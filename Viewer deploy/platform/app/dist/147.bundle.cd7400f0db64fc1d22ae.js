"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[147],{30147:(e,t,n)=>{n.r(t),n.d(t,{default:()=>Q});var i=n(86326),r=n(4667),o=n(15327),a=n(15871),s=n(95e3),l=n(71353),c=n(97598),u=n.n(c);function m({viewportData:e,viewportId:t,element:n,imageSliceData:r,setImageSliceData:a,scrollbarHeight:l,servicesManager:c}){const{cineService:u,cornerstoneViewportService:m}=c.services;return(0,i.useEffect)(()=>{if(!e)return;const n=m.getCornerstoneViewport(t);if(n&&!(n instanceof o.VolumeViewport3D))try{const e=n.getCurrentImageIdIndex(),t=n.getNumberOfSlices();a({imageIndex:e,numberOfSlices:t})}catch(e){console.warn(e)}},[t,e]),(0,i.useEffect)(()=>{if(!e)return;const{viewportType:i}=e,r=i===o.Enums.ViewportType.STACK&&o.Enums.Events.STACK_NEW_IMAGE||i===o.Enums.ViewportType.ORTHOGRAPHIC&&o.Enums.Events.VOLUME_NEW_IMAGE||o.Enums.Events.IMAGE_RENDERED,s=e=>{const n=m.getCornerstoneViewport(t);if(!n||n instanceof o.VolumeViewport3D)return;const{imageIndex:i,newImageIdIndex:r=i,imageIdIndex:s}=e.detail,l=n.getNumberOfSlices();a({imageIndex:r??s,numberOfSlices:l})};return n.addEventListener(r,s),()=>{n.removeEventListener(r,s)}},[e,n]),i.createElement(s.uqr,{onChange:e=>((e,t)=>{const i=m.getCornerstoneViewport(t),{isCineEnabled:r}=u.getState();r&&(u.stopClip(n,{viewportId:t}),u.setCine({id:t,isPlaying:!1})),o.utilities.jumpToSlice(i.element,{imageIndex:e,debounceLoading:!0})})(e,t),max:r.numberOfSlices?r.numberOfSlices-1:0,height:l,value:r.imageIndex||0})}m.propTypes={viewportData:u().object,viewportId:u().string.isRequired,element:u().instanceOf(Element),scrollbarHeight:u().string,imageSliceData:u().object.isRequired,setImageSliceData:u().func.isRequired,servicesManager:u().object.isRequired};const p=m;var d=n(3823),v=n(14867),E=n.n(v);function f(e,t=0){if(null!==e)return parseFloat(e).toFixed(t)}function g(e,t="MMM D, YYYY"){return E()(e,"YYYYMMDD").format(t)}function w(e,t="HH:mm:ss"){return E()(e,"HH:mm:ss").format(t)}var I=n(38007);const S=1e-4,{formatPN:b}=a.Wp,h={"ohif.overlayItem":function(e){const{instance:t,customization:n={}}=e,{color:r,attribute:o,title:a,label:s,background:l}=n,c=n.contentF?.(e,n)??t?.[o];if(null==c)return null;return i.createElement("div",{className:"overlay-item flex flex-row",style:{color:r,background:l},title:a},s?i.createElement("span",{className:"mr-1 shrink-0"},s):null,i.createElement("span",{className:"ml-0 mr-2 shrink-0"},c))},"ohif.overlayItem.windowLevel":function({voi:e,customization:t}){const{windowWidth:n,windowCenter:r}=e;if("number"!=typeof r||"number"!=typeof n)return null;return i.createElement("div",{className:"overlay-item flex flex-row",style:{color:t?.color}},i.createElement("span",{className:"mr-0.5 shrink-0 opacity-[0.70]"},"W:"),i.createElement("span",{className:"mr-2.5 shrink-0"},n.toFixed(0)),i.createElement("span",{className:"mr-0.5 shrink-0 opacity-[0.70]"},"L:"),i.createElement("span",{className:"shrink-0"},r.toFixed(0)))},"ohif.overlayItem.zoomLevel":function({scale:e,customization:t}){return i.createElement("div",{className:"overlay-item flex flex-row",style:{color:t&&t.color||void 0}},i.createElement("span",{className:"mr-0.5 shrink-0 opacity-[0.70]"},"Zoom:"),i.createElement("span",null,e.toFixed(2),"x"))},"ohif.overlayItem.instanceNumber":function({instanceNumber:e,imageSliceData:t,customization:n}){const{imageIndex:r,numberOfSlices:o}=t;return i.createElement("div",{className:"overlay-item flex flex-row",style:{color:n&&n.color||void 0}},i.createElement("span",null,null!=e?i.createElement(i.Fragment,null,i.createElement("span",{className:"mr-0.5 shrink-0 opacity-[0.70]"},"I:"),i.createElement("span",null,`${e} (${r+1}/${o})`)):`${r+1}/${o}`))}};function y({element:e,viewportData:t,imageSliceData:n,viewportId:a,servicesManager:l}){const{cornerstoneViewportService:c,customizationService:u,toolGroupService:m,displaySetService:p}=l.services,[d,v]=(0,i.useState)({windowCenter:null,windowWidth:null}),[E,S]=(0,i.useState)(1),[y,M]=(0,i.useState)(0),{isViewportBackgroundLight:R}=(0,I.eH)(a),{imageIndex:V}=n,C=u.getCustomization("viewportOverlay.topLeft"),T=u.getCustomization("viewportOverlay.topRight"),N=u.getCustomization("viewportOverlay.bottomLeft"),O=u.getCustomization("viewportOverlay.bottomRight"),L=(0,i.useMemo)(()=>t?D(t,a,V,c):null,[t,a,V,c]),A=(0,i.useMemo)(()=>{const e=function(e,t){if(!e?.data?.length)return null;const n=e.data.map(e=>t.getDisplaySetByUID(e.displaySetInstanceUID)).filter(e=>!!e);if(!n.length)return null;return n}(t,p);if(!e)return null;const[n]=e,{instances:i,instance:r}=n;return{displaySets:e,displaySet:n,instance:i?.[V],instances:i,referenceInstance:r}},[t,a,L,c]);(0,i.useEffect)(()=>{const t=e=>{const{range:t}=e.detail;if(!t)return;const{lower:n,upper:i}=t,{windowWidth:r,windowCenter:a}=o.utilities.windowLevel.toWindowLevel(n,i);v({windowCenter:a,windowWidth:r})};return e.addEventListener(o.Enums.Events.VOI_MODIFIED,t),()=>{e.removeEventListener(o.Enums.Events.VOI_MODIFIED,t)}},[a,t,d,e]);const P=(0,i.useCallback)(e=>{e.detail.annotation.metadata.toolName===r.UltrasoundPleuraBLineTool.toolName&&M(e=>e+1)},[]);(0,i.useEffect)(()=>(o.eventTarget.addEventListener(r.Enums.Events.ANNOTATION_MODIFIED,P),()=>{o.eventTarget.removeEventListener(r.Enums.Events.ANNOTATION_MODIFIED,P)}),[P]),(0,i.useEffect)(()=>{const t=e=>{const{previousCamera:t,camera:n}=e.detail;if(t.parallelScale!==n.parallelScale||t.scale!==n.scale){const e=c.getCornerstoneViewport(a);if(!e)return;const t=e.getZoom();S(t)}};return e.addEventListener(o.Enums.Events.CAMERA_MODIFIED,t),()=>{e.removeEventListener(o.Enums.Events.CAMERA_MODIFIED,t)}},[a,t,c,e]);const _=(0,i.useCallback)((r,o)=>{const s={...o,element:e,viewportData:t,imageSliceData:n,viewportId:a,servicesManager:l,customization:r,isLight:R,formatters:{formatPN:b,formatDate:g,formatTime:w,formatNumberPrecision:f}};if(!r)return null;const{inheritsFrom:c}=r,m=h[c];if(m)return i.createElement(m,s);{const e=u.transform(r);if("function"==typeof e.contentF)return e.contentF(s)}},[e,t,n,a,l,u,A,d,E,L,y]),k=(0,i.useCallback)((e,t)=>{const n={...A,formatters:{formatDate:g},voi:d,scale:E,instanceNumber:L,viewportId:a,toolGroupService:m,isLight:R};return i.createElement(i.Fragment,null,e.map((e,r)=>i.createElement("div",{key:`${t}_${r}`},(!e?.condition||e.condition(n))&&_(e,n)||null)))},[_]);return i.createElement(s.pUj,{topLeft:k(C,"topLeftOverlayItem"),topRight:k(T,"topRightOverlayItem"),bottomLeft:k(N,"bottomLeftOverlayItem"),bottomRight:k(O,"bottomRightOverlayItem"),color:R?"text-neutral-dark":"text-neutral-light",shadowClass:R?"shadow-light":"shadow-dark"})}const D=(e,t,n,i)=>{let r;switch(e.viewportType){case o.Enums.ViewportType.STACK:r=function(e,t){const n=e.data[0].imageIds,i=n[t];if(!i)return;const r=o.metaData.get("generalImageModule",i)||{},{instanceNumber:a}=r;if(n.length<=1)return;return parseInt(a)}(e,n);break;case o.Enums.ViewportType.ORTHOGRAPHIC:r=function(e,t,n,i){const r=e.data;if(!r)return;const{volume:a}=r[0];if(!a)return;const{direction:s,imageIds:l}=a,c=n.getCornerstoneViewport(t);if(!c)return;const u=c.getCamera(),{viewPlaneNormal:m}=u,p=s.slice(6,9),v=d.eR.cross(d.eR.create(),m,p);if(d.eR.length(v)<S){const e=l[i];if(!e)return{};const{instanceNumber:t}=o.metaData.get("generalImageModule",e)||{};return parseInt(t)}}(e,t,i,n)}return r??null};y.propTypes={viewportData:u().object,imageIndex:u().number,viewportId:u().string};const M=y;var R=n(55530),V=n.n(R);const{getOrientationStringLPS:C,invertOrientationStringLPS:T}=r.utilities.orientation;const N=function({element:e,viewportData:t,imageSliceData:n,viewportId:r,servicesManager:a,orientationMarkers:s=["top","left"]}){const[l,c]=(0,i.useState)(0),[u,m]=(0,i.useState)(!1),[p,v]=(0,i.useState)(!1),{isViewportBackgroundLight:E}=(0,I.eH)(r),{cornerstoneViewportService:f}=a.services,g=(0,i.useRef)({initialViewUp:null,initialViewRight:null});(0,i.useEffect)(()=>{if(g.current.initialViewUp=null,g.current.initialViewRight=null,"stack"!==t?.viewportType&&e&&(0,o.getEnabledElement)(e)){const{viewport:t}=(0,o.getEnabledElement)(e),{viewUp:n,viewPlaneNormal:i}=t.getCamera(),r=d.eR.create();d.eR.cross(r,n,i),g.current.initialViewUp=[...n],g.current.initialViewRight=[...r]}},[e,t]),(0,i.useEffect)(()=>{const t=e=>{const{previousCamera:t,camera:n}=e.detail,{rotation:i}=n;void 0!==i&&c(i),void 0!==n.flipHorizontal&&t.flipHorizontal!==n.flipHorizontal&&m(n.flipHorizontal),void 0!==n.flipVertical&&t.flipVertical!==n.flipVertical&&v(n.flipVertical)};return e.addEventListener(o.Enums.Events.CAMERA_MODIFIED,t),()=>{e.removeEventListener(o.Enums.Events.CAMERA_MODIFIED,t)}},[]);const w=(0,i.useMemo)(()=>{if(!t)return"";let a,c,m;if("stack"===t.viewportType){const e=n.imageIndex,i=t.data[0].imageIds?.[e];if(!i)return!1;({rowCosines:a,columnCosines:c,isDefaultValueSetForColumnCosine:m,isDefaultValueSetForColumnCosine:m}=o.metaData.get("imagePlaneModule",i)||{})}else{if(!e||!(0,o.getEnabledElement)(e))return"";if(!g.current.initialViewUp||!g.current.initialViewRight)return console.warn("ViewportOrientationMarkers::No initial orientation values"),"";c=[-g.current.initialViewUp[0],-g.current.initialViewUp[1],-g.current.initialViewUp[2]],a=g.current.initialViewRight}if(!a||!c||void 0===l||m)return"";const d=function(e,t,n,i,r){const o=C(e),a=C(t),s=T(o),l={top:T(a),left:s,right:o,bottom:a};i&&(l.top=T(l.top),l.bottom=T(l.bottom));r&&(l.left=T(l.left),l.right=T(l.right));if(90===n||-270===n)return{top:l.left,left:T(l.top),right:T(l.bottom),bottom:l.right};if(-90===n||270===n)return{top:T(l.left),left:l.top,bottom:l.left,right:l.bottom};if(180===n||-180===n)return{top:T(l.top),left:T(l.left),bottom:T(l.bottom),right:T(l.right)};return l}(a,c,l,p,u);return f.getViewportInfo(r)?s.map((e,t)=>i.createElement("div",{className:V()("overlay-text",`${e}-mid orientation-marker`,E?"text-neutral-dark/70":"text-neutral-light/70",E?"shadow-light":"shadow-dark","text-base","leading-5"),key:`${e}-mid orientation-marker`},i.createElement("div",{className:"orientation-marker-value"},d[e]))):(console.log("ViewportOrientationMarkers::No viewport"),null)},[t,n,l,p,u,s,e,E]);return i.createElement("div",{className:"ViewportOrientationMarkers select-none"},w)};function O({viewportData:e,element:t}){const[n,r]=(0,i.useState)(!1),[a,s]=(0,i.useState)(!1),l=(0,i.useRef)(null),c=(0,i.useRef)(null),u=e=>{clearTimeout(l.current),l.current=setTimeout(()=>{r(!0)},50)},m=e=>{clearTimeout(l.current),r(!1)},p=e=>{clearTimeout(l.current),c.current===e.detail.imageId&&(s(e.detail.error),c.current=null)};return(0,i.useEffect)(()=>(t.addEventListener(o.Enums.Events.STACK_VIEWPORT_SCROLL,u),t.addEventListener(o.Enums.Events.IMAGE_LOAD_ERROR,p),t.addEventListener(o.Enums.Events.STACK_NEW_IMAGE,m),()=>{t.removeEventListener(o.Enums.Events.STACK_VIEWPORT_SCROLL,u),t.removeEventListener(o.Enums.Events.STACK_NEW_IMAGE,m),t.removeEventListener(o.Enums.Events.IMAGE_LOAD_ERROR,p)}),[t,e]),a?i.createElement(i.Fragment,null,i.createElement("div",{className:"absolute top-0 left-0 h-full w-full bg-black opacity-50"},i.createElement("div",{className:"transparent flex h-full w-full items-center justify-center"},i.createElement("p",{className:"text-primary-light text-xl font-light"},i.createElement("h4",null,"Error Loading Image"),i.createElement("p",null,"An error has occurred."),i.createElement("p",null,a))))):n?i.createElement("div",{className:"pointer-events-none absolute top-0 left-0 h-full w-full bg-black opacity-50"},i.createElement("div",{className:"transparent flex h-full w-full items-center justify-center"},i.createElement("p",{className:"text-primary-light text-xl font-light"},"Loading..."))):null}O.propTypes={error:u().object,element:u().object};const L=O;const A=function(e){const{viewportId:t,element:n,scrollbarHeight:r,servicesManager:o}=e,{cornerstoneViewportService:a}=o.services,[s,l]=(0,i.useState)({imageIndex:0,numberOfSlices:0}),[c,u]=(0,i.useState)(null);if((0,i.useEffect)(()=>{const{unsubscribe:e}=a.subscribe(a.EVENTS.VIEWPORT_DATA_CHANGED,e=>{e.viewportId===t&&u(e.viewportData)});return()=>{e()}},[t]),!n)return null;if(c){const e=a.getViewportInfo(t);if(e?.viewportOptions?.customViewportProps?.hideOverlays)return null}return i.createElement("div",{className:"noselect"},i.createElement(p,{viewportId:t,viewportData:c,element:n,imageSliceData:s,setImageSliceData:l,scrollbarHeight:r,servicesManager:o}),i.createElement(M,{imageSliceData:s,viewportData:c,viewportId:t,servicesManager:o,element:n}),i.createElement(L,{viewportData:c,element:n}),i.createElement(N,{imageSliceData:s,element:n,viewportData:c,servicesManager:o,viewportId:t}))};var P=n(45981);function _({viewportId:e,cineService:t,newStackFrameRate:n,isPlaying:r,dynamicInfo:a,customizationService:s}){const l=s.getCustomization("cinePlayer"),[c,u]=(0,i.useState)(a);(0,i.useEffect)(()=>{u(a)},[a]),(0,i.useEffect)(()=>{if(!c)return;const e=e=>{const{volumeId:t,dimensionGroupNumber:n,numDimensionGroups:i,splittingTag:r}=e.detail;u({volumeId:t,dimensionGroupNumber:n,numDimensionGroups:i,label:r})};return o.eventTarget.addEventListener(o.Enums.Events.DYNAMIC_VOLUME_DIMENSION_GROUP_CHANGED,e),()=>{o.eventTarget.removeEventListener(o.Enums.Events.DYNAMIC_VOLUME_DIMENSION_GROUP_CHANGED,e)}},[c]),(0,i.useEffect)(()=>{if(!c)return;const{volumeId:e,dimensionGroupNumber:t,numDimensionGroups:n,splittingTag:i}=c||{};o.cache.getVolume(e,!0).dimensionGroupNumber=t,u({volumeId:e,dimensionGroupNumber:t,numDimensionGroups:n,label:i})},[]);const m=(0,i.useCallback)(e=>{const{volumeId:t,dimensionGroupNumber:n}=e;o.cache.getVolume(t,!0).dimensionGroupNumber=n},[]);return i.createElement(l,{className:"absolute left-1/2 bottom-3 -translate-x-1/2",frameRate:n,isPlaying:r,onClose:()=>{t.setCine({id:e,isPlaying:!1}),t.setIsCineEnabled(!1),t.setViewportCineClosed(e)},onPlayPauseChange:n=>{t.setCine({id:e,isPlaying:n})},onFrameRateChange:n=>t.setCine({id:e,frameRate:n}),dynamicInfo:c,updateDynamicInfo:m})}const k=function({enabledVPElement:e,viewportId:t,servicesManager:n}){const{customizationService:r,displaySetService:a,viewportGridService:l}=n.services,[{isCineEnabled:c,cines:u},m]=(0,s.tqw)(),[p,d]=(0,i.useState)(24),[v,E]=(0,i.useState)(null),[f]=(0,P.r)(),g=(0,i.useRef)(null),w=()=>{if(!u?.[t]||!e)return;const{isPlaying:n=!1,frameRate:i=24}=u[t],r=Math.max(i,1);return n?m.playClip(e,{framesPerSecond:r,viewportId:t}):m.stopClip(e)},I=(0,i.useCallback)(()=>{if(!e||!c)return;const{viewports:n}=l.getState(),{displaySetInstanceUIDs:i}=n.get(t);let r=24,o=u[t]?.isPlaying||!1;i.forEach(e=>{const t=a.getDisplaySetByUID(e);if(t.FrameRate&&(r=Math.round(1e3/t.FrameRate),o||=!!f.autoPlayCine),t.isDynamicVolume){const{dynamicVolumeInfo:e}=t,n=e.timePoints.length,i=e.splittingTag,r=e.dimensionGroupNumber||1;E({volumeId:t.displaySetInstanceUID,dimensionGroupNumber:r,numDimensionGroups:n,label:i})}else E(null)}),o&&m.setIsCineEnabled(o),m.setCine({id:t,isPlaying:o,frameRate:r}),d(r)},[a,t,l,u,c,e]);if((0,i.useEffect)(()=>(g.current=!0,I(),()=>{g.current=!1}),[c,I]),(0,i.useEffect)(()=>{c&&w()},[c,w,e]),(0,i.useEffect)(()=>{if(e)return e.addEventListener(o.Enums.Events.VIEWPORT_NEW_IMAGE_SET,I),e.addEventListener(o.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,I),()=>{m.setCine({id:t,isPlaying:!1}),e.removeEventListener(o.Enums.Events.VIEWPORT_NEW_IMAGE_SET,I),e.removeEventListener(o.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,I)}},[e,I,t]),(0,i.useEffect)(()=>{if(u&&u[t]&&e&&g.current)return w(),()=>{m.stopClip(e,{viewportId:t})}},[u,t,m,e,w]),!c)return null;const S=u[t],b=S?.isPlaying||!1;return i.createElement(_,{viewportId:t,cineService:m,newStackFrameRate:p,isPlaying:b,dynamicInfo:v,customizationService:r})};var x=n(20528),G=n(93813);function U({viewportId:e}){const{isHovered:t,isActive:n}=(0,I.uY)(e);return t||n?i.createElement(s.TNf,{size:"medium",IconContainer:s.T0e,containerProps:{size:"tiny",className:"font-normal text-primary hover:bg-primary/25"}},i.createElement(s.R2R.Container,null,i.createElement(s.R2R.TopLeft,null,i.createElement(x.M,{buttonSection:"viewportActionMenu.topLeft",viewportId:e,location:G.ij.TopLeft})),i.createElement(s.R2R.TopMiddle,null,i.createElement(x.M,{buttonSection:"viewportActionMenu.topMiddle",viewportId:e,location:G.ij.TopMiddle})),i.createElement(s.R2R.TopRight,null,i.createElement(x.M,{buttonSection:"viewportActionMenu.topRight",viewportId:e,location:G.ij.TopRight})),i.createElement(s.R2R.LeftMiddle,null,i.createElement(x.M,{buttonSection:"viewportActionMenu.leftMiddle",viewportId:e,location:G.ij.LeftMiddle})),i.createElement(s.R2R.RightMiddle,null,i.createElement(x.M,{buttonSection:"viewportActionMenu.rightMiddle",viewportId:e,location:G.ij.RightMiddle})),i.createElement(s.R2R.BottomLeft,null,i.createElement(x.M,{buttonSection:"viewportActionMenu.bottomLeft",viewportId:e,location:G.ij.BottomLeft})),i.createElement(s.R2R.BottomMiddle,null,i.createElement(x.M,{buttonSection:"viewportActionMenu.bottomMiddle",viewportId:e,location:G.ij.BottomMiddle})),i.createElement(s.R2R.BottomRight,null,i.createElement(x.M,{buttonSection:"viewportActionMenu.bottomRight",viewportId:e,location:G.ij.BottomRight})))):null}const F=(0,i.memo)(U);var z=n(44646),H=n(10182),W=n(2847);var j=n(68578);const B=(0,i.memo)(({servicesManager:e,viewportId:t})=>{const{displaySetService:n,cineService:r,viewportGridService:o,customizationService:a,cornerstoneViewportService:s}=e.services,[l,c]=(0,i.useState)(t),u=(0,i.useCallback)(()=>{if(r.isViewportCineClosed(l))return;const e=o.getDisplaySetsUIDsForViewport(l);if(!e)return;const t=e.map(e=>n.getDisplaySetByUID(e));if(!t.length)return;const i=t.map(e=>e?.Modality),s=t.some(e=>e?.isDynamicVolume),c=a.getCustomization("autoCineModalities");!i.some(e=>c.includes(e))&&!s||r.getState().isCineEnabled||r.setIsCineEnabled(!0)},[l,r,o,n,a]);return(0,i.useEffect)(()=>{const e=o.subscribe(o.EVENTS.ACTIVE_VIEWPORT_ID_CHANGED,({viewportId:e})=>c(e));return()=>e.unsubscribe()},[t,o]),(0,i.useEffect)(()=>{const e=s.subscribe(s.EVENTS.VIEWPORT_DATA_CHANGED,()=>{const e=o.getActiveViewportId();c(e),u()});return()=>e.unsubscribe()},[t,s,o,u]),(0,i.useEffect)(()=>{u()},[u]),null},Y);function Y(e,t){return e.viewportId===t.viewportId&&e.servicesManager===t.servicesManager}B.displayName="ActiveViewportBehavior";const K=B;var $=n(11794);const q=new Map,J=i.memo(e=>{const{displaySets:t,dataSource:n,viewportOptions:c,displaySetOptions:u,servicesManager:m,onElementEnabled:p,onElementDisabled:d,isJumpToMeasurementDisabled:v=!1,initialImageIndex:E,isHangingProtocolLayout:f}=e,g=c.viewportId;if(!g)throw new Error("Viewport ID is required");for(;u.length<t.length;)u.push({});c.viewportType=t.some(e=>e.isDynamicVolume&&e.isReconstructable)?"volume":c.viewportType;const[w,I]=(0,i.useState)("100px"),[S,b]=(0,i.useState)(null),h=(0,i.useRef)(),y=(0,a.bs)(g),{displaySetService:D,toolbarService:M,toolGroupService:R,syncGroupService:V,cornerstoneViewportService:C,segmentationService:T,cornerstoneCacheService:N,customizationService:O,measurementService:L}=m.services,[P]=(0,s.ORo)(),_=(0,i.useCallback)(()=>{const e=h.current.clientHeight-10+"px";I(e)},[h]),x=(0,i.useCallback)(e=>{if(h.current&&e?.length){const t=e[0],{width:n,height:i}=t.contentRect,r=q.get(g)||{width:0,height:0},o=r.width!==n||r.height!==i;n>0&&i>0&&o&&(q.set(g,{width:n,height:i}),C.resize(),_())}},[g,h,C,_]);(0,i.useEffect)(()=>{const e=h.current;if(!e)return;const t=new ResizeObserver(x);return t.observe(e),()=>{t.unobserve(e),t.disconnect()}},[x]);const G=(0,i.useCallback)(e=>{const t=e.getRenderingEngineId(),n=e.getSyncGroups();R.removeViewportFromToolGroup(g,t),V.removeViewportFromSyncGroup(g,t,n),T.clearSegmentationRepresentations(g)},[g,T,V,R]),U=(0,i.useCallback)(e=>{if(e.detail.element!==h.current)return;const{viewportId:t,element:n}=e.detail,i=C.getViewportInfo(t);if(!i)return;(0,l.ye)(t,n),b(n);const r=i.getRenderingEngineId(),o=i.getToolGroupId(),a=i.getSyncGroups();R.addViewportToToolGroup(t,r,o),V.addViewportToSyncGroup(t,r,a);const{synchronizersStore:s}=j.U.getState();s?.[t]?.length&&!f&&function(e,t){const{synchronizersStore:n}=j.U.getState(),i=n[e];if(!i)return;i.forEach(n=>{if(!n.id)return;const{id:i,sourceViewports:r,targetViewports:o}=n,a=t.getSynchronizer(i);if(!a)return;const s=r.find(t=>t.viewportId===e),l=o.find(t=>t.viewportId===e),c=a.getSourceViewports().find(t=>t.viewportId===e),u=a.getTargetViewports().find(t=>t.viewportId===e);s&&!c&&a.addSource({viewportId:s.viewportId,renderingEngineId:s.renderingEngineId}),l&&!u&&a.addTarget({viewportId:l.viewportId,renderingEngineId:l.renderingEngineId})})}(t,V),p&&"function"==typeof p&&p(e)},[g,p,R]);(0,i.useEffect)(()=>(C.enableViewport(g,h.current),o.eventTarget.addEventListener(o.Enums.Events.ELEMENT_ENABLED,U),_(),()=>{const e=C.getViewportInfo(g);e&&(C.storePresentation({viewportId:g}),G(e),d&&"function"==typeof d&&d(e),C.disableElement(g),y.unregister(),o.eventTarget.removeEventListener(o.Enums.Events.ELEMENT_ENABLED,U))}),[]),(0,i.useEffect)(()=>{const{unsubscribe:e}=D.subscribe(D.EVENTS.DISPLAY_SET_SERIES_METADATA_INVALIDATED,async({displaySetInstanceUID:e,invalidateData:t})=>{if(!t)return;const i=C.getViewportInfo(g);if(i.hasDisplaySet(e)){const t=i.getViewportData(),r=await N.invalidateViewportData(t,e,n,D),o=!0;C.updateViewport(g,r,o)}});return()=>{e()}},[g]),(0,i.useEffect)(()=>{c.viewportType||(c.viewportType="stack");(async()=>{const e=await N.createViewportData(t,c,n,E),i=function(e,t){const{lutPresentationStore:n}=H.I.getState(),{positionPresentationStore:i}=z.q.getState(),{segmentationPresentationStore:r}=W.v.getState(),{presentationIds:o}=t;if(!o)return{positionPresentation:null,lutPresentation:null,segmentationPresentation:null};const{lutPresentationId:a,positionPresentationId:s,segmentationPresentationId:l}=o;return{positionPresentation:i[s],lutPresentation:n[a],segmentationPresentation:r[l]}}(0,c);c.needsRerendering&&(c.needsRerendering=!1),C.setViewportData(g,e,c,u,i)})()},[c,t,n]),(0,i.useEffect)(()=>{if(v)return;const{unsubscribe:e}=L.subscribe(a.C5.EVENTS.JUMP_TO_MEASUREMENT_VIEWPORT,e=>function(e,t,n,i){const{measurement:a,isConsumed:s}=e;if(!a||s)return;const l=(0,o.getEnabledElement)(t.current);if(!l)return;const c=l.viewport,{metadata:u,displaySetInstanceUID:m}=a,p=i.getViewportDisplaySets(n),d=p.find(e=>e.displaySetInstanceUID===m);let v=u;d||(v={...u,FrameOfReferenceUID:void 0});if(!c.isReferenceViewable(v,$.g))return;try{c.setViewReference(u),c.render()}catch(e){console.warn("Unable to apply",u,e)}r.annotation.selection.setAnnotationSelected(a.uid),e?.consume?.()}(e,h,g,C));return()=>{e()}},[t,h,g,v,m]);const B=O.getCustomization("ui.notificationComponent");return i.createElement(i.Fragment,null,i.createElement("div",{className:"viewport-wrapper"},i.createElement("div",{className:"cornerstone-viewport-element",style:{height:"100%",width:"100%"},onContextMenu:e=>e.preventDefault(),onMouseDown:e=>e.preventDefault(),"data-viewportid":g,ref:e=>{h.current=e,e&&y.register(e)}}),i.createElement(A,{viewportId:g,toolBarService:M,element:h.current,scrollbarHeight:w,servicesManager:m}),i.createElement(k,{enabledVPElement:S,viewportId:g,servicesManager:m}),i.createElement(K,{viewportId:g,servicesManager:m})),i.createElement("div",{className:"absolute top-[24px] w-full"},P.viewportId===g&&i.createElement(B,{id:"viewport-notification",message:P.message,type:P.type,actions:P.actions,onSubmit:P.onSubmit,onOutsideClick:P.onOutsideClick,onKeyPress:P.onKeyPress})),i.createElement(F,{viewportId:g}))},Z);function Z(e,t){if(t.needsRerendering)return!1;if(e.displaySets.length!==t.displaySets.length)return!1;if(e.viewportOptions.orientation!==t.viewportOptions.orientation)return!1;if(e.viewportOptions.toolGroupId!==t.viewportOptions.toolGroupId)return!1;if(t.viewportOptions.viewportType&&e.viewportOptions.viewportType!==t.viewportOptions.viewportType)return!1;if(t.viewportOptions.needsRerendering)return!1;const n=e.displaySets,i=t.displaySets;if(n.length!==i.length)return!1;for(let e=0;e<n.length;e++){const t=n[e],r=i.find(e=>e.displaySetInstanceUID===t.displaySetInstanceUID);if(!r)return!1;if(r.images?.length!==t.images?.length)return!1;if(r.images?.length)for(let e=0;e<r.images.length;e++)if(r.images[e].imageId!==t.images[e].imageId)return!1}return!0}J.displayName="OHIFCornerstoneViewport";const Q=J}}]);
//# sourceMappingURL=147.bundle.cd7400f0db64fc1d22ae.js.map