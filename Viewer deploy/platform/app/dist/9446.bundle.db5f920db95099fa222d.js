"use strict";(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[9446],{97181:(t,e,n)=>{n.d(e,{A:()=>o});const o=function(t,e,n){return`${t}::${e}::${n}`}},76910:(t,e,n)=>{n.d(e,{A:()=>a});var o=n(99737);const a=t=>t.shiftKey?t.ctrlKey?o.KeyboardBindings.ShiftCtrl:t.altKey?o.KeyboardBindings.ShiftAlt:t.metaKey?o.KeyboardBindings.ShiftMeta:o.KeyboardBindings.Shift:t.ctrlKey?t.altKey?o.KeyboardBindings.CtrlAlt:t.metaKey?o.KeyboardBindings.CtrlMeta:o.KeyboardBindings.Ctrl:t.altKey?t.metaKey&&o.KeyboardBindings.AltMeta||o.KeyboardBindings.Alt:t.metaKey?o.KeyboardBindings.Meta:void 0},44049:(t,e,n)=>{n.r(e),n.d(e,{triggerAnnotationAddedForElement:()=>r,triggerAnnotationAddedForFOR:()=>s,triggerAnnotationCompleted:()=>c,triggerAnnotationModified:()=>d,triggerAnnotationRemoved:()=>l,triggerContourAnnotationCompleted:()=>u});var o=n(15327),a=n(99737),i=n(77609);function r(t,e){const n=(0,o.getEnabledElement)(e),{renderingEngine:i,viewportId:r}=n,s=a.Events.ANNOTATION_ADDED,l={annotation:t,viewportId:r,renderingEngineId:i.id};(0,o.triggerEvent)(o.eventTarget,s,l)}function s(t){const{toolName:e}=t.metadata,n=(0,i.getToolGroupsWithToolName)(e);if(!n.length)return;const r=[];n.forEach(e=>{e.viewportsInfo.forEach(e=>{const{renderingEngineId:n,viewportId:a}=e,{FrameOfReferenceUID:i}=(0,o.getEnabledElementByIds)(a,n);t.metadata.FrameOfReferenceUID===i&&r.push(e)})});const s=a.Events.ANNOTATION_ADDED,l={annotation:t};r.length?r.forEach(({renderingEngineId:t,viewportId:e})=>{l.viewportId=e,l.renderingEngineId=t,(0,o.triggerEvent)(o.eventTarget,s,l)}):(0,o.triggerEvent)(o.eventTarget,s,l)}function l(t){const e=a.Events.ANNOTATION_REMOVED;(0,o.triggerEvent)(o.eventTarget,e,t)}function d(t,e,n=a.ChangeTypes.HandlesUpdated){const i=e&&(0,o.getEnabledElement)(e),{viewportId:r,renderingEngineId:s}=i||{},l=a.Events.ANNOTATION_MODIFIED,d={annotation:t,viewportId:r,renderingEngineId:s,changeType:n};(0,o.triggerEvent)(o.eventTarget,l,d)}function c(t){g({annotation:t})}function u(t,e=!1){g({annotation:t,contourHoleProcessingEnabled:e})}function g(t){const e=a.Events.ANNOTATION_COMPLETED;(0,o.triggerEvent)(o.eventTarget,e,t)}},97:(t,e,n)=>{n.d(e,{c:()=>l});var o=n(2076),a=n(29601),i=n(67013),r=n(82056);const s=i.H;function l(){(0,r.setAnnotationManager)(s)}s.setPreprocessingFn(t=>{const e=(t=(t=>(t.data||(t.data={}),t.data.cachedStats||(t.data.cachedStats={}),t))(t=(t=>(t.data||(t.data={}),t.data.handles||(t.data.handles={}),t.data.handles.textBox||(t.data.handles.textBox={}),t))(t))).annotationUID,n=(0,o.checkAndSetAnnotationLocked)(e);t.isLocked=n;const i=(0,a.checkAndSetAnnotationVisibility)(e);return t.isVisible=i,t}),(0,r.setAnnotationManager)(s)},75419:(t,e,n)=>{n.d(e,{R:()=>i});var o=n(15327),a=n(99737);function i(t){const e={segmentationId:t};(0,o.triggerEvent)(o.eventTarget,a.Events.SEGMENTATION_ADDED,e)}},9726:(t,e,n)=>{n.d(e,{G:()=>i});var o=n(15327),a=n(99737);function i(t){const e={segmentationId:t};(0,o.triggerEvent)(o.eventTarget,a.Events.SEGMENTATION_MODIFIED,e)}},1485:(t,e,n)=>{n.d(e,{B:()=>i});var o=n(15327),a=n(99737);function i(t){const e={segmentationId:t};(0,o.triggerEvent)(o.eventTarget,a.Events.SEGMENTATION_REMOVED,e)}},44951:(t,e,n)=>{n.d(e,{r:()=>i});var o=n(15327),a=n(99737);function i(t,e,n){const i={segmentationId:e,type:n,viewportId:t};(0,o.triggerEvent)(o.eventTarget,a.Events.SEGMENTATION_REPRESENTATION_MODIFIED,i)}},65290:(t,e,n)=>{n.d(e,{O:()=>i});var o=n(15327),a=n(99737);function i(t,e,n){const i={viewportId:t,segmentationId:e,type:n};(0,o.triggerEvent)(o.eventTarget,a.Events.SEGMENTATION_REPRESENTATION_REMOVED,i)}},47098:(t,e,n)=>{n.d(e,{s:()=>a});var o=n(93210);function a(t,e){const n=(0,o.Ut)(t,e);if(!n)return new Set;return Object.entries(n.segments).reduce((t,[e,n])=>(n.visible||t.add(Number(e)),t),new Set)}},9711:(t,e,n)=>{n(99737),n(21345)},88029:(t,e,n)=>{n.d(e,{A:()=>r});var o=n(85204),a=n(99737);const i=[a.ToolModes.Active,a.ToolModes.Passive,a.ToolModes.Enabled];const r=function(t){return o.wk.toolGroups.filter(({toolOptions:e})=>{const n=Object.keys(e);for(let o=0;o<n.length;o++)if(t===n[o]&&e[t]&&i.includes(e[t].mode))return!0;return!1})}},57999:(t,e,n)=>{n.d(e,{A:()=>b});var o=n(3823),a=n(15327),i=n(85204),r=n(99737),s=n(7001),l=n(95527),d=n(93126),c=n(42797),u=n(58640),g=n(72967),m=n(44049);const{getSubPixelSpacingAndXYDirections:h,addCanvasPointsToArray:p,getArea:f}=l.polyline;function v(t,e,n){this.isEditingClosed=!0;const o=t.detail,{currentPoints:l,element:d}=o,c=l.canvas,u=(0,a.getEnabledElement)(d);if(!u)return;const{viewport:g}=u,m=e.data.contour.polyline.map(g.worldToCanvas),{spacing:p,xDir:f,yDir:v}=h(g,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:m,editCanvasPoints:[c],startCrossingIndex:void 0,editIndex:0,annotation:e},this.commonData={annotation:e,viewportIdsToRender:n,spacing:p,xDir:f,yDir:v,movingTextBox:!1},i.wk.isInteractingWithTool=!0,d.addEventListener(r.Events.MOUSE_UP,this.mouseUpClosedContourEditCallback),d.addEventListener(r.Events.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),d.addEventListener(r.Events.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),d.addEventListener(r.Events.TOUCH_END,this.mouseUpClosedContourEditCallback),d.addEventListener(r.Events.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),d.addEventListener(r.Events.TOUCH_TAP,this.mouseUpClosedContourEditCallback),(0,s.hideElementCursor)(d)}function I(t){i.wk.isInteractingWithTool=!1,t.removeEventListener(r.Events.MOUSE_UP,this.mouseUpClosedContourEditCallback),t.removeEventListener(r.Events.MOUSE_DRAG,this.mouseDragClosedContourEditCallback),t.removeEventListener(r.Events.MOUSE_CLICK,this.mouseUpClosedContourEditCallback),t.removeEventListener(r.Events.TOUCH_END,this.mouseUpClosedContourEditCallback),t.removeEventListener(r.Events.TOUCH_DRAG,this.mouseDragClosedContourEditCallback),t.removeEventListener(r.Events.TOUCH_TAP,this.mouseUpClosedContourEditCallback),(0,s.resetElementCursor)(t)}function E(t){const e=t.detail,{currentPoints:n,element:i}=e,r=n.world,s=n.canvas,l=(0,a.getEnabledElement)(i),{viewport:d}=l,{viewportIdsToRender:c,xDir:g,yDir:m,spacing:h}=this.commonData,{editIndex:f,editCanvasPoints:v,startCrossingIndex:I,annotation:E}=this.editData;this.createMemo(i,E);const C=v[v.length-1],D=d.canvasToWorld(C),A=o.eR.create();o.eR.subtract(A,r,D);const w=Math.abs(o.eR.dot(A,g)),x=Math.abs(o.eR.dot(A,m));if(w<=h[0]&&x<=h[1])return;void 0!==I&&this.checkAndRemoveCrossesOnEditLine(t);const b=f+p(i,v,s,this.commonData);this.editData.editIndex=b,void 0===I&&v.length>1&&this.checkForFirstCrossing(t,!0),this.editData.snapIndex=this.findSnapIndex(),-1!==this.editData.snapIndex?(this.editData.fusedCanvasPoints=this.fuseEditPointsWithClosedContour(t),void 0!==I&&this.checkForSecondCrossing(t,!0)&&(this.removePointsAfterSecondCrossing(!0),this.finishEditAndStartNewEdit(t)),(0,u.A)(c)):this.finishEditAndStartNewEdit(t)}function C(t){const e=t.detail,{element:n}=e,o=(0,a.getEnabledElement)(n),{viewport:i,renderingEngine:r}=o,{annotation:s,viewportIdsToRender:l}=this.commonData,{fusedCanvasPoints:c,editCanvasPoints:h}=this.editData;(0,g.A)(s,{points:c,closed:!0,targetWindingDirection:d.W.Clockwise},i),s.autoGenerated&&(s.autoGenerated=!1),(0,m.triggerAnnotationModified)(s,n);const p=h.pop();this.editData={prevCanvasPoints:c,editCanvasPoints:[p],startCrossingIndex:void 0,editIndex:0,snapIndex:void 0,annotation:s},(0,u.A)(l)}function D(t){const{prevCanvasPoints:e,editCanvasPoints:n,startCrossingIndex:a,snapIndex:i}=this.editData;if(void 0===a||void 0===i)return;const r=t.detail,{element:s}=r,l=[...n];let d,c;p(s,l,e[i],this.commonData),l.length>n.length&&l.pop(),a>i?(d=i,c=a):(d=a,c=i);const u=o.Zc.distance(e[d],l[0]),g=o.Zc.distance(e[d],l[l.length-1]),m=o.Zc.distance(e[c],l[0]),h=o.Zc.distance(e[c],l[l.length-1]),v=[];for(let t=0;t<d;t++){const n=e[t];v.push([n[0],n[1]])}let I=u+h,E=g+m;if(I<E)for(let t=0;t<l.length;t++){const e=l[t];v.push([e[0],e[1]])}else for(let t=l.length-1;t>=0;t--){const e=l[t];v.push([e[0],e[1]])}for(let t=c;t<e.length;t++){const n=e[t];v.push([n[0],n[1]])}const C=[];for(let t=d;t<c;t++){const n=e[t];C.push([n[0],n[1]])}if(I=m+g,E=h+u,I<E)for(let t=0;t<l.length;t++){const e=l[t];C.push([e[0],e[1]])}else for(let t=l.length-1;t>=0;t--){const e=l[t];C.push([e[0],e[1]])}return f(v)>f(C)?v:C}function A(t){const e=t.detail,{element:n}=e;this.completeClosedContourEdit(n)}function w(t){const e=(0,a.getEnabledElement)(t),{viewport:n}=e,{annotation:o,viewportIdsToRender:i}=this.commonData;this.doneEditMemo();const{fusedCanvasPoints:r,prevCanvasPoints:s}=this.editData;if(r){const e=(0,c.Q)(this.configuration,o)?(0,c.p)(this.configuration,r,s):r,a=this.configuration?.decimate||{};(0,g.A)(o,{points:e,closed:!0,targetWindingDirection:d.W.Clockwise},n,{decimate:{enabled:!!a.enabled,epsilon:a.epsilon}}),o.autoGenerated&&(o.autoGenerated=!1),(0,m.triggerAnnotationModified)(o,t)}this.isEditingClosed=!1,this.editData=void 0,this.commonData=void 0,(0,u.A)(i),this.deactivateClosedContourEdit(t)}function x(t){this.completeClosedContourEdit(t)}const b=function(t){t.activateClosedContourEdit=v.bind(t),t.deactivateClosedContourEdit=I.bind(t),t.mouseDragClosedContourEditCallback=E.bind(t),t.mouseUpClosedContourEditCallback=A.bind(t),t.finishEditAndStartNewEdit=C.bind(t),t.fuseEditPointsWithClosedContour=D.bind(t),t.cancelClosedContourEdit=x.bind(t),t.completeClosedContourEdit=w.bind(t)}},55927:(t,e,n)=>{n.d(e,{A:()=>T});var o=n(15327),a=n(7001),i=n(99737),r=n(85204),s=n(3823),l=n(42797),d=n(76910),c=n(58640),u=n(44049),g=n(5403),m=n(95527),h=n(82056),p=n(93126);const{addCanvasPointsToArray:f,pointsAreWithinCloseContourProximity:v,getFirstLineSegmentIntersectionIndexes:I,getSubPixelSpacingAndXYDirections:E}=m.polyline;function C(t,e,n){this.isDrawing=!0;const s=t.detail,{currentPoints:l,element:c}=s,u=l.canvas,g=(0,o.getEnabledElement)(c),{viewport:m}=g,h=(0,d.A)(t.detail.event)===this.configuration.contourHoleAdditionModifierKey,{spacing:p,xDir:f,yDir:v}=E(m,this.configuration.subPixelResolution)||{};p&&f&&v&&(this.drawData={canvasPoints:[u],polylineIndex:0,contourHoleProcessingEnabled:h,newAnnotation:!0},this.commonData={annotation:e,viewportIdsToRender:n,spacing:p,xDir:f,yDir:v,movingTextBox:!1},r.wk.isInteractingWithTool=!0,c.addEventListener(i.Events.MOUSE_UP,this.mouseUpDrawCallback),c.addEventListener(i.Events.MOUSE_DRAG,this.mouseDragDrawCallback),c.addEventListener(i.Events.MOUSE_CLICK,this.mouseUpDrawCallback),c.addEventListener(i.Events.TOUCH_END,this.mouseUpDrawCallback),c.addEventListener(i.Events.TOUCH_DRAG,this.mouseDragDrawCallback),c.addEventListener(i.Events.TOUCH_TAP,this.mouseUpDrawCallback),(0,a.hideElementCursor)(c))}function D(t){r.wk.isInteractingWithTool=!1,t.removeEventListener(i.Events.MOUSE_UP,this.mouseUpDrawCallback),t.removeEventListener(i.Events.MOUSE_DRAG,this.mouseDragDrawCallback),t.removeEventListener(i.Events.MOUSE_CLICK,this.mouseUpDrawCallback),t.removeEventListener(i.Events.TOUCH_END,this.mouseUpDrawCallback),t.removeEventListener(i.Events.TOUCH_DRAG,this.mouseDragDrawCallback),t.removeEventListener(i.Events.TOUCH_TAP,this.mouseUpDrawCallback),(0,a.resetElementCursor)(t)}function A(t){const e=t.detail,{currentPoints:n,element:a}=e,r=n.world,l=n.canvas,d=(0,o.getEnabledElement)(a),{viewport:g}=d,{annotation:m,viewportIdsToRender:h,xDir:p,yDir:v,spacing:I,movingTextBox:E}=this.commonData,{polylineIndex:C,canvasPoints:D,newAnnotation:A}=this.drawData;this.createMemo(a,m,{newAnnotation:A});const w=D[D.length-1],x=g.canvasToWorld(w),b=s.eR.create();s.eR.subtract(b,r,x);const S=Math.abs(s.eR.dot(b,p)),y=Math.abs(s.eR.dot(b,v));if(!(S<=I[0]&&y<=I[1])){if(E){this.isDrawing=!1;const{deltaPoints:t}=e,n=t.world,{textBox:o}=m.data.handles,{worldPosition:a}=o;a[0]+=n[0],a[1]+=n[1],a[2]+=n[2],o.hasMoved=!0}else{const e=this.findCrossingIndexDuringCreate(t);if(void 0!==e)this.applyCreateOnCross(t,e);else{const t=f(a,D,l,this.commonData);this.drawData.polylineIndex=C+t}m.invalidated=!0}(0,c.A)(h),m.invalidated&&(0,u.triggerAnnotationModified)(m,a,i.ChangeTypes.HandlesUpdated)}}function w(t){const{allowOpenContours:e}=this.configuration,{canvasPoints:n,contourHoleProcessingEnabled:o}=this.drawData,a=n[0],i=n[n.length-1],r=t.detail,{element:s}=r;this.doneEditMemo(),this.drawData.newAnnotation=!1,e&&!v(a,i,this.configuration.closeContourProximity)?this.completeDrawOpenContour(s,{contourHoleProcessingEnabled:o}):this.completeDrawClosedContour(s,{contourHoleProcessingEnabled:o})}function x(t,e){this.removeCrossedLinesOnCompleteDraw();const{canvasPoints:n}=this.drawData,{contourHoleProcessingEnabled:a,minPointsToSave:i}=e??{};if(i&&n.length<i)return!1;if(this.haltDrawing(t,n))return!1;const{annotation:r,viewportIdsToRender:s}=this.commonData,d=(0,o.getEnabledElement)(t),{viewport:g,renderingEngine:m}=d;f(t,n,n[0],this.commonData),n.pop();const h=(0,l.Q)(this.configuration,r)?(0,l.p)(this.configuration,n):n;this.updateContourPolyline(r,{points:h,closed:!0,targetWindingDirection:p.W.Clockwise},g);const{textBox:v}=r.data.handles;return v?.hasMoved||(0,u.triggerContourAnnotationCompleted)(r,a),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,(0,c.A)(s),this.deactivateDraw(t),!0}function b(){const{canvasPoints:t}=this.drawData,e=t.length,n=[t[0],t[e-1]],o=t.slice(0,-1).slice(1),a=I(o,n[0],n[1],!1);if(a){const e=a[1];this.drawData.canvasPoints=1===e?t.splice(1):t.splice(0,e)}}function S(t,e){const{canvasPoints:n}=this.drawData,{contourHoleProcessingEnabled:a}=e??{};if(this.haltDrawing(t,n))return!1;const{annotation:i,viewportIdsToRender:r}=this.commonData,s=(0,o.getEnabledElement)(t),{viewport:d,renderingEngine:m}=s,h=(0,l.Q)(this.configuration,i)?(0,l.p)(this.configuration,n):n;this.updateContourPolyline(i,{points:h,closed:!1},d);const{textBox:p}=i.data.handles,f=i.data.contour.polyline;return i.data.handles.points=[f[0],f[f.length-1]],i.data.isOpenUShapeContour&&(i.data.openUShapeContourVectorToPeak=(0,g.A)(n,d)),p.hasMoved||(0,u.triggerContourAnnotationCompleted)(i,a),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,(0,c.A)(r),this.deactivateDraw(t),!0}function y(t){const e=t.detail,{currentPoints:n,lastPoints:o}=e,a=n.canvas,i=o.canvas,{canvasPoints:r}=this.drawData,s=r.slice(0,-1),l=I(s,a,i,!1);if(void 0===l)return;return l[0]}function P(t,e){const n=t.detail,{element:a}=n,{canvasPoints:i,contourHoleProcessingEnabled:r}=this.drawData,{annotation:s,viewportIdsToRender:l}=this.commonData;f(a,i,i[e],this.commonData),i.pop();const d=i.slice(e),c=m.polyline.getArea(d);if(o.utilities.isEqual(c,0))return void i.splice(e+1);i.splice(0,e);const u={contourHoleProcessingEnabled:r,minPointsToSave:3};this.completeDrawClosedContour(a,u)&&this.activateClosedContourEdit(t,s,l)}function M(t){const{allowOpenContours:e}=this.configuration,{canvasPoints:n,contourHoleProcessingEnabled:o}=this.drawData,a=n[0],i=n[n.length-1];e&&!v(a,i,this.configuration.closeContourProximity)?this.completeDrawOpenContour(t,{contourHoleProcessingEnabled:o}):this.completeDrawClosedContour(t,{contourHoleProcessingEnabled:o})}function O(t,e){const{subPixelResolution:n}=this.configuration;if(function(t,e){const n=Math.max(3*e,3);return t.length<n}(e,n)){const{annotation:e,viewportIdsToRender:n}=this.commonData,a=(0,o.getEnabledElement)(t),{renderingEngine:i}=a;return(0,h.removeAnnotation)(e.annotationUID),this.isDrawing=!1,this.drawData=void 0,this.commonData=void 0,(0,c.A)(n),this.deactivateDraw(t),!0}return!1}const T=function(t){t.activateDraw=C.bind(t),t.deactivateDraw=D.bind(t),t.applyCreateOnCross=P.bind(t),t.findCrossingIndexDuringCreate=y.bind(t),t.completeDrawOpenContour=S.bind(t),t.removeCrossedLinesOnCompleteDraw=b.bind(t),t.mouseDragDrawCallback=A.bind(t),t.mouseUpDrawCallback=w.bind(t),t.completeDrawClosedContour=x.bind(t),t.cancelDrawing=M.bind(t),t.haltDrawing=O.bind(t)}},92400:(t,e,n)=>{n.d(e,{A:()=>m});var o=n(3823),a=n(95527);const{addCanvasPointsToArray:i,getFirstLineSegmentIntersectionIndexes:r}=a.polyline;function s(t,e){const n=t.detail,{element:a,currentPoints:s,lastPoints:l}=n,d=s.canvas,c=l.canvas,{editCanvasPoints:u,prevCanvasPoints:g}=this.editData,m=r(g,d,c,e);if(m)this.editData.startCrossingIndex=m[0],this.removePointsUpUntilFirstCrossing(e);else if(g.length>=2)if(u.length>this.configuration.checkCanvasEditFallbackProximity){const t=u[0],e=[];for(let n=0;n<g.length;n++){const a=g[n],i=o.Zc.distance(a,t);e.push({distance:i,index:n})}e.sort((t,e)=>t.distance-e.distance);const n=[e[0],e[1]],a=Math.min(n[0].index,n[1].index);this.editData.startCrossingIndex=a}else{const t=o.Zc.create();o.Zc.subtract(t,u[1],u[0]),o.Zc.normalize(t,t);const n=6,s=[u[0][0]-t[0]*n,u[0][1]-t[1]*n],l=r(g,s,u[0],e);if(l){const t=[s];i(a,t,u[0],this.commonData),u.unshift(...t),this.removePointsUpUntilFirstCrossing(e),this.editData.editIndex=u.length-1,this.editData.startCrossingIndex=l[0]}}}function l(t){const{editCanvasPoints:e,prevCanvasPoints:n}=this.editData;let o=0;for(let a=0;a<e.length-1;a++){const i=[e[a],e[a+1]];if(o++,!!r(n,i[0],i[1],t))break}e.splice(0,o),this.editData.editIndex=e.length-1}function d(t,e){const n=t.detail,{currentPoints:o,lastPoints:a}=n,i=o.canvas,s=a.canvas,{prevCanvasPoints:l}=this.editData;return!!r(l,i,s,e)}function c(t){const{prevCanvasPoints:e,editCanvasPoints:n}=this.editData;for(let o=n.length-1;o>0;o--){const a=[n[o],n[o-1]],i=!!r(e,a[0],a[1],t);if(n.pop(),i)break}}function u(){const{editCanvasPoints:t,prevCanvasPoints:e,startCrossingIndex:n}=this.editData;if(void 0===n)return;const a=t[t.length-1],i=[];for(let t=0;t<e.length;t++){const n=e[t],r=o.Zc.distance(n,a);i.push({distance:r,index:t})}i.sort((t,e)=>t.distance-e.distance);const s=t.slice(0,-1);for(let n=0;n<i.length;n++){const{index:o}=i[n],a=e[o],l=t[t.length-1];if(!r(s,a,l,!1))return o}return-1}function g(t){const e=t.detail,{currentPoints:n,lastPoints:o}=e,a=n.canvas,i=o.canvas,{editCanvasPoints:s}=this.editData,l=s.slice(0,-2),d=r(l,a,i,!1);if(!d)return;const c=d[0],u=s.length-c;for(let t=0;t<u;t++)s.pop()}const m=function(t){t.checkForFirstCrossing=s.bind(t),t.removePointsUpUntilFirstCrossing=l.bind(t),t.checkForSecondCrossing=d.bind(t),t.findSnapIndex=u.bind(t),t.removePointsAfterSecondCrossing=c.bind(t),t.checkAndRemoveCrossesOnEditLine=g.bind(t)}},5403:(t,e,n)=>{n.d(e,{A:()=>a,h:()=>i});var o=n(3823);function a(t,e){const n=t[0],a=t[t.length-1],i=o.Zc.create();o.Zc.set(i,a[0]-n[0],a[1]-n[1]),o.Zc.normalize(i,i);const r=o.Zc.create(),s=o.Zc.create();o.Zc.set(r,-i[1],i[0]),o.Zc.set(s,i[1],-i[0]);const l=[(n[0]+a[0])/2,(n[1]+a[1])/2],d={dist:0,index:null};for(let e=0;e<t.length;e++){const n=t[e],a=o.Zc.dist(n,l);a>d.dist&&(d.dist=a,d.index=e)}return[t[d.index],l].map(e.canvasToWorld)}function i(t,e){const{viewport:n}=t;return a(e.data.contour.polyline.map(n.worldToCanvas),n)}},69855:(t,e,n)=>{n.d(e,{A:()=>y});var o=n(3823),a=n(15327),i=n(85204),r=n(99737),s=n(7001),l=n(95527),d=n(42797),c=n(58640),u=n(72967),g=n(5403),m=n(44049);const{addCanvasPointsToArray:h,getSubPixelSpacingAndXYDirections:p}=l.polyline;function f(t,e,n){this.isEditingOpen=!0;const o=t.detail,{currentPoints:l,element:d}=o,c=l.canvas,u=(0,a.getEnabledElement)(d),{viewport:g}=u;this.doneEditMemo();const m=e.data.contour.polyline.map(g.worldToCanvas),{spacing:h,xDir:f,yDir:v}=p(g,this.configuration.subPixelResolution);this.editData={prevCanvasPoints:m,editCanvasPoints:[c],startCrossingIndex:void 0,editIndex:0},this.commonData={annotation:e,viewportIdsToRender:n,spacing:h,xDir:f,yDir:v,movingTextBox:!1},i.wk.isInteractingWithTool=!0,d.addEventListener(r.Events.MOUSE_UP,this.mouseUpOpenContourEditCallback),d.addEventListener(r.Events.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),d.addEventListener(r.Events.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),d.addEventListener(r.Events.TOUCH_END,this.mouseUpOpenContourEditCallback),d.addEventListener(r.Events.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),d.addEventListener(r.Events.TOUCH_TAP,this.mouseUpOpenContourEditCallback),(0,s.hideElementCursor)(d)}function v(t){i.wk.isInteractingWithTool=!1,t.removeEventListener(r.Events.MOUSE_UP,this.mouseUpOpenContourEditCallback),t.removeEventListener(r.Events.MOUSE_DRAG,this.mouseDragOpenContourEditCallback),t.removeEventListener(r.Events.MOUSE_CLICK,this.mouseUpOpenContourEditCallback),t.removeEventListener(r.Events.TOUCH_END,this.mouseUpOpenContourEditCallback),t.removeEventListener(r.Events.TOUCH_DRAG,this.mouseDragOpenContourEditCallback),t.removeEventListener(r.Events.TOUCH_TAP,this.mouseUpOpenContourEditCallback),(0,s.resetElementCursor)(t)}function I(t){const e=t.detail,{currentPoints:n,element:i}=e,r=n.world,s=n.canvas,l=(0,a.getEnabledElement)(i),{viewport:d}=l,{viewportIdsToRender:u,xDir:g,yDir:m,spacing:p}=this.commonData,{editIndex:f,editCanvasPoints:v,startCrossingIndex:I}=this.editData,E=v[v.length-1],C=d.canvasToWorld(E),D=o.eR.create();this.createMemo(i,this.commonData.annotation),o.eR.subtract(D,r,C);const A=Math.abs(o.eR.dot(D,g)),w=Math.abs(o.eR.dot(D,m));if(A<=p[0]&&w<=p[1])return;void 0!==I&&this.checkAndRemoveCrossesOnEditLine(t);const x=f+h(i,v,s,this.commonData);this.editData.editIndex=x,void 0===I&&v.length>1&&this.checkForFirstCrossing(t,!1),this.editData.snapIndex=this.findSnapIndex(),this.editData.fusedCanvasPoints=this.fuseEditPointsWithOpenContour(t),void 0!==I&&this.checkForSecondCrossing(t,!1)?(this.removePointsAfterSecondCrossing(!1),this.finishEditOpenOnSecondCrossing(t)):this.checkIfShouldOverwriteAnEnd(t)&&this.openContourEditOverwriteEnd(t),(0,c.A)(u)}function E(t){const e=t.detail,{element:n}=e,o=(0,a.getEnabledElement)(n),{viewport:i}=o,{annotation:r,viewportIdsToRender:s}=this.commonData,l=this.fuseEditPointsForOpenContourEndEdit();(0,u.A)(r,{points:l,closed:!1},i);const d=r.data.contour.polyline;r.data.handles.points=[d[0],d[d.length-1]],r.data.handles.activeHandleIndex=1,(0,m.triggerAnnotationModified)(r,n),this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,this.doneEditMemo(),this.deactivateOpenContourEdit(n),this.activateOpenContourEndEdit(t,r,s,null)}function C(t){const e=t.detail,{currentPoints:n,lastPoints:a}=e,i=n.canvas,r=a.canvas,{snapIndex:s,prevCanvasPoints:l,startCrossingIndex:d}=this.editData;if(void 0===d||void 0===s)return!1;if(-1===s)return!0;if(0!==s&&s!==l.length-1)return!1;const c=i,u=r,g=l[s],m=o.Zc.create(),h=o.Zc.create();o.Zc.set(m,c[0]-u[0],c[1]-u[1]),o.Zc.set(h,c[0]-g[0],c[1]-g[1]);const p=o.Zc.dot(m,h),f=Math.sqrt(m[0]*m[0]+m[1]*m[1]),v=Math.sqrt(h[0]*h[0]+h[1]*h[1]);return Math.acos(p/(f*v))<Math.PI/2}function D(){const{snapIndex:t,prevCanvasPoints:e,editCanvasPoints:n,startCrossingIndex:a}=this.editData,i=[];if(0===t)for(let t=e.length-1;t>=a;t--){const n=e[t];i.push([n[0],n[1]])}else for(let t=0;t<a;t++){const n=e[t];i.push([n[0],n[1]])}if(o.Zc.distance(e[a],n[0])<o.Zc.distance(e[a],n[n.length-1]))for(let t=0;t<n.length;t++){const e=n[t];i.push([e[0],e[1]])}else for(let t=n.length-1;t>=0;t--){const e=n[t];i.push([e[0],e[1]])}return i}function A(t){const{prevCanvasPoints:e,editCanvasPoints:n,startCrossingIndex:a,snapIndex:i}=this.editData;if(void 0===a||void 0===i)return;const r=t.detail,{element:s}=r,l=[...n];let d,c;h(s,l,e[i],this.commonData),l.length>n.length&&l.pop(),a>i?(d=i,c=a):(d=a,c=i);const u=o.Zc.distance(e[d],l[0]),g=o.Zc.distance(e[d],l[l.length-1]),m=o.Zc.distance(e[c],l[0]),p=o.Zc.distance(e[c],l[l.length-1]),f=[];for(let t=0;t<d;t++){const n=e[t];f.push([n[0],n[1]])}if(u+p<g+m)for(let t=0;t<l.length;t++){const e=l[t];f.push([e[0],e[1]])}else for(let t=l.length-1;t>=0;t--){const e=l[t];f.push([e[0],e[1]])}for(let t=c;t<e.length;t++){const n=e[t];f.push([n[0],n[1]])}return f}function w(t){const e=t.detail,{element:n}=e,o=(0,a.getEnabledElement)(n),{viewport:i,renderingEngine:r}=o,{annotation:s,viewportIdsToRender:l}=this.commonData,{fusedCanvasPoints:d,editCanvasPoints:g}=this.editData;(0,u.A)(s,{points:d,closed:!1},i);const h=s.data.contour.polyline;s.data.handles.points=[h[0],h[h.length-1]],(0,m.triggerAnnotationModified)(s,n);const p=g.pop();this.editData={prevCanvasPoints:d,editCanvasPoints:[p],startCrossingIndex:void 0,editIndex:0},(0,c.A)(l)}function x(t){const e=t.detail,{element:n}=e;this.completeOpenContourEdit(n)}function b(t){const e=(0,a.getEnabledElement)(t),{viewport:n}=e,{annotation:o,viewportIdsToRender:i}=this.commonData;this.doneEditMemo();const{fusedCanvasPoints:r,prevCanvasPoints:s}=this.editData;if(r){const e=(0,d.Q)(this.configuration)?(0,d.p)(this.configuration,r,s):r,a=this.configuration?.decimate||{};(0,u.A)(o,{points:e,closed:!1},n,{decimate:{enabled:!!a.enabled,epsilon:a.epsilon}});const i=o.data.contour.polyline;o.data.handles.points=[i[0],i[i.length-1]],o.data.isOpenUShapeContour&&(o.data.openUShapeContourVectorToPeak=(0,g.A)(r,n)),(0,m.triggerAnnotationModified)(o,t)}this.isEditingOpen=!1,this.editData=void 0,this.commonData=void 0,(0,c.A)(i),this.deactivateOpenContourEdit(t)}function S(t){this.completeOpenContourEdit(t)}const y=function(t){t.activateOpenContourEdit=f.bind(t),t.deactivateOpenContourEdit=v.bind(t),t.mouseDragOpenContourEditCallback=I.bind(t),t.mouseUpOpenContourEditCallback=x.bind(t),t.fuseEditPointsWithOpenContour=A.bind(t),t.finishEditOpenOnSecondCrossing=w.bind(t),t.checkIfShouldOverwriteAnEnd=C.bind(t),t.fuseEditPointsForOpenContourEndEdit=D.bind(t),t.openContourEditOverwriteEnd=E.bind(t),t.cancelOpenContourEdit=S.bind(t),t.completeOpenContourEdit=b.bind(t)}},70734:(t,e,n)=>{n.d(e,{A:()=>c});var o=n(15327),a=n(85204),i=n(99737),r=n(7001),s=n(95527);const{getSubPixelSpacingAndXYDirections:l}=s.polyline;function d(t,e,n,s){this.isDrawing=!0;const d=t.detail,{element:c}=d,u=(0,o.getEnabledElement)(c),{viewport:g}=u,{spacing:m,xDir:h,yDir:p}=l(g,this.configuration.subPixelResolution),f=e.data.contour.polyline.map(g.worldToCanvas);0===e.data.handles.activeHandleIndex&&f.reverse();let v=!1;s?.worldPosition&&(v=!0),this.drawData={canvasPoints:f,polylineIndex:f.length-1},this.commonData={annotation:e,viewportIdsToRender:n,spacing:m,xDir:h,yDir:p,movingTextBox:v},a.wk.isInteractingWithTool=!0,c.addEventListener(i.Events.MOUSE_UP,this.mouseUpDrawCallback),c.addEventListener(i.Events.MOUSE_DRAG,this.mouseDragDrawCallback),c.addEventListener(i.Events.MOUSE_CLICK,this.mouseUpDrawCallback),c.addEventListener(i.Events.TOUCH_END,this.mouseUpDrawCallback),c.addEventListener(i.Events.TOUCH_DRAG,this.mouseDragDrawCallback),c.addEventListener(i.Events.TOUCH_TAP,this.mouseUpDrawCallback),(0,r.hideElementCursor)(c)}const c=function(t){t.activateOpenContourEndEdit=d.bind(t)}},58161:(t,e,n)=>{n.d(e,{A:()=>v});var o=n(74347),a=n(95527),i=n(5403),r=n(15451);const{pointsAreWithinCloseContourProximity:s}=a.polyline;function l(t,e){const n={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:t.viewport.id,annotationUID:e.annotationUID},{lineWidth:o,lineDash:a,color:i,fillColor:r,fillOpacity:s}=this.getAnnotationStyle({annotation:e,styleSpecifier:n}),{closed:l}=e.data.contour;return{color:i,width:o,lineDash:a,fillColor:r,fillOpacity:s,closePath:l}}function d(t,e,n){t?.viewport?.getImageData()&&(n.data.contour.closed?this.renderClosedContour(t,e,n):n.data.isOpenUShapeContour?(!function(t,e){e.data.openUShapeContourVectorToPeak||(e.data.openUShapeContourVectorToPeak=(0,i.h)(t,e))}(t,n),this.renderOpenUShapedContour(t,e,n)):this.renderOpenContour(t,e,n))}function c(t,e,n){if(n.parentAnnotationUID)return;const{viewport:a}=t,i=this._getRenderingOptions(t,n),s=[n.data.contour.polyline.map(t=>a.worldToCanvas(t)),...(0,r.A)(n,a)];(0,o.drawPath)(e,n.annotationUID,"1",s,i)}function u(t,e,n){const{viewport:a}=t,i=this._getRenderingOptions(t,n),r=n.data.contour.polyline.map(t=>a.worldToCanvas(t));(0,o.drawPolyline)(e,n.annotationUID,"1",r,i);const s=n.data.handles.activeHandleIndex;if(!0===this.configuration.alwaysRenderOpenContourHandles?.enabled){const t=this.configuration.alwaysRenderOpenContourHandles.radius,a="0",l=[r[0],r[r.length-1]];0===s?l.shift():1===s&&l.pop(),(0,o.drawHandles)(e,n.annotationUID,a,l,{color:i.color,handleRadius:t})}if(null!==s){const t="1",a=r[0===s?0:r.length-1];(0,o.drawHandles)(e,n.annotationUID,t,[a],{color:i.color})}}function g(t,e,n){const{viewport:a}=t,{openUShapeContourVectorToPeak:i}=n.data,{polyline:r}=n.data.contour;if(this.renderOpenContour(t,e,n),!i)return;const s=a.worldToCanvas(r[0]),l=a.worldToCanvas(r[r.length-1]),d=[a.worldToCanvas(i[0]),a.worldToCanvas(i[1])],c=this._getRenderingOptions(t,n);(0,o.drawPolyline)(e,n.annotationUID,"first-to-last",[s,l],{color:c.color,width:c.width,closePath:!1,lineDash:"2,2"}),(0,o.drawPolyline)(e,n.annotationUID,"midpoint-to-open-contour",[d[0],d[1]],{color:c.color,width:c.width,closePath:!1,lineDash:"2,2"})}function m(t,e,n){const a=this._getRenderingOptions(t,n),{allowOpenContours:i}=this.configuration,{canvasPoints:r}=this.drawData;if(a.closePath=!1,(0,o.drawPolyline)(e,n.annotationUID,"1",r,a),i){const t=r[0],i=r[r.length-1];if(s(t,i,this.configuration.closeContourProximity))(0,o.drawPolyline)(e,n.annotationUID,"2",[i,t],a);else{const i="0";(0,o.drawHandles)(e,n.annotationUID,i,[t],{color:a.color,handleRadius:2})}}}function h(t,e,n){const{viewport:a}=t,{fusedCanvasPoints:i}=this.editData;if(void 0===i)return void this.renderClosedContour(t,e,n);const s=[i,...(0,r.A)(n,a)],l=this._getRenderingOptions(t,n);n.parentAnnotationUID&&l.fillOpacity&&(l.fillOpacity=0),(0,o.drawPath)(e,n.annotationUID,"preview-1",s,l)}function p(t,e,n){const{fusedCanvasPoints:a}=this.editData;if(void 0===a)return void this.renderOpenContour(t,e,n);const i=this._getRenderingOptions(t,n);(0,o.drawPolyline)(e,n.annotationUID,"preview-1",a,i)}function f(t,e,n){if(n.parentAnnotationUID)return;const{viewport:a}=t,i=this._getRenderingOptions(t,n),s=n.data.contour.polyline.map(t=>a.worldToCanvas(t)),l=(0,r.A)(n,a),d=s[0],c=[];for(let t=0;t<100;t++){const e=t/100*2*Math.PI,n=d[0]+6*Math.cos(e),o=d[1]+6*Math.sin(e);c.push([n,o])}const u=[[d[0]-12,d[1]],[d[0]+12,d[1]],[d[0],d[1]-12],[d[0],d[1]+12]];(0,o.drawPath)(e,n.annotationUID,"1-crosshair_v",[u[0],u[1]],i),(0,o.drawPath)(e,n.annotationUID,"1-crosshair_h",[u[2],u[3]],i);const g=[c,...l];(0,o.drawPath)(e,n.annotationUID,"1",g,i)}const v=function(t){t.renderContour=d.bind(t),t.renderClosedContour=c.bind(t),t.renderOpenContour=u.bind(t),t.renderPointContourWithMarker=f.bind(t),t.renderOpenUShapedContour=g.bind(t),t.renderContourBeingDrawn=m.bind(t),t.renderClosedContourBeingEdited=h.bind(t),t.renderOpenContourBeingEdited=p.bind(t),t._getRenderingOptions=l.bind(t)}},91350:(t,e,n)=>{n.d(e,{A:()=>f});var o=n(15327),a=n(3823),i=n(6030),r=n(2076),s=n(29601),l=n(82056),d=n(44049),c=n(75183),u=n(17343),g=n(56534);const{DefaultHistoryMemo:m}=o.utilities.HistoryMemo,{PointsManager:h}=o.utilities;class p extends i.A{static createAnnotation(...t){let e={annotationUID:null,highlighted:!0,invalidated:!0,metadata:{toolName:this.toolName},data:{text:"",handles:{points:new Array,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:""}};for(const n of t)e=o.utilities.deepMerge(e,n);return e}static createAnnotationForViewport(t,...e){return this.createAnnotation({metadata:t.getViewReference()},...e)}static createAndAddAnnotation(t,...e){const n=this.createAnnotationForViewport(t,...e);(0,l.addAnnotation)(n,t.element),(0,d.triggerAnnotationModified)(n,t.element)}constructor(t,e){super(t,e),this.mouseMoveCallback=(t,e)=>{if(!e)return!1;const{element:n,currentPoints:o}=t.detail,a=o.canvas;let i=!1;for(const t of e){if((0,r.isAnnotationLocked)(t.annotationUID)||!(0,s.isAnnotationVisible)(t.annotationUID))continue;const{data:e}=t,o=e.handles?e.handles.activeHandleIndex:void 0,l=this._imagePointNearToolOrHandle(n,t,a,6),d=l&&!t.highlighted,c=!l&&t.highlighted;d||c?(t.highlighted=!t.highlighted,i=!0):e.handles&&e.handles.activeHandleIndex!==o&&(i=!0)}return i},this.isSuvScaled=p.isSuvScaled,t.configuration?.getTextLines&&(this.configuration.getTextLines=t.configuration.getTextLines),t.configuration?.statsCalculator&&(this.configuration.statsCalculator=t.configuration.statsCalculator)}getHandleNearImagePoint(t,e,n,i){const r=(0,o.getEnabledElement)(t),{viewport:s}=r,{data:l}=e,{isCanvasAnnotation:d}=l,{points:c,textBox:u}=l.handles;if(u){const{worldBoundingBox:t}=u;if(t){const e={topLeft:s.worldToCanvas(t.topLeft),topRight:s.worldToCanvas(t.topRight),bottomLeft:s.worldToCanvas(t.bottomLeft),bottomRight:s.worldToCanvas(t.bottomRight)};if(n[0]>=e.topLeft[0]&&n[0]<=e.bottomRight[0]&&n[1]>=e.topLeft[1]&&n[1]<=e.bottomRight[1])return l.handles.activeHandleIndex=null,u}}for(let t=0;t<c?.length;t++){const e=c[t],o=d?e.slice(0,2):s.worldToCanvas(e);if(!0===a.Zc.distance(n,o)<i)return l.handles.activeHandleIndex=t,e}l.handles.activeHandleIndex=null}getLinkedTextBoxStyle(t,e){return{visibility:this.getStyle("textBoxVisibility",t,e),fontFamily:this.getStyle("textBoxFontFamily",t,e),fontSize:this.getStyle("textBoxFontSize",t,e),color:this.getStyle("textBoxColor",t,e),shadow:this.getStyle("textBoxShadow",t,e),background:this.getStyle("textBoxBackground",t,e),lineWidth:this.getStyle("textBoxLinkLineWidth",t,e),lineDash:this.getStyle("textBoxLinkLineDash",t,e)}}static isSuvScaled(t,e,n){if(t instanceof o.BaseVolumeViewport){const t=o.utilities.getVolumeId(e),n=o.cache.getVolume(t);return void 0!==n?.scaling?.PT}const a=n&&o.metaData.get("scalingModule",n);return"number"==typeof a?.suvbw}getAnnotationStyle(t){const{annotation:e,styleSpecifier:n}=t,o=t=>this.getStyle(t,n,e),{annotationUID:a}=e,i=(0,s.isAnnotationVisible)(a),l=(0,r.isAnnotationLocked)(a),d=o("lineWidth"),c=o("lineDash"),u=o("angleArcLineDash"),g=o("color"),m=o("markerSize");return{visibility:i,locked:l,color:g,lineWidth:d,lineDash:c,lineOpacity:1,fillColor:g,fillOpacity:0,shadow:o("shadow"),textbox:this.getLinkedTextBoxStyle(n,e),markerSize:m,angleArcLineDash:u}}_imagePointNearToolOrHandle(t,e,n,o){if(this.getHandleNearImagePoint(t,e,n,o))return!0;return!!this.isPointNearTool(t,e,n,o,"mouse")||void 0}static createAnnotationState(t,e){const{data:n,annotationUID:o}=t,a={...n,cachedStats:{}};delete a.contour,delete a.spline;const i={annotationUID:o,data:structuredClone(a),deleting:e},r=n.contour;return r&&(i.data.contour={...r,polyline:null,pointsManager:h.create3(r.polyline.length,r.polyline)}),i}static createAnnotationMemo(t,e,n){if(!e)return;const{newAnnotation:a,deleting:i=!a&&void 0}=n||{},{annotationUID:r}=e,s=p.createAnnotationState(e,i),h={restoreMemo:()=>{const n=p.createAnnotationState(e,i),{viewport:a}=(0,o.getEnabledElement)(t)||{};if(a?.setViewReference(e.metadata),!0===s.deleting){if(s.deleting=!1,Object.assign(e.data,s.data),e.data.contour){const t=e.data;t.contour.polyline=s.data.contour.pointsManager.points,delete s.data.contour.pointsManager,t.segmentation&&(0,g.addContourSegmentationAnnotation)(e)}return s.data=n.data,(0,l.addAnnotation)(e,t),(0,u.setAnnotationSelected)(e.annotationUID,!0),void a?.render()}if(!1===s.deleting)return s.deleting=!0,s.data=n.data,(0,u.setAnnotationSelected)(e.annotationUID),(0,l.removeAnnotation)(e.annotationUID),void a?.render();const m=(0,l.getAnnotation)(r);m?(Object.assign(m.data,s.data),m.data.contour&&(m.data.contour.polyline=s.data.contour.pointsManager.points),s.data=n.data,m.invalidated=!0,(0,d.triggerAnnotationModified)(m,t,c.A.History)):console.warn("No current annotation")},id:r,operationType:"annotation"};return m.push(h),h}createMemo(t,e,n){this.memo||=p.createAnnotationMemo(t,e,n)}static hydrateBase(t,e,n,a={}){if(!e)return null;const{viewport:i}=e,r=i.getFrameOfReferenceUID(),s=i.getCamera(),l=a.viewplaneNormal??s.viewPlaneNormal,d=a.viewUp??s.viewUp,c=a.toolInstance||new t;let u,g=l,m=d;if(a.referencedImageId)u=a.referencedImageId,g=void 0,m=void 0;else if(i instanceof o.StackViewport){const t=o.utilities.getClosestStackImageIndexForPoint(n[0],i);void 0!==t&&(u=i.getImageIds()[t])}else{if(!(i instanceof o.BaseVolumeViewport))throw new Error("Unsupported viewport type");u=c.getReferencedImageId(i,n[0],l,d)}return{FrameOfReferenceUID:r,referencedImageId:u,viewPlaneNormal:g,viewUp:m,instance:c,viewport:i}}}p.toolName="AnnotationTool";const f=p},36320:(t,e,n)=>{n.d(e,{A:()=>A});var o=n(15327),a=n(99737),i=n(82056),r=n(74347),s=n(91350),l=n(72967),d=n(15451);class c extends s.A{constructor(t,e){super(t,e)}renderAnnotation(t,e){let n=!1;const{viewport:o}=t,{element:a}=o;if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let r=(0,i.getAnnotations)(this.getToolName(),a);if(!r?.length)return n;if(r=this.filterInteractableAnnotationsForElement(a,r),!r?.length)return n;const s=this.getTargetId(o),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:t.viewport.id};for(let o=0;o<r.length;o++){const a=r[o];l.annotationUID=a.annotationUID;const i=this.getAnnotationStyle({annotation:a,styleSpecifier:l});if(!i.visibility)continue;const d=this.renderAnnotationInstance({enabledElement:t,targetId:s,annotation:a,annotationStyle:i,svgDrawingHelper:e});n||=d,a.invalidated=!1}return n}createAnnotation(t){const e=super.createAnnotation(t);return Object.assign(e.data,{contour:{polyline:[],closed:!1}}),Object.assign(e,{interpolationUID:"",autoGenerated:!1}),e}addAnnotation(t,e){return(0,i.addAnnotation)(t,e)}cancelAnnotation(t){}moveAnnotation(t,e){const{points:n}=t.data.handles;for(let t=0,o=n.length;t<o;t++){const o=n[t];o[0]+=e[0],o[1]+=e[1],o[2]+=e[2]}t.invalidated=!0,(0,i.getChildAnnotations)(t).forEach(t=>this.moveAnnotation(t,e))}updateContourPolyline(t,e,n,o){const a=this.configuration?.decimate||{};(0,l.A)(t,e,n,{decimate:{enabled:!!a.enabled,epsilon:a.epsilon},updateWindingDirection:o?.updateWindingDirection})}getPolylinePoints(t){return t.data.contour?.polyline??t.data.polyline}renderAnnotationInstance(t){const{enabledElement:e,annotationStyle:n,svgDrawingHelper:o}=t,a=t.annotation;if(a.parentAnnotationUID)return;const{annotationUID:i}=a,{viewport:s}=e,{worldToCanvas:l}=s,c=this.getPolylinePoints(a).map(t=>l(t)),{lineWidth:u,lineDash:g,color:m,fillColor:h,fillOpacity:p}=n,f=[c,...(0,d.A)(a,s)];return(0,r.drawPath)(o,i,"contourPolyline",f,{color:m,lineDash:g,lineWidth:Math.max(.1,u),fillColor:h,fillOpacity:p}),!0}}var u=n(49906),g=n(27740),m=n(56534),h=n(94779),p=n(77609),f=n(93210),v=n(67165),I=n(58859),E=n(60740),C=n(26795),D=n(86644);class A extends c{static{this.PreviewSegmentIndex=255}constructor(t,e){super(t,e),this.configuration.interpolation?.enabled&&g.A.addTool(this.getToolName())}isContourSegmentationTool(){return!0}createAnnotation(t){const e=t.detail,{element:n}=e,a=(0,o.getEnabledElement)(n);if(!a)return;const{viewport:i}=a,r=super.createAnnotation(t);if(!this.isContourSegmentationTool())return r;const s=(0,v.T)(i.id);if(!s)throw new Error("No active segmentation detected, create one before using scissors tool");if(!s.representationData.Contour)throw new Error("A contour segmentation must be active");const{segmentationId:l}=s,d=(0,E.Q)(l);return o.utilities.deepMerge(r,{data:{segmentation:{segmentationId:l,segmentIndex:d}}})}addAnnotation(t,e){const n=super.addAnnotation(t,e);if(this.isContourSegmentationTool()){const e=t;(0,m.addContourSegmentationAnnotation)(e)}return n}cancelAnnotation(t){this.isContourSegmentationTool()&&(0,m.removeContourSegmentationAnnotation)(t),super.cancelAnnotation(t)}getAnnotationStyle(t){const e=super.getAnnotationStyle(t);if(!this.isContourSegmentationTool())return e;const n=this._getContourSegmentationStyle(t);return o.utilities.deepMerge(e,n)}renderAnnotationInstance(t){const{annotation:e}=t,{invalidated:n}=e,o=super.renderAnnotationInstance(t);if(n&&this.isContourSegmentationTool()){const{segmentationId:t}=e.data.segmentation;(0,u.triggerSegmentationDataModified)(t);const n=(0,I.P)(t).map(t=>(0,p.getToolGroupForViewport)(t).id);(0,h._)(n)}return o}_getContourSegmentationStyle(t){const e=t.annotation,{segmentationId:n,segmentIndex:o}=e.data.segmentation,{viewportId:i}=t.styleSpecifier,r=(0,f.r$)(i,{segmentationId:n});if(!r?.length)return{};let s;s=r.length>1?r.find(t=>t.segmentationId===n&&t.type===a.SegmentationRepresentations.Contour):r[0];const{autoGenerated:l}=e,d=(0,C.getLockedSegmentIndices)(n).includes(o),{color:c,fillColor:u,lineWidth:g,fillOpacity:m,lineDash:h,visibility:p}=(0,D.u)({segmentationId:n,segmentIndex:o,viewportId:i,autoGenerated:l});return{color:c,fillColor:u,lineWidth:g,fillOpacity:m,lineDash:h,textbox:{color:c},visibility:p,locked:d}}}},67772:(t,e,n)=>{n.d(e,{A:()=>a});const o={renderOutline:!0,outlineWidthAutoGenerated:3,outlineWidth:1,outlineWidthInactive:1,outlineOpacity:1,outlineOpacityInactive:.85,outlineDash:void 0,outlineDashInactive:void 0,outlineDashAutoGenerated:"5,3",activeSegmentOutlineWidthDelta:0,renderFill:!0,fillAlpha:.5,fillAlphaInactive:.3,fillAlphaAutoGenerated:.3};const a=function(){return o}},22384:(t,e,n)=>{n.d(e,{d:()=>d});var o=n(82056),a=n(15327),i=n(64485),r=n(56534);n(35056),n(74966),n(87275);var s=n(99737),l=n(92686);function d(t,e,n,d){n.size?t.render():function(t,e,n){const{segmentationId:d}=n,c=new Map;e.forEach(e=>{const n=a.cache.getGeometry(e);if(!n)return void console.warn(`No geometry found for geometryId ${e}. Skipping render.`);const u=n.data.segmentIndex;!function(t){if(!t)throw new Error(`No contours found for geometryId ${t.id}`);const e=t.id;if(t.type!==a.Enums.GeometryType.CONTOUR)throw new Error(`Geometry type ${t.type} not supported for rendering.`);t.data||console.warn(`No contours found for geometryId ${e}. Skipping render.`)}(n);const g=l.Y.getStyle({viewportId:t.id,segmentationId:d,type:s.SegmentationRepresentations.Contour,segmentIndex:u}),m=n.data,h=t.getCamera().viewPlaneNormal;m.contours.forEach(e=>{const{points:n,color:s,id:l}=e,c=(0,i.x)(t,n[0],h),g={annotationUID:a.utilities.uuidv4(),data:{contour:{closed:!0,polyline:n},segmentation:{segmentationId:d,segmentIndex:u,color:s,id:l},handles:{}},handles:{},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!0,isVisible:!0,metadata:{referencedImageId:c,toolName:"PlanarFreehandContourSegmentationTool",FrameOfReferenceUID:t.getFrameOfReferenceUID(),viewPlaneNormal:t.getCamera().viewPlaneNormal}},m=t.element;(0,o.addAnnotation)(g,m),(0,r.addContourSegmentationAnnotation)(g)}),g&&c.set(u,g)}),t.render()}(t,e,d)}},87420:(t,e,n)=>{n.d(e,{A:()=>i});var o=n(33283),a=n(6802);const i=function(t,e,n=!1){const i=(0,o.T)(e),{annotationUIDsMap:r}=i.representationData.Contour;r.forEach(t=>{t.forEach(t=>{(0,a.O8)(t)})})}},63597:(t,e,n)=>{n.d(e,{A:()=>u});var o=n(15327),a=n(97577),i=n(33283),r=n(49906),s=n(99737);const l=new Map,d=({cfun:t,ofun:e,actor:n})=>{n.getProperty().setRGBTransferFunction(1,t),n.getProperty().setScalarOpacity(1,e)};const{uuidv4:c}=o.utilities;const u=async function(t,e,n,u){const g=(0,o.getEnabledElement)(t),{renderingEngine:m,viewport:h}=g,{id:p}=h;if(h instanceof o.BaseVolumeViewport){const t=function(t,e){let{volumeId:n}=t;if(!n){n=c();const o=(0,i.T)(e);o.representationData.Labelmap={...o.representationData.Labelmap,volumeId:n},t.volumeId=n,(0,r.triggerSegmentationModified)(e)}return n}(e,n);o.cache.getVolume(t)||await async function(t){const e=t;if(!(e.imageIds.length>0))throw new Error("cannot create labelmap, no imageIds found for the volume labelmap");const n=await o.volumeLoader.createAndCacheVolumeFromImages(t.volumeId||c(),e.imageIds);return n}(e);let a=u?.blendMode??o.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND,g=a===o.Enums.BlendModes.LABELMAP_EDGE_PROJECTION_BLEND;if(g){const e=h.getVolumeId(),n=o.cache.getVolume(e),i=o.cache.getVolume(t).dimensions,r=n.dimensions;i[0]===r[0]&&i[1]===r[1]&&i[2]===r[2]||(g=!1,a=o.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND,console.debug("Dimensions mismatch - falling back to regular volume addition"))}const f=[{volumeId:t,visibility:true,representationUID:`${n}-${s.SegmentationRepresentations.Labelmap}`,useIndependentComponents:g,blendMode:a}];if(f[0].useIndependentComponents){const t=await async function({viewport:t,volumeInputs:e,segmentationId:n}){const a=t.getDefaultActor(),{actor:r}=a,{uid:c,callback:u}=a,g=t.getVolumeId();if(l.get(c)?.added)return{uid:c,actor:r};const m=e,h=o.cache.getVolume(m[0].volumeId);if(!h)throw new Error(`imageVolume with id: ${h.volumeId} does not exist`);const{volumeId:p}=m[0],f=await o.volumeLoader.loadVolume(p);if(!f)throw new Error(`segImageVolume with id: ${f.volumeId} does not exist`);const v=f.voxelManager.getCompleteScalarDataArray(),{imageData:I}=f,E=o.cache.getVolume(g),C=E.voxelManager.getCompleteScalarDataArray(),D=new Float32Array(2*E.voxelManager.getScalarDataLength()),A=I.getDimensions();for(let t=0;t<A[2];++t)for(let e=0;e<A[1];++e)for(let n=0;n<A[0];++n){const o=n+A[0]*(e+A[1]*t);D[2*o+0]=C[o],D[2*o+1]=v[o]}t.removeActors([c]);const w=r.getMapper(),x=(0,o.convertMapperToNotSharedMapper)(w);r.setMapper(x),x.setBlendMode(o.Enums.BlendModes.LABELMAP_EDGE_PROJECTION_BLEND);const b=x.getInputData().getPointData().getArray(0);function S(e){const{segmentationId:n}=e.detail,{representationData:a}=(0,i.T)(n),{volumeId:r}=a.Labelmap;if(r!==f.volumeId)return;const s=o.cache.getVolume(r).voxelManager,l=x.getInputData(),d=l.getPointData().getArray(0),c=d.getData(),u=I.getDimensions(),g=Array.from({length:u[2]},(t,e)=>e);for(const t of g)for(let e=0;e<u[1];++e)for(let n=0;n<u[0];++n){const o=n+u[0]*(e+u[1]*t);c[2*o+1]=s.getAtIndex(o)}d.setData(c),l.modified(),t.render()}return b.setData(D),b.setNumberOfComponents(2),r.getProperty().setColorMixPreset(1),r.getProperty().setForceNearestInterpolation(1,!0),r.getProperty().setIndependentComponents(!0),t.addActor({actor:r,uid:c,callback:u,referencedId:g,representationUID:`${n}-${s.SegmentationRepresentations.Labelmap}`}),l.set(c,{added:!0,segmentationRepresentationUID:`${n}`,originalBlendMode:t.getBlendMode()}),r.set({preLoad:d}),o.eventTarget.addEventListenerDebounced(s.Events.SEGMENTATION_DATA_MODIFIED,S,200),o.eventTarget.addEventListener(s.Events.SEGMENTATION_REPRESENTATION_REMOVED,async e=>{o.eventTarget.removeEventListener(s.Events.SEGMENTATION_DATA_MODIFIED,S);const n=t.getActor(c),{element:a,id:i}=t;t.removeActors([c]);const r=await(0,o.createVolumeActor)({volumeId:c,blendMode:o.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND,callback:({volumeActor:t})=>{n.callback&&n.callback({volumeActor:t,volumeId:p})}},a,i);t.addActor({actor:r,uid:c}),t.render()}),{uid:c,actor:r}}({viewport:h,volumeInputs:f,segmentationId:n});return t}await(0,o.addVolumesToViewports)(m,f,[p],false,true)}else{const t=(0,a.aF)(h.id,n).map(t=>({imageId:t,representationUID:`${n}-${s.SegmentationRepresentations.Labelmap}-${t}`}));(0,o.addImageSlicesToViewports)(m,t,[p])}(0,r.triggerSegmentationDataModified)(n)}},53486:(t,e,n)=>{n.d(e,{A:()=>a});const o={renderOutline:!0,renderOutlineInactive:!0,outlineWidth:3,outlineWidthInactive:2,activeSegmentOutlineWidthDelta:0,renderFill:!0,renderFillInactive:!0,fillAlpha:.5,fillAlphaInactive:.4,outlineOpacity:1,outlineOpacityInactive:.85};const a=function(){return o}},88234:(t,e,n)=>{n.d(e,{A:()=>i});var o=n(15327),a=n(59452);const i=function(t,e){const n=(0,o.getEnabledElement)(t),{viewport:i}=n;i.removeActors([(0,a.Qe)(i.id,e)])}},18796:(t,e,n)=>{n.d(e,{A:()=>d});var o=n(15327),a=n(82409),i=n(7019),r=n(87275),s=n(35056),l=n(59452);const d=function(t,e,n){const d=(0,o.getEnabledElement)(t),{viewport:c}=d,u=(0,l.Th)(c.id,n,e.segmentIndex),g=u?.actor,m=e.visible;if(g){if(g.setVisibility(m),!m)return;const t=g.getMapper(),n=t.getInputData(),o=e.points,a=e.polys,i=n.getPoints().getData(),l=n.getPolys().getData();if(o.length===i.length&&a.length===l.length)return;const d=r.Ay.newInstance();d.getPoints().setData(o,3);const u=s.Ay.newInstance({values:Float32Array.from(a)});return d.setPolys(u),t.setInputData(d),t.modified(),void c.getRenderer().resetCameraClippingRange()}const h=e.points,p=e.polys,f=e.color,v=r.Ay.newInstance();v.getPoints().setData(h,3);const I=s.Ay.newInstance({values:Float32Array.from(p)});v.setPolys(I);const E=a.Ay.newInstance({});E.setInputData(v);const C=i.Ay.newInstance();C.setMapper(E),C.getProperty().setColor(f[0]/255,f[1]/255,f[2]/255),C.getProperty().setLineWidth(2);const D=(0,l.DU)(n,e.segmentIndex);c.addActor({uid:o.utilities.uuidv4(),actor:C,clippingFilter:undefined,representationUID:D}),c.resetCamera(),c.getRenderer().resetCameraClippingRange(),c.render()}},20552:(t,e,n)=>{n.d(e,{A:()=>a});var o=n(15327);const a=function(t,e){const n=(0,o.getEnabledElement)(t),{viewport:a}=n,i=a.getActors().filter(t=>t.representationUID&&"string"==typeof t.representationUID&&t.representationUID.startsWith(e));a.removeActors(i.map(t=>t.uid))}},55887:(t,e,n)=>{n.d(e,{A:()=>s});n(15327);var o=n(49906),a=n(11990),i=n(40905),r=n(99737);class s{static{this.COMPOSITIONS=a.A}static{this.childFunctions={[r.StrategyCallbacks.OnInteractionStart]:l(r.StrategyCallbacks.OnInteractionStart,r.StrategyCallbacks.Initialize),[r.StrategyCallbacks.OnInteractionEnd]:l(r.StrategyCallbacks.OnInteractionEnd,r.StrategyCallbacks.Initialize),[r.StrategyCallbacks.Fill]:l(r.StrategyCallbacks.Fill),[r.StrategyCallbacks.Initialize]:l(r.StrategyCallbacks.Initialize),[r.StrategyCallbacks.CreateIsInThreshold]:d(r.StrategyCallbacks.CreateIsInThreshold),[r.StrategyCallbacks.Interpolate]:l(r.StrategyCallbacks.Interpolate,r.StrategyCallbacks.Initialize),[r.StrategyCallbacks.AcceptPreview]:l(r.StrategyCallbacks.AcceptPreview,r.StrategyCallbacks.Initialize),[r.StrategyCallbacks.RejectPreview]:l(r.StrategyCallbacks.RejectPreview,r.StrategyCallbacks.Initialize),[r.StrategyCallbacks.INTERNAL_setValue]:d(r.StrategyCallbacks.INTERNAL_setValue),[r.StrategyCallbacks.Preview]:d(r.StrategyCallbacks.Preview,!1),[r.StrategyCallbacks.ComputeInnerCircleRadius]:l(r.StrategyCallbacks.ComputeInnerCircleRadius),[r.StrategyCallbacks.EnsureSegmentationVolumeFor3DManipulation]:l(r.StrategyCallbacks.EnsureSegmentationVolumeFor3DManipulation),[r.StrategyCallbacks.EnsureImageVolumeFor3DManipulation]:l(r.StrategyCallbacks.EnsureImageVolumeFor3DManipulation),[r.StrategyCallbacks.AddPreview]:l(r.StrategyCallbacks.AddPreview),[r.StrategyCallbacks.GetStatistics]:d(r.StrategyCallbacks.GetStatistics),compositions:null}}constructor(t,...e){this._initialize=[],this._fill=[],this._onInteractionStart=[],this.fill=(t,e)=>{const n=this.initialize(t,e,r.StrategyCallbacks.Fill);if(!n)return;this._fill.forEach(t=>t(n));const{segmentationVoxelManager:a,segmentIndex:i}=n;return(0,o.triggerSegmentationDataModified)(n.segmentationId,a.getArrayOfModifiedSlices(),i),n},this.onInteractionStart=(t,e)=>{const n=this.initialize(t,e);n&&this._onInteractionStart.forEach(t=>t.call(this,n))},this.addPreview=(t,e)=>{const n=this.initialize(t,e,r.StrategyCallbacks.AddPreview);if(n)return n},this.configurationName=t,this.compositions=e,e.forEach(t=>{const e="function"==typeof t?t():t;if(e)for(const t in e){if(!s.childFunctions[t])throw new Error(`Didn't find ${t} as a brush strategy`);s.childFunctions[t](this,e[t])}}),this.strategyFunction=(t,e)=>this.fill(t,e);for(const t of Object.keys(s.childFunctions))this.strategyFunction[t]=this[t]}initialize(t,e,n){const{viewport:o}=t,a=(0,i.S)({operationData:e,viewport:o,strategy:this});if(!a)return null;const{imageVoxelManager:r,segmentationVoxelManager:s,segmentationImageData:l}=a,d=e.createMemo(e.segmentationId,s),c={operationName:n,...e,segmentIndex:e.segmentIndex,enabledElement:t,imageVoxelManager:r,segmentationVoxelManager:s,segmentationImageData:l,viewport:o,centerWorld:null,isInObject:null,isInObjectBoundsIJK:null,brushStrategy:this,memo:d};return this._initialize.forEach(t=>t(c)),c}}function l(t,e){const n=`_${t}`;return(o,a)=>{o[n]||=[],o[n].push(a),o[t]||=e?(a,i,...r)=>{const s=o[e](a,i,t);let l;return o[n].forEach(t=>{const e=t.call(o,s,...r);l||=e}),l}:(t,...e)=>{o[n].forEach(n=>n.call(o,t,...e))}}}function d(t,e=!0){return(n,o)=>{if(n[t])throw new Error(`The singleton method ${t} already exists`);n[t]=e?o:(t,e,...a)=>(e.enabledElement=t,o.call(n,e,...a))}}},11990:(t,e,n)=>{n.d(e,{A:()=>w});var o=n(84093);const a={[o.A.OnInteractionStart]:t=>{const{segmentIndex:e,previewSegmentIndex:n,segmentationVoxelManager:o,centerIJK:a,viewPlaneNormal:i,segmentationImageData:r,configuration:s}=t;if(!s?.useCenterSegmentIndex)return;let l=!1,d=!1;const c=[...o.getBoundsIJK()];Math.abs(i[0])>.8?c[0]=[a[0],a[0]]:Math.abs(i[1])>.8?c[1]=[a[1],a[1]]:Math.abs(i[2])>.8&&(c[2]=[a[2],a[2]]);if(o.forEach(({value:t})=>{l||=t===e,d||=t===n},{imageData:r,isInObject:t.isInObject,boundsIJK:c}),!l&&!d)return void(t.centerSegmentIndexInfo.segmentIndex=null);const u=o.getAtIJKPoint(a);t.centerSegmentIndexInfo.segmentIndex=u,t.centerSegmentIndexInfo.hasSegmentIndex=l,t.centerSegmentIndexInfo.hasPreviewIndex=d}};var i=n(3823);const r={[o.A.Initialize]:t=>{const{operationName:e,centerIJK:n,segmentationVoxelManager:a,imageVoxelManager:r,configuration:s,segmentIndex:l,viewport:d}=t;if(!s?.threshold?.isDynamic||!n||!l)return;if(e===o.A.RejectPreview||e===o.A.OnInteractionEnd)return;const c=a.getBoundsIJK(),{range:u,dynamicRadius:g=0}=s.threshold,m=u?0:g,{viewPlaneNormal:h}=d.getCamera(),p=c.map((t,e)=>{const[o,a]=t;return[Math.max(o,n[e]-m),Math.min(a,n[e]+m)]});Math.abs(h[0])>.8?p[0]=[n[0],n[0]]:Math.abs(h[1])>.8?p[1]=[n[1],n[1]]:Math.abs(h[2])>.8&&(p[2]=[n[2],n[2]]);const f=u||[1/0,-1/0],v=m*m;r.forEach(({value:t,pointIJK:e})=>{if(i.eR.sqrDist(n,e)>v)return;const o=Array.isArray(t)?i.eR.len(t):t;f[0]=Math.min(o,f[0]),f[1]=Math.max(o,f[1])},{boundsIJK:p}),s.threshold.range=f},[o.A.OnInteractionStart]:t=>{const{configuration:e}=t;e?.threshold?.isDynamic&&(e.threshold.range=null)},[o.A.ComputeInnerCircleRadius]:t=>{const{configuration:e,viewport:n}=t,{dynamicRadius:o=0,isDynamic:a}=e.threshold;if(!a)return void(e.threshold.dynamicRadiusInCanvas=0);if(0===o)return;const i=n.getImageData();if(!i)return;const{spacing:r}=i,s=[n.element.clientWidth/2,n.element.clientHeight/2],l=o*r[0],d=n.canvasToWorld(s).map(t=>t+l),c=n.worldToCanvas(d),u=Math.abs(s[0]-c[0]);e.threshold.dynamicRadiusInCanvas||(e.threshold.dynamicRadiusInCanvas=0),e.threshold.dynamicRadiusInCanvas=3+u}},s={[o.A.Initialize]:t=>{t.segmentIndex=0}};var l=n(49906),d=n(67912);const c={[o.A.OnInteractionEnd]:t=>{const{previewSegmentIndex:e,segmentIndex:n,viewport:o,segmentationVoxelManager:a,activeStrategy:i,memo:r}=t;if("THRESHOLD_INSIDE_SPHERE_WITH_ISLAND_REMOVAL"!==i||null===n)return;const s=new d.A,c=r?.voxelManager||a;if(!s.initialize(o,c,{previewSegmentIndex:e,segmentIndex:n}))return;s.floodFillSegmentIsland(),s.removeExternalIslands(),s.removeInternalIslands();const u=c.getArrayOfModifiedSlices();u&&(0,l.triggerSegmentationDataModified)(t.segmentationId,u,e)}};var u=n(15327),g=n(98798),m=n(93733),h=n(58859);const p={[o.A.Preview]:function(t){const{previewSegmentIndex:e,configuration:n,enabledElement:o}=t;if(!e||!n)return;this.onInteractionStart?.(o,t);const a=this.fill(o,t);return a&&this.onInteractionEnd?.(o,t),a},[o.A.Initialize]:t=>{const{segmentIndex:e,previewColor:n,previewSegmentIndex:o}=t;if(null==o||null==e)return;const a=(0,h.P)(t.segmentationId);a?.forEach(e=>{(0,m.setSegmentIndexColor)(e,t.segmentationId,o,n)})},[o.A.AcceptPreview]:t=>{const{previewSegmentIndex:e,segmentationVoxelManager:n,memo:o,segmentIndex:a,centerSegmentIndexInfo:i}=t||{},{changedIndices:r}=i||{},s=o;n.forEach(({index:t})=>{const o=n.getAtIndex(t);r?.length>0?r.includes(t)&&s.voxelManager.setAtIndex(t,0):o===e&&s.voxelManager.setAtIndex(t,a)}),(0,g.Q)(t.segmentationId,n.getArrayOfModifiedSlices(),a),t.centerSegmentIndexInfo.changedIndices=[]},[o.A.RejectPreview]:t=>{t&&u.utilities.HistoryMemo.DefaultHistoryMemo.undoIf(e=>{const n=e;if(!n?.voxelManager)return!1;const{segmentationVoxelManager:o}=n;let a=!1;return o.forEach(({value:e})=>{e===t.previewSegmentIndex&&(a=!0)}),a})}},f={[o.A.Fill]:t=>{const{segmentsLocked:e,segmentationImageData:n,segmentationVoxelManager:o,brushStrategy:a,centerIJK:i}=t,r=a.createIsInThreshold?.(t),{setValue:s}=a,l=r?n=>{const{value:o,index:a}=n;!e.includes(o)&&r(a)&&s(t,n)}:e=>s(t,e);o.forEach(l,{imageData:n,isInObject:t.isInObject,boundsIJK:t.isInObjectBoundsIJK}),o.addPoint(i)}};const v={[o.A.INTERNAL_setValue]:(t,{value:e,index:n})=>{const{segmentsLocked:o,previewSegmentIndex:a,memo:i,segmentationVoxelManager:r,centerSegmentIndexInfo:s,segmentIndex:l}=t,d=r.getAtIndex(n);if(!o.includes(e)&&(s||d!==l)&&(0===s?.segmentIndex||d!==l))if(null!==s?.segmentIndex){if(!a){let t=l;return s&&(t=s.segmentIndex),void i.voxelManager.setAtIndex(n,t)}!function({operationData:t,existingValue:e,index:n}){const{previewSegmentIndex:o,memo:a,centerSegmentIndexInfo:i,previewOnHover:r,segmentIndex:s}=t,{hasPreviewIndex:l,hasSegmentIndex:d,segmentIndex:c}=i;if(0===c&&d&&l){if(e===s)return;if(r)return;return e===o?void a.voxelManager.setAtIndex(n,0):void 0}if(0===c&&d&&!l){if(0===e||e!==s)return;return a.voxelManager.setAtIndex(n,o),void i.changedIndices.push(n)}if(0===c&&!d&&l){if(e===s)return;if(r)return;return e===o?void a.voxelManager.setAtIndex(n,0):void 0}if(0===c&&!d&&!l){if(e===s)return;return e===o?void a.voxelManager.setAtIndex(n,o):void 0}if(c===o&&d&&l){if(e===s)return;a.voxelManager.setAtIndex(n,o)}else if(c!==o||d||!l)if(c===s&&d&&l){if(e===s)return;a.voxelManager.setAtIndex(n,o)}else if(c!==s||!d||l);else{if(e===s)return;a.voxelManager.setAtIndex(n,o)}else{if(e===s)return;a.voxelManager.setAtIndex(n,o)}}({operationData:t,existingValue:d,index:n})}else i.voxelManager.setAtIndex(n,a??l)}},I={[o.A.CreateIsInThreshold]:t=>{const{imageVoxelManager:e,segmentIndex:n,configuration:o}=t;if(o&&n)return t=>{const n=e.getAtIndex(t),a=Array.isArray(n)?i.eR.length(n):n,{threshold:r}=o||{};return!r?.range?.length||r.range[0]<=a&&a<=r.range[1]}}};var E=n(38440);const C={[o.A.GetStatistics]:function(t,e,n){const{indices:o}=n,{segmentationId:a,viewport:i}=e;(0,E.A)({segmentationId:a,segmentIndices:o})}};var D=n(38732),A=n(62753);const w={determineSegmentIndex:a,dynamicThreshold:r,erase:s,islandRemoval:c,preview:p,regionFill:f,setValue:v,threshold:I,labelmapStatistics:C,ensureSegmentationVolumeFor3DManipulation:D.A,ensureImageVolumeFor3DManipulation:A.A}},33852:(t,e,n)=>{n.d(e,{r:()=>r});var o=n(55887),a=n(56789),i=n(11990);const r=new o.A("EraseCircle",i.A.erase,...a.pB.compositions).strategyFunction},1989:(t,e,n)=>{n.d(e,{_:()=>r});var o=n(55887),a=n(17492),i=n(11990);const r=new o.A("EraseSphere",i.A.erase,...a.u8.compositions).strategyFunction},17492:(t,e,n)=>{n.d(e,{Jq:()=>m,Sw:()=>v,rd:()=>f,u8:()=>g});var o=n(15327),a=n(3823),i=n(55887),r=n(11990),s=n(84093),l=n(56789),d=n(4296);const{transformWorldToIndex:c}=o.utilities,u={[s.A.Initialize]:t=>{const{points:e,viewport:n,segmentationImageData:o}=t;if(!e)return;const i=a.eR.fromValues(0,0,0);e.forEach(t=>{a.eR.add(i,i,t)}),a.eR.scale(i,i,1/e.length),t.centerWorld=i,t.centerIJK=c(o,i);const{boundsIJK:r,topLeftWorld:s,bottomRightWorld:u}=(0,d.l)(e.slice(0,2),o,n);t.isInObjectBoundsIJK=r,t.isInObject=(0,l.mu)({topLeftWorld:s,bottomRightWorld:u,center:i})}},g=new i.A("Sphere",r.A.regionFill,r.A.setValue,u,r.A.determineSegmentIndex,r.A.preview,r.A.labelmapStatistics,r.A.ensureSegmentationVolumeFor3DManipulation),m=g.strategyFunction,h=new i.A("SphereThreshold",...g.compositions,r.A.dynamicThreshold,r.A.threshold,r.A.ensureSegmentationVolumeFor3DManipulation,r.A.ensureImageVolumeFor3DManipulation),p=new i.A("SphereThreshold",...g.compositions,r.A.dynamicThreshold,r.A.threshold,r.A.islandRemoval,r.A.ensureSegmentationVolumeFor3DManipulation,r.A.ensureImageVolumeFor3DManipulation),f=h.strategyFunction,v=p.strategyFunction},40905:(t,e,n)=>{n.d(e,{S:()=>s});var o=n(15327),a=n(98870),i=n(91963),r=n(12853);function s({operationData:t,viewport:e,strategy:n}){return t?"volumeId"in t&&null!=t.volumeId||"referencedVolumeId"in t&&null!=t.referencedVolumeId?function({operationData:t}){const{volumeId:e}=t;if(!e){const t=new CustomEvent(o.Enums.Events.ERROR_EVENT,{detail:{type:"Segmentation",message:"No volume id found for the segmentation"},cancelable:!0});return o.eventTarget.dispatchEvent(t),null}const n=o.cache.getVolume(e),a=(0,r.b)(e);if(!n||!a)return null;const{imageData:i}=n,{voxelManager:s}=n,{voxelManager:l,imageData:d}=a;return{segmentationImageData:i,segmentationVoxelManager:s,segmentationScalarData:null,imageScalarData:null,imageVoxelManager:l,imageData:d}}({operationData:t}):function({operationData:t,viewport:e,strategy:n}){const{segmentationId:r}=t;let s,l,d,c,u,g;if(n.ensureSegmentationVolumeFor3DManipulation)n.ensureSegmentationVolumeFor3DManipulation({operationData:t,viewport:e}),l=t.segmentationVoxelManager,s=t.segmentationImageData,d=null;else{const n=(0,a.getCurrentLabelmapImageIdForViewport)(e.id,r);if(!n)return null;const c=(0,i.wV)(e.id,r);if(!c)return null;const u=o.cache.getImage(n);s=c.actor.getMapper().getInputData(),l=u.voxelManager;const g=t.imageId,m=o.cache.getImage(g);if(!m)return null;d=m.getPixelData?.()}if(n.ensureImageVolumeFor3DManipulation)n.ensureImageVolumeFor3DManipulation({operationData:t,viewport:e}),u=t.imageVoxelManager,c=t.imageScalarData,g=t.imageData;else{const t=e.getCurrentImageId();if(!t)return null;const n=o.cache.getImage(t);g=n?null:e.getImageData(),c=n?.getPixelData()||g.getScalarData(),u=n?.voxelManager}return{segmentationImageData:s,segmentationScalarData:d,imageScalarData:c,segmentationVoxelManager:l,imageVoxelManager:u,imageData:g}}({operationData:t,viewport:e,strategy:n}):null}},109:(t,e,n)=>{n.d(e,{A:()=>a});class o{constructor(){}static getContourSequence(t,e){const{data:n}=t,{projectionPoints:o,projectionPointsImageIds:a}=n.cachedStats;return o.map((t,n)=>{const o=function(t){const e=[...t[0],...t[1],...t[3],...t[2]],n=e.flat().map(t=>t.toFixed(2));return n}(t),i=function(t,e){const n=e.get("sopCommonModule",t);return{ReferencedSOPClassUID:n.sopClassUID,ReferencedSOPInstanceUID:n.sopInstanceUID}}(a[n],e);return{NumberOfContourPoints:o.length/3,ContourImageSequence:i,ContourGeometricType:"CLOSED_PLANAR",ContourData:o}})}}o.toolName="RectangleROIStartEndThreshold";const a=o},55421:(t,e,n)=>{n.d(e,{A:()=>i});var o=n(82056);const a="PlanarFreehandContourSegmentationTool";function i(t,e=[]){const{viewport:n,sliceData:i,annotation:r}=t,s=new Map,{toolName:l,originalToolName:d}=r.metadata,c=d||l,u=((0,o.getAnnotations)(c,n.element)||[]).filter(t=>!t.metadata.originalToolName||t.metadata.originalToolName===c);if(c!==a){const t=(0,o.getAnnotations)(a,n.element);t?.length&&t.forEach(t=>{const{metadata:e}=t;e.originalToolName===c&&e.originalToolName!==e.toolName&&u.push(t)})}if(!u?.length)return s;for(let t=0;t<i.numberOfSlices;t++){const n=u.filter(e=>e.metadata.sliceIndex===t);if(!n?.length)continue;const o=n.filter(t=>e.every(e=>{const n=e.parentKey?e.parentKey(t):t,o=n?.[e.key];return Array.isArray(o)?o.every((t,n)=>t===e.value[n]):o===e.value}));o.length&&s.set(t,o)}return s}},51893:(t,e,n)=>{n.d(e,{A:()=>a});var o=n(55421);function a(t,e){const n=(0,o.A)(t,e),a=[];if(!n?.size)return a;for(const t of n.values())t.forEach(t=>{a.push(t)});return a}},73816:(t,e,n)=>{n.d(e,{A:()=>O});var o=n(15327),a=n(3823);function i(t,e,n){const a=o.utilities.deepMerge({data:{},metadata:{}},n);return Object.assign(a,{highlighted:!1,invalidated:!0,autoGenerated:!0,annotationUID:void 0,cachedStats:{},childAnnotationUIDs:[],parentAnnotationUID:void 0}),Object.assign(a.data,{handles:{points:e.points||e||[],interpolationSources:e.sources,activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},contour:{...n.data.contour,polyline:t}}),a}var r=n(55421);function s(t,e){const n=t.get(e);return!n?.length||1===n.length&&n[0].autoGenerated}function l(t,e,n){const[o]=t;e[o]||={pair:t,list:[]},e[o].list.push(n)}function d(t,e,n){const o=[];let a=!0;for(let i=t-1;i>=e[0];i--){const t=n.get(i);if(t?.length){if(t[0].autoGenerated)continue;t.length>1&&(a=!1),o.push(i);break}}if(a&&o.length){for(let i=t+1;i<=e[1];i++){const t=n.get(i);if(t?.length){if(t[0].autoGenerated)continue;t.length>1&&(a=!1),o.push(i);break}}if(a&&!(o.length<2))return o}}const c=function(t,e){const n=(0,r.A)(e,[{key:"interpolationUID",value:e.interpolationUID}]),o=function(t){let e=1/0,n=-1/0,o=!1;for(const[a,i]of t.entries())i.length&&(e=Math.min(a,e),n=Math.max(a,n),o=!0);if(!o)return;return[e,n]}(n);if(!o)return void console.warn("No annotations found to interpolate",n);const a=function(t,e){for(const[n,o]of t)for(let t=0;t<o.length;t++)if(o[t].annotationUID===e)return n;return}(n,t.annotationUID),i=[];for(let t=o[0]+1;t<o[1];t++)if(s(n,t)){const e=d(t,o,n);e?.[0]!==a&&e?.[1]!==a||l(e,i,t)}return{interpolationData:n,interpolationList:i}};var u=n(94021),g=n(47807);const{PointsManager:m}=o.utilities;function h(t,e=12){const n=m.create3(e);n.sources=[];const{sources:o}=n,{length:i,sources:r=[]}=t;if(i<15)return t.subselect(e);const s=Math.floor(Math.max(2*i/e,10));r.forEach(()=>o.push(m.create3(e)));const l=function(t,e=6){const{length:n}=t,o=a.eR.create(),i=a.eR.create(),r=new Float32Array(n);for(let s=0;s<n;s++){const l=t.getPoint(s),d=t.getPoint(s-e),c=t.getPoint((s+e)%n);a.eR.sub(o,l,d),a.eR.sub(i,c,l);const u=a.eR.dot(o,i)/(a.eR.len(o)*a.eR.len(i));r[s]=u}return r}(t,5),d=function(t,e){const{max:n,deviation:o}=function(t){const{length:e}=t;let n=0,o=1/0,a=-1/0,i=0;for(let i=0;i<e;i++){const e=t[i];n+=e,o=Math.min(o,e),a=Math.max(a,e)}const r=n/e;for(let n=0;n<e;n++){const e=t[n]-r;i+=e*e}return{mean:r,max:a,min:o,sumSq:i,deviation:Math.sqrt(i/e)}}(t),{length:a}=t;if(o<.01||a<3*e)return[];const i=[];let r,s=null,l=0;for(let e=0;e<a;e++){const a=t[e];a<n-o?s?(s[2]=e,a<r&&(r=a,l=e),s[1]=l):(r=a,l=e,s=[e,e,e]):s&&(i.push(s),s=null)}s&&(0===i[0][0]?i[0][0]=s[0]:(s[1]=l,s[2]=a-1,i.push(s)));return i}(l,e),c=[];if(d?.length>2){let t=-1;const e=s/3;d.forEach(n=>{const[o,,a]=n,r=Math.ceil((o+a)/2);a-t<e||(r-o>2*e?(p(c,t,o,s,i),t=p(c,o,r,s,i)):t=p(c,t,r,s,i),a-t>e&&(t=p(c,t,a,s,i)))});const n=c[0];f(n+i-t,i)>2*e&&p(c,t,n-e,s,i)}else{const t=Math.floor(i/e);p(c,-1,i-t,t,i)}return c.forEach(e=>{const a=t.getPointArray(e);n.push(a),r.forEach((t,n)=>o[n].push(t.getPoint(e)))}),n}function p(t,e,n,o,a){n<e&&(n+=a);const i=n-e,r=Math.ceil(i/o);if(r<=0)return t[t.length-1]!==n&&t.push(f(n,a)),n;for(let n=1;n<=r;n++){const o=f(e+n*i/r,a);t.push(o)}return t[t.length-1]}function f(t,e){return(Math.round(t)+e)%e}var v=n(56534);const{PointsManager:I}=o.utilities,E=.2;function C(t,e,n,o){const r=n.get(e[0])[0],s=n.get(e[1])[0],l=M(r.data.contour.polyline),d=M(s.data.contour.polyline),{c1Interp:c,c2Interp:u}=function(t,e){const n=P(t),o=P(e),a=Math.max(Math.ceil(n[n.length-1]/E),Math.ceil(o[o.length-1]/E)),i=y(n),r=y(o),s=a+e.x.length,l=a+t.x.length,d=S(s,i),c=S(l,r),u=b(s-2,t.x.length),g=b(l-2,e.x.length),m=x(d,u),h=x(c,g),p=w(t,m),f=w(e,h);return function(t,e){const n=t.x.length,o={startingNode:0,totalSquaredXYLengths:1/0};for(let a=0;a<n;a++){let i=a,r=0;for(let o=0;o<n;o++)r+=(t.x[i]-e.x[o])**2+(t.y[i]-e.y[o])**2+(t.z[i]-e.z[o])**2,i++,i===n&&(i=0);r<o.totalSquaredXYLengths&&(o.totalSquaredXYLengths=r,o.startingNode=a)}const a=o.startingNode;A(t.x,a),A(t.y,a),A(t.z,a),A(t.I,a)}(p,f),function(t,e){const n={x:[],y:[],z:[],I:[]},o={x:[],y:[],z:[],I:[]};for(let a=0;a<t.x.length;a++)(t.I[a]||e.I[a])&&(n.x.push(t.x[a]),n.y.push(t.y[a]),n.z.push(t.z[a]),n.I.push(t.I[a]),o.x.push(e.x[a]),o.y.push(e.y[a]),o.z.push(e.z[a]),o.I.push(e.I[a]));return{c1Interp:n,c2Interp:o}}(p,f)}(l,d);c.kIndex=e[0],u.kIndex=e[1],t.forEach(function(t){!function(t,e,n,o,r,s,l){const[d,c]=o,u=(n-d)/(c-d),m=r.get(d)[0],p=r.get(c)[0],f=function(t,e,n,o){const i=o?t.I:e.I,r=I.fromXYZ(t),s=I.fromXYZ(e),{length:l}=r,d=I.create3(l),c=a.eR.create(),u=a.eR.create(),g=I.create3(l);g.kIndex=t.kIndex;const m=I.create3(l);m.kIndex=e.kIndex;for(let e=0;e<t.x.length;e++)if(i[e]){const t=r.getPoint(e),o=s.getPoint(e);g.push(t),m.push(o),a.eR.sub(c,o,t),d.push(a.eR.scaleAndAdd(u,t,c,n))}return d.sources=[g,m],d}(t,e,u,s),E=u>.5?p:m,C=h(f);r.has(n)?function(t,e,n,o,a){const r=D(o,n,a),s=t.points,l=i(s,e,r);Object.assign(r,{metadata:l.metadata,data:l.data})}(f,C,n,E,l):function(t,e,n,o,a){const r=t.points,{viewport:s}=a,l=i(r,e,o),d=s.getViewReference({sliceIndex:n});if(!d)throw new Error(`Can't find slice ${n}`);Object.assign(l.metadata,d),g.state.addAnnotation(l,s.element),o.onInterpolationComplete?.(l,o);const{parentAnnotationUID:c}=o;if(c){const t=D(g.state.getAnnotation(c),n,a);(0,v.createPolylineHole)(s,t,l)}}(f,C,n,E,l)}(c,u,t,e,n,l.x.length>d.x.length,o)})}function D(t,e,n){const{viewport:o}=n,a=g.state.getAnnotations(t.metadata.toolName,o.element);for(let n=0;n<a.length;n++){const o=a[n];if(o.interpolationUID===t.interpolationUID&&o.metadata.sliceIndex===e)return o}}function A(t,e){e-=t.length*Math.floor(e/t.length);const n=t.splice(0,e);return t.push(...n),t}function w(t,e){const n={x:[],y:[],z:[],I:[]};for(let o=0;o<t.x.length-1;o++){n.x.push(t.x[o]),n.y.push(t.y[o]),n.z.push(t.z[o]),n.I.push(!0);const a=(t.x[o+1]-t.x[o])/(e[o]+1),i=(t.y[o+1]-t.y[o])/(e[o]+1),r=(t.z[o+1]-t.z[o])/(e[o]+1);for(let t=0;t<e[o]-1;t++)n.x.push(n.x[n.x.length-1]+a),n.y.push(n.y[n.y.length-1]+i),n.z.push(n.z[n.z.length-1]+r),n.I.push(!1)}return n}function x(t,e){const n=[];for(let e=0;e<t.length;++e)n[e]=e;n.sort(function(e,n){return t[e]<t[n]?-1:1});const o=[];for(let t=0;t<e.length;t++)o.push(e[n[t]]);const a=o.reduce(function(t,e,n){return e&&t.push(n),t},[]),i=[];for(let t=0;t<a.length-1;t++)i.push(a[t+1]-a[t]);return i}function b(t,e){const n=new Array(t+e);return n.fill(!1,0,t),n.fill(!0,t,t+e),n}function S(t,e){const n=1/(t-1),o=[n];for(let e=1;e<t-2;e++)o.push(o[o.length-1]+n);return o.concat(e)}function y(t){const e=[];for(let n=0;n<t.length;n++)e.push(t[n]/t[t.length-1]);return e}function P(t){const e=[0];for(let n=1;n<t.x.length;n++){const o=Math.sqrt((t.x[n]-t.x[n-1])**2+(t.y[n]-t.y[n-1])**2+(t.z[n]-t.z[n-1])**2);e.push(e[n-1]+o)}return e}function M(t){const e={x:[],y:[],z:[]};for(let n=0;n<t.length;n++)e.x[n]=t[n][0],e.y[n]=t[n][1],e.z[n]=t[n][2];return e.x.push(e.x[0]),e.y.push(e.y[0]),e.z.push(e.z[0]),e}const O=function(t){if(!t.annotation)return;const{isInterpolationUpdate:e,annotation:n}=t;queueMicrotask(()=>{try{e&&(n.isInterpolationUpdate=!0,n.autoGenerated=!1),function(t){const{annotation:e}=t;!function(t){const{parentAnnotationUID:e,annotationUID:n}=t;if(!e)return t.interpolationUID;const o=g.state.getAnnotation(e),{interpolationUID:a}=o,i=o.childAnnotationUIDs.indexOf(n);t.interpolationUID=`${a}-${i}`,t.interpolationUID}(e);const{interpolationData:n,interpolationList:a}=c(e,t)||{};if(!n||!a)return;const i={toolName:e.metadata.toolName,toolType:e.metadata.toolName,viewport:t.viewport};for(let t=0;t<a.length;t++)a[t]&&C(a[t].list,a[t].pair,n,i);const{id:r,renderingEngineId:s,element:l}=t.viewport,d={annotation:e,element:l,viewportId:r,renderingEngineId:s};a.length&&(0,o.triggerEvent)(t.viewport.element,u.A.ANNOTATION_INTERPOLATION_PROCESS_COMPLETED,d)}(t)}finally{e&&(n.autoGenerated=!0)}})}},69013:(t,e,n)=>{n.d(e,{B:()=>c,O:()=>d});var o=n(15327),a=n(28364);const{PointsManager:i}=o.utilities;function r(t){return{max:[-1/0],min:[1/0],sum:[0],count:0,maxIJK:null,maxLPS:null,minIJK:null,minLPS:null,runMean:[0],m2:[0],m3:[0],m4:[0],allValues:[[]],pointsInShape:t?i.create3(1024):null,sumLPS:[0,0,0]}}function s(t,e,n=null,o=null){Array.isArray(e)&&e.length>1&&1===t.max.length&&(t.max.push(t.max[0],t.max[0]),t.min.push(t.min[0],t.min[0]),t.sum.push(t.sum[0],t.sum[0]),t.runMean.push(0,0),t.m2.push(t.m2[0],t.m2[0]),t.m3.push(t.m3[0],t.m3[0]),t.m4.push(t.m4[0],t.m4[0]),t.allValues.push([],[])),t?.pointsInShape&&n&&t.pointsInShape.push(n);const a=Array.isArray(e)?e:[e];t.count+=1,n&&(t.sumLPS[0]+=n[0],t.sumLPS[1]+=n[1],t.sumLPS[2]+=n[2]),t.max.forEach((e,i)=>{const r=a[i];t.allValues[i].push(r);const s=t.count,l=r-t.runMean[i],d=l/s,c=l*d*(s-1);t.sum[i]+=r,t.runMean[i]+=d,t.m4[i]+=c*d*d*(s*s-3*s+3)+6*d*d*t.m2[i]-4*d*t.m3[i],t.m3[i]+=c*d*(s-2)-3*d*t.m2[i],t.m2[i]+=c,r<t.min[i]&&(t.min[i]=r,0===i&&(t.minIJK=o?[...o]:null,t.minLPS=n?[...n]:null)),r>t.max[i]&&(t.max[i]=r,0===i&&(t.maxIJK=o?[...o]:null,t.maxLPS=n?[...n]:null))})}function l(t,e){const n=t.sum.map(e=>e/t.count),o=t.m2.map(e=>Math.sqrt(e/t.count)),a=t.sumLPS.map(e=>e/t.count),i=t.m3.map((e,n)=>{const o=t.m2[n]/t.count;return 0===o?0:e/(t.count*Math.pow(o,1.5))}),s=t.m4.map((e,n)=>{const o=t.m2[n]/t.count;return 0===o?0:e/(t.count*o*o)-3}),l=t.allValues.map(t=>function(t){if(0===t.length)return 0;const e=[...t].sort((t,e)=>t-e),n=Math.floor(e.length/2);return e.length%2==0?(e[n-1]+e[n])/2:e[n]}(t)),d={max:{name:"max",label:"Max Pixel",value:1===t.max.length?t.max[0]:t.max,unit:e,pointIJK:t.maxIJK?[...t.maxIJK]:null,pointLPS:t.maxLPS?[...t.maxLPS]:null},min:{name:"min",label:"Min Pixel",value:1===t.min.length?t.min[0]:t.min,unit:e,pointIJK:t.minIJK?[...t.minIJK]:null,pointLPS:t.minLPS?[...t.minLPS]:null},mean:{name:"mean",label:"Mean Pixel",value:1===n.length?n[0]:n,unit:e},stdDev:{name:"stdDev",label:"Standard Deviation",value:1===o.length?o[0]:o,unit:e},count:{name:"count",label:"Voxel Count",value:t.count,unit:null},median:{name:"median",label:"Median",value:1===l.length?l[0]:l,unit:e},skewness:{name:"skewness",label:"Skewness",value:1===i.length?i[0]:i,unit:null},kurtosis:{name:"kurtosis",label:"Kurtosis",value:1===s.length?s[0]:s,unit:null},maxLPS:{name:"maxLPS",label:"Max LPS",value:t.maxLPS?Array.from(t.maxLPS):null,unit:null},minLPS:{name:"minLPS",label:"Min LPS",value:t.minLPS?Array.from(t.minLPS):null,unit:null},pointsInShape:t.pointsInShape,center:{name:"center",label:"Center",value:a?[...a]:null,unit:null},array:[]};d.array.push(d.min,d.max,d.mean,d.stdDev,d.median,d.skewness,d.kurtosis,d.count,d.maxLPS,d.minLPS),d.center.value&&d.array.push(d.center);const c=r(null!==t.pointsInShape);return t.max=c.max,t.min=c.min,t.sum=c.sum,t.count=c.count,t.maxIJK=c.maxIJK,t.maxLPS=c.maxLPS,t.minIJK=c.minIJK,t.minLPS=c.minLPS,t.runMean=c.runMean,t.m2=c.m2,t.m3=c.m3,t.m4=c.m4,t.allValues=c.allValues,t.pointsInShape=c.pointsInShape,t.sumLPS=c.sumLPS,d}class d extends a.t{static{this.state=r(!0)}static statsInit(t){t.storePointData||(this.state.pointsInShape=null),this.state=r(t.storePointData)}static{this.statsCallback=({value:t,pointLPS:e=null,pointIJK:n=null})=>{s(this.state,t,e,n)}}static{this.getStatistics=t=>l(this.state,t?.unit)}}class c extends a.I{constructor(t){super(t),this.state=r(t.storePointData)}statsInit(t){this.state=r(t.storePointData)}statsCallback(t){s(this.state,t.value,t.pointLPS,t.pointIJK)}getStatistics(t){return l(this.state,t?.unit)}}},2222:(t,e,n)=>{function o(t){const[e,n,o,a]=t;return[[o[0],n[1]],[a[0],e[1]]]}n.d(e,{A:()=>o})},86978:(t,e,n)=>{n.d(e,{A:()=>a});var o=n(18989);function a(t,e,n){if(2!==t.length||2!==e.length||2!==n.length)throw Error("lineStart, lineEnd, and point should have 2 elements of [x, y]");return Math.sqrt((0,o.A)(t,e,n))}},81205:(t,e,n)=>{function o(t){return"number"==typeof t?t?t<0?-1:1:t==t?0:NaN:NaN}function a(t,e,n,a,i=!1){const[r,s]=t,[l,d]=e,[c,u]=n,[g,m]=a;if(i){const t=(r-l)*(u-m)-(s-d)*(c-g);if(Math.abs(t)<1e-10)return;const e=((r-c)*(u-m)-(s-u)*(c-g))/t;return[r+e*(l-r),s+e*(d-s)]}const h=d-s,p=r-l,f=l*s-r*d,v=h*c+p*u+f,I=h*g+p*m+f;if(0!==v&&0!==I&&o(v)===o(I))return;const E=m-u,C=c-g,D=g*u-c*m,A=E*r+C*s+D,w=E*l+C*d+D;if(0!==A&&0!==w&&o(A)===o(w))return;const x=h*C-E*p;let b;b=p*D-C*f;const S=b/x;b=E*f-h*D;return[S,b/x]}n.d(e,{A:()=>a})},87105:(t,e,n)=>{n.d(e,{A:()=>a});var o=n(93258);function a(t,e){if(4!==t.length||2!==e.length)throw Error("rectangle:[left, top, width, height] or point: [x,y] not defined correctly");const[n,a,i,r]=t;let s=655535;const l=function(t,e,n,o){return{top:[[t,e],[t+n,e]],right:[[t+n,e],[t+n,e+o]],bottom:[[t+n,e+o],[t,e+o]],left:[[t,e+o],[t,e]]}}(n,a,i,r);return Object.keys(l).forEach(t=>{const[n,a]=l[t],i=o.distanceToPoint(n,a,e);i<s&&(s=i)}),s}},30269:(t,e,n)=>{n.d(e,{H:()=>i});var o=n(56399),a=n(20071);function i(t,e){if(!e||0===e.length||e.length===t.length)return t;const n=e[e.length-1]-e[0]+1,i=(0,o.Qm)(e.map(e=>t[e][0])),r=(0,o.Qm)(e.map(e=>t[e][1]));if(s=t,3===s[0]?.length){const s=(0,o.Qm)(e.map(e=>t[e][2]));return(0,a.yU)((0,o.yd)(i,n),(0,o.yd)(r,n),(0,o.yd)(s,n))}return(0,a.yU)((0,o.yd)(i,n),(0,o.yd)(r,n));var s}},42797:(t,e,n)=>{n.d(e,{Q:()=>i,p:()=>c});var o=n(95527),a=n(61768);function i(t,e){if(e?.autoGenerated)return!1;return!0===t?.smoothing?.smoothOnAdd||!0===t?.smoothing?.smoothOnEdit}function r(t,e){return 0===o.point.distanceToPoint(t,e)}function s(t,e,n){return(t+e+n)%e}function l(t,e,n,o){const[,a,i]=t,[,r,l]=e,d=i.length,c=l.length;let u=t[0],g=e[0];if(!(i[u]&&l[g]&&i[a]&&l[r]))return[void 0,void 0];for(;u!==a&&g!==r;){if(n(l[g],i[u]))return[u,g];u=s(u,d,o),g=s(g,c,o)}return[void 0,void 0]}function d(t,e){const[n,a]=function(t,e){for(let n=0;n<t.length;n++)for(let o=0;o<e.length;o++)if(r(t[n],e[o]))return[n,o]}(t,e)||[],i=(t,e)=>!1===function(t,e){return o.point.distanceToPoint(t,e)<.001}(t,e),[d,c]=l([s(n,t.length,1),n,t],[s(a,e.length,1),a,e],i,1),[u]=l([s(d,t.length,-1),d,t],[s(c,e.length,-1),c,e],i,-1);return[d,u]}function c(t,e,n){const{interpolation:o,smoothing:i}=t,r=e;if(o){const{knotsRatioPercentageOnAdd:t,knotsRatioPercentageOnEdit:o,smoothOnAdd:r=!1,smoothOnEdit:s=!1}=i,l=n?o:t;if(n?s:r){const[t,o]=n?d(e,n):[0,e.length-1];return e[t]&&e[o]?(0,a.A)(e,t,o,l):e}}return r}},94418:(t,e,n)=>{n.d(e,{A:()=>i});var o=n(15327),a=n(36374);function i(t,e,n={}){if(t instanceof o.VolumeViewport){const n=t.getCamera(),{spacingInNormalDirection:i}=o.utilities.getTargetVolumeAndSpacingInNormalDir(t,n);return(0,a.A)(e,n,i)}if(t instanceof o.StackViewport){const e=t.getCurrentImageId();if(!e)return[];const o=e.indexOf(":");n.imageURI=e.substring(o+1)}return e.filter(e=>!!e.isVisible&&(!!e.data.isCanvasAnnotation||t.isReferenceViewable(e.metadata,n)))}},40770:(t,e,n)=>{n.d(e,{W:()=>s});var o=n(3823),a=n(15327);const{EPSILON:i}=a.CONSTANTS,r=1-i;function s(t,e){const{viewPlaneNormal:n}=e,i=t.filter(t=>{let e=t.metadata.viewPlaneNormal;if(!e){const{referencedImageId:n}=t.metadata,{imageOrientationPatient:i}=a.metaData.get("imagePlaneModule",n),r=o.eR.fromValues(i[0],i[1],i[2]),s=o.eR.fromValues(i[3],i[4],i[5]);e=o.eR.create(),o.eR.cross(e,r,s),t.metadata.viewPlaneNormal=e}const i=Math.abs(o.eR.dot(n,e))>r;return e&&i});return i.length?i:[]}},36374:(t,e,n)=>{n.d(e,{A:()=>l});var o=n(3823),a=n(15327);const{isEqual:i}=a.utilities,{EPSILON:r}=a.CONSTANTS,s=1-r;function l(t,e,n){const{viewPlaneNormal:r}=e,l=t.filter(t=>{let n=t.metadata.viewPlaneNormal;if(!t.metadata.referencedImageId&&!n&&t.metadata.FrameOfReferenceUID){for(const n of t.data.handles.points){const t=o.eR.sub(o.eR.create(),n,e.focalPoint),a=o.eR.dot(t,e.viewPlaneNormal);if(!i(a,0))return!1}return t.metadata.viewPlaneNormal=e.viewPlaneNormal,t.metadata.cameraFocalPoint=e.focalPoint,!0}if(!n){const{referencedImageId:e}=t.metadata,{imageOrientationPatient:i}=a.metaData.get("imagePlaneModule",e),r=o.eR.fromValues(i[0],i[1],i[2]),s=o.eR.fromValues(i[3],i[4],i[5]);n=o.eR.create(),o.eR.cross(n,r,s),t.metadata.viewPlaneNormal=n}const l=Math.abs(o.eR.dot(r,n))>s;return n&&l});if(!l.length)return[];const d=n/2,{focalPoint:c}=e,u=[];for(const t of l){const e=t.data,n=e.handles.points[0]||e.contour?.polyline[0];if(!t.isVisible)continue;const a=o.eR.create();if(!n){u.push(t);continue}o.eR.sub(a,c,n);const i=o.eR.dot(a,r);Math.abs(i)<d&&u.push(t)}return u}},57063:(t,e,n)=>{n.d(e,{R:()=>a,p:()=>i});var o=n(15327);function a(t,e,n,o,a=.25){const r=i(t,e,{targetVolumeId:n,stepSize:a});let s;for(const e of r){const n=o(t.getIntensityFromWorld(e),e);n&&(s=n)}return s}function i(t,e,{targetVolumeId:n,stepSize:a}){const i=t.getCamera(),{viewPlaneNormal:s}=i,{spacingInNormalDirection:l}=o.utilities.getTargetVolumeAndSpacingInNormalDir(t,i,n),d=l*a||1,c=t.getBounds(),u=[];let g=[...e];for(;r(g,c);)u.push([...g]),g[0]+=s[0]*d,g[1]+=s[1]*d,g[2]+=s[2]*d;for(g=[...e];r(g,c);)u.push([...g]),g[0]-=s[0]*d,g[1]-=s[1]*d,g[2]-=s[2]*d;return u}const r=function(t,e){const[n,o,a,i,r,s]=e,l=10;return t[0]>n+l&&t[0]<o-l&&t[1]>a+l&&t[1]<i-l&&t[2]>r+l&&t[2]<s-l}},35489:(t,e,n)=>{n.d(e,{A:()=>a});var o=n(3823);function a(t,e,n,a){const i=o.eR.create();o.eR.cross(i,e,t);const r=o.eR.fromValues(...n),s=o.eR.fromValues(...a),l=o.eR.create();o.eR.subtract(l,r,s);const d=o.eR.length(l);if(d<1e-4)return{worldWidth:0,worldHeight:0};const c=o.eR.dot(l,i)/(d*o.eR.length(i));return{worldWidth:Math.sqrt(1-c*c)*d,worldHeight:c*d}}},62514:(t,e,n)=>{n.d(e,{A:()=>a});var o=n(3823);function a(t,e,n,a){const i=o.eR.create();o.eR.cross(i,e,t);const r=o.eR.fromValues(...n),s=o.eR.fromValues(...a),l=o.eR.create();o.eR.subtract(l,r,s);const d=o.eR.length(l);if(d<1e-4)return{worldWidth:0,worldHeight:0};const c=o.eR.dot(l,i)/(d*o.eR.length(i));return{worldWidth:Math.sqrt(1-c*c)*d,worldHeight:c*d}}},30698:(t,e,n)=>{n.d(e,{Y:()=>a});var o=n(3823);const a=(t,e,n,a,i,r,s,l)=>{const d=[o.eR.fromValues(n,a,i),o.eR.fromValues(r,a,i),o.eR.fromValues(n,s,i),o.eR.fromValues(r,s,i),o.eR.fromValues(n,a,l),o.eR.fromValues(r,a,l),o.eR.fromValues(n,s,l),o.eR.fromValues(r,s,l)],c=o.eR.fromValues(e[0],e[1],e[2]),u=o.eR.fromValues(t[0],t[1],t[2]),g=-o.eR.dot(c,u);let m=null;for(const t of d){const e=o.eR.dot(c,t)+g;if(null===m)m=Math.sign(e);else if(Math.sign(e)!==m)return!0}return!1}},56229:(t,e,n)=>{n.d(e,{A:()=>l});var o=n(15327),a=n(47807),i=n(73816),r=n(55421),s=n(94021);function l(t){const{annotation:e}=t,n=(0,r.A)(t,[{key:"interpolationUID",value:t.interpolationUID}]),l=e.metadata.sliceIndex;let d=-1,c=t.sliceData.numberOfSlices;for(const[t,e]of n.entries()){if(t===l)continue;const n=e.find(t=>!t.autoGenerated);n&&(t<l?d=Math.max(t,d):c=Math.min(t,c))}const u=[];for(const[t,e]of n.entries())t<=d||t>=c||t===l||e.forEach(t=>{t.autoGenerated&&(a.state.removeAnnotation(t.annotationUID),u.push(t))});if(u.length){const e={annotations:u,element:t.viewport.element,viewportId:t.viewport.id,renderingEngineId:t.viewport.getRenderingEngine().id};(0,o.triggerEvent)(t.viewport.element,s.A.INTERPOLATED_ANNOTATIONS_REMOVED,e)}if(d>=0&&c<t.sliceData.numberOfSlices){const e=n.get(c)[0],o={viewport:t.viewport,sliceData:{numberOfSlices:t.sliceData.numberOfSlices,imageIndex:e.metadata.sliceIndex},annotation:e,interpolationUID:e.interpolationUID};(0,i.A)(o)}}},27479:(t,e,n)=>{n.d(e,{d:()=>d});var o=n(15327),a=n(99737),i=n(44188),r=n(49906),s=n(52905);const l=new Map;async function d(t,e,n,s,d){const u=await n();(0,i.A)({segmentationId:t,type:e,data:u}),d?.(),l.has(t)||l.set(t,[]);const g=l.get(t);return g.includes(e)||g.push(e),function(t){const e=e=>{c(e,t)};t._debouncedUpdateFunction=e,o.eventTarget.removeEventListener(a.Events.SEGMENTATION_DATA_MODIFIED,t._debouncedUpdateFunction),o.eventTarget.addEventListener(a.Events.SEGMENTATION_DATA_MODIFIED,t._debouncedUpdateFunction)}(s),(0,r.triggerSegmentationModified)(t),u}const c=(0,s.A)((t,e)=>{const n=t.detail.segmentationId,o=l.get(n);o&&o.length&&(e(n),o.length&&(0,r.triggerSegmentationModified)(n))},300)},86644:(t,e,n)=>{n.d(e,{u:()=>c});var o=n(99737),a=n(93733),i=n(67165),r=n(60740),s=n(33658),l=n(47098),d=n(92686);function c({segmentationId:t,segmentIndex:e,viewportId:n,autoGenerated:c=!1}){const u=(0,a.getSegmentIndexColor)(n,t,e),g=(0,s.I)(n,{segmentationId:t,type:o.SegmentationRepresentations.Contour}),m=(0,i.T)(n),h=m?.segmentationId===t,p=d.Y.getStyle({viewportId:n,segmentationId:t,type:o.SegmentationRepresentations.Contour,segmentIndex:e});let f,v=1,I=1,E=0;c?(v=p.outlineWidthAutoGenerated??v,f=p.outlineDashAutoGenerated??f,I=p.outlineOpacity??I,E=p.fillAlphaAutoGenerated??E):h?(v=p.outlineWidth??v,f=p.outlineDash??f,I=p.outlineOpacity??I,E=p.fillAlpha??E):(v=p.outlineWidthInactive??v,f=p.outlineDashInactive??f,I=p.outlineOpacityInactive??I,E=p.fillAlphaInactive??E),(0,r.Q)(t)===e&&(v+=p.activeSegmentOutlineWidthDelta),v=p.renderOutline?v:0,E=p.renderFill?E:0;const C=`rgba(${u[0]}, ${u[1]}, ${u[2]}, ${I})`,D=`rgb(${u[0]}, ${u[1]}, ${u[2]})`,A=!(0,l.s)(n,{segmentationId:t,type:o.SegmentationRepresentations.Contour}).has(e);return{color:C,fillColor:D,lineWidth:v,fillOpacity:E,lineDash:f,textbox:{color:C},visibility:g&&A}}},14543:(t,e,n)=>{n.d(e,{A:()=>s});var o=n(15327),a=n(3198),i=n(9356),r=n(67514);function s(t,e,n=!0){const s=(0,o.getEnabledElement)(t),{renderingEngine:l,FrameOfReferenceUID:d}=s;let c=l.getViewports();c=(0,a.A)(c,d),c=(0,i.A)(c,e);const u=l.getViewport(s.viewportId);n&&(c=(0,r.A)(c,u.getCamera()));return c.map(t=>t.id)}}}]);
//# sourceMappingURL=9446.bundle.db5f920db95099fa222d.js.map