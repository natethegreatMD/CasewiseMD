(globalThis.webpackChunk=globalThis.webpackChunk||[]).push([[2011],{36625:(e,t,n)=>{"use strict";n.d(t,{Nk:()=>a,Qy:()=>r,zj:()=>i});n(15327),n(94021);let o={};function i(){return o}function a(e){o=e}let s=!1;function r(){if(!o.addons?.polySeg)return console.warn("PolySeg add-on not configured. This will prevent automatic conversion between segmentation representations (labelmap, contour, surface). To enable these features, install @cornerstonejs/polymorphic-segmentation and register it during initialization: cornerstoneTools.init({ addons: { polySeg } })."),null;const e=o.addons.polySeg;return s||(e.init(),s=!0),e}},93952:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});const o=[[0,0,0,0],[221,84,84,255],[77,228,121,255],[166,70,235,255],[189,180,116,255],[109,182,196,255],[204,101,157,255],[123,211,94,255],[93,87,218,255],[225,128,80,255],[73,232,172,255],[181,119,186,255],[176,193,112,255],[105,153,200,255],[208,97,120,255],[90,215,101,255],[135,83,222,255],[229,178,76,255],[122,183,181,255],[190,115,171,255],[149,197,108,255],[100,118,205,255],[212,108,93,255],[86,219,141,255],[183,79,226,255],[233,233,72,255],[118,167,187,255],[194,111,146,255],[116,201,104,255],[115,96,209,255],[216,147,89,255],[82,223,188,255],[230,75,224,255],[163,184,121,255],[114,143,191,255],[198,107,114,255],[99,206,122,255],[153,92,213,255],[220,192,85,255],[78,215,227,255],[234,71,173,255],[141,188,117,255],[110,113,195,255],[202,128,103,255],[95,210,157,255],[195,88,217,255],[206,224,81,255],[74,166,231,255],[185,120,139,255],[113,192,113,255],[133,106,199,255],[207,162,98,255],[91,214,198,255],[221,84,198,255],[159,228,77,255],[70,111,235,255],[189,119,116,255],[109,196,138,255],[165,101,204,255],[211,201,94,255],[87,191,218,255],[225,80,153,255],[106,232,73,255],[124,119,186,255],[193,142,112,255],[105,200,168,255],[203,97,208,255],[184,215,90,255],[83,147,222,255],[229,76,101,255],[122,183,130,255],[146,115,190,255],[197,171,108,255],[100,205,205,255],[212,93,177,255],[141,219,86,255],[79,97,226,255],[233,99,72,255],[118,187,150,255],[173,111,194,255],[197,201,104,255],[96,171,209,255],[216,89,137,255],[94,223,82,255],[107,75,230,255],[184,153,121,255],[114,191,175,255],[198,107,191,255],[166,206,99,255],[92,132,213,255],[220,85,91,255],[78,227,115,255],[159,71,234,255],[188,176,117,255],[110,185,195,255],[202,103,161,255],[129,210,95,255],[88,88,217,255],[224,123,81,255],[74,231,166,255],[177,120,185,255],[179,192,113,255],[106,156,199,255],[207,98,125,255],[91,214,96,255],[130,84,221,255],[228,171,77,255],[70,235,221,255],[189,116,174,255],[153,196,109,255],[101,123,204,255],[211,104,94,255],[87,218,136,255],[177,80,225,255],[232,225,73,255],[119,169,186,255],[193,112,149,255],[121,200,105,255],[111,97,208,255],[215,142,90,255],[83,222,181,255],[229,76,229,255],[165,183,122,255],[115,146,190,255],[197,108,119,255],[100,205,118,255],[148,93,212,255],[219,186,86,255],[79,220,226,255],[233,72,179,255],[144,187,118,255],[111,118,194,255],[201,124,104,255],[96,209,153,255],[189,89,216,255],[211,223,82,255],[75,172,230,255],[184,121,142,255],[117,191,114,255],[130,107,198,255],[206,157,99,255],[92,213,193,255],[220,85,203,255],[165,227,78,255],[71,118,234,255],[188,117,117,255],[110,195,135,255],[161,103,202,255],[210,195,95,255],[88,195,217,255],[224,81,158,255],[113,231,74,255],[123,120,185,255],[192,139,113,255],[106,199,164,255],[198,98,207,255],[188,214,91,255],[84,153,221,255],[228,77,108,255],[70,235,84,255],[143,116,189,255],[196,167,109,255],[101,204,199,255],[211,94,182,255],[147,218,87,255],[80,104,225,255],[232,93,73,255],[119,186,147,255],[170,112,193,255],[200,200,105,255],[97,175,208,255],[215,90,142,255],[100,222,83,255],[101,76,229,255],[183,150,122,255],[115,190,171,255],[197,108,194,255],[170,205,100,255],[93,138,212,255],[219,86,97,255],[79,226,110,255],[153,72,233,255],[187,173,118,255],[111,187,194,255],[201,104,165,255],[134,209,96,255],[89,95,216,255],[223,117,82,255],[75,230,159,255],[174,121,184,255],[182,191,114,255],[107,160,198,255],[206,99,130,255],[92,213,92,255],[124,85,220,255],[227,165,78,255],[71,234,214,255],[188,117,176,255],[156,195,110,255],[103,128,202,255],[210,100,95,255],[88,217,131,255],[170,81,224,255],[231,218,74,255],[120,172,185,255],[192,113,153,255],[125,199,106,255],[107,98,207,255],[214,137,91,255],[84,221,175,255],[222,77,228,255],[194,235,70,255],[116,149,189,255],[196,109,123,255],[101,204,114,255],[143,94,211,255],[218,180,87,255],[80,225,225,255],[232,73,186,255],[147,186,119,255],[112,122,193,255],[200,121,105,255],[97,208,148,255],[184,90,215,255],[216,222,83,255],[76,178,229,255],[183,122,145,255],[121,190,115,255],[126,108,197,255],[205,153,100,255],[93,212,187,255],[219,86,208,255],[171,226,79,255],[72,126,233,255],[187,118,121,255],[111,194,132,255],[157,104,201,255],[209,190,96,255],[89,200,216,255],[223,82,164,255],[120,230,75,255],[121,121,184,255],[191,136,114,255],[107,198,160,255],[192,99,206,255],[193,213,92,255],[85,158,220,255],[227,78,115,255],[71,234,78,255],[141,117,188,255],[195,163,110,255],[103,202,194,255],[210,95,186,255],[153,217,88,255],[81,111,224,255]]},47085:(e,t,n)=>{"use strict";n.r(t),n.d(t,{COLOR_LUT:()=>o.A});var o=n(93952)},94430:(e,t,n)=>{"use strict";n.d(t,{A:()=>a,i:()=>r});const o=Symbol("DefinedCursors"),i=new Set(["alias","all-scroll","auto","cell","col-resize","context-menu","copy","crosshair","default","e-resize","ew-resize","grab","grabbing","help","move","ne-resize","nesw-resize","no-drop","none","not-allowed","n-resize","ns-resize","nw-resize","nwse-resize","pointer","progress","row-resize","se-resize","s-resize","sw-resize","text","vertical-text","wait","w-resize","zoom-in","zoom-out"]);class a{constructor(e,t){this.name=e+"",this.fallback=t}getName(){return this.name+""}addFallbackStyleProperty(e){const{fallback:t}=this;return t instanceof a?`${e}, ${t.getStyleProperty()}`:e+""}getStyleProperty(){return this.addFallbackStyleProperty(this.name)+""}static getDefinedCursor(e){const t=s(a,o);let n=t.get(e);return n instanceof a?n:i.has(e)?(n=new a(e),t.set(e,n),n):void 0}static setDefinedCursor(e,t){if(t instanceof a){return s(a,o).set(e,t),!0}return!1}}function s(e,t){let n=e[t];return n instanceof Map||(n=new Map,Object.defineProperty(e,t,{value:n})),n}const r=i.values()},7001:(e,t,n)=>{"use strict";n.r(t),n.d(t,{hideElementCursor:()=>l,initElementCursor:()=>a,resetElementCursor:()=>r,setElementCursor:()=>s});var o=n(94430);const i=Symbol("ElementCursorsMap");function a(e,t){d(e)[0]=t,s(e,t)}function s(e,t){const n=d(e);n[1]=n[0],n[0]=t,e.style.cursor=(t instanceof o.A?t:o.A.getDefinedCursor("auto")).getStyleProperty()}function r(e){s(e,d(e)[1])}function l(e){s(e,o.A.getDefinedCursor("none"))}function d(e){let t=d[i];t instanceof WeakMap||(t=new WeakMap,Object.defineProperty(d,i,{value:t}));let n=t.get(e);return n||(n=[null,null],t.set(e,n)),n}},79475:(e,t,n)=>{"use strict";n.r(t),n.d(t,{CursorNames:()=>D,CursorSVG:()=>m,ImageMouseCursor:()=>a,MouseCursor:()=>o.A,SVGMouseCursor:()=>C,elementCursor:()=>_,registerCursor:()=>p,setCursorForElement:()=>S});var o=n(94430),i=n(15327);class a extends o.A{constructor(e,t,n,o,i){super(o||a.getUniqueInstanceName("image-cursor"),i),this.url=e,this.x=Number(t)||0,this.y=Number(n)||0}getStyleProperty(){const{url:e,x:t,y:n}=this;let o=`url('${e}')`;return t>=0&&n>=0&&(t>0||n>0)&&(o+=` ${t} ${n}`),this.addFallbackStyleProperty(o)}static getUniqueInstanceName(e){return`${e}-${i.utilities.getRuntimeId(a)}`}}var s=n(99737);const r={iconContent:"",iconSize:16,viewBox:{x:16,y:16},mousePoint:{x:8,y:8},mousePointerGroupString:'\n    <path stroke="{{color}}" d="M8 16L8 0"></path>\n    <path stroke="{{color}}" d="M16 8L0 8"></path>\n  '},l={x:127,y:60},d='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n',c='\n<rect fill="{{color}}" x="80.19" y="25.03" width="47.14" height="15.85"/>\n<rect fill="{{color}}" x="95.84" y="9.38" width="15.85" height="47.14"/>\n',h='<path fill="{{color}}" d="M82.89,10a12.09,12.09,0,0,0-16.8-2.5l-27.5,20.4-8.5-6.3a2.93,2.93,0,0,1-1.1-3,14.66,14.66,0,0,0,.1-6.6,14.08,14.08,0,1,0-6.5,15.2,2.87,2.87,0,0,1,3.2.2l8.2,6.1-8.2,6.1a2.87,2.87,0,0,1-3.2.2,14.16,14.16,0,1,0,6.7,14.4,14,14,0,0,0-.3-5.8,2.93,2.93,0,0,1,1.1-3l8.5-6.3,27.5,20.4A11.91,11.91,0,0,0,82.89,57l-31.7-23.5ZM15.29,21a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,21Zm0,36.8a5.9,5.9,0,1,1,5.9-5.9A5.91,5.91,0,0,1,15.29,57.77Zm28.3-21.5a2.8,2.8,0,1,1,2.8-2.8A2.8,2.8,0,0,1,43.59,36.27Z" transform="translate(-1.17 -0.96)"/>',g='<path fill="{{color}}" d="M8.86,2.25V66.08H72.69V2.25H8.86ZM65.28,58.67h-49v-49h49v49Z" transform="translate(-8.86 -2.25)"/>',u='<path fill="{{color}}" d="M40.77,2.25A31.92,31.92,0,1,0,72.69,34.16,31.92,31.92,0,0,0,40.77,2.25Zm0,57.63A25.71,25.71,0,1,1,66.48,34.16,25.71,25.71,0,0,1,40.77,59.87Z" transform="translate(-8.86 -2.25)"/>',m={Angle:v(r,{name:"Angle",iconContent:'<path fill="{{color}}" d="M1203 544q0 13-10 23l-393 393 393 393q10 10 10 23t-10 23l-50\n    50q-10 10-23 10t-23-10l-466-466q-10-10-10-23t10-23l466-466q10-10 23-10t23\n    10l50 50q10 10 10 23z" />',viewBox:{x:1792,y:1792}}),ArrowAnnotate:v(r,{name:"ArrowAnnotate",iconContent:'<g id="arrowAnnotate-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="arrowAnnotate-arrow" d="M23,7 l-15,15 M7,17 l0,6 6,0" stroke-width="2" />\n  </g>',viewBox:{x:24,y:24}}),Bidirectional:v(r,{name:"Bidirectional",iconContent:'<g fill="{{color}}" stroke-width="3" stroke="{{color}}">\n    <path d="M27.63 3.21L3.12 28.81"></path>\n    <path d="M27.63 15.75L15.27 4.43"></path>\n    <path d="M16.5 4.28C16.5 4.96 15.95 5.51 15.27 5.51C14.59 5.51 14.03 4.96 14.03 4.28C14.03 3.59 14.59 3.04 15.27 3.04C15.95 3.04 16.5 3.59 16.5 4.28Z" ></path>\n    <path d="M28.87 3.19C28.87 3.87 28.31 4.43 27.63 4.43C26.95 4.43 26.4 3.87 26.4 3.19C26.4 2.51 26.95 1.95 27.63 1.95C28.31 1.95 28.87 2.51 28.87 3.19Z"></path>\n    <path d="M28.87 15.75C28.87 16.43 28.31 16.99 27.63 16.99C26.95 16.99 26.4 16.43 26.4 15.75C26.4 15.07 26.95 14.51 27.63 14.51C28.31 14.51 28.87 15.07 28.87 15.75Z"></path>\n    <path d="M4.73 28.44C4.73 29.12 4.17 29.68 3.49 29.68C2.81 29.68 2.25 29.12 2.25 28.44C2.25 27.76 2.81 27.2 3.49 27.2C4.17 27.2 4.73 27.76 4.73 28.44Z"></path>\n  </g>',viewBox:{x:48,y:48}}),CobbAngle:v(r,{name:"CobbAngle",iconContent:'<g stroke="{{color}}" stroke-width="3">\n    <path d="M28.59 2.34L3.82 12.32"></path>\n    <path d="M28.59 29.66L3.82 19.68"></path>\n    <path stroke-dasharray="2" fill-opacity="0" d="M12.37\n      23.06C12.67 22.36 12.85 21.93 12.92 21.76C14.6 17.8 14.68 13.35 13.15\n      9.33C13.11 9.24 13.02 9 12.88 8.63">\n    </path>\n  </g>',viewBox:{x:32,y:32}}),CircleROI:v(r,{name:"CircleROI",iconContent:'<circle stroke="{{color}}" fill="none" stroke-width="3" cx="16" cy="16" r="14" />',viewBox:{x:32,y:32}}),EllipticalROI:v(r,{name:"EllipticalROI",iconContent:'<path stroke="{{color}}" fill="none" stroke-width="3" d="M30.74 15.76C30.74 20.99 24.14 25.23 16\n    25.23C7.86 25.23 1.26 20.99 1.26 15.76C1.26 10.54 7.86 6.3 16 6.3C24.14\n    6.3 30.74 10.54 30.74 15.76Z" />',viewBox:{x:32,y:32}}),FreehandROI:v(r,{name:"FreehandROI",iconContent:'<g fill="{{color}}" stroke="{{color}}" stroke-width="2">\n    <ellipse ry="1" rx="1" id="svg_3" cy="4.240343" cx="14.306499"/>\n    <line id="svg_4" y2="3.58462" x2="12.242186" y1="3.997482" x1="13.432202"/>\n    <line id="svg_5" y2="3.268901" x2="10.857882" y1="3.608906" x1="12.387902"/>\n    <line id="svg_6" y2="3.147471" x2="9.740724" y1="3.293187" x1="10.955026"/>\n    <line id="svg_7" y2="3.147471" x2="8.089274" y1="3.196043" x1="9.983585"/>\n    <line id="svg_8" y2="3.268901" x2="6.874972" y1="3.123185" x1="8.307848"/>\n    <line id="svg_9" y2="3.657478" x2="5.587812" y1="3.220329" x1="7.020688"/>\n    <line id="svg_10" y2="4.046054" x2="4.737801" y1="3.560334" x1="5.854959"/>\n    <line id="svg_11" y2="4.337487" x2="4.300652" y1="3.997482" x1="4.834945"/>\n    <line id="svg_12" y2="4.726063" x2="3.88779" y1="4.191771" x1="4.470655"/>\n    <line id="svg_15" y2="5.3575" x2="3.377783" y1="4.604633" x1="3.960648"/>\n    <line id="svg_16" y2="6.183226" x2="2.916348" y1="5.138926" x1="3.547785"/>\n    <line id="svg_17" y2="6.960379" x2="2.770632" y1="5.867507" x1="3.037779"/>\n    <line id="svg_18" y2="7.713246" x2="2.673488" y1="6.741804" x1="2.819204"/>\n    <line id="svg_19" y2="8.684687" x2="2.697774" y1="7.616102" x1="2.673488"/>\n    <line id="svg_20" y2="9.753273" x2="2.892062" y1="8.611829" x1="2.697774"/>\n    <line id="svg_21" y2="10.724714" x2="3.134923" y1="9.534698" x1="2.84349"/>\n    <line id="svg_23" y2="11.647583" x2="3.596357" y1="10.578998" x1="3.086351"/>\n    <line id="svg_25" y2="12.521881" x2="4.276366" y1="11.501867" x1="3.499213"/>\n    <line id="svg_26" y2="13.930471" x2="5.830673" y1="12.376165" x1="4.13065"/>\n    <line id="svg_28" y2="14.707624" x2="7.263549" y1="13.881899" x1="5.733528"/>\n    <line id="svg_29" y2="15.339061" x2="8.963571" y1="14.61048" x1="7.06926"/>\n    <line id="svg_30" y2="15.581921" x2="10.882168" y1="15.314775" x1="8.817855"/>\n    <line id="svg_31" y2="15.460491" x2="12.023612" y1="15.581921" x1="10.785024"/>\n    <line id="svg_33" y2="15.120487" x2="13.092197" y1="15.484777" x1="11.877895"/>\n    <line id="svg_34" y2="14.586194" x2="13.86935" y1="15.217631" x1="12.897909"/>\n    <line id="svg_35" y2="13.833327" x2="14.597931" y1="14.756196" x1="13.699348"/>\n    <line id="svg_37" y2="12.716169" x2="15.180796" y1="13.881899" x1="14.549359"/>\n    <line id="svg_39" y2="11.429009" x2="15.520801" y1="12.813313" x1="15.15651"/>\n    <ellipse ry="1" rx="1" id="svg_40" cy="10.967574" cx="15.520801"/>\n  </g>',viewBox:{x:18,y:18}}),FreehandROISculptor:v(r,{name:"FreehandROISculptor",iconContent:'<g id="icon-freehand-sculpt" fill="none" stroke-width="1.5" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <line id="svg_1" y2="2.559367" x2="10.184807" y1="4.467781" x1="8.81711"/>\n    <line id="svg_4" y2="1.493836" x2="11.727442" y1="2.766112" x1="10.089386"/>\n    <line id="svg_7" y2="1.080346" x2="13.047428" y1="1.748291" x1="11.345759"/>\n    <line id="svg_8" y2="1.000829" x2="14.351511" y1="1.112153" x1="12.77707"/>\n    <line id="svg_9" y2="1.350705" x2="15.242104" y1="0.905408" x1="13.969828"/>\n    <line id="svg_10" y2="2.098167" x2="15.862339" y1="1.14396" x1="14.955842"/>\n    <line id="svg_11" y2="3.195505" x2="16.41896" y1="1.939133" x1="15.766918"/>\n    <line id="svg_12" y2="4.292843" x2="16.530284" y1="2.925147" x1="16.387153"/>\n    <line id="svg_16" y2="5.644637" x2="16.196311" y1="3.831643" x1="16.593898"/>\n    <line id="svg_18" y2="7.266789" x2="15.623787" y1="5.19934" x1="16.275829"/>\n    <line id="svg_19" y2="10.813258" x2="14.526449" y1="6.726071" x1="15.766918"/>\n    <line id="svg_20" y2="5.056209" x2="8.085552" y1="4.181519" x1="8.976145"/>\n    <line id="svg_23" y2="5.326568" x2="7.481221" y1="4.78585" x1="8.403621"/>\n    <line id="svg_24" y2="5.565119" x2="6.749662" y1="5.294761" x1="7.624352"/>\n    <line id="svg_25" y2="5.994512" x2="5.429675" y1="5.533312" x1="6.956407"/>\n    <line id="svg_27" y2="6.551133" x2="4.284627" y1="5.962706" x1="5.572807"/>\n    <line id="svg_28" y2="7.584858" x2="3.044158" y1="6.392099" x1="4.427758"/>\n    <line id="svg_29" y2="8.84123" x2="2.185372" y1="7.489437" x1="3.219096"/>\n    <line id="svg_31" y2="10.606513" x2="1.644654" y1="8.602678" x1="2.280792"/>\n    <line id="svg_32" y2="13.214679" x2="1.48562" y1="10.352058" x1="1.724171"/>\n    <line id="svg_33" y2="14.375631" x2="1.676461" y1="12.992031" x1="1.453813"/>\n    <line id="svg_34" y2="15.298031" x2="2.264889" y1="14.152983" x1="1.517427"/>\n    <line id="svg_35" y2="16.172721" x2="3.521261" y1="14.948155" x1="1.915013"/>\n    <line id="svg_36" y2="16.824762" x2="5.207027" y1="15.997783" x1="3.28271"/>\n    <line id="svg_38" y2="17.063314" x2="7.035924" y1="16.745245" x1="4.968475"/>\n    <line id="svg_39" y2="16.888376" x2="9.278311" y1="17.047411" x1="6.733758"/>\n    <line id="svg_40" y2="16.284045" x2="10.661911" y1="16.983797" x1="8.992048"/>\n    <line id="svg_41" y2="15.313934" x2="11.647925" y1="16.395369" x1="10.455166"/>\n    <line id="svg_44" y2="13.898527" x2="12.82478" y1="15.425259" x1="11.504794"/>\n    <line id="svg_45" y2="12.037824" x2="14.144766" y1="14.312017" x1="12.522614"/>\n    <line id="svg_47" y2="10.59061" x2="14.605966" y1="12.228665" x1="13.953925"/>\n    <ellipse ry="1" rx="1" id="svg_48" cy="3.982726" cx="13.460918"/>\n  </g>',viewBox:{x:18,y:18}}),Length:v(r,{name:"Length",iconContent:'<g id="length-group" fill="none" stroke-width="1" stroke="{{color}}" stroke-linecap="round" stroke-linejoin="round">\n    <path id="length-dashes" d="m22.5,6 -16.5,16.5" stroke-width="3" stroke-dasharray="0.6666,5" />\n  </g>',viewBox:{x:24,y:24}}),Height:v(r,{name:"Height",iconContent:'<path d="m 6 22 l 8.5 0 v -16 h 8" stroke-width="3" fill="none" stroke="{{color}}" />',viewBox:{x:24,y:24}}),Probe:v(r,{name:"Probe",iconContent:'<path fill="{{color}}" d="M1152 896q0 106-75 181t-181 75-181-75-75-181 75-181 181-75 181 75\n    75 181zm-256-544q-148 0-273 73t-198 198-73 273 73 273 198 198 273 73 273-73\n    198-198 73-273-73-273-198-198-273-73zm768 544q0 209-103 385.5t-279.5\n    279.5-385.5 103-385.5-103-279.5-279.5-103-385.5 103-385.5 279.5-279.5\n    385.5-103 385.5 103 279.5 279.5 103 385.5z" />',viewBox:{x:1792,y:1792}}),RectangleROI:v(r,{name:"RectangleROI",iconContent:'<path fill="{{color}}" d="M1312 256h-832q-66 0-113 47t-47 113v832q0 66 47\n    113t113 47h832q66 0 113-47t47-113v-832q0-66-47-113t-113-47zm288 160v832q0\n    119-84.5 203.5t-203.5 84.5h-832q-119 0-203.5-84.5t-84.5-203.5v-832q0-119\n    84.5-203.5t203.5-84.5h832q119 0 203.5 84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),Label:v(r,{name:"Label",iconContent:'<path fill="{{color}}" d="M789 559l-170 450q33 0 136.5 2t160.5 2q19 0\n    57-2-87-253-184-452zm-725 1105l2-79q23-7 56-12.5t57-10.5 49.5-14.5 44.5-29\n    31-50.5l237-616 280-724h128q8 14 11 21l205 480q33 78 106 257.5t114 274.5q15\n    34 58 144.5t72 168.5q20 45 35 57 19 15 88 29.5t84 20.5q6 38 6 57 0 5-.5\n    13.5t-.5 12.5q-63 0-190-8t-191-8q-76 0-215 7t-178 8q0-43 4-78l131-28q1 0\n    12.5-2.5t15.5-3.5 14.5-4.5 15-6.5 11-8 9-11\n    2.5-14q0-16-31-96.5t-72-177.5-42-100l-450-2q-26 58-76.5 195.5t-50.5 162.5q0\n    22 14 37.5t43.5 24.5 48.5 13.5 57 8.5 41 4q1 19 1 58 0 9-2 27-58\n    0-174.5-10t-174.5-10q-8 0-26.5 4t-21.5 4q-80 14-188 14z" />',viewBox:{x:1792,y:1792}}),Crosshairs:v(r,{name:"Crosshairs",iconContent:'<path fill="{{color}}" d="M1325 1024h-109q-26 0-45-19t-19-45v-128q0-26\n    19-45t45-19h109q-32-108-112.5-188.5t-188.5-112.5v109q0 26-19 45t-45\n    19h-128q-26 0-45-19t-19-45v-109q-108 32-188.5 112.5t-112.5 188.5h109q26\n    0 45 19t19 45v128q0 26-19 45t-45 19h-109q32 108 112.5 188.5t188.5\n    112.5v-109q0-26 19-45t45-19h128q26 0 45 19t19 45v109q108-32\n    188.5-112.5t112.5-188.5zm339-192v128q0 26-19 45t-45 19h-143q-37 161-154.5\n    278.5t-278.5 154.5v143q0 26-19 45t-45 19h-128q-26\n    0-45-19t-19-45v-143q-161-37-278.5-154.5t-154.5-278.5h-143q-26\n    0-45-19t-19-45v-128q0-26 19-45t45-19h143q37-161\n    154.5-278.5t278.5-154.5v-143q0-26 19-45t45-19h128q26 0 45 19t19 45v143q161\n    37 278.5 154.5t154.5 278.5h143q26 0 45 19t19 45z" />',viewBox:{x:1792,y:1792}}),Eraser:v(r,{name:"Eraser",iconContent:'<path transform="translate(0,1792) scale(1,-1)" fill="{{color}}" d="M960 1408l336-384h-768l-336 384h768zm1013-1077q15\n    34 9.5 71.5t-30.5 65.5l-896 1024q-38 44-96 44h-768q-38\n    0-69.5-20.5t-47.5-54.5q-15-34-9.5-71.5t30.5-65.5l896-1024q38-44 96-44h768q38\n    0 69.5 20.5t47.5 54.5z" />',viewBox:{x:2048,y:1792}}),Magnify:v(r,{name:"Magnify",iconContent:'<path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />',viewBox:{x:512,y:512}}),Pan:v(r,{name:"Pan",iconContent:'<path fill="{{color}}" d="M1411 541l-355 355 355 355 144-144q29-31 70-14 39 17\n    39 59v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39 14-69l144-144-355-355-355\n    355 144 144q31 30 14 69-17 40-59 40h-448q-26 0-45-19t-19-45v-448q0-42 40-59\n    39-17 69 14l144 144 355-355-355-355-144 144q-19 19-45 19-12\n    0-24-5-40-17-40-59v-448q0-26 19-45t45-19h448q42 0 59 40 17 39-14 69l-144\n    144 355 355 355-355-144-144q-31-30-14-69 17-40 59-40h448q26 0 45 19t19\n    45v448q0 42-39 59-13 5-25 5-26 0-45-19z" />',viewBox:{x:1792,y:1792}}),Rotate:v(r,{name:"Rotate",iconContent:'<path fill="{{color}}" d="M1664 256v448q0 26-19 45t-45 19h-448q-42 0-59-40-17-39\n    14-69l138-138q-148-137-349-137-104 0-198.5 40.5t-163.5 109.5-109.5\n    163.5-40.5 198.5 40.5 198.5 109.5 163.5 163.5 109.5 198.5 40.5q119 0\n    225-52t179-147q7-10 23-12 15 0 25 9l137 138q9 8 9.5 20.5t-7.5 22.5q-109\n    132-264 204.5t-327 72.5q-156 0-298-61t-245-164-164-245-61-298 61-298\n    164-245 245-164 298-61q147 0 284.5 55.5t244.5 156.5l130-129q29-31 70-14\n    39 17 39 59z" />',viewBox:{x:1792,y:1792}}),StackScroll:v(r,{name:"StackScroll",iconContent:'<path fill="{{color}}" d="M24 21v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1zM24 13v2c0\n    0.547-0.453 1-1 1h-22c-0.547 0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547\n    0 1 0.453 1 1zM24 5v2c0 0.547-0.453 1-1 1h-22c-0.547\n    0-1-0.453-1-1v-2c0-0.547 0.453-1 1-1h22c0.547 0 1 0.453 1 1z" />',viewBox:{x:24,y:28}}),WindowLevelRegion:v(r,{name:"WindowLevelRegion",iconContent:'<path fill="{{color}}" d="M1664 416v960q0 119-84.5 203.5t-203.5 84.5h-960q-119\n    0-203.5-84.5t-84.5-203.5v-960q0-119 84.5-203.5t203.5-84.5h960q119 0 203.5\n    84.5t84.5 203.5z" />',viewBox:{x:1792,y:1792}}),WindowLevel:v(r,{name:"WindowLevel",iconContent:'\n    <path fill="{{color}}" d="M14.5,3.5 a1 1 0 0 1 -11,11 Z" stroke="none" opacity="0.8" />\n    <circle cx="9" cy="9" r="8" fill="none" stroke-width="2" stroke="{{color}}" />',viewBox:{x:18,y:18}}),Zoom:v(r,{name:"Zoom",iconContent:'\n  <path fill="{{color}}" d="M508.5 481.6l-129-129c-2.3-2.3-5.3-3.5-8.5-3.5h-10.3C395\n    312 416 262.5 416 208 416 93.1 322.9 0 208 0S0 93.1 0 208s93.1 208 208 208c54.5\n    0 104-21 141.1-55.2V371c0 3.2 1.3 6.2 3.5 8.5l129 129c4.7 4.7 12.3 4.7 17\n    0l9.9-9.9c4.7-4.7 4.7-12.3 0-17zM208 384c-97.3 0-176-78.7-176-176S110.7 32 208\n    32s176 78.7 176 176-78.7 176-176 176z" />\n  <path fill="{{color}}" transform="scale(0.22,0.22) translate(1400,0)" d="M1216\n    320q0 26-19 45t-45 19h-128v1024h128q26 0 45 19t19 45-19 45l-256 256q-19\n    19-45 19t-45-19l-256-256q-19-19-19-45t19-45 45-19h128v-1024h-128q-26\n    0-45-19t-19-45 19-45l256-256q19-19 45-19t45 19l256 256q19 19 19 45z" />',viewBox:{x:640,y:512}}),SegmentationFreeHandEraseInside:v(r,{name:"SegmentationFreeHandEraseInside",iconContent:`${h} ${d}`,viewBox:l}),SegmentationFreeHandFillInside:v(r,{name:"SegmentationFreeHandFillInside",iconContent:`${h} ${c}`,viewBox:l}),SegmentationFreeHandEraseOutside:v(r,{name:"SegmentationFreeHandEraseOutside",iconContent:`${h} ${d}`,viewBox:l}),SegmentationFreeHandFillOutside:v(r,{name:"SegmentationFreeHandFillOutside",iconContent:`${h} ${c}`,viewBox:l}),SegmentationRectangleEraseInside:v(r,{name:"SegmentationRectangleEraseInside",iconContent:`${g} ${d}`,viewBox:l}),RectangleScissor:v(r,{name:"RectangleScissor",iconContent:`${g} ${c}`,viewBox:l}),"RectangleScissor.FILL_INSIDE":v(r,{name:"RectangleScissor.FILL_INSIDE",iconContent:`${g} ${c}`,viewBox:l}),"RectangleScissor.FILL_OUTSIDE":v(r,{name:"RectangleScissor.FILL_OUTSIDE",iconContent:`${g} ${c}`,viewBox:l}),"RectangleScissor.ERASE_OUTSIDE":v(r,{name:"RectangleScissor.ERASE_OUTSIDE",iconContent:`${g} ${d}`,viewBox:l}),"RectangleScissor.ERASE_INSIDE":v(r,{name:"RectangleScissor.ERASE_INSIDE",iconContent:`${g} ${d}`,viewBox:l}),CircleScissor:v(r,{name:"CircleScissor",iconContent:`${u} ${c}`,viewBox:l}),"CircleScissor.FILL_INSIDE":v(r,{name:"CircleScissor.FILL_INSIDE",iconContent:`${u} ${c}`,viewBox:l}),"CircleScissor.ERASE_OUTSIDE":v(r,{name:"CircleScissor.ERASE_OUTSIDE",iconContent:`${u} ${d}`,viewBox:l}),"CircleScissor.FILL_OUTSIDE":v(r,{name:"CircleScissor.FILL_OUTSIDE",iconContent:`${u} ${c}`,viewBox:l})};function v(e,t){return Object.assign(Object.create(e),{...t,name:t.name||e.name})}function p(e,t,n){m[e]=v(r,{iconContent:t,viewBox:n})}const f=Object.keys(m);var E=n(76712);const w=s.AnnotationStyleStates.Highlighted,I=s.ToolModes.Active;class C extends a{constructor(e,t,n,o,i){super(e,t,n,o,i)}static getDefinedCursor(e,t=!1,n){n||(n=(0,E.h)("color",{},w,I));const o=function(e,t,n){const o=t?"pointer":"cursor";return`${o}:${e}/${n}`}(e,t,n);let i=super.getDefinedCursor(o);if(!i){const a=function(e){return m[e]}(e);a&&(i=function(e,t,n,o,i){const{x:a,y:s}=e.mousePoint;return new C(function(e,t,n){const o=function(e,t,n){const o=(t?A:b)(e,n);return new Blob([o],{type:"image/svg+xml"})}(e,t,n),i=`${URL.createObjectURL(o)}#${e.name||"unknown"}-${t?"pointer":"cursor"}`;return i}(e,n,{color:o}),a,s,t,i)}(a,o,t,n,super.getDefinedCursor("default")),super.setDefinedCursor(o,i))}return i}}function T(e,t){const n=Object(t),o=Object.prototype.hasOwnProperty.bind(n);return(e+"").replace(/\{\{(\w+)\}\}/g,(e,t)=>o(t)?n[t]+"":"")}function b(e,t){const{iconContent:n,iconSize:o,viewBox:i}=e;return T(`\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="${o}" height="${o}" viewBox="0 0\n      ${i.x} ${i.y}">\n      ${n}\n    </svg>`,t)}function A(e,t){const{iconContent:n,iconSize:o,viewBox:i,mousePointerGroupString:a}=e,s=16+o;return T(`\n    <svg data-icon="cursor" role="img" xmlns="http://www.w3.org/2000/svg"\n      width="${s}" height="${s}" viewBox="0 0 ${s} ${s}">\n      <g>${a}</g>\n      <g transform="translate(16, 16) scale(${o/Math.max(i.x,i.y,1)})">${n}</g>\n    </svg>`,t)}var _=n(7001);const S=function(e,t){let n=C.getDefinedCursor(t,!0);n||(n=o.A.getDefinedCursor(t)),n||(console.log(`Cursor ${t} is not defined either as SVG or as a standard cursor.`),n=o.A.getDefinedCursor(t)),(0,_.setElementCursor)(e,n)},D=[...f,...o.i]},85856:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});n(97181);var o=n(95074);const i=function(e,t,n,i,a,s={},r=""){const l=[(i[0]+a[0])/2,i[1]],d=[(i[0]+a[0])/2,a[1]],c=[i[0],(i[1]+a[1])/2],h=[a[0],(i[1]+a[1])/2];(0,o.A)(e,t,n,[d,l,c,h],{},"")}},95074:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(97181),i=n(85899),a=n(56442);const s=function(e,t,n,s,r={},l=""){const{color:d,width:c,lineWidth:h,lineDash:g}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},r),u=h||c,m=(0,o.A)(t,"ellipse",n),v=e.getSvgNode(m),[p,f,E,w]=s,I=Math.hypot(E[0]-w[0],E[1]-w[1]),C=Math.hypot(f[0]-p[0],f[1]-p[1]),T=180*Math.atan2(E[1]-w[1],E[0]-w[0])/Math.PI,b=[(E[0]+w[0])/2,(f[1]+p[1])/2],A={cx:`${b[0]}`,cy:`${b[1]}`,rx:`${I/2}`,ry:`${C/2}`,stroke:d,fill:"transparent",transform:`rotate(${T} ${b[0]} ${b[1]})`,"stroke-width":u,"stroke-dasharray":g};if(v)(0,i.A)(A,v),e.setNodeTouched(m);else{const t=document.createElementNS("http://www.w3.org/2000/svg","ellipse");""!==l&&t.setAttribute("data-id",l),(0,a.A)(A,t),e.appendNode(t,m)}}},94042:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(97181),i=n(56442),a=n(85899);const s=function(e,t,n,s,r={},l){const{color:d,handleRadius:c,width:h,lineWidth:g,fill:u,type:m,opacity:v}=Object.assign({color:"rgb(0, 255, 0)",handleRadius:"6",width:"2",lineWidth:void 0,fill:"transparent",type:"circle",opacity:1},r),p=g||h,f=(0,o.A)(t,"handle",`hg-${n}-index-${l}`);let E;if("circle"===m)E={cx:`${s[0]}`,cy:`${s[1]}`,r:c,stroke:d,fill:u,"stroke-width":p,opacity:v};else{if("rect"!==m)throw new Error(`Unsupported handle type: ${m}`);{const e=1.5*parseFloat(c);E={x:`${s[0]-.5*e}`,y:`${s[1]-.5*e}`,width:`${e}`,height:`${e}`,stroke:d,fill:u,"stroke-width":p,rx:""+.1*e,opacity:v}}}const w=e.getSvgNode(f);if(w)(0,a.A)(E,w),e.setNodeTouched(f);else{const t=document.createElementNS("http://www.w3.org/2000/svg",m);(0,i.A)(E,t),e.appendNode(t,f)}}},92118:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(97181),i=n(56442),a=n(85899);function s(e,t,n,s,r,l={},d=""){if(isNaN(s[0])||isNaN(s[1])||isNaN(r[0])||isNaN(r[1]))return;const{color:c="rgb(0, 255, 0)",width:h=10,lineWidth:g,lineDash:u,markerStartId:m=null,markerEndId:v=null,shadow:p=!1,strokeOpacity:f=1}=l,E=g||h,w=(0,o.A)(t,"line",n),I=e.getSvgNode(w),C=e.svgLayerElement.id,T=p?`filter:url(#shadow-${C});`:"",b={x1:`${s[0]}`,y1:`${s[1]}`,x2:`${r[0]}`,y2:`${r[1]}`,stroke:c,style:T,"stroke-width":E,"stroke-dasharray":u,"marker-start":m?`url(#${m})`:"","marker-end":v?`url(#${v})`:"","stroke-opacity":f};if(I)(0,a.A)(b,I),e.setNodeTouched(w);else{const t=document.createElementNS("http://www.w3.org/2000/svg","line");""!==d&&t.setAttribute("data-id",d),(0,i.A)(b,t),e.appendNode(t,w)}}},17311:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(97181),i=n(56442),a=n(85899);function s(e,t,n,s,r){const l=s.length&&s[0].length&&Array.isArray(s[0][0])?s:[s],{color:d="rgb(0, 255, 0)",width:c=10,fillColor:h="none",fillOpacity:g=0,lineWidth:u,lineDash:m,closePath:v=!1}=r,p=u||c,f=(0,o.A)(t,"path",n),E=e.getSvgNode(f);let w="";for(let e=0,t=l.length;e<t;e++){const t=l[e],n=t.length;if(!(n<2)){for(let e=0;e<n;e++){const n=t[e];w+=`${e?"L":"M"} ${n[0].toFixed(1)}, ${n[1].toFixed(1)} `}v&&(w+="Z ")}}if(!w)return;const I={d:w,stroke:d,fill:h,"fill-opacity":g,"stroke-width":p,"stroke-dasharray":m};if(E)(0,a.A)(I,E),e.setNodeTouched(f);else{const t=document.createElementNS("http://www.w3.org/2000/svg","path");(0,i.A)(I,t),e.appendNode(t,f)}}},98812:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(97181),i=n(56442),a=n(85899);function s(e,t,n,s,r){if(s.length<2)return;const{color:l="rgb(0, 255, 0)",width:d=10,fillColor:c="none",fillOpacity:h=0,lineWidth:g,lineDash:u,closePath:m=!1,markerStartId:v=null,markerEndId:p=null}=r,f=g||d,E=(0,o.A)(t,"polyline",n),w=e.getSvgNode(E);let I="";for(const e of s)I+=`${e[0].toFixed(1)}, ${e[1].toFixed(1)} `;if(m){const e=s[0];I+=`${e[0]}, ${e[1]}`}const C={points:I,stroke:l,fill:c,"fill-opacity":h,"stroke-width":f,"stroke-dasharray":u,"marker-start":v?`url(#${v})`:"","marker-end":p?`url(#${p})`:""};if(w)(0,a.A)(C,w),e.setNodeTouched(E);else{const t=document.createElementNS("http://www.w3.org/2000/svg","polyline");(0,i.A)(C,t),e.appendNode(t,E)}}},75076:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(97181),i=n(85899),a=n(56442);function s(e,t,n,s,r={},l=""){const{color:d,width:c,lineWidth:h,lineDash:g}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},r),u=h||c,m=(0,o.A)(t,"rect",n),v=e.getSvgNode(m),[p,f,E,w]=s,I=Math.hypot(p[0]-f[0],p[1]-f[1]),C=Math.hypot(p[0]-E[0],p[1]-E[1]),T=[(w[0]+p[0])/2,(w[1]+p[1])/2],b=[(E[0]+p[0])/2,(E[1]+p[1])/2],A=180*Math.atan2(T[1]-b[1],T[0]-b[0])/Math.PI,_={x:""+(T[0]-I/2),y:""+(T[1]-C/2),width:`${I}`,height:`${C}`,stroke:d,fill:"transparent",transform:`rotate(${A} ${T[0]} ${T[1]})`,"stroke-width":u,"stroke-dasharray":g};if(v)(0,i.A)(_,v),e.setNodeTouched(m);else{const t=document.createElementNS("http://www.w3.org/2000/svg","rect");""!==l&&t.setAttribute("data-id",l),(0,a.A)(_,t),e.appendNode(t,m)}}},26290:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var o=n(97181),i=n(85899);function a(e){const t=document.createElementNS("http://www.w3.org/2000/svg","tspan");return t.setAttribute("x","0"),t.setAttribute("dy","1.2em"),t.textContent=e,t}function s(e,t){let n=e.querySelector("rect.background");if(!t)return n&&e.removeChild(n),e.getBBox();n||(n=document.createElementNS("http://www.w3.org/2000/svg","rect"),n.setAttribute("class","background"),e.insertBefore(n,e.firstChild));const o=e.getBBox(),a={x:`${o.x}`,y:`${o.y}`,width:`${o.width}`,height:`${o.height}`,fill:t};return(0,i.A)(a,n),o}const r=function(e,t,n,r,l,d={}){return function(e,t,n,r=[""],l,d){const{padding:c,color:h,fontFamily:g,fontSize:u,background:m}=d;let v;const[p,f]=[l[0]+c,l[1]+c],E="http://www.w3.org/2000/svg",w=(0,o.A)(t,"text",n),I=e.getSvgNode(w);if(I){const n=I.querySelector("text"),o=Array.from(n.children);for(let e=0;e<o.length;e++){const t=o[e],n=r[e]||"";t.textContent=n}if(r.length>o.length){for(let e=0;e<r.length-o.length;e++){const t=a(r[e+o.length]);n.appendChild(t)}I.appendChild(n),e.appendNode(I,w)}const l={fill:h,"font-size":u,"font-family":g},d={transform:`translate(${p} ${f})`};(0,i.A)(l,n),(0,i.A)(d,I),I.setAttribute("data-annotation-uid",t),v=s(I,m),e.setNodeTouched(w)}else{const n=document.createElementNS(E,"g");n.setAttribute("data-annotation-uid",t),n.setAttribute("transform",`translate(${p} ${f})`);const o=function(e,t){const{color:n,fontFamily:o,fontSize:i}=t,a="http://www.w3.org/2000/svg",s=document.createElementNS(a,"text"),r="user-select: none; pointer-events: none; -webkit-tap-highlight-color:  rgba(255, 255, 255, 0);",l=`filter:url(#shadow-${e.svgLayerElement.id});`,d=`${r}${l}`;return s.setAttribute("x","0"),s.setAttribute("y","0"),s.setAttribute("fill",n),s.setAttribute("font-family",o),s.setAttribute("font-size",i),s.setAttribute("style",d),s.setAttribute("pointer-events","visible"),s}(e,d);for(let e=0;e<r.length;e++){const t=a(r[e]);o.appendChild(t)}n.appendChild(o),e.appendNode(n,w),v=s(n,m)}return Object.assign({},v,{x:p,y:f,height:v.height+c,width:v.width+c})}(e,t,n,r,l,Object.assign({fontFamily:"Helvetica, Arial, sans-serif",fontSize:"14px",color:"rgb(255, 255, 0)",background:"",padding:25,centerX:!1,centerY:!0},d))}},74347:(e,t,n)=>{"use strict";n.r(t),n.d(t,{draw:()=>o.A,drawArrow:()=>T,drawCircle:()=>i.A,drawEllipse:()=>a.A,drawEllipseByCoordinates:()=>s.A,drawFan:()=>p,drawHandle:()=>l.A,drawHandles:()=>r.A,drawHeight:()=>c,drawLine:()=>d.A,drawLinkedTextBox:()=>f.A,drawPath:()=>g.A,drawPolyline:()=>h.A,drawRect:()=>E.A,drawRectByCoordinates:()=>w.A,drawRedactionRect:()=>b,drawTextBox:()=>I.A,setAttributesIfNecessary:()=>m.A,setNewAttributesIfValid:()=>v.A});var o=n(18262),i=n(12004),a=n(85856),s=n(95074),r=n(56745),l=n(94042),d=n(92118);function c(e,t,n,o,i,a={}){if(isNaN(o[0])||isNaN(o[1])||isNaN(i[0])||isNaN(i[1]))return;const{color:s,width:r,lineWidth:l,lineDash:c}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},a),h=i[0]+(o[0]-i[0])/2,g=[h,o[1]],u=[h,i[1]],m={start:o,end:g},v={start:g,end:u},p={start:u,end:i};(0,d.A)(e,t,"1",m.start,m.end,{color:s,width:r,lineWidth:l,lineDash:c}),(0,d.A)(e,t,"2",v.start,v.end,{color:s,width:r,lineWidth:l,lineDash:c}),(0,d.A)(e,t,"3",p.start,p.end,{color:s,width:r,lineWidth:l,lineDash:c})}var h=n(98812),g=n(17311),u=n(97181),m=n(85899),v=n(56442);const p=function(e,t,n,o,i,a,s,r,l={},d="",c){const{color:h,fill:g,width:p,lineWidth:f,lineDash:E,fillOpacity:w,strokeOpacity:I}=Object.assign({color:"rgb(0, 255, 0)",fill:"transparent",width:"2",lineDash:void 0,lineWidth:void 0,strokeOpacity:1,fillOpacity:1},l),C=f||p,T=(0,u.A)(t,"fan",n),b=e.getSvgNode(T),A=s*Math.PI/180,_=r*Math.PI/180,S=o[0],D=o[1],y=S+a*Math.cos(A),M=D+a*Math.sin(A),x=S+a*Math.cos(_),R=D+a*Math.sin(_),P=S+i*Math.cos(A),L=D+i*Math.sin(A),k=r-s<=180?0:1;let O=`M ${y} ${M}`;O+=` A ${a} ${a} 0 ${k} 1 ${x} ${R}`,O+=` L ${S+i*Math.cos(_)} ${D+i*Math.sin(_)}`,O+=` A ${i} ${i} 0 ${k} 0 ${P} ${L}`,O+=" Z";const U={d:O,stroke:h,fill:g,"stroke-width":C,"stroke-dasharray":E,"fill-opacity":w,"stroke-opacity":I,"mix-blend-mode":"normal"};if(b)(0,m.A)(U,b),e.setNodeTouched(T);else{const t=document.createElementNS("http://www.w3.org/2000/svg","path");""!==d&&t.setAttribute("data-id",d),void 0!==c&&(t.style.zIndex=c.toString()),(0,v.A)(U,t),e.appendNode(t,T)}};var f=n(1595),E=n(97530),w=n(75076),I=n(26290);const C="http://www.w3.org/2000/svg";function T(e,t,n,o,i,a={}){if(isNaN(o[0])||isNaN(o[1])||isNaN(i[0])||isNaN(i[1]))return;const{viaMarker:s=!1,color:r="rgb(0, 255, 0)",markerSize:l=10}=a;if(!s)return void function(e,t,n,o,i,a={}){const{color:s="rgb(0, 255, 0)",width:r=2,lineWidth:l,lineDash:c}=a,h=10,g=Math.atan2(i[1]-o[1],i[0]-o[0]),u={start:[i[0]-h*Math.cos(g-Math.PI/7),i[1]-h*Math.sin(g-Math.PI/7)],end:i},m={start:[i[0]-h*Math.cos(g+Math.PI/7),i[1]-h*Math.sin(g+Math.PI/7)],end:i};(0,d.A)(e,t,n,o,i,{color:s,width:r,lineWidth:l,lineDash:c}),(0,d.A)(e,t,"2",u.start,u.end,{color:s,width:r,lineWidth:l,lineDash:c}),(0,d.A)(e,t,"3",m.start,m.end,{color:s,width:r,lineWidth:l,lineDash:c})}(e,t,n,o,i,a);const c=`${`arrow-${t}`}-${e.svgLayerElement.id}`,h=e.svgLayerElement.querySelector("defs");let g=h.querySelector(`#${c}`);if(g){g.setAttribute("markerWidth",`${l}`),g.setAttribute("markerHeight",`${l}`);const e=g.querySelector("path");e&&e.setAttribute("fill",r)}else{g=document.createElementNS(C,"marker"),g.setAttribute("id",c),g.setAttribute("viewBox","0 0 10 10"),g.setAttribute("refX","8"),g.setAttribute("refY","5"),g.setAttribute("markerWidth",`${l}`),g.setAttribute("markerHeight",`${l}`),g.setAttribute("orient","auto");const e=document.createElementNS(C,"path");e.setAttribute("d","M 0 0 L 10 5 L 0 10 z"),e.setAttribute("fill",r),g.appendChild(e),h.appendChild(g)}a.markerEndId=c,(0,d.A)(e,t,n,o,i,a)}function b(e,t,n,o,i,a={}){const{color:s,width:r,lineWidth:l,lineDash:d}=Object.assign({color:"rgb(0, 255, 0)",width:"2",lineWidth:void 0,lineDash:void 0},a),c=l||r,h=(0,u.A)(t,"rect",n),g=e.getSvgNode(h),p=[Math.min(o[0],i[0]),Math.min(o[1],i[1])],f=Math.abs(o[0]-i[0]),E=Math.abs(o[1]-i[1]),w={x:`${p[0]}`,y:`${p[1]}`,width:`${f}`,height:`${E}`,stroke:s,fill:"black","stroke-width":c,"stroke-dasharray":d};if(g)(0,m.A)(w,g),e.setNodeTouched(h);else{const t=document.createElementNS("http://www.w3.org/2000/svg","rect");(0,v.A)(w,t),e.appendNode(t,h)}}},85899:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});const o=function(e,t){Object.keys(e).forEach(n=>{const o=t.getAttribute(n),i=e[n];void 0===i||""===i?t.removeAttribute(n):o!==i&&t.setAttribute(n,i)})}},56442:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});const o=function(e,t){Object.keys(e).forEach(n=>{const o=e[n];void 0!==o&&""!==o&&t.setAttribute(n,o)})}},93098:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(15327),i=n(94021),a=n(27740);const s={enable:function(){o.eventTarget.addEventListener(i.A.ANNOTATION_COMPLETED,a.A.handleAnnotationCompleted),o.eventTarget.addEventListener(i.A.ANNOTATION_MODIFIED,a.A.handleAnnotationUpdate),o.eventTarget.addEventListener(i.A.ANNOTATION_REMOVED,a.A.handleAnnotationDelete)},disable:function(){o.eventTarget.removeEventListener(i.A.ANNOTATION_COMPLETED,a.A.handleAnnotationCompleted),o.eventTarget.removeEventListener(i.A.ANNOTATION_MODIFIED,a.A.handleAnnotationUpdate),o.eventTarget.removeEventListener(i.A.ANNOTATION_REMOVED,a.A.handleAnnotationDelete)}}},24271:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var o=n(15327),i=n(99737),a=n(70333);const{Active:s,Passive:r,Enabled:l}=i.ToolModes,d=function(e){(0,a.A)(e,[s,r,l]).forEach(t=>{t.onCameraModified&&t.onCameraModified(e)})},c={enable:function(e){e.addEventListener(o.Enums.Events.CAMERA_MODIFIED,d)},disable:function(e){e.removeEventListener(o.Enums.Events.CAMERA_MODIFIED,d)}}},93151:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var o=n(15327),i=n(99737),a=n(70333);const{Active:s,Passive:r,Enabled:l}=i.ToolModes,d=function(e){(0,a.A)(e,[s,r,l]).forEach(t=>{t.onResetCamera&&t.onResetCamera(e)})},c={enable:function(e){e.addEventListener(o.Enums.Events.CAMERA_RESET,d)},disable:function(e){e.removeEventListener(o.Enums.Events.CAMERA_RESET,d)}}},75681:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(15327),i=n(56069);const a=function(e){(0,i.A)(e.detail.element)},s={enable:function(e){e.addEventListener(o.Enums.Events.IMAGE_RENDERED,a)},disable:function(e){e.removeEventListener(o.Enums.Events.IMAGE_RENDERED,a)}}},40396:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var o=n(15327),i=n(99737),a=n(70333);const{Active:s,Passive:r,Enabled:l}=i.ToolModes,d=function(e){(0,a.A)(e,[s,r,l]).forEach(t=>{t.onImageSpacingCalibrated&&t.onImageSpacingCalibrated(e)})},c={enable:function(e){e.addEventListener(o.Enums.Events.IMAGE_SPACING_CALIBRATED,d)},disable:function(e){e.removeEventListener(o.Enums.Events.IMAGE_SPACING_CALIBRATED,d)}}},3406:(e,t,n)=>{"use strict";n.d(t,{$m:()=>l.A,In:()=>o.A,V$:()=>a.A,aB:()=>s.A,dj:()=>d.A,n6:()=>i.A,we:()=>c.A,z5:()=>r.A});var o=n(75681),i=n(66106),a=n(83438),s=n(24271),r=n(40396),l=n(45470),d=n(93098),c=n(93151)},83438:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var o=n(94021),i=n(74690);const a={enable:function(e){e.addEventListener(o.A.KEY_DOWN,i.u),e.addEventListener(o.A.KEY_UP,i.L)},disable:function(e){e.removeEventListener(o.A.KEY_DOWN,i.u),e.removeEventListener(o.A.KEY_UP,i.L)}}},66106:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var o=n(94021),i=n(40100);const a={enable:function(e){e.addEventListener(o.A.MOUSE_CLICK,i.q_),e.addEventListener(o.A.MOUSE_DOWN,i.cT),e.addEventListener(o.A.MOUSE_DOWN_ACTIVATE,i.Xd),e.addEventListener(o.A.MOUSE_DOUBLE_CLICK,i.LM),e.addEventListener(o.A.MOUSE_DRAG,i.al),e.addEventListener(o.A.MOUSE_MOVE,i.tG),e.addEventListener(o.A.MOUSE_UP,i.Je),e.addEventListener(o.A.MOUSE_WHEEL,i.rO)},disable:function(e){e.removeEventListener(o.A.MOUSE_CLICK,i.q_),e.removeEventListener(o.A.MOUSE_DOWN,i.cT),e.removeEventListener(o.A.MOUSE_DOWN_ACTIVATE,i.Xd),e.removeEventListener(o.A.MOUSE_DOUBLE_CLICK,i.LM),e.removeEventListener(o.A.MOUSE_DRAG,i.al),e.removeEventListener(o.A.MOUSE_MOVE,i.tG),e.removeEventListener(o.A.MOUSE_UP,i.Je),e.removeEventListener(o.A.MOUSE_WHEEL,i.rO)}}},45470:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var o=n(94021),i=n(84971);const a={enable:function(e){e.addEventListener(o.A.TOUCH_START,i.gX),e.addEventListener(o.A.TOUCH_START_ACTIVATE,i.$F),e.addEventListener(o.A.TOUCH_DRAG,i.Oz),e.addEventListener(o.A.TOUCH_END,i.ls),e.addEventListener(o.A.TOUCH_TAP,i.lI),e.addEventListener(o.A.TOUCH_PRESS,i.x5)},disable:function(e){e.removeEventListener(o.A.TOUCH_START,i.gX),e.removeEventListener(o.A.TOUCH_START_ACTIVATE,i.$F),e.removeEventListener(o.A.TOUCH_DRAG,i.Oz),e.removeEventListener(o.A.TOUCH_END,i.ls),e.removeEventListener(o.A.TOUCH_PRESS,i.x5)}}},21418:(e,t,n)=>{"use strict";n.d(t,{tQ:()=>W,nm:()=>G,Gg:()=>$,ge:()=>F,_9:()=>R,kt:()=>v.A,bH:()=>r,qI:()=>_,sp:()=>S,F_:()=>h,CG:()=>m});var o=n(91099),i=n(68014),a=n(41343);function s(e){e.removeEventListener("dblclick",o.A),e.removeEventListener("mousedown",i.Ay),e.removeEventListener("mousemove",a.A),e.removeEventListener("dblclick",i.DF,{capture:!0})}const r={enable:function(e){s(e),e.addEventListener("dblclick",o.A),e.addEventListener("mousedown",i.Ay),e.addEventListener("mousemove",a.A),e.addEventListener("dblclick",i.DF,{capture:!0})},disable:s};var l=n(41666),d=n(82603);function c(e){l.A.disable(e),e.removeEventListener("touchstart",d.A)}const h={enable:function(e){c(e),l.A.enable(e),e.addEventListener("touchstart",d.A,{passive:!1})},disable:c};var g=n(17806);function u(e){e.removeEventListener("wheel",g.A)}const m={enable:function(e){u(e),e.addEventListener("wheel",g.A,{passive:!1})},disable:u};var v=n(39595),p=n(24917),f=n(15327),E=n(99737);var w=n(59452),I=n(93210),C=n(97577);var T=n(33283),b=n(58859);const A=function(e){const{segmentationId:t,modifiedSlicesToUse:n}=e.detail,{representationData:o}=(0,T.T)(t),i=(0,b.P)(t),a=i.some(e=>{const{viewport:t}=(0,f.getEnabledElementByViewportId)(e);return t instanceof f.VolumeViewport}),s=i.some(e=>{const{viewport:t}=(0,f.getEnabledElementByViewportId)(e);return t instanceof f.StackViewport}),r=a&&s;i.forEach(e=>{const{viewport:a}=(0,f.getEnabledElementByViewportId)(e);a instanceof f.VolumeViewport&&function({modifiedSlicesToUse:e,representationData:t,type:n}){const o=f.cache.getVolume(t[n].volumeId);if(!o)return void console.warn("segmentation not found in cache");const{imageData:i,vtkOpenGLTexture:a}=o;let s;if(e?.length>0)s=e;else{const e=i.getDimensions()[2];s=[...Array(e).keys()]}s.forEach(e=>{a.setUpdatedFrame(e)}),i.modified()}({modifiedSlicesToUse:r?[]:n,representationData:o,type:E.SegmentationRepresentations.Labelmap}),a instanceof f.StackViewport&&function({viewportIds:e,segmentationId:t}){e.forEach(e=>{let n=(0,I.r$)(e,{segmentationId:t});n=n.filter(e=>e.type===E.SegmentationRepresentations.Labelmap),n.forEach(n=>{if(n.segmentationId!==t)return;const o=(0,f.getEnabledElementByViewportId)(e);if(!o)return;const{viewport:i}=o;if(i instanceof f.VolumeViewport)return;const a=(0,w.ED)(e,t);a?.length&&a.forEach((n,o)=>{const i=n.actor.getMapper().getInputData(),a=(0,C.aF)(e,t),s=f.cache.getImage(a[o]);i.modified(),f.utilities.updateVTKImageDataWithCornerstoneImage(i,s)})})})}({viewportIds:i,segmentationId:t})})},_=function(e){const{segmentationId:t}=e.detail,{representationData:n}=(0,T.T)(t);n.Labelmap&&A(e),(0,p.fy)(t)},S=function(e){const{segmentationId:t}=e.detail;(0,p.fy)(t)};var D=n(42008),y=n(58498),M=n(78231);new Map;function x(e){const t=e.detail,{viewportId:n,renderingEngineId:o}=t,{viewport:i}=(0,f.getEnabledElementByIds)(n,o),a=(0,I.r$)(n);if(!a?.length)return;const s=a.filter(e=>e.type===E.SegmentationRepresentations.Labelmap),r=i.getActors();s.forEach(e=>{const{segmentationId:t}=e;(0,M.t)(n,t)});const l=s.flatMap(e=>(0,w.ED)(n,e.segmentationId)).filter(e=>void 0!==e);l.length&&(l.forEach(e=>{s.find(t=>{const o=(0,C.aF)(n,t.segmentationId);return o?.includes(e.referencedId)})||i.removeActors([e.uid])}),s.forEach(t=>{const{segmentationId:o}=t,a=i.getCurrentImageId(),s=(0,C.aF)(n,o);if(!s)return;s.forEach(e=>{const s=f.cache.getImage(e);if(!s)return void console.warn("No derived image found in the cache for segmentation representation",t);const l=r.find(t=>t.referencedId===e);if(!l){const{dimensions:t,spacing:r,direction:l}=i.getImageDataMetadata(s),d=f.cache.getImage(a)||{imageId:a},{origin:c}=i.getImageDataMetadata(d),h=c,g=s.voxelManager.getConstructor(),u=s.voxelManager.getScalarData(),m=D.Ay.newInstance({name:"Pixels",numberOfComponents:1,values:new g(u)}),v=y.Ay.newInstance();return v.setDimensions(t[0],t[1],1),v.setSpacing(r),v.setDirection(l),v.setOrigin(h),v.getPointData().setScalars(m),v.modified(),i.addImages([{imageId:e,representationUID:`${o}-${E.SegmentationRepresentations.Labelmap}-${s.imageId}`,callback:({imageActor:e})=>{e.getMapper().setInputData(v)}}]),void(0,p.h6)(n)}{const e=l.actor.getMapper().getInputData();e.setDerivedImage?e.setDerivedImage(s):f.utilities.updateVTKImageDataWithCornerstoneImage(e,s)}}),i.render(),e.type===f.Enums.Events.IMAGE_RENDERED&&i.element.removeEventListener(f.Enums.Events.IMAGE_RENDERED,x)}))}const R={enable:function(e){if(!e)return;const t=(0,f.getEnabledElement)(e);if(!t)return;const{viewport:n}=t;n instanceof f.BaseVolumeViewport||(e.addEventListener(f.Enums.Events.PRE_STACK_NEW_IMAGE,x),e.addEventListener(f.Enums.Events.IMAGE_RENDERED,x))},disable:function(e){e.removeEventListener(f.Enums.Events.PRE_STACK_NEW_IMAGE,x),e.removeEventListener(f.Enums.Events.IMAGE_RENDERED,x)}};var P=n(56534),L=n(15295),k=n(82056),O=n(77609),U=n(3444),N=n(49941),V=n(65172);async function B(e){const t=e.detail.annotation;if(!(0,P.isContourSegmentationAnnotation)(t))return;const n=function(e){const t=(0,L.A)(e),n=t.find(e=>function(e,t=!1){const n="PlanarFreehandContourSegmentationTool",o=(0,O.getToolGroupForViewport)(e.id,e.renderingEngineId);let i;o?o.hasTool(n)?o.getToolOptions(n)||(i=`Tool ${n} must be in active/passive state in ${o.id} toolGroup`):i=`Tool ${n} not added to ${o.id} toolGroup`:i=`ToolGroup not found for viewport ${e.id}`;i&&!t&&console.warn(i);return!i}(e,!0));return n??t[0]}(t),o=function(e,t){const{annotationUID:n}=t;return(0,k.getAllAnnotations)().filter(o=>o.annotationUID&&o.annotationUID!==n&&(0,P.isContourSegmentationAnnotation)(o)&&(0,P.areSameSegment)(o,t)&&e.isReferenceViewable(o.metadata))}(n,t);if(!o.length)return void(0,f.triggerEvent)(f.eventTarget,E.Events.ANNOTATION_CUT_MERGE_PROCESS_COMPLETED,{element:n.element,sourceAnnotation:t});const i=(0,V.RZ)(t.data.contour.polyline,n),a=(0,U.h)(n,i,o);if(!a.length)return void(0,f.triggerEvent)(f.eventTarget,E.Events.ANNOTATION_CUT_MERGE_PROCESS_COMPLETED,{element:n.element,sourceAnnotation:t});if(a.length>1)return void(0,N.A)(n,t,i,a);const{targetAnnotation:s,targetPolyline:r,isContourHole:l}=a[0];if(l){const{contourHoleProcessingEnabled:o=!1}=e.detail;if(!o)return;(0,V.rK)(n,s,t)}else(0,V.pH)(n,s,r,t,i)}function W(e){const t=e.detail.annotation;P.isContourSegmentationAnnotation(t)&&B(e)}var H=n(58640);const F=function(e){if(!e.detail.removed.length)return;(0,f.getRenderingEngines)().forEach(e=>{const t=e.getViewports().map(e=>e.id);(0,H.t)(t)})};const G=function(e){const{viewportId:t}=e.detail;(0,H.A)([t])};function $(e){const t=e.detail.annotation;P.isContourSegmentationAnnotation(t)&&function(e){const t=e.detail.annotation;(0,P.removeContourSegmentationAnnotation)(t)}(e)}},44150:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(24917);const i=function(e){const{viewportId:t}=e.detail;(0,o.h6)(t)}},4667:(e,t,n)=>{"use strict";n.r(t),n.d(t,{AdvancedMagnifyTool:()=>p.M$,AngleTool:()=>p.yT,AnnotationDisplayTool:()=>p.wh,AnnotationTool:()=>p.EC,ArrowAnnotateTool:()=>p.ao,BaseTool:()=>p.oS,BidirectionalTool:()=>p.Mu,BrushTool:()=>p.ls,CONSTANTS:()=>s,CircleROIStartEndThresholdTool:()=>p.pq,CircleROITool:()=>p.Vl,CircleScissorsTool:()=>p.G2,CobbAngleTool:()=>p.EV,CrosshairsTool:()=>p.ep,DragProbeTool:()=>p.j$,ETDRSGridTool:()=>p.nJ,EllipticalROITool:()=>p.qD,Enums:()=>E,EraserTool:()=>p.dB,HeightTool:()=>p.m8,KeyImageTool:()=>p.Np,LabelMapEditWithContourTool:()=>p.LK,LabelTool:()=>p.hz,LabelmapBaseTool:()=>p.il,LengthTool:()=>p.LW,LivewireContourSegmentationTool:()=>p.Ix,LivewireContourTool:()=>p.Ys,MIPJumpToClickTool:()=>p.uJ,MagnifyTool:()=>p.eh,OrientationMarkerTool:()=>p.Xr,OverlayGridTool:()=>p.Nk,PaintFillTool:()=>p.Uj,PanTool:()=>p.CH,PlanarFreehandContourSegmentationTool:()=>p.qi,PlanarFreehandROITool:()=>p.ex,PlanarRotateTool:()=>p.A5,ProbeTool:()=>p.N7,RectangleROIStartEndThresholdTool:()=>p.mX,RectangleROIThresholdTool:()=>p.TR,RectangleROITool:()=>p.E0,RectangleScissorsTool:()=>p.td,ReferenceCursors:()=>p.xI,ReferenceLinesTool:()=>p.X8,RegionSegmentPlusTool:()=>p.sR,RegionSegmentTool:()=>p.wR,ScaleOverlayTool:()=>p.FE,SculptorTool:()=>p.N,SegmentBidirectionalTool:()=>p.Fz,SegmentLabelTool:()=>p.u9,SegmentSelectTool:()=>p.IX,SegmentationIntersectionTool:()=>p.cN,SphereScissorsTool:()=>p.zH,SplineContourSegmentationTool:()=>p.qT,SplineROITool:()=>p.J2,StackScrollTool:()=>p.ae,Synchronizer:()=>i.Synchronizer,SynchronizerManager:()=>i.SynchronizerManager,ToolGroupManager:()=>i.ToolGroupManager,TrackballRotateTool:()=>p.So,Types:()=>g,UltrasoundDirectionalTool:()=>p.oi,UltrasoundPleuraBLineTool:()=>p.T8,VideoRedactionTool:()=>f.A,VolumeRotateTool:()=>p.Oh,WholeBodySegmentTool:()=>p.Tc,WindowLevelRegionTool:()=>p.TG,WindowLevelTool:()=>p.Du,ZoomTool:()=>p.OQ,addTool:()=>i.addTool,annotation:()=>u,cancelActiveManipulations:()=>i.cancelActiveManipulations,cursors:()=>h,destroy:()=>o.zr,drawing:()=>d,init:()=>o.Ts,removeTool:()=>i.removeTool,segmentation:()=>m,splines:()=>v,state:()=>a.wk,store:()=>i,synchronizers:()=>l,utilities:()=>c,version:()=>r.r});var o=n(64957),i=n(6657),a=n(85204),s=n(47085),r=n(5363),l=n(34389),d=n(74347),c=n(53860),h=n(79475),g=n(13369),u=n(47807),m=n(90713),v=n(3040),p=n(49975),f=n(11811),E=n(99737)},64957:(e,t,n)=>{"use strict";n.d(t,{Ts:()=>v,zr:()=>p});var o=n(15327),i=n(82056),a=n(99737),s=n(6657),r=n(85204),l=n(21418),d=n(3406),c=n(77609),h=n(59475),g=n(44150),u=n(36625);let m=!1;function v(e={}){m||((0,u.Nk)(e),function(){f();const e=o.Enums.Events.ELEMENT_ENABLED,t=o.Enums.Events.ELEMENT_DISABLED;o.eventTarget.addEventListener(e,s.addEnabledElement),o.eventTarget.addEventListener(t,s.removeEnabledElement),d.dj.enable()}(),E(),o.eventTarget.addEventListener(a.Events.ANNOTATION_COMPLETED,l.tQ),o.eventTarget.addEventListener(a.Events.ANNOTATION_MODIFIED,l.nm),o.eventTarget.addEventListener(a.Events.ANNOTATION_SELECTION_CHANGE,l.ge),o.eventTarget.addEventListener(a.Events.ANNOTATION_SELECTION_CHANGE,l.ge),o.eventTarget.addEventListener(a.Events.ANNOTATION_REMOVED,l.Gg),o.eventTarget.addEventListener(a.Events.SEGMENTATION_MODIFIED,l.sp),o.eventTarget.addEventListener(a.Events.SEGMENTATION_DATA_MODIFIED,l.qI),o.eventTarget.addEventListener(a.Events.SEGMENTATION_REPRESENTATION_MODIFIED,g.A),o.eventTarget.addEventListener(a.Events.SEGMENTATION_REPRESENTATION_ADDED,g.A),m=!0)}function p(){f(),E(),c.destroy(),(0,r.qh)();const e=(0,i.getAnnotationManager)(),t=h._6;e.restoreAnnotations({}),t.resetState(),m=!1}function f(){const e=o.Enums.Events.ELEMENT_ENABLED,t=o.Enums.Events.ELEMENT_DISABLED;o.eventTarget.removeEventListener(e,s.addEnabledElement),o.eventTarget.removeEventListener(t,s.removeEnabledElement),d.dj.disable()}function E(){o.eventTarget.removeEventListener(a.Events.ANNOTATION_COMPLETED,l.tQ),o.eventTarget.removeEventListener(a.Events.ANNOTATION_MODIFIED,l.nm),o.eventTarget.removeEventListener(a.Events.ANNOTATION_SELECTION_CHANGE,l.ge),o.eventTarget.removeEventListener(a.Events.ANNOTATION_SELECTION_CHANGE,l.ge),o.eventTarget.removeEventListener(a.Events.SEGMENTATION_MODIFIED,l.sp),o.eventTarget.removeEventListener(a.Events.SEGMENTATION_DATA_MODIFIED,l.qI),o.eventTarget.removeEventListener(a.Events.SEGMENTATION_REPRESENTATION_MODIFIED,g.A),o.eventTarget.removeEventListener(a.Events.SEGMENTATION_REPRESENTATION_ADDED,g.A)}},39011:(e,t,n)=>{"use strict";n.d(t,{o:()=>c});var o=n(15327),i=n(99737),a=n(74347),s=n(39848);const{Active:r,Passive:l,Enabled:d}=i.ToolModes;const c=new class{constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._renderFlaggedViewports=()=>{this._throwIfDestroyed();const e=Array.from(this._viewportElements.values());for(let t=0;t<e.length;t++){const n=e[t];if(this._needsRender.has(n)&&(this._triggerRender(n),this._needsRender.delete(n),0===this._needsRender.size))break}this._animationFrameSet=!1,this._animationFrameHandle=null,this._render()},this._viewportElements=new Map}addViewportElement(e,t){this._viewportElements.set(e,t)}removeViewportElement(e,t){this._viewportElements.delete(e),this._needsRender.delete(t),this._reset()}renderViewport(e){this._setViewportsToBeRenderedNextFrame([e])}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setAllViewportsToBeRenderedNextFrame(){[...this._viewportElements.values()].forEach(e=>{this._needsRender.add(e)}),this._renderFlaggedViewports()}_setViewportsToBeRenderedNextFrame(e){const t=[...this._viewportElements.values()];e.forEach(e=>{-1!==t.indexOf(e)&&this._needsRender.add(e)}),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedViewports),this._animationFrameSet=!0)}_triggerRender(e){const t=(0,o.getEnabledElement)(e);if(!t)return;if(!(0,o.getRenderingEngine)(t.renderingEngineId))return void console.warn("rendering Engine has been destroyed");const n=(0,s.A)(e,[r,l,d]),{renderingEngineId:c,viewportId:h}=t,g={element:e,renderingEngineId:c,viewportId:h};(0,a.draw)(e,a=>{let s=!1;n.forEach(e=>{if(e.renderAnnotation){const n=e.renderAnnotation(t,a);s=s||n}}),s&&(0,o.triggerEvent)(e,i.Events.ANNOTATION_RENDERED,{...g})})}_reset(){window.cancelAnimationFrame(this._animationFrameHandle),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null,this._setAllViewportsToBeRenderedNextFrame()}}},67013:(e,t,n)=>{"use strict";n.d(t,{A:()=>s,H:()=>a});var o=n(15327);class i{constructor(e){this.getGroupKey=e=>{if("string"==typeof e)return e;const t=e,n=(0,o.getEnabledElement)(t);if(!n)throw new Error("Element not enabled, you must have an enabled element if you are not providing a FrameOfReferenceUID");return n.FrameOfReferenceUID},this._imageVolumeModifiedHandler=e=>{const t=e.detail,{FrameOfReferenceUID:n}=t,o=this.annotations[n];o&&Object.keys(o).forEach(e=>{o[e].forEach(e=>{void 0!==e.invalidated&&(e.invalidated=!0)})})},this.getFramesOfReference=()=>Object.keys(this.annotations),this.getAnnotations=(e,t)=>{const n=this.annotations;return n[e]?t?n[e][t]?n[e][t]:[]:n[e]:[]},this.getAnnotation=e=>{const t=this.annotations;for(const n in t){const o=t[n];for(const t in o){const n=o[t];for(const t of n)if(e===t.annotationUID)return t}}},this.getNumberOfAnnotations=(e,t)=>{const n=this.getAnnotations(e,t);if(!n.length)return 0;if(t)return n.length;let o=0;for(const e in n)o+=n[e].length;return o},this.addAnnotation=(e,t)=>{const{metadata:n}=e,{FrameOfReferenceUID:o,toolName:i}=n;t=t||o;const a=this.annotations;let s=a[t];s||(a[t]={},s=a[t]);let r=s[i];r||(s[i]=[],r=s[i]),this.preprocessingFn&&(e=this.preprocessingFn(e)),r.push(e)},this.removeAnnotation=e=>{const{annotations:t}=this;for(const n in t){const o=t[n];for(const t in o){const n=o[t],i=n.findIndex(t=>t.annotationUID===e);-1!==i&&(n.splice(i,1),0===n.length&&delete o[t])}0===Object.keys(o).length&&delete t[n]}},this.removeAnnotations=(e,t)=>{const n=this.annotations,o=[];if(!n[e])return o;if(t){const i=n[e][t];for(const e of i)this.removeAnnotation(e.annotationUID),o.push(e)}else for(const t in n[e]){const i=n[e][t];for(const e of i)this.removeAnnotation(e.annotationUID),o.push(e)}return o},this.saveAnnotations=(e,t)=>{const n=this.annotations;if(e&&t){const o=n[e];if(!o)return;const i=o[t];return structuredClone(i)}if(e){const t=n[e];return structuredClone(t)}return structuredClone(n)},this.restoreAnnotations=(e,t,n)=>{const o=this.annotations;if(t&&n){let i=o[t];i||(o[t]={},i=o[t]),i[n]=e}else t?o[t]=e:this.annotations=structuredClone(e)},this.getAllAnnotations=()=>Object.values(this.annotations).map(e=>Object.values(e)).flat(2),this.getNumberOfAllAnnotations=()=>{let e=0;const t=this.annotations;for(const n in t){const o=t[n];for(const t in o){e+=o[t].length}}return e},this.removeAllAnnotations=()=>{const e=[];for(const t of this.getAllAnnotations())this.removeAnnotation(t.annotationUID),e.push(t);return e},e||(e=o.utilities.uuidv4()),this.annotations={},this.uid=e,o.eventTarget.addEventListener(o.Enums.Events.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedHandler)}setPreprocessingFn(e){this.preprocessingFn=e}}const a=new i("DEFAULT"),s=i},2076:(e,t,n)=>{"use strict";n.r(t),n.d(t,{checkAndSetAnnotationLocked:()=>g,getAnnotationsLocked:()=>d,getAnnotationsLockedCount:()=>h,isAnnotationLocked:()=>c,setAnnotationLocked:()=>r,unlockAllAnnotations:()=>l});var o=n(15327),i=n(99737),a=n(82056);const s=new Set;function r(e,t=!0){const n=u();e&&(t?function(e,t,n){if(!t.has(e)){t.add(e),n.added.push(e);const o=(0,a.getAnnotation)(e);o&&(o.isLocked=!0)}}(e,s,n):m(e,s,n)),v(n,s)}function l(){const e=u();!function(e,t){e.forEach(n=>{m(n,e,t)})}(s,e),v(e,s)}function d(){return Array.from(s)}function c(e){return s.has(e)}function h(){return s.size}function g(e){const t=c(e);return r(e,t),t}function u(){return Object.freeze({added:[],removed:[],locked:[]})}function m(e,t,n){if(t.delete(e)){n.removed.push(e);const t=(0,a.getAnnotation)(e);t&&(t.isLocked=!1)}}function v(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach(t=>{e.locked.push(t)}),(0,o.triggerEvent)(o.eventTarget,i.Events.ANNOTATION_LOCK_CHANGE,e))}},17343:(e,t,n)=>{"use strict";n.r(t),n.d(t,{deselectAnnotation:()=>l,getAnnotationsSelected:()=>d,getAnnotationsSelectedByToolName:()=>c,getAnnotationsSelectedCount:()=>g,isAnnotationSelected:()=>h,setAnnotationSelected:()=>r});var o=n(15327),i=n(99737),a=n(82056);const s=new Set;function r(e,t=!0,n=!1){t?function(e,t=!1){const n=u();if(!t){m(s,n);const t=(0,a.getAnnotation)(e);t&&(t.isSelected=!0)}if(e&&!s.has(e)){s.add(e),n.added.push(e);const t=(0,a.getAnnotation)(e);t&&(t.isSelected=!0)}v(n,s)}(e,n):l(e)}function l(e){const t=u();if(e){if(s.delete(e)){t.removed.push(e);(0,a.getAnnotation)(e).isSelected=!1}}else m(s,t);v(t,s)}function d(){return Array.from(s)}function c(e){return d().filter(t=>{const n=(0,a.getAnnotation)(t);return n?.metadata?.toolName===e})}function h(e){return s.has(e)}function g(){return s.size}function u(){return Object.freeze({added:[],removed:[],selection:[]})}function m(e,t){e.forEach(n=>{if(e.delete(n)){t.removed.push(n);const e=(0,a.getAnnotation)(n);e&&(e.isSelected=!1)}})}function v(e,t){(e.added.length>0||e.removed.length>0)&&(t.forEach(t=>{e.selection.push(t)}),(0,o.triggerEvent)(o.eventTarget,i.Events.ANNOTATION_SELECTION_CHANGE,e))}},82056:(e,t,n)=>{"use strict";n.r(t),n.d(t,{addAnnotation:()=>v,addChildAnnotation:()=>g,clearParentAnnotation:()=>h,getAllAnnotations:()=>c,getAnnotation:()=>d,getAnnotationManager:()=>s,getAnnotations:()=>l,getChildAnnotations:()=>m,getNumberOfAnnotations:()=>p,getParentAnnotation:()=>u,invalidateAnnotation:()=>I,removeAllAnnotations:()=>E,removeAnnotation:()=>f,removeAnnotations:()=>w,setAnnotationManager:()=>r});var o=n(15327),i=n(44049);let a;function s(){return a}function r(e){a=e}function l(e,t){const n=s(),o=n.getGroupKey(t);return n.getAnnotations(o,e)}function d(e){return s().getAnnotation(e)}function c(){return s().getAllAnnotations()}function h(e){const{annotationUID:t,parentAnnotationUID:n}=e;if(!n)return;const o=d(n),i=o.childAnnotationUIDs.indexOf(t);o.childAnnotationUIDs.splice(i,1),e.parentAnnotationUID=void 0}function g(e,t){const{annotationUID:n}=e,{annotationUID:o}=t;h(t),e.childAnnotationUIDs||(e.childAnnotationUIDs=[]),e.childAnnotationUIDs.includes(o)||(e.childAnnotationUIDs.push(o),t.parentAnnotationUID=n)}function u(e){return e.parentAnnotationUID?d(e.parentAnnotationUID):void 0}function m(e){return e.childAnnotationUIDs?.map(e=>d(e))??[]}function v(e,t){e.annotationUID||(e.annotationUID=o.utilities.uuidv4());const n=s();if(t instanceof HTMLDivElement){const o=n.getGroupKey(t);n.addAnnotation(e,o),(0,i.triggerAnnotationAddedForElement)(e,t)}else n.addAnnotation(e,void 0),(0,i.triggerAnnotationAddedForFOR)(e);return e.annotationUID}function p(e,t){const n=s(),o=n.getGroupKey(t);return n.getNumberOfAnnotations(o,e)}function f(e){if(!e)return;const t=s(),n=t.getAnnotation(e);n&&(n.childAnnotationUIDs?.forEach(e=>f(e)),t.removeAnnotation(e),(0,i.triggerAnnotationRemoved)({annotation:n,annotationManagerUID:t.uid}))}function E(){const e=s(),t=e.removeAllAnnotations();for(const n of t)(0,i.triggerAnnotationRemoved)({annotation:n,annotationManagerUID:e.uid})}function w(e,t){const n=s(),o=n.getGroupKey(t),a=n.removeAnnotations(o,e);for(const e of a)(0,i.triggerAnnotationRemoved)({annotation:e,annotationManagerUID:n.uid})}function I(e){let t=e;for(;t;)t.invalidated=!0,t=t.parentAnnotationUID?d(t.parentAnnotationUID):void 0}},29601:(e,t,n)=>{"use strict";n.r(t),n.d(t,{checkAndSetAnnotationVisibility:()=>m,isAnnotationVisible:()=>c,setAnnotationVisibility:()=>l,showAllAnnotations:()=>d});var o=n(15327),i=n(99737),a=n(17343),s=n(82056);const r=new Set;function l(e,t=!0){const n=h();e&&(t?g(e,r,n):function(e,t,n){t.has(e)||(t.add(e),(0,a.isAnnotationSelected)(e)&&(0,a.deselectAnnotation)(e),n.lastHidden.push(e))}(e,r,n)),u(n)}function d(){const e=h();r.forEach(t=>{g(t,r,e)}),u(e)}function c(e){if((0,s.getAnnotation)(e))return!r.has(e)}function h(){return Object.freeze({lastVisible:[],lastHidden:[],hidden:[]})}function g(e,t,n){if(t.delete(e)){n.lastVisible.push(e);(0,s.getAnnotation)(e).isVisible=!0}}function u(e){(e.lastHidden.length>0||e.lastVisible.length>0)&&(r.forEach(t=>{e.hidden.push(t)}),(0,o.triggerEvent)(o.eventTarget,i.Events.ANNOTATION_VISIBILITY_CHANGE,e))}function m(e){const t=!r.has(e);return l(e,t),t}},8710:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});const o=new class{constructor(){this._initializeConfig({color:"rgb(255, 255, 0)",colorHighlighted:"rgb(0, 255, 0)",colorSelected:"rgb(0, 220, 0)",colorLocked:"rgb(209, 193, 90)",lineWidth:"1",lineDash:"",shadow:!0,textBoxVisibility:!0,textBoxFontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",textBoxFontSize:"14px",textBoxColor:"rgb(255, 255, 0)",textBoxColorHighlighted:"rgb(0, 255, 0)",textBoxColorSelected:"rgb(0, 255, 0)",textBoxColorLocked:"rgb(209, 193, 90)",textBoxBackground:"",textBoxLinkLineWidth:"1",textBoxLinkLineDash:"2,3",textBoxShadow:!0,markerSize:"10",angleArcLineDash:""})}getAnnotationToolStyles(e){return this.config.annotations&&this.config.annotations[e]}getViewportToolStyles(e){return this.config.viewports&&this.config.viewports[e]}getToolGroupToolStyles(e){return this.config.toolGroups&&this.config.toolGroups[e]}getDefaultToolStyles(){return this.config.default}setAnnotationStyles(e,t){let n=this.config.annotations;n||(this.config={...this.config,annotations:{}},n=this.config.annotations),n[e]=t}setViewportToolStyles(e,t){let n=this.config.viewports;n||(this.config={...this.config,viewports:{}},n=this.config.viewports),n[e]=t}setToolGroupToolStyles(e,t){let n=this.config.toolGroups;n||(this.config={...this.config,toolGroups:{}},n=this.config.toolGroups),n[e]=t}setDefaultToolStyles(e){this.config.default=e}getStyleProperty(e,t){const{annotationUID:n,viewportId:o,toolGroupId:i,toolName:a}=t;return this._getToolStyle(e,n,o,i,a)}_getToolStyle(e,t,n,o,i){if(t){const n=this.getAnnotationToolStyles(t);if(n&&void 0!==n[e])return n[e]}if(n){const t=this.getViewportToolStyles(n);if(t){if(t[i]&&void 0!==t[i][e])return t[i][e];if(t.global&&void 0!==t.global[e])return t.global[e]}}if(o){const t=this.getToolGroupToolStyles(o);if(t){if(t[i]&&void 0!==t[i][e])return t[i][e];if(t.global&&void 0!==t.global[e])return t.global[e]}}const a=this.getDefaultToolStyles();return a[i]&&void 0!==a[i][e]?a[i][e]:a.global&&void 0!==a.global[e]?a.global[e]:void 0}_initializeConfig(e){const t={};for(const n in e)t[n]=e[n];this.config={default:{global:t}}}}},76712:(e,t,n)=>{"use strict";n.d(t,{h:()=>i});var o=n(8710);function i(e,t,n,i){const a=function(e,t,n){const o=[`${e}`];return t&&o.push(`${o[0]}${t}`),n&&o.push(`${o[o.length-1]}${n}`),o}(e,n,i);for(let e=a.length-1;e>=0;--e){const n=o.A.getStyleProperty(a[e],t);if(void 0!==n)return n}}},49310:(e,t,n)=>{"use strict";n.r(t),n.d(t,{getFont:()=>l,getState:()=>s,style:()=>d.A});var o=n(2076),i=n(17343),a=n(99737);const s=function(e){if(e){if(e.data&&e.highlighted)return a.AnnotationStyleStates.Highlighted;if((0,i.isAnnotationSelected)(e.annotationUID))return a.AnnotationStyleStates.Selected;if((0,o.isAnnotationLocked)(e.annotationUID))return a.AnnotationStyleStates.Locked;if(e.data&&e.autoGenerated)return a.AnnotationStyleStates.AutoGenerated}return a.AnnotationStyleStates.Default};var r=n(76712);const l=function(e,t,n){return`${(0,r.h)("textBoxFontSize",e,t,n)}px ${(0,r.h)("textBoxFontFamily",e,t,n)}`};var d=n(8710)},47807:(e,t,n)=>{"use strict";n.r(t),n.d(t,{AnnotationGroup:()=>g,FrameOfReferenceSpecificAnnotationManager:()=>d.A,config:()=>o,locking:()=>i,selection:()=>a,state:()=>m,visibility:()=>l});var o=n(49310),i=n(2076),a=n(17343),s=n(82056),r=n(44049),l=n(29601),d=n(67013),c=n(15327),h=n(94021);class g{constructor(){this.annotationUIDs=new Set,this._isVisible=!0,this.visibleFilter=this.unboundVisibleFilter.bind(this)}unboundVisibleFilter(e){return!this._isVisible||!this.annotationUIDs.has(e)}has(e){return this.annotationUIDs.has(e)}setVisible(e=!0,t,n){this._isVisible!==e&&(this._isVisible=e,this.annotationUIDs.forEach(o=>{const i=(0,s.getAnnotation)(o);if(!i)return void this.annotationUIDs.delete(o);if(i.isVisible===e)return;if(!e&&!1===n?.(o))return;i.isVisible=e;const a={...t,annotation:i};(0,c.triggerEvent)(c.eventTarget,h.A.ANNOTATION_MODIFIED,a)}))}get isVisible(){return this._isVisible}findNearby(e,t){const n=[...this.annotationUIDs];if(0===n.length)return null;if(!e)return n[1===t?0:n.length-1];const o=n.indexOf(e);return-1===o||o+t<0||o+t>=n.length?null:n[o+t]}add(...e){e.forEach(e=>this.annotationUIDs.add(e))}remove(...e){e.forEach(e=>this.annotationUIDs.delete(e))}clear(){this.annotationUIDs.clear()}}var u=n(97);const m={...s,...r,resetAnnotationManager:u.c}},24917:(e,t,n)=>{"use strict";n.d(t,{fy:()=>f,h6:()=>p});var o=n(15327),i=n(99737),a=n(18682),s=n(93210),r=n(67014),l=n(25894),d=n(684),c=n(68040),h=n(85204),g=n(37590),u=n(77609);const m={[a.A.Labelmap]:d.Ay,[a.A.Contour]:l.A,[a.A.Surface]:r.Ay},v=g.A.toolName;function p(e){E.renderSegmentationsForViewport(e)}function f(e){E.renderSegmentation(e)}const E=new class{constructor(){this._needsRender=new Set,this._animationFrameSet=!1,this._animationFrameHandle=null,this._getAllViewports=()=>(0,o.getRenderingEngines)().flatMap(e=>e.getViewports()),this._renderFlaggedSegmentations=()=>{this._throwIfDestroyed();Array.from(this._needsRender).forEach(e=>{this._triggerRender(e)}),this._needsRender.clear(),this._animationFrameSet=!1,this._animationFrameHandle=null}}renderSegmentationsForViewport(e){const t=e?[e]:this._getViewportIdsForSegmentation();this._setViewportsToBeRenderedNextFrame(t)}renderSegmentation(e){const t=this._getViewportIdsForSegmentation(e);this._setViewportsToBeRenderedNextFrame(t)}_getViewportIdsForSegmentation(e){const t=this._getAllViewports(),n=[];for(const o of t){const t=o.id;if(e){const o=(0,s.r$)(t,{segmentationId:e});o?.length>0&&n.push(t)}else{const e=(0,s.r$)(t);e?.length>0&&n.push(t)}}return n}_throwIfDestroyed(){if(this.hasBeenDestroyed)throw new Error("this.destroy() has been manually called to free up memory, can not longer use this instance. Instead make a new one.")}_setViewportsToBeRenderedNextFrame(e){e.forEach(e=>{this._needsRender.add(e)}),this._render()}_render(){this._needsRender.size>0&&!1===this._animationFrameSet&&(this._animationFrameHandle=window.requestAnimationFrame(this._renderFlaggedSegmentations),this._animationFrameSet=!0)}_triggerRender(e){const t=(0,s.r$)(e);if(!t?.length)return;const{viewport:n}=(0,o.getEnabledElementByViewportId)(e)||{};if(!n)return;const a=[],r=t.map(e=>{e.type===i.SegmentationRepresentations.Contour&&this._addPlanarFreeHandToolIfAbsent(n);const t=m[e.type];try{const o=t.render(n,e);a.push(o)}catch(e){console.error(e)}return Promise.resolve({segmentationId:e.segmentationId,type:e.type})});Promise.allSettled(r).then(e=>{const t=e.filter(e=>"fulfilled"===e.status).map(e=>e.value);n.element.addEventListener(o.Enums.Events.IMAGE_RENDERED,function e(n){const{element:a,viewportId:s}=n.detail;a.removeEventListener(o.Enums.Events.IMAGE_RENDERED,e),t.forEach(e=>{const t={viewportId:s,segmentationId:e.segmentationId,type:e.type};(0,o.triggerEvent)(o.eventTarget,i.Events.SEGMENTATION_RENDERED,{...t})})}),n.render()})}_addPlanarFreeHandToolIfAbsent(e){v in h.wk.tools||(0,c.Gx)(g.A);const t=(0,u.getToolGroupForViewport)(e.id);t.hasTool(v)||(t.addTool(v),t.setToolPassive(v))}}},59475:(e,t,n)=>{"use strict";n.d(t,{Zm:()=>h,_6:()=>m,cC:()=>g});var o=n(15327),i=n(99737),a=n(642),s=n(99341),r=n(49906),l=n(92686),d=n(75419);const c={colorLUT:[],segmentations:[],viewportSegRepresentations:{}};async function h({imageIds:e,options:t}){const n=e,i=t?.volumeId||o.utilities.uuidv4();return await o.volumeLoader.createAndCacheVolumeFromImages(i,n),{volumeId:i}}async function g({segmentationId:e,options:t}){const n=m.getSegmentation(e),o=n.representationData.Labelmap,{volumeId:i}=await h({imageIds:o.imageIds,options:t});n.representationData.Labelmap.volumeId=i}function u(e){const t=a.Ay.newInstance(),n=s.Ay.newInstance();return n.addPoint(0,0),e===i.SegmentationRepresentations.Labelmap?{cfun:t,ofun:n}:{}}const m=new class{constructor(e){this._stackLabelmapImageIdReferenceMap=new Map,this._labelmapImageIdReferenceMap=new Map,e||=o.utilities.uuidv4(),this.state=Object.freeze(o.utilities.deepClone(c)),this.uid=e}getState(){return this.state}updateState(e){const t=o.utilities.deepClone(this.state);e(t),this.state=Object.freeze(t)}getColorLUT(e){return this.state.colorLUT[e]}getNextColorLUTIndex(){return this.state.colorLUT.length}resetState(){this._stackLabelmapImageIdReferenceMap.clear(),this._labelmapImageIdReferenceMap.clear(),this.state=Object.freeze(o.utilities.deepClone(c))}getSegmentation(e){return this.state.segmentations.find(t=>t.segmentationId===e)}updateSegmentation(e,t){this.updateState(n=>{const o=n.segmentations.find(t=>t.segmentationId===e);o?Object.assign(o,t):console.warn(`Segmentation with id ${e} not found. Update aborted.`)}),(0,r.triggerSegmentationModified)(e)}addSegmentation(e){if(this.getSegmentation(e.segmentationId))throw new Error(`Segmentation with id ${e.segmentationId} already exists`);this.updateState(t=>{const n=o.utilities.deepClone(e);if(n.representationData.Labelmap&&"volumeId"in n.representationData.Labelmap&&!("imageIds"in n.representationData.Labelmap)){const e=this.getLabelmapImageIds(n.representationData);n.representationData.Labelmap.imageIds=e}t.segmentations.push(n)}),(0,d.R)(e.segmentationId)}removeSegmentation(e){this.updateState(t=>{const n=t.segmentations.filter(t=>t.segmentationId!==e);t.segmentations.splice(0,t.segmentations.length,...n)}),(0,r.triggerSegmentationRemoved)(e)}addSegmentationRepresentation(e,t,n,a){if(!(0,o.getEnabledElementByViewportId)(e))return;this.getSegmentationRepresentations(e,{type:n,segmentationId:t}).length>0?console.debug("A segmentation representation of type",n,"already exists in viewport",e,"for segmentation",t):(this.updateState(o=>{o.viewportSegRepresentations[e]||(o.viewportSegRepresentations[e]=[],l.Y.setRenderInactiveSegmentations(e,!0)),n!==i.SegmentationRepresentations.Labelmap?this.addDefaultSegmentationRepresentation(o,e,t,n,a):this.addLabelmapRepresentation(o,e,t,a)}),(0,r.triggerSegmentationRepresentationModified)(e,t,n))}addDefaultSegmentationRepresentation(e,t,n,o,i){const a=e.segmentations.find(e=>e.segmentationId===n);if(!a)return;const s={};Object.keys(a.segments).forEach(e=>{s[Number(e)]={visible:!0}}),e.viewportSegRepresentations[t].push({segmentationId:n,type:o,active:!0,visible:!0,colorLUTIndex:i?.colorLUTIndex||0,segments:s,config:{...u(o),...i}}),this._setActiveSegmentation(e,t,n)}addLabelmapRepresentation(e,t,n,a=u(i.SegmentationRepresentations.Labelmap)){if(!(0,o.getEnabledElementByViewportId)(t))return;const s=this.getSegmentation(n);if(!s)return;const{representationData:r}=s;if(!r.Labelmap)return this.addDefaultSegmentationRepresentation(e,t,n,i.SegmentationRepresentations.Labelmap,a);this.processLabelmapRepresentationAddition(t,n),this.addDefaultSegmentationRepresentation(e,t,n,i.SegmentationRepresentations.Labelmap,a)}async processLabelmapRepresentationAddition(e,t){const n=(0,o.getEnabledElementByViewportId)(e);if(!n)return;const i=this.getSegmentation(t);if(!i)return;const a=n.viewport instanceof o.BaseVolumeViewport,{representationData:s}=i,r="volumeId"in s.Labelmap;n.viewport;a||r||this.updateLabelmapSegmentationImageReferences(e,i.segmentationId)}_updateLabelmapSegmentationReferences(e,t,n,o){const i=t.getCurrentImageId();let a=!1;for(const o of n){t.isReferenceViewable({referencedImageId:o},{asOverlay:!0})&&(a=!0,this._stackLabelmapImageIdReferenceMap.get(e).set(i,o),this._updateLabelmapImageIdReferenceMap({segmentationId:e,referenceImageId:i,labelmapImageId:o}))}return o&&o(t,e,n),a?this._stackLabelmapImageIdReferenceMap.get(e).get(i):void 0}updateLabelmapSegmentationImageReferences(e,t){const n=this.getSegmentation(t);if(!n)return;this._stackLabelmapImageIdReferenceMap.has(t)||this._stackLabelmapImageIdReferenceMap.set(t,new Map);const{representationData:i}=n;if(!i.Labelmap)return;const a=this.getLabelmapImageIds(i),s=(0,o.getEnabledElementByViewportId)(e).viewport;return this._updateLabelmapSegmentationReferences(t,s,a,null)}_updateAllLabelmapSegmentationImageReferences(e,t){const n=this.getSegmentation(t);if(!n)return;this._stackLabelmapImageIdReferenceMap.has(t)||this._stackLabelmapImageIdReferenceMap.set(t,new Map);const{representationData:i}=n;if(!i.Labelmap)return;const a=this.getLabelmapImageIds(i),s=(0,o.getEnabledElementByViewportId)(e).viewport;this._updateLabelmapSegmentationReferences(t,s,a,(e,t,n)=>{e.getImageIds().forEach((o,i)=>{for(const a of n){e.isReferenceViewable({referencedImageId:a,sliceIndex:i},{asOverlay:!0,withNavigation:!0})&&(this._stackLabelmapImageIdReferenceMap.get(t).set(o,a),this._updateLabelmapImageIdReferenceMap({segmentationId:t,referenceImageId:o,labelmapImageId:a}))}})})}getLabelmapImageIds(e){const t=e.Labelmap;let n;if(t.imageIds)n=t.imageIds;else if(!n&&t.volumeId){const e=t.volumeId;n=o.cache.getVolume(e).imageIds}return n}getLabelmapImageIdsForImageId(e,t){const n=this._generateMapKey({segmentationId:t,referenceImageId:e});return this._labelmapImageIdReferenceMap.get(n)}getCurrentLabelmapImageIdsForViewport(e,t){const n=(0,o.getEnabledElementByViewportId)(e);if(!n)return;const i=n.viewport.getCurrentImageId();return this.getLabelmapImageIdsForImageId(i,t)}getCurrentLabelmapImageIdForViewport(e,t){const n=(0,o.getEnabledElementByViewportId)(e);if(!n)return;if(!this._stackLabelmapImageIdReferenceMap.has(t))return;const i=n.viewport.getCurrentImageId();return this._stackLabelmapImageIdReferenceMap.get(t).get(i)}getStackSegmentationImageIdsForViewport(e,t){if(!this.getSegmentation(t))return[];this._updateAllLabelmapSegmentationImageReferences(e,t);const{viewport:n}=(0,o.getEnabledElementByViewportId)(e),i=n.getImageIds(),a=this._stackLabelmapImageIdReferenceMap.get(t);return i.map(e=>a.get(e))}removeSegmentationRepresentationsInternal(e,t){const n=[];return this.updateState(o=>{if(!o.viewportSegRepresentations[e])return;const i=o.viewportSegRepresentations[e];let a=!1;if(!t||Object.values(t).every(e=>void 0===e))n.push(...i),delete o.viewportSegRepresentations[e];else{const{segmentationId:s,type:r}=t;o.viewportSegRepresentations[e]=i.filter(e=>{const t=s&&r&&e.segmentationId===s&&e.type===r||s&&!r&&e.segmentationId===s||!s&&r&&e.type===r;return t&&(n.push(e),e.active&&(a=!0)),!t}),0===o.viewportSegRepresentations[e].length?delete o.viewportSegRepresentations[e]:a&&(o.viewportSegRepresentations[e][0].active=!0)}}),n}removeSegmentationRepresentations(e,t){const n=this.removeSegmentationRepresentationsInternal(e,t);n.forEach(t=>{(0,r.triggerSegmentationRepresentationRemoved)(e,t.segmentationId,t.type)});const o=this.getSegmentationRepresentations(e);return o.length>0&&o[0].active&&(0,r.triggerSegmentationRepresentationModified)(e,o[0].segmentationId,o[0].type),n}removeSegmentationRepresentation(e,t,n){const o=this.removeSegmentationRepresentationsInternal(e,t);return n||o.forEach(({segmentationId:t,type:n})=>{(0,r.triggerSegmentationRepresentationRemoved)(e,t,n)}),o}_updateLabelmapImageIdReferenceMap({segmentationId:e,referenceImageId:t,labelmapImageId:n}){const o=this._generateMapKey({segmentationId:e,referenceImageId:t});if(!this._labelmapImageIdReferenceMap.has(o))return void this._labelmapImageIdReferenceMap.set(o,[n]);const i=this._labelmapImageIdReferenceMap.get(o),a=Array.from(new Set([...i,n]));this._labelmapImageIdReferenceMap.set(o,a)}_setActiveSegmentation(e,t,n){const o=e.viewportSegRepresentations[t];o&&o.forEach(e=>{e.active=e.segmentationId===n})}setActiveSegmentation(e,t){this.updateState(n=>{const o=n.viewportSegRepresentations[e];o&&o.forEach(e=>{e.active=e.segmentationId===t})}),(0,r.triggerSegmentationRepresentationModified)(e,t)}getActiveSegmentation(e){if(!this.state.viewportSegRepresentations[e])return;const t=this.state.viewportSegRepresentations[e].find(e=>e.active);return t?this.getSegmentation(t.segmentationId):void 0}getSegmentationRepresentations(e,t={}){const n=this.state.viewportSegRepresentations[e];return n?t.type||t.segmentationId?n.filter(e=>{const n=!t.type||e.type===t.type,o=!t.segmentationId||e.segmentationId===t.segmentationId;return n&&o}):n:[]}getSegmentationRepresentation(e,t){return this.getSegmentationRepresentations(e,t)[0]}getSegmentationRepresentationVisibility(e,t){const n=this.getSegmentationRepresentation(e,t);return n?.visible}setSegmentationRepresentationVisibility(e,t,n){this.updateState(o=>{const i=this.getSegmentationRepresentations(e,t);i&&i.forEach(e=>{e.visible=n,Object.entries(e.segments).forEach(([e,t])=>{t.visible=n})})}),(0,r.triggerSegmentationRepresentationModified)(e,t.segmentationId,t.type)}addColorLUT(e,t){this.updateState(n=>{n.colorLUT[t]&&console.warn("Color LUT table already exists, overwriting"),n.colorLUT[t]=o.utilities.deepClone(e)})}removeColorLUT(e){this.updateState(t=>{delete t.colorLUT[e]})}_getStackIdForImageIds(e){return e.map(e=>e.slice(-Math.round(.15*e.length))).join("_")}getAllViewportSegmentationRepresentations(){return Object.entries(this.state.viewportSegRepresentations).map(([e,t])=>({viewportId:e,representations:t}))}getSegmentationRepresentationsBySegmentationId(e){const t=[];return Object.entries(this.state.viewportSegRepresentations).forEach(([n,o])=>{const i=o.filter(t=>t.segmentationId===e);i.length>0&&t.push({viewportId:n,representations:i})}),t}_generateMapKey({segmentationId:e,referenceImageId:t}){return`${e}-${t}`}}("DEFAULT")},26228:(e,t,n)=>{"use strict";n.r(t),n.d(t,{getActiveSegmentation:()=>a,setActiveSegmentation:()=>s});var o=n(67165),i=n(59475);function a(e){return(0,o.T)(e)}function s(e,t){!function(e,t){i._6.setActiveSegmentation(e,t)}(e,t)}},4714:(e,t,n)=>{"use strict";n.d(t,{u:()=>r});var o=n(15327),i=n(59475),a=n(70906),s=n(93952);function r(e,t){const n=i._6,r=t??(0,a.u)();let l=[...e];if(o.utilities.isEqual(l[0],[0,0,0,0])||(console.warn("addColorLUT: [0, 0, 0, 0] color is not provided for the background color (segmentIndex =0), automatically adding it"),l=[[0,0,0,0],...l]),l=l.map(e=>3===e.length?[e[0],e[1],e[2],255]:e),l.length<255){const e=s.A.slice(l.length);l=[...l,...e]}return n.addColorLUT(l,r),r}},74283:(e,t,n)=>{"use strict";n.d(t,{$j:()=>h,At:()=>s,Hr:()=>c,Wz:()=>l,cs:()=>r,gR:()=>a,w9:()=>d});var o=n(99737),i=n(55894);function a(e,t){t.map(t=>(0,i.U)(e,t))}function s(e,t){return a(e,t.map(e=>({...e,type:o.SegmentationRepresentations.Contour})))}function r(e){const t={};for(const[n,o]of Object.entries(e))t[n]=s(n,o);return t}function l(e,t){return a(e,t.map(e=>({...e,type:o.SegmentationRepresentations.Labelmap})))}function d(e){const t={};for(const[n,i]of Object.entries(e))t[n]=l(n,i.map(e=>({...e,type:o.SegmentationRepresentations.Labelmap})))}function c(e,t){return a(e,t.map(e=>({...e,type:o.SegmentationRepresentations.Surface})))}function h(e){const t={};for(const[n,o]of Object.entries(e))t[n]=c(n,o);return t}},30935:(e,t,n)=>{"use strict";n.d(t,{d:()=>l});var o=n(59475),i=n(49906),a=n(99737),s=n(15327);const r=function(e){const{segmentationId:t,representation:n,config:o}=e,{type:i,data:r}=n,l=r?{...r}:{};if(!l)throw new Error("Segmentation representation data may not be undefined");var d;i===a.SegmentationRepresentations.Contour&&((d=l).geometryIds=d.geometryIds??[],d.annotationUIDsMap=d.annotationUIDsMap??new Map);const c=function(e,t,n){const o={};e?Object.entries(e).forEach(([e,t])=>{const{label:n,locked:i,cachedStats:a,active:s,...r}=t,l={segmentIndex:Number(e),label:n??`Segment ${e}`,locked:i??!1,cachedStats:a??{},active:s??!1,...r};o[e]=l}):t===a.SegmentationRepresentations.Surface?function(e,t){const{geometryIds:n}=t;n?.forEach(t=>{const n=s.cache.getGeometry(t);if(n?.data){const{segmentIndex:t}=n.data;e[t]={segmentIndex:t}}})}(o,n):o[1]={segmentIndex:1,label:"Segment 1",locked:!1,cachedStats:{},active:!0};return o}(o?.segments,i,l);return delete o?.segments,{segmentationId:t,label:o?.label??null,cachedStats:o?.cachedStats??{},segments:c,representationData:{[i]:{...l}}}};function l(e,t){const n=o._6;e.forEach(e=>{const o=r(e);n.addSegmentation(o),t||(0,i.triggerSegmentationModified)(o.segmentationId)})}},93733:(e,t,n)=>{"use strict";n.r(t),n.d(t,{addColorLUT:()=>r,getSegmentIndexColor:()=>d,setColorLUT:()=>l,setSegmentIndexColor:()=>c});var o=n(4714),i=n(50409),a=n(93210),s=n(49906);function r(e,t){if(!e)throw new Error("addColorLUT: colorLUT is required");return(0,o.u)(e,t)}function l(e,t,n){if(!(0,i.B)(n))throw new Error(`setColorLUT: could not find colorLUT with index ${n}`);const o=(0,a.r$)(e,{segmentationId:t});if(!o)throw new Error(`viewport specific state for viewport ${e} does not exist`);o.forEach(e=>{e.colorLUTIndex=n}),(0,s.triggerSegmentationRepresentationModified)(e,t)}function d(e,t,n){const o=(0,a.r$)(e,{segmentationId:t});if(!o||0===o.length)return null;const s=o[0],{colorLUTIndex:r}=s,l=(0,i.B)(r);let d=l[n];if(!d){if("number"!=typeof n)return console.warn(`Can't create colour for LUT index ${n}`),null;d=l[n]=[0,0,0,0]}return d}function c(e,t,n,o){const i=d(e,t,n);for(let e=0;e<o.length;e++)i[e]=o[e];(0,s.triggerSegmentationRepresentationModified)(e,t)}},60740:(e,t,n)=>{"use strict";n.d(t,{Q:()=>i});var o=n(33283);function i(e){const t=(0,o.T)(e);if(t){const e=Object.keys(t.segments).find(e=>t.segments[e].active);return e?Number(e):void 0}}},50409:(e,t,n)=>{"use strict";n.d(t,{B:()=>i});var o=n(59475);function i(e){return o._6.getColorLUT(e)}},97577:(e,t,n)=>{"use strict";n.d(t,{T8:()=>s,aF:()=>a,vl:()=>i});var o=n(59475);function i(e,t){return a(e,t)[0]}function a(e,t){return o._6.getCurrentLabelmapImageIdsForViewport(e,t)}function s(e,t){return o._6.getLabelmapImageIdsForImageId(e,t)}},70906:(e,t,n)=>{"use strict";n.d(t,{u:()=>i});var o=n(59475);function i(){return o._6.getNextColorLUTIndex()}},33283:(e,t,n)=>{"use strict";n.d(t,{T:()=>i});var o=n(59475);function i(e){return o._6.getSegmentation(e)}},93210:(e,t,n)=>{"use strict";n.d(t,{Ut:()=>a,ny:()=>s,r$:()=>i});var o=n(59475);function i(e,t={}){return o._6.getSegmentationRepresentations(e,t)}function a(e,t){const n=o._6;if(!t.segmentationId||!t.type)throw new Error("getSegmentationRepresentation: No segmentationId or type provided, you need to provide at least one of them");const i=n.getSegmentationRepresentations(e,t);return i?.[0]}function s(e){return o._6.getSegmentationRepresentationsBySegmentationId(e)}},70758:(e,t,n)=>{"use strict";n.d(t,{K:()=>i});var o=n(59475);function i(){return o._6.getState().segmentations}},58859:(e,t,n)=>{"use strict";n.d(t,{P:()=>i});var o=n(59475);function i(e){const t=o._6.getState().viewportSegRepresentations;return Object.entries(t).filter(([,t])=>t.some(t=>t.segmentationId===e)).map(([e])=>e)}},42568:(e,t,n)=>{"use strict";n.d(t,{a:()=>a,z:()=>s});var o=n(33283),i=n(59475);function a(e,t){return s(e).map(e=>(t&&e.type,(0,o.T)(e.segmentationId))).filter(e=>void 0!==e)}function s(e){return i._6.getState().viewportSegRepresentations[e]}},93690:(e,t,n)=>{"use strict";n.d(t,{_:()=>s,f:()=>r});var o=n(15327),i=n(33283),a=n(98149);async function s({volumeId:e}){return{imageIds:o.cache.getVolume(e).imageIds}}function r({segmentationId:e,options:t}){const n=(0,i.T)(e);if(!n)return;const{volumeId:s}=n.representationData.Labelmap,r=o.cache.getVolume(s);return(0,a.X)({segmentationId:e,viewportId:t.viewportId,imageIds:r.imageIds,options:t})}},6994:(e,t,n)=>{"use strict";n.d(t,{a:()=>i});var o=n(59475);async function i(e){return(0,o.Zm)(e)}},59452:(e,t,n)=>{"use strict";n.d(t,{DU:()=>c,ED:()=>r,Qe:()=>s,Th:()=>d,wV:()=>l});var o=n(15327),i=n(99737);function a(e,t,n){const i=(0,o.getEnabledElementByViewportId)(e);if(!i)return;const{renderingEngine:a,viewport:s}=i;if(!a||!s)return;const r=s.getActors().filter(n);return r.length>0?r[0]:void 0}function s(e,t){const n=l(e,t);return n?.uid}function r(e,t){return function(e,t){const n=(0,o.getEnabledElementByViewportId)(e);if(!n)return;const{renderingEngine:i,viewport:a}=n;if(!i||!a)return;const s=a.getActors().filter(t);return s.length>0?s:void 0}(e,e=>e.representationUID?.startsWith(`${t}-${i.SegmentationRepresentations.Labelmap}`))}function l(e,t){return a(e,0,e=>e.representationUID?.startsWith(`${t}-${i.SegmentationRepresentations.Labelmap}`))}function d(e,t,n){return a(e,0,e=>e.representationUID===c(t,n))}function c(e,t){return`${e}-${i.SegmentationRepresentations.Surface}-${t}`}},91963:(e,t,n)=>{"use strict";n.d(t,{wV:()=>o.wV});n(9711);var o=n(59452)},90713:(e,t,n)=>{"use strict";n.r(t),n.d(t,{activeSegmentation:()=>m,addContourRepresentationToViewport:()=>l.At,addContourRepresentationToViewportMap:()=>l.cs,addLabelmapRepresentationToViewport:()=>l.Wz,addLabelmapRepresentationToViewportMap:()=>l.w9,addRepresentationData:()=>c.A,addSegmentationRepresentations:()=>l.gR,addSegmentations:()=>d.d,addSurfaceRepresentationToViewport:()=>l.Hr,addSurfaceRepresentationToViewportMap:()=>l.$j,config:()=>a,defaultSegmentationStateManager:()=>h._6,getActiveSegmentation:()=>ue.T,getCurrentLabelmapImageIdsForViewport:()=>ge.aF,getLabelmapImageIds:()=>de,getLabelmapImageIdsForImageId:()=>ge.T8,helpers:()=>me,removeAllSegmentationRepresentations:()=>r.us,removeAllSegmentations:()=>he.j,removeContourRepresentation:()=>r.OE,removeLabelmapRepresentation:()=>r.kN,removeSegment:()=>le,removeSegmentation:()=>he.z,removeSegmentationRepresentation:()=>r.E8,removeSegmentationRepresentations:()=>r.nc,removeSurfaceRepresentation:()=>r.JC,segmentIndex:()=>O,segmentLocking:()=>v,segmentationStyle:()=>y.Y,state:()=>p,strategies:()=>ce,triggerSegmentationEvents:()=>g,updateSegmentations:()=>u,utilities:()=>s});var o={};n.r(o),n.d(o,{getHiddenSegmentIndices:()=>_,getSegmentIndexVisibility:()=>A,getSegmentationRepresentationVisibility:()=>T,setSegmentIndexVisibility:()=>b,setSegmentationRepresentationVisibility:()=>C});var i={};n.r(i),n.d(i,{getRenderInactiveSegmentations:()=>P,getStyle:()=>M,hasCustomStyle:()=>k,resetToGlobalStyle:()=>L,setRenderInactiveSegmentations:()=>R,setStyle:()=>x});var a={};n.r(a),n.d(a,{color:()=>f,style:()=>i,visibility:()=>o});var s={};n.r(s),n.d(s,{decimateContours:()=>Z,extractSegmentPolylines:()=>K,getAnnotationMapFromSegmentation:()=>G,getViewportAssociatedToSegmentation:()=>W,getViewportWithMatchingViewPlaneNormal:()=>H,removeCompleteContourAnnotation:()=>Y,removeContourHoles:()=>X,removeContourIslands:()=>ee,smoothContours:()=>ne});var r=n(53662),l=n(74283),d=n(30935),c=n(44188),h=n(59475),g=n(49906);function u(e,t){const n=h._6;e.forEach(e=>{n.updateSegmentation(e.segmentationId,e.payload),t||(0,g.triggerSegmentationModified)(e.segmentationId)})}var m=n(26228),v=n(26795),p=n(98870),f=n(93733),E=n(93210);var w=n(33658),I=n(24917);function C(e,t,n){const o=(0,E.r$)(e,t);o&&o.forEach(t=>{!function(e,t,n){h._6.setSegmentationRepresentationVisibility(e,t,n)}(e,{segmentationId:t.segmentationId,type:t.type},n)})}function T(e,t){return(0,w.I)(e,t)}function b(e,t,n,o){const i=(0,E.r$)(e,t);i&&(i.forEach(e=>{e.segments[n].visible=o}),(0,I.fy)(t.segmentationId),(0,g.triggerSegmentationRepresentationModified)(e,t.segmentationId))}function A(e,t,n){return!_(e,t).has(n)}function _(e,t){const n=(0,E.Ut)(e,t);if(!n)return new Set;return Object.entries(n.segments).reduce((e,[t,n])=>(n.visible||e.add(Number(t)),e),new Set)}var S=n(70758),D=n(42568),y=n(92686);function M(e){return y.Y.getStyle(e)}function x(e,t){if(y.Y.setStyle(e,t),!e.viewportId&&!e.segmentationId){(0,S.K)().forEach(e=>{(0,I.h6)(e.segmentationId)})}(0,g.triggerSegmentationRepresentationModified)(e.viewportId,e.segmentationId,e.type)}function R(e,t){y.Y.setRenderInactiveSegmentations(e,t),(0,I.h6)(e);(0,D.a)(e).forEach(t=>{(0,g.triggerSegmentationRepresentationModified)(e,t.segmentationId)})}function P(e){return y.Y.getRenderInactiveSegmentations(e)}function L(){y.Y.resetToGlobalStyle(),(0,I.h6)()}function k(e){return y.Y.hasCustomStyle(e)}var O=n(70930),U=n(3823),N=n(15327),V=n(58859);function B(e){const t=(0,V.P)(e);if(0===t?.length)return[];const n=[];for(const e of t){const{viewport:t}=(0,N.getEnabledElementByViewportId)(e)||{};t&&n.push(t)}return n}function W(e){const t=B(e);return t.length>0?t[0]:void 0}function H(e,t,n=.99){const o=t.metadata?.viewPlaneNormal;if(!o||!Array.isArray(o))return;const i=U.eR.create();U.eR.normalize(i,o);for(const t of e){const e=t.getCamera();if(!e?.viewPlaneNormal)continue;const o=U.eR.create();U.eR.normalize(o,e.viewPlaneNormal);const a=U.eR.dot(i,o);if(Math.abs(a)>=n)return t}}var F=n(82056);function G(e,t={}){const n=e.annotationUIDsMap,o=t.segmentIndices?.length?t.segmentIndices:Array.from(n.keys()),i=new Map;return o.forEach(e=>{const t=n.get(e);let o=Array.from(t);o=o.filter(e=>!(0,F.getAnnotation)(e).parentAnnotationUID);const a=o.map(e=>{const t=(0,F.getAnnotation)(e),n=t.childAnnotationUIDs?.length,o=n&&t.childAnnotationUIDs.map(e=>{const t=(0,F.getAnnotation)(e);return{polyline:t.data.contour.polyline,isClosed:t.data.contour.closed}}),i=n&&o.map(e=>e.isClosed),a=n&&o.map(e=>e.polyline);return{polyline:t.data.contour.polyline,isClosed:t.data.contour.closed,annotationUID:t.annotationUID,referencedImageId:t.metadata.referencedImageId,holesPolyline:a,holesUIDs:t.childAnnotationUIDs,holesClosed:i}});i.set(e,a)}),{segmentIndices:o,annotationUIDsInSegmentMap:i}}var $=n(33283),z=n(56534);function q(e,t){if(!e||0===e.length)return[];if(!t)return[...e];const n=e[0],o=e[e.length-1];return n[0]===o[0]&&n[1]===o[1]&&n[2]===o[2]?[...e]:[...e,n]}function K(e,t){const n=B(e),o=(0,$.T)(e);if(!o)return;if(!o.representationData.Contour)return;const i=o.representationData.Contour,{annotationUIDsMap:a}=i;if(!a)return;if(!a.get(t))return;const s=function(e,t){const{annotationUIDsInSegmentMap:n}=G(e);if(!n.has(t))return void console.warn(`No contour information found for segmentIndex ${t}`);const o=new Map,i=n.get(t);for(const e of i){o.set(e.annotationUID,q(e.polyline,e.isClosed));for(let t=0;t<e.holesUIDs?.length;t++)o.set(e.holesUIDs[t],q(e.holesPolyline[t],e.holesClosed[t]))}return o}(i,t);if(!s)return;const r=Array.from(s?.keys()),l=new Map;for(const e of r){const t=H(n,(0,F.getAnnotation)(e));l.set(e,(0,z.convertContourPolylineToCanvasSpace)(s.get(e),t))}return l}var j=n(99944);function Z(e,t,n={epsilon:.1}){const o=(0,$.T)(e);if(!o)return void console.warn(`Invalid segmentation given ${e}`);if(!o.representationData.Contour)return void console.warn(`No contour representation found for segmentation ${e}`);const i=B(e);if(!i)return void console.warn("No viewport associated to the segmentation found");const a=K(e,t);if(!a)return void console.warn(`Error extracting contour data from segment ${t} in segmentation ${e}`);const s=Array.from(a?.keys());for(const e of s){const t=(0,F.getAnnotation)(e);if(!t)continue;const o=a.get(e),s=(0,j.A)(o,n.epsilon),r=H(i,t);r&&(t.data.contour.polyline=s.map(e=>r.canvasToWorld(e)),(0,F.invalidateAnnotation)(t))}}function Y(e){e&&(e.parentAnnotationUID&&(0,F.clearParentAnnotation)(e),(0,F.removeAnnotation)(e.annotationUID),(0,z.removeContourSegmentationAnnotation)(e))}var J=n(6936);n(44049);function X(e,t){const n=(0,$.T)(e);if(!n)return void console.warn(`Invalid segmentation given ${e}`);if(!n.representationData.Contour)return void console.warn(`No contour representation found for segmentation ${e}`);const o=K(e,t);if(!o)return void console.warn(`Error extracting contour data from segment ${t} in segmentation ${e}`);const i=Array.from(o?.keys()),a=i.map(e=>o.get(e)),s=(0,J.findContourHoles)(a);s?.length>0&&s.forEach(e=>{e.holeIndexes.forEach(e=>{Y((0,F.getAnnotation)(i[e]))})})}var Q=n(76617);function ee(e,t,n={threshold:3}){const o=(0,$.T)(e);if(!o)return void console.warn(`Invalid segmentation given ${e}`);if(!o.representationData.Contour)return void console.warn(`No contour representation found for segmentation ${e}`);const i=K(e,t);if(!i)return void console.warn(`Error extracting contour data from segment ${t} in segmentation ${e}`);const a=Array.from(i?.keys()),s=a.map(e=>i.get(e)),r=(0,Q.A)(s,n.threshold);r?.length>0&&r.forEach(e=>{Y((0,F.getAnnotation)(a[e]))})}var te=n(61768);function ne(e,t,n={knotsRatioPercentage:30}){const o=(0,$.T)(e);if(!o)return void console.warn(`Invalid segmentation given ${e}`);if(!o.representationData.Contour)return void console.warn(`No contour representation found for segmentation ${e}`);const i=o.representationData.Contour,{annotationUIDsMap:a}=i;if(!a)return void console.warn(`No contours found for segmentation ${e}`);if(!a.has(t))return void console.warn(`Error extracting contour data from segment ${t} in segmentation ${e}`);a.get(t).forEach(e=>{const t=(0,F.getAnnotation)(e);if(!t)return;const o=t.data.contour.polyline;if(!o||o.length<3)return;const i=(0,te.A)(o,0,o.length-1,n.knotsRatioPercentage);t.data.contour.polyline=i})}var oe=n(6273),ie=n(6994);function ae(e,t){const n=(0,$.T)(e);if(!n.representationData.Labelmap)throw new Error("Invalid segmentation type, only labelmap is supported right now");{const{representationData:o}=n,i=o.Labelmap;if("imageIds"in i||"volumeId"in i){("imageIds"in i?i.imageIds.map(e=>N.cache.getImage(e)):[N.cache.getVolume(i.volumeId)]).forEach(e=>{if(!e)return;const{voxelManager:n}=e;n.forEach(({value:e,index:o})=>{e===t&&n.setAtIndex(o,0)})})}(0,g.triggerSegmentationDataModified)(e)}}var se=n(93690),re=n(60740);function le(e,t,n={setNextSegmentAsActive:!0}){ae(e,t);const o=(0,re.Q)(e)===t,i=(0,$.T)(e),{segments:a}=i;delete a[t];const s={...a};if(u([{segmentationId:e,payload:{segments:s}}]),o&&n.setNextSegmentAsActive){const n=Object.keys(a).map(Number).sort((e,t)=>e-t),o=n.indexOf(t),i=n[o+1],s=n[o-1];void 0!==i?(0,O.setActiveSegmentIndex)(e,i):void 0!==s&&(0,O.setActiveSegmentIndex)(e,s)}(0,V.P)(e).forEach(n=>{(0,E.r$)(n,{segmentationId:e}).forEach(e=>{delete e.segments[t]})})}function de(e){const t=h._6,n=(0,$.T)(e);return t.getLabelmapImageIds(n.representationData)}var ce=n(99522),he=n(63427),ge=n(97577),ue=n(67165);const me={clearSegmentValue:ae,convertStackToVolumeLabelmap:oe.p,computeVolumeLabelmapFromStack:ie.a,convertVolumeToStackLabelmap:se.f}},55894:(e,t,n)=>{"use strict";n.d(t,{U:()=>d});var o=n(93952),i=n(58640),a=n(99737),s=n(49906),r=n(4714),l=n(59475);function d(e,t){const{segmentationId:n,config:o}=t,r={colorLUTIndex:c(o),...o};l._6.addSegmentationRepresentation(e,n,t.type,r),t.type===a.SegmentationRepresentations.Contour&&(0,i.t)([e]),(0,s.triggerSegmentationModified)(n)}function c(e){const{colorLUTOrIndex:t}=e||{};if(void 0===t){return(0,r.u)(JSON.parse(JSON.stringify(o.A)))}if("number"==typeof t)return t;if(Array.isArray(t)&&t.every(e=>Array.isArray(e)&&4===e.length)){return(0,r.u)(t)}return(0,r.u)(JSON.parse(JSON.stringify(o.A)))}},63427:(e,t,n)=>{"use strict";n.d(t,{j:()=>r,z:()=>s});var o=n(59475),i=n(49906),a=n(53662);function s(e){const t=o._6;t.getAllViewportSegmentationRepresentations().filter(({representations:t})=>t.some(t=>t.segmentationId===e)).map(({viewportId:e})=>e).forEach(t=>{(0,a.nc)(t,{segmentationId:e})}),t.removeSegmentation(e),(0,i.triggerSegmentationRemoved)(e)}function r(){const e=o._6;e.getState().segmentations.map(e=>e.segmentationId).forEach(e=>{s(e)}),e.resetState()}},53662:(e,t,n)=>{"use strict";n.d(t,{us:()=>u,OE:()=>v,kN:()=>m,E8:()=>c,nc:()=>h,JC:()=>p});var o=n(18682),i=n(684),a=n(25894),s=n(93210),r=n(15327),l=n(59475),d=n(67014);function c(e,t,n){return g(e,t,n)}function h(e,t,n){return g(e,t,n)}function g(e,t,n){const{segmentationId:c,type:h}=t;return function(e,t,n,l){const c=(0,s.r$)(e,{segmentationId:t,type:n});c.forEach(t=>{t.type===o.A.Labelmap?i.Ay.removeRepresentation(e,t.segmentationId,l):t.type===o.A.Contour?a.A.removeRepresentation(e,t.segmentationId,l):t.type===o.A.Surface&&d.Ay.removeRepresentation(e,t.segmentationId,l)});const{viewport:h}=(0,r.getEnabledElementByViewportId)(e)||{};h&&h.render()}(e,c,h,n),l._6.removeSegmentationRepresentations(e,{segmentationId:c,type:h})}function u(){l._6.getAllViewportSegmentationRepresentations().forEach(({viewportId:e,representations:t})=>{t.forEach(({segmentationId:t,type:n})=>{c(e,{segmentationId:t,type:n})})}),l._6.resetState()}function m(e,t,n){c(e,{segmentationId:t,type:o.A.Labelmap},n)}function v(e,t,n){c(e,{segmentationId:t,type:o.A.Contour},n)}function p(e,t,n){c(e,{segmentationId:t,type:o.A.Surface},n)}},70930:(e,t,n)=>{"use strict";n.r(t),n.d(t,{getActiveSegmentIndex:()=>l.Q,setActiveSegmentIndex:()=>c});var o=n(77609),i=n(35706),a=n(33283),s=n(58859),r=n(49906),l=n(60740),d=n(93210);function c(e,t){const n=(0,a.T)(e);"string"==typeof t&&(console.warn("segmentIndex is a string, converting to number"),t=Number(t)),Object.values(n.segments).forEach(e=>{e.active=!1}),n.segments[t]||(n.segments[t]={segmentIndex:t,label:"",locked:!1,cachedStats:{},active:!1}),!0!==n.segments[t].active&&(n.segments[t].active=!0,(0,r.triggerSegmentationModified)(e));const l=(0,s.P)(e);l.forEach(n=>{(0,d.r$)(n,{segmentationId:e}).forEach(e=>{e.segments[t]||(e.segments[t]={visible:!0})})}),l.forEach(e=>{const t=(0,o.getToolGroupForViewport)(e);(0,i.E)(t.id)})}},26795:(e,t,n)=>{"use strict";n.r(t),n.d(t,{getLockedSegmentIndices:()=>r,isSegmentIndexLocked:()=>a,setSegmentIndexLocked:()=>s});var o=n(33283),i=n(49906);function a(e,t){const n=(0,o.T)(e);if(!n)throw new Error(`No segmentation state found for ${e}`);const{segments:i}=n;return i[t].locked}function s(e,t,n=!0){const a=(0,o.T)(e);if(!a)throw new Error(`No segmentation state found for ${e}`);const{segments:s}=a;s[t].locked=n,(0,i.triggerSegmentationModified)(e)}function r(e){const t=(0,o.T)(e);if(!t)throw new Error(`No segmentation state found for ${e}`);const{segments:n}=t;return Object.keys(n).filter(e=>n[e].locked).map(e=>parseInt(e))}},98870:(e,t,n)=>{"use strict";n.r(t),n.d(t,{addColorLUT:()=>l.u,addSegmentations:()=>a.d,destroy:()=>w,getColorLUT:()=>d.B,getCurrentLabelmapImageIdForViewport:()=>v.vl,getCurrentLabelmapImageIdsForViewport:()=>v.aF,getNextColorLUTIndex:()=>c.u,getSegmentation:()=>o.T,getSegmentationRepresentation:()=>E.Ut,getSegmentationRepresentations:()=>E.r$,getSegmentationRepresentationsBySegmentationId:()=>E.ny,getSegmentations:()=>i.K,getStackSegmentationImageIdsForViewport:()=>f,getViewportIdsWithSegmentation:()=>m.P,getViewportSegmentationRepresentations:()=>u.z,getViewportSegmentations:()=>u.a,removeAllSegmentationRepresentations:()=>r.us,removeAllSegmentations:()=>s.j,removeColorLUT:()=>g,removeContourRepresentation:()=>r.OE,removeLabelmapRepresentation:()=>r.kN,removeSegmentation:()=>s.z,removeSegmentationRepresentation:()=>r.E8,removeSurfaceRepresentation:()=>r.JC,updateLabelmapSegmentationImageReferences:()=>p.t});var o=n(33283),i=n(70758),a=n(30935),s=n(63427),r=n(53662),l=n(4714),d=n(50409),c=n(70906),h=n(59475);function g(e){h._6.removeColorLUT(e)}var u=n(42568),m=n(58859),v=n(97577),p=n(78231);function f(e,t){return h._6.getStackSegmentationImageIdsForViewport(e,t)}var E=n(93210);function w(){h._6.resetState()}},49906:(e,t,n)=>{"use strict";n.r(t),n.d(t,{triggerSegmentationDataModified:()=>o.Q,triggerSegmentationModified:()=>i.G,triggerSegmentationRemoved:()=>a.B,triggerSegmentationRepresentationModified:()=>s.r,triggerSegmentationRepresentationRemoved:()=>r.O});var o=n(98798),i=n(9726),a=n(1485),s=n(44951),r=n(65290)},78231:(e,t,n)=>{"use strict";n.d(t,{t:()=>i});var o=n(59475);function i(e,t){return o._6.updateLabelmapSegmentationImageReferences(e,t)}},50749:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(15327);function i(e,t){return e.findIndex(e=>t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId)}function a(e,t){return e.some(e=>e.renderingEngineId===t.renderingEngineId&&e.viewportId===t.viewportId)}const s=class{constructor(e,t,n,i){this._viewportOptions={},this._onEvent=e=>{if(!0===this._ignoreFiredEvents)return;if(!this._targetViewports.length)return;const t="element"===this._eventSource?(0,o.getEnabledElement)(e.currentTarget):(0,o.getEnabledElementByViewportId)(e.detail?.viewportId);if(!t)return;const{renderingEngineId:n,viewportId:i}=t;this._sourceViewports.find(e=>e.viewportId===i)&&this.fireEvent({renderingEngineId:n,viewportId:i},e)},this._enabled=!0,this._eventName=t,this._eventHandler=n,this._ignoreFiredEvents=!1,this._sourceViewports=[],this._targetViewports=[],this._options=i||{},this._eventSource=this._options.eventSource||"element",this._auxiliaryEvents=this._options.auxiliaryEvents||[],this.id=e}isDisabled(){return!this._enabled||!this._hasSourceElements()}setOptions(e,t={}){this._viewportOptions[e]=t}setEnabled(e){this._enabled=e}getOptions(e){return this._viewportOptions[e]}add(e){this.addTarget(e),this.addSource(e)}addSource(e){if(a(this._sourceViewports,e))return;const{renderingEngineId:t,viewportId:n}=e,i=(0,o.getRenderingEngine)(t).getViewport(n);if(!i)return void console.warn(`Synchronizer.addSource: No viewport for ${t} ${n}`);("element"===this._eventSource?i.element:o.eventTarget).addEventListener(this._eventName,this._onEvent.bind(this)),this._auxiliaryEvents.forEach(({name:e,source:t})=>{("element"===t?i.element:o.eventTarget).addEventListener(e,this._onEvent.bind(this))}),this._updateDisableHandlers(),this._sourceViewports.push(e)}addTarget(e){a(this._targetViewports,e)||(this._targetViewports.push(e),this._updateDisableHandlers())}getSourceViewports(){return this._sourceViewports}getTargetViewports(){return this._targetViewports}destroy(){this._sourceViewports.forEach(e=>this.removeSource(e)),this._targetViewports.forEach(e=>this.removeTarget(e))}remove(e){this.removeTarget(e),this.removeSource(e)}removeSource(e){const t=i(this._sourceViewports,e);if(-1===t)return;const n="element"===this._eventSource?this.getViewportElement(e):o.eventTarget;this._sourceViewports.splice(t,1),n.removeEventListener(this._eventName,this._eventHandler),this._auxiliaryEvents.forEach(({name:t,source:n})=>{("element"===n?this.getViewportElement(e):o.eventTarget).removeEventListener(t,this._eventHandler)}),this._updateDisableHandlers()}removeTarget(e){const t=i(this._targetViewports,e);-1!==t&&(this._targetViewports.splice(t,1),this._updateDisableHandlers())}hasSourceViewport(e,t){return a(this._sourceViewports,{renderingEngineId:e,viewportId:t})}hasTargetViewport(e,t){return a(this._targetViewports,{renderingEngineId:e,viewportId:t})}fireEvent(e,t){if(this.isDisabled()||this._ignoreFiredEvents)return;this._ignoreFiredEvents=!0;const n=[];try{for(let o=0;o<this._targetViewports.length;o++){const i=this._targetViewports[o];if(e.viewportId===i.viewportId)continue;const a=this._eventHandler(this,e,i,t,this._options);a instanceof Promise&&n.push(a)}}catch(e){console.warn(`Synchronizer, for: ${this._eventName}`,e)}finally{n.length?Promise.allSettled(n).then(()=>{this._ignoreFiredEvents=!1}):this._ignoreFiredEvents=!1}}_hasSourceElements(){return 0!==this._sourceViewports.length}_updateDisableHandlers(){const e=function(e,t){const n=[],o=e.concat(t);for(let e=0;e<o.length;e++){const t=o[e];n.some(e=>t.renderingEngineId===e.renderingEngineId&&t.viewportId===e.viewportId)||n.push(t)}return n}(this._sourceViewports,this._targetViewports),t=this.remove.bind(this),n=e=>{t(e.detail.element)};e.forEach(e=>{const t=this.getEventSource(e);t&&(t.removeEventListener(o.Enums.Events.ELEMENT_DISABLED,n),t.addEventListener(o.Enums.Events.ELEMENT_DISABLED,n))})}getEventSource(e){return"element"===this._eventSource?this.getViewportElement(e):o.eventTarget}getViewportElement(e){const{renderingEngineId:t,viewportId:n}=e,i=(0,o.getRenderingEngine)(t);if(!i)return null;const a=i.getViewport(n);return a?a.element:null}}},36601:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var o=n(85204),i=n(50749);const a=function(e,t,n,a){if(o.wk.synchronizers.some(t=>t.id===e))throw new Error(`Synchronizer with id '${e}' already exists.`);const s=new i.A(e,t,n,a);return o.wk.synchronizers.push(s),s}},13239:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(85204);const i=function(){for(;o.wk.synchronizers.length>0;){o.wk.synchronizers.pop().destroy()}}},71395:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(85204);const i=function(e){const t=o.wk.synchronizers.findIndex(t=>t.id===e);if(t>-1){o.wk.synchronizers[t].destroy(),o.wk.synchronizers.splice(t,1)}}},92569:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(85204);const i=function(){return o.wk.synchronizers}},70321:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(85204);const i=function(e){return o.wk.synchronizers.find(t=>t.id===e)}},27851:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(85204);const i=function(e,t){const n=[];if(!t&&!e)throw new Error("At least one of renderingEngineId or viewportId should be given");for(let i=0;i<o.wk.synchronizers.length;i++){const a=o.wk.synchronizers[i],s=!a.isDisabled(),r=a.hasSourceViewport(t,e),l=a.hasTargetViewport(t,e);s&&(r||l)&&n.push(a)}return n}},70741:(e,t,n)=>{"use strict";n.r(t),n.d(t,{createSynchronizer:()=>o.A,destroy:()=>i.A,destroySynchronizer:()=>l.A,getAllSynchronizers:()=>r.A,getSynchronizer:()=>s.A,getSynchronizersForViewport:()=>a.A});var o=n(36601),i=n(13239),a=n(27851),s=n(70321),r=n(92569),l=n(71395)},77609:(e,t,n)=>{"use strict";n.r(t),n.d(t,{createToolGroup:()=>E,destroy:()=>I,destroyToolGroup:()=>w,getAllToolGroups:()=>T,getToolGroup:()=>c,getToolGroupForViewport:()=>C.A,getToolGroupsWithToolName:()=>b.A});var o=n(85204),i=n(99737),a=n(93008),s=n.n(a),r=n(15327),l=n(79475),d=n(7001);const c=function(e){return o.wk.toolGroups.find(t=>t.id===e)},{Active:h,Passive:g,Enabled:u,Disabled:m}=i.ToolModes,v=[{mouseButton:i.MouseBindings.Primary}];class p{constructor(e){this.viewportsInfo=[],this.toolOptions={},this.currentActivePrimaryToolName=null,this.prevActivePrimaryToolName=null,this.restoreToolOptions={},this._toolInstances={},this.id=e}getViewportIds(){return this.viewportsInfo.map(({viewportId:e})=>e)}getViewportsInfo(){return this.viewportsInfo.slice()}getToolInstance(e){const t=this._toolInstances[e];if(t)return t;console.warn(`'${e}' is not registered with this toolGroup (${this.id}).`)}getToolInstances(){return this._toolInstances}hasTool(e){return!!this._toolInstances[e]}addTool(e,t={}){const n=o.wk.tools[e],i=void 0!==e&&""!==e,a=this.toolOptions[e];if(!i)return void console.warn("Tool with configuration did not produce a toolName: ",t);if(!n)return void console.warn(`'${e}' is not registered with the library. You need to use cornerstoneTools.addTool to register it.`);if(a)return void console.warn(`'${e}' is already registered for ToolGroup ${this.id}.`);const{toolClass:s}=n,r=new s({name:e,toolGroupId:this.id,configuration:t});this._toolInstances[e]=r}addToolInstance(e,t,n={}){let i=o.wk.tools[e]?.toolClass;if(!i){const n=o.wk.tools[t].toolClass;class a extends n{}a.toolName=e,i=a,o.wk.tools[e]={toolClass:a}}this.addTool(i.toolName,n)}addViewport(e,t){if("string"!=typeof e)throw new Error("viewportId must be defined and be a string");const n=this._findRenderingEngine(e,t);this.viewportsInfo.some(({viewportId:t})=>t===e)||this.viewportsInfo.push({viewportId:e,renderingEngineId:n});const o=this.getActivePrimaryMouseButtonTool();r.Settings.getRuntimeSettings().get("useCursors")&&this.setViewportsCursorByToolName(o);const a={toolGroupId:this.id,viewportId:e,renderingEngineId:n};(0,r.triggerEvent)(r.eventTarget,i.Events.TOOLGROUP_VIEWPORT_ADDED,a)}removeViewports(e,t){const n=[];if(this.viewportsInfo.forEach((o,i)=>{let a=!1;o.renderingEngineId===e&&(a=!0,t&&o.viewportId!==t&&(a=!1)),a&&n.push(i)}),n.length)for(let e=n.length-1;e>=0;e--)this.viewportsInfo.splice(n[e],1);const o={toolGroupId:this.id,viewportId:t,renderingEngineId:e};(0,r.triggerEvent)(r.eventTarget,i.Events.TOOLGROUP_VIEWPORT_REMOVED,o)}setActiveStrategy(e,t){const n=this._toolInstances[e];void 0!==n?n.setActiveStrategy(t):console.warn(`Tool ${e} not added to toolGroup, can't set tool configuration.`)}setToolMode(e,t,n={}){e?t!==i.ToolModes.Active?t!==i.ToolModes.Passive?t!==i.ToolModes.Enabled?t!==i.ToolModes.Disabled?console.warn("setToolMode: mode must be defined"):this.setToolDisabled(e):this.setToolEnabled(e):this.setToolPassive(e):this.setToolActive(e,n||this.restoreToolOptions[e]):console.warn("setToolMode: toolName must be defined")}setToolActive(e,t={}){const n=this._toolInstances[e];if(void 0===n)return void console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);if(!n)return void console.warn(`'${e}' instance ${n} is not registered with this toolGroup, can't set tool mode.`);const o={bindings:[...this.toolOptions[e]?this.toolOptions[e].bindings:[],...t.bindings?t.bindings:[]].reduce((e,t)=>{const n=void 0!==t.numTouchPoints,o=void 0!==t.mouseButton;return e.some(e=>f(e,t))||!n&&!o||e.push(t),e},[]),mode:h};this.toolOptions[e]=o,this._toolInstances[e].mode=h;const a=r.Settings.getRuntimeSettings().get("useCursors");if(this._hasMousePrimaryButtonBinding(t)&&a)this.setViewportsCursorByToolName(e);else{if(!this.getActivePrimaryMouseButtonTool()&&a){const e=l.MouseCursor.getDefinedCursor("default");this._setCursorForViewports(e)}}this._hasMousePrimaryButtonBinding(t)&&(null===this.prevActivePrimaryToolName?this.prevActivePrimaryToolName=e:this.prevActivePrimaryToolName=this.currentActivePrimaryToolName,this.currentActivePrimaryToolName=e),"function"==typeof n.onSetToolActive&&n.onSetToolActive(),this._renderViewports();const s={toolGroupId:this.id,toolName:e,toolBindingsOptions:t};(0,r.triggerEvent)(r.eventTarget,i.Events.TOOL_ACTIVATED,s),this._triggerToolModeChangedEvent(e,h,t)}setToolPassive(e,t){const n=this._toolInstances[e];if(void 0===n)return void console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);const o=this.getToolOptions(e),i=Object.assign({bindings:o?o.bindings:[]},o,{mode:g}),a=Array.isArray(t?.removeAllBindings)?t.removeAllBindings:this.getDefaultPrimaryBindings();i.bindings=i.bindings.filter(e=>!0!==t?.removeAllBindings&&!a.some(t=>f(e,t)));let s=g;0!==i.bindings.length&&(s=h,i.mode=s),this.toolOptions[e]=i,n.mode=s,"function"==typeof n.onSetToolPassive&&n.onSetToolPassive(),this._renderViewports(),this._triggerToolModeChangedEvent(e,g)}setToolEnabled(e){const t=this._toolInstances[e];if(void 0===t)return void console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);const n={bindings:[],mode:u};this.toolOptions[e]=n,t.mode=u,"function"==typeof t.onSetToolEnabled&&t.onSetToolEnabled(),this._renderViewports(),this._triggerToolModeChangedEvent(e,u)}setToolDisabled(e){const t=this._toolInstances[e];if(void 0===t)return void console.warn(`Tool ${e} not added to toolGroup, can't set tool mode.`);const n={bindings:[],mode:m};this.restoreToolOptions[e]=this.toolOptions[e],this.toolOptions[e]=n,t.mode=m,"function"==typeof t.onSetToolDisabled&&t.onSetToolDisabled(),this._renderViewports(),this._triggerToolModeChangedEvent(e,m)}getToolOptions(e){const t=this.toolOptions[e];if(void 0!==t)return t}getActivePrimaryMouseButtonTool(){return Object.keys(this.toolOptions).find(e=>{const t=this.toolOptions[e];return t.mode===h&&this._hasMousePrimaryButtonBinding(t)})}setViewportsCursorByToolName(e,t){const n=this._getCursor(e,t);this._setCursorForViewports(n)}_getCursor(e,t){let n,o;return t&&(n=`${e}.${t}`,o=l.SVGMouseCursor.getDefinedCursor(n,!0),o)?o:(n=`${e}`,o=l.SVGMouseCursor.getDefinedCursor(n,!0),o||(n=e,o=l.SVGMouseCursor.getDefinedCursor(n,!0),o||l.MouseCursor.getDefinedCursor("default")))}_setCursorForViewports(e){this.viewportsInfo.forEach(({renderingEngineId:t,viewportId:n})=>{const o=(0,r.getEnabledElementByIds)(n,t);if(!o)return;const{viewport:i}=o;(0,d.initElementCursor)(i.element,e)})}setToolConfiguration(e,t,n){const o=this._toolInstances[e];if(void 0===o)return console.warn(`Tool ${e} not present, can't set tool configuration.`),!1;let i;return i=n?t:Object.assign(o.configuration,t),o.configuration=i,"function"==typeof o.onSetToolConfiguration&&o.onSetToolConfiguration(),this._renderViewports(),!0}getDefaultMousePrimary(){return i.MouseBindings.Primary}getDefaultPrimaryBindings(){return v}getToolConfiguration(e,t){if(void 0===this._toolInstances[e])return void console.warn(`Tool ${e} not present, can't set tool configuration.`);const n=s()(this._toolInstances[e].configuration,t)||this._toolInstances[e].configuration;return r.utilities.deepClone(n)}getPrevActivePrimaryToolName(){return this.prevActivePrimaryToolName}setActivePrimaryTool(e){const t=this.getCurrentActivePrimaryToolName();this.setToolDisabled(t),this.setToolActive(e,{bindings:[{mouseButton:i.MouseBindings.Primary}]})}getCurrentActivePrimaryToolName(){return this.currentActivePrimaryToolName}clone(e,t=null){let n=c(e);return n?(console.debug(`ToolGroup ${e} already exists`),n):(n=new p(e),o.wk.toolGroups.push(n),t=t??(()=>!0),Object.keys(this._toolInstances).filter(t).forEach(e=>{const t=this._toolInstances[e],o=this.toolOptions[e],i=t.mode;n.addTool(e),n.setToolMode(e,i,{bindings:o.bindings??[]})}),n)}_hasMousePrimaryButtonBinding(e){const t=this.getDefaultPrimaryBindings();return e?.bindings?.some(e=>t.some(t=>f(e,t)))}_renderViewports(){this.viewportsInfo.forEach(({renderingEngineId:e,viewportId:t})=>{(0,r.getRenderingEngine)(e).renderViewport(t)})}_triggerToolModeChangedEvent(e,t,n){const o={toolGroupId:this.id,toolName:e,mode:t,toolBindingsOptions:n};(0,r.triggerEvent)(r.eventTarget,i.Events.TOOL_MODE_CHANGED,o)}_findRenderingEngine(e,t){const n=(0,r.getRenderingEngines)();if(0===n?.length)throw new Error("No rendering engines found.");if(t)return t;const o=n.filter(t=>t.getViewport(e));if(0===o.length){if(1===n.length)return n[0].id;throw new Error("No rendering engines found that contain the viewport with the same viewportId, you must specify a renderingEngineId.")}if(o.length>1)throw new Error("Multiple rendering engines found that contain the viewport with the same viewportId, you must specify a renderingEngineId.");return o[0].id}}function f(e,t){return e.mouseButton===t.mouseButton&&(e.numTouchPoints===t.numTouchPoints&&e.modifierKey===t.modifierKey)}const E=function(e){if(o.wk.toolGroups.some(t=>t.id===e))return void console.warn(`'${e}' already exists.`);const t=new p(e);return o.wk.toolGroups.push(t),t};const w=function(e){const t=o.wk.toolGroups.findIndex(t=>t.id===e);t>-1&&o.wk.toolGroups.splice(t,1)};const I=function(){const e=[...o.wk.toolGroups];for(const t of e)w(t.id);o.wk.toolGroups=[]};var C=n(65136);const T=function(){return o.wk.toolGroups};var b=n(88029)},17221:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var o=n(21418),i=n(3406),a=n(85204),s=n(39011);function r(e){const{element:t,viewportId:n}=e.detail,r=function(e){const t="http://www.w3.org/2000/svg",n=document.createElementNS(t,"svg"),o=`svg-layer-${e}`;n.classList.add("svg-layer"),n.setAttribute("id",o),n.setAttribute("xmlns","http://www.w3.org/2000/svg"),n.style.width="100%",n.style.height="100%",n.style.pointerEvents="none",n.style.position="absolute";const i=document.createElementNS(t,"defs"),a=document.createElementNS(t,"filter"),s=document.createElementNS(t,"feOffset"),r=document.createElementNS(t,"feColorMatrix"),l=document.createElementNS(t,"feBlend");return a.setAttribute("id",`shadow-${o}`),a.setAttribute("filterUnits","userSpaceOnUse"),s.setAttribute("result","offOut"),s.setAttribute("in","SourceGraphic"),s.setAttribute("dx","0.5"),s.setAttribute("dy","0.5"),r.setAttribute("result","matrixOut"),r.setAttribute("in","offOut"),r.setAttribute("in2","matrix"),r.setAttribute("values","0.2 0 0 0 0 0 0.2 0 0 0 0 0 0.2 0 0 0 0 0 1 0"),l.setAttribute("in","SourceGraphic"),l.setAttribute("in2","matrixOut"),l.setAttribute("mode","normal"),a.appendChild(s),a.appendChild(r),a.appendChild(l),i.appendChild(a),n.appendChild(i),n}(n);var l;!function(e){const{viewportUid:t,renderingEngineUid:n}=e.dataset,o=`${t}:${n}`;a.wk.svgNodeCache[o]={}}(t),l=r,t.querySelector("div.viewport-element").appendChild(l),s.o.addViewportElement(n,t),o.bH.enable(t),o.CG.enable(t),o.F_.enable(t),o.kt.enable(t),o._9.enable(t),i.In.enable(t),i.aB.enable(t),i.z5.enable(t),i.we.enable(t),i.n6.enable(t),i.V$.enable(t),i.$m.enable(t),a.wk.enabledElements.push(t)}},68040:(e,t,n)=>{"use strict";n.d(t,{Bl:()=>r,Gx:()=>i,J2:()=>a,l$:()=>s});var o=n(85204);function i(e){const t=e.toolName;if(!t)throw new Error(`No Tool Found for the ToolClass ${e.name}`);o.wk.tools[t]||(o.wk.tools[t]={toolClass:e})}function a(e){const t=e.toolName;return!(!t||!o.wk.tools[t])}function s(e){return!(!e||!o.wk.tools[e])}function r(e){const t=e.toolName;if(!t)throw new Error(`No tool found for: ${e.name}`);if(void 0===!o.wk.tools[t])throw new Error(`${t} cannot be removed because it has not been added`);delete o.wk.tools[t]}},91243:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(99737),i=n(39848),a=n(57725);function s(e){const t=(0,i.A)(e,[o.ToolModes.Active,o.ToolModes.Passive]),n=(0,a.A)(e,t);for(const{tool:t}of n){const n=t.cancel(e);if(n)return n}}},6657:(e,t,n)=>{"use strict";n.r(t),n.d(t,{Synchronizer:()=>l.A,SynchronizerManager:()=>h,ToolGroupManager:()=>c,addEnabledElement:()=>i.A,addTool:()=>o.Gx,cancelActiveManipulations:()=>s.A,hasTool:()=>o.J2,removeEnabledElement:()=>a.A,removeTool:()=>o.Bl,state:()=>r.Ay,svgNodeCache:()=>d.A});var o=n(68040),i=n(17221),a=n(34222),s=n(91243),r=n(85204),l=n(50749),d=n(48145),c=n(77609),h=n(70741)},34222:(e,t,n)=>{"use strict";n.d(t,{A:()=>m});var o=n(15327),i=n(21418),a=n(3406),s=(n(57725),n(85204)),r=(n(39848),n(99737),n(6802),n(27851)),l=n(65136),d=n(39011);const c="viewport-element";const h=e=>{const t=(0,o.getEnabledElement)(e);if(!t)return;(0,r.A)(t.viewportId,t.renderingEngineId).forEach(e=>{e.remove(t)})},g=e=>{const t=(0,o.getEnabledElement)(e);if(!t)return;const{renderingEngineId:n,viewportId:i}=t,a=(0,l.A)(i,n);a&&a.removeViewports(n,i)};const u=function(e){const t=s.wk.enabledElements.findIndex(t=>t===e);t>-1&&s.wk.enabledElements.splice(t,1)},m=function(e){const{element:t,viewportId:n}=e.detail;!function(e){const{viewportUid:t,renderingEngineUid:n}=e.dataset,o=`${t}:${n}`;delete s.wk.svgNodeCache[o]}(t),function(e){const t=e.querySelector(`div.${c}`),n=t.querySelector("svg");n&&t.removeChild(n)}(t),d.o.removeViewportElement(n,t),i.bH.disable(t),i.CG.disable(t),i.F_.disable(t),i.kt.disable(t),i._9.disable(t),a.In.disable(t),a.aB.disable(t),a.z5.disable(t),a.we.disable(t),a.n6.disable(t),a.V$.disable(t),a.$m.disable(t),h(t),g(t),u(t)}},85204:(e,t,n)=>{"use strict";n.d(t,{Ay:()=>a,qh:()=>s,wk:()=>a});var o=n(48145);const i={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:o.A,enabledElements:[],handleRadius:6};let a={isInteractingWithTool:!1,isMultiPartToolActive:!1,tools:{},toolGroups:[],synchronizers:[],svgNodeCache:o.A,enabledElements:[],handleRadius:6};function s(){(0,o.e)(),a={...structuredClone({...i,svgNodeCache:{}}),svgNodeCache:{...i.svgNodeCache}}}},48145:(e,t,n)=>{"use strict";n.d(t,{A:()=>a,e:()=>i});let o={};function i(){o={}}const a=o},94195:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(3823);function i(e,t){const{viewPlaneNormal:n}=e.getCamera(),{viewPlaneNormal:i}=t.getCamera(),a=o.eR.dot(n,i);return Math.abs(a)>.9}},67831:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(15327);function i(e,t,n,i){const{camera:a}=i.detail,s=(0,o.getRenderingEngine)(n.renderingEngineId);if(!s)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const r=s.getViewport(n.viewportId);r.setCamera(a),r.render()}},69877:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var o=n(3823),i=n(15327),a=n(94195);const s=(e,t)=>i.utilities.spatialRegistrationMetadataProvider.get("spatialRegistrationModule",e,t);async function r(e,t,n){const r=(0,i.getRenderingEngine)(n.renderingEngineId);if(!r)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const l=r.getViewport(t.viewportId),d=e.getOptions(n.viewportId);if(d?.disabled)return;const c=r.getViewport(n.viewportId),h=l.getCurrentImageId(),g=i.metaData.get("imagePlaneModule",h).imagePositionPatient,u=c.getImageIds();if(!(0,a.A)(l,c))return;let m=s(n.viewportId,t.viewportId);if(!m){if(l.getFrameOfReferenceUID()===c.getFrameOfReferenceUID()&&!1!==d?.useInitialPosition?m=o.pB.identity(o.pB.create()):(i.utilities.calculateViewportsSpatialRegistration(l,c),m=s(n.viewportId,t.viewportId)),!m)return}const v=o.eR.transformMat4(o.eR.create(),g,m),p=(f=v,u.reduce((e,t,n)=>{const{imagePositionPatient:a}=i.metaData.get("imagePlaneModule",t),s=o.eR.distance(a,f);return s<e.distance?{distance:s,index:n}:e},{distance:1/0,index:-1}));var f;let E=p.index;c instanceof i.VolumeViewport&&(E=u.length-p.index-1),-1!==p.index&&c.getCurrentImageIdIndex()!==p.index&&await i.utilities.jumpToSlice(c.element,{imageIndex:E})}},56553:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(15327);function i(e,t,n,i,a){const s=(0,o.getRenderingEngine)(n.renderingEngineId);if(!s)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const r=s.getViewport(n.viewportId),l=s.getViewport(t.viewportId).getViewPresentation(a);r.setViewPresentation(l),r.render()}},9912:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(15327);function i(e,t,n){const i=(0,o.getRenderingEngine)(n.renderingEngineId);if(!i)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const a=i.getViewport(n.viewportId),s=i.getViewport(t.viewportId),r=s.getSlabThickness?.();r&&(a.setSlabThickness?.(r),a.render())}},14676:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(15327);function i(e,t,n,i,a){const s=i.detail,{volumeId:r,range:l,invertStateChanged:d,invert:c,colormap:h}=s,g=(0,o.getRenderingEngine)(n.renderingEngineId);if(!g)throw new Error(`Rendering Engine does not exist: ${n.renderingEngineId}`);const u=g.getViewport(n.viewportId),m={voiRange:l};if(a?.syncInvertState&&d&&(m.invert=c),a?.syncColormap&&h&&(m.colormap=h),u instanceof o.BaseVolumeViewport){u._actors&&u._actors.size>1?u.setProperties(m,r):u.setProperties(m)}else{if(!(u instanceof o.StackViewport))throw new Error("Viewport type not supported.");u.setProperties(m)}u.render()}},53308:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(15327);function i(e,t,n){const i=(0,o.getRenderingEngine)(n.renderingEngineId);if(!i)throw new Error(`No RenderingEngine for Id: ${n.renderingEngineId}`);const a=e.getOptions(n.viewportId),s=i.getViewport(n.viewportId),r=i.getViewport(t.viewportId);if(!1!==a?.syncZoom){const e=r.getZoom();s.setZoom(e)}if(!1!==a?.syncPan){const e=r.getPan();s.setPan(e)}s.render()}},34389:(e,t,n)=>{"use strict";n.r(t),n.d(t,{createCameraPositionSynchronizer:()=>o.A,createImageSliceSynchronizer:()=>r.A,createPresentationViewSynchronizer:()=>i.A,createSlabThicknessSynchronizer:()=>l.A,createStackImageSynchronizer:()=>d,createVOISynchronizer:()=>a.A,createZoomPanSynchronizer:()=>s.A});var o=n(90839),i=n(31130),a=n(32865),s=n(3889),r=n(76266),l=n(7137);const d=r.A},90839:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var o=n(70741),i=n(15327),a=n(67831);const{CAMERA_MODIFIED:s}=i.Enums.Events;function r(e){return(0,o.createSynchronizer)(e,s,a.A)}},76266:(e,t,n)=>{"use strict";n.d(t,{A:()=>l});var o=n(70741),i=n(15327),a=n(69877);const{STACK_NEW_IMAGE:s,VOLUME_NEW_IMAGE:r}=i.Enums.Events;function l(e){return(0,o.createSynchronizer)(e,s,a.A,{auxiliaryEvents:[{name:"VOLUME_NEW_IMAGE"}]})}},31130:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var o=n(15327),i=n(70741),a=n(56553);const{CAMERA_MODIFIED:s}=o.Enums.Events;function r(e,t){return(0,i.createSynchronizer)(e,s,a.A,{viewPresentation:t})}},7137:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var o=n(15327),i=n(70741),a=n(9912);const{CAMERA_MODIFIED:s}=o.Enums.Events;function r(e){return(0,i.createSynchronizer)(e,s,a.A)}},32865:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(70741),i=n(15327),a=n(14676);function s(e,t){t=Object.assign({syncInvertState:!0,syncColormap:!0},t);return(0,o.createSynchronizer)(e,i.Enums.Events.VOI_MODIFIED,a.A,{auxiliaryEvents:[{name:i.Enums.Events.COLORMAP_MODIFIED}],...t})}},3889:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var o=n(70741),i=n(15327),a=n(53308);const{CAMERA_MODIFIED:s}=i.Enums.Events;function r(e){return(0,o.createSynchronizer)(e,s,a.A)}},45152:(e,t,n)=>{"use strict";n.d(t,{A:()=>_});var o=n(85817),i=n(15327),a=n(82056),s=n(2076),r=n(29601),l=n(44049),d=n(74347),c=n(85204),h=n(99737),g=n(60810),u=n(7001),m=n(58640),v=n(77081),p=n(3823),f=n(77609),E=n(52905),w=n(82216),I=n(90713);const{Events:C}=i.Enums,T=e=>e.uid!==e.referencedId;var b;!function(e){e.ShowZoomFactorsList="showZoomFactorsList"}(b||(b={}));const A=1-i.CONSTANTS.EPSILON;class _ extends o.EC{static{this.Actions=b}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,magnifyingGlass:{radius:125,zoomFactor:3,zoomFactorList:[1.5,2,2.5,3,3.5,4,4.5,5],autoPan:{enabled:!0,padding:10}},actions:{showZoomFactorsList:{method:"showZoomFactorsList",bindings:[{mouseButton:h.MouseBindings.Secondary,modifierKey:h.KeyboardBindings.Shift}]}}}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,s=(0,i.getEnabledElement)(o),{viewport:r,renderingEngine:l}=s,d=n.world,c=n.canvas,{magnifyingGlass:h}=this.configuration,{radius:u,zoomFactor:v,autoPan:p}=h,f=this._getCanvasHandlePoints(c,u),E=r.getCamera(),{viewPlaneNormal:w,viewUp:I}=E,C=this.getReferencedImageId(r,d,w,I),T=i.utilities.uuidv4(),b=i.utilities.uuidv4(),A=r.getFrameOfReferenceUID(),_={annotationUID:T,highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...w],viewUp:[...I],FrameOfReferenceUID:A,referencedImageId:C},data:{sourceViewportId:r.id,magnifyViewportId:b,zoomFactor:v,isCanvasAnnotation:!0,handles:{points:f,activeHandleIndex:null}}};this.magnifyViewportManager.createViewport(_,{magnifyViewportId:b,sourceEnabledElement:s,position:c,radius:u,zoomFactor:v,autoPan:{enabled:p.enabled,padding:p.padding,callback:e=>{const t=_.data.handles.points,{canvas:n}=e.delta;for(let e=0,o=t.length;e<o;e++){const o=t[e];o[0]+=n[0],o[1]+=n[1],_.invalidated=!0}}}}),(0,a.addAnnotation)(_,o);const S=(0,g.getViewportIdsWithToolToRender)(o,this.getToolName());return e.preventDefault(),(0,m.A)(S),_},this.onSetToolDisabled=()=>{this.magnifyViewportManager.dispose();(0,a.getAllAnnotations)().forEach(e=>{e.metadata.toolName===this.getToolName()&&(0,a.removeAnnotation)(e.annotationUID)})},this.isPointNearTool=(e,t,n,o)=>{const{data:i}=t,{points:a}=i.handles,s=a,r=s[0],l=s[2],d=s[3],c=.5*Math.abs(l[1]-r[1]),h=[d[0]+c,r[1]+c],g=(0,v.getCanvasCircleRadius)([h,n]);return Math.abs(g-c)<2*o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=(0,g.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i},(0,u.hideElementCursor)(o),this._activateModify(o),(0,m.A)(i),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;const{points:s}=a.handles,r=s.findIndex(e=>e===n),l=(0,g.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:r},this._activateModify(i),(0,u.hideElementCursor)(i),(0,m.A)(l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a}=this.editData,{data:s}=o;s.handles.activeHandleIndex=null,this._deactivateModify(n),(0,u.resetElementCursor)(n),this.editData=null,this.isDrawing=!1,(0,m.A)(i),a&&(0,l.triggerAnnotationCompleted)(o)},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{deltaPoints:n}=t,o=n?.canvas??[0,0,0],{annotation:i,viewportIdsToRender:a}=this.editData,{points:s}=i.data.handles;s.forEach(e=>{e[0]+=o[0],e[1]+=o[1]}),i.invalidated=!0,this.editData.hasMoved=!0,(0,m.A)(a)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a}=this.editData,{data:s}=o;if(void 0===a){const{deltaPoints:e}=t,n=e.canvas;s.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1]}),o.invalidated=!0}else this._dragHandle(e),o.invalidated=!0;(0,m.A)(i)},this._dragHandle=e=>{const t=e.detail,{annotation:n}=this.editData,{data:o}=n,{points:i}=o.handles,a=i,s=a[0],r=a[2],l=a[3],d=.5*Math.abs(r[1]-s[1]),c=[l[0]+d,s[1]+d],{currentPoints:h}=t,g=h.canvas,u=(0,v.getCanvasCircleRadius)([c,g]),m=this._getCanvasHandlePoints(c,u);i[0]=m[0],i[1]=m[1],i[2]=m[2],i[3]=m[3]},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateModify(e),(0,u.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;return t.highlighted=!1,i.handles.activeHandleIndex=null,(0,m.A)(n),o&&(0,l.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID},this._activateModify=e=>{c.wk.isInteractingWithTool=!0,e.addEventListener(h.Events.MOUSE_UP,this._endCallback),e.addEventListener(h.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(h.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(h.Events.TOUCH_END,this._endCallback),e.addEventListener(h.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(h.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{c.wk.isInteractingWithTool=!1,e.removeEventListener(h.Events.MOUSE_UP,this._endCallback),e.removeEventListener(h.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(h.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(h.Events.TOUCH_END,this._endCallback),e.removeEventListener(h.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(h.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let l=(0,a.getAnnotations)(this.getToolName(),i);if(!l?.length)return n;l=l?.filter(e=>e.data.sourceViewportId===o.id);const c=this.filterInteractableAnnotationsForElement(i,l);if(!c?.length)return n;const h={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<c.length;e++){const i=c[e],{annotationUID:a,data:l}=i,{magnifyViewportId:g,zoomFactor:u,handles:m}=l,{points:v,activeHandleIndex:p}=m;h.annotationUID=a;this.getStyle("lineWidth",h,i),this.getStyle("lineDash",h,i);const f=this.getStyle("color",h,i),E=v,w=E[0],I=E[2],C=E[3],T=.5*Math.abs(I[1]-w[1]),b=[C[0]+T,w[1]+T];if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let A;if(!(0,r.isAnnotationVisible)(a))continue;if((0,s.isAnnotationLocked)(a)||this.editData||null===p||(A=[E[p]]),A){const e="0";(0,d.drawHandles)(t,a,e,A,{color:f})}const _=`${a}-advancedMagnify`,S="0";(0,d.drawCircle)(t,a,S,b,T,{color:f,lineWidth:5},_);const D=this.magnifyViewportManager.getViewport(g);D.position=b,D.radius=T,D.zoomFactor=u,D.update(),n=!0}return n},this._getCanvasHandlePoints=(e,t)=>[[e[0],e[1]-t,0],[e[0]+t,e[1],0],[e[0],e[1]+t,0],[e[0]-t,e[1],0]],this.magnifyViewportManager=S.getInstance()}showZoomFactorsList(e,t){const{element:n,currentPoints:o}=e.detail,a=(0,i.getEnabledElement)(n),{viewport:s}=a,{canvas:r}=o,l=n.querySelector(":scope .viewport-element"),d=t.data.zoomFactor,c=this._getZoomFactorsListDropdown(d,e=>{void 0!==e&&(t.data.zoomFactor=Number.parseFloat(e),t.invalidated=!0),c.parentElement.removeChild(c),s.render()});Object.assign(c.style,{left:`${r[0]}px`,top:`${r[1]}px`}),l.appendChild(c),c.focus()}_getZoomFactorsListDropdown(e,t){const{zoomFactorList:n}=this.configuration.magnifyingGlass,o=document.createElement("select");return o.size=5,Object.assign(o.style,{width:"50px",position:"absolute"}),["mousedown","mouseup","mousemove","click"].forEach(e=>{o.addEventListener(e,e=>e.stopPropagation())}),o.addEventListener("change",e=>{e.stopPropagation(),t(o.value)}),o.addEventListener("keydown",e=>{((e.keyCode??27===e.which)||"escape"===e.key?.toLowerCase())&&(e.stopPropagation(),t())}),n.forEach(t=>{const n=document.createElement("option");n.label=t,n.title=`Zoom factor ${t.toFixed(1)}`,n.value=t,n.defaultSelected=t===e,o.add(n)}),o}}class S{constructor(){this.createViewport=(e,t)=>{const{magnifyViewportId:n,sourceEnabledElement:o,position:i,radius:a,zoomFactor:s,autoPan:r}=t,{viewport:l}=o,{element:d}=l,c=new D({magnifyViewportId:n,sourceEnabledElement:o,radius:a,position:i,zoomFactor:s,autoPan:r});return this._addSourceElementEventListener(d),this._magnifyViewportsMap.set(c.viewportId,{annotation:e,magnifyViewport:c,magnifyViewportInfo:t}),c},this._annotationRemovedCallback=e=>{const{annotation:t}=e.detail;"AdvancedMagnify"===t.metadata.toolName&&this.destroyViewport(t.data.magnifyViewportId)},this._newStackImageCallback=e=>{const{viewportId:t,imageId:n}=e.detail,o=this._getMagnifyViewportsMapEntriesBySourceViewportId(t),{viewport:a}=(0,i.getEnabledElementByViewportId)(t);a.stackActorReInitialized&&this._reset(t),o.forEach(({annotation:e})=>{e.metadata.referencedImageId=n,e.invalidated=!0})},this._newVolumeImageCallback=e=>{const{renderingEngineId:t,viewportId:n}=e.detail,o=(0,i.getRenderingEngine)(t).getViewport(n),{viewPlaneNormal:a}=o.getCamera();this._getMagnifyViewportsMapEntriesBySourceViewportId(n).forEach(({annotation:e})=>{const{viewPlaneNormal:t}=e.metadata;if(!(Math.abs(p.eR.dot(t,a))>A))return;const{handles:n}=e.data,i=o.canvasToWorld([0,0]),s=p.eR.sub(p.eR.create(),i,n.points[0]),r=p.eR.dot(s,a),l=p.eR.scale(p.eR.create(),a,r);for(let e=0,t=n.points.length;e<t;e++){const t=n.points[e];t[0]+=l[0],t[1]+=l[1],t[2]+=l[2]}e.invalidated=!0})},this._magnifyViewportsMap=new Map,this._initialize()}static getInstance(){return S._singleton=S._singleton??new S,S._singleton}getViewport(e){return this._magnifyViewportsMap.get(e)?.magnifyViewport}dispose(){this._removeEventListeners(),this._destroyViewports()}destroyViewport(e){const t=this._magnifyViewportsMap.get(e);if(t){const{magnifyViewport:n}=t,{viewport:o}=n.sourceEnabledElement,{element:i}=o;this._removeSourceElementEventListener(i),n.dispose(),this._magnifyViewportsMap.delete(e)}}_destroyViewports(){Array.from(this._magnifyViewportsMap.keys()).forEach(e=>this.destroyViewport(e))}_getMagnifyViewportsMapEntriesBySourceViewportId(e){return Array.from(this._magnifyViewportsMap.values()).filter(({magnifyViewport:t})=>{const{viewport:n}=t.sourceEnabledElement;return n.id===e})}_reset(e){this._getMagnifyViewportsMapEntriesBySourceViewportId(e).forEach(({magnifyViewport:t,annotation:n,magnifyViewportInfo:o})=>{this.destroyViewport(t.viewportId);const a=(0,i.getEnabledElementByViewportId)(e);this.createViewport(n,{...o,sourceEnabledElement:{...a}})})}_addEventListeners(){i.eventTarget.addEventListener(h.Events.ANNOTATION_REMOVED,this._annotationRemovedCallback)}_removeEventListeners(){i.eventTarget.removeEventListener(h.Events.ANNOTATION_REMOVED,this._annotationRemovedCallback)}_addSourceElementEventListener(e){e.addEventListener(C.STACK_NEW_IMAGE,this._newStackImageCallback);const t=e=>{const{viewportId:t}=e.detail;this._reset(t)};e.addEventListener(C.VIEWPORT_NEW_IMAGE_SET,t);const n=e=>{const{viewportId:t}=e.detail;this._reset(t)};e.addEventListener(C.VOLUME_VIEWPORT_NEW_VOLUME,n),e.addEventListener(C.VOLUME_NEW_IMAGE,this._newVolumeImageCallback),e.newStackHandler=t,e.newVolumeHandler=n}_removeSourceElementEventListener(e){e.removeEventListener(C.STACK_NEW_IMAGE,this._newStackImageCallback),e.removeEventListener(C.VOLUME_NEW_IMAGE,this._newVolumeImageCallback),e.removeEventListener(C.VIEWPORT_NEW_IMAGE_SET,e.newStackHandler),e.removeEventListener(C.VOLUME_VIEWPORT_NEW_VOLUME,e.newVolumeHandler),delete e.newStackHandler,delete e.newVolumeHandler}_initialize(){this._addEventListeners()}}class D{constructor({magnifyViewportId:e,sourceEnabledElement:t,radius:n=125,position:o=[0,0],zoomFactor:a,autoPan:s}){this._enabledElement=null,this._sourceToolGroup=null,this._magnifyToolGroup=null,this._isViewportReady=!1,this._radius=0,this._resized=!1,this._canAutoPan=!1,this._viewportId=e??i.utilities.uuidv4(),this._sourceEnabledElement=t,this._autoPan=s,this.radius=n,this.position=o,this.zoomFactor=a,this.visible=!0,this._browserMouseDownCallback=this._browserMouseDownCallback.bind(this),this._browserMouseUpCallback=this._browserMouseUpCallback.bind(this),this._handleToolModeChanged=this._handleToolModeChanged.bind(this),this._mouseDragCallback=this._mouseDragCallback.bind(this),this._resizeViewportAsync=(0,E.A)(this._resizeViewport.bind(this),1),this._initialize()}get sourceEnabledElement(){return this._sourceEnabledElement}get viewportId(){return this._viewportId}get radius(){return this._radius}set radius(e){Math.abs(this._radius-e)>1e-5&&(this._radius=e,this._resized=!0)}update(){const{radius:e,position:t,visible:n}=this,{viewport:o}=this._enabledElement,{element:i}=o,a=2*e,[s,r]=t;this._resized&&(this._resizeViewportAsync(),this._resized=!1),Object.assign(i.style,{display:n?"block":"hidden",width:`${a}px`,height:`${a}px`,left:-e+"px",top:-e+"px",transform:`translate(${s}px, ${r}px)`}),this._isViewportReady&&(this._syncViewports(),o.render())}dispose(){const{viewport:e}=this._enabledElement,{element:t}=e,n=e.getRenderingEngine();this._removeEventListeners(t),n.disableElement(e.id),t.parentNode&&t.parentNode.removeChild(t)}_handleToolModeChanged(e){const{_magnifyToolGroup:t}=this,{toolGroupId:n,toolName:o,mode:i,toolBindingsOptions:a}=e.detail;if(this._sourceToolGroup?.id===n)switch(i){case h.ToolModes.Active:t.setToolActive(o,a);break;case h.ToolModes.Passive:t.setToolPassive(o);break;case h.ToolModes.Enabled:t.setToolEnabled(o);break;case h.ToolModes.Disabled:t.setToolDisabled(o);break;default:throw new Error(`Unknow tool mode (${i})`)}}_inheritBorderRadius(e){const t=e.querySelector(".viewport-element"),n=e.querySelector(".cornerstone-canvas");t.style.borderRadius="inherit",n.style.borderRadius="inherit"}_createViewportNode(){const e=document.createElement("div"),{radius:t}=this,n=2*t;return e.classList.add("advancedMagnifyTool"),Object.assign(e.style,{display:"block",width:`${n}px`,height:`${n}px`,position:"absolute",overflow:"hidden",borderRadius:"50%",boxSizing:"border-box",left:-t+"px",top:-t+"px",transform:"translate(-1000px, -1000px)"}),e}_convertZoomFactorToParallelScale(e,t,n){const{parallelScale:o}=e.getCamera();return o*(1/n)*(t.canvas.offsetWidth/e.canvas.offsetWidth)}_isStackViewport(e){return"setStack"in e}_isVolumeViewport(e){return"addVolumes"in e}_cloneToolGroups(e,t){const n=e.getActors(),i=`${t.id}-toolGroup`,a=(0,f.getToolGroupForViewport)(e.id,e.renderingEngineId),s=a.clone(i,e=>{const t=a.getToolInstance(e);return t instanceof o.EC&&!(t instanceof _)});return s.addViewport(t.id,t.renderingEngineId),n.filter(T).forEach(e=>{(0,I.addSegmentationRepresentations)(this.viewportId,[{segmentationId:e.referencedId,type:h.SegmentationRepresentations.Labelmap}])}),{sourceToolGroup:a,magnifyToolGroup:s}}_cloneStack(e,t){const n=e.getImageIds();t.setStack(n).then(()=>{this._isViewportReady=!0,this.update()})}_cloneVolumes(e,t){const n=e.getActors().filter(e=>!T(e)).map(e=>({volumeId:e.uid}));return t.setVolumes(n).then(()=>{this._isViewportReady=!0,this.update()}),t}_cloneViewport(e,t){const{viewportId:n}=this,o=e.getRenderingEngine(),{options:i}=e,a={element:t,viewportId:n,type:e.type,defaultOptions:{...i}};o.enableElement(a);const s=o.getViewport(n);this._isStackViewport(e)?this._cloneStack(e,s):this._isVolumeViewport(e)&&this._cloneVolumes(e,s),this._inheritBorderRadius(t);const r=this._cloneToolGroups(e,s);this._sourceToolGroup=r.sourceToolGroup,this._magnifyToolGroup=r.magnifyToolGroup}_cancelMouseEventCallback(e){e.stopPropagation(),e.preventDefault()}_browserMouseUpCallback(e){const{element:t}=this._enabledElement.viewport;document.removeEventListener("mouseup",this._browserMouseUpCallback),t.addEventListener("mouseup",this._cancelMouseEventCallback),t.addEventListener("mousemove",this._cancelMouseEventCallback)}_browserMouseDownCallback(e){const{element:t}=this._enabledElement.viewport;this._canAutoPan=!!e.target?.closest(".advancedMagnifyTool"),document.addEventListener("mouseup",this._browserMouseUpCallback),t.removeEventListener("mouseup",this._cancelMouseEventCallback),t.removeEventListener("mousemove",this._cancelMouseEventCallback)}_mouseDragCallback(e){if(!c.wk.isInteractingWithTool)return;const{_autoPan:t}=this;if(!t.enabled||!this._canAutoPan)return;const{currentPoints:n}=e.detail,{viewport:o}=this._enabledElement,{canvasToWorld:i}=o,{canvas:a}=n,{radius:s}=this,r=[s,s],l=(0,w.distanceToPoint)(r,a),d=s-t.padding;if(l<=d)return;const h=l-d,g=p.Zc.sub(p.Zc.create(),a,r);p.Zc.normalize(g,g),p.Zc.scale(g,g,h);const u=p.Zc.add(p.Zc.create(),this.position,g),m=i(this.position),v=i(u),f=p.eR.sub(p.eR.create(),v,m),E={points:{currentPosition:{canvas:this.position,world:m},newPosition:{canvas:u,world:v}},delta:{canvas:g,world:f}};t.callback(E)}_addBrowserEventListeners(e){document.addEventListener("mousedown",this._browserMouseDownCallback,!0),e.addEventListener("mousedown",this._cancelMouseEventCallback),e.addEventListener("mouseup",this._cancelMouseEventCallback),e.addEventListener("mousemove",this._cancelMouseEventCallback),e.addEventListener("dblclick",this._cancelMouseEventCallback)}_removeBrowserEventListeners(e){document.removeEventListener("mousedown",this._browserMouseDownCallback,!0),document.removeEventListener("mouseup",this._browserMouseUpCallback),e.removeEventListener("mousedown",this._cancelMouseEventCallback),e.removeEventListener("mouseup",this._cancelMouseEventCallback),e.removeEventListener("mousemove",this._cancelMouseEventCallback),e.removeEventListener("dblclick",this._cancelMouseEventCallback)}_addEventListeners(e){i.eventTarget.addEventListener(h.Events.TOOL_MODE_CHANGED,this._handleToolModeChanged),e.addEventListener(h.Events.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(h.Events.MOUSE_DRAG,this._mouseDragCallback),this._addBrowserEventListeners(e)}_removeEventListeners(e){i.eventTarget.removeEventListener(h.Events.TOOL_MODE_CHANGED,this._handleToolModeChanged),e.addEventListener(h.Events.MOUSE_MOVE,this._mouseDragCallback),e.addEventListener(h.Events.MOUSE_DRAG,this._mouseDragCallback),this._removeBrowserEventListeners(e)}_initialize(){const{_sourceEnabledElement:e}=this,{viewport:t}=e,{canvas:n}=t,o=this._createViewportNode();n.parentNode.appendChild(o),this._addEventListeners(o),this._cloneViewport(t,o),this._enabledElement=(0,i.getEnabledElement)(o)}_syncViewportsCameras(e,t){const n=e.canvasToWorld(this.position),o=this._convertZoomFactorToParallelScale(e,t,this.zoomFactor),{focalPoint:i,position:a,viewPlaneNormal:s}=t.getCamera(),r=Math.sqrt(Math.pow(i[0]-a[0],2)+Math.pow(i[1]-a[1],2)+Math.pow(i[2]-a[2],2)),l=[n[0],n[1],n[2]],d=[l[0]+r*s[0],l[1]+r*s[1],l[2]+r*s[2]];t.setCamera({parallelScale:o,focalPoint:l,position:d})}_syncStackViewports(e,t){t.setImageIdIndex(e.getCurrentImageIdIndex())}_syncViewports(){const{viewport:e}=this._sourceEnabledElement,{viewport:t}=this._enabledElement,n=e.getProperties();t.getImageData()&&(t.setProperties(n),this._syncViewportsCameras(e,t),this._isStackViewport(e)&&this._syncStackViewports(e,t),this._syncViewportsCameras(e,t),t.render())}_resizeViewport(){const{viewport:e}=this._enabledElement;e.getRenderingEngine().resize()}}_.toolName="AdvancedMagnify"},68760:(e,t,n)=>{"use strict";n.d(t,{A:()=>l});var o=n(85817),i=n(82056),a=n(17343),s=n(77609);class r extends o.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.preMouseDownCallback=e=>this._deleteNearbyAnnotations(e,"mouse"),this.preTouchStartCallback=e=>this._deleteNearbyAnnotations(e,"touch")}_deleteNearbyAnnotations(e,t){const{renderingEngineId:n,viewportId:r,element:l,currentPoints:d}=e.detail,c=(0,s.getToolGroupForViewport)(r,n);if(!c)return!1;const h=c._toolInstances,g=[];for(const e in h){const n=h[e];if("function"!=typeof n.isPointNearTool||"function"!=typeof n.filterInteractableAnnotationsForElement)continue;const o=(0,i.getAnnotations)(e,l),a=n.filterInteractableAnnotationsForElement(l,o);if(a)for(const e of a)n.isPointNearTool(l,e,d.canvas,10,t)&&g.push(e.annotationUID)}for(const e of g){(0,a.setAnnotationSelected)(e);const t=(0,i.getAnnotation)(e);o.EC.createAnnotationMemo(l,t,{deleting:!0}),(0,i.removeAnnotation)(e)}return e.preventDefault(),!0}}r.toolName="Eraser";const l=r},14840:(e,t,n)=>{"use strict";n.d(t,{A:()=>y});var o=n(3823),i=n(84607),a=n(89265),s=n(85817),r=n(15327),l=n(77609),d=n(82056),c=n(74347),h=n(85204),g=n(99737),u=n(60810),m=n(7001),v=n(35381),p=n(93258),f=n(2076),E=n(58640);const{RENDERING_DEFAULTS:w}=r.CONSTANTS;function I(){return"rgb(0, 200, 0)"}function C(){return!0}function T(){return!0}function b(){return!0}const A=1,_=2,S=3;class D extends s.EC{constructor(e={},t={supportedInteractionTypes:["Mouse"],configuration:{shadow:!0,viewportIndicators:!1,viewportIndicatorsConfig:{radius:5,x:null,y:null},autoPan:{enabled:!1,panSize:10},handleRadius:3,enableHDPIHandles:!1,referenceLinesCenterGapRadius:20,filterActorUIDsToSetSlabThickness:[],slabThicknessBlendMode:r.Enums.BlendModes.MAXIMUM_INTENSITY_BLEND,mobile:{enabled:!1,opacity:.8,handleRadius:9}}}){super(e,t),this.toolCenter=[0,0,0],this.initializeViewport=({renderingEngineId:e,viewportId:t})=>{const n=(0,r.getEnabledElementByIds)(t,e);if(!n)return;const{FrameOfReferenceUID:o,viewport:i}=n,{element:a}=i,{position:s,focalPoint:l,viewPlaneNormal:c}=i.getCamera();let h=this._getAnnotations(n);h=this.filterInteractableAnnotationsForElement(a,h),h?.length&&(0,d.removeAnnotation)(h[0].annotationUID);const g={highlighted:!1,metadata:{cameraPosition:[...s],cameraFocalPoint:[...l],FrameOfReferenceUID:o,toolName:this.getToolName()},data:{handles:{rotationPoints:[],slabThicknessPoints:[],toolCenter:this.toolCenter},activeOperation:null,activeViewportIds:[],viewportId:t}};return(0,d.addAnnotation)(g,a),{normal:c,point:i.canvasToWorld([i.canvas.clientWidth/2,i.canvas.clientHeight/2])}},this._getViewportsInfo=()=>(0,l.getToolGroup)(this.toolGroupId).viewportsInfo,this.resetCrosshairs=()=>{const e=this._getViewportsInfo();for(const t of e){const{viewportId:e,renderingEngineId:n}=t,o=(0,r.getEnabledElementByIds)(e,n),i=o.viewport,a=!0,s=!0,l=!0,c=!0,h=!0;i.resetCamera({resetPan:a,resetZoom:s,resetToCenter:l,resetRotation:c,suppressEvents:h}),i.resetSlabThickness();const{element:g}=i;let u=this._getAnnotations(o);u=this.filterInteractableAnnotationsForElement(g,u),u.length&&(0,d.removeAnnotation)(u[0].annotationUID),i.render()}this._computeToolCenter(e)},this.computeToolCenter=()=>{const e=this._getViewportsInfo();this._computeToolCenter(e)},this._computeToolCenter=e=>{if(!e.length||1===e.length)return void console.warn("For crosshairs to operate, at least two viewports must be given.");const[t,n,i]=e,{normal:a,point:s}=this.initializeViewport(t),{normal:l,point:d}=this.initializeViewport(n);let c=[0,0,0],h=o.eR.create();i?({normal:c,point:h}=this.initializeViewport(i)):(o.eR.add(h,s,d),o.eR.scale(h,h,.5),o.eR.cross(c,a,l));const g=r.utilities.planar.planeEquation(a,s),u=r.utilities.planar.planeEquation(l,d),m=r.utilities.planar.planeEquation(c,h),v=r.utilities.planar.threePlaneIntersection(g,u,m);this.setToolCenter(v)},this.addNewAnnotation=e=>{const t=e.detail,{element:n}=t,{currentPoints:o}=t,i=o.world,a=(0,r.getEnabledElement)(n),{viewport:s}=a;this._jump(a,i);const l=this._getAnnotations(a),d=this.filterInteractableAnnotationsForElement(s.element,l),{data:c}=d[0],{rotationPoints:h}=c.handles,g=[];for(let e=0;e<h.length-1;++e){const t=h[e][1],n=this._getReferenceLineControllable(t.id),o=this._getReferenceLineDraggableRotatable(t.id);n&&o&&(g.push(t.id),e++)}return c.activeViewportIds=[...g],c.handles.activeOperation=A,e.preventDefault(),(0,m.hideElementCursor)(n),this._activateModify(n),d[0]},this.cancel=()=>{console.log("Not implemented yet")},this.handleSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0,this._activateModify(o),(0,m.hideElementCursor)(o),e.preventDefault()},this.isPointNearTool=(e,t,n,o)=>!!this._pointNearTool(e,t,n,6),this.toolSelectedCallback=(e,t,n)=>{const o=e.detail,{element:i}=o;t.highlighted=!0,this._activateModify(i),(0,m.hideElementCursor)(i),e.preventDefault()},this.onCameraModified=e=>{const t=e.detail,{element:n}=t,o=(0,r.getEnabledElement)(n),{renderingEngine:a}=o,s=o.viewport,d=this._getAnnotations(o),c=this.filterInteractableAnnotationsForElement(n,d)[0];if(!c)return;const h=s.getCamera(),m=c.metadata.cameraPosition,v=[0,0,0];i.Ay.subtract(h.position,m,v);const p=c.metadata.cameraFocalPoint,f=[0,0,0];i.Ay.subtract(h.focalPoint,p,f),c.metadata.cameraPosition=[...h.position],c.metadata.cameraFocalPoint=[...h.focalPoint];const w=this._getReferenceLineControllable(s.id),I=this._getReferenceLineDraggableRotatable(s.id);if(!r.utilities.isEqual(h.position,m,.001)&&w&&I){let e=!1;r.utilities.isEqual(v,f,.001)||(e=!0);const t=Math.abs(i.Ay.dot(v,h.viewPlaneNormal))<.01;e||t||(this.toolCenter[0]+=v[0],this.toolCenter[1]+=v[1],this.toolCenter[2]+=v[2],(0,r.triggerEvent)(r.eventTarget,g.Events.CROSSHAIR_TOOL_CENTER_CHANGED,{toolGroupId:this.toolGroupId,toolCenter:this.toolCenter}))}if(this.configuration.autoPan?.enabled){(0,l.getToolGroupForViewport)(s.id,a.id).getViewportIds().filter(e=>e!==s.id).forEach(e=>{this._autoPanViewportIfNecessary(e,a)})}const C=(0,u.getViewportIdsWithToolToRender)(n,this.getToolName(),!1);(0,E.A)(C)},this.onResetCamera=e=>{this.resetCrosshairs()},this.mouseMoveCallback=(e,t)=>{const{element:n,currentPoints:o}=e.detail,i=o.canvas;let a=!1;for(let e=0;e<t.length;e++){const o=t[e];if((0,f.isAnnotationLocked)(o.annotationUID))continue;const{data:s,highlighted:r}=o;if(!s.handles)continue;const l=s.handles.activeOperation,d=s.activeViewportIds&&s.activeViewportIds.length>0?[...s.activeViewportIds]:[];s.activeViewportIds=[],s.handles.activeOperation=null;let c=!1;c=!!this.getHandleNearImagePoint(n,o,i,6)||this._pointNearTool(n,o,i,6);c&&!r||!c&&r?(o.highlighted=!r,a=!0):s.handles.activeOperation===l&&this._areViewportIdArraysEqual(s.activeViewportIds,d)||(a=!0)}return a},this.filterInteractableAnnotationsForElement=(e,t)=>{if(!t||!t.length)return[];const n=(0,r.getEnabledElement)(e),{viewportId:o}=n;return t.filter(e=>e.data.viewportId===o)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:s,renderingEngine:r}=e,{element:l}=s,d=this._getAnnotations(e),h=s.getCamera(),g=this.filterInteractableAnnotationsForElement(l,d)[0];if(!d?.length||!g?.data)return n;const u=g.annotationUID,{clientWidth:m,clientHeight:p}=s.canvas,f=Math.sqrt(m*m+p*p),E=Math.min(m,p),w=g.data,I=s.worldToCanvas(this.toolCenter),C=this._filterAnnotationsByUniqueViewportOrientations(e,d),T=[],b=[0,0,m,p];C.forEach(e=>{const{data:t}=e;t.handles.toolCenter=this.toolCenter;const n=r.getViewport(t.viewportId),l=n.getCamera(),d=this._getReferenceLineControllable(n.id),c=this._getReferenceLineDraggableRotatable(n.id),g=this._getReferenceLineSlabThicknessControlsOn(n.id),{clientWidth:u,clientHeight:m}=n.canvas,p=Math.sqrt(u*u+m*m),w=[.5*u,.5*m],A=n.canvasToWorld(w),_=[0,0,0];i.Ay.cross(h.viewPlaneNormal,l.viewPlaneNormal,_),i.Ay.normalize(_),i.Ay.multiplyScalar(_,p);const S=[0,0,0];i.Ay.add(A,_,S);const D=[0,0,0];i.Ay.subtract(A,_,D);const y=s.worldToCanvas(S),M=s.worldToCanvas(A),x=o.Zc.create();o.Zc.subtract(x,y,M),o.Zc.normalize(x,x);const R=o.Zc.create();o.Zc.scale(R,x,100*f);const P=o.Zc.create();o.Zc.scale(P,x,.4*E);const L=o.Zc.create();o.Zc.scale(L,x,.2*E);const k=o.Zc.create(),O=this.configuration.referenceLinesCenterGapRadius;o.Zc.scale(k,x,2===C.length?O:0);const U=o.Zc.create(),N=o.Zc.create(),V=o.Zc.create(),B=o.Zc.create();let W=o.Zc.clone(I);c&&d||(W=o.Zc.clone(M)),o.Zc.add(U,W,k),o.Zc.add(N,W,R),o.Zc.subtract(V,W,k),o.Zc.subtract(B,W,R),(0,v.A)(U,N,b),(0,v.A)(V,B,b);const H=o.Zc.create();o.Zc.subtract(H,I,P);const F=o.Zc.create();o.Zc.add(F,I,P);let G=o.Zc.clone(I);!c&&g&&(G=o.Zc.clone(M));let $=[...this.toolCenter];!c&&g&&($=[...A]);const z=[0,0,0];i.Ay.subtract(S,D,z),i.Ay.normalize(z);const{viewPlaneNormal:q}=h,{matrix:K}=a.A.buildFromDegree().rotate(90,q),j=[0,0,0];o.eR.transformMat4(j,z,K);const Z=n.getSlabThickness(),Y=[...j];i.Ay.multiplyScalar(Y,Z);const J=[0,0,0];i.Ay.add($,Y,J);const X=s.worldToCanvas(J),Q=o.Zc.create();o.Zc.subtract(Q,G,X);const ee=o.Zc.create();o.Zc.subtract(ee,G,R),o.Zc.add(ee,ee,Q);const te=o.Zc.create();o.Zc.add(te,G,R),o.Zc.add(te,te,Q),(0,v.A)(ee,te,b);const ne=o.Zc.create();o.Zc.add(ne,G,R),o.Zc.subtract(ne,ne,Q);const oe=o.Zc.create();o.Zc.subtract(oe,G,R),o.Zc.subtract(oe,oe,Q),(0,v.A)(ne,oe,b);const ie=o.Zc.create(),ae=o.Zc.create(),se=o.Zc.create(),re=o.Zc.create();o.Zc.subtract(ie,G,L),o.Zc.add(ie,ie,Q),o.Zc.add(ae,G,L),o.Zc.add(ae,ae,Q),o.Zc.subtract(se,G,L),o.Zc.subtract(se,se,Q),o.Zc.add(re,G,L),o.Zc.subtract(re,re,Q),T.push([n,U,N,V,B,ee,te,ne,oe,H,F,ie,ae,se,re])});const D=[],y=[],M=this._getReferenceLineColor(s.id),x=void 0!==M?M:"rgb(200, 200, 200)";if(T.forEach((e,n)=>{const o=e[0],i=this._getReferenceLineColor(o.id),a=this._getReferenceLineControllable(o.id),r=this._getReferenceLineDraggableRotatable(o.id)||this.configuration.mobile?.enabled,l=this._getReferenceLineSlabThicknessControlsOn(o.id)||this.configuration.mobile?.enabled,d=w.activeViewportIds.find(e=>e===o.id);let h=void 0!==i?i:"rgb(200, 200, 200)",g=1;const m=null!==w.handles.activeOperation&&w.handles.activeOperation===A&&d;m&&(g=2.5);let v=`${n}`;if(a&&r?(v=`${n}One`,(0,c.drawLine)(t,u,v,e[1],e[2],{color:h,lineWidth:g}),v=`${n}Two`,(0,c.drawLine)(t,u,v,e[3],e[4],{color:h,lineWidth:g})):(0,c.drawLine)(t,u,v,e[2],e[4],{color:h,lineWidth:g}),a){h=void 0!==i?i:"rgb(200, 200, 200)";const a=w.handles.activeOperation===_,g=[e[9],e[10]],p=[s.canvasToWorld(e[9]),o,e[1],e[2]],f=[s.canvasToWorld(e[10]),o,e[3],e[4]];D.push(p,f);const E=w.handles.activeOperation===S,I=[e[11],e[12],e[13],e[14]],C=[s.canvasToWorld(e[11]),o,e[5],e[6]],T=[s.canvasToWorld(e[12]),o,e[5],e[6]],b=[s.canvasToWorld(e[13]),o,e[7],e[8]],A=[s.canvasToWorld(e[14]),o,e[7],e[8]];y.push(C,T,b,A);let M=this.configuration.handleRadius*(this.configuration.enableHDPIHandles?window.devicePixelRatio:1),x=1;if(this.configuration.mobile?.enabled&&(M=this.configuration.mobile.handleRadius,x=this.configuration.mobile.opacity),(m||this.configuration.mobile?.enabled)&&!a&&!E&&r&&l){let e=`${n}One`;(0,c.drawHandles)(t,u,e,g,{color:h,handleRadius:M,opacity:x,type:"circle"}),e=`${n}Two`,(0,c.drawHandles)(t,u,e,I,{color:h,handleRadius:M,opacity:x,type:"rect"})}else if(m&&!a&&!E&&r){const e=`${n}`;(0,c.drawHandles)(t,u,e,g,{color:h,handleRadius:M,opacity:x,type:"circle"})}else if(d&&!a&&!E&&l){const e=`${n}`;(0,c.drawHandles)(t,u,e,I,{color:h,handleRadius:M,opacity:x,type:"rect"})}else if(a&&r){const e=`${n}`,o=this.configuration.handleRadius*(this.configuration.enableHDPIHandles?window.devicePixelRatio:1);(0,c.drawHandles)(t,u,e,g,{color:h,handleRadius:o,fill:h,type:"circle"})}else if(E&&d&&l){const e=this.configuration.handleRadius*(this.configuration.enableHDPIHandles?window.devicePixelRatio:1);(0,c.drawHandles)(t,u,v,I,{color:h,handleRadius:e,fill:h,type:"rect"})}o.getSlabThickness()>.5&&l&&(v=`${n}STOne`,(0,c.drawLine)(t,u,v,e[5],e[6],{color:h,width:1,lineDash:[2,3]}),v=`${n}STTwo`,(0,c.drawLine)(t,u,v,e[7],e[8],{color:h,width:e,lineDash:[2,3]}))}}),n=!0,w.handles.rotationPoints=D,w.handles.slabThicknessPoints=y,this.configuration.viewportIndicators){const{viewportIndicatorsConfig:e}=this.configuration,n=[m*(e?.xOffset||.95),p*(e?.yOffset||.05)],o=e?.circleRadius||.01*f,i="0";(0,c.drawCircle)(t,u,i,n,o,{color:x,fill:x})}return n},this._getAnnotations=e=>{const{viewport:t}=e,n=(0,d.getAnnotations)(this.getToolName(),t.element)||[],o=this._getViewportsInfo().map(({viewportId:e})=>e);return n.filter(e=>{const{data:t}=e;return o.includes(t.viewportId)})},this._onNewVolume=()=>{const e=this._getViewportsInfo();this._computeToolCenter(e)},this._areViewportIdArraysEqual=(e,t)=>e.length===t.length&&(e.forEach(e=>{let n=!1;for(let o=0;o<t.length;++o)if(e===t[o]){n=!0;break}if(!1===n)return!1}),!0),this._getAnnotationsForViewportsWithDifferentCameras=(e,t)=>{const{viewportId:n,renderingEngine:o,viewport:i}=e,a=t.filter(e=>e.data.viewportId!==n);if(!a||!a.length)return[];const s=i.getCamera(),{viewPlaneNormal:l,position:d}=s,c=a.filter(e=>{const{viewportId:t}=e.data,n=o.getViewport(t).getCamera();return!(r.utilities.isEqual(n.viewPlaneNormal,l,.01)&&r.utilities.isEqual(n.position,d,1))});return c},this._filterViewportWithSameOrientation=(e,t,n)=>{const{renderingEngine:o}=e,{data:a}=t,s=o.getViewport(a.viewportId),l=n.filter(e=>{const{data:t}=e,n=o.getViewport(t.viewportId);return!0===this._getReferenceLineControllable(n.id)});if(!l||!l.length)return[];const d=s.getCamera(),c=d.viewPlaneNormal;i.Ay.normalize(c);return l.filter(e=>{const{viewportId:t}=e.data,n=o.getViewport(t).getCamera(),a=n.viewPlaneNormal;return i.Ay.normalize(a),r.utilities.isEqual(c,a,.01)&&r.utilities.isEqual(d.viewUp,n.viewUp,.01)})},this._filterAnnotationsByUniqueViewportOrientations=(e,t)=>{const{renderingEngine:n,viewport:o}=e,a=o.getCamera().viewPlaneNormal;i.Ay.normalize(a);const s=t.filter(e=>{const{data:t}=e,i=n.getViewport(t.viewportId),a=this._getReferenceLineControllable(i.id);return o!==i&&!0===a}),l=[];for(let e=0;e<s.length;++e){const t=s[e],{viewportId:o}=t.data,d=n.getViewport(o).getCamera(),c=d.viewPlaneNormal;if(i.Ay.normalize(c),r.utilities.isEqual(a,c,.01)||r.utilities.isOpposite(a,c,.01))continue;let h=!1;for(let e=0;e<l.length;++e){const t=l[e],{viewportId:o}=t.data,i=n.getViewport(o).getCamera();r.utilities.isEqual(i.viewPlaneNormal,d.viewPlaneNormal,.01)&&r.utilities.isEqual(i.position,d.position,1)&&(h=!0)}h||l.push(t)}const d=t.filter(e=>{const{data:t}=e,i=n.getViewport(t.viewportId),a=this._getReferenceLineControllable(i.id);return o!==i&&!0!==a});for(let e=0;e<d.length;++e){const t=d[e],{viewportId:o}=t.data,s=n.getViewport(o).getCamera(),c=s.viewPlaneNormal;if(i.Ay.normalize(c),r.utilities.isEqual(a,c,.01)||r.utilities.isOpposite(a,c,.01))continue;let h=!1;for(let e=0;e<l.length;++e){const t=l[e],{viewportId:o}=t.data,i=n.getViewport(o).getCamera();r.utilities.isEqual(i.viewPlaneNormal,s.viewPlaneNormal,.01)&&r.utilities.isEqual(i.position,s.position,1)&&(h=!0)}h||l.push(t)}const c=this._getAnnotationsForViewportsWithDifferentCameras(e,t);for(let e=0;e<c.length;++e){const t=c[e];if(l.some(e=>e===t))continue;const{viewportId:o}=t.data,s=n.getViewport(o).getCamera(),d=s.viewPlaneNormal;if(i.Ay.normalize(d),r.utilities.isEqual(a,d,.01)||r.utilities.isOpposite(a,d,.01))continue;let h=!1;for(let e=0;e<l.length;++e){const t=l[e],{viewportId:o}=t.data,i=n.getViewport(o).getCamera();r.utilities.isEqual(i.viewPlaneNormal,s.viewPlaneNormal,.01)&&r.utilities.isEqual(i.position,s.position,1)&&(h=!0)}h||l.push(t)}return l},this._checkIfViewportsRenderingSameScene=(e,t)=>{const n=e.getAllVolumeIds(),o=t.getAllVolumeIds();return n.length===o.length&&n.every(e=>o.includes(e))},this._jump=(e,t)=>{h.wk.isInteractingWithTool=!0;const{viewport:n,renderingEngine:o}=e,a=this._getAnnotations(e),s=[0,0,0];i.Ay.subtract(t,this.toolCenter,s);const r=this._getAnnotationsForViewportsWithDifferentCameras(e,a).filter(e=>{const{data:t}=e,i=o.getViewport(t.viewportId),a=this._checkIfViewportsRenderingSameScene(n,i);return this._getReferenceLineControllable(i.id)&&this._getReferenceLineDraggableRotatable(i.id)&&a});return 0===r.length?(h.wk.isInteractingWithTool=!1,!1):(this._applyDeltaShiftToSelectedViewportCameras(o,r,s),h.wk.isInteractingWithTool=!1,!0)},this._activateModify=e=>{h.wk.isInteractingWithTool=!this.configuration.mobile?.enabled,e.addEventListener(g.Events.MOUSE_UP,this._endCallback),e.addEventListener(g.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(g.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(g.Events.TOUCH_END,this._endCallback),e.addEventListener(g.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(g.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{h.wk.isInteractingWithTool=!1,e.removeEventListener(g.Events.MOUSE_UP,this._endCallback),e.removeEventListener(g.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(g.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(g.Events.TOUCH_END,this._endCallback),e.removeEventListener(g.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(g.Events.TOUCH_TAP,this._endCallback)},this._endCallback=e=>{const t=e.detail,{element:n}=t;this.editData.annotation.data.handles.activeOperation=null,this.editData.annotation.data.activeViewportIds=[],this._deactivateModify(n),(0,m.resetElementCursor)(n),this.editData=null;const o=(0,u.getViewportIdsWithToolToRender)(n,this.getToolName(),!1);(0,E.A)(o)},this._dragCallback=e=>{const t=e.detail,n=t.deltaPoints.world;if(Math.abs(n[0])<.001&&Math.abs(n[1])<.001&&Math.abs(n[2])<.001)return;const{element:s}=t,d=(0,r.getEnabledElement)(s),{renderingEngine:c,viewport:h}=d,g=this._getAnnotations(d),u=this.filterInteractableAnnotationsForElement(s,g)[0];if(!u)return;const{handles:m}=u.data,{currentPoints:v}=e.detail,p=v.canvas;if(m.activeOperation===A){const e=this._getAnnotationsForViewportsWithDifferentCameras(d,g).filter(e=>{const{data:t}=e,n=c.getViewport(t.viewportId),o=this._getReferenceLineControllable(n.id),i=this._getReferenceLineDraggableRotatable(n.id);return!0===o&&!0===i&&u.data.activeViewportIds.find(e=>e===n.id)});this._applyDeltaShiftToSelectedViewportCameras(c,e,n)}else if(m.activeOperation===_){const e=this._getAnnotationsForViewportsWithDifferentCameras(d,g).filter(e=>{const{data:t}=e,n=c.getViewport(t.viewportId),o=this._getReferenceLineControllable(n.id),i=this._getReferenceLineDraggableRotatable(n.id);return!0===o&&!0===i}),n=o.Zc.create(),i=o.Zc.create(),s=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]],r=h.worldToCanvas(s),l=t.currentPoints.canvas,u=o.Zc.create();o.Zc.sub(u,l,t.deltaPoints.canvas),o.Zc.sub(n,u,r),o.Zc.sub(i,l,r);let m=o.Zc.angle(n,i);this._isClockWise(r,u,l)&&(m*=-1),m=Math.round(100*m)/100;const v=h.getCamera().viewPlaneNormal,{matrix:p}=a.A.buildFromRadian().translate(s[0],s[1],s[2]).rotate(m,v).translate(-s[0],-s[1],-s[2]),f=[];e.forEach(e=>{const{data:t}=e;t.handles.toolCenter=s;const n=c.getViewport(t.viewportId),i=n.getCamera(),{viewUp:a,position:r,focalPoint:l}=i;a[0]+=r[0],a[1]+=r[1],a[2]+=r[2],o.eR.transformMat4(l,l,p),o.eR.transformMat4(r,r,p),o.eR.transformMat4(a,a,p),a[0]-=r[0],a[1]-=r[1],a[2]-=r[2],n.setCamera({position:r,viewUp:a,focalPoint:l}),f.push(n.id)}),c.renderViewports(f)}else if(m.activeOperation===S){const e=this._getAnnotationsForViewportsWithDifferentCameras(d,g).filter(e=>{const{data:t}=e,n=c.getViewport(t.viewportId),o=this._getReferenceLineControllable(n.id),i=this._getReferenceLineSlabThicknessControlsOn(n.id);return!0===o&&!0===i&&u.data.activeViewportIds.find(e=>e===n.id)});if(0===e.length)return;const a=this._filterViewportWithSameOrientation(d,e[0],g),s=[];s.push(h.id),a.forEach(e=>{const{data:a}=e,d=c.getViewport(a.viewportId),g=d.getCamera().viewPlaneNormal,m=i.Ay.dot(n,g),v=[...g];if(i.Ay.multiplyScalar(v,m),Math.abs(v[0])>.001||Math.abs(v[1])>.001||Math.abs(v[2])>.001){const e=Math.sqrt(v[0]*v[0]+v[1]*v[1]+v[2]*v[2]),n=t.lastPoints.world,a=[0,0,0],m=[this.toolCenter[0],this.toolCenter[1],this.toolCenter[2]];if(!this._getReferenceLineDraggableRotatable(d.id)){const{rotationPoints:e}=this.editData.annotation.data.handles,t=e.filter(e=>e[1].uid===d.id);if(2===t.length){const e=h.canvasToWorld(t[0][3]),n=h.canvasToWorld(t[1][3]);i.Ay.add(e,n,m),i.Ay.multiplyScalar(m,.5)}}i.Ay.subtract(n,m,a);const f=i.Ay.dot(a,g),E=[...g];i.Ay.multiplyScalar(E,f);const I=[E[0],E[1],E[2]];o.eR.normalize(I,I);const C=[v[0],v[1],v[2]];o.eR.normalize(C,C);let T=d.getSlabThickness();r.utilities.isOpposite(I,C,.001)?T-=e:T+=e,T=Math.abs(T),T=Math.max(w.MINIMUM_SLAB_THICKNESS,T);this._pointNearReferenceLine(u,p,6,d)&&(T=w.MINIMUM_SLAB_THICKNESS);(0,l.getToolGroupForViewport)(d.id,c.id).getToolInstance(this.getToolName()).setSlabThickness(d,T),s.push(d.id)}}),c.renderViewports(s)}},this._pointNearReferenceLine=(e,t,n,o)=>{const{data:i}=e,{rotationPoints:a}=i.handles;for(let e=0;e<a.length-1;++e){const i=a[e][1];if(i.id!==o.id)continue;if(!this._getReferenceLineControllable(i.id))continue;const s={start:{x:a[e][2][0],y:a[e][2][1]},end:{x:a[e][3][0],y:a[e][3][1]}},r=p.distanceToPoint([s.start.x,s.start.y],[s.end.x,s.end.y],[t[0],t[1]]),l={start:{x:a[e+1][2][0],y:a[e+1][2][1]},end:{x:a[e+1][3][0],y:a[e+1][3][1]}},d=p.distanceToPoint([l.start.x,l.start.y],[l.end.x,l.end.y],[t[0],t[1]]);if(r<=n||d<=n)return!0;e++}return!1},this._getReferenceLineColor=e.configuration?.getReferenceLineColor||I,this._getReferenceLineControllable=e.configuration?.getReferenceLineControllable||C,this._getReferenceLineDraggableRotatable=e.configuration?.getReferenceLineDraggableRotatable||T,this._getReferenceLineSlabThicknessControlsOn=e.configuration?.getReferenceLineSlabThicknessControlsOn||b}onSetToolActive(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),this._subscribeToViewportNewVolumeSet(e),this._computeToolCenter(e)}onSetToolPassive(){const e=this._getViewportsInfo();this._computeToolCenter(e)}onSetToolEnabled(){const e=this._getViewportsInfo();this._computeToolCenter(e)}onSetToolDisabled(){const e=this._getViewportsInfo();this._unsubscribeToViewportNewVolumeSet(e),e.forEach(({renderingEngineId:e,viewportId:t})=>{const n=(0,r.getEnabledElementByIds)(t,e);if(!n)return;const o=this._getAnnotations(n);o?.length&&o.forEach(e=>{(0,d.removeAnnotation)(e.annotationUID)})})}setToolCenter(e,t=!1){this.toolCenter=e;const n=this._getViewportsInfo();(0,E.A)(n.map(({viewportId:e})=>e)),t||(0,r.triggerEvent)(r.eventTarget,g.Events.CROSSHAIR_TOOL_CENTER_CHANGED,{toolGroupId:this.toolGroupId,toolCenter:this.toolCenter})}getHandleNearImagePoint(e,t,n,o){const i=(0,r.getEnabledElement)(e),{viewport:a}=i;let s=this._getRotationHandleNearImagePoint(a,t,n,o);return null!==s?s:(s=this._getSlabThicknessHandleNearImagePoint(a,t,n,o),null!==s?s:void 0)}_unsubscribeToViewportNewVolumeSet(e){e.forEach(({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,r.getEnabledElementByIds)(e,t),{element:o}=n;o.removeEventListener(r.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)})}_subscribeToViewportNewVolumeSet(e){e.forEach(({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,r.getEnabledElementByIds)(e,t),{element:o}=n;o.addEventListener(r.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this._onNewVolume)})}_autoPanViewportIfNecessary(e,t){const n=t.getViewport(e),{clientWidth:o,clientHeight:i}=n.canvas,a=n.worldToCanvas(this.toolCenter),s=this.configuration.autoPan.panSize,r=[a[0],a[1]];if(a[0]<0?r[0]=s:a[0]>o&&(r[0]=o-s),a[1]<0?r[1]=s:a[1]>i&&(r[1]=i-s),r[0]===a[0]&&r[1]===a[1])return;const l=n.canvasToWorld(r),d=[l[0]-this.toolCenter[0],l[1]-this.toolCenter[1],l[2]-this.toolCenter[2]],c=n.getCamera(),{focalPoint:h,position:g}=c,u=[g[0]-d[0],g[1]-d[1],g[2]-d[2]],m=[h[0]-d[0],h[1]-d[1],h[2]-d[2]];n.setCamera({focalPoint:m,position:u}),n.render()}setSlabThickness(e,t){let n;const{filterActorUIDsToSetSlabThickness:o}=this.configuration;o&&o.length>0&&(n=o);let i=this.configuration.slabThicknessBlendMode;t===w.MINIMUM_SLAB_THICKNESS&&(i=r.Enums.BlendModes.COMPOSITE);e.setBlendMode(i,n,!1),e.setSlabThickness(t,n)}_isClockWise(e,t,n){return(t[0]-e[0])*(n[1]-e[1])-(t[1]-e[1])*(n[0]-e[0])>0}_applyDeltaShiftToSelectedViewportCameras(e,t,n){t.forEach(t=>{this._applyDeltaShiftToViewportCamera(e,t,n)})}_applyDeltaShiftToViewportCamera(e,t,n){const{data:o}=t,a=e.getViewport(o.viewportId),s=a.getCamera(),r=s.viewPlaneNormal,l=i.Ay.dot(n,r),d=[...r];if(i.Ay.multiplyScalar(d,l),Math.abs(d[0])>.001||Math.abs(d[1])>.001||Math.abs(d[2])>.001){const e=[0,0,0],t=[0,0,0];i.Ay.add(s.focalPoint,d,e),i.Ay.add(s.position,d,t),a.setCamera({focalPoint:e,position:t}),a.render()}}_getRotationHandleNearImagePoint(e,t,n,i){const{data:a}=t,{rotationPoints:s}=a.handles;for(let r=0;r<s.length;r++){const l=s[r][0],d=s[r][1];if(!this._getReferenceLineControllable(d.id))continue;if(!this._getReferenceLineDraggableRotatable(d.id))continue;const c=e.worldToCanvas(l);if(o.Zc.distance(n,c)<i)return a.handles.activeOperation=_,this.editData={annotation:t},l}return null}_getSlabThicknessHandleNearImagePoint(e,t,n,i){const{data:a}=t,{slabThicknessPoints:s}=a.handles;for(let r=0;r<s.length;r++){const l=s[r][0],d=s[r][1];if(!this._getReferenceLineControllable(d.id))continue;if(!this._getReferenceLineSlabThicknessControlsOn(d.id))continue;const c=e.worldToCanvas(l);if(o.Zc.distance(n,c)<i)return a.handles.activeOperation=S,a.activeViewportIds=[d.id],this.editData={annotation:t},l}return null}_pointNearTool(e,t,n,i){const a=(0,r.getEnabledElement)(e),{viewport:s}=a,{clientWidth:l,clientHeight:d}=s.canvas,c=Math.sqrt(l*l+d*d),{data:h}=t,{rotationPoints:g}=h.handles,{slabThicknessPoints:u}=h.handles,m=[];for(let e=0;e<g.length-1;++e){const t=g[e][1],o=this._getReferenceLineControllable(t.id),a=this._getReferenceLineDraggableRotatable(t.id);if(!o||!a)continue;const s={start:{x:g[e][2][0],y:g[e][2][1]},end:{x:g[e][3][0],y:g[e][3][1]}},r=p.distanceToPoint([s.start.x,s.start.y],[s.end.x,s.end.y],[n[0],n[1]]),l={start:{x:g[e+1][2][0],y:g[e+1][2][1]},end:{x:g[e+1][3][0],y:g[e+1][3][1]}},d=p.distanceToPoint([l.start.x,l.start.y],[l.end.x,l.end.y],[n[0],n[1]]);(r<=i||d<=i)&&(m.push(t.id),h.handles.activeOperation=A),e++}for(let e=0;e<u.length-1;++e){const t=u[e][1];if(m.find(e=>e===t.id))continue;const a=this._getReferenceLineControllable(t.id),s=this._getReferenceLineSlabThicknessControlsOn(t.id);if(!a||!s)continue;const r=u[e][2],l=u[e][3],d=o.Zc.create();o.Zc.add(d,r,l),o.Zc.scale(d,d,.5);const g=o.Zc.create();o.Zc.subtract(g,r,d),o.Zc.normalize(g,g);const v=o.Zc.create();o.Zc.scale(v,g,.05*c);const f=o.Zc.create(),E=o.Zc.create();o.Zc.add(f,d,v),o.Zc.subtract(E,d,v);const w={start:{x:f[0],y:f[1]},end:{x:r[0],y:r[1]}},I=p.distanceToPoint([w.start.x,w.start.y],[w.end.x,w.end.y],[n[0],n[1]]),C={start:{x:E[0],y:E[1]},end:{x:l[0],y:l[1]}},T=p.distanceToPoint([C.start.x,C.start.y],[C.end.x,C.end.y],[n[0],n[1]]);(I<=i||T<=i)&&(m.push(t.id),h.handles.activeOperation=null),e++}return h.activeViewportIds=[...m],this.editData={annotation:t},h.handles.activeOperation===A}}D.toolName="Crosshairs";const y=D},66944:(e,t,n)=>{"use strict";n.d(t,{A:()=>l});var o=n(85817),i=n(15327),a=n(13165),s=n(77609);class r extends o.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{targetViewportIds:[]}}){super(e,t)}mouseClickCallback(e){const{element:t,currentPoints:n}=e.detail,o=(0,i.getEnabledElement)(t),{viewport:r,renderingEngine:l}=o,d=r.getVolumeId();if(!d)throw new Error("MIPJumpToClickTool: targetId is not a volumeId, you should only use MIPJumpToClickTool with a volumeId as the targetId");let c=-1/0;const h=(0,a.getPointInLineOfSightWithCriteria)(r,n.world,d,(e,t)=>{if(e>c)return c=e,t});if(!h||!h.length)return;const{targetViewportIds:g,toolGroupId:u}=this.configuration;l.getViewports().filter(e=>{if(g?.indexOf(e.id)>=0)return!0;const t=(0,s.getToolGroupForViewport)(e.id,l.id);return!(!u||u!==t?.id)}).forEach(e=>{e instanceof i.VolumeViewport?e.jumpToWorld(h):console.warn("Cannot jump to specified world coordinates for a viewport that is not a VolumeViewport")})}}r.toolName="MIPJumpToClickTool";const l=r},72674:(e,t,n)=>{"use strict";n.d(t,{A:()=>g});var o=n(85817),i=n(99737),a=n(15327),s=n(60810),r=n(58640),l=n(85204),d=n(7001);const c="magnify-viewport";class h extends o.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{magnifySize:10,magnifyWidth:250,magnifyHeight:250}}){super(e,t),this._hasBeenRemoved=!1,this.preMouseDownCallback=e=>{const t=e.detail,{element:n,currentPoints:o}=t,i=(0,a.getEnabledElement)(n),{viewport:l,renderingEngine:c}=i;if(!(l instanceof a.StackViewport))throw new Error("MagnifyTool only works on StackViewports");const h=this._getReferencedImageId(l);if(!h)throw new Error("MagnifyTool: No referenced image id found, reconstructed planes not supported yet");const g=(0,s.getViewportIdsWithToolToRender)(n,this.getToolName());return this.editData={referencedImageId:h,viewportIdsToRender:g,enabledElement:i,renderingEngine:c,currentPoints:o},this._createMagnificationViewport(),this._activateDraw(n),(0,d.hideElementCursor)(n),e.preventDefault(),(0,r.A)(g),!0},this.preTouchStartCallback=e=>{this.preMouseDownCallback(e)},this._createMagnificationViewport=()=>{const{enabledElement:e,referencedImageId:t,viewportIdsToRender:n,renderingEngine:o,currentPoints:i}=this.editData,{viewport:s}=e,{element:l}=s,d=s.getProperties(),{rotation:h}=s.getViewPresentation(),{canvas:g,world:u}=i;let m;if(m=l.querySelector(".magnifyTool"),null===m){const e=document.createElement("div");e.classList.add("magnifyTool"),e.style.display="block",e.style.width=`${this.configuration.magnifyWidth}px`,e.style.height=`${this.configuration.magnifyHeight}px`,e.style.position="absolute",m=e;l.querySelector(".viewport-element").appendChild(e);const t={viewportId:c,type:a.Enums.ViewportType.STACK,element:m};o.enableElement(t)}m.style.top=g[1]-this.configuration.magnifyHeight/2+"px",m.style.left=g[0]-this.configuration.magnifyWidth/2+"px";const v=o.getViewport(c);v.setStack([t]).then(()=>{if(this._hasBeenRemoved)return;v.setProperties(d),v.setViewPresentation({rotation:h});const{parallelScale:e}=s.getCamera(),{focalPoint:t,position:n,viewPlaneNormal:o}=v.getCamera(),i=Math.sqrt(Math.pow(t[0]-n[0],2)+Math.pow(t[1]-n[1],2)+Math.pow(t[2]-n[2],2)),a=[u[0],u[1],u[2]],r=[a[0]+i*o[0],a[1]+i*o[1],a[2]+i*o[2]];v.setCamera({parallelScale:e*(1/this.configuration.magnifySize),focalPoint:a,position:r}),v.render()}),m.style.display="block",(0,r.A)(n)},this._dragCallback=e=>{const t=e.detail,{deltaPoints:n,element:o,currentPoints:i}=t,s=n.world,r=i.canvas,l=(0,a.getEnabledElement)(o),{renderingEngine:d}=l,h=d.getViewport(c),g=o.querySelector(".magnifyTool");if(!g)return;g.style.top=r[1]-this.configuration.magnifyHeight/2+"px",g.style.left=r[0]-this.configuration.magnifyWidth/2+"px";const{focalPoint:u,position:m}=h.getCamera(),v=[m[0]+s[0],m[1]+s[1],m[2]+s[2]],p=[u[0]+s[0],u[1]+s[1],u[2]+s[2]];h.setCamera({focalPoint:p,position:v}),h.render()},this._dragEndCallback=e=>{const{element:t}=e.detail,n=(0,a.getEnabledElement)(t),{renderingEngine:o}=n;o.disableElement(c);const i=t.querySelector(".viewport-element"),s=i.querySelector(".magnifyTool");i.removeChild(s),this._deactivateDraw(t),(0,d.resetElementCursor)(t),this._hasBeenRemoved=!0},this._activateDraw=e=>{l.wk.isInteractingWithTool=!0,this._hasBeenRemoved=!1,e.addEventListener(i.Events.MOUSE_UP,this._dragEndCallback),e.addEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(i.Events.MOUSE_CLICK,this._dragEndCallback),e.addEventListener(i.Events.TOUCH_END,this._dragEndCallback),e.addEventListener(i.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{l.wk.isInteractingWithTool=!1,e.removeEventListener(i.Events.MOUSE_UP,this._dragEndCallback),e.removeEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(i.Events.MOUSE_CLICK,this._dragEndCallback),e.removeEventListener(i.Events.TOUCH_END,this._dragEndCallback),e.removeEventListener(i.Events.TOUCH_DRAG,this._dragCallback)}}_getReferencedImageId(e){const t=this.getTargetId(e);let n;return e instanceof a.StackViewport&&(n=t.split("imageId:")[1]),n}}h.toolName="Magnify";const g=h},36913:(e,t,n)=>{"use strict";n.d(t,{A:()=>f});var o,i=n(25161),a=n(85825),s=n(45700),r=n(7019),l=n(82409),d=n(94199),c=n(87275),h=n(85817),g=n(15327),u=n(60810),m=n(77609),v=n(99737);!function(e){e[e.ANNOTATED_CUBE=1]="ANNOTATED_CUBE",e[e.AXES=2]="AXES",e[e.CUSTOM=3]="CUSTOM"}(o||(o={}));class p extends h.oS{static{this.CUBE=1}static{this.AXIS=2}static{this.VTPFILE=3}static{this.OVERLAY_MARKER_TYPES=o}constructor(e={},t={configuration:{orientationWidget:{enabled:!0,viewportCorner:i.Ay.Corners.BOTTOM_RIGHT,viewportSize:.15,minPixelSize:100,maxPixelSize:300},overlayMarkerType:p.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE,overlayConfiguration:{[p.OVERLAY_MARKER_TYPES.ANNOTATED_CUBE]:{faceProperties:{xPlus:{text:"L",faceColor:"#ffff00",faceRotation:90},xMinus:{text:"R",faceColor:"#ffff00",faceRotation:270},yPlus:{text:"P",faceColor:"#00ffff",fontColor:"white",faceRotation:180},yMinus:{text:"A",faceColor:"#00ffff",fontColor:"white"},zPlus:{text:"S"},zMinus:{text:"I"}},defaultStyle:{fontStyle:"bold",fontFamily:"Arial",fontColor:"black",fontSizeScale:e=>e/2,faceColor:"#0000ff",edgeThickness:.1,edgeColor:"black",resolution:400}},[p.OVERLAY_MARKER_TYPES.AXES]:{},[p.OVERLAY_MARKER_TYPES.CUSTOM]:{polyDataURL:"https://raw.githubusercontent.com/Slicer/Slicer/80ad0a04dacf134754459557bf2638c63f3d1d1b/Base/Logic/Resources/OrientationMarkers/Human.vtp"}}}}){super(e,t),this._resizeObservers=new Map,this.onSetToolEnabled=()=>{this.initViewports(),this._subscribeToViewportEvents()},this.onSetToolActive=()=>{this.initViewports(),this._subscribeToViewportEvents()},this.onSetToolDisabled=()=>{this.cleanUpData(),this._unsubscribeToViewportNewVolumeSet()},this._getViewportsInfo=()=>(0,m.getToolGroup)(this.toolGroupId).viewportsInfo,this.resize=e=>{const t=this.orientationMarkers[e];if(!t)return;const{orientationWidget:n}=t;n.updateViewport()},this.orientationMarkers={},this.updatingOrientationMarker={}}_unsubscribeToViewportNewVolumeSet(){const e=()=>{this._getViewportsInfo().forEach(({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,g.getEnabledElementByIds)(e,t),{element:o}=n;o.removeEventListener(g.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this.initViewports.bind(this));this._resizeObservers.get(e).unobserve(o)})};g.eventTarget.removeEventListener(v.Events.TOOLGROUP_VIEWPORT_ADDED,t=>{t.detail.toolGroupId===this.toolGroupId&&(e(),this.initViewports())})}_subscribeToViewportEvents(){const e=()=>{this._getViewportsInfo().forEach(({viewportId:e,renderingEngineId:t})=>{const{viewport:n}=(0,g.getEnabledElementByIds)(e,t),{element:o}=n;this.initViewports(),o.addEventListener(g.Enums.Events.VOLUME_VIEWPORT_NEW_VOLUME,this.initViewports.bind(this));const i=new ResizeObserver(()=>{setTimeout(()=>{const n=(0,g.getEnabledElementByIds)(e,t);if(!n)return;const{viewport:o}=n;this.resize(e),o.render()},100)});i.observe(o),this._resizeObservers.set(e,i)})};e(),g.eventTarget.addEventListener(v.Events.TOOLGROUP_VIEWPORT_ADDED,t=>{t.detail.toolGroupId===this.toolGroupId&&(e(),this.initViewports())})}cleanUpData(){(0,g.getRenderingEngines)()[0].getViewports().forEach(e=>{const t=this.orientationMarkers[e.id];if(!t)return;const{actor:n,orientationWidget:o}=t;o?.setEnabled(!1),o?.delete(),n?.delete();e.getRenderingEngine().offscreenMultiRenderWindow.getRenderWindow().render(),e.getRenderingEngine().render(),delete this.orientationMarkers[e.id]})}initViewports(){const e=(0,g.getRenderingEngines)()[0];if(!e)return;let t=e.getViewports();t=(0,u.filterViewportsWithToolEnabled)(t,this.getToolName()),t.forEach(e=>{const t=e.getWidget(this.getToolName());t&&!t.isDeleted()||this.addAxisActorInViewport(e)})}async addAxisActorInViewport(e){const t=e.id;if(!this.updatingOrientationMarker[t]){this.updatingOrientationMarker[t]=!0;const n=this.configuration.overlayMarkerType,o=this.configuration.overlayConfiguration[n];if(this.orientationMarkers[t]){const{actor:n,orientationWidget:o}=this.orientationMarkers[t];e.getRenderer().removeActor(n),o.setEnabled(!1)}let a;1===n?a=this.createAnnotationCube(o):2===n?a=s.Ay.newInstance():3===n&&(a=await this.createCustomActor());const r=e.getRenderer(),l=e.getRenderingEngine().offscreenMultiRenderWindow.getRenderWindow(),{enabled:d,viewportCorner:c,viewportSize:h,minPixelSize:g,maxPixelSize:u}=this.configuration.orientationWidget,m=i.Ay.newInstance({actor:a,interactor:l.getInteractor(),parentRenderer:r});m.setEnabled(d),m.setViewportCorner(c),m.setViewportSize(h),m.setMinPixelSize(g),m.setMaxPixelSize(u),m.updateMarkerOrientation(),this.orientationMarkers[t]={orientationWidget:m,actor:a},e.addWidget(this.getToolName(),m),l.render(),e.getRenderingEngine().render(),this.updatingOrientationMarker[t]=!1}}async createCustomActor(){const e=this.configuration.overlayConfiguration[o.CUSTOM].polyDataURL,t=await fetch(e),n=await t.arrayBuffer(),i=d.Ay.newInstance();i.parseAsArrayBuffer(n),i.update();const a=c.Ay.newInstance();a.shallowCopy(i.getOutputData()),a.getPointData().setActiveScalars("Color");const s=l.Ay.newInstance();s.setInputData(a),s.setColorModeToDirectScalars();const h=r.Ay.newInstance();return h.setMapper(s),h.rotateZ(180),h}createAnnotationCube(e){const t=a.Ay.newInstance();return t.setDefaultStyle({...e.defaultStyle}),t.setXPlusFaceProperty({...e.faceProperties.xPlus}),t.setXMinusFaceProperty({...e.faceProperties.xMinus}),t.setYPlusFaceProperty({...e.faceProperties.yPlus}),t.setYMinusFaceProperty({...e.faceProperties.yMinus}),t.setZPlusFaceProperty({...e.faceProperties.zPlus}),t.setZMinusFaceProperty({...e.faceProperties.zMinus}),t}async createAnnotatedCubeActor(){const e=a.Ay.newInstance(),{faceProperties:t,defaultStyle:n}=this.configuration.annotatedCube;return e.setDefaultStyle(n),Object.keys(t).forEach(n=>{const o=`set${n.charAt(0).toUpperCase()+n.slice(1)}FaceProperty`;e[o](t[n])}),e}}p.toolName="OrientationMarker";const f=p},65566:(e,t,n)=>{"use strict";n.d(t,{A:()=>g});var o=n(3823),i=n(15327),a=n(82056),s=n(77609),r=n(74347),l=n(58640),d=n(6030);const{EPSILON:c}=i.CONSTANTS;class h extends d.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceImageIds:[]}}){super(e,t),this.onSetToolEnabled=()=>{this._init()},this.onSetToolActive=()=>{this._init()},this._init=()=>{const e=this.configuration.sourceImageIds;if(!e?.length)return void console.warn("OverlayGridTool: No sourceImageIds provided in configuration");const t=i.metaData.get("imagePlaneModule",e[0]);if(!t)return void console.warn("OverlayGridTool: No imagePlaneModule found for sourceImageIds");const{frameOfReferenceUID:n}=t,o=(0,s.getToolGroup)(this.toolGroupId).viewportsInfo;if(!o?.length)return void console.warn("OverlayGridTool: No viewports found");const r=(0,a.getAnnotations)(this.getToolName(),n);if(!r?.length){const t=e.map(e=>this.calculateImageIdPointSets(e)),o={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:n,referencedImageId:null},data:{viewportData:new Map,pointSets:t}};(0,a.addAnnotation)(o,n)}(0,l.A)(o.map(({viewportId:e})=>e))},this.calculateImageIdPointSets=e=>{const{imagePositionPatient:t,rows:n,columns:a,rowCosines:s,columnCosines:r,rowPixelSpacing:l,columnPixelSpacing:d}=i.metaData.get("imagePlaneModule",e),c=[...t],h=[...t],g=[...t],u=[...t];o.eR.scaleAndAdd(h,t,r,a*d),o.eR.scaleAndAdd(g,t,s,n*l),o.eR.scaleAndAdd(u,g,r,a*d);return{pointSet1:[c,g,h,u],pointSet2:[c,h,g,u]}},this.renderAnnotation=(e,t)=>{const n=this.configuration.sourceImageIds;let s=!1;if(!n?.length)return s;const{viewport:l,FrameOfReferenceUID:d}=e;if(l.getImageIds().length<2)return s;const c=(0,a.getAnnotations)(this.getToolName(),d);if(!c?.length)return s;const h=c[0],{annotationUID:g}=h,{focalPoint:u,viewPlaneNormal:m}=l.getCamera(),v={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},p=this.getImageIdNormal(n[0]);if(this.isParallel(m,p))return s;const f=i.utilities.planar.planeEquation(m,u),E=h.data.pointSets,w=h.data.viewportData;for(let e=0;e<n.length;e++){const{pointSet1:n,pointSet2:a}=E[e],s=w.get(l.id)||this.initializeViewportData(w,l.id);if(!s.pointSetsToUse[e]){let t=n,r=o.eR.subtract(o.eR.create(),n[0],n[1]);r=o.eR.normalize(o.eR.create(),r),this.isPerpendicular(r,m)&&(t=a),s.pointSetsToUse[e]=t,s.lineStartsWorld[e]=i.utilities.planar.linePlaneIntersection(t[0],t[1],f),s.lineEndsWorld[e]=i.utilities.planar.linePlaneIntersection(t[2],t[3],f)}const d=s.lineStartsWorld[e],c=s.lineEndsWorld[e];v.annotationUID=g;const u=this.getStyle("lineWidth",v,h),p=this.getStyle("lineDash",v,h),I=this.getStyle("color",v,h),C=this.getStyle("shadow",v,h),T=[d,c].map(e=>l.worldToCanvas(e)),b=`${g}-line`,A=`${e}`;(0,r.drawLine)(t,g,A,T[0],T[1],{color:I,width:u,lineDash:p,shadow:C},b)}return s=!0,s},this.initializeViewportData=(e,t)=>(e.set(t,{pointSetsToUse:[],lineStartsWorld:[],lineEndsWorld:[]}),e.get(t)),this.isPerpendicular=(e,t)=>{const n=o.eR.dot(e,t);return Math.abs(n)<c}}isParallel(e,t){return Math.abs(o.eR.dot(e,t))>1-c}getImageIdNormal(e){const{imageOrientationPatient:t}=i.metaData.get("imagePlaneModule",e),n=o.eR.fromValues(t[0],t[1],t[2]),a=o.eR.fromValues(t[3],t[4],t[5]);return o.eR.cross(o.eR.create(),n,a)}}h.toolName="OverlayGrid";const g=h},38782:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(85817),i=n(15327);class a extends o.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t)}touchDragCallback(e){this._dragCallback(e)}mouseDragCallback(e){this._dragCallback(e)}_dragCallback(e){const{element:t,deltaPoints:n}=e.detail,o=(0,i.getEnabledElement)(t),a=n.world;if(0===a[0]&&0===a[1]&&0===a[2])return;const s=o.viewport.getCamera(),{focalPoint:r,position:l}=s,d=[l[0]-a[0],l[1]-a[1],l[2]-a[2]],c=[r[0]-a[0],r[1]-a[1],r[2]-a[2]];o.viewport.setCamera({focalPoint:c,position:d}),o.viewport.render()}}a.toolName="Pan";const s=a},82058:(e,t,n)=>{"use strict";n.d(t,{A:()=>l});var o=n(15327),i=n(3823),a=n(85817),s=n(25963);class r extends a.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.mouseWheelCallback=e=>{const{element:t,wheel:n}=e.detail,i=(0,o.getEnabledElement)(t),{viewport:a}=i,{invert:s}=this.configuration,r=10*n.direction*(s?-1:1);this.setAngle(a,r)},this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,startPoints:a}=e.detail,r=n.world,l=a.world,d=(0,o.getEnabledElement)(t),{viewport:c}=d,h=c.getCamera(),g=[.5*t.clientWidth,.5*t.clientHeight],u=c.canvasToWorld(g);let m=(0,s.A)([l,u],[u,r]);const{viewPlaneNormal:v}=h,p=i.eR.sub(i.eR.create(),u,l),f=i.eR.sub(i.eR.create(),u,r),E=i.eR.cross(i.eR.create(),p,f);i.eR.dot(v,E)>0&&(m=-m),Number.isNaN(m)||this.setAngle(c,m)}setAngle(e,t){const{viewPlaneNormal:n,viewUp:a}=e.getCamera();if(e instanceof o.BaseVolumeViewport){const o=(t+360)%360*Math.PI/180,s=i.pB.identity(new Float32Array(16));i.pB.rotate(s,s,o,n);const r=i.eR.transformMat4(i.eR.create(),a,s);e.setCamera({viewUp:r})}else{const{rotation:n}=e.getViewPresentation();e.setViewPresentation({rotation:(n+t+360)%360})}e.render()}}r.toolName="PlanarRotate";const l=r},85735:(e,t,n)=>{"use strict";n.d(t,{A:()=>v});var o=n(15327),i=n(82056),a=n(29601),s=n(74347),r=n(60810),l=n(58640),d=n(3823),c=n(6030),h=n(84607),g=n(7001),u=n(77609);class m extends c.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,displayThreshold:5,positionSync:!0,disableCursor:!1}}){super(e,t),this.isDrawing=!1,this.isHandleOutsideImage=!1,this._elementWithCursor=null,this._currentCursorWorldPosition=null,this._currentCanvasPosition=null,this._disableCursorEnabled=!1,this.mouseMoveCallback=e=>{const{detail:t}=e,{element:n,currentPoints:o}=t;this._currentCursorWorldPosition=o.world,this._currentCanvasPosition=o.canvas,this._elementWithCursor=n;const i=this.getActiveAnnotation(n);return null===i?(this.createInitialAnnotation(o.world,n),!1):(this.updateAnnotationPosition(n,i),!1)},this.createInitialAnnotation=(e,t)=>{const n=(0,o.getEnabledElement)(t);if(!n)throw new Error("No enabled element found");const{viewport:a,renderingEngine:s}=n;this.isDrawing=!0;const d=a.getCamera(),{viewPlaneNormal:c,viewUp:h}=d;if(!c||!h)throw new Error("Camera not found");const g=this.getReferencedImageId(a,e,c,h),u=a.getFrameOfReferenceUID(),m={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...h],FrameOfReferenceUID:u,referencedImageId:g},data:{label:"",handles:{points:[[...e]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}};if((0,i.getAnnotations)(this.getToolName(),t).length>0)return null;if(null===(0,i.addAnnotation)(m,t))return;const v=(0,r.getViewportIdsWithToolToRender)(t,this.getToolName(),!1);(0,l.A)(v)},this.onCameraModified=e=>{const t=e.detail,{element:n,previousCamera:i,camera:a}=t,s=(0,o.getEnabledElement)(n).viewport;if(n!==this._elementWithCursor)return;const r=i.focalPoint,l=a.viewPlaneNormal,d=a.focalPoint,c=[0,0,0];if(h.Ay.subtract(d,r,c),0===c.reduce((e,t)=>e+t,0))return;const g=h.Ay.dot(c,l);if(Math.abs(g)<.01)return;if(!this._currentCanvasPosition)return;const u=s.canvasToWorld(this._currentCanvasPosition);this._currentCursorWorldPosition=u,this.updateAnnotationPosition(n,this.getActiveAnnotation(n))},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o,FrameOfReferenceUID:r}=e,l=this._elementWithCursor===o.element;this.configuration.positionSync&&!l&&this.updateViewportImage(o);const{element:d}=o;let c=(0,i.getAnnotations)(this.getToolName(),d);if(!c?.length)return n;if(c=this.filterInteractableAnnotationsForElement(d,c),!c?.length)return n;const h={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<c.length;e++){const i=c[e],{annotationUID:r,data:d}=i,{handles:g}=d,{points:u}=g;if(!r)return n;h.annotationUID=r;const m=parseFloat(this.getStyle("lineWidth",h,i)),v=m,p=this.getStyle("lineDash",h,i),f=this.getStyle("color",h,i);if(u[0].some(e=>isNaN(e)))return n;const E=u.map(e=>o.worldToCanvas(e));if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,a.isAnnotationVisible)(r))continue;const w={upper:"upper",right:"right",lower:"lower",left:"left"},[I,C]=E[0],T=l?20:7,b=l?5:7;(0,s.drawLine)(t,r,w.upper,[I,C-(T/2+b)],[I,C-T/2],{color:f,lineDash:p,lineWidth:v}),(0,s.drawLine)(t,r,w.lower,[I,C+(T/2+b)],[I,C+T/2],{color:f,lineDash:p,lineWidth:v}),(0,s.drawLine)(t,r,w.right,[I+(T/2+b),C],[I+T/2,C],{color:f,lineDash:p,lineWidth:v}),(0,s.drawLine)(t,r,w.left,[I-(T/2+b),C],[I-T/2,C],{color:f,lineDash:p,lineWidth:v}),n=!0}return n},this._disableCursorEnabled=this.configuration.disableCursor}onSetToolActive(){if(this._disableCursorEnabled=this.configuration.disableCursor,!this._disableCursorEnabled)return;const e=(0,u.getToolGroup)(this.toolGroupId).viewportsInfo;if(!e)return;e.map(e=>(0,o.getEnabledElementByIds)(e.viewportId,e.renderingEngineId)).forEach(e=>{e&&(0,g.hideElementCursor)(e.viewport.element)})}onSetToolDisabled(){if(!this._disableCursorEnabled)return;const e=(0,u.getToolGroup)(this.toolGroupId).viewportsInfo;if(!e)return;e.map(e=>(0,o.getEnabledElementByIds)(e.viewportId,e.renderingEngineId)).forEach(e=>{e&&(0,g.resetElementCursor)(e.viewport.element)})}getActiveAnnotation(e){const t=(0,i.getAnnotations)(this.getToolName(),e);if(!t.length)return null;return t[0]}updateAnnotationPosition(e,t){const n=this._currentCursorWorldPosition;if(!n)return;if(!t.data?.handles?.points)return;t.data.handles.points=[[...n]],t.invalidated=!0;const i=(0,r.getViewportIdsWithToolToRender)(e,this.getToolName(),!1);(0,o.getEnabledElement)(e)&&(0,l.A)(i)}filterInteractableAnnotationsForElement(e,t){if(!(t instanceof Array)||0===t.length)return[];const n=t[0],i=(0,o.getEnabledElement)(e)?.viewport;if(!i)return[];const a=i.getCamera(),{viewPlaneNormal:s,focalPoint:r}=a;if(!s||!r)return[];const l=n.data?.handles?.points;if(!(l instanceof Array)||1!==l.length)return[];const d=l[0],c=o.utilities.planar.planeEquation(s,r);return o.utilities.planar.planeDistanceToPoint(c,d)<this.configuration.displayThreshold?[n]:[]}updateViewportImage(e){const t=this._currentCursorWorldPosition;if(t&&!t.some(e=>isNaN(e)))if(e instanceof o.StackViewport){const n=o.utilities.getClosestStackImageIndexForPoint(t,e);if(null===n)return;n!==e.getCurrentImageIdIndex()&&e.setImageIdIndex(n)}else if(e instanceof o.VolumeViewport){const{focalPoint:n,viewPlaneNormal:i}=e.getCamera();if(!n||!i)return;const a=o.utilities.planar.planeEquation(i,n),s=o.utilities.planar.planeDistanceToPoint(a,t,!0);if(Math.abs(s)<.5)return;const r=d.eR.normalize(d.eR.create(),d.eR.fromValues(...i)),l=d.eR.scale(d.eR.create(),r,s),c=d.eR.add(d.eR.create(),d.eR.fromValues(...n),l);if(!0){e.setCamera({focalPoint:c});const t=e.getRenderingEngine();t&&t.renderViewport(e.id)}}}}m.toolName="ReferenceCursors";const v=m},36797:(e,t,n)=>{"use strict";n.d(t,{A:()=>g});var o=n(3823),i=n(15327),a=n(82056),s=n(74347),r=n(60810),l=n(58640),d=n(6030);const{EPSILON:c}=i.CONSTANTS;class h extends d.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{sourceViewportId:"",enforceSameFrameOfReference:!0,showFullDimension:!1}}){super(e,t),this.editData=null,this._init=()=>{const e=(0,i.getRenderingEngines)()[0];if(!e)return;let t=e.getViewports();t=(0,r.filterViewportsWithToolEnabled)(t,this.getToolName());const n=e.getViewport(this.configuration.sourceViewportId);if(!n?.getImageData())return;const{element:o}=n,{viewUp:s,viewPlaneNormal:d}=n.getCamera(),c=i.utilities.getViewportImageCornersInWorld(n);let h=this.editData?.annotation;const g=n.getFrameOfReferenceUID();if(h)this.editData.annotation.data.handles.points=c;else{const e={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...d],viewUp:[...s],FrameOfReferenceUID:g,referencedImageId:null},data:{handles:{points:c}}};(0,a.addAnnotation)(e,o),h=e}this.editData={sourceViewportId:n.id,renderingEngine:e,annotation:h},(0,l.A)(t.filter(e=>e.id!==n.id).map(e=>e.id))},this.onSetToolEnabled=()=>{this._init()},this.onSetToolConfiguration=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,t)=>{const{viewport:n}=e;if(!this.editData)return!1;const{annotation:a,sourceViewportId:r}=this.editData;let l=!1;const{viewport:d}=(0,i.getEnabledElementByViewportId)(r)||{};if(!d)return l;if(d.id===n.id)return l;if(!a||!a?.data?.handles?.points)return l;if(this.configuration.enforceSameFrameOfReference&&d.getFrameOfReferenceUID()!==n.getFrameOfReferenceUID())return l;const c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},h=a.data.handles.points[0],g=a.data.handles.points[1],u=a.data.handles.points[2],m=a.data.handles.points[3],{focalPoint:v,viewPlaneNormal:p,viewUp:f}=n.getCamera(),{viewPlaneNormal:E}=d.getCamera();if(this.isParallel(p,E))return l;const w=i.utilities.planar.planeEquation(p,v),I=[h,u,g,m],C=[h,g,u,m];let T=I,b=o.eR.subtract(o.eR.create(),I[0],I[1]);b=o.eR.normalize(o.eR.create(),b);let A=o.eR.subtract(o.eR.create(),I[2],I[0]);A=o.eR.normalize(o.eR.create(),A);const _=o.eR.cross(o.eR.create(),b,A);if(this.isParallel(_,p))return l;this.isPerpendicular(b,p)&&(T=C);const S=i.utilities.planar.linePlaneIntersection(T[0],T[1],w),D=i.utilities.planar.linePlaneIntersection(T[2],T[3],w),{annotationUID:y}=a;c.annotationUID=y;const M=this.getStyle("lineWidth",c,a),x=this.getStyle("lineDash",c,a),R=this.getStyle("color",c,a),P=this.getStyle("shadow",c,a);let L=[S,D].map(e=>n.worldToCanvas(e));if(this.configuration.showFullDimension&&(L=this.handleFullDimension(n,S,p,f,D,L)),L.length<2)return l;const k=`${y}-line`;return(0,s.drawLine)(t,y,"1",L[0],L[1],{color:R,width:M,lineDash:x,shadow:P},k),l=!0,l},this.isPerpendicular=(e,t)=>{const n=o.eR.dot(e,t);return Math.abs(n)<c}}handleFullDimension(e,t,n,o,a,s){e.getRenderingEngine();const r=this.getTargetId(e),l=this.getTargetImageData(r),d=this.getReferencedImageId(e,t,n,o);if(d&&l)try{const{imageData:n,dimensions:o}=l,[r,c,h,g]=[n.indexToWorld([0,0,0]),n.indexToWorld([o[0]-1,0,0]),n.indexToWorld([o[0]-1,o[1]-1,0]),n.indexToWorld([0,o[1]-1,0])].map(e=>i.utilities.worldToImageCoords(d,e)),[u,m]=[t,a].map(e=>i.utilities.worldToImageCoords(d,e));s=[[r,c],[c,h],[g,h],[r,g]].map(([e,t])=>this.intersectInfiniteLines(e,t,u,m)).filter(e=>e&&this.isInBound(e,o)).map(t=>{const n=i.utilities.imageToWorldCoords(d,t);return e.worldToCanvas(n)})}catch(e){console.log(e)}return s}intersectInfiniteLines(e,t,n,o){const[i,a]=e,[s,r]=t,[l,d]=n,[h,g]=o,u=r-a,m=i-s,v=s*a-i*r,p=g-d,f=l-h,E=h*d-l*g;if(Math.abs(u*f-p*m)<c)return;return[(m*E-f*v)/(u*f-p*m),(p*v-u*E)/(u*f-p*m)]}isParallel(e,t){return Math.abs(o.eR.dot(e,t))>1-c}isInBound(e,t){return e[0]>=0&&e[0]<=t[0]&&e[1]>=0&&e[1]<=t[1]}}h.toolName="ReferenceLines";const g=h},26039:(e,t,n)=>{"use strict";n.d(t,{A:()=>h});var o=n(6030),i=n(3823),a=n(15327),s=n(82056),r=n(74347),l=n(77609);const d=[];class c extends o.A{constructor(e={},t={configuration:{viewportId:"",scaleLocation:"bottom"}}){super(e,t),this.editData=null,this._init=()=>{const e=(0,a.getRenderingEngines)()[0];if(!e)return;const t=(0,l.getToolGroup)(this.toolGroupId).viewportsInfo;if(!t)return;const n=t.map(e=>(0,a.getEnabledElementByIds)(e.viewportId,e.renderingEngineId));let{viewport:o}=n[0];const{FrameOfReferenceUID:i}=n[0];if(this.configuration.viewportId&&n.forEach(e=>{e.viewport.id==this.configuration.viewportId&&(o=e.viewport)}),!o)return;const{viewUp:r,viewPlaneNormal:c}=o.getCamera(),h=a.utilities.getViewportImageCornersInWorld(o);let g=this.editData?.annotation;const u=(0,s.getAnnotations)(this.getToolName(),o.element);u.length&&(g=u.filter(e=>e.data.viewportId==o.id)[0]),n.forEach(e=>{const{viewport:t}=e;if(!d.includes(t.id)){const e={metadata:{toolName:this.getToolName(),viewPlaneNormal:[...c],viewUp:[...r],FrameOfReferenceUID:i,referencedImageId:null},data:{handles:{points:a.utilities.getViewportImageCornersInWorld(t)},viewportId:t.id}};d.push(t.id),(0,s.addAnnotation)(e,t.element),g=e}}),this.editData?.annotation&&this.editData.annotation.data.viewportId==o.id&&(this.editData.annotation.data.handles.points=h,this.editData.annotation.data.viewportId=o.id),this.editData={viewport:o,renderingEngine:e,annotation:g}},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this.configuration.viewportId=e.detail.viewportId,this._init()},this.computeScaleSize=(e,t,n)=>{const o=[16e3,8e3,4e3,2e3,1e3,500,250,100,50,25,10,5,2];let i;return i="top"==n||"bottom"==n?o.filter(t=>t<.6*e&&t>.2*e):o.filter(e=>e<.6*t&&e>.2*t),i[0]},this.computeEndScaleTicks=(e,t)=>{const n={bottom:[[0,-10],[0,-10]],top:[[0,10],[0,10]],left:[[0,0],[10,0]],right:[[0,0],[-10,0]]};return{endTick1:[[e[1][0]+n[t][0][0],e[1][1]+n[t][0][0]],[e[1][0]+n[t][1][0],e[1][1]+n[t][1][1]]],endTick2:[[e[0][0]+n[t][0][0],e[0][1]+n[t][0][0]],[e[0][0]+n[t][1][0],e[0][1]+n[t][1][1]]]}},this.computeInnerScaleTicks=(e,t,n,o,i)=>{let a;"bottom"==t||"top"==t?a=i[0][0]-o[0][0]:"left"!=t&&"right"!=t||(a=i[0][1]-o[0][1]);const s=[],r=[],l=[];let d=e;e>=50&&(d=e/10);const c=a/d;for(let e=0;e<d-1;e++){const i={bottom:[[c*(e+1),0],[c*(e+1),5]],top:[[c*(e+1),0],[c*(e+1),-5]],left:[[0,c*(e+1)],[-5,c*(e+1)]],right:[[0,c*(e+1)],[5,c*(e+1)]]};s.push(`${n}-tick${e}`),r.push(`tick${e}`),(e+1)%5==0?l.push([[o[0][0]+i[t][0][0],o[0][1]+i[t][0][1]],[o[1][0]+i[t][0][0],o[1][1]+i[t][0][1]]]):l.push([[o[0][0]+i[t][0][0],o[0][1]+i[t][0][1]],[o[1][0]+i[t][1][0],o[1][1]+i[t][1][1]]])}return{tickIds:s,tickUIDs:r,tickCoordinates:l}},this.computeWorldScaleCoordinates=(e,t,n)=>{let o,a=i.eR.subtract(i.eR.create(),n[0],n[1]);a=i.eR.normalize(i.eR.create(),a);let s=i.eR.subtract(i.eR.create(),n[2],n[0]);s=i.eR.normalize(i.eR.create(),s);const r={bottom:[n[1],n[2]],top:[n[0],n[3]],right:[n[2],n[3]],left:[n[0],n[1]]},l=i.eR.add(i.eR.create(),r[t][0],r[t][0]).map(e=>e/2),d=e/2/Math.sqrt(Math.pow(a[0],2)+Math.pow(a[1],2)+Math.pow(a[2],2));return"top"==t||"bottom"==t?o=[i.eR.subtract(i.eR.create(),l,s.map(e=>e*d)),i.eR.add(i.eR.create(),l,s.map(e=>e*d))]:"left"!=t&&"right"!=t||(o=[i.eR.add(i.eR.create(),l,a.map(e=>e*d)),i.eR.subtract(i.eR.create(),l,a.map(e=>e*d))]),o},this.computeCanvasScaleCoordinates=(e,t,n,o,i)=>{let a;if("top"==i||"bottom"==i){const o=t[0][0]-t[1][0];a=[[e.width/2-o/2,n.height],[e.width/2+o/2,n.height]]}else if("left"==i||"right"==i){const n=t[0][1]-t[1][1];a=[[o.width,e.height/2-n/2],[o.width,e.height/2+n/2]]}return a},this.computeScaleBounds=(e,t,n,o)=>{const i=t*Math.min(1e3,e.width),a=n*Math.min(1e3,e.height),s={bottom:[-a,-i],top:[a,i],left:[a,i],right:[-a,-i]},r={bottom:[e.height,e.width],top:[0,e.width],left:[e.height,0],right:[e.height,e.width]};return{height:r[o][0]+s[o][0],width:r[o][1]+s[o][1]}}}renderAnnotation(e,t){if(!this.editData||!this.editData.viewport)return;const n=this.configuration.scaleLocation,{viewport:o}=e,a=(0,s.getAnnotations)(this.getToolName(),o.element).filter(e=>e.data.viewportId==o.id)[0],l=e.viewport.canvas,d=!1;if(!o)return d;const c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},h={width:l.width/window.devicePixelRatio||1,height:l.height/window.devicePixelRatio||1},g=a.data.handles.points[0],u=a.data.handles.points[1],m=a.data.handles.points[2],v=a.data.handles.points[3],p=[g,m,u,v],f=i.eR.distance(m,v),E=i.eR.distance(g,m),w=this.computeScaleBounds(h,.05,.05,n),I=this.computeScaleBounds(h,.05,.05,n),C=this.computeScaleSize(f,E,n),T=this.computeWorldScaleCoordinates(C,n,p).map(e=>o.worldToCanvas(e)),b=this.computeCanvasScaleCoordinates(h,T,I,w,n),A=this.computeEndScaleTicks(b,n),{annotationUID:_}=a;c.annotationUID=_;const S=this.getStyle("lineWidth",c,a),D=this.getStyle("lineDash",c,a),y=this.getStyle("color",c,a),M=this.getStyle("shadow",c,a),x=`${_}-scaleline`;(0,r.drawLine)(t,_,"1",b[0],b[1],{color:y,width:S,lineDash:D,shadow:M},x);const R=`${_}-left`;(0,r.drawLine)(t,_,"2",A.endTick1[0],A.endTick1[1],{color:y,width:S,lineDash:D,shadow:M},R);const P=`${_}-right`;(0,r.drawLine)(t,_,"3",A.endTick2[0],A.endTick2[1],{color:y,width:S,lineDash:D,shadow:M},P);const L={bottom:[-10,-42],top:[-12,-35],left:[-40,-20],right:[-50,-20]},k=[b[0][0]+L[n][0],b[0][1]+L[n][1]],O=this._getTextLines(C),{tickIds:U,tickUIDs:N,tickCoordinates:V}=this.computeInnerScaleTicks(C,n,_,A.endTick1,A.endTick2);for(let e=0;e<N.length;e++)(0,r.drawLine)(t,_,N[e],V[e][0],V[e][1],{color:y,width:S,lineDash:D,shadow:M},U[e]);return(0,r.drawTextBox)(t,_,"text0",O,[k[0],k[1]],{fontFamily:"Helvetica Neue, Helvetica, Arial, sans-serif",fontSize:"14px",lineDash:"2,3",lineWidth:"1",shadow:!0,color:y}),d}_getTextLines(e){let t,n;e>=50?(t=e/10,n=" cm"):(t=e,n=" mm");return[t.toString().concat(n)]}}c.toolName="ScaleOverlay";const h=c},3751:(e,t,n)=>{"use strict";n.d(t,{A:()=>f});var o=n(15327),i=n(85817),a=n(6802),s=n(95527),r=n(99737),l=n(58640),d=n(7001),c=n(76712),h=n(44049),g=n(16175),u=n(13271),m=n(77609);class v extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{minSpacing:1,referencedToolNames:["PlanarFreehandROI","PlanarFreehandContourSegmentationTool"],toolShape:"circle",referencedToolName:"PlanarFreehandROI",updateCursorSize:"dynamic"}}){super(e,t),this.registeredShapes=new Map,this.isActive=!1,this.commonData={activeAnnotationUID:null,viewportIdsToRender:[],isEditingOpenContour:!1,canvasLocation:void 0},this.preMouseDownCallback=e=>{const t=e.detail,n=t.element;if(this.configureToolSize(e),this.selectFreehandTool(t),null!==this.commonData.activeAnnotationUID)return this.isActive=!0,(0,d.hideElementCursor)(n),this.activateModify(n),!0},this.mouseMoveCallback=e=>{this.mode===r.ToolModes.Active?(this.configureToolSize(e),this.updateCursor(e)):this.commonData.canvasLocation=void 0},this.endCallback=e=>{const t=e.detail,{element:n}=t,i=this.configuration,a=(0,o.getEnabledElement)(n);this.isActive=!1,this.deactivateModify(n),(0,d.resetElementCursor)(n);const{renderingEngineId:s,viewportId:l}=a,c=(0,m.getToolGroupForViewport)(l,s).getToolInstance(i.referencedToolName),g=this.filterSculptableAnnotationsForElement(n).find(e=>e.annotationUID===this.commonData.activeAnnotationUID);c.configuration.calculateStats&&(g.invalidated=!0),(0,h.triggerAnnotationModified)(g,n,r.ChangeTypes.HandlesUpdated)},this.dragCallback=e=>{const t=e.detail,n=t.element;this.updateCursor(e);const o=this.filterSculptableAnnotationsForElement(n),i=o.find(e=>e.annotationUID===this.commonData.activeAnnotationUID);if(!o?.length||!this.isActive)return;const a=i.data.contour.polyline;this.sculpt(t,a)},this.registerShapes(g.A.shapeName,g.A),this.setToolShape(this.configuration.toolShape)}registerShapes(e,t){const n=new t;this.registeredShapes.set(e,n)}sculpt(e,t){const n=this.configuration,i=e.element,a=(0,o.getEnabledElement)(i),{viewport:s}=a,r=this.registeredShapes.get(this.selectedShape);this.sculptData={mousePoint:e.currentPoints.world,mouseCanvasPoint:e.currentPoints.canvas,deltaWorld:e.deltaPoints.world,points:t,maxSpacing:r.getMaxSpacing(n.minSpacing),element:i};const l=r.pushHandles(s,this.sculptData);void 0!==l.first&&this.insertNewHandles(l)}interpolatePointsWithinMaxSpacing(e,t,n,i){const{element:a}=this.sculptData,r=(0,o.getEnabledElement)(a),{viewport:l}=r,d=p(e+1,t.length),c=l.worldToCanvas(t[e]),h=l.worldToCanvas(t[d]);s.point.distanceToPoint(c,h)>i&&n.push(e)}updateCursor(e){const t=e.detail,n=t.element,i=(0,o.getEnabledElement)(n),{renderingEngine:a,viewport:s}=i;this.commonData.viewportIdsToRender=[s.id];const r=this.filterSculptableAnnotationsForElement(n);if(!r?.length)return;const d=r.find(e=>e.annotationUID===this.commonData.activeAnnotationUID);if(this.commonData.canvasLocation=t.currentPoints.canvas,this.isActive)d.highlighted=!0;else{const e=this.registeredShapes.get(this.selectedShape),n=t.currentPoints.canvas;"dynamic"===this.configuration.updateCursorSize&&e.updateToolSize(n,s,d)}(0,l.t)(this.commonData.viewportIdsToRender)}filterSculptableAnnotationsForElement(e){const t=this.configuration,n=(0,o.getEnabledElement)(e),{renderingEngineId:i,viewportId:s}=n,r=[],l=(0,m.getToolGroupForViewport)(s,i).getToolInstance(t.referencedToolName);return t.referencedToolNames.forEach(t=>{const n=(0,a.Rh)(t,e);n&&r.push(...n)}),l.filterInteractableAnnotationsForElement(e,r)}configureToolSize(e){this.registeredShapes.get(this.selectedShape).configureToolSize(e)}insertNewHandles(e){const t=this.findNewHandleIndices(e);let n=0;for(let e=0;e<t?.length;e++){const o=t[e]+1+n;this.insertHandleRadially(o),n++}}findNewHandleIndices(e){const{points:t,maxSpacing:n}=this.sculptData,o=[];for(let i=e.first;i<=e.last;i++)this.interpolatePointsWithinMaxSpacing(i,t,o,n);return o}insertHandleRadially(e){const{points:t}=this.sculptData;if(e>t.length-1&&this.commonData.isEditingOpenContour)return;const n=this.registeredShapes.get(this.selectedShape),o=e-1,i=p(e,t.length),a=n.getInsertPosition(o,i,this.sculptData);t.splice(e,0,a)}selectFreehandTool(e){const t=this.getClosestFreehandToolOnElement(e);void 0!==t&&(this.commonData.activeAnnotationUID=t)}getClosestFreehandToolOnElement(e){const{element:t}=e,n=(0,o.getEnabledElement)(t),{viewport:i}=n,a=this.configuration,s=this.filterSculptableAnnotationsForElement(t);if(!s?.length)return;const r=e.currentPoints.canvas,l={distance:1/0,toolIndex:void 0,annotationUID:void 0};for(let e=0;e<s?.length;e++){if(s[e].isLocked||!s[e].isVisible)continue;const t=(0,u.X)(i,s[e],r);-1!==t&&(t<l.distance&&(l.distance=t,l.toolIndex=e,l.annotationUID=s[e].annotationUID))}return this.commonData.isEditingOpenContour=!s[l.toolIndex].data.contour.closed,a.referencedToolName=s[l.toolIndex].metadata.toolName,l.annotationUID}activateModify(e){e.addEventListener(r.Events.MOUSE_UP,this.endCallback),e.addEventListener(r.Events.MOUSE_CLICK,this.endCallback),e.addEventListener(r.Events.MOUSE_DRAG,this.dragCallback),e.addEventListener(r.Events.TOUCH_TAP,this.endCallback),e.addEventListener(r.Events.TOUCH_END,this.endCallback),e.addEventListener(r.Events.TOUCH_DRAG,this.dragCallback)}deactivateModify(e){e.removeEventListener(r.Events.MOUSE_UP,this.endCallback),e.removeEventListener(r.Events.MOUSE_CLICK,this.endCallback),e.removeEventListener(r.Events.MOUSE_DRAG,this.dragCallback),e.removeEventListener(r.Events.TOUCH_TAP,this.endCallback),e.removeEventListener(r.Events.TOUCH_END,this.endCallback),e.removeEventListener(r.Events.TOUCH_DRAG,this.dragCallback)}setToolShape(e){this.selectedShape=this.registeredShapes.get(e)??g.A.shapeName}renderAnnotation(e,t){const{viewport:n}=e,{element:o}=n,i=this.commonData.viewportIdsToRender;if(!this.commonData.canvasLocation||this.mode!==r.ToolModes.Active||!i.includes(n.id))return;const a=this.filterSculptableAnnotationsForElement(o);if(!a?.length)return;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};let l=(0,c.h)("color",s,r.AnnotationStyleStates.Default,this.mode);this.isActive&&(l=(0,c.h)("color",s,r.AnnotationStyleStates.Highlighted,this.mode));this.registeredShapes.get(this.selectedShape).renderShape(t,this.commonData.canvasLocation,{color:l})}}const p=(e,t)=>(e+t)%t;v.toolName="SculptorTool";const f=v},32302:(e,t,n)=>{"use strict";n.d(t,{A:()=>m});var o=n(15327),i=n(82056),a=n(74347),s=n(77609),r=n(58640),l=n(6030),d=(n(82216),n(38726)),c=n(53860);class h extends l.A{constructor(e={},t={configuration:{opacity:.5}}){super(e,t),this._init=()=>{const e=(0,s.getToolGroup)(this.toolGroupId).viewportsInfo;if(!e?.length)return void console.warn(this.getToolName()+"Tool: No viewports found");const t=(0,o.getRenderingEngine)(e[0].renderingEngineId)?.getViewport(e[0].viewportId);if(!t)return;const n=t.getFrameOfReferenceUID(),a=(0,i.getAnnotations)(this.getToolName(),n);if(!a?.length){const t=new Map;!function(e,t){t.forEach(({viewportId:t,renderingEngineId:n})=>{const i=(0,o.getRenderingEngine)(n)?.getViewport(t);g(e,i)})}(t,e);const a={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),FrameOfReferenceUID:n,referencedImageId:null},data:{actorsWorldPointsMap:t}};(0,i.addAnnotation)(a,n)}(0,r.A)(e.map(({viewportId:e})=>e))},this.onSetToolEnabled=()=>{this._init()},this.onCameraModified=e=>{this._init()},this.renderAnnotation=(e,t)=>{const{viewport:n,FrameOfReferenceUID:o}=e;let s=!1;const r=(0,i.getAnnotations)(this.getToolName(),o);if(!r?.length)return s;const l=r[0],{annotationUID:d}=l,c=l.data.actorsWorldPointsMap;g(c,n);const h=n.getActors(),m=u(n);return h.forEach(e=>{if(!e?.clippingFilter)return;const o=c.get(e.uid);if(!o)return;if(!o.get(m))return;let i=1;const{worldPointsSet:s,color:r}=o.get(m);for(let o=0;o<s.length;o++){const l=s[o].map(e=>n.worldToCanvas(e)),c={color:r,fillColor:r,fillOpacity:this.configuration.opacity,closePath:!0,lineWidth:2},h=e.uid+"#"+i;(0,a.drawPath)(t,d,h,l,c),i++}}),s=!0,s}}}function g(e,t){const n=t.getActors(),o=u(t);n.forEach(t=>{if(!t?.clippingFilter)return;let n=e.get(t.uid);if(n||(n=new Map,e.set(t.uid,n)),!n.get(o)){const e=t.clippingFilter.getOutputData(),i=c.polyDataUtils.getPolyDataPoints(e);if(!i)return;const a=function(e){function t(e){let t=Math.floor(255*e).toString(16);return 1===t.length&&(t="0"+t),t}return"#"+t(e[0])+t(e[1])+t(e[2])}(t.actor.getProperty().getColor());n.set(o,{worldPointsSet:i,color:a})}})}function u(e){const{viewPlaneNormal:t}=e.getCamera(),n=e.getCurrentImageIdIndex();return`${e.id}-${(0,d.l)(t)}-${n}`}h.toolName="SegmentationIntersection";const m=h},89460:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(15327),i=n(85817);class a extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{invert:!1,debounceIfNotLoaded:!0,loop:!1}}){super(e,t),this.deltaY=1}mouseWheelCallback(e){this._scroll(e)}mouseDragCallback(e){this._dragCallback(e)}touchDragCallback(e){this._dragCallback(e)}_dragCallback(e){this._scrollDrag(e)}_scrollDrag(e){const{deltaPoints:t,viewportId:n,renderingEngineId:i}=e.detail,{viewport:a}=(0,o.getEnabledElementByIds)(n,i),{debounceIfNotLoaded:s,invert:r,loop:l}=this.configuration,d=t.canvas[1];let c;a instanceof o.VolumeViewport&&(c=a.getVolumeId());const h=this._getPixelPerImage(a),g=d+this.deltaY;if(h)if(Math.abs(g)>=h){const e=Math.round(g/h);o.utilities.scroll(a,{delta:r?-e:e,volumeId:c,debounceLoading:s,loop:l}),this.deltaY=g%h}else this.deltaY=g}_scroll(e){const{wheel:t,element:n}=e.detail,{direction:i}=t,{invert:a}=this.configuration,{viewport:s}=(0,o.getEnabledElement)(n),r=i*(a?-1:1);o.utilities.scroll(s,{delta:r,debounceLoading:this.configuration.debounceIfNotLoaded,loop:this.configuration.loop,volumeId:s instanceof o.BaseVolumeViewport?s.getVolumeId():void 0,scrollSlabs:this.configuration.scrollSlabs})}_getPixelPerImage(e){const{element:t}=e,n=e.getNumberOfSlices();return Math.max(2,t.offsetHeight/Math.max(n,8))}}a.toolName="StackScroll";const s=a},26884:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var o=n(84607),i=n(99737),a=n(15327),s=n(3823),r=n(85817),l=n(77609);class d extends r.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{rotateIncrementDegrees:2,rotateSampleDistanceFactor:2}}){super(e,t),this._resizeObservers=new Map,this._hasResolutionChanged=!1,this.preMouseDownCallback=e=>{const t=e.detail,{element:n}=t,o=(0,a.getEnabledElement)(n),{viewport:i}=o,s=i.getDefaultActor().actor.getMapper();if(!("getSampleDistance"in s||"getCurrentSampleDistance"in s))return!0;const r=s.getSampleDistance();if(!this._hasResolutionChanged){const{rotateSampleDistanceFactor:e}=this.configuration;s.setSampleDistance(r*e),this._hasResolutionChanged=!0,null!==this.cleanUp&&document.removeEventListener("mouseup",this.cleanUp),this.cleanUp=()=>{s.setSampleDistance(r),i.render(),this._hasResolutionChanged=!1},document.addEventListener("mouseup",this.cleanUp,{once:!0})}return!0},this._getViewportsInfo=()=>(0,l.getToolGroup)(this.toolGroupId).viewportsInfo,this.onSetToolActive=()=>{const e=()=>{this._getViewportsInfo().forEach(({viewportId:e,renderingEngineId:t})=>{if(!this._resizeObservers.has(e)){const{viewport:n}=(0,a.getEnabledElementByIds)(e,t)||{viewport:null};if(!n)return;const{element:o}=n,i=new ResizeObserver(()=>{const n=(0,a.getEnabledElementByIds)(e,t);if(!n)return;const{viewport:o}=n,i=o.getViewPresentation();o.resetCamera(),o.setViewPresentation(i),o.render()});i.observe(o),this._resizeObservers.set(e,i)}})};e(),this._viewportAddedListener=t=>{t.detail.toolGroupId===this.toolGroupId&&e()},a.eventTarget.addEventListener(i.Events.TOOLGROUP_VIEWPORT_ADDED,this._viewportAddedListener)},this.onSetToolDisabled=()=>{this._resizeObservers.forEach((e,t)=>{e.disconnect(),this._resizeObservers.delete(t)}),this._viewportAddedListener&&(a.eventTarget.removeEventListener(i.Events.TOOLGROUP_VIEWPORT_ADDED,this._viewportAddedListener),this._viewportAddedListener=null)},this.rotateCamera=(e,t,n,o)=>{const i=e.getVtkActiveCamera(),a=i.getViewUp(),r=i.getFocalPoint(),l=i.getPosition(),d=[0,0,0],c=[0,0,0],h=[0,0,0],g=s.pB.identity(new Float32Array(16));s.pB.translate(g,g,t),s.pB.rotate(g,g,o,n),s.pB.translate(g,g,[-t[0],-t[1],-t[2]]),s.eR.transformMat4(d,l,g),s.eR.transformMat4(c,r,g),s.pB.identity(g),s.pB.rotate(g,g,o,n),s.eR.transformMat4(h,a,g),e.setCamera({position:d,viewUp:h,focalPoint:c})},this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}_dragCallback(e){const{element:t,currentPoints:n,lastPoints:i}=e.detail,s=n.canvas,r=i.canvas,{rotateIncrementDegrees:l}=this.configuration,d=(0,a.getEnabledElement)(t),{viewport:c}=d,h=c.getCamera(),g=t.clientWidth,u=t.clientHeight,m=[s[0]/g,s[1]/u],v=[r[0]/g,r[1]/u],p=[.5*g,.5*u],f=c.canvasToWorld(p),E=(1+Math.abs(.5))**2,w=[v[0],0,0],I=[m[0],0,0],C=w[0]**2,T=I[0]**2,b=C>E?0:Math.sqrt(E-C),A=T>E?0:Math.sqrt(E-T),_=[w[0],0,b];o.Ay.normalize(_);const S=[I[0],0,A];o.Ay.normalize(S);const D=o.Ay.dot(_,S);if(Math.abs(D)>1e-4){const e=-2*Math.acos(o.Ay.clampValue(D,-1,1))*Math.sign(m[0]-v[0])*l,t=h.viewUp,n=h.viewPlaneNormal,i=[0,0,0],a=[0,0,0];o.Ay.cross(t,n,i),o.Ay.normalize(i),o.Ay.cross(n,i,a),o.Ay.normalize(a),o.Ay.normalize(t),this.rotateCamera(c,f,a,e);const s=(v[1]-m[1])*l;this.rotateCamera(c,f,i,s),c.render()}}}d.toolName="TrackballRotate";const c=d},30588:(e,t,n)=>{"use strict";n.d(t,{A:()=>l});var o=n(85817),i=n(15327),a=n(3823);const s=[0,0,1];class r extends o.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{direction:s,rotateIncrementDegrees:30}}){super(e,t)}mouseWheelCallback(e){const{element:t,wheel:n}=e.detail,o=(0,i.getEnabledElement)(t),{viewport:s}=o,{direction:r,rotateIncrementDegrees:l}=this.configuration,d=s.getCamera(),{viewUp:c,position:h,focalPoint:g}=d,{direction:u}=n,[m,v,p]=g,[f,E,w]=r,I=u*(l*Math.PI)/180,C=[0,0,0],T=[0,0,0],b=[0,0,0],A=a.pB.identity(new Float32Array(16));a.pB.translate(A,A,[m,v,p]),a.pB.rotate(A,A,I,[f,E,w]),a.pB.translate(A,A,[-m,-v,-p]),a.eR.transformMat4(C,h,A),a.eR.transformMat4(T,g,A),a.pB.identity(A),a.pB.rotate(A,A,I,[f,E,w]),a.eR.transformMat4(b,c,A),s.setCamera({position:C,viewUp:b,focalPoint:T}),s.render()}}r.toolName="VolumeRotateMouseWheel";const l=r},17819:(e,t,n)=>{"use strict";n.d(t,{A:()=>v});var o=n(85817),i=n(15327),a=n(6802),s=n(44049),r=n(74347),l=n(85204),d=n(99737),c=n(60810),h=n(7001),g=n(58640),u=n(97213);class m extends o.EC{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{minWindowWidth:10}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,s=n.world,r=(0,i.getEnabledElement)(o),{viewport:l}=r;this.isDrawing=!0;const d=l.getCamera(),{viewPlaneNormal:u,viewUp:m}=d,v=this.getReferencedImageId(l,s,u,m),p=l.getFrameOfReferenceUID(),f={invalidated:!0,highlighted:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...u],viewUp:[...m],FrameOfReferenceUID:p,referencedImageId:v},data:{handles:{points:[[...s],[...s],[...s],[...s]]},cachedStats:{}}};(0,a.lC)(f,o);const E=(0,c.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:E},this._activateDraw(o),(0,h.hideElementCursor)(o),e.preventDefault(),(0,g.A)(E),f},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i}=this.editData;this._deactivateDraw(n),(0,h.resetElementCursor)(n),this.editData=null,this.isDrawing=!1,(0,a.O8)(o.annotationUID),(0,g.A)(i),(0,s.triggerAnnotationCompleted)(o),this.applyWindowLevelRegion(o,n)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a}=this.editData,{data:s}=o,{currentPoints:r}=t,l=(0,i.getEnabledElement)(n),{worldToCanvas:d,canvasToWorld:c}=l.viewport,h=r.world,{points:u}=s.handles;u[3]=[...h];const m=d(u[0]),v=d(u[3]),p=[v[0],m[1]],f=[m[0],v[1]],E=c(p),w=c(f);u[1]=E,u[2]=w,o.invalidated=!0,(0,g.A)(a)},this._activateDraw=e=>{l.wk.isInteractingWithTool=!0,e.addEventListener(d.Events.MOUSE_UP,this._endCallback),e.addEventListener(d.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(d.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(d.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(d.Events.TOUCH_END,this._endCallback),e.addEventListener(d.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(d.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{l.wk.isInteractingWithTool=!1,e.removeEventListener(d.Events.MOUSE_UP,this._endCallback),e.removeEventListener(d.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(d.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(d.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(d.Events.TOUCH_END,this._endCallback),e.removeEventListener(d.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(d.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let s=(0,a.Rh)(this.getToolName(),i);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(i,s),!s?.length)return n;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<s.length;e++){const i=s[e],{annotationUID:a,data:d}=i,{points:c}=d.handles,h=c.map(e=>o.worldToCanvas(e));l.annotationUID=a;const{color:g,lineWidth:u,lineDash:m}=this.getAnnotationStyle({annotation:i,styleSpecifier:l});if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const v=`${a}-rect`,p="0";(0,r.drawRect)(t,a,p,h[0],h[3],{color:g,lineDash:m,lineWidth:u},v),n=!0}return n},this.applyWindowLevelRegion=(e,t)=>{const n=(0,i.getEnabledElement)(t),{viewport:o}=n,a=u.windowLevel.extractWindowLevelRegionToolData(o),{data:s}=e,{points:r}=s.handles,l=r.map(e=>o.worldToCanvas(e)),d=l[0],c=l[3];let h=Math.min(d[0],c[0]),g=Math.min(d[1],c[1]),m=Math.abs(d[0]-c[0]),v=Math.abs(d[1]-c[1]);h=i.utilities.clip(h,0,a.width),g=i.utilities.clip(g,0,a.height),m=Math.floor(Math.min(m,Math.abs(a.width-h))),v=Math.floor(Math.min(v,Math.abs(a.height-g)));const p=u.windowLevel.getLuminanceFromRegion(a,Math.round(h),Math.round(g),m,v),f=u.windowLevel.calculateMinMaxMean(p,a.minPixelValue,a.maxPixelValue);void 0===this.configuration.minWindowWidth&&(this.configuration.minWindowWidth=10);const E=Math.max(Math.abs(f.max-f.min),this.configuration.minWindowWidth),w=f.mean,I=o.getProperties().VOILUTFunction,C=i.utilities.windowLevel.toLowHighRange(E,w,I);o.setProperties({voiRange:C}),o.render()},this.cancel=()=>null,this.isPointNearTool=()=>null,this.toolSelectedCallback=()=>null,this.handleSelectedCallback=()=>null,this._activateModify=()=>null,this._deactivateModify=()=>null}}m.toolName="WindowLevelRegion";const v=m},43159:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(85817),i=n(15327);class a extends o.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this._getImageDynamicRangeFromMiddleSlice=(e,t)=>{const n=Math.floor(t[2]/2),o=t[0]*t[1];let i,a;e instanceof Float32Array?(i=4,a=Float32Array):e instanceof Uint8Array?(i=1,a=Uint8Array):e instanceof Uint16Array?(i=2,a=Uint16Array):e instanceof Int16Array&&(i=2,a=Int16Array);const s=new a(e.buffer,n*o*i,o),{max:r,min:l}=this._getMinMax(s,o);return r-l}}touchDragCallback(e){this.mouseDragCallback(e)}mouseDragCallback(e){const{element:t,deltaPoints:n}=e.detail,o=(0,i.getEnabledElement)(t),{viewport:a}=o;let s,r,l,d,c,h,g=!1;const u=a.getProperties();if(a instanceof i.VolumeViewport){s=a.getVolumeId(),h=i.utilities.getViewportsWithVolumeId(s),({lower:r,upper:l}=u.voiRange);const e=i.cache.getVolume(s);if(!e)throw new Error("Volume not found "+s);d=e.metadata.Modality,g=e.scaling&&Object.keys(e.scaling).length>0}else{if(!u.voiRange)throw new Error("Viewport is not a valid type");{d=a.modality,({lower:r,upper:l}=u.voiRange);const{preScale:e={scaled:!1}}=a.getImageData?.()||{};g=e.scaled&&void 0!==e.scalingParameters?.suvbw}}c="PT"===d&&g?this.getPTScaledNewRange({deltaPointsCanvas:n.canvas,lower:r,upper:l,clientHeight:t.clientHeight,isPreScaled:g,viewport:a,volumeId:s}):this.getNewRange({viewport:a,deltaPointsCanvas:n.canvas,volumeId:s,lower:r,upper:l}),c.lower>=c.upper||(a.setProperties({voiRange:c}),a.render(),a instanceof i.VolumeViewport&&h.forEach(e=>{a!==e&&e.render()}))}getPTScaledNewRange({deltaPointsCanvas:e,lower:t,upper:n,clientHeight:o,viewport:i,volumeId:a,isPreScaled:s}){let r=4;r=s?5/o:this._getMultiplierFromDynamicRange(i,a)||4;return n-=e[1]*r,{lower:t,upper:n=s?Math.max(n,.1):n}}getNewRange({viewport:e,deltaPointsCanvas:t,volumeId:n,lower:o,upper:a}){const s=this._getMultiplierFromDynamicRange(e,n)||4,r=t[0]*s,l=t[1]*s;let{windowWidth:d,windowCenter:c}=i.utilities.windowLevel.toWindowLevel(o,a);d+=r,c+=l,d=Math.max(d,1);const h=e.getProperties().VOILUTFunction;return i.utilities.windowLevel.toLowHighRange(d,c,h)}_getMultiplierFromDynamicRange(e,t){let n;if(t){const o=i.cache.getVolume(t),{voxelManager:a}=e.getImageData(),s=a.getMiddleSliceData().reduce((e,t)=>[Math.min(e[0],t),Math.max(e[1],t)],[1/0,-1/0]),r=o?.metadata?.BitsStored,l=r?2**r:1/0;n=Math.min(s,l)}else n=this._getImageDynamicRangeFromViewport(e);const o=n/1024;return o>1?Math.round(o):o}_getImageDynamicRangeFromViewport(e){const{imageData:t,voxelManager:n}=e.getImageData();if(n?.getRange){const e=n.getRange();return e[1]-e[0]}const o=t.getDimensions();if(t.getRange){const e=t.getRange();return e[1]-e[0]}let i,a;if(i=t.getScalarData?t.getScalarData():t.getPointData().getScalars().getData(),1!==o[2])return this._getImageDynamicRangeFromMiddleSlice(i,o);if(i.getRange)a=i.getRange();else{const{min:e,max:t}=this._getMinMax(i,i.length);a=[e,t]}return a[1]-a[0]}_getMinMax(e,t){let n=1/0,o=-1/0;for(let i=0;i<t;i++){const t=e[i];t<n&&(n=t),t>o&&(o=t)}return{max:o,min:n}}}a.toolName="WindowLevel";const s=a},26938:(e,t,n)=>{"use strict";n.d(t,{A:()=>d});var o=n(3823),i=n(84607),a=n(15327),s=n(85817),r=n(99737);class l extends s.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{zoomToCenter:!1,minZoomScale:.001,maxZoomScale:3e3,pinchToZoom:!0,pan:!0,invert:!1}}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{element:n,currentPoints:i}=t,s=i.world,r=(0,a.getEnabledElement)(n).viewport.getCamera(),{focalPoint:l}=r;this.initialMousePosWorld=s;let d=o.eR.fromValues(l[0]-s[0],l[1]-s[1],l[2]-s[2]);return d=o.eR.normalize(o.eR.create(),d),this.dirVec=d,!1},this.preTouchStartCallback=e=>{if(!this.configuration.pinchToZoom)return this.preMouseDownCallback(e)},this._dragParallelProjection=(e,t,n,i=!1)=>{const{element:a,deltaPoints:s}=e.detail,r=i?e.detail.deltaDistance.canvas:s.canvas[1],l=[a.clientWidth,a.clientHeight],{parallelScale:d,focalPoint:c,position:h}=n,g=r*(5/l[1])*(this.configuration.invert?-1:1),u=(1-g)*d;let m=c,v=h;if(!this.configuration.zoomToCenter){const e=o.eR.distance(c,this.initialMousePosWorld);v=o.eR.scaleAndAdd(o.eR.create(),h,this.dirVec,-e*g),m=o.eR.scaleAndAdd(o.eR.create(),c,this.dirVec,-e*g)}const p=t.getImageData();let f=[1,1,1],E=u,w=!1;if(p){f=p.spacing;const{dimensions:e}=p,n=e[0]*f[0],o=e[1]*f[1],i=l[0]/l[1],a=t.options?.displayArea,s=n*(a?.imageArea?.[0]??1.1),r=o*(a?.imageArea?.[1]??1.1);let d;d=s/r>i?s/i*.5:.5*r;const{minZoomScale:c,maxZoomScale:h}=this.configuration,g=d/h,m=d/c;u<g?(E=g,w=!0):u>m&&(E=m,w=!0)}t.setCamera({parallelScale:E,focalPoint:w?c:m,position:w?h:v})},this._dragPerspectiveProjection=(e,t,n,o=!1)=>{const{element:a,deltaPoints:s}=e.detail,r=o?e.detail.deltaDistance.canvas:s.canvas[1],l=[a.clientWidth,a.clientHeight],{position:d,focalPoint:c,viewPlaneNormal:h}=n,g=i.Ay.distance2BetweenPoints(d,c),u=Math.sqrt(g)/l[1],m=[-h[0],-h[1],-h[2]],v=this.configuration.invert?r/u:r*u;let p=v*m[0];d[0]+=p,c[0]+=p,p=v*m[1],d[1]+=p,c[1]+=p,p=v*m[2],d[2]+=p,c[2]+=p,t.setCamera({position:d,focalPoint:c})},this.initialMousePosWorld=[0,0,0],this.dirVec=[0,0,0],this.configuration.pinchToZoom?this.touchDragCallback=this._pinchCallback.bind(this):this.touchDragCallback=this._dragCallback.bind(this),this.mouseDragCallback=this._dragCallback.bind(this)}mouseWheelCallback(e){this._zoom(e)}_pinchCallback(e){if(e.detail.currentPointsList.length>1){const{element:t,currentPoints:n}=e.detail,i=(0,a.getEnabledElement)(t),{viewport:s}=i,r=s.getCamera(),l=n.world,{focalPoint:d}=r;this.initialMousePosWorld=l;let c=o.eR.fromValues(d[0]-l[0],d[1]-l[1],d[2]-l[2]);c=o.eR.normalize(o.eR.create(),c),this.dirVec=c,r.parallelProjection?this._dragParallelProjection(e,s,r,!0):this._dragPerspectiveProjection(e,s,r,!0),s.render()}this.configuration.pan&&this._panCallback(e)}_dragCallback(e){const{element:t}=e.detail,n=(0,a.getEnabledElement)(t),{viewport:o}=n,i=o.getCamera();i.parallelProjection?this._dragParallelProjection(e,o,i):this._dragPerspectiveProjection(e,o,i),o.render()}_zoom(e){const{element:t,points:n}=e.detail,o=(0,a.getEnabledElement)(t),{viewport:i}=o,s=(i.getCamera(),e.detail.wheel.direction),l={detail:{element:t,eventName:r.Events.MOUSE_WHEEL,renderingEngineId:o.renderingEngineId,viewportId:i.id,camera:{},deltaPoints:{page:n.page,client:n.client,world:n.world,canvas:[0,5*-s]},startPoints:n,lastPoints:n,currentPoints:n}};i.type===a.Enums.ViewportType.STACK&&this.preMouseDownCallback(l),this._dragCallback(l)}_panCallback(e){const{element:t,deltaPoints:n}=e.detail,o=(0,a.getEnabledElement)(t),i=n.world,s=o.viewport.getCamera(),{focalPoint:r,position:l}=s,d=[l[0]-i[0],l[1]-i[1],l[2]-i[2]],c=[r[0]-i[0],r[1]-i[1],r[2]-i[2]];o.viewport.setCamera({focalPoint:c,position:d}),o.viewport.render()}}l.toolName="Zoom";const d=l},9608:(e,t,n)=>{"use strict";n.d(t,{A:()=>I});var o=n(99737),i=n(15327),a=n(85817),s=n(27730),r=n(82056),l=n(2076),d=n(93258),c=n(25963),h=n(74347),g=n(85204),u=n(60810),m=n(58640),v=n(44049),p=n(7001),f=n(29601);class E extends a.EC{static{this.toolName="Angle"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,showAngleArc:!1,arcOffset:5,preventHandleOutsideImage:!1,getTextLines:w}}){super(e,t),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,s=(0,i.getEnabledElement)(o),{viewport:l,renderingEngine:d}=s;(0,p.hideElementCursor)(o),this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,v=this.getReferencedImageId(l,a,h,g),f=l.getFrameOfReferenceUID(),E={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:f,referencedImageId:v,...l.getViewReference({points:[a]})},data:{handles:{points:[[...a],[...a]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,r.addAnnotation)(E,o);const w=(0,u.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:E,viewportIdsToRender:w,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),e.preventDefault(),(0,m.A)(w),E},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,[l,c,h]=r.handles.points,g=s.worldToCanvas(l),u=s.worldToCanvas(c),m={start:{x:g[0],y:g[1]},end:{x:u[0],y:u[1]}};if(d.distanceToPoint([m.start.x,m.start.y],[m.end.x,m.end.y],[n[0],n[1]])<=o)return!0;if(!h)return!1;const v=s.worldToCanvas(h),p={start:{x:u[0],y:u[1]},end:{x:v[0],y:v[1]}};return d.distanceToPoint([p.start.x,p.start.y],[p.end.x,p.end.y],[n[0],n[1]])<=o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,u.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(o),(0,p.hideElementCursor)(o);const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;(0,m.A)(a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,newAnnotation:s,hasMoved:l}=this.editData,{data:d}=o;if(s&&!l)return;if(this.angleStartedNotYetCompleted&&2===d.handles.points.length)return void(this.editData.handleIndex=2);this.angleStartedNotYetCompleted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,p.resetElementCursor)(n);const c=(0,i.getEnabledElement)(n),{renderingEngine:h}=c;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(o.annotationUID),(0,m.A)(a),this.doneEditMemo(),s&&(0,v.triggerAnnotationCompleted)(o),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:a,viewportIdsToRender:s,handleIndex:r,movingTextBox:l,newAnnotation:d}=this.editData,{data:c}=a;if(this.createMemo(n,a,{newAnnotation:d}),l){const{deltaPoints:e}=t,n=e.world,{textBox:o}=c.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===r){const{deltaPoints:e}=t,n=e.world;c.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),a.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;c.handles.points[r]=[...n],a.invalidated=!0}this.editData.hasMoved=!0;const h=(0,i.getEnabledElement)(n),{renderingEngine:g}=h;(0,m.A)(s),a.invalidated&&(0,v.triggerAnnotationModified)(a,n,o.ChangeTypes.HandlesUpdated)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,p.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;return t.highlighted=!1,i.handles.activeHandleIndex=null,(0,m.A)(n),o&&(0,v.triggerAnnotationCompleted)(t),this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID}},this._activateModify=e=>{g.wk.isInteractingWithTool=!0,e.addEventListener(o.Events.MOUSE_UP,this._endCallback),e.addEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(o.Events.TOUCH_TAP,this._endCallback),e.addEventListener(o.Events.TOUCH_END,this._endCallback),e.addEventListener(o.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{g.wk.isInteractingWithTool=!1,e.removeEventListener(o.Events.MOUSE_UP,this._endCallback),e.removeEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(o.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(o.Events.TOUCH_END,this._endCallback),e.removeEventListener(o.Events.TOUCH_DRAG,this._dragCallback)},this._activateDraw=e=>{g.wk.isInteractingWithTool=!0,e.addEventListener(o.Events.MOUSE_UP,this._endCallback),e.addEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(o.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(o.Events.TOUCH_TAP,this._endCallback),e.addEventListener(o.Events.TOUCH_END,this._endCallback),e.addEventListener(o.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{g.wk.isInteractingWithTool=!1,e.removeEventListener(o.Events.MOUSE_UP,this._endCallback),e.removeEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(o.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(o.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(o.Events.TOUCH_END,this._endCallback),e.removeEventListener(o.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=(0,r.getAnnotations)(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const s=this.getTargetId(o),c=o.getRenderingEngine(),g={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const r=a[i],{annotationUID:u,data:m}=r,{points:v,activeHandleIndex:p}=m.handles;g.annotationUID=u;const{color:E,lineWidth:w,lineDash:I,angleArcLineDash:C}=this.getAnnotationStyle({annotation:r,styleSpecifier:g}),T=v.map(e=>o.worldToCanvas(e));let b;if(m.cachedStats[s]&&null!=m.cachedStats[s].angle?r.invalidated&&this._throttledCalculateCachedStats(r,c,e):(m.cachedStats[s]={angle:null},this._calculateCachedStats(r,c,e)),(0,l.isAnnotationLocked)(r.annotationUID)||this.editData||null===p||(b=[T[p]]),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,f.isAnnotationVisible)(u))continue;if(b){const e="0";(0,h.drawHandles)(t,u,e,T,{color:E,lineDash:I,lineWidth:w})}let A="1";if((0,h.drawLine)(t,u,A,T[0],T[1],{color:E,width:w,lineDash:I}),n=!0,3!==T.length)return n;if(A="2",(0,h.drawLine)(t,u,A,T[1],T[2],{color:E,width:w,lineDash:I}),this.configuration.showAngleArc){const e=T[1],n=this.configuration.arcOffset,o=Math.min(d.distanceToPoint([e[0],e[1]],[T[0][0],T[0][1]],[T[2][0],T[2][1]]),d.distanceToPoint([e[0],e[1]],[T[2][0],T[2][1]],[T[0][0],T[0][1]]))/n,i=[];let a=Math.atan2(T[0][1]-e[1],T[0][0]-e[0]),s=Math.atan2(T[2][1]-e[1],T[2][0]-e[0]);s<a&&(s+=2*Math.PI);if(s-a>Math.PI){const e=a;a=s,s=e+2*Math.PI}const r=32;for(let t=0;t<=r;t++){const n=a+t/r*(s-a);i.push([e[0]+o*Math.cos(n),e[1]+o*Math.sin(n)])}(0,h.drawPath)(t,u,"3",i,{color:E,width:w,lineDash:C})}if(!m.cachedStats[s]?.angle)continue;const _=this.getLinkedTextBoxStyle(g,r);if(!_.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const S=this.configuration.getTextLines(m,s);if(!m.handles.textBox.hasMoved){const e=T[1];m.handles.textBox.worldPosition=o.canvasToWorld(e)}const D=o.worldToCanvas(m.handles.textBox.worldPosition),y="1",M=(0,h.drawLinkedTextBox)(t,u,y,S,D,T,{},_),{x,y:R,width:P,height:L}=M;m.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([x,R]),topRight:o.canvasToWorld([x+P,R]),bottomLeft:o.canvasToWorld([x,R+L]),bottomRight:o.canvasToWorld([x+P,R+L])}}return n},this._throttledCalculateCachedStats=(0,s.A)(this._calculateCachedStats,100,{trailing:!0})}static{this.hydrate=(e,t,n)=>{const o=(0,i.getEnabledElementByViewportId)(e);if(!o)return;const{FrameOfReferenceUID:a,referencedImageId:s,viewPlaneNormal:l,instance:d,viewport:c}=this.hydrateBase(E,o,t,n),{toolInstance:h,...g}=n||{},u={annotationUID:n?.annotationUID||i.utilities.uuidv4(),data:{handles:{points:t}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:d.getToolName(),viewPlaneNormal:l,FrameOfReferenceUID:a,referencedImageId:s,...g}};(0,r.addAnnotation)(u,c.element),(0,m.A)([c.id])}}handleSelectedCallback(e,t,n){const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex(e=>e===n);const d=(0,u.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,p.hideElementCursor)(a);const c=(0,i.getEnabledElement)(a),{renderingEngine:h}=c;(0,m.A)(d),e.preventDefault()}_calculateCachedStats(e,t,n){const a=e.data,{element:s}=n.viewport;if(3!==a.handles.points.length)return;const r=a.handles.points[0],l=a.handles.points[1],d=a.handles.points[2],{cachedStats:h}=a,g=Object.keys(h);for(let e=0;e<g.length;e++){const t=g[e],n=(0,c.A)([r,l],[l,d]),{dimensions:o,imageData:a}=this.getTargetImageData(t);this.isHandleOutsideImage=[r,l,d].map(e=>i.utilities.transformWorldToIndex(a,e)).some(e=>!i.utilities.indexWithinDimensions(e,o)),h[t]={angle:isNaN(n)?"Incomplete Angle":n}}const u=e.invalidated;return e.invalidated=!1,u&&(0,v.triggerAnnotationModified)(e,s,o.ChangeTypes.StatsUpdated),h}}function w(e,t){const n=e.cachedStats[t],{angle:o}=n;if(void 0===o)return;if(isNaN(o))return[`${o}`];return[`${i.utilities.roundNumber(o)} ${String.fromCharCode(176)}`]}const I=E},24146:(e,t,n)=>{"use strict";n.d(t,{A:()=>I});var o=n(99737),i=n(15327),a=n(85817),s=n(82056),r=n(2076),l=n(93258),d=n(74347),c=n(85204),h=n(60810),g=n(58640),u=n(44049),m=n(7001),v=n(29601),p=n(53860);class f extends a.EC{static{this.toolName="ArrowAnnotate"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,getTextCallback:E,changeTextCallback:w,preventHandleOutsideImage:!1,arrowFirst:!0,arrowHeadStyle:"legacy"}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,r=(0,i.getEnabledElement)(o),{viewport:l,renderingEngine:d}=r;(0,m.hideElementCursor)(o),this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:u,viewUp:v}=c,p=this.getReferencedImageId(l,a,u,v),{arrowFirst:f}=this.configuration,E=l.getFrameOfReferenceUID(),w={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...u],viewUp:[...v],FrameOfReferenceUID:E,referencedImageId:p,...l.getViewReference({points:[a]})},data:{text:"",handles:{points:[[...a],[...a]],activeHandleIndex:null,arrowFirst:f,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:""}};(0,s.addAnnotation)(w,o);const I=(0,h.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:w,viewportIdsToRender:I,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),e.preventDefault(),(0,g.A)(I),w},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,[d,c]=r.handles.points,h=s.worldToCanvas(d),g=s.worldToCanvas(c),u={start:{x:h[0],y:h[1]},end:{x:g[0],y:g[1]}};return l.distanceToPoint([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]])<=o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,h.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(o),(0,m.hideElementCursor)(o);const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;(0,g.A)(a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:r,hasMoved:l,movingTextBox:d}=this.editData,{data:c}=i;r&&!l||(c.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,m.resetElementCursor)(n),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,s.removeAnnotation)(i.annotationUID),r?this.configuration.getTextCallback(e=>{if(!e)return(0,s.removeAnnotation)(i.annotationUID),(0,g.A)(a),this.editData=null,void(this.isDrawing=!1);i.data.text=e,(0,u.triggerAnnotationModified)(i,n,o.ChangeTypes.HandlesUpdated),(0,u.triggerAnnotationCompleted)(i),this.createMemo(n,i,{newAnnotation:!!this.memo}),(0,p.setAnnotationLabel)(i,n,e),(0,g.A)(a)}):d||(0,u.triggerAnnotationModified)(i,n,o.ChangeTypes.HandlesUpdated),this.doneEditMemo(),this.editData=null,this.isDrawing=!1)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:s,movingTextBox:r,newAnnotation:l}=this.editData;this.createMemo(n,i,{newAnnotation:l});const{data:d}=i;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=d.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;d.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;d.handles.points[s]=[...n],i.invalidated=!0}this.editData.hasMoved=!0,(0,g.A)(a),i.invalidated&&(0,u.triggerAnnotationModified)(i,n,o.ChangeTypes.HandlesUpdated)},this.touchTapCallback=e=>{2==e.detail.taps&&this.doubleClickCallback(e)},this.doubleClickCallback=e=>{const t=e.detail,{element:n}=t;let o=(0,s.getAnnotations)(this.getToolName(),n);if(o=this.filterInteractableAnnotationsForElement(n,o),!o?.length)return;const i=o.find(e=>this.isPointNearTool(n,e,t.currentPoints.canvas,6));if(!i)return;const a=i;this.configuration.changeTextCallback(i,e.detail,this._doneChangingTextCallback.bind(this,n,a)),this.editData=null,this.isDrawing=!1,e.stopImmediatePropagation(),e.preventDefault()},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,m.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;return t.highlighted=!1,i.handles.activeHandleIndex=null,(0,g.A)(n),o&&(0,u.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{c.wk.isInteractingWithTool=!0,e.addEventListener(o.Events.MOUSE_UP,this._endCallback),e.addEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(o.Events.TOUCH_TAP,this._endCallback),e.addEventListener(o.Events.TOUCH_END,this._endCallback),e.addEventListener(o.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{c.wk.isInteractingWithTool=!1,e.removeEventListener(o.Events.MOUSE_UP,this._endCallback),e.removeEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(o.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(o.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(o.Events.TOUCH_END,this._endCallback)},this._activateDraw=e=>{c.wk.isInteractingWithTool=!0,e.addEventListener(o.Events.MOUSE_UP,this._endCallback),e.addEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(o.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(o.Events.TOUCH_TAP,this._endCallback),e.addEventListener(o.Events.TOUCH_END,this._endCallback),e.addEventListener(o.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{c.wk.isInteractingWithTool=!1,e.removeEventListener(o.Events.MOUSE_UP,this._endCallback),e.removeEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(o.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(o.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(o.Events.TOUCH_END,this._endCallback),e.removeEventListener(o.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=(0,s.getAnnotations)(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const i=a[e],{annotationUID:s,data:c}=i,{handles:h,text:g}=c,{points:u,activeHandleIndex:m}=h;l.annotationUID=s;const{color:p,lineWidth:f,lineDash:E,markerSize:w}=this.getAnnotationStyle({annotation:i,styleSpecifier:l}),I=u.map(e=>o.worldToCanvas(e));let C;if((0,r.isAnnotationLocked)(s)||this.editData||null===m||(C=[I[m]]),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,v.isAnnotationVisible)(s))continue;if(C){const e="0";(0,d.drawHandles)(t,s,e,I,{color:p,lineWidth:f})}const T="1";if(this.configuration.arrowFirst?(0,d.drawArrow)(t,s,T,I[1],I[0],{color:p,width:f,lineDash:E,viaMarker:"legacy"!==this.configuration.arrowHeadStyle,markerSize:w}):(0,d.drawArrow)(t,s,T,I[0],I[1],{color:p,width:f,lineDash:E,viaMarker:"legacy"!==this.configuration.arrowHeadStyle,markerSize:w}),n=!0,!g)continue;const b=this.getLinkedTextBoxStyle(l,i);if(!b.visibility){c.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}if(!c.handles.textBox.hasMoved){const e=I[1];c.handles.textBox.worldPosition=o.canvasToWorld(e)}const A=o.worldToCanvas(c.handles.textBox.worldPosition),_="1",S=(0,d.drawLinkedTextBox)(t,s,_,[g],A,I,{},b),{x:D,y,width:M,height:x}=S;c.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([D,y]),topRight:o.canvasToWorld([D+M,y]),bottomLeft:o.canvasToWorld([D,y+x]),bottomRight:o.canvasToWorld([D+M,y+x])}}return n}}static{this.hydrate=(e,t,n,o)=>{const a=(0,i.getEnabledElementByViewportId)(e);if(!a)return;const{FrameOfReferenceUID:r,referencedImageId:l,viewPlaneNormal:d,instance:c,viewport:h}=this.hydrateBase(f,a,t,o),{toolInstance:u,...m}=o||{},v={annotationUID:o?.annotationUID||i.utilities.uuidv4(),data:{text:n||"",handles:{points:t}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:c.getToolName(),viewPlaneNormal:d,FrameOfReferenceUID:r,referencedImageId:l,...m}};(0,s.addAnnotation)(v,h.element),(0,g.A)([h.id])}}handleSelectedCallback(e,t,n){const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex(e=>e===n);const d=(0,h.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,m.hideElementCursor)(a);const c=(0,i.getEnabledElement)(a),{renderingEngine:u}=c;(0,g.A)(d),e.preventDefault()}_doneChangingTextCallback(e,t,n){t.data.text=n;(0,i.getEnabledElement)(e);const o=(0,h.getViewportIdsWithToolToRender)(e,this.getToolName());(0,g.A)(o),(0,u.triggerAnnotationModified)(t,e)}_isInsideVolume(e,t,n){return i.utilities.indexWithinDimensions(e,n)&&i.utilities.indexWithinDimensions(t,n)}}function E(e){return e(prompt("Enter your annotation:"))}function w(e,t,n){return n(prompt("Enter your annotation:"))}const I=f},25072:(e,t,n)=>{"use strict";n.d(t,{A:()=>b});var o=n(3823),i=n(15327),a=n(4096),s=n(85817),r=n(27730),l=n(82056),d=n(2076),c=n(29601),h=n(44049),g=n(74347),u=n(85204),m=n(99737),v=n(60810),p=n(93258),f=n(473),E=n(7001),w=n(58640);const{transformWorldToIndex:I}=i.utilities;class C extends s.EC{static{this.toolName="Bidirectional"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:T}}){super(e,t),this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{points:l}=r.handles;let d=s.worldToCanvas(l[0]),c=s.worldToCanvas(l[1]),h={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}},g=p.distanceToPoint([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]]);return g<=o||(d=s.worldToCanvas(l[2]),c=s.worldToCanvas(l[3]),h={start:{x:d[0],y:d[1]},end:{x:c[0],y:c[1]}},g=p.distanceToPoint([h.start.x,h.start.y],[h.end.x,h.end.y],[n[0],n[1]]),g<=o)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,v.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(o);const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;(0,w.A)(a),(0,E.hideElementCursor)(o),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:a}=o,s=t.data;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex(e=>e===n);const d=(0,v.getViewportIdsWithToolToRender)(a,this.getToolName());(0,E.hideElementCursor)(a),this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a);const c=(0,i.getEnabledElement)(a),{renderingEngine:h}=c;(0,w.A)(d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:a,viewportIdsToRender:s,newAnnotation:r,hasMoved:d}=this.editData,{data:c}=a;if(r&&!d)return;this.doneEditMemo(),c.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,E.resetElementCursor)(n);const{renderingEngine:g}=(0,i.getEnabledElement)(n);if(void 0!==this.editData.handleIndex){const{points:e}=c.handles,t=o.eR.distance(e[0],e[1]);if(o.eR.distance(e[2],e[3])>t){const t=[[...e[2]],[...e[3]]],n=[...e[0]],i=[...e[1]],a=o.Zc.create();o.Zc.set(a,t[1][0]-t[0][0],t[1][1]-t[1][0]);const s=o.Zc.create();o.Zc.set(s,-a[1],a[0]);const r=o.Zc.create();let l;o.Zc.set(r,i[0]-n[0],i[1]-n[0]),l=o.Zc.dot(r,s)>0?[n,i]:[i,n],c.handles.points=[t[0],t[1],l[0],l[1]]}}this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,l.removeAnnotation)(a.annotationUID),(0,w.A)(s),r&&(0,h.triggerAnnotationCompleted)(a),this.editData=null,this.isDrawing=!1},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:a}=t,s=(0,i.getEnabledElement)(a),{viewport:r}=s,{worldToCanvas:l}=r,{annotation:d,viewportIdsToRender:c,handleIndex:g,newAnnotation:u}=this.editData;this.createMemo(a,d,{newAnnotation:u});const{data:v}=d,p=n.world;v.handles.points[g]=[...p];const f=v.handles.points.map(l),E={start:{x:f[0][0],y:f[0][1]},end:{x:f[1][0],y:f[1][1]}},I=(f[2][0],f[2][1],f[3][0],f[3][1],o.Zc.distance(f[0],f[1])/3),C=E.start.x-E.end.x,T=E.start.y-E.end.y,b=Math.sqrt(C*C+T*T),A=C/b,_=T/b,S=(E.start.x+E.end.x)/2,D=(E.start.y+E.end.y)/2,y=S+I*_,M=D-I*A,x=S-I*_,R=D+I*A;v.handles.points[2]=r.canvasToWorld([y,M]),v.handles.points[3]=r.canvasToWorld([x,R]),d.invalidated=!0,(0,w.A)(c),(0,h.triggerAnnotationModified)(d,a,m.ChangeTypes.HandlesUpdated),this.editData.hasMoved=!0},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,handleIndex:a,movingTextBox:s,newAnnotation:r}=this.editData;this.createMemo(n,o,{newAnnotation:r});const{data:l}=o;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:o}=l.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===a){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),o.invalidated=!0}else this._dragModifyHandle(e),o.invalidated=!0;(0,w.A)(i),o.invalidated&&(0,h.triggerAnnotationModified)(o,n,m.ChangeTypes.HandlesUpdated)},this._dragModifyHandle=e=>{const t=e.detail,{currentPoints:n,element:a}=t,s=(0,i.getEnabledElement)(a),{viewport:r}=s,{annotation:l,handleIndex:d}=this.editData,{data:c}=l,h=n.world,g=[r.worldToCanvas(c.handles.points[0]),r.worldToCanvas(c.handles.points[1]),r.worldToCanvas(c.handles.points[2]),r.worldToCanvas(c.handles.points[3])],u={start:{x:g[0][0],y:g[0][1]},end:{x:g[1][0],y:g[1][1]}},m={start:{x:g[2][0],y:g[2][1]},end:{x:g[3][0],y:g[3][1]}},v=[...h],f=r.worldToCanvas(v);if(0===d||1===d){const e=g[0===d?1:0],t=o.Zc.set(o.Zc.create(),f[0]-e[0],f[1]-e[1]),n=o.Zc.set(o.Zc.create(),g[d][0]-e[0],g[d][1]-e[1]);o.Zc.normalize(t,t),o.Zc.normalize(n,n);const i={start:{x:e[0],y:e[1]},end:{x:f[0],y:f[1]}};if(this._movingLongAxisWouldPutItThroughShortAxis(i,m))return;const a=e,s=this._getSignedAngle(n,t);let l=g[2][0],h=g[2][1],u=g[3][0],p=g[3][1];l-=a[0],h-=a[1],u-=a[0],p-=a[1];const E=l*Math.cos(s)-h*Math.sin(s),w=l*Math.sin(s)+h*Math.cos(s),I=u*Math.cos(s)-p*Math.sin(s),C=u*Math.sin(s)+p*Math.cos(s);l=E+a[0],h=w+a[1],u=I+a[0],p=C+a[1];const T=r.canvasToWorld([l,h]),b=r.canvasToWorld([u,p]);c.handles.points[d]=v,c.handles.points[2]=T,c.handles.points[3]=b}else{const e=2===d?3:2,t={longLineSegment:{start:u.start,end:u.end},shortLineSegment:{start:m.start,end:m.end}},n=o.Zc.subtract(o.Zc.create(),[t.longLineSegment.end.x,t.longLineSegment.end.y],[t.longLineSegment.start.x,t.longLineSegment.start.y]),i=o.Zc.normalize(o.Zc.create(),n),a=o.Zc.subtract(o.Zc.create(),[f[0],f[1]],[g[d][0],g[d][1]]),s=o.Zc.length(a),l=this._getSignedAngle(i,a),h=Math.cos(l)*s,E=o.Zc.scaleAndAdd(o.Zc.create(),[g[e][0],g[e][1]],i,h);if(this._movingLongAxisWouldPutItThroughShortAxis({start:{x:f[0],y:f[1]},end:{x:E[0],y:E[1]}},{start:{x:t.longLineSegment.start.x,y:t.longLineSegment.start.y},end:{x:t.longLineSegment.end.x,y:t.longLineSegment.end.y}}))return;if(!p.intersectLine([f[0],f[1]],[E[0],E[1]],[u.start.x,u.start.y],[u.end.x,u.end.y]))return;c.handles.points[e]=r.canvasToWorld(E),c.handles.points[d]=v}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,E.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;return t.highlighted=!1,i.handles.activeHandleIndex=null,(0,w.A)(n),o&&(0,h.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateDraw=e=>{u.wk.isInteractingWithTool=!0,e.addEventListener(m.Events.MOUSE_UP,this._endCallback),e.addEventListener(m.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(m.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(m.Events.TOUCH_TAP,this._endCallback),e.addEventListener(m.Events.TOUCH_END,this._endCallback),e.addEventListener(m.Events.TOUCH_DRAG,this._dragDrawCallback)},this._deactivateDraw=e=>{u.wk.isInteractingWithTool=!1,e.removeEventListener(m.Events.MOUSE_UP,this._endCallback),e.removeEventListener(m.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(m.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(m.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(m.Events.TOUCH_END,this._endCallback),e.removeEventListener(m.Events.TOUCH_DRAG,this._dragDrawCallback)},this._activateModify=e=>{u.wk.isInteractingWithTool=!0,e.addEventListener(m.Events.MOUSE_UP,this._endCallback),e.addEventListener(m.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(m.Events.TOUCH_END,this._endCallback),e.addEventListener(m.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(m.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{u.wk.isInteractingWithTool=!1,e.removeEventListener(m.Events.MOUSE_UP,this._endCallback),e.removeEventListener(m.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(m.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(m.Events.TOUCH_END,this._endCallback),e.removeEventListener(m.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(m.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!0;const{viewport:o}=e,{element:i}=o;let a=(0,l.getAnnotations)(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const s=this.getTargetId(o),r=o.getRenderingEngine(),h={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const l=a[i],{annotationUID:u,data:m}=l,{points:v,activeHandleIndex:p}=m.handles,E=v.map(e=>o.worldToCanvas(e));h.annotationUID=u;const{color:w,lineWidth:I,lineDash:C,shadow:T}=this.getAnnotationStyle({annotation:l,styleSpecifier:h});if(m.cachedStats[s]&&null!=m.cachedStats[s].unit?l.invalidated&&this._throttledCalculateCachedStats(l,r,e):(m.cachedStats[s]={length:null,width:null,unit:null},this._calculateCachedStats(l,r,e)),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let b;if(!(0,c.isAnnotationVisible)(u))continue;if((0,d.isAnnotationLocked)(u)||this.editData||null===p||(b=[E[p]]),b){const e="0";(0,g.drawHandles)(t,u,e,b,{color:w})}const A=`${u}-line-1`,_=`${u}-line-2`,S="0";(0,g.drawLine)(t,u,S,E[0],E[1],{color:w,lineDash:C,lineWidth:I,shadow:T},A);const D="1";(0,g.drawLine)(t,u,D,E[2],E[3],{color:w,lineDash:C,lineWidth:I,shadow:T},_),n=!0;const y=this.getLinkedTextBoxStyle(h,l);if(!y.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const M=this.configuration.getTextLines(m,s);if(!M||0===M.length)continue;let x;m.handles.textBox.hasMoved||(x=(0,f.getTextBoxCoordsCanvas)(E),m.handles.textBox.worldPosition=o.canvasToWorld(x));const R=o.worldToCanvas(m.handles.textBox.worldPosition),P="1",L=(0,g.drawLinkedTextBox)(t,u,P,M,R,E,{},y),{x:k,y:O,width:U,height:N}=L;m.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([k,O]),topRight:o.canvasToWorld([k+U,O]),bottomLeft:o.canvasToWorld([k,O+N]),bottomRight:o.canvasToWorld([k+U,O+N])}}return n},this._movingLongAxisWouldPutItThroughShortAxis=(e,t)=>{const n=o.Zc.create();o.Zc.set(n,t.end.x-t.start.x,t.end.y-t.start.y),o.Zc.normalize(n,n);const i={start:{x:t.start.x-10*n[0],y:t.start.y-10*n[1]},end:{x:t.end.x+10*n[0],y:t.end.y+10*n[1]}};return!p.intersectLine([i.start.x,i.start.y],[i.end.x,i.end.y],[e.start.x,e.start.y],[e.end.x,e.end.y])},this._calculateCachedStats=(e,t,n)=>{const{data:o}=e,{element:i}=n.viewport,s=o.handles.points[0],r=o.handles.points[1],l=o.handles.points[2],d=o.handles.points[3],{cachedStats:c}=o,g=Object.keys(c);for(let e=0;e<g.length;e++){const t=g[e],n=this.getTargetImageData(t);if(!n)continue;const{imageData:o,dimensions:i}=n,h=I(o,s),u=I(o,r),m=I(o,l),v=I(o,d),p=[h,u],f=[m,v],{scale:E,unit:w}=(0,a.Op)(n,p),{scale:C,unit:T}=(0,a.Op)(n,f),b=this._calculateLength(s,r)/E,A=this._calculateLength(l,d)/C,_=b>A?b:A,S=b>A?A:b,D=b>A?w:T,y=b>A?T:w;this._isInsideVolume(h,u,m,v,i)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,c[t]={length:_,width:S,unit:D,widthUnit:y}}const u=e.invalidated;return e.invalidated=!1,u&&(0,h.triggerAnnotationModified)(e,i,m.ChangeTypes.StatsUpdated),c},this._isInsideVolume=(e,t,n,o,a)=>i.utilities.indexWithinDimensions(e,a)&&i.utilities.indexWithinDimensions(t,a)&&i.utilities.indexWithinDimensions(n,a)&&i.utilities.indexWithinDimensions(o,a),this._getSignedAngle=(e,t)=>Math.atan2(e[0]*t[1]-e[1]*t[0],e[0]*t[0]+e[1]*t[1]),this._throttledCalculateCachedStats=(0,r.A)(this._calculateCachedStats,100,{trailing:!0})}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,s=(0,i.getEnabledElement)(o),{viewport:r,renderingEngine:d}=s;this.isDrawing=!0;const c=r.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(r,a,h,g),m=r.getFrameOfReferenceUID(),p={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:m,referencedImageId:u,...r.getViewReference({points:[a]})},data:{handles:{points:[[...a],[...a],[...a],[...a]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}}};(0,l.addAnnotation)(p,o);const f=(0,v.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:p,viewportIdsToRender:f,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),(0,E.hideElementCursor)(o),e.preventDefault(),(0,w.A)(f),p}static{this.hydrate=(e,t,n)=>{const o=(0,i.getEnabledElementByViewportId)(e);if(!o)return;const{FrameOfReferenceUID:a,referencedImageId:s,viewPlaneNormal:r,instance:d,viewport:c}=this.hydrateBase(C,o,t[0],n),[h,g]=t,[u,m]=h,[v,p]=g,f=[u,m,v,p],{toolInstance:E,...I}=n||{},T={annotationUID:n?.annotationUID||i.utilities.uuidv4(),data:{handles:{points:f,activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},cachedStats:{}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:d.getToolName(),viewPlaneNormal:r,FrameOfReferenceUID:a,referencedImageId:s,...I}};return(0,l.addAnnotation)(T,c.element),(0,w.A)([c.id]),T}}_calculateLength(e,t){const n=e[0]-t[0],o=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(n*n+o*o+i*i)}}function T(e,t){const{cachedStats:n,label:o}=e,{length:a,width:s,unit:r}=n[t],l=[];return o&&l.push(o),void 0===a||l.push(`L: ${i.utilities.roundNumber(a)} ${r||r}`,`W: ${i.utilities.roundNumber(s)} ${r}`),l}const b=C},31137:(e,t,n)=>{"use strict";n.d(t,{A:()=>D});var o=n(85817),i=n(15327),a=n(4096),s=n(27730),r=n(82056),l=n(2076),d=n(29601),c=n(44049),h=n(74347),g=n(85204),u=n(99737),m=n(60810),v=n(473),p=n(62514),f=n(7001),E=n(58640),w=n(40634),I=n(18990),C=n(77081),T=n(11683),b=n(73262);const{transformWorldToIndex:A}=i.utilities;class _ extends o.EC{static{this.toolName="CircleROI"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,storePointData:!1,centerPointRadius:0,calculateStats:!0,getTextLines:S,statsCalculator:b.BasicStatsCalculator}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,s=(0,i.getEnabledElement)(o),{viewport:l,renderingEngine:d}=s;this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(l,a,h,g),v=l.getFrameOfReferenceUID(),p={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:v,referencedImageId:u,...l.getViewReference({points:[a]})},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...a],[...a]],activeHandleIndex:null},cachedStats:{}}};(0,r.addAnnotation)(p,o);const w=(0,m.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:p,viewportIdsToRender:w,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),(0,f.hideElementCursor)(o),e.preventDefault(),(0,E.A)(w),p},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{points:l}=r.handles,d=l.map(e=>s.worldToCanvas(e)),c=(0,C.getCanvasCircleRadius)(d),h=(0,C.getCanvasCircleRadius)([d[0],n]);return Math.abs(h-c)<o/2},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,m.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},(0,f.hideElementCursor)(o),this._activateModify(o);const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;(0,E.A)(a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;let r,l=!1;if(n.worldPosition)l=!0;else{const{points:e}=s.handles;r=e.findIndex(e=>e===n)}const d=(0,m.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,f.hideElementCursor)(a);const c=(0,i.getEnabledElement)(a),{renderingEngine:h}=c;(0,E.A)(d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,newAnnotation:s,hasMoved:l}=this.editData,{data:d}=o;if(s&&!l)return;this.doneEditMemo(),o.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,f.resetElementCursor)(n);const{renderingEngine:h}=(0,i.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(o.annotationUID),(0,E.A)(a),s&&(0,c.triggerAnnotationCompleted)(o)},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,a=o.canvas,s=(0,i.getEnabledElement)(n),{viewport:r}=s,{canvasToWorld:l}=r,{annotation:d,viewportIdsToRender:h,newAnnotation:g}=this.editData;this.createMemo(n,d,{newAnnotation:g});const{data:m}=d;m.handles.points=[m.handles.points[0],l(a)],d.invalidated=!0,this.editData.hasMoved=!0,(0,E.A)(h),(0,c.triggerAnnotationModified)(d,n,u.ChangeTypes.HandlesUpdated)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,handleIndex:s,movingTextBox:r,newAnnotation:l}=this.editData;this.createMemo(n,o,{newAnnotation:l});const{data:d}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=d.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;d.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),o.invalidated=!0}else this._dragHandle(e),o.invalidated=!0;const h=(0,i.getEnabledElement)(n),{renderingEngine:g}=h;(0,E.A)(a),o.invalidated&&(0,c.triggerAnnotationModified)(o,n,u.ChangeTypes.HandlesUpdated)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,o=(0,i.getEnabledElement)(n),{canvasToWorld:a,worldToCanvas:s}=o.viewport,{annotation:r,handleIndex:l}=this.editData,{data:d}=r,{points:c}=d.handles,h=c.map(e=>s(e)),{currentPoints:g}=t,u=g.canvas;if(0===l){const e=u[0]-h[0][0],t=u[1]-h[0][1],n=u,o=[h[1][0]+e,h[1][1]+t];c[0]=a(n),c[1]=a(o)}else c[1]=a(u)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,f.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;return t.highlighted=!1,i.handles.activeHandleIndex=null,(0,E.A)(n),o&&(0,c.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{g.wk.isInteractingWithTool=!0,e.addEventListener(u.Events.MOUSE_UP,this._endCallback),e.addEventListener(u.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(u.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(u.Events.TOUCH_END,this._endCallback),e.addEventListener(u.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(u.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{g.wk.isInteractingWithTool=!1,e.removeEventListener(u.Events.MOUSE_UP,this._endCallback),e.removeEventListener(u.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(u.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(u.Events.TOUCH_END,this._endCallback),e.removeEventListener(u.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(u.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{g.wk.isInteractingWithTool=!0,e.addEventListener(u.Events.MOUSE_UP,this._endCallback),e.addEventListener(u.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(u.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(u.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(u.Events.TOUCH_END,this._endCallback),e.addEventListener(u.Events.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(u.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{g.wk.isInteractingWithTool=!1,e.removeEventListener(u.Events.MOUSE_UP,this._endCallback),e.removeEventListener(u.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(u.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(u.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(u.Events.TOUCH_END,this._endCallback),e.removeEventListener(u.Events.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(u.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:a}=o;let s=(0,r.getAnnotations)(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const c=this.getTargetId(o),g=o.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<s.length;a++){const r=s[a],{annotationUID:m,data:p}=r,{handles:f}=p,{points:E,activeHandleIndex:w}=f;u.annotationUID=m;const{color:I,lineWidth:T,lineDash:b}=this.getAnnotationStyle({annotation:r,styleSpecifier:u}),A=E.map(e=>o.worldToCanvas(e)),_=A[0],S=(0,C.getCanvasCircleRadius)(A),D=(0,C.getCanvasCircleCorners)(A),{centerPointRadius:y}=this.configuration;if(p.cachedStats[c]&&null!=p.cachedStats[c].areaUnit){if(r.invalidated&&(this._throttledCalculateCachedStats(r,o,g,e),o instanceof i.VolumeViewport)){const{referencedImageId:e}=r.metadata;for(const t in p.cachedStats)if(t.startsWith("imageId")){g.getStackViewports().find(t=>{const n=i.utilities.imageIdToURI(e),o=t.hasImageURI(n),a=i.utilities.imageIdToURI(t.getCurrentImageId());return o&&a!==n})&&delete p.cachedStats[t]}}}else p.cachedStats[c]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null,radius:null,radiusUnit:null,perimeter:null},this._calculateCachedStats(r,o,g,e);if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let M;if(!(0,d.isAnnotationVisible)(m))continue;if((0,l.isAnnotationLocked)(m)||this.editData||null===w||(M=[A[w]]),M){const e="0";(0,h.drawHandles)(t,m,e,M,{color:I})}const x=`${m}-circle`,R="0";(0,h.drawCircle)(t,m,R,_,S,{color:I,lineDash:b,lineWidth:T},x),y>0&&S>3*y&&(0,h.drawCircle)(t,m,`${R}-center`,_,y,{color:I,lineDash:b,lineWidth:T}),n=!0;const P=this.getLinkedTextBoxStyle(u,r);if(!P.visibility){p.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const L=this.configuration.getTextLines(p,c);if(!L||0===L.length)continue;let k;p.handles.textBox.hasMoved||(k=(0,v.getTextBoxCoordsCanvas)(D),p.handles.textBox.worldPosition=o.canvasToWorld(k));const O=o.worldToCanvas(p.handles.textBox.worldPosition),U="1",N=(0,h.drawLinkedTextBox)(t,m,U,L,O,A,{},P),{x:V,y:B,width:W,height:H}=N;p.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([V,B]),topRight:o.canvasToWorld([V+W,B]),bottomLeft:o.canvasToWorld([V,B+H]),bottomRight:o.canvasToWorld([V+W,B+H])}}return n},this._calculateCachedStats=(e,t,n,o)=>{if(!this.configuration.calculateStats)return;const s=e.data,{element:r}=t,l=e.invalidated,{points:d}=s.handles,h=d.map(e=>t.worldToCanvas(e)),{viewPlaneNormal:g,viewUp:m}=t.getCamera(),[v,f]=(0,C.getCanvasCircleCorners)(h),E=t.canvasToWorld(v),b=t.canvasToWorld(f),{cachedStats:_}=s,S=Object.keys(_),D=E,y=b;for(let n=0;n<S.length;n++){const o=S[n],s=this.getTargetImageData(o);if(!s)continue;const{dimensions:r,imageData:l,metadata:d,voxelManager:c}=s,h=A(l,D);h[0]=Math.floor(h[0]),h[1]=Math.floor(h[1]),h[2]=Math.floor(h[2]);const u=A(l,y);if(u[0]=Math.floor(u[0]),u[1]=Math.floor(u[1]),u[2]=Math.floor(u[2]),this._isInsideVolume(h,u,r)){const n=[[Math.min(h[0],u[0]),Math.max(h[0],u[0])],[Math.min(h[1],u[1]),Math.max(h[1],u[1])],[Math.min(h[2],u[2]),Math.max(h[2],u[2])]],r=[(E[0]+b[0])/2,(E[1]+b[1])/2,(E[2]+b[2])/2],v=Math.abs(E[0]-b[0])/2,f=Math.abs(E[1]-b[1])/2,C=Math.abs(E[2]-b[2])/2,A={center:r,xRadius:v<i.EPSILON/2?0:v,yRadius:f<i.EPSILON/2?0:f,zRadius:C<i.EPSILON/2?0:C},{worldWidth:S,worldHeight:M}=(0,p.A)(g,m,D,y),x=0===S&&0===M,R=[h,u],{scale:P,unit:L,areaUnit:k}=(0,a.Op)(s,R),O=(0,a.CQ)(s),U=Math.abs(Math.PI*(S/P/2)*(M/O/P/2)),N={isPreScaled:(0,I.u)(t,o),isSuvScaled:this.isSuvScaled(t,o,e.metadata.referencedImageId)},V=(0,w.j)(d.Modality,e.metadata.referencedImageId,N);let B;c&&(B=c.forEach(this.configuration.statsCalculator.statsCallback,{isInObject:e=>(0,T.pointInEllipse)(A,e,{fast:!0}),boundsIJK:n,imageData:l,returnPoints:this.configuration.storePointData}));const W=this.configuration.statsCalculator.getStatistics();_[o]={Modality:d.Modality,area:U,mean:W.mean?.value,max:W.max?.value,min:W.min?.value,pointsInShape:B,stdDev:W.stdDev?.value,statsArray:W.array,isEmptyArea:x,areaUnit:k,radius:S/2/P,radiusUnit:L,perimeter:2*Math.PI*(S/2)/P,modalityUnit:V}}else this.isHandleOutsideImage=!0,_[o]={Modality:d.Modality}}return e.invalidated=!1,l&&(0,c.triggerAnnotationModified)(e,r,u.ChangeTypes.StatsUpdated),_},this._isInsideVolume=(e,t,n)=>i.utilities.indexWithinDimensions(e,n)&&i.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=(0,s.A)(this._calculateCachedStats,100,{trailing:!0})}static{this.hydrate=(e,t,n)=>{const o=(0,i.getEnabledElementByViewportId)(e);if(!o)return;const{FrameOfReferenceUID:a,referencedImageId:s,viewPlaneNormal:l,instance:d,viewport:c}=this.hydrateBase(_,o,t,n),{toolInstance:h,...g}=n||{},u={annotationUID:n?.annotationUID||i.utilities.uuidv4(),data:{handles:{points:t,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:d.getToolName(),viewPlaneNormal:l,FrameOfReferenceUID:a,referencedImageId:s,...g}};(0,r.addAnnotation)(u,c.element),(0,E.A)([c.id])}}}function S(e,t){const n=e.cachedStats[t],{radius:o,radiusUnit:a,area:s,mean:r,stdDev:l,max:d,min:c,isEmptyArea:h,areaUnit:g,modalityUnit:u}=n,m=[];if(i.utilities.isNumber(o)){const e=h?"Radius: Oblique not supported":`Radius: ${i.utilities.roundNumber(o)} ${a}`;m.push(e)}if(i.utilities.isNumber(s)){const e=h?"Area: Oblique not supported":`Area: ${i.utilities.roundNumber(s)} ${g}`;m.push(e)}return i.utilities.isNumber(r)&&m.push(`Mean: ${i.utilities.roundNumber(r)} ${u}`),i.utilities.isNumber(d)&&m.push(`Max: ${i.utilities.roundNumber(d)} ${u}`),i.utilities.isNumber(c)&&m.push(`Min: ${i.utilities.roundNumber(c)} ${u}`),i.utilities.isNumber(l)&&m.push(`Std Dev: ${i.utilities.roundNumber(l)} ${u}`),m}const D=_},99718:(e,t,n)=>{"use strict";n.d(t,{A:()=>b});var o=n(3823),i=n(99737),a=n(15327),s=n(85817),r=n(27730),l=n(82056),d=n(2076),c=n(44049),h=n(93258),g=n(25963),u=n(82983),m=n(74347),v=n(85204),p=n(60810),f=n(473),E=n(58640),w=n(7001),I=n(29601);class C extends s.EC{static{this.toolName="CobbAngle"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:T,showArcLines:!1}}){super(e,t),this.addNewAnnotation=e=>{if(this.angleStartedNotYetCompleted)return;this.angleStartedNotYetCompleted=!0;const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,s=(0,a.getEnabledElement)(o),{viewport:r,renderingEngine:d}=s;(0,w.hideElementCursor)(o),this.isDrawing=!0;const c=r.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(r,i,h,g),m=r.getFrameOfReferenceUID(),v={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:m,referencedImageId:u,...r.getViewReference({points:[i]})},data:{handles:{points:[[...i],[...i]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,l.addAnnotation)(v,o);const f=(0,p.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:v,viewportIdsToRender:f,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),e.preventDefault(),(0,E.A)(f),v},this.isPointNearTool=(e,t,n,o)=>{const i=(0,a.getEnabledElement)(e),{viewport:s}=i,{data:r}=t,{distanceToPoint:l,distanceToPoint2:d}=this.distanceToLines({viewport:s,points:r.handles.points,canvasCoords:n,proximity:o});return l<=o||d<=o},this.toolSelectedCallback=(e,t,n,o,i=6)=>{const s=e.detail,{element:r}=s;t.highlighted=!0;const l=(0,p.getViewportIdsWithToolToRender)(r,this.getToolName()),d=(0,a.getEnabledElement)(r),{renderingEngine:c,viewport:h}=d,{isNearFirstLine:g,isNearSecondLine:u}=this.distanceToLines({viewport:h,points:t.data.handles.points,canvasCoords:o,proximity:i});this.editData={annotation:t,viewportIdsToRender:l,movingTextBox:!1,isNearFirstLine:g,isNearSecondLine:u},this._activateModify(r),(0,w.hideElementCursor)(r),(0,E.A)(l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:s,hasMoved:r}=this.editData,{data:d}=o;if(s&&!r)return;if(this.doneEditMemo(),this.angleStartedNotYetCompleted&&d.handles.points.length<4)return(0,w.resetElementCursor)(n),void(this.editData.handleIndex=d.handles.points.length);this.angleStartedNotYetCompleted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,w.resetElementCursor)(n);const h=(0,a.getEnabledElement)(n),{renderingEngine:g}=h;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,l.removeAnnotation)(o.annotationUID),(0,E.A)(i),s&&(0,c.triggerAnnotationCompleted)(o),this.editData=null,this.isDrawing=!1},this._mouseDownCallback=e=>{const{annotation:t,handleIndex:n}=this.editData,o=e.detail,{element:i,currentPoints:a}=o,s=a.world,{data:r}=t;return 1===n?(r.handles.points[1]=s,void(this.editData.hasMoved=r.handles.points[1][0]!==r.handles.points[0][0]||r.handles.points[1][1]!==r.handles.points[0][0])):3===n?(r.handles.points[3]=s,this.editData.hasMoved=r.handles.points[3][0]!==r.handles.points[2][0]||r.handles.points[3][1]!==r.handles.points[2][0],void(this.angleStartedNotYetCompleted=!1)):(this.editData.hasMoved=!1,(0,w.hideElementCursor)(i),r.handles.points[2]=r.handles.points[3]=s,void(this.editData.handleIndex=r.handles.points.length-1))},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:s,handleIndex:r,movingTextBox:l,isNearFirstLine:d,isNearSecondLine:h,newAnnotation:g}=this.editData;this.createMemo(n,o,{newAnnotation:g});const{data:u}=o;if(l){const{deltaPoints:e}=t,n=e.world,{textBox:o}=u.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===r&&(d||h)){const{deltaPoints:e}=t,n=e.world,i=u.handles.points;if(d){[i[0],i[1]].forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})}else if(h){[i[2],i[3]].forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]})}o.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;u.handles.points[r]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const m=(0,a.getEnabledElement)(n),{renderingEngine:v}=m;(0,E.A)(s),o.invalidated&&(0,c.triggerAnnotationModified)(o,n,i.ChangeTypes.HandlesUpdated)},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,w.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;i.handles.points.length<4&&(0,l.removeAnnotation)(t.annotationUID),t.highlighted=!1,i.handles.activeHandleIndex=null;const s=(0,a.getEnabledElement)(e),{renderingEngine:r}=s;return(0,E.A)(n),o&&(0,c.triggerAnnotationCompleted)(t),this.editData=null,this.angleStartedNotYetCompleted=!1,t.annotationUID},this._activateModify=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(i.Events.MOUSE_UP,this._endCallback),e.addEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(i.Events.TOUCH_END,this._endCallback),e.addEventListener(i.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(i.Events.TOUCH_START,this._mouseDownCallback),e.addEventListener(i.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(i.Events.MOUSE_UP,this._endCallback),e.removeEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(i.Events.TOUCH_END,this._endCallback),e.removeEventListener(i.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(i.Events.TOUCH_START,this._mouseDownCallback),e.removeEventListener(i.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{v.wk.isInteractingWithTool=!0,e.addEventListener(i.Events.MOUSE_UP,this._endCallback),e.addEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(i.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(i.Events.MOUSE_DOWN,this._mouseDownCallback),e.addEventListener(i.Events.TOUCH_END,this._endCallback),e.addEventListener(i.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(i.Events.TOUCH_START,this._mouseDownCallback),e.addEventListener(i.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{v.wk.isInteractingWithTool=!1,e.removeEventListener(i.Events.MOUSE_UP,this._endCallback),e.removeEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(i.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(i.Events.MOUSE_DOWN,this._mouseDownCallback),e.removeEventListener(i.Events.TOUCH_END,this._endCallback),e.removeEventListener(i.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(i.Events.TOUCH_START,this._mouseDownCallback),e.removeEventListener(i.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=(0,l.getAnnotations)(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const s=this.getTargetId(o),r=o.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const l=a[i],{annotationUID:h,data:g}=l,{points:v,activeHandleIndex:p}=g.handles;c.annotationUID=h;const{color:E,lineWidth:w,lineDash:C}=this.getAnnotationStyle({annotation:l,styleSpecifier:c}),T=v.map(e=>o.worldToCanvas(e));let b;if(g.cachedStats[s]&&null!=g.cachedStats[s].angle?l.invalidated&&this._throttledCalculateCachedStats(l,r,e):(g.cachedStats[s]={angle:null,arc1Angle:null,arc2Angle:null,points:{world:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null},canvas:{arc1Start:null,arc1End:null,arc2Start:null,arc2End:null,arc1Angle:null,arc2Angle:null}}},this._calculateCachedStats(l,r,e)),(0,d.isAnnotationLocked)(h)||this.editData||null===p||(b=[T[p]]),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,I.isAnnotationVisible)(h))continue;if(b){const e="0";(0,m.drawHandles)(t,h,e,T,{color:E,lineDash:C,lineWidth:w})}const A=[T[0],T[1]],_=[T[2],T[3]];let S="line1";if((0,m.drawLine)(t,h,S,A[0],A[1],{color:E,width:w,lineDash:C}),n=!0,T.length<4)return n;S="line2",(0,m.drawLine)(t,h,S,_[0],_[1],{color:E,width:w,lineDash:C}),S="linkLine";const D=(0,u.f)(A[0],A[1]),y=(0,u.f)(_[0],_[1]);(0,m.drawLine)(t,h,S,D,y,{color:E,lineWidth:"1",lineDash:"1,4"});const{arc1Start:M,arc1End:x,arc2End:R,arc2Start:P}=g.cachedStats[s].points.canvas,{arc1Angle:L,arc2Angle:k}=g.cachedStats[s];if(this.configuration.showArcLines&&(S="arc1",(0,m.drawLine)(t,h,S,M,x,{color:E,lineWidth:"1"}),S="arc2",(0,m.drawLine)(t,h,S,P,R,{color:E,lineWidth:"1"})),!g.cachedStats[s]?.angle)continue;const O=this.getLinkedTextBoxStyle(c,l);if(!O.visibility){g.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const U=this.configuration.getTextLines(g,s);if(!g.handles.textBox.hasMoved){const e=(0,f.getTextBoxCoordsCanvas)(T);g.handles.textBox.worldPosition=o.canvasToWorld(e)}const N=o.worldToCanvas(g.handles.textBox.worldPosition),V="cobbAngleText",B=(0,m.drawLinkedTextBox)(t,h,V,U,N,T,{},O),{x:W,y:H,width:F,height:G}=B;if(g.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([W,H]),topRight:o.canvasToWorld([W+F,H]),bottomLeft:o.canvasToWorld([W,H+G]),bottomRight:o.canvasToWorld([W+F,H+G])},this.configuration.showArcLines){const e="arcAngle1",n=[`${L.toFixed(2)} ${String.fromCharCode(176)}`],o=(0,u.f)(M,x);(0,m.drawTextBox)(t,h,e,n,o,{...O,padding:3});const i="arcAngle2",a=[`${k.toFixed(2)} ${String.fromCharCode(176)}`],s=(0,u.f)(P,R);(0,m.drawTextBox)(t,h,i,a,s,{...O,padding:3})}}return n},this.distanceToLines=({viewport:e,points:t,canvasCoords:n,proximity:o})=>{const[i,a,s,r]=t,l=e.worldToCanvas(i),d=e.worldToCanvas(a),c=e.worldToCanvas(s),g=e.worldToCanvas(r),u={start:{x:l[0],y:l[1]},end:{x:d[0],y:d[1]}},m={start:{x:c[0],y:c[1]},end:{x:g[0],y:g[1]}},v=h.distanceToPoint([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]]),p=h.distanceToPoint([m.start.x,m.start.y],[m.end.x,m.end.y],[n[0],n[1]]);let f=!1,E=!1;return v<=o?f=!0:p<=o&&(E=!0),{distanceToPoint:v,distanceToPoint2:p,isNearFirstLine:f,isNearSecondLine:E}},this.getArcsStartEndPoints=({firstLine:e,secondLine:t,mid1:n,mid2:o})=>{const i=[n,o],a=(0,g.A)(e,i),s=(0,g.A)(t,i),r=a>90?1:0,l=s>90?0:1,d=(0,u.f)(i[0],i[1]),c=Math.sqrt((i[1][0]-i[0][0])**2+(i[1][1]-i[0][1])**2),h=.1,m=(0,u.f)(e[0],e[1]),v=(0,u.f)(t[0],t[1]),p=[e[r][0]-m[0],e[r][1]-m[1]],f=Math.sqrt(p[0]**2+p[1]**2),E=[p[0]/f,p[1]/f],w=[m[0]+E[0]*c*h,m[1]+E[1]*c*h],I=[d[0]-n[0],d[1]-n[1]],C=Math.sqrt(I[0]**2+I[1]**2),T=[I[0]/C,I[1]/C],b=[n[0]+T[0]*c*h,n[1]+T[1]*c*h],A=[t[l][0]-v[0],t[l][1]-v[1]],_=Math.sqrt(A[0]**2+A[1]**2),S=[A[0]/_,A[1]/_],D=[v[0]+S[0]*c*h,v[1]+S[1]*c*h],y=[d[0]-o[0],d[1]-o[1]],M=Math.sqrt(y[0]**2+y[1]**2),x=[y[0]/M,y[1]/M];return{arc1Start:w,arc1End:b,arc2Start:D,arc2End:[o[0]+x[0]*c*h,o[1]+x[1]*c*h],arc1Angle:a>90?180-a:a,arc2Angle:s>90?180-s:s}},this._throttledCalculateCachedStats=(0,r.A)(this._calculateCachedStats,25,{trailing:!0})}handleSelectedCallback(e,t,n,o="mouse"){const i=e.detail,{element:a}=i,{data:s}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex(e=>e===n);const d=(0,p.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,w.hideElementCursor)(a),(0,E.A)(d),e.preventDefault()}_calculateCachedStats(e,t,n){const a=e.data;if(4!==a.handles.points.length)return;const s=[null,null],r=[null,null];let l=Number.MAX_VALUE;for(let e=0;e<2;e+=1)for(let t=2;t<4;t+=1){const n=o.eR.distance(a.handles.points[e],a.handles.points[t]);n<l&&(l=n,s[1]=a.handles.points[e],s[0]=a.handles.points[(e+1)%2],r[0]=a.handles.points[t],r[1]=a.handles.points[2+(t-1)%2])}const{viewport:d}=n,{element:h}=d,m=a.handles.points.map(e=>d.worldToCanvas(e)),v=[m[0],m[1]],p=[m[2],m[3]],f=(0,u.f)(v[0],v[1]),E=(0,u.f)(p[0],p[1]),{arc1Start:w,arc1End:I,arc2End:C,arc2Start:T,arc1Angle:b,arc2Angle:A}=this.getArcsStartEndPoints({firstLine:v,secondLine:p,mid1:f,mid2:E}),{cachedStats:_}=a,S=Object.keys(_);for(let e=0;e<S.length;e++){_[S[e]]={angle:(0,g.A)(s,r),arc1Angle:b,arc2Angle:A,points:{canvas:{arc1Start:w,arc1End:I,arc2End:C,arc2Start:T},world:{arc1Start:d.canvasToWorld(w),arc1End:d.canvasToWorld(I),arc2End:d.canvasToWorld(C),arc2Start:d.canvasToWorld(T)}}}}const D=e.invalidated;return e.invalidated=!1,D&&(0,c.triggerAnnotationModified)(e,h,i.ChangeTypes.StatsUpdated),_}}function T(e,t){const n=e.cachedStats[t],{angle:o}=n;if(void 0===o)return;return[`${o.toFixed(2)} ${String.fromCharCode(176)}`]}const b=C},40487:(e,t,n)=>{"use strict";n.d(t,{A:()=>h});var o=n(15327),i=n(74347),a=n(60810),s=n(7001),r=n(58640),l=n(61873);class d extends l.A{static{this.toolName="DragProbe"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:c}}){super(e,t),this.postMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:i}=t,l=n.world,d=(0,o.getEnabledElement)(i),{viewport:c,renderingEngine:h}=d;this.isDrawing=!0;const g=c.getCamera(),{viewPlaneNormal:u,viewUp:m}=g,v=this.getReferencedImageId(c,l,u,m),p={invalidated:!0,highlighted:!0,isVisible:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...u],viewUp:[...m],FrameOfReferenceUID:c.getFrameOfReferenceUID(),referencedImageId:v},data:{label:"",handles:{points:[[...l]]},cachedStats:{}}},f=(0,a.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:p,newAnnotation:!0,viewportIdsToRender:f},this._activateModify(i),(0,s.hideElementCursor)(i),e.preventDefault(),(0,r.A)(f),p},this.postTouchStartCallback=e=>this.postMouseDownCallback(e),this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e;if(!this.editData)return n;const a=this.filterInteractableAnnotationsForElement(o.element,[this.editData.annotation]);if(!a?.length)return n;const s=this.getTargetId(o),r=o.getRenderingEngine(),l={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},d=this.editData.annotation,c=d.annotationUID,h=d.data,g=h.handles.points[0],u=o.worldToCanvas(g);l.annotationUID=c;const{color:m}=this.getAnnotationStyle({annotation:d,styleSpecifier:l});if(h.cachedStats[s]&&null!==h.cachedStats[s].value?d.invalidated&&this._calculateCachedStats(d,r,e):(h.cachedStats[s]={Modality:null,index:null,value:null},this._calculateCachedStats(d,r,e)),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;(0,i.drawHandles)(t,c,"0",[u],{color:m}),n=!0;const v=this.configuration.getTextLines(h,s);if(v){const e=[u[0]+6,u[1]-6],n="0";(0,i.drawTextBox)(t,c,n,v,[e[0],e[1]],this.getLinkedTextBoxStyle(l,d))}return n}}}function c(e,t){const n=e.cachedStats[t],{index:o,value:i,modalityUnit:a}=n;if(void 0===i)return;const s=[];return s.push(`(${o[0]}, ${o[1]}, ${o[2]})`),s.push(`${i.toFixed(2)} ${a}`),s}const h=d},8467:(e,t,n)=>{"use strict";n.d(t,{A:()=>f});var o=n(85817),i=n(15327),a=n(82056),s=n(29601),r=n(44049),l=n(74347),d=n(85204),c=n(99737),h=n(60810),g=n(7001),u=n(58640),m=n(77081),v=n(3823);class p extends o.EC{static{this.toolName="ETDRSGrid"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,degrees:[45,135,225,315],diameters:[10,30,60]}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,s=n.world,r=(0,i.getEnabledElement)(o),{viewport:l,renderingEngine:d}=r;this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:m,viewUp:v}=c,p=this.getReferencedImageId(l,s,m,v),f=l.getFrameOfReferenceUID(),E={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...m],viewUp:[...v],FrameOfReferenceUID:f,referencedImageId:p,...l.getViewReference({points:[s]})},data:{label:"",handles:{points:[[...s]]}}};(0,a.addAnnotation)(E,o);const w=(0,h.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:E,viewportIdsToRender:w,newAnnotation:!0},this._activateDraw(o),(0,g.hideElementCursor)(o),e.preventDefault(),(0,u.A)(w),E},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{points:l}=r.handles,d=s.worldToCanvas(l[0]),c=(0,m.getCanvasCircleRadius)([d,n]);return Math.abs(c)<o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,h.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a},(0,g.hideElementCursor)(o),this._activateModify(o);const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;(0,u.A)(a),e.preventDefault()},this.handleSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,h.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a},this._activateModify(o),(0,g.hideElementCursor)(o);const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;(0,u.A)(a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:s,newAnnotation:l,hasMoved:d}=this.editData,{data:c}=o;if(l&&!d)return;o.highlighted=!1,c.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,g.resetElementCursor)(n);const{renderingEngine:h}=(0,i.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,a.removeAnnotation)(o.annotationUID),(0,u.A)(s),l&&(0,r.triggerAnnotationCompleted)(o)},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,a=o.canvas,s=(0,i.getEnabledElement)(n),{renderingEngine:r,viewport:l}=s,{canvasToWorld:d}=l,{annotation:c,viewportIdsToRender:h}=this.editData,{data:g}=c;g.handles.points=[d(a),d(a)],c.invalidated=!0,this.editData.hasMoved=!0,(0,u.A)(h)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a}=this.editData,{data:s}=o,{deltaPoints:r}=t,l=r.world;s.handles.points.forEach(e=>{e[0]+=l[0],e[1]+=l[1],e[2]+=l[2]}),o.invalidated=!0;const d=(0,i.getEnabledElement)(n),{renderingEngine:c}=d;(0,u.A)(a)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,o=(0,i.getEnabledElement)(n),{canvasToWorld:a,worldToCanvas:s}=o.viewport,{annotation:r}=this.editData,{data:l}=r,{points:d}=l.handles,c=d.map(e=>s(e)),{currentPoints:h}=t,g=h.canvas,u=g[0]-c[0][0],m=g[1]-c[0][1],v=g,p=[c[1][0]+u,c[1][1]+m];d[0]=a(v),d[1]=a(p)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,g.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;const{renderingEngine:s}=(0,i.getEnabledElement)(e);return(0,u.A)(n),o&&(0,r.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{d.wk.isInteractingWithTool=!0,e.addEventListener(c.Events.MOUSE_UP,this._endCallback),e.addEventListener(c.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(c.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(c.Events.TOUCH_END,this._endCallback),e.addEventListener(c.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(c.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{d.wk.isInteractingWithTool=!1,e.removeEventListener(c.Events.MOUSE_UP,this._endCallback),e.removeEventListener(c.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(c.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(c.Events.TOUCH_END,this._endCallback),e.removeEventListener(c.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(c.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{d.wk.isInteractingWithTool=!0,e.addEventListener(c.Events.MOUSE_UP,this._endCallback),e.addEventListener(c.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(c.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(c.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(c.Events.TOUCH_END,this._endCallback),e.addEventListener(c.Events.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(c.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{d.wk.isInteractingWithTool=!1,e.removeEventListener(c.Events.MOUSE_UP,this._endCallback),e.removeEventListener(c.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(c.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(c.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(c.Events.TOUCH_END,this._endCallback),e.removeEventListener(c.Events.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(c.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let r=(0,a.getAnnotations)(this.getToolName(),i);if(!r?.length)return n;if(r=this.filterInteractableAnnotationsForElement(i,r),!r?.length)return n;const d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<r.length;e++){const i=r[e],{annotationUID:a,data:c}=i,{handles:h}=c,{points:g}=h;d.annotationUID=a;const{color:u,lineWidth:m,lineDash:v}=this.getAnnotationStyle({annotation:i,styleSpecifier:d}),p=g.map(e=>o.worldToCanvas(e))[0];if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,s.isAnnotationVisible)(a))continue;let f=`${a}-crosshair-vertical`,E=[p[0],p[1]+5],w=[p[0],p[1]-5];(0,l.drawLine)(t,a,f,E,w,{color:u,lineDash:v,lineWidth:m}),f=`${a}-crosshair-horizontal`,E=[p[0]+5,p[1]],w=[p[0]-5,p[1]],(0,l.drawLine)(t,a,f,E,w,{color:u,lineDash:v,lineWidth:m});const I=this.configuration.diameters.map(e=>this.worldMeasureToCanvas(e,o));for(let e=0;e<I.length;e++){const n=`${a}-circle-${e}`,o=`${a}-circle-${e}`;(0,l.drawCircle)(t,a,o,p,I[e]/2,{color:u,lineDash:v,lineWidth:m},n)}const C=e=>e*Math.PI/180,T=this.configuration.degrees.map(e=>C(e));for(let e=0;e<T.length;e++){const n=`${a}-line-${e}`,o=[Math.cos(T[e])*I[0]/2+p[0],Math.sin(T[e])*I[0]/2+p[1]],i=[Math.cos(T[e])*I[2]/2+p[0],Math.sin(T[e])*I[2]/2+p[1]];(0,l.drawLine)(t,a,n,o,i,{color:u,lineDash:v,lineWidth:m})}n=!0}return n}}worldMeasureToCanvas(e,t){const n=t.canvasToWorld([t.canvas.width/2,t.canvas.height/2]),{viewUp:o}=t.getCamera(),i=v.eR.scaleAndAdd(v.eR.create(),n,o,e),a=t.worldToCanvas(n),s=t.worldToCanvas(i);return Math.sqrt(Math.pow(s[0]-a[0],2)+Math.pow(s[1]-a[1],2))}}const f=p},78684:(e,t,n)=>{"use strict";n.d(t,{A:()=>D});var o=n(85817),i=n(15327),a=n(4096),s=n(27730),r=n(82056),l=n(2076),d=n(29601),c=n(44049),h=n(74347),g=n(85204),u=n(99737),m=n(60810),v=n(473),p=n(62514),f=n(11683),E=n(7001),w=n(58640),I=n(40634),C=n(18990),T=n(73262),b=n(3823);const{transformWorldToIndex:A}=i.utilities;class _ extends o.EC{static{this.toolName="EllipticalROI"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,storePointData:!1,centerPointRadius:0,calculateStats:!0,getTextLines:S,statsCalculator:T.BasicStatsCalculator}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,s=(n.canvas,(0,i.getEnabledElement)(o)),{viewport:l,renderingEngine:d}=s;this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:h,viewUp:g}=c,u=this.getReferencedImageId(l,a,h,g),v=l.getFrameOfReferenceUID(),p={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...h],viewUp:[...g],FrameOfReferenceUID:v,referencedImageId:u,...l.getViewReference({points:[a]})},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},cachedStats:{},initialRotation:l.getRotation()}};(0,r.addAnnotation)(p,o);const f=(0,m.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:p,viewportIdsToRender:f,centerWorld:a,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),(0,E.hideElementCursor)(o),e.preventDefault(),(0,w.A)(f),p},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{points:l}=r.handles,d=l.map(e=>s.worldToCanvas(e)),[c,h,g,u]=d,m=Math.hypot(g[0]-u[0],g[1]-u[1]),v=Math.hypot(h[0]-c[0],h[1]-c[1]),p=Math.atan2(g[1]-u[1],g[0]-u[0]),f=[(g[0]+u[0])/2,(h[1]+c[1])/2],E={center:f,xRadius:(m-o)/2,yRadius:(v-o)/2,angle:p},w={center:f,xRadius:(m+o)/2,yRadius:(v+o)/2,angle:p},I=this._pointInEllipseCanvas(E,n);return!(!this._pointInEllipseCanvas(w,n)||I)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,m.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},(0,E.hideElementCursor)(o),this._activateModify(o);const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;(0,w.A)(a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;let r,l,d,c,h,g,u=!1;if(n.worldPosition)u=!0;else{const{points:e}=s.handles,{viewport:t}=(0,i.getEnabledElement)(a),{worldToCanvas:o,canvasToWorld:u}=t;r=e.findIndex(e=>e===n);const m=e.map(o);g=m[r],c=Math.abs(m[2][0]-m[3][0]),h=Math.abs(m[0][1]-m[1][1]),l=[(m[2][0]+m[3][0])/2,(m[0][1]+m[1][1])/2],d=u(l)}const v=(0,m.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:v,handleIndex:r,canvasWidth:c,canvasHeight:h,centerWorld:d,originalHandleCanvas:g,movingTextBox:u},this._activateModify(a),(0,E.hideElementCursor)(a),(0,w.A)(v),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:s}=this.editData,{data:l}=o;a&&!s||(this.doneEditMemo(),o.highlighted=!1,l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,E.resetElementCursor)(n),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(o.annotationUID),(0,w.A)(i),a&&(0,c.triggerAnnotationCompleted)(o))},this._dragDrawCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:o}=t,a=o.canvas,s=(0,i.getEnabledElement)(n),{viewport:r}=s,{canvasToWorld:l}=r,{annotation:d,viewportIdsToRender:h,centerWorld:g,newAnnotation:m}=this.editData;this.createMemo(n,d,{newAnnotation:m});const v=r.worldToCanvas(g),{data:p}=d,f=Math.abs(a[0]-v[0]),E=Math.abs(a[1]-v[1]),I=[v[0],v[1]-E],C=[v[0],v[1]+E],T=[v[0]-f,v[1]],b=[v[0]+f,v[1]];p.handles.points=[l(I),l(C),l(T),l(b)],d.invalidated=!0,this.editData.hasMoved=!0,(0,w.A)(h),(0,c.triggerAnnotationModified)(d,n,u.ChangeTypes.HandlesUpdated)},this._dragModifyCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,handleIndex:s,movingTextBox:r,newAnnotation:l}=this.editData;this.createMemo(n,o,{newAnnotation:l});const{data:d}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=d.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;d.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),o.invalidated=!0}else this._dragHandle(e),o.invalidated=!0;const h=(0,i.getEnabledElement)(n),{renderingEngine:g}=h;(0,w.A)(a),o.invalidated&&(0,c.triggerAnnotationModified)(o,n,u.ChangeTypes.HandlesUpdated)},this._dragHandle=e=>{const t=e.detail,{element:n}=t,{viewport:o}=(0,i.getEnabledElement)(n),{canvasToWorld:a,worldToCanvas:s}=o,{annotation:r,canvasWidth:l,canvasHeight:d,handleIndex:c,centerWorld:h,originalHandleCanvas:g}=this.editData,u=o.worldToCanvas(h),{data:m}=r,{points:v}=m.handles,{currentPoints:p}=t,f=p.canvas;if(0===c||1===c){const e=Math.abs(f[1]-u[1]),t=[u[0],u[1]-e],n=[u[0],u[1]+e];v[0]=a(t),v[1]=a(n);const o=l/2+(f[0]-g[0]),i=[u[0]-o,u[1]],s=[u[0]+o,u[1]];v[2]=a(i),v[3]=a(s)}else{const e=Math.abs(f[0]-u[0]),t=[u[0]-e,u[1]],n=[u[0]+e,u[1]];v[2]=a(t),v[3]=a(n);const o=d/2+(f[1]-g[1]),i=[u[0],u[1]-o],s=[u[0],u[1]+o];v[0]=a(i),v[1]=a(s)}},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,E.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;return t.highlighted=!1,i.handles.activeHandleIndex=null,(0,w.A)(n),o&&(0,c.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{g.wk.isInteractingWithTool=!0,e.addEventListener(u.Events.MOUSE_UP,this._endCallback),e.addEventListener(u.Events.MOUSE_DRAG,this._dragModifyCallback),e.addEventListener(u.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(u.Events.TOUCH_END,this._endCallback),e.addEventListener(u.Events.TOUCH_DRAG,this._dragModifyCallback),e.addEventListener(u.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{g.wk.isInteractingWithTool=!1,e.removeEventListener(u.Events.MOUSE_UP,this._endCallback),e.removeEventListener(u.Events.MOUSE_DRAG,this._dragModifyCallback),e.removeEventListener(u.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(u.Events.TOUCH_END,this._endCallback),e.removeEventListener(u.Events.TOUCH_DRAG,this._dragModifyCallback),e.removeEventListener(u.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{g.wk.isInteractingWithTool=!0,e.addEventListener(u.Events.MOUSE_UP,this._endCallback),e.addEventListener(u.Events.MOUSE_DRAG,this._dragDrawCallback),e.addEventListener(u.Events.MOUSE_MOVE,this._dragDrawCallback),e.addEventListener(u.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(u.Events.TOUCH_END,this._endCallback),e.addEventListener(u.Events.TOUCH_DRAG,this._dragDrawCallback),e.addEventListener(u.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{g.wk.isInteractingWithTool=!1,e.removeEventListener(u.Events.MOUSE_UP,this._endCallback),e.removeEventListener(u.Events.MOUSE_DRAG,this._dragDrawCallback),e.removeEventListener(u.Events.MOUSE_MOVE,this._dragDrawCallback),e.removeEventListener(u.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(u.Events.TOUCH_END,this._endCallback),e.removeEventListener(u.Events.TOUCH_DRAG,this._dragDrawCallback),e.removeEventListener(u.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:a}=o;let s=(0,r.getAnnotations)(this.getToolName(),a);if(!s?.length)return n;if(s=this.filterInteractableAnnotationsForElement(a,s),!s?.length)return n;const c=this.getTargetId(o),g=o.getRenderingEngine(),u={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<s.length;a++){const r=s[a],{annotationUID:m,data:p}=r,{handles:E}=p,{points:w,activeHandleIndex:I}=E;u.annotationUID=m;const{color:C,lineWidth:T,lineDash:b}=this.getAnnotationStyle({annotation:r,styleSpecifier:u}),A=w.map(e=>o.worldToCanvas(e)),_=(0,f.getCanvasEllipseCorners)(A),{centerPointRadius:S}=this.configuration;if(p.cachedStats[c]&&null!=p.cachedStats[c].areaUnit){if(r.invalidated&&(this._throttledCalculateCachedStats(r,o,g,e),o instanceof i.VolumeViewport)){const{referencedImageId:e}=r.metadata;for(const t in p.cachedStats)if(t.startsWith("imageId")){g.getStackViewports().find(t=>{const n=i.utilities.imageIdToURI(e),o=t.hasImageURI(n),a=i.utilities.imageIdToURI(t.getCurrentImageId());return o&&a!==n})&&delete p.cachedStats[t]}}}else p.cachedStats[c]={Modality:null,area:null,max:null,mean:null,stdDev:null,areaUnit:null},this._calculateCachedStats(r,o,g);if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let D;if(!(0,d.isAnnotationVisible)(m))continue;if((0,l.isAnnotationLocked)(m)||this.editData||null===I||(D=[A[I]]),D){const e="0";(0,h.drawHandles)(t,m,e,D,{color:C})}const y=`${m}-ellipse`,M="0";if((0,h.drawEllipseByCoordinates)(t,m,M,A,{color:C,lineDash:b,lineWidth:T},y),S>0){if(Math.min(Math.abs(_[0][0]-_[1][0])/2,Math.abs(_[0][1]-_[1][1])/2)>3*S){const e=this._getCanvasEllipseCenter(A);(0,h.drawCircle)(t,m,`${M}-center`,e,S,{color:C,lineDash:b,lineWidth:T})}}n=!0;const x=this.getLinkedTextBoxStyle(u,r);if(!x.visibility){p.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const R=this.configuration.getTextLines(p,c);if(!R||0===R.length)continue;let P;p.handles.textBox.hasMoved||(P=(0,v.getTextBoxCoordsCanvas)(_),p.handles.textBox.worldPosition=o.canvasToWorld(P));const L=o.worldToCanvas(p.handles.textBox.worldPosition),k="1",O=(0,h.drawLinkedTextBox)(t,m,k,R,L,A,{},x),{x:U,y:N,width:V,height:B}=O;p.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([U,N]),topRight:o.canvasToWorld([U+V,N]),bottomLeft:o.canvasToWorld([U,N+B]),bottomRight:o.canvasToWorld([U+V,N+B])}}return n},this._calculateCachedStats=(e,t,n)=>{if(!this.configuration.calculateStats)return;const o=e.data,{element:i}=t,{points:s}=o.handles,r=s.map(e=>t.worldToCanvas(e)),{viewPlaneNormal:l,viewUp:d}=t.getCamera(),[h,g]=(0,f.getCanvasEllipseCorners)(r),m=t.canvasToWorld(h),v=t.canvasToWorld(g),{cachedStats:E}=o,w=Object.keys(E),T=m,b=v;for(let n=0;n<w.length;n++){const o=w[n],i=this.getTargetImageData(o);if(!i)continue;const{dimensions:s,imageData:r,metadata:c,voxelManager:h}=i,g=A(r,T);g[0]=Math.floor(g[0]),g[1]=Math.floor(g[1]),g[2]=Math.floor(g[2]);const u=A(r,b);u[0]=Math.floor(u[0]),u[1]=Math.floor(u[1]),u[2]=Math.floor(u[2]),this.isHandleOutsideImage=!this._isInsideVolume(g,u,s);const _=[[Math.min(g[0],u[0]),Math.max(g[0],u[0])],[Math.min(g[1],u[1]),Math.max(g[1],u[1])],[Math.min(g[2],u[2]),Math.max(g[2],u[2])]],S={center:[(m[0]+v[0])/2,(m[1]+v[1])/2,(m[2]+v[2])/2],xRadius:Math.abs(m[0]-v[0])/2,yRadius:Math.abs(m[1]-v[1])/2,zRadius:Math.abs(m[2]-v[2])/2},{worldWidth:D,worldHeight:y}=(0,p.A)(l,d,T,b),M=0===D&&0===y,x=[g,u],{scale:R,areaUnit:P}=(0,a.Op)(i,x),L=Math.abs(Math.PI*(D/2)*(y/2))/R/R,k={isPreScaled:(0,C.u)(t,o),isSuvScaled:this.isSuvScaled(t,o,e.metadata.referencedImageId)},O=(0,I.j)(c.Modality,e.metadata.referencedImageId,k);let U;if(h){h.forEach(this.configuration.statsCalculator.statsCallback,{boundsIJK:_,imageData:r,isInObject:e=>(0,f.pointInEllipse)(S,e,{fast:!0}),returnPoints:this.configuration.storePointData})}const N=this.configuration.statsCalculator.getStatistics();E[o]={Modality:c.Modality,area:L,mean:N.mean?.value,max:N.max?.value,min:N.min?.value,stdDev:N.stdDev?.value,statsArray:N.array,pointsInShape:U,isEmptyArea:M,areaUnit:P,modalityUnit:O}}const _=e.invalidated;return e.invalidated=!1,_&&(0,c.triggerAnnotationModified)(e,i,u.ChangeTypes.StatsUpdated),E},this._isInsideVolume=(e,t,n)=>i.utilities.indexWithinDimensions(e,n)&&i.utilities.indexWithinDimensions(t,n),this._throttledCalculateCachedStats=(0,s.A)(this._calculateCachedStats,100,{trailing:!0})}static{this.hydrate=(e,t,n)=>{const o=(0,i.getEnabledElementByViewportId)(e);if(!o)return;const{FrameOfReferenceUID:a,referencedImageId:s,viewPlaneNormal:l,instance:d,viewport:c}=this.hydrateBase(_,o,t,n),{toolInstance:h,...g}=n||{},u={annotationUID:n?.annotationUID||i.utilities.uuidv4(),data:{handles:{points:t,activeHandleIndex:null},label:"",cachedStats:{}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:d.getToolName(),viewPlaneNormal:l,FrameOfReferenceUID:a,referencedImageId:s,...g}};(0,r.addAnnotation)(u,c.element),(0,w.A)([c.id])}}_pointInEllipseCanvas(e,t){const{xRadius:n,yRadius:o,center:i,angle:a}=e,s=b.Zc.rotate(b.Zc.create(),t,i,-a);if(n<=0||o<=0)return!1;const r=[s[0]-i[0],s[1]-i[1]];return r[0]*r[0]/(n*n)+r[1]*r[1]/(o*o)<=1}_getCanvasEllipseCenter(e){const[t,n,o,i]=e,a=[o[0],n[1]],s=[i[0],t[1]];return[(a[0]+s[0])/2,(a[1]+s[1])/2]}}function S(e,t){const n=e.cachedStats[t],{area:o,mean:a,stdDev:s,max:r,isEmptyArea:l,areaUnit:d,modalityUnit:c,min:h}=n,g=[];if(i.utilities.isNumber(o)){const e=l?"Area: Oblique not supported":`Area: ${i.utilities.roundNumber(o)} ${d}`;g.push(e)}return i.utilities.isNumber(a)&&g.push(`Mean: ${i.utilities.roundNumber(a)} ${c}`),i.utilities.isNumber(r)&&g.push(`Max: ${i.utilities.roundNumber(r)} ${c}`),i.utilities.isNumber(h)&&g.push(`Min: ${i.utilities.roundNumber(h)} ${c}`),i.utilities.isNumber(s)&&g.push(`Std Dev: ${i.utilities.roundNumber(s)} ${c}`),g}const D=_},59320:(e,t,n)=>{"use strict";n.d(t,{A:()=>T});var o=n(99737),i=n(15327),a=n(4096),s=n(85817),r=n(27730),l=n(82056),d=n(2076),c=n(29601),h=n(44049),g=n(93258),u=n(74347),m=n(85204),v=n(60810),p=n(473),f=n(58640),E=n(7001);const{transformWorldToIndex:w}=i.utilities;class I extends s.EC{static{this.toolName="Height"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:C}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,s=(0,i.getEnabledElement)(o),{viewport:r,renderingEngine:d}=s;(0,E.hideElementCursor)(o),this.isDrawing=!0;const{viewPlaneNormal:c,viewUp:h,position:g}=r.getCamera(),u=this.getReferencedImageId(r,a,c,h),m={highlighted:!0,invalidated:!0,metadata:{...r.getViewReference({points:[a]}),toolName:this.getToolName(),referencedImageId:u,viewUp:h,cameraPosition:g},data:{handles:{points:[[...a],[...a]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,l.addAnnotation)(m,o);const p=(0,v.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:m,viewportIdsToRender:p,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),e.preventDefault(),(0,f.A)(p),m},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,[l,d]=r.handles.points,c=s.worldToCanvas(l),h=s.worldToCanvas(d),u={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}};return g.distanceToPoint([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]])<=o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,v.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1},this._activateModify(o),(0,E.hideElementCursor)(o);(0,i.getEnabledElement)(o);(0,f.A)(a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,newAnnotation:s,hasMoved:r}=this.editData,{data:d}=o;if(s&&!r)return;d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,E.resetElementCursor)(n);const c=(0,i.getEnabledElement)(n),{renderingEngine:g}=c;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,l.removeAnnotation)(o.annotationUID),(0,f.A)(a),s&&(0,h.triggerAnnotationCompleted)(o),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=l.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),o.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;l.handles.points[s]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const d=(0,i.getEnabledElement)(n),{renderingEngine:c}=d;(0,f.A)(a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,E.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:a}=t;t.highlighted=!1,a.handles.activeHandleIndex=null;(0,i.getEnabledElement)(e);return(0,f.A)(n),o&&(0,h.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{m.wk.isInteractingWithTool=!0,e.addEventListener(o.Events.MOUSE_UP,this._endCallback),e.addEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(o.Events.TOUCH_END,this._endCallback),e.addEventListener(o.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(o.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{m.wk.isInteractingWithTool=!1,e.removeEventListener(o.Events.MOUSE_UP,this._endCallback),e.removeEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(o.Events.TOUCH_END,this._endCallback),e.removeEventListener(o.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(o.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{m.wk.isInteractingWithTool=!0,e.addEventListener(o.Events.MOUSE_UP,this._endCallback),e.addEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(o.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(o.Events.TOUCH_END,this._endCallback),e.addEventListener(o.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(o.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{m.wk.isInteractingWithTool=!1,e.removeEventListener(o.Events.MOUSE_UP,this._endCallback),e.removeEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(o.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(o.Events.TOUCH_END,this._endCallback),e.removeEventListener(o.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(o.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=(0,l.getAnnotations)(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const s=this.getTargetId(o),r=o.getRenderingEngine(),h={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const l=a[i],{annotationUID:g,data:m}=l,{points:v,activeHandleIndex:f}=m.handles;h.annotationUID=g;const{color:E,lineWidth:w,lineDash:I,shadow:C}=this.getAnnotationStyle({annotation:l,styleSpecifier:h}),T=v.map(e=>o.worldToCanvas(e));let b;if(m.cachedStats[s]&&null!=m.cachedStats[s].unit?l.invalidated&&this._throttledCalculateCachedStats(l,r,e):(m.cachedStats[s]={length:null,unit:null},this._calculateCachedStats(l,r,e)),!(0,c.isAnnotationVisible)(g))continue;if((0,d.isAnnotationLocked)(g)||this.editData||null===f||(b=[T[f]]),b){const e="0";(0,u.drawHandles)(t,g,e,T,{color:E,lineDash:I,lineWidth:w})}const A="0";if((0,u.drawHeight)(t,g,A,T[0],T[1],{color:E,width:w,lineDash:I}),n=!0,!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const _=this.getLinkedTextBoxStyle(h,l);if(!_.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const S=this.configuration.getTextLines(m,s);if(!m.handles.textBox.hasMoved){const e=(0,p.getTextBoxCoordsCanvas)(T);m.handles.textBox.worldPosition=o.canvasToWorld(e)}const D=o.worldToCanvas(m.handles.textBox.worldPosition),y="1",M=(0,u.drawLinkedTextBox)(t,g,y,S,D,T,{},_),{x,y:R,width:P,height:L}=M;m.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([x,R]),topRight:o.canvasToWorld([x+P,R]),bottomLeft:o.canvasToWorld([x,R+L]),bottomRight:o.canvasToWorld([x+P,R+L])}}return n},this._throttledCalculateCachedStats=(0,r.A)(this._calculateCachedStats,100,{trailing:!0})}handleSelectedCallback(e,t,n){const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex(e=>e===n);const d=(0,v.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a),(0,E.hideElementCursor)(a);const c=(0,i.getEnabledElement)(a),{renderingEngine:h}=c;(0,f.A)(d),e.preventDefault()}_calculateHeight(e,t){const n=t[0]-e[0],o=t[1]-e[1],i=t[2]-e[2];return 0==n?0!=o?Math.abs(i):0:0==o?Math.abs(i):0==i?Math.abs(o):void 0}_calculateCachedStats(e,t,n){const i=e.data,{element:s}=n.viewport,r=i.handles.points[0],l=i.handles.points[1],{cachedStats:d}=i,c=Object.keys(d);for(let e=0;e<c.length;e++){const t=c[e],n=this.getTargetImageData(t);if(!n)continue;const{imageData:o,dimensions:i}=n,s=w(o,r),h=w(o,l),g=[s,h],{scale:u,unit:m}=(0,a.Op)(n,g),v=this._calculateHeight(r,l)/u,p=this._isInsideVolume(s,h,i);this.isHandleOutsideImage=p,d[t]={height:v,unit:m}}const g=e.invalidated;return e.invalidated=!1,g&&(0,h.triggerAnnotationModified)(e,s,o.ChangeTypes.StatsUpdated),d}_isInsideVolume(e,t,n){return i.utilities.indexWithinDimensions(e,n)&&i.utilities.indexWithinDimensions(t,n)}}function C(e,t){const n=e.cachedStats[t],{height:o,unit:a}=n;if(null==o||isNaN(o))return;return[`${i.utilities.roundNumber(o)} ${a}`]}const T=I},33327:(e,t,n)=>{"use strict";n.d(t,{A:()=>p});var o=n(99737),i=n(15327),a=n(85817),s=n(82056),r=n(44049),l=n(74347),d=n(85204),c=n(60810),h=n(58640),g=n(7001);class u extends a.EC{static{this.toolName="KeyImage"}static{this.dataSeries={data:{seriesLevel:!0}}}static{this.dataPoint={data:{isPoint:!0}}}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{getTextCallback:m,changeTextCallback:v,canvasPosition:[10,10],canvasSize:10,handleRadius:"6",seriesLevel:!1,isPoint:!1}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{element:n,currentPoints:o}=t,a=(0,i.getEnabledElement)(n),{viewport:l}=a,d=o.world,g=this.constructor.createAnnotationForViewport(l,{data:{handles:{points:[[...d]]},seriesLevel:this.configuration.seriesLevel,isPoint:this.configuration.isPoint}});(0,s.addAnnotation)(g,n);const u=(0,c.getViewportIdsWithToolToRender)(n,this.getToolName());return e.preventDefault(),(0,h.A)(u),this.configuration.getTextCallback(e=>{if(!e)return(0,s.removeAnnotation)(g.annotationUID),(0,h.A)(u),void(this.isDrawing=!1);g.data.text=e,(0,r.triggerAnnotationCompleted)(g),(0,h.A)(u)}),this.createMemo(n,g,{newAnnotation:!0}),g},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t;if(!r?.isPoint)return!1;const{canvasPosition:l,canvasSize:d}=this.configuration;return!!l?.length&&(Math.abs(n[0]-l[0]+d/2)<=d/2&&Math.abs(n[1]-l[1]+d/2)<=d/2)},this.toolSelectedCallback=(e,t)=>{t.highlighted=!0,e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,newAnnotation:l}=this.editData,{viewportId:d,renderingEngine:c}=(0,i.getEnabledElement)(n);this.eventDispatchDetail={viewportId:d,renderingEngineId:c.id},this._deactivateModify(n),(0,g.resetElementCursor)(n),l&&this.createMemo(n,o,{newAnnotation:l}),this.editData=null,this.isDrawing=!1,this.doneEditMemo(),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,s.removeAnnotation)(o.annotationUID),(0,h.A)(a),l&&(0,r.triggerAnnotationCompleted)(o)},this.doubleClickCallback=e=>{const t=e.detail,{element:n}=t;let o=(0,s.getAnnotations)(this.getToolName(),n);if(o=this.filterInteractableAnnotationsForElement(n,o),!o?.length)return;const i=o.find(e=>this.isPointNearTool(n,e,t.currentPoints.canvas,6));if(!i)return;const a=i;this.createMemo(n,a),this.configuration.changeTextCallback(i,e.detail,this._doneChangingTextCallback.bind(this,n,a)),this.isDrawing=!1,this.doneEditMemo(),e.stopImmediatePropagation(),e.preventDefault()},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,{annotation:a,viewportIdsToRender:s,newAnnotation:r}=this.editData,{data:l}=a;this.createMemo(o,a,{newAnnotation:r}),l.handles.points[0]=[...i],a.invalidated=!0,(0,h.A)(s)},this._activateModify=e=>{d.wk.isInteractingWithTool=!0,e.addEventListener(o.Events.MOUSE_UP,this._endCallback),e.addEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(o.Events.TOUCH_END,this._endCallback),e.addEventListener(o.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(o.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{d.wk.isInteractingWithTool=!1,e.removeEventListener(o.Events.MOUSE_UP,this._endCallback),e.removeEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(o.Events.TOUCH_END,this._endCallback),e.removeEventListener(o.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(o.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=(0,s.getAnnotations)(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const r={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const i=a[e],{annotationUID:s,data:d}=i;r.annotationUID=s;const{color:c,lineWidth:h}=this.getAnnotationStyle({annotation:i,styleSpecifier:r}),{canvasPosition:g,canvasSize:u}=this.configuration,m="1";if(d?.isPoint){const e=d.handles.points[0],n=o.worldToCanvas(e);(0,l.drawHandles)(t,s,m,[n],{color:c,lineWidth:h,handleRadius:this.configuration.handleRadius})}else g?.length&&(0,l.drawArrow)(t,s,m,g.map(e=>e+u),g,{color:c,width:1});if(n=!0,!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n}return n}}handleSelectedCallback(e,t){const n=e.detail,{element:o}=n;t.highlighted=!0;const i=(0,c.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i},this._activateModify(o),(0,g.hideElementCursor)(o),(0,h.A)(i),e.preventDefault()}static setPoint(e,t=!e.data.isPoint,n){e.data.isPoint=t,(0,r.triggerAnnotationModified)(e,n)}_doneChangingTextCallback(e,t,n){t.data.text=n;const o=(0,c.getViewportIdsWithToolToRender)(e,this.getToolName());(0,h.A)(o),(0,r.triggerAnnotationModified)(t,e)}cancel(e){if(this.isDrawing){this.isDrawing=!1,this._deactivateModify(e),(0,g.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;return t.highlighted=!1,i.handles.activeHandleIndex=null,(0,h.A)(n),o&&(0,r.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}}_isInsideVolume(e,t,n){return i.utilities.indexWithinDimensions(e,n)&&i.utilities.indexWithinDimensions(t,n)}}function m(e){return e(prompt("Enter your annotation:"))}function v(e,t,n){return n(prompt("Enter your annotation:"))}const p=u},37117:(e,t,n)=>{"use strict";n.d(t,{A:()=>E});var o=n(3823),i=n(99737),a=n(15327),s=n(85817),r=n(82056),l=n(74347),d=n(85204),c=n(60810),h=n(58640),g=n(44049),u=n(7001),m=n(29601);class v extends s.EC{static{this.toolName="Label"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,getTextCallback:p,changeTextCallback:f,preventHandleOutsideImage:!1}}){super(e,t),this.isPointNearTool=(e,t,n,i)=>{const s=(0,a.getEnabledElement)(e),{viewport:r}=s,{annotationUID:l}=t,d=t.data.handles.points[0],c=r.worldToCanvas(d);if(o.Zc.distance(n,c)<i)return!0;const h=e.querySelector("svg");if(!h)return!1;const g=h.querySelector(`g[data-annotation-uid="${l}"]`);if(!g)return!1;const u=g,m=u.getBBox(),v=u.getAttribute("transform");let p=0,f=0;if(v){const e=v.match(/translate\(([-\d.]+)\s+([-\d.]+)\)/);e&&(p=parseFloat(e[1]),f=parseFloat(e[2]))}const E=m.x+p,w=m.y+f;return n[0]>=E&&n[0]<=E+m.width&&n[1]>=w&&n[1]<=w+m.height},this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,s=(0,a.getEnabledElement)(o),{viewport:l}=s;(0,u.hideElementCursor)(o),this.isDrawing=!0;const d=l.getCamera(),{viewPlaneNormal:m,viewUp:v}=d,p=this.getReferencedImageId(l,i,m,v),f=l.getFrameOfReferenceUID(),E={annotationUID:null,highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...m],viewUp:[...v],FrameOfReferenceUID:f,referencedImageId:p,...l.getViewReference({points:[i]})},data:{text:"",handles:{points:[[...i],[...i]]},label:""}};(0,r.addAnnotation)(E,o);const w=(0,c.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:E,newAnnotation:!0,viewportIdsToRender:w,offset:[0,0,0]},e.preventDefault(),(0,h.A)(w),this.configuration.getTextCallback(e=>{if(!e)return(0,r.removeAnnotation)(E.annotationUID),(0,h.A)(w),void(this.isDrawing=!1);(0,u.resetElementCursor)(o),E.data.text=e,(0,g.triggerAnnotationCompleted)(E),(0,h.A)(w)}),this.createMemo(o,E,{newAnnotation:!0}),E},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o,currentPoints:i}=n;t.highlighted=!0;const a=(0,c.getViewportIdsWithToolToRender)(o,this.getToolName());let s=[0,0,0];if(i&&i.world){const e=i.world,n=t.data.handles.points[0];s=[n[0]-e[0],n[1]-e[1],n[2]-e[2]]}this.editData={annotation:t,viewportIdsToRender:a,offset:s},this._activateModify(o),(0,u.hideElementCursor)(o),(0,h.A)(a),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a}=this.editData;this._deactivateDraw(n),this._deactivateModify(n),(0,u.resetElementCursor)(n),a&&this.createMemo(n,o,{newAnnotation:a}),this.editData=null,this.isDrawing=!1,this.doneEditMemo(),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(o.annotationUID),(0,h.A)(i),a&&(0,g.triggerAnnotationCompleted)(o)},this._dragCallback=e=>{const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,{annotation:s,viewportIdsToRender:r,offset:l}=this.editData;s.data.handles.points[0]=l?[a[0]+l[0],a[1]+l[1],a[2]+l[2]]:[...a],s.invalidated=!0,(0,h.A)(r),(0,g.triggerAnnotationModified)(s,o,i.ChangeTypes.LabelChange)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateModify(e),(0,u.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;return t.highlighted=!1,i.handles.activeHandleIndex=null,(0,h.A)(n),o&&(0,g.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{d.wk.isInteractingWithTool=!0,e.addEventListener(i.Events.MOUSE_UP,this._endCallback),e.addEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(i.Events.TOUCH_TAP,this._endCallback),e.addEventListener(i.Events.TOUCH_END,this._endCallback),e.addEventListener(i.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{d.wk.isInteractingWithTool=!1,e.removeEventListener(i.Events.MOUSE_UP,this._endCallback),e.removeEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(i.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(i.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(i.Events.TOUCH_END,this._endCallback)},this._activateDraw=e=>{d.wk.isInteractingWithTool=!0,e.addEventListener(i.Events.MOUSE_UP,this._endCallback),e.addEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(i.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(i.Events.TOUCH_TAP,this._endCallback),e.addEventListener(i.Events.TOUCH_END,this._endCallback),e.addEventListener(i.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{d.wk.isInteractingWithTool=!1,e.removeEventListener(i.Events.MOUSE_UP,this._endCallback),e.removeEventListener(i.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(i.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(i.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(i.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(i.Events.TOUCH_END,this._endCallback),e.removeEventListener(i.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=(0,r.getAnnotations)(this.getToolName(),i);if(!a?.length)return n;a=this.filterInteractableAnnotationsForElement(i,a);const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const i=a[e],{annotationUID:r,data:d}=i,c=d.handles.points[0];s.annotationUID=r;const h=o.worldToCanvas(c);if(n=!0,!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,m.isAnnotationVisible)(r))continue;if(!d.text)continue;const g=this.getLinkedTextBoxStyle(s,i),u="1";(0,l.drawTextBox)(t,r,u,[d.text],h,{...g,padding:0})}return n}}static{this.hydrate=(e,t,n,o)=>{const i=(0,a.getEnabledElementByViewportId)(e);if(!i)return;const{viewport:s}=i,l=s.getFrameOfReferenceUID(),{viewPlaneNormal:d,viewUp:c}=s.getCamera(),g=new this,u=g.getReferencedImageId(s,t,d,c),m={annotationUID:o?.annotationUID||a.utilities.uuidv4(),data:{text:n,handles:{points:[t]}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:g.getToolName(),viewPlaneNormal:d,FrameOfReferenceUID:l,referencedImageId:u,...o}};(0,r.addAnnotation)(m,s.element),(0,h.A)([s.id])}}handleSelectedCallback(e,t,n,o){}_doneChangingTextCallback(e,t,n){t.data.text=n;const o=(0,c.getViewportIdsWithToolToRender)(e,this.getToolName());(0,h.A)(o),(0,g.triggerAnnotationModified)(t,e)}_isInsideVolume(e,t,n){return a.utilities.indexWithinDimensions(e,n)&&a.utilities.indexWithinDimensions(t,n)}}function p(e){return e(prompt("Enter your annotation:"))}function f(e,t,n){return n(prompt("Enter your annotation:"))}v.toolName="Label";const E=v},14335:(e,t,n)=>{"use strict";n.d(t,{A:()=>T});var o=n(99737),i=n(15327),a=n(4096),s=n(85817),r=n(27730),l=n(82056),d=n(2076),c=n(29601),h=n(44049),g=n(93258),u=n(74347),m=n(85204),v=n(60810),p=n(473),f=n(58640),E=n(7001);const{transformWorldToIndex:w}=i.utilities;class I extends s.EC{static{this.toolName="Length"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:C,actions:{undo:{method:"undo",bindings:[{key:"z"}]},redo:{method:"redo",bindings:[{key:"y"}]}}}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,s=(0,i.getEnabledElement)(o),{viewport:r}=s;(0,E.hideElementCursor)(o),this.isDrawing=!0;const{viewPlaneNormal:d,viewUp:c,position:h}=r.getCamera(),g=this.getReferencedImageId(r,a,d,c),u={highlighted:!0,invalidated:!0,metadata:{...r.getViewReference({points:[a]}),toolName:this.getToolName(),referencedImageId:g,viewUp:c,cameraPosition:h},data:{handles:{points:[[...a],[...a]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,l.addAnnotation)(u,o);const m=(0,v.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:u,viewportIdsToRender:m,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),e.preventDefault(),(0,f.A)(m),u},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,[l,d]=r.handles.points,c=s.worldToCanvas(l),h=s.worldToCanvas(d),u={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}};return g.distanceToPoint([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]])<=o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=(0,v.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},this._activateModify(o),(0,E.hideElementCursor)(o),(0,f.A)(i),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=o;a&&!s||(r.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,E.resetElementCursor)(n),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,l.removeAnnotation)(o.annotationUID),(0,f.A)(i),this.doneEditMemo(),a&&(0,h.triggerAnnotationCompleted)(o),this.editData=null,this.isDrawing=!1)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:s,movingTextBox:r,newAnnotation:l}=this.editData,{data:d}=i;if(this.createMemo(n,i,{newAnnotation:l}),r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=d.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;d.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),i.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;d.handles.points[s]=[...n],i.invalidated=!0}this.editData.hasMoved=!0,(0,f.A)(a),i.invalidated&&(0,h.triggerAnnotationModified)(i,n,o.ChangeTypes.HandlesUpdated)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,E.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;return t.highlighted=!1,i.handles.activeHandleIndex=null,(0,f.A)(n),o&&(0,h.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{m.wk.isInteractingWithTool=!0,e.addEventListener(o.Events.MOUSE_UP,this._endCallback),e.addEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(o.Events.TOUCH_END,this._endCallback),e.addEventListener(o.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(o.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{m.wk.isInteractingWithTool=!1,e.removeEventListener(o.Events.MOUSE_UP,this._endCallback),e.removeEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(o.Events.TOUCH_END,this._endCallback),e.removeEventListener(o.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(o.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{m.wk.isInteractingWithTool=!0,e.addEventListener(o.Events.MOUSE_UP,this._endCallback),e.addEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(o.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(o.Events.TOUCH_END,this._endCallback),e.addEventListener(o.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(o.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{m.wk.isInteractingWithTool=!1,e.removeEventListener(o.Events.MOUSE_UP,this._endCallback),e.removeEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(o.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(o.Events.TOUCH_END,this._endCallback),e.removeEventListener(o.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(o.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=(0,l.getAnnotations)(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const s=this.getTargetId(o),r=o.getRenderingEngine(),h={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const l=a[i],{annotationUID:g,data:m}=l,{points:v,activeHandleIndex:f}=m.handles;h.annotationUID=g;const{color:E,lineWidth:w,lineDash:I,shadow:C}=this.getAnnotationStyle({annotation:l,styleSpecifier:h}),T=v.map(e=>o.worldToCanvas(e));if(m.cachedStats[s]&&null!=m.cachedStats[s].unit?l.invalidated&&this._throttledCalculateCachedStats(l,r,e):(m.cachedStats[s]={length:null,unit:null},this._calculateCachedStats(l,r,e)),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let b;if(!(0,c.isAnnotationVisible)(g))continue;if((0,d.isAnnotationLocked)(g)||this.editData||null===f||(b=[T[f]]),b){const e="0";(0,u.drawHandles)(t,g,e,T,{color:E,lineDash:I,lineWidth:w})}const A=`${g}-line`,_="1";if((0,u.drawLine)(t,g,_,T[0],T[1],{color:E,width:w,lineDash:I,shadow:C},A),n=!0,!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;const S=this.getLinkedTextBoxStyle(h,l);if(!S.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const D=this.configuration.getTextLines(m,s);if(!m.handles.textBox.hasMoved){const e=(0,p.getTextBoxCoordsCanvas)(T);m.handles.textBox.worldPosition=o.canvasToWorld(e)}const y=o.worldToCanvas(m.handles.textBox.worldPosition),M="1",x=(0,u.drawLinkedTextBox)(t,g,M,D,y,T,{},S),{x:R,y:P,width:L,height:k}=x;m.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([R,P]),topRight:o.canvasToWorld([R+L,P]),bottomLeft:o.canvasToWorld([R,P+k]),bottomRight:o.canvasToWorld([R+L,P+k])}}return n},this._throttledCalculateCachedStats=(0,r.A)(this._calculateCachedStats,100,{trailing:!0})}static{this.hydrate=(e,t,n)=>{const o=(0,i.getEnabledElementByViewportId)(e);if(!o)return;const{FrameOfReferenceUID:a,referencedImageId:s,viewPlaneNormal:r,instance:d,viewport:c}=this.hydrateBase(I,o,t,n),{toolInstance:h,...g}=n||{},u={annotationUID:n?.annotationUID||i.utilities.uuidv4(),data:{handles:{points:t}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:d.getToolName(),viewPlaneNormal:r,FrameOfReferenceUID:a,referencedImageId:s,...g}};(0,l.addAnnotation)(u,c.element),(0,f.A)([c.id])}}handleSelectedCallback(e,t,n){const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;let s,r=!1;n.worldPosition?r=!0:s=a.handles.points.findIndex(e=>e===n);const l=(0,v.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:s,movingTextBox:r},this._activateModify(i),(0,E.hideElementCursor)(i),(0,f.A)(l),e.preventDefault()}_calculateLength(e,t){const n=e[0]-t[0],o=e[1]-t[1],i=e[2]-t[2];return Math.sqrt(n*n+o*o+i*i)}_calculateCachedStats(e,t,n){const i=e.data,{element:s}=n.viewport,r=i.handles.points[0],l=i.handles.points[1],{cachedStats:d}=i,c=Object.keys(d);for(let e=0;e<c.length;e++){const t=c[e],n=this.getTargetImageData(t);if(!n)continue;const{imageData:o,dimensions:i}=n,s=w(o,r),h=w(o,l),g=[s,h],{scale:u,unit:m}=(0,a.Op)(n,g),v=this._calculateLength(r,l)/u;this._isInsideVolume(s,h,i)?this.isHandleOutsideImage=!1:this.isHandleOutsideImage=!0,d[t]={length:v,unit:m}}const g=e.invalidated;return e.invalidated=!1,g&&(0,h.triggerAnnotationModified)(e,s,o.ChangeTypes.StatsUpdated),d}_isInsideVolume(e,t,n){return i.utilities.indexWithinDimensions(e,n)&&i.utilities.indexWithinDimensions(t,n)}}function C(e,t){const n=e.cachedStats[t],{length:o,unit:a}=n;if(null==o||isNaN(o))return;return[`${i.utilities.roundNumber(o)} ${a}`]}const T=I},76358:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var o=n(15327),i=n(9136),a=n(38776),s=n(44049),r=n(99737),l=n(74347);class d extends i.A{static{this.toolName="LivewireContourSegmentationTool"}updateInterpolatedAnnotation(e,t){!this.editData&&e.invalidated&&e.data.handles.interpolationSources&&(e.data.contour.originalPolyline=e.data.contour.polyline,queueMicrotask(()=>{if(!e.data.handles.interpolationSources)return;const{points:n}=e.data.handles,{element:i}=t.viewport;this.setupBaseEditData(n[0],i,e);const{length:l}=n,{scissors:d}=this,{nearestEdge:c,repeatInterpolation:h}=this.configuration.interpolation;e.data.handles.originalPoints=n;const{worldToSlice:g,sliceToWorld:u}=this.editData,m=[];if(c){let e=g(n[n.length-1]);n.forEach((t,i)=>{const a=g(t);e=a,m.push(a),d.startSearch(e),d.findPathToPoint(a),d.findPathToPoint(g(n[(i+3)%n.length]));const s=d.findMinNearby(a,c);o.utilities.isEqual(a,s)||(m[i]=s,e=s,n[i]=u(s))})}const v=new a.j;for(let e=0;e<l;e++){d.startSearch(g(n[e]));const t=d.findPathToPoint(g(n[(e+1)%l]));v.addPoints(t)}this.updateAnnotation(v),this.scissors=null,this.scissorsNext=null,this.editData=null,e.data.handles.interpolationSources=null,h&&(0,s.triggerAnnotationModified)(e,t.viewport.element,r.ChangeTypes.InterpolationUpdated)}))}renderAnnotationInstance(e){const{enabledElement:t,svgDrawingHelper:n}=e,o=e.annotation,{annotationUID:i}=o,{viewport:a}=t,{worldToCanvas:s}=a,{showInterpolationPolyline:r}=this.configuration.interpolation||{};this.updateInterpolatedAnnotation?.(o,t);const{originalPolyline:d}=o.data.contour,c=super.renderAnnotationInstance(e);if(r&&d&&o.autoGenerated){const e=d.map(s);e.push(e[0]),(0,l.drawPolyline)(n,i,"interpolationContour-0",e,{color:"#70ffff",lineWidth:1,fillOpacity:0})}return c}isContourSegmentationTool(){return!0}}const c=d},9136:(e,t,n)=>{"use strict";n.d(t,{A:()=>b});var o=n(3823),i=n(15327),a=n(82056),s=n(74347),r=n(85204),l=n(99737),d=n(7001),c=n(76910),h=n(95527),g=n(58640),u=n(98013),m=n(93126),v=n(44049),p=n(78044),f=n(38776),E=n(60810),w=n(36320),I=n(473),C=n(53860);class T extends w.A{static{this.toolName="LivewireContour"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{getTextLines:A,calculateStats:!0,preventHandleOutsideImage:!1,contourHoleAdditionModifierKey:l.KeyboardBindings.Shift,snapHandleNearby:2,interpolation:{enabled:!1,nearestEdge:2,showInterpolationPolyline:!1},decimate:{enabled:!1,epsilon:.1},actions:{cancelInProgress:{method:"cancelInProgress",bindings:[{key:"Escape"}]}}}}){super(e,t),this.isHandleOutsideImage=!1,this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,r=o*o,l=t.data.contour.polyline.map(e=>s.worldToCanvas(e));let d=l[l.length-1];for(let e=0;e<l.length;e++){const t=l[e];if(h.lineSegment.distanceToPointSquared(d,t,n)<=r)return!0;d=t}return!1},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const a=(0,E.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:a,movingTextBox:!1};const s=(0,i.getEnabledElement)(o),{renderingEngine:r}=s;this._activateModify(o),(0,g.A)(a),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;let r,l=!1;if(n.worldPosition)l=!0;else{const{points:e}=s.handles;r=e.findIndex(e=>e===n)}const d=(0,E.getViewportIdsWithToolToRender)(a,this.getToolName());this.editData={annotation:t,viewportIdsToRender:d,handleIndex:r,movingTextBox:l},this._activateModify(a);const c=(0,i.getEnabledElement)(a),{renderingEngine:h}=c;(0,g.A)(d),e.preventDefault()},this._endCallback=(e,t=!1)=>{const n=e.detail,{element:o}=n,{annotation:s,viewportIdsToRender:r,newAnnotation:c,contourHoleProcessingEnabled:h}=this.editData,{data:u}=s;this.doneEditMemo(),u.handles.activeHandleIndex=null,this._deactivateModify(o),this._deactivateDraw(o),(0,d.resetElementCursor)(o);const m=(0,i.getEnabledElement)(o);if(this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage||t)return(0,a.removeAnnotation)(s.annotationUID),this.clearEditData(),void(0,g.A)(r);(0,g.A)(r);const v=c?l.ChangeTypes.Completed:l.ChangeTypes.HandlesUpdated;this.triggerChangeEvent(s,m,v,h),this.clearEditData()},this.triggerChangeEvent=(e,t,n=l.ChangeTypes.StatsUpdated,o=!1)=>{n===l.ChangeTypes.Completed?(0,v.triggerContourAnnotationCompleted)(e,o):(0,v.triggerAnnotationModified)(e,t.viewport.element,n)},this._mouseDownCallback=e=>{const t=e.type===l.Events.MOUSE_DOUBLE_CLICK,{annotation:n,viewportIdsToRender:o,worldToSlice:a,sliceToWorld:s,newAnnotation:r}=this.editData;if(this.editData.closed)return;const d=e.detail,{element:c}=d,{currentPoints:u}=d,{canvas:m,world:v}=u;let p=v;const E=(0,i.getEnabledElement)(c),{viewport:w,renderingEngine:I}=E,C=this.editData.currentPath.getControlPoints();let T=C.length>=2&&t;if(this.doneEditMemo(),this.createMemo(c,n,{newAnnotation:r&&1===C.length}),C.length>=2){const e={index:-1,distSquared:1/0};for(let t=0,n=C.length;t<n;t++){const n=s(C[t]),o=w.worldToCanvas(n),i=h.point.distanceToPointSquared(m,o);i<=100&&i<e.distSquared&&(e.distSquared=i,e.index=t)}0===e.index&&(T=!0)}const{snapHandleNearby:b}=this.configuration;if(b&&!this.editData.closed){const e=new f.j,t=this.scissors.findMinNearby(a(v),1),n=this.scissors.findPathToPoint(t);e.addPoints(n),e.prependPath(this.editData.confirmedPath),p=s(t),this.editData.currentPath=e}this.editData.closed=this.editData.closed||T,this.editData.confirmedPath=this.editData.currentPath;const A=this.editData.currentPath.getLastPoint();this.editData.confirmedPath.addControlPoint(A),n.data.handles.points.push(s(A)),this.scissors.startSearch(a(p)),n.invalidated=!0,(0,g.A)(o),this.editData.closed&&(this.updateAnnotation(this.editData.confirmedPath),this._endCallback(e)),e.preventDefault()},this._mouseMoveCallback=e=>{const{element:t,currentPoints:n}=e.detail,{world:o,canvas:a}=n,{renderingEngine:s}=(0,i.getEnabledElement)(t),r=(0,E.getViewportIdsWithToolToRender)(t,this.getToolName());this.editData.lastCanvasPoint=a;const{width:l,height:d}=this.scissors,{worldToSlice:c}=this.editData,h=c(o);if(h[0]<0||h[1]<0||h[0]>=l||h[1]>=d)return;const u=this.scissors.findPathToPoint(h),m=new f.j;m.addPoints(u),m.prependPath(this.editData.confirmedPath),this.editData.currentPath=m,(0,g.A)(r),e.preventDefault()},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,movingTextBox:s,handleIndex:r,newAnnotation:l}=this.editData;this.createMemo(n,o,{newAnnotation:l});const{data:d}=o;if(s){const{deltaPoints:e}=t,n=e.world,{textBox:o}=d.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===r)console.warn("Drag annotation not implemented");else{const{currentPoints:e}=t,i=e.world;this.editHandle(i,n,o,r)}this.editData.hasMoved=!0;const c=(0,i.getEnabledElement)(n),{renderingEngine:h}=c;(0,g.A)(a)},this.cancel=e=>{if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,d.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData;return o&&(0,a.removeAnnotation)(t.annotationUID),(0,g.A)(n),this.doneEditMemo(),this.scissors=null,t.annotationUID},this._activateModify=e=>{r.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{r.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{r.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_MOVE,this._mouseMoveCallback),e.addEventListener(l.Events.MOUSE_DOWN,this._mouseDownCallback),e.addEventListener(l.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.addEventListener(l.Events.TOUCH_TAP,this._mouseDownCallback)},this._deactivateDraw=e=>{r.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_MOVE,this._mouseMoveCallback),e.removeEventListener(l.Events.MOUSE_DOWN,this._mouseDownCallback),e.removeEventListener(l.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._mouseDownCallback)},this._calculateCachedStats=(e,t)=>{if(!this.configuration.calculateStats)return;const n=e.data;if(!n.contour.closed)return;const a=(0,i.getEnabledElement)(t),{viewport:s,renderingEngine:r}=a,{cachedStats:d}=n,{polyline:c}=n.contour,g=Object.keys(d);for(let e=0;e<g.length;e++){const t=g[e],n=this.getTargetImageData(t);if(!n)continue;const{metadata:a}=n,r=c.map(e=>s.worldToCanvas(e)),l=r[0],u=s.canvasToWorld(l),m=s.canvasToWorld([l[0]+1,l[1]]),v=s.canvasToWorld([l[0],l[1]+1]),p=o.eR.distance(u,m),f=o.eR.distance(u,v),{imageData:E}=n,{scale:w,areaUnit:I}=(0,C.getCalibratedLengthUnitsAndScale)(n,()=>{const{maxX:e,maxY:t,minX:n,minY:o}=h.polyline.getAABB(r),a=s.canvasToWorld([n,o]),l=i.utilities.transformWorldToIndex(E,a),d=s.canvasToWorld([e,t]);return[l,i.utilities.transformWorldToIndex(E,d)]});let T=h.polyline.getArea(r)/w/w;T*=p*f,d[t]={Modality:a.Modality,area:T,areaUnit:I}}const u=e.invalidated;return e.invalidated=!1,u&&this.triggerAnnotationModified(e,a,l.ChangeTypes.StatsUpdated),d},this._renderStats=(e,t,n,o)=>{const i=e.data,a=this.getTargetId(t);if(!i.contour.closed||!o.visibility)return;const r=this.configuration.getTextLines(i,a);if(!r||0===r.length)return;const l=i.handles.points.map(e=>t.worldToCanvas(e));if(!i.handles.textBox.hasMoved){const e=(0,I.getTextBoxCoordsCanvas)(l);i.handles.textBox.worldPosition=t.canvasToWorld(e)}const d=t.worldToCanvas(i.handles.textBox.worldPosition),c=(0,s.drawLinkedTextBox)(n,e.annotationUID??"","textBox",r,d,l,{},o),{x:h,y:g,width:u,height:m}=c;i.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([h,g]),topRight:t.canvasToWorld([h+u,g]),bottomLeft:t.canvasToWorld([h,g+m]),bottomRight:t.canvasToWorld([h+u,g+m])}},this.triggerAnnotationModified=(e,t,n=l.ChangeTypes.StatsUpdated)=>{const{viewportId:o,renderingEngineId:a}=t,s=l.Events.ANNOTATION_MODIFIED,r={annotation:e,viewportId:o,renderingEngineId:a,changeType:n};(0,i.triggerEvent)(i.eventTarget,s,r)},this._throttledCalculateCachedStats=(0,C.throttle)(this._calculateCachedStats,100,{trailing:!0})}setupBaseEditData(e,t,n,a,s){const r=(0,i.getEnabledElement)(t),{viewport:l}=r;this.isDrawing=!0;const d=l.getImageData(),{imageData:c}=d;let h,g,u,m,v;if(l instanceof i.VolumeViewport){if(!(l instanceof i.VolumeViewport))throw new Error("Viewport not supported");{const e=i.utilities.getCurrentVolumeViewportSlice(l),{sliceToIndexMatrix:t,indexToSliceMatrix:n}=e;h=e=>{const t=i.utilities.transformWorldToIndex(c,e),a=o.eR.transformMat4([0,0,0],t,n);return[a[0],a[1]]},g=e=>{const n=o.eR.transformMat4([0,0,0],[e[0],e[1],0],t);return i.utilities.transformIndexToWorld(c,n)},v=e.scalarData,u=e.width,m=e.height}}else u=d.dimensions[0],m=d.dimensions[1],h=e=>{const t=i.utilities.transformWorldToIndex(c,e);return[t[0],t[1]]},g=e=>i.utilities.transformIndexToWorld(c,[e[0],e[1],0]),v=d.scalarData;v=i.utilities.convertToGrayscale(v,u,m);const{voiRange:w}=l.getProperties(),I=h(e);this.scissors=p.f.createInstanceFromRawPixelData(v,u,m,w),a&&(this.scissorsNext=p.f.createInstanceFromRawPixelData(v,u,m,w),this.scissorsNext.startSearch(h(a))),this.scissors.startSearch(I);const C=!a,T=new f.j,b=new f.j,A=C?void 0:new f.j;T.addPoint(I),T.addControlPoint(I);const _=(0,E.getViewportIdsWithToolToRender)(t,this.getToolName()),S=l.worldToCanvas(e);this.editData={annotation:n,viewportIdsToRender:_,newAnnotation:C,hasMoved:!1,lastCanvasPoint:S,confirmedPath:T,currentPath:b,confirmedPathNext:A,closed:!1,handleIndex:this.editData?.handleIndex??n.handles?.activeHandleIndex,worldToSlice:h,sliceToWorld:g,contourHoleProcessingEnabled:s}}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:o}=t,{world:i}=n,a=this.createAnnotation(e),s=(0,c.A)(e.detail.event)===this.configuration.contourHoleAdditionModifierKey;return this.setupBaseEditData(i,o,a,void 0,s),this.addAnnotation(a,o),this._activateDraw(o),e.preventDefault(),(0,g.A)(this.editData.viewportIdsToRender),a}clearEditData(){this.editData=null,this.scissors=null,this.scissorsNext=null,this.isDrawing=!1}editHandle(e,t,n,o){const{data:i}=n,{points:a}=i.handles,{length:s}=a,r=a[(o-1+s)%s],l=a[(o+1)%s];if(!this.editData?.confirmedPathNext){this.setupBaseEditData(r,t,n,l);const{polyline:e}=i.contour,a=new f.j,s=new f.j,{worldToSlice:d}=this.editData,c=(0,u.A)(n,o-1),h=(0,u.A)(n,o+1);if(-1===h||-1===c)throw new Error(`Can't find handle index ${-1===h&&l} ${-1===c&&r}`);0===o?s.addPoints(e.slice(h+1,c).map(d)):(a.addPoints(e.slice(0,c+1).map(d)),s.addPoints(e.slice(h,e.length).map(d))),this.editData.confirmedPath=a,this.editData.confirmedPathNext=s}const{editData:d,scissors:c}=this,{worldToSlice:h,sliceToWorld:g}=d,{activeHandleIndex:m}=i.handles;if(null==m)i.handles.activeHandleIndex=o;else if(m!==o)throw new Error(`Trying to edit a different handle than the one currently being edited ${o}!==${i.handles.activeHandleIndex}`);const v=h(e);if(v[0]<0||v[0]>=c.width||v[1]<0||v[1]>=c.height)return;a[o]=g(v);const p=c.findPathToPoint(v),E=this.scissorsNext.findPathToPoint(v),w=new f.j;w.prependPath(d.confirmedPath),0!==o&&w.addPoints(p),w.addPoints(E.reverse()),w.appendPath(d.confirmedPathNext),0===o&&w.addPoints(p),d.currentPath=w,n.invalidated=!0,d.hasMoved=!0,d.closed=!0}renderAnnotation(e,t){return this.updateAnnotation(this.editData?.currentPath),super.renderAnnotation(e,t)}isContourSegmentationTool(){return!1}createAnnotation(e){const t=super.createAnnotation(e),{world:n}=e.detail.currentPoints;return i.utilities.deepMerge(t,{data:{handles:{points:[[...n]]}}})}cancelInProgress(e,t,n){this.editData?this._endCallback(n,!0):this.undo()}renderAnnotationInstance(e){const{annotation:t,enabledElement:n,svgDrawingHelper:o,annotationStyle:i,targetId:a}=e,{viewport:r}=n,{element:l}=r,{worldToCanvas:d}=r,{annotationUID:c,data:h,highlighted:g}=t,{handles:u}=h,m=this.editData?.newAnnotation,{lineWidth:v,lineDash:p,color:f}=i;if(g||m&&t.annotationUID===this.editData?.annotation?.annotationUID){const e="0",t=u.points.map(d);(0,s.drawHandles)(o,c,e,t,{color:f,lineDash:p,lineWidth:v})}return super.renderAnnotationInstance(e),h.cachedStats[a]&&null!==h.cachedStats[a]?.areaUnit?t.invalidated&&this._throttledCalculateCachedStats(t,l):(h.cachedStats[a]={Modality:null,area:null,areaUnit:null},this._calculateCachedStats(t,l)),this._renderStats(t,r,o,i.textbox),!0}updateAnnotation(e){if(!this.editData||!e)return;const{annotation:t,sliceToWorld:n,worldToSlice:o,closed:i,newAnnotation:a}=this.editData;let{pointArray:s}=e;s.length>1&&(s=[...s,s[0]]);const r=a&&i?m.W.Clockwise:void 0;this.updateContourPolyline(t,{points:s,closed:i,targetWindingDirection:r},{canvasToWorld:n,worldToCanvas:o})}}const b=T;function A(e,t){const n=e.cachedStats[t],{area:o,areaUnit:a}=n,s=[];if(o){const e=`Area: ${i.utilities.roundNumber(o)} ${a}`;s.push(e)}return s}},61873:(e,t,n)=>{"use strict";n.d(t,{A:()=>C});var o=n(3823),i=n(15327),a=n(85817),s=n(82056),r=n(44049),l=n(4096),d=n(74347),c=n(85204),h=n(99737),g=n(60810),u=n(7001),m=n(29601),v=n(58640),p=n(40634),f=n(18990);const{transformWorldToIndex:E}=i.utilities;class w extends a.EC{static{this.toolName="Probe"}static{this.probeDefaults={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:I,handleRadius:"6",textCanvasOffset:{x:6,y:-6}}}}constructor(e={},t){super(e,a.EC.mergeDefaultProps(w.probeDefaults,t)),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,r=(0,i.getEnabledElement)(o),{viewport:l}=r;this.isDrawing=!0;const d=this.constructor.createAnnotationForViewport(l,{data:{handles:{points:[[...a]]}}});(0,s.addAnnotation)(d,o);const c=(0,g.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:d,newAnnotation:!0,viewportIdsToRender:c},this._activateModify(o),(0,u.hideElementCursor)(o),e.preventDefault(),(0,v.A)(c),d},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,newAnnotation:l}=this.editData,{viewportId:d,renderingEngine:c}=(0,i.getEnabledElement)(n);this.eventDispatchDetail={viewportId:d,renderingEngineId:c.id},this._deactivateModify(n),(0,u.resetElementCursor)(n),l&&this.createMemo(n,o,{newAnnotation:l}),this.editData=null,this.isDrawing=!1,this.doneEditMemo(),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,s.removeAnnotation)(o.annotationUID),(0,v.A)(a),l&&(0,r.triggerAnnotationCompleted)(o)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{currentPoints:n,element:o}=t,i=n.world,{annotation:a,viewportIdsToRender:s,newAnnotation:r}=this.editData,{data:l}=a;this.createMemo(o,a,{newAnnotation:r}),l.handles.points[0]=[...i],a.invalidated=!0,(0,v.A)(s)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateModify(e),(0,u.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;return t.highlighted=!1,i.handles.activeHandleIndex=null,(0,v.A)(n),o&&(0,r.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{c.wk.isInteractingWithTool=!0,e.addEventListener(h.Events.MOUSE_UP,this._endCallback),e.addEventListener(h.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(h.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(h.Events.TOUCH_END,this._endCallback),e.addEventListener(h.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(h.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{c.wk.isInteractingWithTool=!1,e.removeEventListener(h.Events.MOUSE_UP,this._endCallback),e.removeEventListener(h.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(h.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(h.Events.TOUCH_END,this._endCallback),e.removeEventListener(h.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(h.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:a}=o;let r=(0,s.getAnnotations)(this.getToolName(),a);if(!r?.length)return n;if(r=this.filterInteractableAnnotationsForElement(a,r),!r?.length)return n;const l=this.getTargetId(o),c=o.getRenderingEngine(),g={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<r.length;a++){const s=r[a],u=s.annotationUID,v=s.data,p=v.handles.points[0],f=o.worldToCanvas(p);g.annotationUID=u;const{color:E,lineWidth:w}=this.getAnnotationStyle({annotation:s,styleSpecifier:g});if(v.cachedStats||(v.cachedStats={}),v.cachedStats[l]&&null!==v.cachedStats[l].value){if(s.invalidated&&(this._calculateCachedStats(s,c,e),o instanceof i.VolumeViewport)){const{referencedImageId:e}=s.metadata;for(const t in v.cachedStats)if(t.startsWith("imageId")){c.getStackViewports().find(t=>{const n=i.utilities.imageIdToURI(e),o=t.hasImageURI(n),a=i.utilities.imageIdToURI(t.getCurrentImageId());return o&&a!==n})&&delete v.cachedStats[t]}}}else v.cachedStats[l]={Modality:null,index:null,value:null},this._calculateCachedStats(s,c,e,h.ChangeTypes.StatsUpdated);if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,m.isAnnotationVisible)(u))continue;const I="0";(0,d.drawHandles)(t,u,I,[f],{color:E,lineWidth:w,handleRadius:this.configuration.handleRadius}),n=!0;const C=this.getLinkedTextBoxStyle(g,s);if(!C.visibility)continue;const T=this.configuration.getTextLines(v,l);if(T){const e=[f[0]+this.configuration.textCanvasOffset.x,f[1]+this.configuration.textCanvasOffset.y],n="0";(0,d.drawTextBox)(t,u,n,T,[e[0],e[1]],C)}}return n}}isPointNearTool(e,t,n,a){const s=(0,i.getEnabledElement)(e),{viewport:r}=s,{data:l}=t,d=l.handles.points[0],c=r.worldToCanvas(d);return o.Zc.distance(n,c)<a}toolSelectedCallback(){}static{this.hydrate=(e,t,n)=>{const o=(0,i.getEnabledElementByViewportId)(e);if(!o)return;const{FrameOfReferenceUID:a,referencedImageId:r,viewPlaneNormal:l,viewUp:d,instance:c,viewport:h}=this.hydrateBase(w,o,t,n),{toolInstance:g,...u}=n||{},m={annotationUID:n?.annotationUID||i.utilities.uuidv4(),data:{handles:{points:t}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:c.getToolName(),viewPlaneNormal:l,FrameOfReferenceUID:a,referencedImageId:r,...u}};(0,s.addAnnotation)(m,h.element),(0,v.A)([h.id])}}getHandleNearImagePoint(e,t,n,a){const s=(0,i.getEnabledElement)(e),{viewport:r}=s,{data:l}=t,d=l.handles.points[0],c=r.worldToCanvas(d);if(!0===o.Zc.distance(n,c)<a)return d}handleSelectedCallback(e,t){const n=e.detail,{element:o}=n;t.highlighted=!0;const i=(0,g.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i},this._activateModify(o),(0,u.hideElementCursor)(o),(0,v.A)(i),e.preventDefault()}_calculateCachedStats(e,t,n,a=h.ChangeTypes.StatsUpdated){const s=e.data,{renderingEngineId:d,viewport:c}=n,{element:g}=c,u=s.handles.points[0],{cachedStats:m}=s,v=Object.keys(m);for(let t=0;t<v.length;t++){const n=v[t],a={isPreScaled:(0,f.u)(c,n),isSuvScaled:this.isSuvScaled(c,n,e.metadata.referencedImageId)},s=this.getTargetImageData(n);if(!s)continue;const{dimensions:r,imageData:d,metadata:h,voxelManager:g}=s,w=h.Modality;let I=E(d,u);if(I=o.eR.round(I,I),i.utilities.indexWithinDimensions(I,r)){this.isHandleOutsideImage=!1;let t,o=g.getAtIJKPoint(I);if(n.startsWith("imageId:")){const e=n.split("imageId:")[1],t=i.utilities.imageIdToURI(e),o=i.utilities.getViewportsWithImageURI(t)[0];I[2]=o.getCurrentImageIdIndex()}if("US"===w){const e=(0,l.Xw)(s,[I]),n=e.values.every(e=>null!==e);o=n?e.values:o,t=n?e.units:"raw"}else t=(0,p.j)(w,e.metadata.referencedImageId,a);m[n]={index:I,value:o,Modality:w,modalityUnit:t}}else this.isHandleOutsideImage=!0,m[n]={index:I,Modality:w}}const w=e.invalidated;return e.invalidated=!1,w&&(0,r.triggerAnnotationModified)(e,g,a),m}}function I(e,t){const n=e.cachedStats[t],{index:o,value:a,modalityUnit:s}=n;if(void 0===a||!o)return;const r=[];if(r.push(`(${o[0]}, ${o[1]}, ${o[2]})`),a instanceof Array&&s instanceof Array)for(let e=0;e<a.length;e++)r.push(`${i.utilities.roundNumber(a[e])} ${s[e]}`);else r.push(`${i.utilities.roundNumber(a)} ${s}`);return r}const C=w},7750:(e,t,n)=>{"use strict";n.d(t,{A:()=>d});var o=n(15327),i=n(93759),a=n(10639),s=n(16171),r=n(99737);class l extends a.A{static{this.toolName="RegionSegmentPlus"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{isPartialVolume:!1,positiveSeedVariance:.4,negativeSeedVariance:.9,subVolumePaddingPercentage:.1,islandRemoval:{enabled:!1}}}){super(e,t),this.mouseTimer=null,this.allowedToProceed=!1}mouseMoveCallback(e){if(this.mode!==r.ToolModes.Active)return;const t=e.detail,{currentPoints:n,element:o}=t,{world:i}=n;o.style.cursor="default",null!==this.mouseTimer&&(window.clearTimeout(this.mouseTimer),this.mouseTimer=null),this.mouseTimer=window.setTimeout(()=>{this.onMouseStable(e,i,o)},this.configuration.mouseStabilityDelay||500)}async onMouseStable(e,t,n){await super.preMouseDownCallback(e);const i=o.cache.getVolume(this.growCutData.segmentation.referencedVolumeId),a=(0,s.sG)(i,t,{})||{positiveSeedIndices:new Set,negativeSeedIndices:new Set},{positiveSeedIndices:r,negativeSeedIndices:l}=a;let d;r.size/l.size>20||l.size<30?(d="not-allowed",this.allowedToProceed=!1):(d="copy",this.allowedToProceed=!0);const c=(0,o.getEnabledElement)(n);n&&(n.style.cursor=d,requestAnimationFrame(()=>{n.style.cursor!==d&&(n.style.cursor=d)})),this.allowedToProceed&&(this.seeds=a),c&&c.viewport&&c.viewport.render()}async preMouseDownCallback(e){if(!this.allowedToProceed)return!1;const t=e.detail,{currentPoints:n,element:i}=t;(0,o.getEnabledElement)(i)&&(i.style.cursor="wait",requestAnimationFrame(()=>{"wait"!==i.style.cursor&&(i.style.cursor="wait")}));const{world:a}=n;return await super.preMouseDownCallback(e),this.growCutData=o.utilities.deepMerge(this.growCutData,{worldPoint:a,islandRemoval:{worldIslandPoints:[a]}}),this.growCutData.worldPoint=a,this.growCutData.islandRemoval={worldIslandPoints:[a]},await this.runGrowCut(),i&&(i.style.cursor="default"),!0}getRemoveIslandData(e){const{worldPoint:t}=e;return{worldIslandPoints:[t]}}async getGrowCutLabelmap(e){const{segmentation:{referencedVolumeId:t},worldPoint:n,options:o}=e,{subVolumePaddingPercentage:a}=this.configuration,s={...o,subVolumePaddingPercentage:a,seeds:this.seeds};return i.growCut.runOneClickGrowCut({referencedVolumeId:t,worldPosition:n,options:s})}}const d=l},9626:(e,t,n)=>{"use strict";n.d(t,{A:()=>g});var o=n(3823),i=n(15327),a=n(74347),s=n(7001),r=n(99737),l=n(58640),d=n(93759),c=n(10639);class h extends c.A{static{this.toolName="RegionSegment"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{isPartialVolume:!0,positiveSeedVariance:.5,negativeSeedVariance:.9}}){super(e,t),this._dragCallback=e=>{const t=e.detail,{element:n,currentPoints:o}=t,{world:a}=o,s=(0,i.getEnabledElement)(n),{viewport:r}=s;this.growCutData.circleBorderPoint=a,(0,l.A)([r.id])},this._endCallback=async e=>{const t=e.detail,{element:n}=t,o=(0,i.getEnabledElement)(n),{viewport:a}=o;this.runGrowCut(),this._deactivateDraw(n),this.growCutData=null,(0,s.resetElementCursor)(n),(0,l.A)([a.id])},this._deactivateDraw=e=>{e.removeEventListener(r.Events.MOUSE_UP,this._endCallback),e.removeEventListener(r.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(r.Events.MOUSE_CLICK,this._endCallback)}}async preMouseDownCallback(e){const t=e.detail,{element:n,currentPoints:o}=t,{world:a}=o,r=(0,i.getEnabledElement)(n),{viewport:d,renderingEngine:c}=r;return await super.preMouseDownCallback(e),Object.assign(this.growCutData,{circleCenterPoint:a,circleBorderPoint:a}),this._activateDraw(n),(0,s.hideElementCursor)(n),(0,l.A)([d.id]),!0}async getGrowCutLabelmap(e){const{segmentation:{referencedVolumeId:t},renderingEngineId:n,viewportId:a,circleCenterPoint:s,circleBorderPoint:r,options:l}=e,c=(0,i.getRenderingEngine)(n).getViewport(a),h={center:s,radius:o.eR.len(o.eR.sub(o.eR.create(),s,r))};return d.growCut.runGrowCutForSphere(t,h,c,l)}_activateDraw(e){e.addEventListener(r.Events.MOUSE_UP,this._endCallback),e.addEventListener(r.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(r.Events.MOUSE_CLICK,this._endCallback)}renderAnnotation(e,t){if(!this.growCutData)return;const{viewport:n}=e,{segmentation:s,circleCenterPoint:r,circleBorderPoint:l}=this.growCutData,d=n.worldToCanvas(r),c=n.worldToCanvas(l),h=o.Zc.sub(o.Zc.create(),c,d),g=o.Zc.len(h);if(i.utilities.isEqual(g,0))return;const{color:u}=this.getSegmentStyle({segmentationId:s.segmentationId,segmentIndex:s.segmentIndex,viewportId:n.id});(0,a.drawCircle)(t,"growcut","0",d,g,{color:u})}}const g=h},60580:(e,t,n)=>{"use strict";n.d(t,{A:()=>l});var o=n(15327),i=n(3066),a=n(99737),s=n(56534);class r extends i.A{static{this.toolName="SplineContourSegmentationTool"}constructor(e){super(o.utilities.deepMerge({configuration:{calculateStats:!1}},e)),this.annotationCutMergeCompletedBinded=this.annotationCutMergeCompleted.bind(this)}isContourSegmentationTool(){return!0}initializeListeners(){o.eventTarget.addEventListener(a.Events.ANNOTATION_CUT_MERGE_PROCESS_COMPLETED,this.annotationCutMergeCompletedBinded)}removeListeners(){o.eventTarget.removeEventListener(a.Events.ANNOTATION_CUT_MERGE_PROCESS_COMPLETED,this.annotationCutMergeCompletedBinded)}annotationCutMergeCompleted(e){const{sourceAnnotation:t}=e.detail;this.splineToolNames.includes(t?.metadata?.toolName)&&this.configuration.simplifiedSpline&&(0,s.convertContourSegmentationAnnotation)(t)}}const l=r},3066:(e,t,n)=>{"use strict";n.d(t,{A:()=>M});var o=n(15327),i=n(3823),a=n(82056),s=n(74347),r=n(85204),l=n(99737),d=n(7001),c=n(95527),h=n(27730),g=n(60810),u=n(473),m=n(4096),v=n(76910),p=n(93126),f=n(71543),E=n(63802),w=n(31147),I=n(34115),C=n(36320),T=n(53860),b=n(56534);const A={resolution:20,controlPointAdditionDistance:6,controlPointDeletionDistance:6,showControlPointsConnectors:!1,controlPointAdditionEnabled:!0,controlPointDeletionEnabled:!0};var _,S;!function(e){e.Cardinal="CARDINAL",e.Linear="LINEAR",e.CatmullRom="CATMULLROM",e.BSpline="BSPLINE"}(_||(_={})),function(e){e.AddControlPoint="addControlPoint",e.DeleteControlPoint="deleteControlPoint"}(S||(S={}));class D extends C.A{static{this.toolName="SplineROI"}static{this.SplineTypes=_}static{this.Actions=S}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,calculateStats:!0,simplifiedSpline:!1,getTextLines:y,contourHoleAdditionModifierKey:l.KeyboardBindings.Shift,decimate:{enabled:!1,epsilon:.1},spline:{configuration:{[_.Cardinal]:{Class:f.A,scale:.5},[_.CatmullRom]:{Class:w.e},[_.Linear]:{Class:E.F},[_.BSpline]:{Class:I.k,controlPointAdditionEnabled:!1,controlPointDeletionEnabled:!1,showControlPointsConnectors:!0}},type:_.CatmullRom,drawPreviewEnabled:!0,enableTwoPointPreview:!1,lastControlPointDeletionKeys:["Backspace","Delete"]},actions:{[S.AddControlPoint]:{method:"addControlPointCallback",bindings:[{mouseButton:l.MouseBindings.Primary,modifierKey:l.KeyboardBindings.Shift}]},[S.DeleteControlPoint]:{method:"deleteControlPointCallback",bindings:[{mouseButton:l.MouseBindings.Primary,modifierKey:l.KeyboardBindings.Ctrl}]}}}}){super(e,t),this.splineToolNames=["CatmullRomSplineROI","LinearSplineROI","BSplineROI","CardinalSplineROI"],this.isHandleOutsideImage=!1,this.fireChangeOnUpdate=null,this.isPointNearTool=(e,t,n,o)=>{const{instance:i}=t.data.spline;return i.isPointNearCurve(n,o)},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=(0,g.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},this._activateModify(o),(0,T.triggerAnnotationRenderForViewportIds)(i),e.preventDefault()},this.handleSelectedCallback=(e,t,n)=>{const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;let s,r=!1;if(n.worldPosition)r=!0;else{const{points:e}=a.handles;s=e.findIndex(e=>e===n)}const l=(0,g.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:s,movingTextBox:r},this._activateModify(i),(0,T.triggerAnnotationRenderForViewportIds)(l),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:s,newAnnotation:r,contourHoleProcessingEnabled:c}=this.editData,{data:h}=i;i.autoGenerated=!1,h.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,d.resetElementCursor)(n);const g=(0,o.getEnabledElement)(n),u=this.getTargetImageData(this.getTargetId(g.viewport)),{imageData:m,dimensions:v}=u;this.isHandleOutsideImage=h.handles.points.map(e=>o.utilities.transformWorldToIndex(m,e)).some(e=>!o.utilities.indexWithinDimensions(e,v)),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,a.removeAnnotation)(i.annotationUID);const p=r?l.ChangeTypes.Completed:l.ChangeTypes.HandlesUpdated;this.fireChangeOnUpdate?(this.fireChangeOnUpdate.annotationUID=i.annotationUID,this.fireChangeOnUpdate.changeType=p):this.fireChangeOnUpdate={annotationUID:i.annotationUID,changeType:p,contourHoleProcessingEnabled:c},(0,T.triggerAnnotationRenderForViewportIds)(s),this.doneEditMemo(),this.editData=null,this.isDrawing=!1},this._keyDownCallback=e=>{const t=e.detail,{element:n}=t,o=t.key??"",{lastControlPointDeletionKeys:i}=this.configuration.spline;if(!i.includes(o))return;const{annotation:a}=this.editData,{data:s}=a;if(3!==s.handles.points.length){{const e=s.handles.points.length-1;this._deleteControlPointByIndex(n,a,e)}e.preventDefault()}else this.cancel(n)},this._mouseMoveCallback=e=>{const{drawPreviewEnabled:t}=this.configuration.spline;if(!t)return;const{element:n}=e.detail,{renderingEngine:i}=(0,o.getEnabledElement)(n),a=(0,g.getViewportIdsWithToolToRender)(n,this.getToolName());this.editData.lastCanvasPoint=e.detail.currentPoints.canvas,(0,T.triggerAnnotationRenderForViewportIds)(a),e.preventDefault()},this._mouseDownCallback=e=>{const t=e.type===l.Events.MOUSE_DOUBLE_CLICK,{annotation:n,viewportIdsToRender:o}=this.editData,{data:i}=n;if(i.contour.closed)return;this.doneEditMemo();const a=e.detail,{currentPoints:s,element:r}=a,{canvas:d,world:c}=s;let h=i.handles.points.length>=2&&t,g=!0;if(i.handles.points.length&&this.createMemo(r,n,{newAnnotation:1===i.handles.points.length}),i.handles.points.length>=3){this.createMemo(r,n);const{instance:e}=i.spline,t=e.getClosestControlPointWithinDistance(d,10);0===t?.index&&(g=!1,h=!0)}g&&i.handles.points.push(c),i.contour.closed=i.contour.closed||h,n.invalidated=!0,(0,T.triggerAnnotationRenderForViewportIds)(o),i.contour.closed&&this._endCallback(e),e.preventDefault()},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:s,movingTextBox:r,newAnnotation:l}=this.editData,{data:d}=i;if(this.createMemo(n,i,{newAnnotation:l}),r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=d.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;this.moveAnnotation(i,n)}else{const{currentPoints:e}=t,n=e.world;d.handles.points[s]=[...n],i.invalidated=!0}this.editData.hasMoved=!0;const c=(0,o.getEnabledElement)(n),{renderingEngine:h}=c;(0,T.triggerAnnotationRenderForViewportIds)(a)},this.triggerAnnotationCompleted=(e,t)=>{const n=l.Events.ANNOTATION_COMPLETED,i={annotation:e,changeType:l.ChangeTypes.Completed,contourHoleProcessingEnabled:t};(0,o.triggerEvent)(o.eventTarget,n,i)},this.triggerAnnotationModified=(e,t,n=l.ChangeTypes.StatsUpdated)=>{const{viewportId:i,renderingEngineId:a}=t,s=l.Events.ANNOTATION_MODIFIED,r={annotation:e,viewportId:i,renderingEngineId:a,changeType:n};(0,o.triggerEvent)(o.eventTarget,s,r)},this.triggerChangeEvent=(e,t,n=l.ChangeTypes.StatsUpdated,o)=>{n===l.ChangeTypes.Completed?this.triggerAnnotationCompleted(e,o):this.triggerAnnotationModified(e,t,n)},this._activateModify=e=>{r.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.MOUSE_UP,this._endCallback),e.addEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(l.Events.TOUCH_END,this._endCallback),e.addEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{r.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.MOUSE_UP,this._endCallback),e.removeEventListener(l.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(l.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(l.Events.TOUCH_END,this._endCallback),e.removeEventListener(l.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{r.wk.isInteractingWithTool=!0,e.addEventListener(l.Events.KEY_DOWN,this._keyDownCallback),e.addEventListener(l.Events.MOUSE_MOVE,this._mouseMoveCallback),e.addEventListener(l.Events.MOUSE_DOWN,this._mouseDownCallback),e.addEventListener(l.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.addEventListener(l.Events.TOUCH_TAP,this._mouseDownCallback)},this._deactivateDraw=e=>{r.wk.isInteractingWithTool=!1,e.removeEventListener(l.Events.KEY_DOWN,this._keyDownCallback),e.removeEventListener(l.Events.MOUSE_MOVE,this._mouseMoveCallback),e.removeEventListener(l.Events.MOUSE_DOWN,this._mouseDownCallback),e.removeEventListener(l.Events.MOUSE_DOUBLE_CLICK,this._mouseDownCallback),e.removeEventListener(l.Events.TOUCH_TAP,this._mouseDownCallback)},this._renderStats=(e,t,n,o)=>{const i=e.data,a=this.getTargetId(t);if(!i.spline.instance.closed||!o.visibility)return;const r=this.configuration.getTextLines(i,a);if(!r||0===r.length)return;const l=i.handles.points.map(e=>t.worldToCanvas(e));if(!i.handles.textBox.hasMoved){const e=(0,u.getTextBoxCoordsCanvas)(l);i.handles.textBox.worldPosition=t.canvasToWorld(e)}const d=t.worldToCanvas(i.handles.textBox.worldPosition),c=(0,s.drawLinkedTextBox)(n,e.annotationUID??"","textBox",r,d,l,{},o),{x:h,y:g,width:m,height:v}=c;i.handles.textBox.worldBoundingBox={topLeft:t.canvasToWorld([h,g]),topRight:t.canvasToWorld([h+m,g]),bottomLeft:t.canvasToWorld([h,g+v]),bottomRight:t.canvasToWorld([h+m,g+v])}},this.addControlPointCallback=(e,t)=>{const{data:n}=t,i=n.spline.type,a=this._getSplineConfig(i),s=a.controlPointAdditionDistance;if(!1===a.controlPointAdditionEnabled)return;const r=e.detail,{element:l}=r,d=(0,o.getEnabledElement)(l),{renderingEngine:c,viewport:h}=d,{canvasToWorld:u}=h,{instance:m}=n.spline,v=e.detail.currentPoints.canvas,p=m.getClosestPoint(v);if(p.distance>s)return;const{index:f,point:E}=m.addControlPointAtU(p.uValue);n.handles.points.splice(f,0,u(E)),t.invalidated=!0;const w=(0,g.getViewportIdsWithToolToRender)(l,this.getToolName());(0,T.triggerAnnotationRenderForViewportIds)(w)},this.deleteControlPointCallback=(e,t)=>{const n=t.data.spline.type,o=this._getSplineConfig(n),i=o.controlPointDeletionDistance;if(!1===o.controlPointDeletionEnabled)return;const a=e.detail,{element:s,currentPoints:r}=a,{canvas:l}=r,{instance:d}=t.data.spline,c=d.getClosestControlPointWithinDistance(l,i);c&&this._deleteControlPointByIndex(s,t,c.index)},this._calculateCachedStats=(e,t)=>{if(!this.configuration.calculateStats)return;const n=e.data;if(!n.contour.closed)return;const a=(0,o.getEnabledElement)(t);if(!a)return;const{viewport:s}=a,{cachedStats:r}=n,{polyline:d}=n.contour,h=Object.keys(r);for(let e=0;e<h.length;e++){const t=h[e],n=this.getTargetImageData(t);if(!n)continue;const{metadata:a}=n,l=d.map(e=>s.worldToCanvas(e)),g=l[0],u=s.canvasToWorld(g),v=s.canvasToWorld([g[0]+1,g[1]]),p=s.canvasToWorld([g[0],g[1]+1]),f=i.eR.distance(u,v),E=i.eR.distance(u,p),{imageData:w}=n,{scale:I,areaUnit:C}=(0,m.Op)(n,()=>{const{maxX:e,maxY:t,minX:n,minY:i}=c.polyline.getAABB(l),a=s.canvasToWorld([n,i]),r=o.utilities.transformWorldToIndex(w,a),d=s.canvasToWorld([e,t]);return[r,o.utilities.transformWorldToIndex(w,d)]});let T=c.polyline.getArea(l)/I/I;T*=f*E,r[t]={Modality:a.Modality,area:T,areaUnit:C}}const g=e.invalidated;return e.invalidated=!1,g&&this.triggerAnnotationModified(e,a,l.ChangeTypes.StatsUpdated),r},this._throttledCalculateCachedStats=(0,h.A)(this._calculateCachedStats,100,{trailing:!0}),this.annotationCompletedBinded=this.annotationCompleted.bind(this)}annotationCompleted(e){const{sourceAnnotation:t}=e.detail;this.splineToolNames.includes(t?.metadata?.toolName)&&this.configuration.simplifiedSpline&&this.isContourSegmentationTool()&&(0,b.convertContourSegmentationAnnotation)(t)}initializeListeners(){o.eventTarget.addEventListener(l.Events.ANNOTATION_COMPLETED,this.annotationCompletedBinded)}removeListeners(){o.eventTarget.removeEventListener(l.Events.ANNOTATION_COMPLETED,this.annotationCompletedBinded)}onSetToolEnabled(){this.initializeListeners()}onSetToolActive(){this.initializeListeners()}onSetToolDisabled(){this.removeListeners()}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:i}=t,{canvas:a}=n,s=(0,v.A)(e.detail.event)===this.configuration.contourHoleAdditionModifierKey,r=(0,o.getEnabledElement)(i),{renderingEngine:l}=r,d=this.createAnnotation(e);this.isDrawing=!0,this.addAnnotation(d,i);const c=(0,g.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:d,viewportIdsToRender:c,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,lastCanvasPoint:a,contourHoleProcessingEnabled:s},this._activateDraw(i),e.preventDefault(),(0,T.triggerAnnotationRenderForViewportIds)(c),d}cancel(e){if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,d.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:i}=this.editData;i&&(0,a.removeAnnotation)(t.annotationUID),super.cancelAnnotation(t);const s=(0,o.getEnabledElement)(e),{renderingEngine:r}=s;return(0,T.triggerAnnotationRenderForViewportIds)(n),this.editData=null,t.annotationUID}isContourSegmentationTool(){return!1}renderAnnotationInstance(e){const{enabledElement:t,targetId:n,svgDrawingHelper:o,annotationStyle:i}=e,{viewport:r}=t,{worldToCanvas:l}=r,{element:d}=r,c=e.annotation,{annotationUID:h,data:g,highlighted:u}=c,{handles:m}=g,{points:v,activeHandleIndex:f}=m,E=this.editData?.newAnnotation,{lineWidth:w,lineDash:I,color:C,locked:T}=i,b=v.map(e=>l(e)),{drawPreviewEnabled:A}=this.configuration.spline,_=c.data.spline.type,S=this._getSplineConfig(_),D=c.data.spline.instance,y=(0,a.getChildAnnotations)(c);if(-1!==y.findIndex(e=>!e))throw new Error(`Can't find annotation for child ${c.childAnnotationUIDs.join()}`);let M;if([c,...y].filter(e=>this._isSplineROIAnnotation(e)).forEach(e=>{const t=this._updateSplineInstance(d,e).getPolylinePoints();this.updateContourPolyline(e,{points:t,closed:g.contour.closed,targetWindingDirection:p.W.Clockwise},r,{updateWindingDirection:g.contour.closed})}),super.renderAnnotationInstance(e),g.cachedStats[n]&&null!=g.cachedStats[n].areaUnit?c.invalidated&&this._throttledCalculateCachedStats(c,d):(g.cachedStats[n]={Modality:null,area:null,areaUnit:null},this._calculateCachedStats(c,d)),T||this.editData||null===f||(M=[b[f]]),M||E||u){const e="0";(0,s.drawHandles)(o,h,e,b,{color:C,lineWidth:w,handleRadius:"3"})}if(A&&D.numControlPoints>=1&&this.editData?.lastCanvasPoint&&!D.closed){const{lastCanvasPoint:e}=this.editData,{enableTwoPointPreview:t}=this.configuration.spline;if(1===D.numControlPoints&&t){const t=[b[0],e];(0,s.drawPolyline)(o,h,"previewSplineChange",t,{color:"#9EA0CA",lineDash:I,lineWidth:1})}else if(D.numControlPoints>1){const t=D.getPreviewPolylinePoints(e,10);(0,s.drawPolyline)(o,h,"previewSplineChange",t,{color:"#9EA0CA",lineDash:I,lineWidth:1})}}if(S.showControlPointsConnectors){const e=[...b];D.closed&&e.push(b[0]),(0,s.drawPolyline)(o,h,"controlPointsConnectors",e,{color:"rgba(255, 255, 255, 0.5)",lineWidth:1})}return this._renderStats(c,r,o,i.textbox),this.fireChangeOnUpdate?.annotationUID===h&&(this.triggerChangeEvent(c,t,this.fireChangeOnUpdate.changeType,this.fireChangeOnUpdate.contourHoleProcessingEnabled),this.fireChangeOnUpdate=null),c.invalidated=!1,!0}createInterpolatedSplineControl(e){if(e.data.handles.points?.length)return;const{polyline:t}=e.data.contour;if(!t||!t.length)return;e.data.handles.points=[];const{points:n}=e.data.handles,o=Math.max(10,Math.floor(t.length/20));for(let e=0;e<t.length-o;e+=o)n.push(t[e]);n.push(t[t.length-1])}createAnnotation(e){const t=super.createAnnotation(e),{world:n}=e.detail.currentPoints,{type:i}=this.configuration.spline,a=this._getSplineConfig(i),s=new a.Class,r=()=>({type:a.type,instance:s,resolution:a.resolution});let l;return this.configuration.interpolation?.enabled&&(l=e=>{e.data.spline||=r(),this.createInterpolatedSplineControl(e)}),o.utilities.deepMerge(t,{data:{handles:{points:[[...n]]},spline:r(),cachedStats:{}},onInterpolationComplete:l})}_deleteControlPointByIndex(e,t,n){const i=(0,o.getEnabledElement)(e),{points:s}=t.data.handles;3===s.length?(0,a.removeAnnotation)(t.annotationUID):s.splice(n,1);const{renderingEngine:r}=i,l=(0,g.getViewportIdsWithToolToRender)(e,this.getToolName());t.invalidated=!0,(0,T.triggerAnnotationRenderForViewportIds)(l)}_isSplineROIAnnotation(e){return!!e.data?.spline}_getSplineConfig(e){const{configuration:t}=this,n=t.spline.configuration;return Object.assign({type:e},A,n[e])}_updateSplineInstance(e,t){const n=(0,o.getEnabledElement)(e),{viewport:i}=n,{worldToCanvas:a}=i,{data:s}=t,{type:r,instance:l}=t.data.spline,d=this._getSplineConfig(r),c=s.handles.points.map(a),h=void 0!==d.resolution?parseInt(d.resolution):void 0,g=void 0!==d.scale?parseFloat(d.scale):void 0;return l.setControlPoints(c),l.closed=!!s.contour.closed,l.fixedResolution||void 0===h||l.resolution===h||(l.resolution=h,t.invalidated=!0),l instanceof f.A&&!l.fixedScale&&void 0!==g&&l.scale!==g&&(l.scale=g,t.invalidated=!0),l}static{this.hydrate=(e,t,n)=>{const i=(0,o.getEnabledElementByViewportId)(e);if(!i)return;if(t.length<3)return void console.warn("Spline requires at least 3 control points");const{FrameOfReferenceUID:s,referencedImageId:r,viewPlaneNormal:l,viewUp:d,instance:c,viewport:h}=this.hydrateBase(D,i,t,n),g=n?.splineType||_.CatmullRom,u=new(0,c._getSplineConfig(g).Class),{toolInstance:m,...v}=n||{},p={annotationUID:n?.annotationUID||o.utilities.uuidv4(),data:{handles:{points:t},label:"",cachedStats:{},spline:{type:g,instance:u},contour:{closed:!0}},highlighted:!1,autoGenerated:!1,invalidated:!0,isLocked:!1,isVisible:!0,metadata:{toolName:c.getToolName(),viewPlaneNormal:l,FrameOfReferenceUID:s,referencedImageId:r,...v}};(0,a.addAnnotation)(p,h.element),(0,T.triggerAnnotationRenderForViewportIds)([h.id])}}}function y(e,t){const n=e.cachedStats[t],{area:i,isEmptyArea:a,areaUnit:s}=n,r=[];if(i){const e=a?"Area: Oblique not supported":`Area: ${o.utilities.roundNumber(i)} ${s}`;r.push(e)}return r}const M=D},94504:(e,t,n)=>{"use strict";n.d(t,{A:()=>I});var o=n(99737),i=n(15327),a=n(85817),s=n(27730),r=n(82056),l=n(44049),d=n(74347),c=n(85204),h=n(60810),g=n(82216),u=n(58640),m=n(7001),v=n(4096),p=n(95527);const{transformWorldToIndex:f}=i.utilities;class E extends a.EC{static{this.toolName="UltrasoundDirectionalTool"}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1,getTextLines:w,displayBothAxesDistances:!1}}){super(e,t),this.addNewAnnotation=e=>{if(this.startedDrawing)return;this.startedDrawing=!0;const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,s=(0,i.getEnabledElement)(o),{viewport:l,renderingEngine:d}=s;if(!(l instanceof i.StackViewport))throw new Error("UltrasoundDirectionalTool can only be used on a StackViewport");(0,m.hideElementCursor)(o),this.isDrawing=!0;const c=l.getCamera(),{viewPlaneNormal:g,viewUp:v}=c,p=this.getReferencedImageId(l,a,g,v),f=l.getFrameOfReferenceUID(),E={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...g],viewUp:[...v],FrameOfReferenceUID:f,referencedImageId:p},data:{handles:{points:[[...a],[...a]],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},label:"",cachedStats:{}}};(0,r.addAnnotation)(E,o);const w=(0,h.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:E,viewportIdsToRender:w,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),e.preventDefault(),(0,u.A)(w),E},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,[l,d]=r.handles.points,c=s.worldToCanvas(l),h=s.worldToCanvas(d),g={start:{x:c[0],y:c[1]},end:{x:h[0],y:h[1]}};return p.lineSegment.distanceToPoint([g.start.x,g.start.y],[g.end.x,g.end.y],[n[0],n[1]])<=o},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,newAnnotation:s,hasMoved:d}=this.editData,{data:c}=o;if(s&&!d)return;if(this.startedDrawing&&1===c.handles.points.length)return void(this.editData.handleIndex=1);this.startedDrawing=!1,c.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,m.resetElementCursor)(n);const h=(0,i.getEnabledElement)(n),{renderingEngine:g}=h;this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.removeAnnotation)(o.annotationUID),(0,u.A)(a),s&&(0,l.triggerAnnotationCompleted)(o),this.editData=null,this.isDrawing=!1},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:a,handleIndex:s,movingTextBox:r}=this.editData,{data:l}=o;if(r){const{deltaPoints:e}=t,n=e.world,{textBox:o}=l.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===s){const{deltaPoints:e}=t,n=e.world;l.handles.points.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),o.invalidated=!0}else{const{currentPoints:e}=t,n=e.world;l.handles.points[s]=[...n],o.invalidated=!0}this.editData.hasMoved=!0;const d=(0,i.getEnabledElement)(n),{renderingEngine:c}=d;(0,u.A)(a)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,m.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;return t.highlighted=!1,i.handles.activeHandleIndex=null,(0,u.A)(n),o&&(0,l.triggerAnnotationCompleted)(t),this.editData=null,this.startedDrawing=!1,t.annotationUID}},this._activateModify=e=>{c.wk.isInteractingWithTool=!0,e.addEventListener(o.Events.MOUSE_UP,this._endCallback),e.addEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(o.Events.TOUCH_TAP,this._endCallback),e.addEventListener(o.Events.TOUCH_END,this._endCallback),e.addEventListener(o.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{c.wk.isInteractingWithTool=!1,e.removeEventListener(o.Events.MOUSE_UP,this._endCallback),e.removeEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(o.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(o.Events.TOUCH_END,this._endCallback),e.removeEventListener(o.Events.TOUCH_DRAG,this._dragCallback)},this._activateDraw=e=>{c.wk.isInteractingWithTool=!0,e.addEventListener(o.Events.MOUSE_UP,this._endCallback),e.addEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(o.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(o.Events.TOUCH_TAP,this._endCallback),e.addEventListener(o.Events.TOUCH_END,this._endCallback),e.addEventListener(o.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{c.wk.isInteractingWithTool=!1,e.removeEventListener(o.Events.MOUSE_UP,this._endCallback),e.removeEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(o.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(o.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(o.Events.TOUCH_END,this._endCallback),e.removeEventListener(o.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;let a=(0,r.getAnnotations)(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const s=this.getTargetId(o),l=o.getRenderingEngine(),c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<a.length;i++){const r=a[i],{annotationUID:h,data:g}=r,{points:u}=g.handles;c.annotationUID=h;const m=this.getStyle("color",c,r),v=u.map(e=>o.worldToCanvas(e));if(g.cachedStats[s]&&null!=g.cachedStats[s].xValues?r.invalidated&&this._throttledCalculateCachedStats(r,l,e):(g.cachedStats[s]={xValues:[0,0],yValues:[0,0],isHorizontal:!1,units:[""],isUnitless:!1},this._calculateCachedStats(r,l,e)),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let p="0";if((0,d.drawHandle)(t,h,p,v[0],{color:m},0),n=!0,2!==v.length)return n;p="1",(0,d.drawHandle)(t,h,p,v[1],{color:m},1);if(g.cachedStats[s].isUnitless){const e=`${h}-line-1`,n="1";(0,d.drawLine)(t,h,n,v[0],v[1],{color:m,width:1,shadow:this.configuration.shadow},e)}else{const e=v[0],n=v[1],o=n[1]-e[1],i=n[0]-e[0];let a=[0,0];a=g.cachedStats[s].isHorizontal?[e[0]+i,e[1]]:[e[0],e[1]+o];let r=`${h}-line-1`,l="1";(0,d.drawLine)(t,h,l,v[0],a,{color:m,width:1,shadow:this.configuration.shadow},r),r=`${h}-line-2`,l="2",(0,d.drawLine)(t,h,l,v[1],a,{color:m,width:1,lineDash:[1,1],shadow:this.configuration.shadow},r)}const f=this.getLinkedTextBoxStyle(c,r);if(!f.visibility){g.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const E=this.configuration.getTextLines(g,s,this.configuration);if(!g.handles.textBox.hasMoved){const e=v[1];g.handles.textBox.worldPosition=o.canvasToWorld(e)}const w=o.worldToCanvas(g.handles.textBox.worldPosition),I="1",C=(0,d.drawLinkedTextBox)(t,h,I,E,w,v,{},f),{x:T,y:b,width:A,height:_}=C;g.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([T,b]),topRight:o.canvasToWorld([T+A,b]),bottomLeft:o.canvasToWorld([T,b+_]),bottomRight:o.canvasToWorld([T+A,b+_])}}return n},this._throttledCalculateCachedStats=(0,s.A)(this._calculateCachedStats,100,{trailing:!0})}toolSelectedCallback(e,t,n,o){}handleSelectedCallback(e,t,n){const o=e.detail,{element:a}=o,{data:s}=t;t.highlighted=!0;const r=(0,h.getViewportIdsWithToolToRender)(a,this.getToolName());let l,d=!1;n.worldPosition?d=!0:l=s.handles.points.findIndex(e=>e===n),this.editData={handleIndex:l,annotation:t,viewportIdsToRender:r},this._activateModify(a),(0,m.hideElementCursor)(a);const c=(0,i.getEnabledElement)(a),{renderingEngine:g}=c;(0,u.A)(r),e.preventDefault()}_calculateCachedStats(e,t,n){const i=e.data,{element:a}=n.viewport;if(2!==i.handles.points.length)return;const{cachedStats:s}=i,r=Object.keys(s);for(let e=0;e<r.length;e++){const t=r[e],o=this.getTargetImageData(t);if(!o)continue;const{imageData:a}=o,l=i.handles.points[0],d=i.handles.points[1],c=f(a,l),h=f(a,d),{values:u,units:m}=(0,v.Xw)(o,[c]),{values:p,units:E}=(0,v.Xw)(o,[h]);let w,I,C,T,b=!1;if(m[0]!==E[0]||m[1]!==E[1]||"raw"===m[0]&&"raw"===E[0]){const e=(0,g.distanceToPoint)(l,d);w=[e,0],I=[e,0],C=["px"],b=!0}else{const e=n.viewport.worldToCanvas(l),t=n.viewport.worldToCanvas(d),o=t[1]-e[1],i=t[0]-e[0];T=Math.abs(i)>Math.abs(o),w=[u[0],p[0]],I=[u[1],p[1]],C=[m[0],m[1]]}s[t]={xValues:w,yValues:I,isHorizontal:T,units:C,isUnitless:b}}const d=e.invalidated;return e.invalidated=!1,d&&(0,l.triggerAnnotationModified)(e,a,o.ChangeTypes.StatsUpdated),s}}function w(e,t,n){const o=e.cachedStats[t],{xValues:a,yValues:s,units:r,isUnitless:l,isHorizontal:d}=o;if(l)return[`${i.utilities.roundNumber(a[0])} px`];if(n.displayBothAxesDistances){const e=Math.abs(a[1]-a[0]),t=Math.abs(s[1]-s[0]);return[`${i.utilities.roundNumber(e)} ${r[0]}`,`${i.utilities.roundNumber(t)} ${r[1]}`]}if(d){const e=Math.abs(a[1]-a[0]);return[`${i.utilities.roundNumber(e)} ${r[0]}`]}{const e=Math.abs(s[1]-s[0]);return[`${i.utilities.roundNumber(e)} ${r[1]}`]}}const I=E},20214:(e,t,n)=>{"use strict";n.d(t,{A:()=>C});var o=n(99737),i=n(15327),a=n(85817),s=n(82056),r=n(2076),l=n(29601),d=n(44049),c=n(93258),h=n(74347),g=n(85204),u=n(60810),m=n(58640),v=n(7001),p=n(17787),f=n(58180);const{transformIndexToWorld:E}=i.utilities;class w extends a.EC{static{this.toolName="UltrasoundPleuraBLineTool"}static{this.USPleuraBLineAnnotationType={BLINE:"bLine",PLEURA:"pleura"}}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{preventHandleOutsideImage:!1,getTextLines:I,center:null,innerRadius:null,outerRadius:null,startAngle:null,endAngle:null,bLineColor:"rgb(60, 255, 60)",pleuraColor:"rgb(0, 4, 255)",drawDepthGuide:!0,depth_ratio:.5,depthGuideColor:"rgb(0, 255, 255)",depthGuideThickness:4,depthGuideDashLength:20,depthGuideDashGap:16,depthGuideOpacity:.2,fanOpacity:.1,showFanAnnotations:!0,updatePercentageCallback:null,actions:{undo:{method:"undo",bindings:[{key:"z"}]},redo:{method:"redo",bindings:[{key:"y"}]}}}}){super(e,t),this.pleuraAnnotations=[],this.bLineAnnotations=[],this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,r=(0,i.getEnabledElement)(o),{viewport:l}=r;(0,v.hideElementCursor)(o),this.isDrawing=!0;const{viewPlaneNormal:d,viewUp:c,position:h}=l.getCamera(),g=this.getReferencedImageId(l,a,d,c),p={highlighted:!0,invalidated:!0,metadata:{...l.getViewReference({points:[a]}),toolName:this.getToolName(),referencedImageId:g,viewUp:c,cameraPosition:h},data:{handles:{points:[[...a],[...a]],activeHandleIndex:null},annotationType:this.getActiveAnnotationType(),label:""}};(0,s.addAnnotation)(p,o);const f=(0,u.getViewportIdsWithToolToRender)(o,this.getToolName());return this.editData={annotation:p,viewportIdsToRender:f,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),e.preventDefault(),(0,m.A)(f),p},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,[l,d]=r.handles.points,h=s.worldToCanvas(l),g=s.worldToCanvas(d),u={start:{x:h[0],y:h[1]},end:{x:g[0],y:g[1]}};return c.distanceToPoint([u.start.x,u.start.y],[u.end.x,u.end.y],[n[0],n[1]])<=o},this.toolSelectedCallback=(e,t)=>{const n=e.detail,{element:o}=n;t.highlighted=!0;const i=(0,u.getViewportIdsWithToolToRender)(o,this.getToolName());this.editData={annotation:t,viewportIdsToRender:i,movingTextBox:!1},this._activateModify(o),(0,v.hideElementCursor)(o),(0,m.A)(i),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportIdsToRender:i,newAnnotation:a,hasMoved:r}=this.editData,{data:l}=o;a&&!r||(l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,v.resetElementCursor)(n),this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,s.removeAnnotation)(o.annotationUID),(0,m.A)(i),this.doneEditMemo(),a&&(0,d.triggerAnnotationCompleted)(o),this.editData=null,this.isDrawing=!1)},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{viewport:a}=(0,i.getEnabledElement)(n)||{};if(!a)return;const{annotation:s,viewportIdsToRender:r,handleIndex:l,movingTextBox:c,newAnnotation:h}=this.editData,{data:g}=s;if(this.createMemo(n,s,{newAnnotation:h}),c){const{deltaPoints:e}=t,n=e.world,{textBox:o}=g.handles,{worldPosition:i}=o;i[0]+=n[0],i[1]+=n[1],i[2]+=n[2],o.hasMoved=!0}else if(void 0===l){const{deltaPoints:e}=t,n=e.world,o=g.handles.points;o.every(e=>{const t=[e[0]+n[0],e[1]+n[1],e[2]+n[2]];return this.isInsideFanShape(a,t)})&&(o.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),s.invalidated=!0)}else{const{currentPoints:e}=t,n=e.world;this.isInsideFanShape(a,n)&&(g.handles.points[l]=[...n],s.invalidated=!0)}this.editData.hasMoved=!0,(0,m.A)(r),s.invalidated&&(0,d.triggerAnnotationModified)(s,n,o.ChangeTypes.HandlesUpdated)},this.cancel=e=>{if(this.isDrawing){this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,v.resetElementCursor)(e);const{annotation:t,viewportIdsToRender:n,newAnnotation:o}=this.editData,{data:i}=t;return t.highlighted=!1,i.handles.activeHandleIndex=null,(0,m.A)(n),o&&(0,d.triggerAnnotationCompleted)(t),this.editData=null,t.annotationUID}},this._activateModify=e=>{g.wk.isInteractingWithTool=!0,e.addEventListener(o.Events.MOUSE_UP,this._endCallback),e.addEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(o.Events.TOUCH_END,this._endCallback),e.addEventListener(o.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(o.Events.TOUCH_TAP,this._endCallback)},this._deactivateModify=e=>{g.wk.isInteractingWithTool=!1,e.removeEventListener(o.Events.MOUSE_UP,this._endCallback),e.removeEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(o.Events.TOUCH_END,this._endCallback),e.removeEventListener(o.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(o.Events.TOUCH_TAP,this._endCallback)},this._activateDraw=e=>{g.wk.isInteractingWithTool=!0,e.addEventListener(o.Events.MOUSE_UP,this._endCallback),e.addEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(o.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(o.Events.TOUCH_END,this._endCallback),e.addEventListener(o.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(o.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{g.wk.isInteractingWithTool=!1,e.removeEventListener(o.Events.MOUSE_UP,this._endCallback),e.removeEventListener(o.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(o.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(o.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(o.Events.TOUCH_END,this._endCallback),e.removeEventListener(o.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(o.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:i}=o;if(!this.getFanShapeGeometryParameters(o))return;const{imageData:a}=o.getImageData()||{};if(!a)return n;this.configuration.drawDepthGuide&&this.drawDepthGuide(t,o);let d=(0,s.getAnnotations)(this.getToolName(),i);if(!d?.length)return n;if(d=this.filterInteractableAnnotationsForElement(i,d),!d?.length)return n;this.getTargetId(o),o.getRenderingEngine();const c={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id},g=o.worldToCanvas(E(a,this.configuration.center)),u=this.getIndexToCanvasRatio(o),m=this.configuration.innerRadius*u,v=this.configuration.outerRadius*u,f=o.getCurrentImageId(),I=d.filter(e=>e.data.annotationType===w.USPleuraBLineAnnotationType.PLEURA&&e.metadata.referencedImageId===f).map(e=>{const t=e.data.handles.points.map(e=>o.worldToCanvas(e));return(0,p.R3)(g,t)}),C=(0,p.l7)(I),T=[],b=[],A=e=>{const{annotationUID:i,data:a}=e,{points:s,activeHandleIndex:d}=a.handles;c.annotationUID=i;const{color:u,lineWidth:f,lineDash:E,shadow:I}=this.getAnnotationStyle({annotation:e,styleSpecifier:c}),A=s.map(e=>o.worldToCanvas(e));if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let _;if(!(0,l.isAnnotationVisible)(i))return;if((0,r.isAnnotationLocked)(i)||this.editData||null===d||(_=[A[d]]),_){const n="0";(0,h.drawHandles)(t,i,n,A,{color:this.getColorForLineType(e),fill:this.getColorForLineType(e),lineDash:E,lineWidth:f})}const S=`${i}-line`;if((0,h.drawLine)(t,i,"1",A[0],A[1],{color:this.getColorForLineType(e),width:f,lineDash:E,shadow:I},S),this.configuration.showFanAnnotations){const n=(0,p.R3)(g,A);let o=0;if(e.data.annotationType===w.USPleuraBLineAnnotationType.BLINE){(0,p.V0)(b,n).forEach(n=>{(0,p.IM)(n,C).forEach(n=>{o++;const a=`${i}-fan-${o}`,s=`2-${o}`;(0,h.drawFan)(t,i,s,g,m,v,n[0],n[1],{color:"transparent",fill:this.getColorForLineType(e),fillOpacity:this.configuration.fanOpacity,width:f,lineDash:E,shadow:I},a,10),b.push(n)})})}else if(e.data.annotationType===w.USPleuraBLineAnnotationType.PLEURA){(0,p.V0)(T,n).forEach((n,a)=>{o++;const s=`${i}-fan-${o}`,r=`2-${o}`;(0,h.drawFan)(t,i,r,g,m,v,n[0],n[1],{color:"transparent",fill:this.getColorForLineType(e),fillOpacity:this.configuration.fanOpacity,width:f,lineDash:E,shadow:I},s,5),T.push(n)})}}};d.filter(e=>e.data.annotationType===w.USPleuraBLineAnnotationType.PLEURA&&e.metadata.referencedImageId===f).forEach(e=>{if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;A(e)});return d.filter(e=>e.data.annotationType===w.USPleuraBLineAnnotationType.BLINE&&e.metadata.referencedImageId===f).forEach(e=>{if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;A(e)}),n=!0,this.configuration.updatePercentageCallback&&o&&this.configuration.updatePercentageCallback(this.calculateBLinePleuraPercentage(o)),n},this.activeAnnotationType=w.USPleuraBLineAnnotationType.BLINE}static filterAnnotations(e,t=()=>!0){const n=(0,s.getAnnotations)(w.toolName,e);if(!n?.length)return[];return n.filter(e=>{const n=e.metadata.referencedImageId;return t(n)})}static countAnnotations(e,t=()=>!0){const n=(0,s.getAnnotations)(w.toolName,e),{viewport:o}=(0,i.getEnabledElement)(e),a=o.getImageIds(),r=e=>{const t=a.findIndex(t=>t===e);return-1===t?0:t};if(!n?.length)return;const l=new Map;return n.forEach(e=>{const n=e.metadata.referencedImageId;if(!t(n))return;const{annotationType:o}=e.data;let i;i=l.has(n)?l.get(n):{frame:r(n),bLine:0,pleura:0},o===w.USPleuraBLineAnnotationType.PLEURA?i.pleura++:o===w.USPleuraBLineAnnotationType.BLINE&&i.bLine++,l.set(n,i)}),l}static deleteAnnotations(e,t=()=>!1){const n=(0,s.getAnnotations)(w.toolName,e);n?.length&&n.forEach(e=>{t(e.metadata.referencedImageId)&&(0,s.removeAnnotation)(e.annotationUID)})}setActiveAnnotationType(e){this.activeAnnotationType=e}getActiveAnnotationType(){return this.activeAnnotationType}deleteLastAnnotationType(e,t){let n;const o=(0,s.getAnnotations)(w.toolName,e);if(t===w.USPleuraBLineAnnotationType.PLEURA?n=o.filter(e=>e.data.annotationType===w.USPleuraBLineAnnotationType.PLEURA):t===w.USPleuraBLineAnnotationType.BLINE&&(n=o.filter(e=>e.data.annotationType===w.USPleuraBLineAnnotationType.BLINE)),n?.length>0){const e=n.pop();(0,s.removeAnnotation)(e.annotationUID)}}static{this.hydrate=(e,t,n)=>{const o=(0,i.getEnabledElementByViewportId)(e);if(!o)return;const{FrameOfReferenceUID:a,referencedImageId:r,viewPlaneNormal:l,instance:d,viewport:c}=this.hydrateBase(w,o,t,n),{toolInstance:h,...g}=n||{},u={annotationUID:n?.annotationUID||i.utilities.uuidv4(),data:{handles:{points:t}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:d.getToolName(),viewPlaneNormal:l,FrameOfReferenceUID:a,referencedImageId:r,...g}};(0,s.addAnnotation)(u,c.element),(0,m.A)([c.id])}}handleSelectedCallback(e,t,n){const o=e.detail,{element:i}=o,{data:a}=t;t.highlighted=!0;let s,r=!1;n.worldPosition?r=!0:s=a.handles.points.findIndex(e=>e===n);const l=(0,u.getViewportIdsWithToolToRender)(i,this.getToolName());this.editData={annotation:t,viewportIdsToRender:l,handleIndex:s,movingTextBox:r},this._activateModify(i),(0,v.hideElementCursor)(i),(0,m.A)(l),e.preventDefault()}isInsideFanShape(e,t){if(!this.getFanShapeGeometryParameters(e))return!1;const{imageData:n}=e.getImageData()||{};if(n){const o=e.worldToCanvas(n.indexToWorld(this.configuration.center)),i=e.worldToCanvas(t),a=(0,p.xA)(o,i);return a>=this.configuration.startAngle&&a<=this.configuration.endAngle}}updateFanGeometryConfiguration(e){e&&(this.isFanShapeGeometryParametersValid(e)&&(this.configuration.center=[e.center[0],e.center[1],0]),this.configuration.innerRadius=e.innerRadius,this.configuration.outerRadius=e.outerRadius,this.configuration.startAngle=e.startAngle,this.configuration.endAngle=e.endAngle)}deriveFanGeometryFromViewport(e){const t=e.getCurrentImageId(),{fanGeometry:n}=(0,f.calculateFanGeometry)(t)||{};n&&this.updateFanGeometryConfiguration(n)}isFanShapeGeometryParametersValid(e){return e||(e=this.configuration),e?.center&&e?.innerRadius>0&&e?.outerRadius&&e?.startAngle>0&&e?.startAngle<360&&e?.endAngle>0&&e?.endAngle<360}getFanShapeGeometryParameters(e){if(this.isFanShapeGeometryParametersValid())return!0;if(!this.isFanShapeGeometryParametersValid()){const t=e.getCurrentImageId(),n=i.metaData.get("ultrasoundFanShapeGeometry",t);this.updateFanGeometryConfiguration(n)}return this.isFanShapeGeometryParametersValid()||this.deriveFanGeometryFromViewport(e),this.isFanShapeGeometryParametersValid()}calculateBLinePleuraPercentage(e){if(!this.getFanShapeGeometryParameters(e))return;const{imageData:t}=e.getImageData()||{};if(!t)return;const{element:n}=e,o=e.worldToCanvas(t.indexToWorld(this.configuration.center)),i=e.getCurrentImageId(),a=(0,s.getAnnotations)(this.getToolName(),n)||[],r=a.filter(e=>e.data.annotationType===w.USPleuraBLineAnnotationType.PLEURA&&e.metadata.referencedImageId===i).map(t=>t.data.handles.points.map(t=>e.worldToCanvas(t))),l=a.filter(e=>e.data.annotationType===w.USPleuraBLineAnnotationType.BLINE&&e.metadata.referencedImageId===i).map(t=>t.data.handles.points.map(t=>e.worldToCanvas(t)));return(0,p.Mo)(o,r,l)}getColorForLineType(e){const{annotationType:t}=e.data,{bLineColor:n,pleuraColor:o}=this.configuration;return t===w.USPleuraBLineAnnotationType.BLINE?n:t===w.USPleuraBLineAnnotationType.PLEURA?o:n}getIndexToCanvasRatio(e){const{imageData:t}=e.getImageData()||{},n=e.worldToCanvas(t.indexToWorld([1,0,0])),o=e.worldToCanvas(t.indexToWorld([2,0,0])),i=[o[0]-n[0],o[1]-n[1]];return Math.sqrt(i[0]*i[0]+i[1]*i[1])}drawDepthGuide(e,t){if(!this.getFanShapeGeometryParameters(t))return;const{imageData:n}=t.getImageData()||{};if(!n)return;const o=e=>180*e/Math.PI,i=e=>e*Math.PI/180,a=e=>t.worldToCanvas(E(n,e)),s=this.configuration.innerRadius+this.configuration.depth_ratio*(this.configuration.outerRadius-this.configuration.innerRadius),r=this.configuration.startAngle,l=this.configuration.endAngle-r,d=i(l)*s;let c=Math.round(d/(this.configuration.depthGuideDashLength+this.configuration.depthGuideDashGap));c<=0&&(c=Math.max(15,Math.round(l/5)));const g=l/c;for(let n=0;n<c;n++){const l=i(r+n*g),d=i(r+n*g+o(this.configuration.depthGuideDashLength)/s),c=[this.configuration.center[0]+s*Math.cos(l),this.configuration.center[1]+s*Math.sin(l),0],u=[this.configuration.center[0]+s*Math.cos(d),this.configuration.center[1]+s*Math.sin(d),0];(0,h.drawLine)(e,t.id,`depthGuide-${n}`,a(c),a(u),{color:this.configuration.depthGuideColor,lineWidth:this.configuration.depthGuideThickness,strokeOpacity:this.configuration.depthGuideOpacity})}}_isInsideVolume(e,t,n){return i.utilities.indexWithinDimensions(e,n)&&i.utilities.indexWithinDimensions(t,n)}}function I(e,t){return[""]}const C=w},18526:(e,t,n)=>{"use strict";function o(e,t,n,o,i){const a=function(e,t=7){if(!e.length)throw new Error("Convex hull is empty");const n=e.length,o=e=>(e+1)%n,i=(e,t)=>{const n=[];for(let i=e;n.push(i),i!==t;i=o(i));return n};let a=0,s=0;for(let t=1;t<n;t++)e[t][0]<e[a][0]&&(a=t),e[t][0]>e[s][0]&&(s=t);const r=e[a],l=e[s],d=i(a,s),c=i(s,a),h=Math.min(...e.map(e=>e[1])),g=d.some(t=>e[t][1]===h)?d:c,u=Math.min(...g.map(t=>e[t][1]));let m=g.map(t=>e[t]).filter(e=>Math.abs(e[1]-u)<=t);return m.length<2&&(m=g.map(t=>e[t]).sort((e,t)=>e[1]-t[1]).slice(0,2)),{P1:m.reduce((e,t)=>t[0]<e[0]?t:e,m[0]),P2:r,P3:l,P4:m.reduce((e,t)=>t[0]>e[0]?t:e,m[0])}}(o),s=function(e,t,n,o,i,a={}){const{maxDist:s=15,slack:r=2}=a,l={dx:-1,dy:-1},d={dx:-1,dy:1},c={dx:1,dy:1},h={dx:1,dy:-1};function g(o,{dx:a,dy:l},d=5){const c=a<0?o[0]-s:o[0]-r,h=a<0?o[0]+r:o[0]+s,g=l<0?o[1]-s:o[1]-r,u=l<0?o[1]+r:o[1]+s;let m=o;for(const[o,s]of i){if(o<c||o>h||s<g||s>u)continue;const i=Math.round(o),r=Math.round(s);if(i<0||i>=t||r<0||r>=n)continue;const v=(i-m[0])*a,p=(r-m[0])*l;e[r*t+i]>d&&(v>0||p>0)&&(m=[o,s])}return m}return{P1:g(o.P1,l),P2:g(o.P2,d),P3:g(o.P3,c),P4:g(o.P4,h)}}(e,t,n,a,i,{maxDist:20,step:.5});return s}n.d(t,{tu:()=>o})},89256:(e,t,n)=>{"use strict";n.d(t,{B:()=>a});var o=n(93258);function i(e,t){return Math.atan2(t[1]-e[1],t[0]-e[0])}function a(e){const{P1:t,P2:n,P3:a,P4:s}=e,r=(0,o.intersectLine)(t,n,s,a,!0);if(!r)throw new Error("Fan edges appear parallel  no apex found");const l=r;let d=i(l,t)*(180/Math.PI),c=i(l,s)*(180/Math.PI);if(c<=d){const e=d;d=c,c=e}const h=Math.hypot(t[0]-l[0],t[1]-l[1]),g=Math.hypot(s[0]-l[0],s[1]-l[1]),u=Math.hypot(n[0]-l[0],n[1]-l[1]),m=Math.hypot(a[0]-l[0],a[1]-l[1]);return{center:l,startAngle:d,endAngle:c,innerRadius:Math.min(h,g),outerRadius:Math.max(u,m)}}},58180:(e,t,n)=>{"use strict";n.r(t),n.d(t,{calculateFanGeometry:()=>g,default:()=>c,downloadFanJpeg:()=>h,exportContourJpeg:()=>l,getPixelData:()=>d});var o=n(15327),i=n(7033),a=n(4035),s=n(18526),r=n(89256);function l(e,t,n,o,i={}){const{strokeStyle:a="#f00",lineWidth:s=2,quality:r=.92}=i,l=document.createElement("canvas");l.width=t,l.height=n;const d=l.getContext("2d"),c=t*n,h=e.length/c,g=d.createImageData(t,n),u=g.data;for(let t=0;t<c;t++){const n=t*h,o=4*t;if(1===h){const t=e[n];u[o]=t,u[o+1]=t,u[o+2]=t,u[o+3]=255}else u[o]=e[n],u[o+1]=e[n+1],u[o+2]=e[n+2],u[o+3]=4===h?e[n+3]:255}if(d.putImageData(g,0,0),o.length>0){d.strokeStyle=a,d.lineWidth=s,d.beginPath(),d.moveTo(o[0][0]+.5,o[0][1]+.5);for(let e=1;e<o.length;e++)d.lineTo(o[e][0]+.5,o[e][1]+.5);d.closePath(),d.stroke()}return l.toDataURL("image/jpeg",r)}function d(e){const t=o.cache.getImage(e);if(!t)return;const n=t.width,i=t.height;return{pixelData:t.getPixelData(),width:n,height:i}}function c(e,t){const n=document.createElement("a");n.href=e,n.download=t,document.body.appendChild(n),n.style.display="none",n.click(),n.remove()}function h(e,t=5){const{contour:n,simplified:o,hull:i,refined:a,fanGeometry:s}=g(e),{pixelData:r,width:h,height:u}=d(e)||{};if(!r)return;let m;m=1===t?l(r,h,u,n):2===t?l(r,h,u,o):3===t?l(r,h,u,i):4===t?l(r,h,u,[a.P1,a.P2,a.P3,a.P4]):function(e,t,n,o,i={}){const{center:a,startAngle:s,endAngle:r,innerRadius:l,outerRadius:d}=o,{strokeStyle:c="#0ff",lineWidth:h=2,quality:g=.92}=i,u=s*Math.PI/180,m=r*Math.PI/180,v=document.createElement("canvas");v.width=t,v.height=n;const p=v.getContext("2d"),f=t*n,E=e.length/f,w=p.createImageData(t,n),I=w.data;for(let t=0;t<f;t++){const n=4*t;if(1===E){const o=e[t];I[n]=o,I[n+1]=o,I[n+2]=o,I[n+3]=255}else{const o=t*E;I[n]=e[o],I[n+1]=e[o+1],I[n+2]=e[o+2],I[n+3]=4===E?e[o+3]:255}}p.putImageData(w,0,0),p.beginPath();for(let e=u;e<=m;e+=.01){const t=a[0]+l*Math.cos(e),n=a[1]+l*Math.sin(e);e===u?p.moveTo(t,n):p.lineTo(t,n)}for(let e=m;e>=u;e-=.01){const t=a[0]+d*Math.cos(e),n=a[1]+d*Math.sin(e);p.lineTo(t,n)}return p.closePath(),p.strokeStyle=c,p.lineWidth=h,p.stroke(),v.toDataURL("image/jpeg",g)}(r,h,u,s,{strokeStyle:"#f00",lineWidth:3,quality:.95}),c(m,"contour.jpg")}function g(e){const{pixelData:t,width:n,height:o}=d(e)||{};if(!t)return;const l=(0,i.o)(t,n,o),{simplified:c,hull:h}=(0,a.e)(l),g=(0,s.tu)(t,n,o,h,c);return{contour:l,simplified:c,hull:h,refined:g,fanGeometry:(0,r.B)({P1:g.P1,P2:g.P2,P3:g.P3,P4:g.P4})}}},4035:(e,t,n)=>{"use strict";n.d(t,{e:()=>i});var o=n(4667);function i(e){const t=o.utilities.math.polyline.decimate(e,2);return{simplified:t,hull:o.utilities.math.polyline.convexHull(t)}}},7033:(e,t,n)=>{"use strict";n.d(t,{o:()=>i});var o=n(93759);function i(e,t,n){const i=t*n,a=e.length/i;if(![1,3,4].includes(a))throw new Error("Buffer must be 1, 3, or 4 channels per pixel");const s=Array.from({length:n},()=>new Array(t).fill(!1));for(let o=0;o<n;o++)for(let n=0;n<t;n++){const i=(o*t+n)*a;let r=!1;for(let t=0;t<Math.min(3,a);t++)if(e[i+t]>0){r=!0;break}s[o][n]=r}const r=Array.from({length:n},()=>new Array(t).fill(0));let l=0;const d={};for(let e=0;e<n;e++)for(let i=0;i<t;i++)if(s[e][i]&&0===r[e][i]){l++;const a=(e,o)=>!(e<0||e>=t||o<0||o>=n)&&(s[o][e]&&0===r[o][e]);let c=0;const h={onFlood:(e,t)=>{r[t][e]=l,c++},diagonals:!1};(0,o.floodFill)(a,[i,e],h),d[l]=c}if(0===l)return[];const c=Object.keys(d).reduce((e,t)=>d[e]>d[t]?e:t);function h(e,o){if(r[o][e]!==+c)return!1;for(const[i,a]of[[1,0],[-1,0],[0,1],[0,-1]]){const s=e+i,l=o+a;if(s<0||s>=t||l<0||l>=n||r[l][s]!==+c)return!0}return!1}let g=null;e:for(let e=0;e<n;e++)for(let n=0;n<t;n++)if(h(n,e)){g=[n,e];break e}if(!g)return[];const u=[[1,0],[1,1],[0,1],[-1,1],[-1,0],[-1,-1],[0,-1],[1,-1]],m=[];let v=g,p=[g[0]-1,g[1]];do{m.push([v[0],v[1]]);const e=p[0]-v[0],o=p[1]-v[1];let i=u.findIndex(t=>t[0]===e&&t[1]===o);i<0&&(i=0);let a=null;for(let e=1;e<=8;e++){const[o,s]=u[(i+e)%8],r=v[0]+o,l=v[1]+s;if(r>=0&&r<t&&l>=0&&l<n&&h(r,l)){a=[r,l];const[t,n]=u[(i+e-1+8)%8];p=[v[0]+t,v[1]+n];break}}if(!a)break;v=a}while(v[0]!==g[0]||v[1]!==g[1]);return m}},11811:(e,t,n)=>{"use strict";n.d(t,{A:()=>f});var o=n(3823),i=n(15327),a=n(85817),s=n(27730),r=n(6802),l=n(74347),d=n(85204),c=n(99737),h=n(60810),g=n(33657),u=n(7001),m=n(58640),v=n(62514);class p extends a.EC{static{this.toolName="VideoRedaction"}constructor(e={}){super(e,{supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:o}=t,a=n.world,s=(0,i.getEnabledElement)(o),{viewport:l}=s;this.isDrawing=!0;const d=this.constructor.createAnnotationForViewport(l,{data:{handles:{points:[[...a],[...a],[...a],[...a]]}}});(0,r.lC)(d,o);const c=(0,h.getViewportIdsWithToolToRender)(o,this.getToolName(),!1);return this.editData={annotation:d,viewportUIDsToRender:c,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(o),(0,u.hideElementCursor)(o),e.preventDefault(),(0,m.A)(c),d},this.getHandleNearImagePoint=(e,t,n,a)=>{const s=(0,i.getEnabledElement)(e),{viewport:r}=s,{data:l}=t,{points:d}=l.handles;for(let e=0;e<d.length;e++){const t=d[e],i=r.worldToCanvas(t);if(!0===o.Zc.distance(n,i)<a)return l.handles.activeHandleIndex=e,t}l.handles.activeHandleIndex=null},this.isPointNearTool=(e,t,n,o)=>{const a=(0,i.getEnabledElement)(e),{viewport:s}=a,{data:r}=t,{points:l}=r.handles,d=s.worldToCanvas(l[0]),c=s.worldToCanvas(l[3]),h=this._getRectangleImageCoordinates([d,c]),u=[n[0],n[1]],{left:m,top:v,width:p,height:f}=h;if(g.distanceToPoint([m,v,p,f],u)<=o)return!0},this.toolSelectedCallback=(e,t,n="mouse")=>{const o=e.detail,{element:i}=o,{data:a}=t;a.active=!0;const s=(0,h.getViewportIdsWithToolToRender)(i,this.getToolName(),!1);this.editData={annotation:t,viewportUIDsToRender:s},this._activateModify(i),(0,u.hideElementCursor)(i),(0,m.A)(s),e.preventDefault()},this.handleSelectedCallback=(e,t,n,o="mouse")=>{const i=e.detail,{element:a}=i,{data:s}=t;s.active=!0;let r,l=!1;n.worldPosition?l=!0:r=s.handles.points.findIndex(e=>e===n);const d=(0,h.getViewportIdsWithToolToRender)(a,this.getToolName(),!1);this.editData={annotation:t,viewportUIDsToRender:d,handleIndex:r},this._activateModify(a),(0,u.hideElementCursor)(a),(0,m.A)(d),e.preventDefault()},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:o,viewportUIDsToRender:i,newAnnotation:a,hasMoved:s}=this.editData,{data:l}=o;a&&!s||(this.doneEditMemo(),l.active=!1,l.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,u.resetElementCursor)(n),this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,r.O8)(o.annotationUID),(0,m.A)(i))},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:o,viewportUIDsToRender:a,handleIndex:s,newAnnotation:r}=this.editData;this.createMemo(n,o,{newAnnotation:r});const{data:l}=o;if(void 0===s){const{deltaPoints:e}=t,n=e.world,{points:o}=l.handles;o.forEach(e=>{e[0]+=n[0],e[1]+=n[1],e[2]+=n[2]}),l.invalidated=!0}else{const{currentPoints:e}=t,o=(0,i.getEnabledElement)(n),{worldToCanvas:a,canvasToWorld:r}=o.viewport,d=e.world,{points:c}=l.handles;let h,g,u,m,v,p,f,E;switch(c[s]=[...d],s){case 0:case 3:h=a(c[0]),m=a(c[3]),g=[m[0],h[1]],u=[h[0],m[1]],p=r(g),f=r(u),c[1]=p,c[2]=f;break;case 1:case 2:g=a(c[1]),u=a(c[2]),h=[u[0],g[1]],m=[g[0],u[1]],v=r(h),E=r(m),c[0]=v,c[3]=E}l.invalidated=!0}this.editData.hasMoved=!0;(0,i.getEnabledElement)(n);(0,m.A)(a)},this._activateDraw=e=>{d.wk.isInteractingWithTool=!0,e.addEventListener(c.Events.MOUSE_UP,this._endCallback),e.addEventListener(c.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(c.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(c.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(c.Events.TOUCH_END,this._endCallback),e.addEventListener(c.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{d.wk.isInteractingWithTool=!1,e.removeEventListener(c.Events.MOUSE_UP,this._endCallback),e.removeEventListener(c.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(c.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(c.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(c.Events.TOUCH_END,this._endCallback),e.removeEventListener(c.Events.TOUCH_DRAG,this._dragCallback)},this._activateModify=e=>{d.wk.isInteractingWithTool=!0,e.addEventListener(c.Events.MOUSE_UP,this._endCallback),e.addEventListener(c.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(c.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(c.Events.TOUCH_END,this._endCallback),e.addEventListener(c.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateModify=e=>{d.wk.isInteractingWithTool=!1,e.removeEventListener(c.Events.MOUSE_UP,this._endCallback),e.removeEventListener(c.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(c.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(c.Events.TOUCH_END,this._endCallback),e.removeEventListener(c.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{const n=!1,{viewport:o}=e,{element:i}=o;let a=(0,r.Rh)(this.getToolName(),i);if(!a?.length)return n;if(a=this.filterInteractableAnnotationsForElement(i,a),!a?.length)return n;const s={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<a.length;e++){const n=a[e],{annotationUID:i}=n,r=n.data,{points:d,activeHandleIndex:c}=r.handles,h=d.map(e=>o.worldToCanvas(e)),g=this.getStyle("lineWidth",s,n),u=this.getStyle("lineDash",s,n),m=this.getStyle("color",s,n);if(!o.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");let v;if(this.editData||null===c||(v=[h[c]]),v){const e="0";(0,l.drawHandles)(t,i,e,v,{color:m})}const p="0";(0,l.drawRedactionRect)(t,i,p,h[0],h[3],{color:"black",lineDash:u,lineWidth:g})}},this._getRectangleImageCoordinates=e=>{const[t,n]=e;return{left:Math.min(t[0],n[0]),top:Math.min(t[1],n[1]),width:Math.abs(t[0]-n[0]),height:Math.abs(t[1]-n[1])}},this._calculateCachedStats=(e,t,n,a,s)=>{const{data:r}=e,{viewportUID:l,renderingEngineUID:d,sceneUID:h}=s,g=r.handles.points[0],u=r.handles.points[3],{cachedStats:m}=r,p=Object.keys(m);for(let e=0;e<p.length;e++){const i=p[e],{imageVolume:s}=this._getImageVolumeFromTargetUID(i,a),{dimensions:r,scalarData:l,vtkImageData:d,metadata:c}=s,h=o.eR.fromValues(0,0,0),f=o.eR.fromValues(0,0,0);if(d.worldToIndexVec3(g,h),h[0]=Math.floor(h[0]),h[1]=Math.floor(h[1]),h[2]=Math.floor(h[2]),d.worldToIndexVec3(u,f),f[0]=Math.floor(f[0]),f[1]=Math.floor(f[1]),f[2]=Math.floor(f[2]),this._isInsideVolume(h,f,r)){this.isHandleOutsideImage=!1;const e=Math.min(h[0],f[0]),o=Math.max(h[0],f[0]),a=Math.min(h[1],f[1]),s=Math.max(h[1],f[1]),d=Math.min(h[2],f[2]),p=Math.max(h[2],f[2]),{worldWidth:E,worldHeight:w}=(0,v.A)(t,n,g,u),I=E*w;let C=0,T=0,b=0;const A=r[0],_=r[0]*r[1];for(let t=d;t<=p;t++)for(let n=a;n<=s;n++)for(let i=e;i<=o;i++){C++,T+=l[t*_+n*A+i]}T/=C;for(let t=d;t<=p;t++)for(let n=a;n<=s;n++)for(let i=e;i<=o;i++){const e=l[t*_+n*A+i]-T;b+=e*e}b/=C,b=Math.sqrt(b),m[i]={Modality:c.Modality,area:I,mean:T,stdDev:b}}else this.isHandleOutsideImage=!0,m[i]={Modality:c.Modality}}const f=e.invalidated;if(e.invalidated=!1,f){const t=c.Events.ANNOTATION_MODIFIED,n={annotation:e,viewportUID:l,renderingEngineUID:d,sceneUID:h,changeType:c.ChangeTypes.StatsUpdated};(0,i.triggerEvent)(i.eventTarget,t,n)}return m},this._isInsideVolume=(e,t,n)=>i.utilities.indexWithinDimensions(e,n)&&i.utilities.indexWithinDimensions(t,n),this._getTargetVolumeUID=e=>{if(this.configuration.volumeUID)return this.configuration.volumeUID;const t=e.getVolumeActors();return t||t.length?t[0].uid:void 0},this._throttledCalculateCachedStats=(0,s.A)(this._calculateCachedStats,100,{trailing:!0})}cancel(e){if(!this.isDrawing)return;this.isDrawing=!1,this._deactivateDraw(e),this._deactivateModify(e),(0,u.resetElementCursor)(e);const{annotation:t,viewportUIDsToRender:n}=this.editData,{data:o}=t;return o.active=!1,o.handles.activeHandleIndex=null,(0,m.A)(n),this.editData=null,t.metadata.annotationUID}_getImageVolumeFromTargetUID(e,t){let n;if(e.startsWith("stackTarget")){const o=e.indexOf(":"),i=e.substring(o+1);n=t.getViewport(i).getImageData()}else n=i.cache.getVolume(e);return{imageVolume:n,viewport:undefined}}_getTargetStackUID(e){return`stackTarget:${e.uid}`}}const f=p},31787:(e,t,n)=>{"use strict";n.d(t,{A:()=>f});var o=n(3823),i=n(15327),a=n(74347),s=n(7001),r=n(99737),l=n(58640),d=n(93759),c=n(10639);const h=[-1/0,-995],g=[0,1900],u=[1e3,1900],{transformWorldToIndex:m,transformIndexToWorld:v}=i.utilities;class p extends c.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{isPartialVolume:!0,positivePixelRange:g,negativePixelRange:h,islandRemoval:{enabled:!0,islandPixelRange:u}}}){super(e,t),this._dragCallback=e=>{const t=e.detail,{element:n,currentPoints:o}=t,{world:a}=o,s=(0,i.getEnabledElement)(n),{viewport:r}=s,d=this._getHorizontalLineWorldPoints(s,a);this.growCutData.horizontalLines[1]=d,(0,l.A)([r.id])},this._endCallback=async e=>{const t=e.detail,{element:n}=t,o=(0,i.getEnabledElement)(n),{viewport:a}=o;await this.runGrowCut(),this._deactivateDraw(n),this.growCutData=null,(0,s.resetElementCursor)(n),(0,l.A)([a.id])},this._deactivateDraw=e=>{e.removeEventListener(r.Events.MOUSE_UP,this._endCallback),e.removeEventListener(r.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(r.Events.MOUSE_CLICK,this._endCallback)}}async preMouseDownCallback(e){const t=e.detail,{element:n,currentPoints:o}=t,{world:a}=o,r=(0,i.getEnabledElement)(n),{viewport:d,renderingEngine:c}=r,h=this._getHorizontalLineWorldPoints(r,a);return await super.preMouseDownCallback(e),this.growCutData.horizontalLines=[h,h],this._activateDraw(n),(0,s.hideElementCursor)(n),(0,l.A)([d.id]),!0}renderAnnotation(e,t){if(!this.growCutData)return;const{segmentation:n,horizontalLines:o}=this.growCutData;if(2!==o.length)return;const{viewport:i}=e,{segmentationId:s,segmentIndex:r}=n,[l,d]=o,[c,h]=l,[g,u]=d,m=[c,h,u,g].map(e=>i.worldToCanvas(e)),{color:v,fillColor:p,lineWidth:f,fillOpacity:E,lineDash:w}=this.getSegmentStyle({segmentationId:s,segmentIndex:r,viewportId:i.id});(0,a.drawPolyline)(t,"growCutRect","0",m,{color:v,fillColor:p,fillOpacity:E,lineWidth:f,lineDash:w,closePath:!0})}async getGrowCutLabelmap(e){const{segmentation:{segmentIndex:t,referencedVolumeId:n},renderingEngineId:o,viewportId:a,horizontalLines:s}=e,r=(0,i.getRenderingEngine)(o).getViewport(a),[l,c]=s,h=[l[0],l[1],c[1],c[0]],g=i.cache.getVolume(n),{topLeft:u,bottomRight:v}=this._getWorldBoundingBoxFromProjectedSquare(r,h),p={boundingBox:{ijkTopLeft:m(g.imageData,u),ijkBottomRight:m(g.imageData,v)}},f=this.configuration,E={positiveSeedValue:t,negativeSeedValue:255,negativePixelRange:f.negativePixelRange,positivePixelRange:f.positivePixelRange};return d.growCut.runGrowCutForBoundingBox(n,p,E)}getRemoveIslandData(){const{segmentation:{segmentIndex:e,referencedVolumeId:t,labelmapVolumeId:n}}=this.growCutData,o=i.cache.getVolume(t),a=i.cache.getVolume(n),s=o.voxelManager.getCompleteScalarDataArray(),r=a.voxelManager.getCompleteScalarDataArray(),{islandPixelRange:l}=this.configuration.islandRemoval,d=[];for(let t=0,n=r.length;t<n;t++){if(r[t]!==e)continue;const n=s[t];n>=l[0]&&n<=l[1]&&d.push(t)}return{islandPointIndexes:d}}_activateDraw(e){e.addEventListener(r.Events.MOUSE_UP,this._endCallback),e.addEventListener(r.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(r.Events.MOUSE_CLICK,this._endCallback)}_projectWorldPointAcrossSlices(e,t,n){const o=this._getViewportVolume(e),{dimensions:a}=o,s=m(o.imageData,t),r=n.findIndex(e=>i.utilities.isEqual(Math.abs(e),1));if(-1===r)throw new Error("Non-orthogonal direction vector");const l=[...s],d=[...s];return l[r]=0,d[r]=a[r]-1,[l,d]}_getCuboidIJKEdgePointsFromProjectedWorldPoint(e,t){const{viewPlaneNormal:n}=e.getCamera();return this._projectWorldPointAcrossSlices(e,t,n)}_getWorldCuboidCornerPoints(e,t){const n=[],o=this._getViewportVolume(e);return t.forEach(t=>{const i=this._getCuboidIJKEdgePointsFromProjectedWorldPoint(e,t).map(e=>v(o.imageData,e));n.push(...i)}),n}_getWorldBoundingBoxFromProjectedSquare(e,t){const n=this._getWorldCuboidCornerPoints(e,t),i=[...n[0]],a=[...n[0]];return n.forEach(e=>{o.eR.min(i,i,e),o.eR.max(a,a,e)}),{topLeft:i,bottomRight:a}}_getViewportVolume(e){if(!(e instanceof i.BaseVolumeViewport))throw new Error("Viewport is not a BaseVolumeViewport");const t=e.getAllVolumeIds()[0];return i.cache.getVolume(t)}_getHorizontalLineIJKPoints(e,t){const{viewport:n}=e,a=this._getViewportVolume(n),{dimensions:s}=a,r=m(a.imageData,t),{viewUp:l,viewPlaneNormal:d}=n.getCamera(),c=o.eR.cross(o.eR.create(),l,d).findIndex(e=>i.utilities.isEqual(Math.abs(e),1)),h=[...r],g=[...r];return h[c]=0,g[c]=s[c]-1,[h,g]}_getHorizontalLineWorldPoints(e,t){const{viewport:n}=e,o=this._getViewportVolume(n),[i,a]=this._getHorizontalLineIJKPoints(e,t);return[v(o.imageData,i),v(o.imageData,a)]}}p.toolName="WholeBodySegment";const f=p},34115:(e,t,n)=>{"use strict";n.d(t,{A:()=>s,k:()=>s});var o=n(3823),i=n(57163);const a=o.pB.multiplyScalar(o.pB.create(),o.pB.fromValues(1,4,1,0,-3,0,3,0,3,-6,3,0,-1,3,-3,1),1/6);class s extends i.m{getTransformMatrix(){return a}}},71543:(e,t,n)=>{"use strict";n.d(t,{A:()=>i,h:()=>i});var o=n(57163);class i extends o.m{constructor(e){super(e),this._scale=e?.scale??.5,this._fixedScale=e?.fixedScale??!1}get scale(){return this._scale}set scale(e){this._fixedScale||this._scale===e||(this._scale=e,this.invalidated=!0)}get fixedScale(){return this._fixedScale}getTransformMatrix(){const{scale:e}=this,t=2*e;return[0,1,0,0,-e,0,e,0,t,e-3,3-t,-e,-e,2-e,e-2,e]}}},31147:(e,t,n)=>{"use strict";n.d(t,{A:()=>i,e:()=>i});var o=n(71543);class i extends o.A{constructor(){super({scale:.5,fixedScale:!0})}}},57163:(e,t,n)=>{"use strict";n.d(t,{A:()=>s,m:()=>s});var o=n(3823),i=n(56091),a=n(95527);class s extends i.e{getPreviewCurveSegments(e,t){const n=this._getNumCurveSegments()+1,o=Math.max(0,n-2),i=t?n:n-1,a=this.getTransformMatrix(),s=[...this.controlPoints],r=[];t||s.push(e);for(let e=o;e<=i;e++){const n=this._getCurveSegment(e,a,s,t);r.push(n)}return r}getSplineCurves(){const e=this._getNumCurveSegments(),t=new Array(e);if(e<=0)return[];const n=this.getTransformMatrix();let o=0;for(let i=0;i<e;i++){const e=this._getCurveSegment(i,n);e.previousCurveSegmentsLength=o,t[i]=e,o+=e.length}return t}_getNumCurveSegments(e=this.controlPoints,t=this.closed){return t?e.length:Math.max(0,e.length-1)}_getPoint(e,t,n=this.controlPoints,i=this.closed){const a=this._getNumCurveSegments(n,i),s=Math.floor(e);let r=s%a;const l=e-s;if(r<0||r>=a){if(!this.closed)return;r=(a+r)%a}const{p0:d,p1:c,p2:h,p3:g}=this._getCurveSegmentPoints(r,n,i),u=l*l,m=u*l,v=o.ln.fromValues(1,l,u,m),p=o.ln.transformMat4(o.ln.create(),v,t);return[o.ln.dot(p,o.ln.fromValues(d[0],c[0],h[0],g[0])),o.ln.dot(p,o.ln.fromValues(d[1],c[1],h[1],g[1]))]}_getCurveSegmentPoints(e,t=this.controlPoints,n=this.closed){const o=this._getNumCurveSegments(t,n),i=e-1,s=n?(e+1)%o:e+1,r=s+1,l=t[e],d=t[s];let c,h;return c=i>=0?t[i]:n?t[t.length-1]:a.point.mirror(d,l),h=r<t.length?t[r]:n?t[0]:a.point.mirror(l,d),{p0:c,p1:l,p2:d,p3:h}}_getLineSegments(e,t,n=this.controlPoints,o=this.closed){const i=this._getNumCurveSegments(n,o),a=this.resolution+1,s=1/a;let r=e+1;o||e!==i-1||(r-=1e-8);const l=[];let d,c,h=0;for(let i=0,g=e;i<=a;i++,g+=s){g=g>r?r:g;const e=this._getPoint(g,t,n,o);if(!i){d=e;continue}c=e;const a=c[0]-d[0],s=c[1]-d[1],u=Math.sqrt(a**2+s**2),m={minX:d[0]<=c[0]?d[0]:c[0],maxX:d[0]>=c[0]?d[0]:c[0],minY:d[1]<=c[1]?d[1]:c[1],maxY:d[1]>=c[1]?d[1]:c[1]};l.push({points:{start:d,end:c},aabb:m,length:u,previousLineSegmentsLength:h}),d=c,h+=u}return l}_getCurveSegment(e,t=this.getTransformMatrix(),n=this.controlPoints,o=this.closed){const{p0:i,p1:a,p2:s,p3:r}=this._getCurveSegmentPoints(e,n,o),l=this._getLineSegments(e,t,n,o);let d=0,c=1/0,h=1/0,g=-1/0,u=-1/0;return l.forEach(({aabb:e,length:t})=>{c=Math.min(c,e.minX),h=Math.min(h,e.minY),g=Math.max(g,e.maxX),u=Math.max(u,e.maxY),d+=t}),{controlPoints:{p0:i,p1:a,p2:s,p3:r},aabb:{minX:c,minY:h,maxX:g,maxY:u},length:d,previousCurveSegmentsLength:0,lineSegments:l}}}},63802:(e,t,n)=>{"use strict";n.d(t,{A:()=>i,F:()=>i});var o=n(71543);class i extends o.A{constructor(){super({resolution:0,fixedResolution:!0,scale:0,fixedScale:!0})}}},33941:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var o=n(711);const i=[1,0,0,-2,2,0,1,-2,1];class a extends o.s{hasTangentPoints(){return!0}getTransformMatrix(){return i}}},711:(e,t,n)=>{"use strict";n.d(t,{A:()=>i,s:()=>i});var o=n(56091);class i extends o.e{getSplineCurves(){return[]}getLineSegments(){return[]}getPreviewCurveSegments(e,t){return[]}}},56091:(e,t,n)=>{"use strict";n.d(t,{A:()=>i,e:()=>i});var o=n(95527);class i{constructor(e){this._controlPoints=[],this._invalidated=!1,this._length=0,this._controlPoints=[],this._resolution=e?.resolution??20,this._fixedResolution=e?.fixedResolution??!1,this._closed=e?.closed??!1,this._invalidated=!0}get controlPoints(){return this._controlPoints}get numControlPoints(){return this._controlPoints.length}get resolution(){return this._resolution}set resolution(e){this._fixedResolution||this._resolution===e||(this._resolution=e,this.invalidated=!0)}get fixedResolution(){return this._fixedResolution}get closed(){return this._closed}set closed(e){this._closed!==e&&(this._closed=e,this.invalidated=!0)}get aabb(){return this._update(),this._aabb}get length(){return this._update(),this._length}get invalidated(){return this._invalidated}set invalidated(e){this._invalidated=e}hasTangentPoints(){return!1}addControlPoint(e){this._controlPoints.push([e[0],e[1]]),this.invalidated=!0}addControlPoints(e){e.forEach(e=>this.addControlPoint(e))}addControlPointAtU(e){const t=this._getLineSegmentAt(e),{start:n,end:o}=t.points,i=Math.floor(e),a=this._curveSegments[i],s=e-Math.floor(i),r=[n[0]+s*(o[0]-n[0]),n[1]+s*(o[1]-n[1])],l=this._controlPoints.indexOf(a.controlPoints.p1)+1;return this._controlPoints.splice(l,0,r),this.invalidated=!0,{index:l,point:r}}deleteControlPointByIndex(e){const t=this._closed?3:1;return e>=0&&e<this._controlPoints.length&&this._controlPoints.length>t&&(this._controlPoints.splice(e,1),this.invalidated=!0,!0)}clearControlPoints(){this._controlPoints=[],this.invalidated=!0}setControlPoints(e){this.clearControlPoints(),this.addControlPoints(e)}updateControlPoint(e,t){if(e<0||e>=this._controlPoints.length)throw new Error("Index out of bounds");this._controlPoints[e]=[...t],this.invalidated=!0}getControlPoints(){return this._controlPoints.map(e=>[e[0],e[1]])}getClosestControlPoint(e){const t=this._controlPoints;let n=1/0,o=-1;for(let i=0,a=t.length;i<a;i++){const a=t[i],s=e[0]-a[0],r=e[1]-a[1],l=s*s+r*r;l<n&&(n=l,o=i)}return{index:o,point:-1===o?void 0:[...t[o]],distance:Math.sqrt(n)}}getClosestControlPointWithinDistance(e,t){const n=this.getClosestControlPoint(e);return n.distance<=t?n:void 0}getClosestPoint(e){this._update();const t=this._getCurveSegmmentsDistanceSquaredInfo(e);if(!t.length)return;let n;t.sort((e,t)=>e.distanceSquared-t.distanceSquared);let i,a,s=-1,r=1/0;for(let l=0;l<t.length;l++){const d=t[l];if(d.distanceSquared>r)continue;const{curveSegmentIndex:c,curveSegment:h}=d,{lineSegments:g}=h;for(let t=0;t<g.length;t++){const l=g[t],{point:h,distanceSquared:u}=o.lineSegment.distanceToPointSquaredInfo(l.points.start,l.points.end,e);u<r&&(a=l,s=c,i=d.curveSegment,n=h,r=u)}}return{point:n,uValue:s+(a.previousLineSegmentsLength+o.point.distanceToPoint(a.points.start,n))/i.length,distance:Math.sqrt(r)}}getClosestPointOnControlPointLines(e){const t=[...this._controlPoints];if(this._closed&&t.push(this._controlPoints[0]),!t.length)return;let n,i=1/0,a=t[0];for(let s=1,r=t.length;s<r;s++){const r=t[s],{point:l,distanceSquared:d}=o.lineSegment.distanceToPointSquaredInfo(a,r,e);d<i&&(n=l,i=d),a=r}return{point:n,distance:Math.sqrt(i)}}getPolylinePoints(){return this._update(),this._convertCurveSegmentsToPolyline(this._curveSegments)}getPreviewPolylinePoints(e,t){if(this._closed)return[];this._update();const n=this.getClosestControlPointWithinDistance(e,t),o=0===n?.index,i=this.getPreviewCurveSegments(e,o);return i?.length?this._convertCurveSegmentsToPolyline(i):[]}isPointNearCurve(e,t){this._update();const n=this._getCurveSegmmentsWithinDistance(e,t),i=t*t;for(let t=0;t<n.length;t++){const{lineSegments:a}=n[t];for(let t=0;t<a.length;t++){const n=a[t];if(o.lineSegment.distanceToPointSquared(n.points.start,n.points.end,e)<=i)return!0}}return!1}containsPoint(e){this._update();if(this._controlPoints.length<3)return!1;const t=[...this._curveSegments],n=this._getClosingCurveSegmentWithStraightLineSegment();n&&t.push(n);let o=0;for(let n=0;n<t.length;n++){const i=t[n],{aabb:a}=i;if(!(e[0]<=a.maxX&&e[1]>=a.minY&&e[1]<a.maxY))continue;const{lineSegments:s}=i;for(let t=0;t<s.length;t++){const n=s[t],{aabb:i}=n;if(e[0]<=i.maxX&&e[1]>=i.minY&&e[1]<i.maxY){const{start:t,end:i}=n.points,a=t[0]===i[0],s=(e[1]-t[1])*(i[0]-t[0])/(i[1]-t[1])+t[0];o+=a||e[0]<=s?1:0}}}return o%2==1}_update(){if(!this._invalidated)return;const e=this.getSplineCurves();let t=0,n=1/0,o=1/0,i=-1/0,a=-1/0;for(let s=0,r=e.length;s<r;s++){const{aabb:r,length:l}=e[s];n=n<=r.minX?n:r.minX,o=o<=r.minY?o:r.minY,i=i>=r.maxX?i:r.maxX,a=a>=r.maxY?a:r.maxY,t+=l}this._curveSegments=e,this._aabb={minX:n,minY:o,maxX:i,maxY:a},this._length=t,this._invalidated=!1}_convertCurveSegmentsToPolyline(e){this._update();const t=[];return e.forEach(({lineSegments:e},n)=>{e.forEach((e,o)=>{0===n&&0===o&&t.push([...e.points.start]),t.push([...e.points.end])})}),t}_getCurveSegmmentsDistanceSquaredInfo(e){this._update();const t=[],{_curveSegments:n}=this;for(let i=0;i<n.length;i++){const a=n[i],s=o.aabb.distanceToPointSquared(a.aabb,e);t.push({curveSegmentIndex:i,curveSegment:a,distanceSquared:s})}return t}_getCurveSegmmentsWithinDistance(e,t){this._update();const n=t*t;if(o.aabb.distanceToPointSquared(this.aabb,e)>n)return[];const i=this._getCurveSegmmentsDistanceSquaredInfo(e),a=[];for(let e=0,t=i.length;e<t;e++){const{curveSegment:t,distanceSquared:o}=i[e];o<=n&&a.push(t)}return a}_getLineSegmentAt(e){this._update();const t=Math.floor(e),n=e-t,o=this._curveSegments[t],{lineSegments:i}=o,a=o.length*n;for(let e=0;e<i.length;e++){const t=i[e],n=t.previousLineSegmentsLength+t.length;if(a>=t.previousLineSegmentsLength&&a<=n)return t}}_getClosingCurveSegmentWithStraightLineSegment(){if(this.closed)return;const e=this._controlPoints,t=e[0],n=e[e.length-1],o={points:{start:[...t],end:[...n]},aabb:{minX:Math.min(t[0],n[0]),minY:Math.min(t[1],n[1]),maxX:Math.max(t[0],n[0]),maxY:Math.max(t[1],n[1])}};return{aabb:{minX:o.aabb.minX,minY:o.aabb.minY,maxX:o.aabb.maxX,maxY:o.aabb.maxY},lineSegments:[o]}}}},3040:(e,t,n)=>{"use strict";n.r(t),n.d(t,{BSpline:()=>o.A,CardinalSpline:()=>i.h,CatmullRomSpline:()=>a.A,CubicSpline:()=>s.A,LinearSpline:()=>r.A,QuadraticBezier:()=>l.A,QuadraticSpline:()=>d.A,Spline:()=>c.A});var o=n(34115),i=n(71543),a=n(31147),s=n(57163),r=n(63802),l=n(33941),d=n(711),c=n(56091)},6030:(e,t,n)=>{"use strict";n.d(t,{A:()=>h});var o=n(15327),i=n(37234),a=n(82056),s=n(56069),r=n(94418),l=n(76712),d=n(49310);class c extends i.A{constructor(){super(...arguments),this.onImageSpacingCalibrated=e=>{const{element:t,imageId:n}=e.detail,i=o.utilities.imageIdToURI(n),r=(0,a.getAnnotationManager)();r.getFramesOfReference().forEach(e=>{const n=r.getAnnotations(e)[this.getToolName()];n&&n.length&&(n.forEach(e=>{if(!e.metadata?.referencedImageId)return;o.utilities.imageIdToURI(e.metadata.referencedImageId)===i&&(e.invalidated=!0,e.data.cachedStats={})}),(0,s.A)(t))})}}filterInteractableAnnotationsForElement(e,t){if(!t?.length)return[];const n=(0,o.getEnabledElement)(e),{viewport:i}=n;return(0,r.A)(i,t)}createAnnotation(e){const t=e.detail,{currentPoints:n,element:i}=t,{world:a}=n,s=(0,o.getEnabledElement)(i),{viewport:r}=s,l=r.getCamera(),{viewPlaneNormal:d,viewUp:c,position:h}=l,g=this.getReferencedImageId(r,a,d,c),u=r.getViewReference({points:[a]});return{highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),...u,referencedImageId:g,viewUp:c,cameraPosition:h},data:{cachedStats:{},handles:{points:[],activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}}}getReferencedImageId(e,t,n,i){const a=this.getTargetId(e);let s=a.split(/^[a-zA-Z]+:/)[1];if(e instanceof o.BaseVolumeViewport){const e=o.utilities.getVolumeId(a),i=o.cache.getVolume(e);s=o.utilities.getClosestImageId(i,t,n)}return s}getStyle(e,t,n){return(0,l.h)(e,t,(0,d.getState)(n),this.mode)}}c.toolName="AnnotationDisplayTool";const h=c},37234:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var o=n(15327),i=n(49892);const{DefaultHistoryMemo:a}=o.utilities.HistoryMemo;class s{static{this.defaults={configuration:{strategies:{},defaultStrategy:void 0,activeStrategy:void 0,strategyOptions:{}}}}constructor(e,t){const n=s.mergeDefaultProps(s.defaults,t),a=o.utilities.deepMerge(n,e),{configuration:r={},supportedInteractionTypes:l,toolGroupId:d}=a;this.toolGroupId=d,this.supportedInteractionTypes=l||[],this.configuration=Object.assign({},r),this.mode=i.A.Disabled}static mergeDefaultProps(e={},t){return t?o.utilities.deepMerge(e,t):e}get toolName(){return this.getToolName()}getToolName(){return this.constructor.toolName}applyActiveStrategy(e,t){const{strategies:n,activeStrategy:o}=this.configuration;return n[o]?.call(this,e,t)}applyActiveStrategyCallback(e,t,n,...o){const{strategies:i,activeStrategy:a}=this.configuration;if(!i[a])throw new Error(`applyActiveStrategyCallback: active strategy ${a} not found, check tool configuration or spellings`);return i[a][n]?.call(this,e,t,...o)}setConfiguration(e){this.configuration=o.utilities.deepMerge(this.configuration,e)}setActiveStrategy(e){this.setConfiguration({activeStrategy:e})}getTargetImageData(e){if(e.startsWith("imageId:")){const t=e.split("imageId:")[1],n=o.utilities.imageIdToURI(t);let i=o.utilities.getViewportsWithImageURI(n);if(!i||!i.length)return;if(i=i.filter(e=>e.getCurrentImageId()===t),!i||!i.length)return;return i[0].getImageData()}if(e.startsWith("volumeId:")){const t=o.utilities.getVolumeId(e),n=o.utilities.getViewportsWithVolumeId(t);if(!n||!n.length)return;return n[0].getImageData()}if(e.startsWith("videoId:")){const t=o.utilities.imageIdToURI(e),n=o.utilities.getViewportsWithImageURI(t);if(!n||!n.length)return;return n[0].getImageData()}throw new Error('getTargetIdImage: targetId must start with "imageId:" or "volumeId:"')}getTargetId(e){const t=e.getViewReferenceId?.();if(t)return t;throw new Error("getTargetId: viewport must have a getViewReferenceId method")}undo(){this.doneEditMemo(),a.undo()}redo(){a.redo()}static createZoomPanMemo(e){const t={pan:e.getPan(),zoom:e.getZoom()},n={restoreMemo:()=>{const n=e.getPan(),o=e.getZoom();e.setZoom(t.zoom),e.setPan(t.pan),e.render(),t.pan=n,t.zoom=o}};return a.push(n),n}doneEditMemo(){this.memo?.commitMemo?.()&&a.push(this.memo),this.memo=null}}s.toolName="BaseTool";const r=s},85817:(e,t,n)=>{"use strict";n.d(t,{EC:()=>i.A,oS:()=>o.A,wh:()=>a.A});var o=n(37234),i=n(91350),a=n(6030)},25894:(e,t,n)=>{"use strict";n.d(t,{A:()=>v});var o=n(15327),i=n(18682),a=n(22384),s=n(33283),r=n(87420),l=n(36625),d=n(27479),c=n(25758),h=n(82056),g=n(3823);const u=new Map,m=new Map;const v={render:async function(e,t){const{segmentationId:n}=t,r=(0,s.T)(n);if(!r)return;let v=r.representationData[i.A.Contour];const p=(0,l.Qy)();if(v||!(0,l.Qy)()?.canComputeRequestedRepresentation(n,i.A.Contour)||u.get(e.id)?v||(0,l.Qy)()||console.debug(`No contour data found for segmentationId ${n} and PolySeg add-on is not configured. Unable to convert from other representations to contour. Please register PolySeg using cornerstoneTools.init({ addons: { polySeg } }) to enable automatic conversion.`):(u.set(e.id,!0),v=await(0,d.d)(n,i.A.Contour,()=>p.computeContourData(n,{viewport:e}),()=>{}),u.set(e.id,!1)),!v)return;if(!v.geometryIds?.length)return;let f=!1;const E=e.getCamera().viewPlaneNormal;v.annotationUIDsMap&&(f=!function(e,t){const n=Array.from(e.values()).flat().map(e=>Array.from(e)).flat(),i=o.utilities.getRandomSampleFromArray(n,3);for(const e of i){const n=(0,h.getAnnotation)(e);if(n?.metadata){if(!n.metadata.viewPlaneNormal)continue;const e=n.metadata.viewPlaneNormal,o=Math.abs(t[0]*e[0]+t[1]*e[1]+t[2]*e[2]);if(Math.abs(o-1)>.01)return!1}}return!0}(v.annotationUIDsMap,E)),v.geometryIds.length>0&&(f=!function(e,t){let n=null,i=null;for(const t of e){const e=o.cache.getGeometry(t);if(!e)continue;const a=e.data;if(a.contours?.[0]?.points?.length>=3){n=e,i=a;break}}if(!n||!i)return!1;const a=i.contours[0].points,s=a[0],r=a[1],l=a[2];let d=g.eR.cross(g.eR.create(),g.eR.sub(g.eR.create(),r,s),g.eR.sub(g.eR.create(),l,s));d=g.eR.normalize(g.eR.create(),d);const c=g.eR.dot(d,t);return Math.abs(c)>.9}(v.geometryIds,E));const w=m.get(e.id)||new Set;if(f&&!u.get(e.id)&&!w.has(n)&&e.viewportStatus===o.Enums.ViewportStatus.RENDERED){u.set(e.id,!0);const t=(0,c.O)(n),i=(await p.computeSurfaceData(n,{segmentIndices:t,viewport:e})).geometryIds,a=[];for(const e of i.values()){const t=o.cache.getGeometry(e).data;a.push({points:t.points,polys:t.polys,segmentIndex:t.segmentIndex,id:t.segmentIndex})}const s=await p.clipAndCacheSurfacesForViewport(a,e),r=p.extractContourData(s),l=p.createAndAddContourSegmentationsFromClippedSurfaces(r,e,n);v.annotationUIDsMap=new Map([...v.annotationUIDsMap,...l]),w.add(n),m.set(e.id,w),u.set(e.id,!1)}(0,a.d)(e,v.geometryIds,v.annotationUIDsMap,t)},removeRepresentation:function(e,t,n=!1){const i=(0,o.getEnabledElementByViewportId)(e);if(!i)return;const{viewport:a}=i;(0,r.A)(e,t),n&&a.render()}}},684:(e,t,n)=>{"use strict";n.d(t,{Ay:()=>_});var o=n(15327),i=n(63597),a=n(88234),s=n(26228),r=n(50409),l=n(97577),d=n(33283),c=n(92686),h=n(18682),g=n(47098),u=n(60740),m=n(59452),v=n(36625),p=n(27479),f=n(49906),E=n(59475);const w=new Map;let I=!1;function C(e,t,n){const{segmentationId:o}=n,{cfun:i,ofun:a}=n.config,{colorLUTIndex:l}=n,d=(0,s.getActiveSegmentation)(e),m=d?.segmentationId===o,v=c.Y.getStyle({viewportId:e,type:h.A.Labelmap,segmentationId:o}),p=c.Y.getRenderInactiveSegmentations(e),f=(0,r.B)(l),E=Math.min(256,f.length),{outlineWidth:w,renderOutline:I,outlineOpacity:C,activeSegmentOutlineWidthDelta:A}=T(v,m),_=(0,g.s)(e,{segmentationId:o,type:h.A.Labelmap});for(let t=0;t<E;t++){const n=t,s=f[n],r=c.Y.getStyle({viewportId:e,type:h.A.Labelmap,segmentationId:o,segmentIndex:n}),{fillAlpha:l,outlineWidth:d,renderFill:g,renderOutline:u}=T(v,m,r),{forceOpacityUpdate:p,forceColorUpdate:E}=b(e,o,n,{fillAlpha:l,renderFill:g,renderOutline:u,segmentColor:s,outlineWidth:d,segmentsHidden:_,cfun:i,ofun:a});if(E&&i.addRGBPoint(n,s[0]/255,s[1]/255,s[2]/255),p)if(g){const e=_.has(n)?0:s[3]/255*l;a.removePoint(n),a.addPointLong(n,e,.5,1)}else a.addPointLong(n,.01,.5,1)}a.setClamping(!1);const S=t.actor,{preLoad:D}=S.get?.("preLoad")||{preLoad:null};if(D?D({cfun:i,ofun:a,actor:S}):(S.getProperty().setRGBTransferFunction(0,i),S.getProperty().setScalarOpacity(0,a),S.getProperty().setInterpolationTypeToNearest()),I){S.getProperty().setUseLabelOutline(I),S.getProperty().setLabelOutlineOpacity(C);const e=(0,u.Q)(n.segmentationId),t=new Array(E-1);for(let n=1;n<E;n++){_.has(n)?t[n-1]=0:t[n-1]=n===e?w+A:w}S.getProperty().setLabelOutlineThickness(t),S.modified(),S.getProperty().modified(),S.getMapper().modified()}else S.getProperty().setLabelOutlineThickness(new Array(E-1).fill(0));const y=m||p;S.setVisibility(y)}function T(e,t,n){const o={...e,...n||{}};return{fillAlpha:t?o.fillAlpha:o.fillAlphaInactive,outlineWidth:t?o.outlineWidth:o.outlineWidthInactive,renderFill:t?o.renderFill:o.renderFillInactive,renderOutline:t?o.renderOutline:o.renderOutlineInactive,outlineOpacity:t?o.outlineOpacity:o.outlineOpacityInactive,activeSegmentOutlineWidthDelta:o.activeSegmentOutlineWidthDelta}}function b(e,t,n,{fillAlpha:o,renderFill:i,renderOutline:a,segmentColor:s,outlineWidth:r,segmentsHidden:l,cfun:d,ofun:c}){const h=`${e}-${t}-${n}`,g=w.get(h);if(!g)return w.set(h,{fillAlpha:o,renderFill:i,renderOutline:a,outlineWidth:r,segmentColor:s.slice(),segmentsHidden:new Set(l),cfunMTime:d.getMTime(),ofunMTime:c.getMTime()}),{forceOpacityUpdate:!0,forceColorUpdate:!0};const{fillAlpha:u,renderFill:m,renderOutline:v,outlineWidth:p,segmentColor:f,segmentsHidden:E,cfunMTime:I,ofunMTime:C}=g,T=f[0]!==s[0]||f[1]!==s[1]||f[2]!==s[2],b=f[3]!==s[3]||u!==o||m!==i||v!==a||p!==r||E!==l;return(b||T)&&w.set(h,{fillAlpha:o,renderFill:i,renderOutline:a,outlineWidth:r,segmentColor:s.slice(),segmentsHidden:new Set(l),cfunMTime:d.getMTime(),ofunMTime:c.getMTime()}),{forceOpacityUpdate:b,forceColorUpdate:T}}async function A(e,t,n,o){return await(0,i.A)(e.element,t,n,o)||void 0}const _={render:async function(e,t){const{segmentationId:n,config:i}=t,a=(0,d.T)(n);if(!a)return void console.warn("No segmentation found for segmentationId: ",n);let s=a.representationData[h.A.Labelmap],r=(0,m.ED)(e.id,n);if(s||!(0,v.Qy)()?.canComputeRequestedRepresentation(n,h.A.Labelmap)||I)s||(0,v.Qy)()||console.debug(`No labelmap data found for segmentationId ${n} and PolySeg add-on is not configured. Unable to convert from other representations to labelmap. Please register PolySeg using cornerstoneTools.init({ addons: { polySeg } }) to enable automatic conversion.`);else{I=!0;const t=(0,v.Qy)();if(s=await(0,p.d)(n,h.A.Labelmap,()=>t.computeLabelmapData(n,{viewport:e}),()=>null,()=>{E._6.processLabelmapRepresentationAddition(e.id,n),setTimeout(()=>{(0,f.triggerSegmentationDataModified)(n)},0)}),!s)throw new Error(`No labelmap data found for segmentationId ${n}.`);I=!1}if(s){if(e instanceof o.VolumeViewport)r?.length||await A(e,s,n,i),r=(0,m.ED)(e.id,n);else{const t=(0,l.aF)(e.id,n);if(!t?.length)return;r||await A(e,s,n,i),r=(0,m.ED)(e.id,n)}if(r?.length)for(const n of r)C(e.id,n,t)}},removeRepresentation:function(e,t,n=!1){const i=(0,o.getEnabledElementByViewportId)(e);if(w.forEach((e,n)=>{n.includes(t)&&w.delete(n)}),!i)return;const{viewport:s}=i;(0,a.A)(s.element,t),n&&s.render()}}},67014:(e,t,n)=>{"use strict";n.d(t,{Ay:()=>g});var o=n(15327),i=n(18682),a=n(20552),s=n(18796),r=n(33283),l=n(50409),d=n(36625),c=n(27479),h=n(47098);const g={render:async function(e,t){const{segmentationId:n,type:a}=t,g=(0,r.T)(n);if(!g)return;let u=g.representationData[i.A.Surface];if(!u&&(0,d.Qy)()?.canComputeRequestedRepresentation(n,i.A.Surface)){const t=(0,d.Qy)();if(u=await(0,c.d)(n,i.A.Surface,()=>t.computeSurfaceData(n,{viewport:e}),()=>t.updateSurfaceData(n,{viewport:e})),!u)throw new Error(`No Surface data found for segmentationId ${n} even we tried to compute it`)}else u||(0,d.Qy)()||console.debug(`No surface data found for segmentationId ${n} and PolySeg add-on is not configured. Unable to convert from other representations to surface. Please register PolySeg using cornerstoneTools.init({ addons: { polySeg } }) to enable automatic conversion.`);if(!u)return void console.warn(`No Surface data found for segmentationId ${n}. Skipping render.`);const{geometryIds:m}=u;m?.size||console.warn(`No Surfaces found for segmentationId ${n}. Skipping render.`);const{colorLUTIndex:v}=t,p=(0,l.B)(v),f=[];m.forEach(t=>{const i=o.cache.getGeometry(t);if(!i?.data)return void console.warn(`No Surfaces found for geometryId ${t}. Skipping render.`);const{segmentIndex:r}=i.data,l=(0,h.s)(e.id,{segmentationId:n,type:a}).has(r),d=i.data,c=p[r];d.color=c.slice(0,3),d.visible=!l,f.push(d),(0,s.A)(e.element,d,n)}),e.render()},removeRepresentation:function(e,t,n=!1){const i=(0,o.getEnabledElementByViewportId)(e);if(!i)return;const{viewport:s}=i;(0,a.A)(s.element,t),n&&s.render()}}},49975:(e,t,n)=>{"use strict";n.d(t,{A5:()=>d.A,CH:()=>i.A,Du:()=>s.A,E0:()=>y.A,EC:()=>o.EC,EV:()=>W.A,FE:()=>w.A,Fz:()=>ae.A,G2:()=>Y.A,IX:()=>ie.A,Ix:()=>N.A,J2:()=>P.A,LK:()=>re.A,LW:()=>A.A,M$:()=>m.A,Mu:()=>T.A,N:()=>I.A,N7:()=>S.A,Nk:()=>p.A,Np:()=>G.A,OQ:()=>c.A,Oh:()=>C.A,So:()=>a.A,T8:()=>F.A,TG:()=>r.A,TR:()=>X.A,Tc:()=>K.A,Uj:()=>ne.A,Vl:()=>x.A,X8:()=>v.A,Xr:()=>oe.A,Ys:()=>U.A,ae:()=>l.A,ao:()=>V.A,cN:()=>f.A,dB:()=>$.A,eh:()=>u.A,ep:()=>g.A,ex:()=>k.A,hz:()=>b.A,il:()=>j.A,j$:()=>D.A,ls:()=>te.A,m8:()=>_.A,mX:()=>Q.A,nJ:()=>R.A,oS:()=>o.oS,oi:()=>H.A,pq:()=>ee.A,qD:()=>M.A,qT:()=>L.A,qi:()=>O.A,sR:()=>q.A,td:()=>Z.A,u9:()=>se.A,uJ:()=>h.A,wR:()=>z.A,wh:()=>o.wh,xI:()=>E.A,yT:()=>B.A,zH:()=>J.A});var o=n(85817),i=n(38782),a=n(26884),s=n(43159),r=n(17819),l=n(89460),d=n(82058),c=n(26938),h=n(66944),g=n(14840),u=n(72674),m=n(45152),v=n(36797),p=n(65566),f=n(32302),E=n(85735),w=n(26039),I=n(3751),C=n(30588),T=n(25072),b=n(37117),A=n(14335),_=n(59320),S=n(61873),D=n(40487),y=n(4010),M=n(78684),x=n(31137),R=n(8467),P=n(3066),L=n(60580),k=n(28220),O=n(37590),U=n(9136),N=n(76358),V=n(24146),B=n(9608),W=n(99718),H=n(94504),F=n(20214),G=n(33327),$=n(68760),z=n(9626),q=n(7750),K=n(31787),j=n(23631),Z=n(56526),Y=n(66917),J=n(10804),X=n(40336),Q=n(67847),ee=n(65284),te=n(48736),ne=n(61777),oe=n(36913),ie=n(12905),ae=n(38502),se=(n(99522),n(987)),re=n(89584)},48736:(e,t,n)=>{"use strict";n.d(t,{A:()=>p});var o=n(15327),i=n(3823),a=n(99737),s=n(17492),r=n(1989),l=n(56789),d=n(33852),c=n(74347),h=n(7001),g=n(58640),u=n(23631),m=n(40905);class v extends u.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE_CIRCLE:l.kr,ERASE_INSIDE_CIRCLE:d.r,FILL_INSIDE_SPHERE:s.Jq,ERASE_INSIDE_SPHERE:r._,THRESHOLD_INSIDE_CIRCLE:l.q,THRESHOLD_INSIDE_SPHERE:s.rd,THRESHOLD_INSIDE_SPHERE_WITH_ISLAND_REMOVAL:s.Sw},defaultStrategy:"FILL_INSIDE_CIRCLE",activeStrategy:"FILL_INSIDE_CIRCLE",brushSize:25,useCenterSegmentIndex:!1,preview:{enabled:!1,previewColors:{0:[255,255,255,128]},previewTimeMs:250,previewMoveDistance:8,dragMoveDistance:4,dragTimeMs:500},actions:{[a.StrategyCallbacks.AcceptPreview]:{method:a.StrategyCallbacks.AcceptPreview,bindings:[{key:"Enter"}]},[a.StrategyCallbacks.RejectPreview]:{method:a.StrategyCallbacks.RejectPreview,bindings:[{key:"Escape"}]},[a.StrategyCallbacks.Interpolate]:{method:a.StrategyCallbacks.Interpolate,bindings:[{key:"i"}],configuration:{useBallStructuringElement:!0,noUseDistanceTransform:!0,noUseExtrapolation:!0}},interpolateExtrapolation:{method:a.StrategyCallbacks.Interpolate,bindings:[{key:"e"}],configuration:{}}}}}){super(e,t),this.onSetToolPassive=e=>{this.disableCursor()},this.onSetToolEnabled=()=>{this.disableCursor()},this.onSetToolDisabled=e=>{this.disableCursor()},this.preMouseDownCallback=e=>{const t=e.detail,{element:n}=t,i=(0,o.getEnabledElement)(n);this._editData=this.createEditData(n),this._activateDraw(n),(0,h.hideElementCursor)(n),e.preventDefault(),this._previewData.isDrag=!1,this._previewData.timerStart=Date.now();const s=this._hoverData||this.createHoverData(n);(0,g.A)(s.viewportIdsToRender);const r=this.getOperationData(n);return this.applyActiveStrategyCallback(i,r,a.StrategyCallbacks.OnInteractionStart),!0},this.mouseMoveCallback=e=>{if(this.mode===a.ToolModes.Active){if(this.updateCursor(e),!this.configuration.preview.enabled)return;const{previewTimeMs:t,previewMoveDistance:n,dragMoveDistance:o}=this.configuration.preview,{currentPoints:a,element:s}=e.detail,{canvas:r}=a,{startPoint:l,timer:d,timerStart:c,isDrag:h}=this._previewData;if(h)return;const g=i.Zc.distance(r,l),u=Date.now()-c;if((g>n||u>t&&g>o)&&(d&&(window.clearTimeout(d),this._previewData.timer=null),h||this.rejectPreview(s)),!this._previewData.timer){const e=window.setTimeout(this.previewCallback,250);Object.assign(this._previewData,{timerStart:Date.now(),timer:e,startPoint:r,element:s})}}},this.previewCallback=()=>{if(this._previewData.isDrag)return void(this._previewData.timer=null);this._previewData.timer=null;const e=this.getOperationData(this._previewData.element),t=(0,o.getEnabledElement)(this._previewData.element);if(!t)return;const{viewport:n}=t,i=this.configuration.activeStrategy,s=(0,m.S)({operationData:e,viewport:n,strategy:i});if(!e)return;const r=this.createMemo(e.segmentationId,s.segmentationVoxelManager);this._previewData.preview=this.applyActiveStrategyCallback((0,o.getEnabledElement)(this._previewData.element),{...e,...s,memo:r},a.StrategyCallbacks.Preview)},this._dragCallback=e=>{const t=e.detail,{element:n,currentPoints:a}=t,s=(0,o.getEnabledElement)(n);this.updateCursor(e);const{viewportIdsToRender:r}=this._hoverData;(0,g.A)(r);const l=i.Zc.distance(a.canvas,this._previewData.startPoint),{dragTimeMs:d,dragMoveDistance:c}=this.configuration.preview;!this._previewData.isDrag&&Date.now()-this._previewData.timerStart<d&&l<c||(this._previewData.timer&&(window.clearTimeout(this._previewData.timer),this._previewData.timer=null),this._previewData.preview=this.applyActiveStrategy(s,this.getOperationData(n)),this._previewData.element=n,this._previewData.timerStart=Date.now()+d,this._previewData.isDrag=!0,this._previewData.startPoint=a.canvas)},this._endCallback=e=>{const t=e.detail,{element:n}=t,i=(0,o.getEnabledElement)(n),s=this.getOperationData(n);this._previewData.preview||this._previewData.isDrag||this.applyActiveStrategy(i,s),this.doneEditMemo(),this._deactivateDraw(n),(0,h.resetElementCursor)(n),this.updateCursor(e),this._editData=null,this.applyActiveStrategyCallback(i,s,a.StrategyCallbacks.OnInteractionEnd),this._previewData.isDrag||this.acceptPreview(n)},this._activateDraw=e=>{e.addEventListener(a.Events.MOUSE_UP,this._endCallback),e.addEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(a.Events.MOUSE_CLICK,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(a.Events.MOUSE_UP,this._endCallback),e.removeEventListener(a.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(a.Events.MOUSE_CLICK,this._endCallback)}}disableCursor(){this._hoverData=void 0,this.rejectPreview()}updateCursor(e){const t=e.detail,{element:n}=t,{currentPoints:o}=t,i=o.canvas;this._hoverData=this.createHoverData(n,i),this._calculateCursor(n,i),this._hoverData&&(0,g.A)(this._hoverData.viewportIdsToRender)}_calculateCursor(e,t){const n=(0,o.getEnabledElement)(e),{viewport:a}=n,{canvasToWorld:s}=a,r=a.getCamera(),{brushSize:l}=this.configuration,d=i.eR.fromValues(r.viewUp[0],r.viewUp[1],r.viewUp[2]),c=i.eR.fromValues(r.viewPlaneNormal[0],r.viewPlaneNormal[1],r.viewPlaneNormal[2]),h=i.eR.create();i.eR.cross(h,d,c);const g=s([t[0],t[1]]),u=i.eR.create(),m=i.eR.create(),v=i.eR.create(),p=i.eR.create();for(let e=0;e<=2;e++)u[e]=g[e]-d[e]*l,m[e]=g[e]+d[e]*l,v[e]=g[e]-h[e]*l,p[e]=g[e]+h[e]*l;if(!this._hoverData)return;const{brushCursor:f}=this._hoverData,{data:E}=f;void 0===E.handles&&(E.handles={}),E.handles.points=[u,m,v,p];const w=this.configuration.activeStrategy,I=this.configuration.strategies[w];"function"==typeof I?.computeInnerCircleRadius&&I.computeInnerCircleRadius({configuration:this.configuration,viewport:a}),E.invalidated=!1}getStatistics(e,t){if(!e)return;const n=(0,o.getEnabledElement)(e);return this.applyActiveStrategyCallback(n,this.getOperationData(e),a.StrategyCallbacks.GetStatistics,t)}rejectPreview(e=this._previewData.element){if(!e)return;this.doneEditMemo();const t=(0,o.getEnabledElement)(e);t&&(this.applyActiveStrategyCallback(t,this.getOperationData(e),a.StrategyCallbacks.RejectPreview),this._previewData.preview=null,this._previewData.isDrag=!1)}acceptPreview(e=this._previewData.element){e&&super.acceptPreview(e)}interpolate(e,t){if(!e)return;const n=(0,o.getEnabledElement)(e);this._previewData.preview=this.applyActiveStrategyCallback(n,this.getOperationData(e),a.StrategyCallbacks.Interpolate,t.configuration),this._previewData.isDrag=!0}invalidateBrushCursor(){if(void 0===this._hoverData)return;const{data:e}=this._hoverData.brushCursor,{viewport:t}=this._hoverData;e.invalidated=!0;const{segmentColor:n}=this.getActiveSegmentationData(t)||{};this._hoverData.brushCursor.metadata.segmentColor=n}renderAnnotation(e,t){if(!this._hoverData)return;const{viewport:n}=e;if(!this._hoverData.viewportIdsToRender.includes(n.id))return;const o=this._hoverData.brushCursor;if(!0===o.data.invalidated){const{centerCanvas:e}=this._hoverData,{element:t}=n;this._calculateCursor(t,e)}const i=o.metadata;if(!i)return;const a=i.brushCursorUID,s=o.data,{points:r}=s.handles,l=r.map(e=>n.worldToCanvas(e)),d=l[0],h=l[1],g=[Math.floor((d[0]+h[0])/2),Math.floor((d[1]+h[1])/2)],u=Math.abs(d[1]-Math.floor((d[1]+h[1])/2)),m=`rgb(${i.segmentColor?.slice(0,3)||[0,0,0]})`;if(!n.getRenderingEngine())return void console.warn("Rendering Engine has been destroyed");(0,c.drawCircle)(t,a,"0",g,u,{color:m,lineDash:0===this.centerSegmentIndexInfo.segmentIndex?[1,2]:null});const{dynamicRadiusInCanvas:v}=this.configuration?.threshold||{dynamicRadiusInCanvas:0};if(v){const e="1";(0,c.drawCircle)(t,a,e,g,v,{color:m})}}}v.toolName="Brush";const p=v},65284:(e,t,n)=>{"use strict";n.d(t,{A:()=>y});var o=n(15327),i=n(3823),a=n(82056),s=n(2076),r=n(74347),l=n(60810),d=n(62514),c=n(473),h=n(27730),g=n(52905),u=n(29601),m=n(7001),v=n(58640),p=n(44049),f=n(31137),E=n(77081),w=n(4096),I=n(18990),C=n(11683),T=n(73262),b=n(13165),A=n(40634);const{transformWorldToIndex:_}=o.utilities;class S extends f.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{storePointData:!1,numSlicesToPropagate:10,calculatePointsInsideVolume:!0,getTextLines:D,statsCalculator:T.BasicStatsCalculator,showTextBox:!1,throttleTimeout:100}}){super(e,t),this.isHandleOutsideImage=!1,this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,s=n.world,r=(0,o.getEnabledElement)(i),{viewport:d,renderingEngine:c}=r;this.isDrawing=!0;const h=d.getCamera(),{viewPlaneNormal:g,viewUp:u}=h;let p,f,E;if(d instanceof o.StackViewport)throw new Error("Stack Viewport Not implemented");{const e=this.getTargetId(d);E=o.utilities.getVolumeId(e),f=o.cache.getVolume(E),p=o.utilities.getClosestImageId(f,s,g)}const w=o.utilities.getSpacingInNormalDirection(f,g),I=this._getStartCoordinate(s,w,g),C=this._getEndCoordinate(s,w,g),T=d.getFrameOfReferenceUID(),b={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...g],viewUp:[...u],FrameOfReferenceUID:T,referencedImageId:p,volumeId:E,spacingInNormal:w,enabledElement:r},data:{label:"",startCoordinate:I,endCoordinate:C,handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...s],[...s]],activeHandleIndex:null},cachedStats:{pointsInVolume:[],projectionPoints:[],statistics:[]},labelmapUID:null}};this._computeProjectionPoints(b,f),(0,a.addAnnotation)(b,i);const A=(0,l.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:b,viewportIdsToRender:A,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,m.hideElementCursor)(i),e.preventDefault(),(0,v.A)(A),b},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:s,newAnnotation:r,hasMoved:l}=this.editData,{data:d}=i;if(r&&!l)return;i.highlighted=!1,d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,m.resetElementCursor)(n);const c=(0,o.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,a.removeAnnotation)(i.annotationUID);const h=this.getTargetId(c.viewport),g=o.cache.getVolume(h.split(/volumeId:|\?/)[1]);this._computePointsInsideVolume(i,g,h,c),(0,v.A)(s),r?(0,p.triggerAnnotationCompleted)(i):(0,p.triggerAnnotationModified)(i,n)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e;let l=(0,a.getAnnotations)(this.getToolName(),i.element);if(!l?.length)return n;l=(0,b.filterAnnotationsWithinSamePlane)(l,i.getCamera());const d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let a=0;a<l.length;a++){const h=l[a],{annotationUID:g,data:m,metadata:v}=h,{startCoordinate:p,endCoordinate:f}=m,{points:w,activeHandleIndex:I}=m.handles;d.annotationUID=g;const C=this.getStyle("lineWidth",d,h),T=this.getStyle("lineDash",d,h),b=this.getStyle("color",d,h),A=w.map(e=>i.worldToCanvas(e)),_=A[0],S=(0,E.getCanvasCircleRadius)(A),{centerPointRadius:D}=this.configuration,y=(0,E.getCanvasCircleCorners)(A),M=i.getCamera().focalPoint,x=i.getCamera().viewPlaneNormal;let R=p,P=f;Array.isArray(p)&&(R=this._getCoordinateForViewplaneNormal(R,x),m.startCoordinate=R),Array.isArray(f)&&(P=this._getCoordinateForViewplaneNormal(P,x),m.endCoordinate=P);const L=o.utilities.roundToPrecision(m.startCoordinate),k=o.utilities.roundToPrecision(m.endCoordinate),O=this._getCoordinateForViewplaneNormal(M,x),U=o.utilities.roundToPrecision(O);if(U<Math.min(L,k)||U>Math.max(L,k))continue;const N=o.utilities.roundToPrecision((m.startCoordinate+m.endCoordinate)/2);let V,B=!1;if(U===N&&(B=!0),m.handles.points[0][this._getIndexOfCoordinatesForViewplaneNormal(x)]=N,h.invalidated&&this._throttledCalculateCachedStats(h,e),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,u.isAnnotationVisible)(g))continue;if((0,s.isAnnotationLocked)(g)||this.editData||null===I||!B||(V=[A[I]]),V){const e="0";(0,r.drawHandles)(t,g,e,V,{color:b})}let W=C,H=T;B?(W=C,H=[]):H=[5,5];const F="0";if((0,r.drawCircle)(t,g,F,_,S,{color:b,lineDash:H,lineWidth:W}),D>0&&S>3*D&&(0,r.drawCircle)(t,g,`${F}-center`,_,D,{color:b,lineDash:T,lineWidth:C}),n=!0,this.configuration.showTextBox){const e=this.getLinkedTextBoxStyle(d,h);if(!e.visibility){m.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const n=this.configuration.getTextLines(m,{metadata:v});if(!n||0===n.length)continue;let o;m.handles.textBox.hasMoved||(o=(0,c.getTextBoxCoordsCanvas)(y),m.handles.textBox.worldPosition=i.canvasToWorld(o));const a=i.worldToCanvas(m.handles.textBox.worldPosition),s="1",l=(0,r.drawLinkedTextBox)(t,g,s,n,a,A,{},e),{x:u,y:p,width:f,height:E}=l;m.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([u,p]),topRight:i.canvasToWorld([u+f,p]),bottomLeft:i.canvasToWorld([u,p+E]),bottomRight:i.canvasToWorld([u+f,p+E])}}}return n},this.configuration.calculatePointsInsideVolume?this._throttledCalculateCachedStats=(0,h.A)(this._calculateCachedStatsTool,this.configuration.throttleTimeout,{trailing:!0}):this._throttledCalculateCachedStats=(0,g.A)(this._calculateCachedStatsTool,this.configuration.throttleTimeout)}_computeProjectionPoints(e,t){const{data:n,metadata:a}=e,{viewPlaneNormal:s,spacingInNormal:r}=a,{imageData:l}=t,{startCoordinate:d,endCoordinate:c}=n,{points:h}=n.handles,g=_(l,h[0]),u=_(l,h[0]),m=o.utilities.deepClone(h),v=i.eR.create();l.indexToWorldVec3(g,v);const p=i.eR.create();l.indexToWorldVec3(u,p);const f=this._getIndexOfCoordinatesForViewplaneNormal(s);2==f?(v[2]=d,p[2]=c,m[0][2]=d,m[1][2]=d):0==f?(v[0]=d,p[0]=c,m[0][0]=d,m[1][0]=d):1==f&&(v[1]=d,p[1]=c,m[0][1]=d,m[1][1]=d);const E=i.eR.create();i.eR.subtract(E,p,v);const w=i.eR.length(E);i.eR.normalize(E,E);const I=[],C=h;for(let e=0;e<w;e+=r)I.push(C.map(t=>{const n=i.eR.create();return i.eR.scaleAndAdd(n,t,E,e),Array.from(n)}));n.cachedStats.projectionPoints=I}_computePointsInsideVolume(e,t,n,o){const{data:i,metadata:a}=e,{viewPlaneNormal:s,viewUp:r}=a,{viewport:l}=o,c=i.cachedStats.projectionPoints,h=[[]],g=this.getTargetImageData(n),u=i.handles.points.map(e=>l.worldToCanvas(e)),[m,v]=(0,E.getCanvasCircleCorners)(u),p=l.canvasToWorld(m),f=l.canvasToWorld(v),{worldWidth:T,worldHeight:b}=(0,d.A)(s,r,p,f),S=(0,w.Op)(g,i.handles),D=(0,w.CQ)(g),y=Math.abs(Math.PI*(T/S.scale/2)*(b/D/S.scale/2)),M={isPreScaled:(0,I.u)(l,n),isSuvScaled:this.isSuvScaled(l,n,e.metadata.referencedImageId)},x=(0,A.j)(a.Modality,e.metadata.referencedImageId,M);for(let e=0;e<c.length;e++){if(!t)continue;const n=c[e][0],o=c[e].map(e=>l.worldToCanvas(e)),[i,a]=(0,E.getCanvasCircleCorners)(o),r=l.canvasToWorld(i),d=l.canvasToWorld(a),g=r,u=d,{dimensions:m,imageData:v,voxelManager:p}=t,f=_(v,g),w=_(v,n),I=this._getIndexOfCoordinatesForViewplaneNormal(s);f[0]=Math.floor(f[0]),f[1]=Math.floor(f[1]),f[2]=Math.floor(f[2]),f[I]=w[I];const T=_(v,u);if(T[0]=Math.floor(T[0]),T[1]=Math.floor(T[1]),T[2]=Math.floor(T[2]),T[I]=w[I],this._isInsideVolume(f,T,m)){const e=[[Math.min(f[0],T[0]),Math.max(f[0],T[0])],[Math.min(f[1],T[1]),Math.max(f[1],T[1])],[Math.min(f[2],T[2]),Math.max(f[2],T[2])]],t={center:n,xRadius:Math.abs(r[0]-d[0])/2,yRadius:Math.abs(r[1]-d[1])/2,zRadius:Math.abs(r[2]-d[2])/2},o=p.forEach(this.configuration.statsCalculator.statsCallback,{isInObject:e=>(0,C.pointInEllipse)(t,e),boundsIJK:e,imageData:v,returnPoints:this.configuration.storePointData});h.push(o)}}const R=this.configuration.statsCalculator.getStatistics();i.cachedStats.pointsInVolume=h,i.cachedStats.statistics={Modality:a.Modality,area:y,mean:R.mean?.value,stdDev:R.stdDev?.value,max:R.max?.value,statsArray:R.array,areaUnit:S.areaUnit,modalityUnit:x}}_calculateCachedStatsTool(e,t){const n=e.data,{viewport:i}=t,{cachedStats:a}=n,s=this.getTargetId(i),r=o.cache.getVolume(s.split(/volumeId:|\?/)[1]);return this._computeProjectionPoints(e,r),this._computePointsInsideVolume(e,r,s,t),e.invalidated=!1,(0,p.triggerAnnotationModified)(e,i.element),a}_getStartCoordinate(e,t,n){const o=this.configuration.numSlicesToPropagate,a=Math.round(o/2),s=i.eR.create();i.eR.scaleAndAdd(s,e,n,a*-t);return this._getCoordinateForViewplaneNormal(s,n)}_getEndCoordinate(e,t,n){const o=this.configuration.numSlicesToPropagate,a=o-Math.round(o/2),s=i.eR.create();i.eR.scaleAndAdd(s,e,n,a*t);return this._getCoordinateForViewplaneNormal(s,n)}_getIndexOfCoordinatesForViewplaneNormal(e){const t=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])];return t.indexOf(Math.max(...t))}_getCoordinateForViewplaneNormal(e,t){return e[this._getIndexOfCoordinatesForViewplaneNormal(t)]}}function D(e,t={}){const n=e.cachedStats.statistics,{area:i,mean:a,max:s,stdDev:r,areaUnit:l,modalityUnit:d}=n;if(void 0===a)return;const c=[];return c.push(`Area: ${o.utilities.roundNumber(i)} ${l}`),c.push(`Mean: ${o.utilities.roundNumber(a)} ${d}`),c.push(`Max: ${o.utilities.roundNumber(s)} ${d}`),c.push(`Std Dev: ${o.utilities.roundNumber(r)} ${d}`),c}S.toolName="CircleROIStartEndThreshold";const y=S},66917:(e,t,n)=>{"use strict";n.d(t,{A:()=>m});var o=n(15327),i=(n(85817),n(56789)),a=n(33852),s=n(99737),r=n(74347),l=n(7001),d=n(58640),c=n(90713),h=n(98870),g=n(23631);class u extends g.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:i.kr,ERASE_INSIDE:a.r},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,s=n.canvas,r=(0,o.getEnabledElement)(i),{viewport:g}=r;this.isDrawing=!0;const u=g.getCamera(),{viewPlaneNormal:m,viewUp:v}=u,p=c.activeSegmentation.getActiveSegmentation(g.id);if(!p)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:f}=p,E=c.segmentIndex.getActiveSegmentIndex(f),w=c.segmentLocking.getLockedSegmentIndices(f),I=c.config.color.getSegmentIndexColor(g.id,f,E),{representationData:C}=(0,h.getSegmentation)(f),T=C.Labelmap;if(!T)throw new Error("No labelmap data found for the active segmentation, create one before using scissors tool");const b={invalidated:!0,highlighted:!0,metadata:{viewPlaneNormal:[...m],viewUp:[...v],FrameOfReferenceUID:g.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:I},data:{handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},isDrawing:!0,cachedStats:{}}},A=[g.id];if(this.editData={annotation:b,centerCanvas:s,segmentIndex:E,segmentationId:f,segmentsLocked:w,segmentColor:I,viewportIdsToRender:A,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,volumeId:null,referencedVolumeId:null,imageId:null},g instanceof o.BaseVolumeViewport){const{volumeId:e}=T,t=o.cache.getVolume(e);this.editData={...this.editData,volumeId:e,referencedVolumeId:t.referencedVolumeId}}else{const e=(0,h.getCurrentLabelmapImageIdForViewport)(g.id,f);this.editData={...this.editData,imageId:e}}return this._activateDraw(i),(0,l.hideElementCursor)(i),e.preventDefault(),(0,d.A)(A),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas,s=(0,o.getEnabledElement)(n),{renderingEngine:r,viewport:l}=s,{canvasToWorld:c}=l,{annotation:h,viewportIdsToRender:g,centerCanvas:u}=this.editData,{data:m}=h,v=Math.abs(a[0]-u[0]),p=Math.abs(a[1]-u[1]),f=Math.sqrt(v*v+p*p),E=[u[0],u[1]+f],w=[u[0],u[1]-f],I=[u[0]-f,u[1]],C=[u[0]+f,u[1]];m.handles.points=[c(E),c(w),c(I),c(C)],h.invalidated=!0,this.editData.hasMoved=!0,(0,d.A)(g)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=i,{viewPlaneNormal:d,viewUp:c}=i.metadata;if(a&&!s)return;r.handles.activeHandleIndex=null,this._deactivateDraw(n),(0,l.resetElementCursor)(n);const h=(0,o.getEnabledElement)(n),g={...this.editData,points:r.handles.points,viewPlaneNormal:d,viewUp:c,createMemo:this.createMemo.bind(this)};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(h,g),this.doneEditMemo()},this._activateDraw=e=>{e.addEventListener(s.Events.MOUSE_UP,this._endCallback),e.addEventListener(s.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(s.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(s.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(s.Events.TOUCH_TAP,this._endCallback),e.addEventListener(s.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(s.Events.TOUCH_END,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(s.Events.MOUSE_UP,this._endCallback),e.removeEventListener(s.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(s.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(s.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(s.Events.TOUCH_END,this._endCallback),e.removeEventListener(s.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(s.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:o}=e,{viewportIdsToRender:i}=this.editData;if(!i.includes(o.id))return n;const{annotation:a}=this.editData,s=a.metadata,l=a.annotationUID,d=a.data,{points:c}=d.handles,h=c.map(e=>o.worldToCanvas(e)),g=h[0],u=h[1],m=[Math.floor((g[0]+u[0])/2),Math.floor((g[1]+u[1])/2)],v=Math.abs(g[1]-Math.floor((g[1]+u[1])/2)),p=`rgb(${s.segmentColor.slice(0,3)})`;if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return(0,r.drawCircle)(t,l,"0",m,v,{color:p}),n=!0,n}}}u.toolName="CircleScissor";const m=u},89584:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var o=n(99737),i=n(15327),a=n(37590),s=n(48736),r=n(90713),l=n(93210);class d extends a.A{static{this.toolName="LabelMapEditWithContour"}static{this.annotationsToViewportMap=new Map}static{this.viewportIdsChecked=[]}constructor(e={}){super(i.utilities.deepMerge({configuration:{calculateStats:!1,allowOpenContours:!1}},e)),this.onViewportAddedToToolGroupBinded=this.onViewportAddedToToolGroup.bind(this),this.onSegmentationModifiedBinded=this.onSegmentationModified.bind(this)}initializeListeners(){d.annotationsToViewportMap.clear(),d.viewportIdsChecked=[],i.eventTarget.addEventListener(o.Events.ANNOTATION_MODIFIED,this.annotationModified),i.eventTarget.addEventListener(o.Events.ANNOTATION_COMPLETED,this.annotationCompleted),i.eventTarget.addEventListener(o.Events.TOOLGROUP_VIEWPORT_ADDED,this.onViewportAddedToToolGroupBinded),i.eventTarget.addEventListener(o.Events.SEGMENTATION_MODIFIED,this.onSegmentationModifiedBinded)}cleanUpListeners(){d.annotationsToViewportMap.clear(),d.viewportIdsChecked=[],i.eventTarget.removeEventListener(o.Events.ANNOTATION_MODIFIED,this.annotationModified),i.eventTarget.removeEventListener(o.Events.ANNOTATION_COMPLETED,this.annotationCompleted),i.eventTarget.removeEventListener(o.Events.TOOLGROUP_VIEWPORT_ADDED,this.onViewportAddedToToolGroup.bind(this)),i.eventTarget.removeEventListener(o.Events.SEGMENTATION_MODIFIED,this.onSegmentationModified.bind(this))}async checkContourSegmentation(e){if(d.viewportIdsChecked.includes(e))return;const t=r.getActiveSegmentation(e);if(!t)return console.log("No active segmentation detected"),!1;const n=t.segmentationId;return t.representationData.Contour?d.viewportIdsChecked.push(e):(d.viewportIdsChecked.push(e),await r.addContourRepresentationToViewport(e,[{segmentationId:n,type:o.SegmentationRepresentations.Contour}]),r.addRepresentationData({segmentationId:n,type:o.SegmentationRepresentations.Contour,data:{}})),!0}onViewportAddedToToolGroup(e){const{toolGroupId:t,viewportId:n}=e.detail;t===this.toolGroupId&&this.checkContourSegmentation(n)}onSegmentationModified(e){const{segmentationId:t}=e.detail||{};if(!t)return;const n=(0,l.ny)(t);n&&n.forEach(async({viewportId:e})=>await this.checkContourSegmentation(e))}onSetToolEnabled(){this.initializeListeners()}onSetToolActive(){this.initializeListeners()}onSetToolDisabled(){this.cleanUpListeners()}annotationModified(e){const{annotation:t,renderingEngineId:n,viewportId:o}=e.detail,a=(0,i.getRenderingEngine)(n)?.getViewport(o);a&&d.annotationsToViewportMap.set(t.annotationUID,a)}annotationCompleted(e){const{annotation:t}=e.detail,{polyline:n}=t.data?.contour||{};if(t?.metadata?.toolName===d.toolName&&n&&d.annotationsToViewportMap.has(t.annotationUID)){const e=d.annotationsToViewportMap.get(t.annotationUID);n.length>3&&s.A.viewportContoursToLabelmap(e)}}}const c=d},61777:(e,t,n)=>{"use strict";n.d(t,{A:()=>u});var o=n(15327),i=n(85817),a=n(99737),s=n(49906),r=n(90713),l=n(84882),d=n(98870);const{transformWorldToIndex:c,isEqual:h}=o.utilities;class g extends i.oS{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"]}){super(e,t),this.preMouseDownCallback=e=>{const t=e.detail,{currentPoints:n,element:i}=t,h=n.world,g=(0,o.getEnabledElement)(i),{viewport:u}=g,m=u.getCamera(),{viewPlaneNormal:v}=m,p=r.activeSegmentation.getActiveSegmentation(u.id);if(!p)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:f}=p,E=r.segmentIndex.getActiveSegmentIndex(f),w=r.segmentLocking.getLockedSegmentIndices(f),{representationData:I}=(0,d.getSegmentation)(f);let C,T,b,A;if(this.doneEditMemo(),u instanceof o.BaseVolumeViewport){const{volumeId:e}=I[a.SegmentationRepresentations.Labelmap],t=o.cache.getVolume(e);({dimensions:C,direction:T}=t),A=t.voxelManager,b=c(t.imageData,h)}else{const e=(0,d.getCurrentLabelmapImageIdForViewport)(u.id,f);if(!e)throw new Error("No active segmentation imageId detected, create one before using scissors tool");const{imageData:t}=u.getImageData();C=t.getDimensions(),T=t.getDirection();const n=o.cache.getImage(e);A=n.voxelManager,b=c(t,h)}const _=this.getFixedDimension(v,T);if(void 0===_)return void console.warn("Oblique paint fill not yet supported");const{floodFillGetter:S,getLabelValue:D,getScalarDataPositionFromPlane:y,inPlaneSeedPoint:M,fixedDimensionValue:x}=this.generateHelpers(A,C,b,_);if(b[0]<0||b[0]>=C[0]||b[1]<0||b[1]>=C[1]||b[2]<0||b[2]>=C[2])return;const R=D(b[0],b[1],b[2]);if(w.includes(R))return;const P=(0,l.A)(S,M),{flooded:L}=P;L.forEach(e=>{const t=y(e[0],e[1]);A.setAtIndex(t,E)});const k=this.getFramesModified(_,x,P);return(0,s.triggerSegmentationDataModified)(f,k),!0},this.getFramesModified=(e,t,n)=>{const{flooded:o}=n;if(2===e)return[t];let i=1/0,a=-1/0;for(let e=0;e<o.length;e++){const t=o[e][1];t<i&&(i=t),t>a&&(a=t)}const s=[];for(let e=i;e<=a;e++)s.push(e);return s},this.generateHelpers=(e,t,n,o=2)=>{let i,a;switch(o){case 0:i=n[0],a=[n[1],n[2]];break;case 1:i=n[1],a=[n[0],n[2]];break;case 2:i=n[2],a=[n[0],n[1]];break;default:throw new Error(`Invalid fixedDimension: ${o}`)}const s=(t,n,o)=>e.getAtIJK(t,n,o),r=this.generateFloodFillGetter(t,o,i,s);return{getScalarDataPositionFromPlane:this.generateGetScalarDataPositionFromPlane((t,n,o)=>e.toIndex([t,n,o]),o,i),getLabelValue:s,floodFillGetter:r,inPlaneSeedPoint:a,fixedDimensionValue:i}},this.generateFloodFillGetter=(e,t,n,o)=>{let i;switch(t){case 0:i=(t,i)=>{if(!(t>=e[1]||t<0||i>=e[2]||i<0))return o(n,t,i)};break;case 1:i=(t,i)=>{if(!(t>=e[0]||t<0||i>=e[2]||i<0))return o(t,n,i)};break;case 2:i=(t,i)=>{if(!(t>=e[0]||t<0||i>=e[1]||i<0))return o(t,i,n)};break;default:throw new Error(`Invalid fixedDimension: ${t}`)}return i},this.generateGetScalarDataPositionFromPlane=(e,t,n)=>{let o;switch(t){case 0:o=(t,o)=>e(n,t,o);break;case 1:o=(t,o)=>e(t,n,o);break;case 2:o=(t,o)=>e(t,o,n);break;default:throw new Error(`Invalid fixedDimension: ${t}`)}return o}}getFixedDimension(e,t){const n=t.slice(0,3),o=t.slice(3,6),i=t.slice(6,9),a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],s=[Math.abs(n[0]),Math.abs(n[1]),Math.abs(n[2])];if(h(a,s))return 0;const r=[Math.abs(o[0]),Math.abs(o[1]),Math.abs(o[2])];if(h(a,r))return 1;const l=[Math.abs(i[0]),Math.abs(i[1]),Math.abs(i[2])];return h(a,l)?2:void 0}}g.toolName="PaintFill";const u=g},67847:(e,t,n)=>{"use strict";n.d(t,{A:()=>S});var o=n(15327),i=n(4096),a=n(3823),s=n(6802),r=n(2076),l=n(74347),d=n(60810),c=n(27730),h=n(52905),g=n(473),u=n(35489),m=n(29601),v=n(7001),p=n(58640),f=n(44049),E=n(4010),w=n(18990),I=n(73262),C=n(13165),T=n(40634);const{transformWorldToIndex:b}=o.utilities;class A extends E.A{constructor(e={},t={configuration:{storePointData:!1,numSlicesToPropagate:10,calculatePointsInsideVolume:!0,getTextLines:_,statsCalculator:I.BasicStatsCalculator,showTextBox:!1,throttleTimeout:100}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,r=(0,o.getEnabledElement)(i),{viewport:l,renderingEngine:c}=r;this.isDrawing=!0;const h=l.getCamera(),{viewPlaneNormal:g,viewUp:u}=h;let m,f,E;if(l instanceof o.StackViewport)throw new Error("Stack Viewport Not implemented");{const e=this.getTargetId(l);E=o.utilities.getVolumeId(e),f=o.cache.getVolume(E),m=o.utilities.getClosestImageId(f,a,g)}const w=o.utilities.getSpacingInNormalDirection(f,g),I=this._getStartCoordinate(a,g),C=this._getEndCoordinate(a,w,g),T=l.getFrameOfReferenceUID(),b={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...g],enabledElement:r,viewUp:[...u],FrameOfReferenceUID:T,referencedImageId:m,toolName:this.getToolName(),volumeId:E,spacingInNormal:w},data:{label:"",startCoordinate:I,endCoordinate:C,cachedStats:{pointsInVolume:[],projectionPoints:[],projectionPointsImageIds:[m],statistics:[]},handles:{textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},labelmapUID:null}};this._computeProjectionPoints(b,f),(0,s.lC)(b,i);const A=(0,d.getViewportIdsWithToolToRender)(i,this.getToolName());return this.editData={annotation:b,viewportIdsToRender:A,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(i),(0,v.hideElementCursor)(i),e.preventDefault(),(0,p.A)(A),b},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,newAnnotation:r,hasMoved:l}=this.editData,{data:d}=i;if(r&&!l)return;d.handles.activeHandleIndex=null,this._deactivateModify(n),this._deactivateDraw(n),(0,v.resetElementCursor)(n);const c=(0,o.getEnabledElement)(n);this.editData=null,this.isDrawing=!1,this.isHandleOutsideImage&&this.configuration.preventHandleOutsideImage&&(0,s.O8)(i.annotationUID);const h=this.getTargetId(c.viewport),g=o.cache.getVolume(h.split(/volumeId:|\?/)[1]);this._computePointsInsideVolume(i,h,g,c),(0,p.A)(a),r?(0,f.triggerAnnotationCompleted)(i):(0,f.triggerAnnotationModified)(i,n)},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:i}=e;let a=(0,s.Rh)(this.getToolName(),i.element);if(!a?.length)return n;a=(0,C.filterAnnotationsWithinSamePlane)(a,i.getCamera());const d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let s=0;s<a.length;s++){const c=a[s],{annotationUID:h,data:u,metadata:v}=c,{startCoordinate:p,endCoordinate:f}=u,{points:E,activeHandleIndex:w}=u.handles,I=E.map(e=>i.worldToCanvas(e));d.annotationUID=h;const C=this.getStyle("lineWidth",d,c),T=this.getStyle("lineDash",d,c),b=this.getStyle("color",d,c),A=i.getCamera().focalPoint,_=i.getCamera().viewPlaneNormal;let S=p,D=f;if(Array.isArray(p)){S=this._getCoordinateForViewplaneNormal(S,_);const e=this._getIndexOfCoordinatesForViewplaneNormal(_);u.handles.points.forEach(t=>{t[e]=S}),u.startCoordinate=S}Array.isArray(f)&&(D=this._getCoordinateForViewplaneNormal(D,_),u.endCoordinate=D,u.endCoordinate=D);const y=o.utilities.roundToPrecision(S),M=o.utilities.roundToPrecision(D),x=this._getCoordinateForViewplaneNormal(A,_),R=o.utilities.roundToPrecision(x);if(R<Math.min(y,M)||R>Math.max(y,M))continue;c.invalidated&&this._throttledCalculateCachedStats(c,e);let P,L=!1;if(R!==y&&R!==M||(L=!0),!i.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;if(!(0,m.isAnnotationVisible)(h))continue;if((0,r.isAnnotationLocked)(h)||this.editData||null===w||!L||(P=[I[w]]),P){const e="0";(0,l.drawHandles)(t,h,e,P,{color:b})}let k=T;L||(k=2);const O="0";if((0,l.drawRect)(t,h,O,I[0],I[3],{color:b,lineDash:k,lineWidth:C}),n=!0,this.configuration.showTextBox){const e=this.getLinkedTextBoxStyle(d,c);if(!e.visibility){u.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}const n=this.configuration.getTextLines(u,{metadata:v});if(!n||0===n.length)continue;if(!u.handles.textBox.hasMoved){const e=(0,g.getTextBoxCoordsCanvas)(I);u.handles.textBox.worldPosition=i.canvasToWorld(e)}const o=i.worldToCanvas(u.handles.textBox.worldPosition),a="1",s=(0,l.drawLinkedTextBox)(t,h,a,n,o,I,{},e),{x:r,y:m,width:p,height:f}=s;u.handles.textBox.worldBoundingBox={topLeft:i.canvasToWorld([r,m]),topRight:i.canvasToWorld([r+p,m]),bottomLeft:i.canvasToWorld([r,m+f]),bottomRight:i.canvasToWorld([r+p,m+f])}}}return n},this.configuration.calculatePointsInsideVolume?this._throttledCalculateCachedStats=(0,c.A)(this._calculateCachedStatsTool,this.configuration.throttleTimeout,{trailing:!0}):this._throttledCalculateCachedStats=(0,h.A)(this._calculateCachedStatsTool,this.configuration.throttleTimeout)}_computeProjectionPoints(e,t){const{data:n,metadata:o}=e,{viewPlaneNormal:i,spacingInNormal:s}=o,{imageData:r}=t,{startCoordinate:l,endCoordinate:d}=n,{points:c}=n.handles,h=b(r,c[0]),g=b(r,c[0]),u=a.eR.create();r.indexToWorldVec3(h,u);const m=a.eR.create();r.indexToWorldVec3(g,m);const v=this._getIndexOfCoordinatesForViewplaneNormal(i);2==v?(u[2]=l,m[2]=d):0==v?(u[0]=l,m[0]=d):1==v&&(u[1]=l,m[1]=d);const p=a.eR.create();a.eR.subtract(p,m,u);const f=a.eR.length(p);a.eR.normalize(p,p);const E=[];for(let e=0;e<f;e+=s)E.push(c.map(t=>{const n=a.eR.create();return a.eR.scaleAndAdd(n,t,p,e),Array.from(n)}));n.cachedStats.projectionPoints=E}_computePointsInsideVolume(e,t,n,o){const{data:a,metadata:s}=e,{viewPlaneNormal:r,viewUp:l}=s,{viewport:d}=o,c=a.cachedStats.projectionPoints,h=[[]],g=this.getTargetImageData(t),m=a.handles.points[0],v=a.handles.points[3],{worldWidth:p,worldHeight:f}=(0,u.A)(r,l,m,v),E=(0,i.Op)(g,a.habdles),I=Math.abs(p*f)/(E.scale*E.scale),C={isPreScaled:(0,w.u)(d,t),isSuvScaled:this.isSuvScaled(d,t,e.metadata.referencedImageId)},A=(0,T.j)(s.Modality,e.metadata.referencedImageId,C);for(let e=0;e<c.length;e++){if(!n)continue;const t=c[e][0],{dimensions:o,imageData:i,voxelManager:a}=n,s=b(i,m),l=b(i,t),d=this._getIndexOfCoordinatesForViewplaneNormal(r);s[0]=Math.floor(s[0]),s[1]=Math.floor(s[1]),s[2]=Math.floor(s[2]),s[d]=l[d];const g=b(i,v);if(g[0]=Math.floor(g[0]),g[1]=Math.floor(g[1]),g[2]=Math.floor(g[2]),g[d]=l[d],this._isInsideVolume(s,g,o)){this.isHandleOutsideImage=!1;const e=[[Math.min(s[0],g[0]),Math.max(s[0],g[0])],[Math.min(s[1],g[1]),Math.max(s[1],g[1])],[Math.min(s[2],g[2]),Math.max(s[2],g[2])]],t=a.forEach(this.configuration.statsCalculator.statsCallback,{boundsIJK:e,imageData:i,returnPoints:this.configuration.storePointData});h.push(t)}}const _=this.configuration.statsCalculator.getStatistics();a.cachedStats.pointsInVolume=h,a.cachedStats.statistics={Modality:s.Modality,area:I,mean:_.mean?.value,stdDev:_.stdDev?.value,max:_.max?.value,statsArray:_.array,areaUnit:E.areaUnit,modalityUnit:A}}_calculateCachedStatsTool(e,t){const n=e.data,{viewport:i}=t,{cachedStats:a}=n,s=this.getTargetId(i),r=o.cache.getVolume(s.split(/volumeId:|\?/)[1]);return this._computeProjectionPoints(e,r),this._computePointsInsideVolume(e,s,r,t),e.invalidated=!1,(0,f.triggerAnnotationModified)(e,i.element),a}_getStartCoordinate(e,t){const n=e;return this._getCoordinateForViewplaneNormal(n,t)}_getEndCoordinate(e,t,n){const o=this.configuration.numSlicesToPropagate,i=a.eR.create();a.eR.scaleAndAdd(i,e,n,o*t);return this._getCoordinateForViewplaneNormal(i,n)}_getIndexOfCoordinatesForViewplaneNormal(e){const t=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])];return t.indexOf(Math.max(...t))}_getCoordinateForViewplaneNormal(e,t){return e[this._getIndexOfCoordinatesForViewplaneNormal(t)]}}function _(e,t={}){const n=e.cachedStats.statistics,{area:i,mean:a,max:s,stdDev:r,areaUnit:l,modalityUnit:d}=n;if(void 0===a)return;const c=[];return c.push(`Area: ${o.utilities.roundNumber(i)} ${l}`),c.push(`Mean: ${o.utilities.roundNumber(a)} ${d}`),c.push(`Max: ${o.utilities.roundNumber(s)} ${d}`),c.push(`Std Dev: ${o.utilities.roundNumber(r)} ${d}`),c}A.toolName="RectangleROIStartEndThreshold";const S=A},40336:(e,t,n)=>{"use strict";n.d(t,{A:()=>m});var o=n(15327),i=n(6802),a=n(2076),s=n(74347),r=n(60810),l=n(7001),d=n(58640),c=n(29601),h=n(44049),g=n(4010);class u extends g.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{shadow:!0,preventHandleOutsideImage:!1}}){super(e,t),this.addNewAnnotation=e=>{const t=e.detail,{currentPoints:n,element:a}=t,s=n.world,c=(0,o.getEnabledElement)(a),{viewport:h,renderingEngine:g}=c;this.isDrawing=!0;const u=h.getCamera(),{viewPlaneNormal:m,viewUp:v}=u,p=this.getTargetId(h);let f,E;if(h instanceof o.StackViewport)f=p.split("imageId:")[1];else{E=o.utilities.getVolumeId(p);const e=o.cache.getVolume(E);f=o.utilities.getClosestImageId(e,s,m)}const w=h.getFrameOfReferenceUID(),I={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...m],enabledElement:c,viewUp:[...v],FrameOfReferenceUID:w,referencedImageId:f,toolName:this.getToolName(),volumeId:E},data:{label:"",handles:{textBox:{hasMoved:!1,worldPosition:null,worldBoundingBox:null},points:[[...s],[...s],[...s],[...s]],activeHandleIndex:null},segmentationId:null}};(0,i.lC)(I,a);const C=(0,r.getViewportIdsWithToolToRender)(a,this.getToolName());return this.editData={annotation:I,viewportIdsToRender:C,handleIndex:3,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),(0,l.hideElementCursor)(a),e.preventDefault(),(0,d.A)(C),I},this.renderAnnotation=(e,t)=>{let n=!1;const{viewport:o}=e,{element:r}=o;let l=(0,i.Rh)(this.getToolName(),r);if(!l?.length)return n;if(l=this.filterInteractableAnnotationsForElement(r,l),!l?.length)return n;const d={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let e=0;e<l.length;e++){const i=l[e],{annotationUID:g,data:u}=i,{points:m,activeHandleIndex:v}=u.handles,p=m.map(e=>o.worldToCanvas(e));d.annotationUID=g;const f=this.getStyle("lineWidth",d,i),E=this.getStyle("lineDash",d,i),w=this.getStyle("color",d,i);if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let I;if((0,h.triggerAnnotationModified)(i,r),!(0,c.isAnnotationVisible)(g))continue;if((0,a.isAnnotationLocked)(g)||this.editData||null===v||(I=[p[v]]),I){const e="0";(0,s.drawHandles)(t,g,e,I,{color:w})}const C="0";(0,s.drawRect)(t,g,C,p[0],p[3],{color:w,lineDash:E,lineWidth:f}),n=!0}return n}}}u.toolName="RectangleROIThreshold";const m=u},56526:(e,t,n)=>{"use strict";n.d(t,{A:()=>v});var o=n(15327),i=(n(85817),n(10088)),a=n(47347),s=n(60810),r=n(99737),l=n(74347),d=n(7001),c=n(58640),h=n(90713),g=n(98870),u=n(23631);class m extends u.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:i.pY,ERASE_INSIDE:a.M},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,l=(0,o.getEnabledElement)(i),{viewport:u}=l;this.isDrawing=!0;const m=u.getCamera(),{viewPlaneNormal:v,viewUp:p}=m,f=h.activeSegmentation.getActiveSegmentation(u.id);if(!f)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:E}=f,w=h.segmentIndex.getActiveSegmentIndex(E),I=h.segmentLocking.getLockedSegmentIndices(E),C=h.config.color.getSegmentIndexColor(u.id,E,w),{representationData:T}=(0,g.getSegmentation)(E),b=T[r.SegmentationRepresentations.Labelmap],A={highlighted:!0,invalidated:!0,metadata:{viewPlaneNormal:[...v],viewUp:[...p],FrameOfReferenceUID:u.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:C},data:{handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null}}},_=(0,s.getViewportIdsWithToolToRender)(i,this.getToolName());if(this.editData={annotation:A,segmentIndex:w,segmentationId:E,segmentsLocked:I,segmentColor:C,viewportIdsToRender:_,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,volumeId:null,referencedVolumeId:null,imageId:null},u instanceof o.BaseVolumeViewport){const{volumeId:e}=b,t=o.cache.getVolume(e);this.editData={...this.editData,volumeId:e,referencedVolumeId:t.referencedVolumeId}}else{const e=(0,g.getCurrentLabelmapImageIdForViewport)(u.id,E);this.editData={...this.editData,imageId:e}}return this._activateDraw(i),(0,d.hideElementCursor)(i),e.preventDefault(),(0,c.A)(_),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{annotation:i,viewportIdsToRender:a,handleIndex:s}=this.editData,{data:r}=i,{currentPoints:l}=t,d=(0,o.getEnabledElement)(n),{worldToCanvas:h,canvasToWorld:g}=d.viewport,u=l.world,{points:m}=r.handles;let v,p,f,E,w,I,C,T;switch(m[s]=[...u],s){case 0:case 3:v=h(m[0]),E=h(m[3]),p=[E[0],v[1]],f=[v[0],E[1]],I=g(p),C=g(f),m[1]=I,m[2]=C;break;case 1:case 2:p=h(m[1]),f=h(m[2]),v=[f[0],p[1]],E=[p[0],f[1]],w=g(v),T=g(E),m[0]=w,m[3]=T}i.invalidated=!0,this.editData.hasMoved=!0,(0,c.A)(a)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,newAnnotation:a,hasMoved:s}=this.editData,{data:r}=i;if(a&&!s)return;r.handles.activeHandleIndex=null,this._deactivateDraw(n),(0,d.resetElementCursor)(n);const l=(0,o.getEnabledElement)(n),c={...this.editData,points:r.handles.points,createMemo:this.createMemo.bind(this)};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(l,c),this.doneEditMemo()},this._activateDraw=e=>{e.addEventListener(r.Events.MOUSE_UP,this._endCallback),e.addEventListener(r.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(r.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(r.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(r.Events.TOUCH_END,this._endCallback),e.addEventListener(r.Events.TOUCH_DRAG,this._dragCallback),e.addEventListener(r.Events.TOUCH_TAP,this._endCallback)},this._deactivateDraw=e=>{e.removeEventListener(r.Events.MOUSE_UP,this._endCallback),e.removeEventListener(r.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(r.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(r.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(r.Events.TOUCH_TAP,this._endCallback),e.removeEventListener(r.Events.TOUCH_END,this._endCallback),e.removeEventListener(r.Events.TOUCH_DRAG,this._dragCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:o}=e,{annotation:i}=this.editData,a=i.metadata,s=i.annotationUID,r=i.data,{points:d}=r.handles,c=d.map(e=>o.worldToCanvas(e)),h=`rgb(${a.segmentColor.slice(0,3)})`;if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return(0,l.drawRect)(t,s,"0",c[0],c[3],{color:h}),n=!0,n}}}m.toolName="RectangleScissor";const v=m},38502:(e,t,n)=>{"use strict";n.d(t,{A:()=>v});var o=n(15327),i=n(82056),a=n(2076),s=n(29601),r=n(74347),l=n(60810),d=n(473),c=n(7001),h=n(58640),g=n(25072),u=n(93733);class m extends g.A{static{this.toolName="SegmentBidirectional"}constructor(e={}){super(e),this.renderAnnotation=(e,t)=>{let n=!0;const{viewport:o}=e,{element:l}=o,c=o.id;let h=(0,i.getAnnotations)(this.getToolName(),l);if(!h?.length)return n;if(h=this.filterInteractableAnnotationsForElement(l,h),!h?.length)return n;const g=this.getTargetId(o),m=o.getRenderingEngine(),v={toolGroupId:this.toolGroupId,toolName:this.getToolName(),viewportId:e.viewport.id};for(let i=0;i<h.length;i++){const l=h[i],{annotationUID:p,data:f}=l,{points:E,activeHandleIndex:w}=f.handles,I=E.map(e=>o.worldToCanvas(e));v.annotationUID=p;const{segmentIndex:C,segmentationId:T}=l.metadata,{lineWidth:b,lineDash:A,shadow:_}=this.getAnnotationStyle({annotation:l,styleSpecifier:v}),S=`rgb(${(0,u.getSegmentIndexColor)(c,T,C).slice(0,3).join(",")})`;if(f.cachedStats[g]&&null!=f.cachedStats[g].unit?l.invalidated&&this._throttledCalculateCachedStats(l,m,e):(f.cachedStats[g]={length:null,width:null,unit:null},this._calculateCachedStats(l,m,e)),!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;let D;if(!(0,s.isAnnotationVisible)(p))continue;if((0,a.isAnnotationLocked)(p)||this.editData||null===w||(D=[I[w]]),D){const e="0";(0,r.drawHandles)(t,p,e,D,{color:S})}const y=`${p}-line-1`,M=`${p}-line-2`,x="0";(0,r.drawLine)(t,p,x,I[0],I[1],{color:S,lineWidth:b,lineDash:A,shadow:_},y);const R="1";(0,r.drawLine)(t,p,R,I[2],I[3],{color:S,lineWidth:b,lineDash:A,shadow:_},M),n=!0;const P=this.getLinkedTextBoxStyle(v,l);if(!P.visibility){f.handles.textBox={hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}};continue}P.color=S;const L=this.configuration.getTextLines(f,g);if(!L||0===L.length)continue;let k;f.handles.textBox.hasMoved||(k=(0,d.getTextBoxCoordsCanvas)(I),f.handles.textBox.worldPosition=o.canvasToWorld(k));const O=o.worldToCanvas(f.handles.textBox.worldPosition),U="1",N=(0,r.drawLinkedTextBox)(t,p,U,L,O,I,{},P),{x:V,y:B,width:W,height:H}=N;f.handles.textBox.worldBoundingBox={topLeft:o.canvasToWorld([V,B]),topRight:o.canvasToWorld([V+W,B]),bottomLeft:o.canvasToWorld([V,B+H]),bottomRight:o.canvasToWorld([V+W,B+H])}}return n}}addNewAnnotation(e){const t=e.detail,{currentPoints:n,element:a}=t,s=n.world,r=(0,o.getEnabledElement)(a),{viewport:d}=r;this.isDrawing=!0;const g=d.getCamera(),{viewPlaneNormal:u,viewUp:m}=g,v=this.getReferencedImageId(d,s,u,m),p=d.getFrameOfReferenceUID(),f={highlighted:!0,invalidated:!0,metadata:{toolName:this.getToolName(),viewPlaneNormal:[...u],viewUp:[...m],FrameOfReferenceUID:p,referencedImageId:v,...d.getViewReference({points:[s]})},data:{handles:{points:[[...s],[...s],[...s],[...s]],textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:"",cachedStats:{}}};(0,i.addAnnotation)(f,a);const E=(0,l.getViewportIdsWithToolToRender)(a,this.getToolName());return this.editData={annotation:f,viewportIdsToRender:E,handleIndex:1,movingTextBox:!1,newAnnotation:!0,hasMoved:!1},this._activateDraw(a),(0,c.hideElementCursor)(a),e.preventDefault(),(0,h.A)(E),f}static{this.hydrate=(e,t,n)=>{const a=(0,o.getEnabledElementByViewportId)(e);if(!a)return;const{viewport:s}=a,r=(0,i.getAllAnnotations)().filter(e=>"SegmentBidirectional"===e.metadata.toolName),l=r.find(e=>{const{metadata:t}=e;return t.segmentIndex===n?.segmentIndex&&t.segmentationId===n?.segmentationId});l&&(0,i.removeAnnotation)(l.annotationUID);const{FrameOfReferenceUID:d,referencedImageId:c,viewPlaneNormal:g,instance:u}=this.hydrateBase(m,a,t[0],n),[v,p]=t,[f,E]=v,[w,I]=p,C=[f,E,w,I],{toolInstance:T,...b}=n||{},A={annotationUID:n?.annotationUID||o.utilities.uuidv4(),data:{handles:{points:C,activeHandleIndex:null,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}},cachedStats:{}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{segmentIndex:n?.segmentIndex,segmentationId:n?.segmentationId,toolName:u.getToolName(),viewPlaneNormal:g,FrameOfReferenceUID:d,referencedImageId:c,...b}};return(0,i.addAnnotation)(A,s.element),(0,h.A)([s.id]),A}}}const v=m},987:(e,t,n)=>{"use strict";n.d(t,{A:()=>g});var o=n(15327),i=n(85817),a=n(49906),s=n(58640),r=n(26228),l=n(93759),d=n(85204),c=n(74347);class h extends i.oS{constructor(e={data:{handles:{textBox:{worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}}},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{hoverTimeout:100,searchRadius:6}}){super(e,t),this.mouseMoveCallback=e=>(this.hoverTimer&&clearTimeout(this.hoverTimer),this.hoverTimer=setTimeout(()=>{this._setHoveredSegment(e),this.hoverTimer=null},this.configuration.hoverTimeout),!0),this.onSetToolEnabled=()=>{this.onSetToolActive()},this.onSetToolActive=()=>{this.hoverTimer=null},this.onSetToolDisabled=()=>{this.hoverTimer=null},this.data=e.data??{handles:{textBox:{worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}}}},this.hoverTimer=null}_setHoveredSegment(e={}){if(d.wk.isInteractingWithTool)return;const{element:t,currentPoints:n}=e.detail,i=n.world,a=(0,o.getEnabledElement)(t);if(!a)return;const{viewport:s}=a,l=(0,r.getActiveSegmentation)(s.id);l&&this._setHoveredSegmentForType(l,i,s)}_setHoveredSegmentForType(e,t,n){if(!n.getImageData())return;const{segmentationId:o}=e,i=(0,l.getSegmentIndexAtWorldPoint)(o,t,{viewport:n}),r=e.segments[i],d=r?.label,c=n.worldToCanvas(t);if(this._editData={hoveredSegmentIndex:i,hoveredSegmentLabel:d,canvasCoordinates:c,worldPoint:t},!i||0===i)return;const h=n.getRenderingEngine().getViewports().map(e=>e.id);(0,a.triggerSegmentationModified)(o),(0,s.A)(h)}renderAnnotation(e,t){if(!this._editData)return;const{viewport:n}=e,{hoveredSegmentIndex:o,hoveredSegmentLabel:i,canvasCoordinates:a,worldPoint:s}=this._editData;if(!o)return;const r=n.worldToCanvas(s),l=(0,c.drawLinkedTextBox)(t,"segmentSelectLabelAnnotation","segmentSelectLabelTextBox",[i||"(unnamed segment)"],r,[a],{},{}),d=a[0],h=a[1],{width:g,height:u}=l;this.data.handles.textBox.worldBoundingBox={topLeft:n.canvasToWorld([d,h]),topRight:n.canvasToWorld([d+g,h]),bottomLeft:n.canvasToWorld([d,h+u]),bottomRight:n.canvasToWorld([d+g,h+u])}}}h.toolName="SegmentLabelTool";const g=h},12905:(e,t,n)=>{"use strict";n.d(t,{A:()=>u});var o=n(15327),i=n(85817),a=n(49906),s=n(58640),r=n(26228),l=n(70930),d=n(93759),c=n(85204),h=n(99737);class g extends i.oS{static{this.SelectMode={Inside:"Inside",Border:"Border"}}constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{hoverTimeout:100,mode:g.SelectMode.Border,searchRadius:6}}){super(e,t),this.mouseMoveCallback=e=>{if(this.mode===h.ToolModes.Active)return this.hoverTimer&&clearTimeout(this.hoverTimer),this.hoverTimer=setTimeout(()=>{this._setActiveSegment(e),this.hoverTimer=null},this.configuration.hoverTimeout),!0},this.onSetToolEnabled=()=>{this.onSetToolActive()},this.onSetToolActive=()=>{this.hoverTimer=null},this.onSetToolDisabled=()=>{this.hoverTimer=null},this.hoverTimer=null}_setActiveSegment(e={}){if(c.wk.isInteractingWithTool)return;const{element:t,currentPoints:n}=e.detail,i=n.world,a=(0,o.getEnabledElement)(t);if(!a)return;const{viewport:s}=a,l=(0,r.getActiveSegmentation)(s.id);l&&this._setActiveSegmentForType(l,i,s)}_setActiveSegmentForType(e,t,n){if(!n.getImageData())return;const{segmentationId:o,representationData:i}=e;let r;if(this.configuration.mode===g.SelectMode.Inside?r=(0,d.getSegmentIndexAtWorldPoint)(o,t,{viewport:n}):i.Labelmap?r=(0,d.getSegmentIndexAtLabelmapBorder)(o,t,{viewport:n,searchRadius:this.configuration.searchRadius}):i.Contour?r=(0,d.getHoveredContourSegmentationAnnotation)(o):i.Surface,!r||0===r)return;(0,l.setActiveSegmentIndex)(o,r);const c=n.getRenderingEngine().getViewports().map(e=>e.id);(0,a.triggerSegmentationModified)(o),(0,s.A)(c)}}g.toolName="SegmentSelectTool";const u=g},10804:(e,t,n)=>{"use strict";n.d(t,{A:()=>m});var o=n(15327),i=n(17492),a=n(1989),s=n(99737),r=n(74347),l=n(7001),d=n(58640),c=n(90713),h=n(98870),g=n(23631);class u extends g.A{constructor(e={},t={supportedInteractionTypes:["Mouse","Touch"],configuration:{strategies:{FILL_INSIDE:i.Jq,ERASE_INSIDE:a._},defaultStrategy:"FILL_INSIDE",activeStrategy:"FILL_INSIDE"}}){super(e,t),this.preMouseDownCallback=e=>{if(!0===this.isDrawing)return;this.doneEditMemo();const t=e.detail,{currentPoints:n,element:i}=t,a=n.world,s=n.canvas,r=(0,o.getEnabledElement)(i),{viewport:g}=r;this.isDrawing=!0;const u=g.getCamera(),{viewPlaneNormal:m,viewUp:v}=u,p=c.activeSegmentation.getActiveSegmentation(g.id);if(!p)throw new Error("No active segmentation detected, create one before using scissors tool");const{segmentationId:f}=p,E=c.segmentIndex.getActiveSegmentIndex(f),w=c.segmentLocking.getLockedSegmentIndices(f),I=c.config.color.getSegmentIndexColor(g.id,f,E);this.isDrawing=!0;const C={metadata:{viewPlaneNormal:[...m],viewUp:[...v],FrameOfReferenceUID:g.getFrameOfReferenceUID(),referencedImageId:"",toolName:this.getToolName(),segmentColor:I},data:{invalidated:!0,handles:{points:[[...a],[...a],[...a],[...a]],activeHandleIndex:null},cachedStats:{},highlighted:!0}},T=[g.id];this.editData={annotation:C,centerCanvas:s,segmentIndex:E,segmentationId:f,segmentsLocked:w,segmentColor:I,toolGroupId:this.toolGroupId,viewportIdsToRender:T,handleIndex:3,movingTextBox:!1,newAnnotation:!0,hasMoved:!1,volumeId:null,referencedVolumeId:null,imageId:null};const{representationData:b}=(0,h.getSegmentation)(f),A=this.getEditData({viewport:g,representationData:b,segmentsLocked:w,segmentationId:f});return this.editData={...this.editData,...A},this._activateDraw(i),(0,l.hideElementCursor)(i),e.preventDefault(),(0,d.A)(T),!0},this._dragCallback=e=>{this.isDrawing=!0;const t=e.detail,{element:n}=t,{currentPoints:i}=t,a=i.canvas,s=(0,o.getEnabledElement)(n),{renderingEngine:r,viewport:l}=s,{canvasToWorld:c}=l,{annotation:h,viewportIdsToRender:g,centerCanvas:u}=this.editData,{data:m}=h,v=Math.abs(a[0]-u[0]),p=Math.abs(a[1]-u[1]),f=Math.sqrt(v*v+p*p),E=[u[0],u[1]+f],w=[u[0],u[1]-f],I=[u[0]-f,u[1]],C=[u[0]+f,u[1]];m.handles.points=[c(E),c(w),c(I),c(C)],h.invalidated=!0,this.editData.hasMoved=!0,(0,d.A)(g)},this._endCallback=e=>{const t=e.detail,{element:n}=t,{annotation:i,newAnnotation:a,hasMoved:s,segmentIndex:r,segmentsLocked:d}=this.editData,{data:c}=i,{viewPlaneNormal:h,viewUp:g}=i.metadata;if(a&&!s)return;i.highlighted=!1,c.handles.activeHandleIndex=null,this._deactivateDraw(n),(0,l.resetElementCursor)(n);const u=(0,o.getEnabledElement)(n),m={...this.editData,points:c.handles.points,segmentIndex:r,segmentsLocked:d,viewPlaneNormal:h,viewUp:g,createMemo:this.createMemo.bind(this)};this.editData=null,this.isDrawing=!1,this.applyActiveStrategy(u,m),this.doneEditMemo()},this._activateDraw=e=>{e.addEventListener(s.Events.MOUSE_UP,this._endCallback),e.addEventListener(s.Events.MOUSE_DRAG,this._dragCallback),e.addEventListener(s.Events.MOUSE_CLICK,this._endCallback),e.addEventListener(s.Events.MOUSE_MOVE,this._dragCallback),e.addEventListener(s.Events.TOUCH_END,this._endCallback),e.addEventListener(s.Events.TOUCH_TAP,this._endCallback),e.addEventListener(s.Events.TOUCH_DRAG,this._dragCallback)},this._deactivateDraw=e=>{e.removeEventListener(s.Events.MOUSE_UP,this._endCallback),e.removeEventListener(s.Events.MOUSE_DRAG,this._dragCallback),e.removeEventListener(s.Events.MOUSE_CLICK,this._endCallback),e.removeEventListener(s.Events.MOUSE_MOVE,this._dragCallback),e.removeEventListener(s.Events.TOUCH_END,this._endCallback),e.removeEventListener(s.Events.TOUCH_DRAG,this._dragCallback),e.removeEventListener(s.Events.TOUCH_TAP,this._endCallback)},this.renderAnnotation=(e,t)=>{let n=!1;if(!this.editData)return n;const{viewport:o}=e,{viewportIdsToRender:i}=this.editData;if(!i.includes(o.id))return n;const{annotation:a}=this.editData,s=a.metadata,l=a.annotationUID,d=a.data,{points:c}=d.handles,h=c.map(e=>o.worldToCanvas(e)),g=h[0],u=h[1],m=[Math.floor((g[0]+u[0])/2),Math.floor((g[1]+u[1])/2)],v=Math.abs(g[1]-Math.floor((g[1]+u[1])/2)),p=`rgb(${s.segmentColor.slice(0,3)})`;if(!o.getRenderingEngine())return console.warn("Rendering Engine has been destroyed"),n;return(0,r.drawCircle)(t,l,"0",m,v,{color:p}),n=!0,n}}}u.toolName="SphereScissor";const m=u},62753:(e,t,n)=>{"use strict";n.d(t,{A:()=>r});var o=n(15327),i=n(84093),a=n(33283),s=n(83075);const r={[i.A.EnsureImageVolumeFor3DManipulation]:e=>{const{operationData:t,viewport:n}=e;let i;if(n){i=n.getImageIds();if(!o.utilities.isValidVolume(i))throw new Error("Volume is not reconstructable for sphere manipulation")}else{i=(0,a.T)(t.segmentationId).representationData.Labelmap.imageIds.map(e=>o.cache.getImage(e).referencedImageId)}const r=(0,s.A)(i);if(!r)throw new Error("Failed to create or get image volume");t.imageVoxelManager=r.voxelManager,t.imageData=r.imageData}}},38732:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(15327),i=n(84093),a=n(30722);const s={[i.A.EnsureSegmentationVolumeFor3DManipulation]:e=>{const{operationData:t,viewport:n}=e,{segmentationId:i,imageIds:s}=t,r=n?n.getImageIds():s.map(e=>o.cache.getImage(e).referencedImageId);if(!o.utilities.isValidVolume(r))throw new Error("Volume is not reconstructable for sphere manipulation");const l=(0,a.A)(i);l&&(t.segmentationVoxelManager=l.voxelManager,t.segmentationImageData=l.imageData)}}},56789:(e,t,n)=>{"use strict";n.d(t,{N5:()=>w,kr:()=>f,mu:()=>m,pB:()=>v,q:()=>E});var o=n(3823),i=n(15327),a=n(11683),s=n(72282),r=n(55887),l=n(99737),d=n(11990),c=n(62783);const{transformWorldToIndex:h,isEqual:g}=i.utilities,u={[l.StrategyCallbacks.Initialize]:e=>{const{points:t,viewport:n,segmentationImageData:i}=e;if(!t)return;const r=o.eR.fromValues(0,0,0);t.forEach(e=>{o.eR.add(r,r,e)}),o.eR.scale(r,r,1/t.length),e.centerWorld=r,e.centerIJK=h(i,r);const l=t.map(e=>n.worldToCanvas(e)),[d,c]=(0,a.getCanvasEllipseCorners)(l),g=n.canvasToWorld(d),u=n.canvasToWorld(c),v=t.map(e=>h(i,e)),p=(0,s.getBoundingBoxAroundShapeIJK)(v,i.getDimensions());e.isInObject=m({topLeftWorld:g,bottomRightWorld:u,center:r}),e.isInObjectBoundsIJK=p}};function m(e){const{topLeftWorld:t,bottomRightWorld:n,center:o}=e,i=Math.abs(t[0]-n[0])/2,s=Math.abs(t[1]-n[1])/2,r=Math.abs(t[2]-n[2])/2,l=Math.max(i,s,r);if(g(i,l)&&g(s,l)&&g(r,l)){const e={center:o,radius:l,radius2:l*l};return t=>(0,c.d)(e,t)}const d={center:o,xRadius:i,yRadius:s,zRadius:r},{precalculated:h}=(0,a.precalculatePointInEllipse)(d,{});return h}const v=new r.A("Circle",d.A.regionFill,d.A.setValue,u,d.A.determineSegmentIndex,d.A.preview,d.A.labelmapStatistics),p=new r.A("CircleThreshold",d.A.regionFill,d.A.setValue,u,d.A.determineSegmentIndex,d.A.dynamicThreshold,d.A.threshold,d.A.preview,d.A.islandRemoval,d.A.labelmapStatistics),f=v.strategyFunction,E=p.strategyFunction;function w(){throw new Error("Not yet implemented")}},10088:(e,t,n)=>{"use strict";n.d(t,{VQ:()=>v,pY:()=>m});var o=n(3823),i=n(15327),a=n(72282),s=(n(49906),n(40905),n(26384)),r=n(55887),l=n(99737),d=n(11990);const{transformWorldToIndex:c}=i.utilities,h={[l.StrategyCallbacks.Initialize]:e=>{const{points:t,imageVoxelManager:n,viewport:r,segmentationImageData:l,segmentationVoxelManager:d}=e;if(!t)return;const h=o.eR.fromValues(0,0,0);t.forEach(e=>{o.eR.add(h,h,e)}),o.eR.scale(h,h,1/t.length),e.centerWorld=h,e.centerIJK=c(l,h);const{boundsIJK:g,pointInShapeFn:u}=function(e,t,n){let o=t.map(e=>c(n,e));o=o.map(e=>e.map(e=>Math.round(e)));const r=(0,a.getBoundingBoxAroundShapeIJK)(o,n.getDimensions()),l=e instanceof i.StackViewport,d=l||(0,s.l)(o),h=n.getDirection(),g=n.getSpacing(),{viewPlaneNormal:u}=e.getCamera(),m=i.utilities.getSpacingInNormalDirection({direction:h,spacing:g},u),v=(0,a.getBoundingBoxAroundShapeWorld)(t);let[[p,f],[E,w],[I,C]]=v;p-=m,f+=m,E-=m,w+=m,I-=m,C+=m;const T=d?()=>!0:e=>{const[t,n,o]=e;return t>=p&&t<=f&&(n>=E&&n<=w)&&(o>=I&&o<=C)};return{boundsIJK:r,pointInShapeFn:T}}(r,t,l);e.isInObject=u,e.isInObjectBoundsIJK=g}};const g=new r.A("Rectangle",d.A.regionFill,d.A.setValue,h,d.A.determineSegmentIndex,d.A.preview,d.A.labelmapStatistics),u=new r.A("RectangleThreshold",d.A.regionFill,d.A.setValue,h,d.A.determineSegmentIndex,d.A.dynamicThreshold,d.A.threshold,d.A.preview,d.A.islandRemoval,d.A.labelmapStatistics),m=g.strategyFunction,v=u.strategyFunction},99522:(e,t,n)=>{"use strict";n.r(t),n.d(t,{fillInsideCircle:()=>i.kr,fillInsideRectangle:()=>o.pY,fillOutsideCircle:()=>i.N5,thresholdInsideRectangle:()=>o.VQ});var o=n(10088),i=n(56789)},93126:(e,t,n)=>{"use strict";var o;n.d(t,{W:()=>o}),function(e){e[e.CounterClockwise=-1]="CounterClockwise",e[e.Unknown=0]="Unknown",e[e.Clockwise=1]="Clockwise"}(o||(o={}))},13369:()=>{},16678:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(15327),i=n(94021),a=n(99737);class s{static setStartRange(e,t,n=e.getCurrentImageIdIndex()){this.setRange(e,t,n)}static setEndRange(e,t,n=e.getCurrentImageIdIndex()){this.setRange(e,t,void 0,n)}static setRange(e,t,n,s){const{metadata:r}=t;void 0===n&&(n=r.sliceIndex<s?r.sliceIndex:0,void 0===s&&(s=e.getNumberOfSlices()-1));const l=e.getSliceIndexForImage(r.multiSliceReference);void 0===s&&(s=l>=n?l:e.getNumberOfSlices()-1),s=Math.max(n,s),r.sliceIndex=Math.min(n,s),r.referencedImageId=e.getCurrentImageId(r.sliceIndex),r.referencedImageURI=void 0,s===r.sliceIndex?r.multiSliceReference=void 0:s!==r.multiSliceReference?.sliceIndex&&(r.multiSliceReference={referencedImageId:e.getCurrentImageId(s),sliceIndex:s});const d={viewportId:e.id,renderingEngineId:e.renderingEngineId,changeType:a.ChangeTypes.MetadataReferenceModified,annotation:t};(0,o.triggerEvent)(o.eventTarget,i.A.ANNOTATION_MODIFIED,d),this.setViewportFrameRange(e,r)}static setSingle(e,t,n=e.getCurrentImageIdIndex()){this.setRange(e,t,n,n)}static getFrameRange(e){const{metadata:t}=e,{sliceIndex:n,multiSliceReference:o}=t,i=o?.sliceIndex;return i?[n+1,i+1]:n+1}static getFrameRangeStr(e){const t=this.getFrameRange(e);return Array.isArray(t)?`${t[0]}-${t[1]}`:String(t)}static setViewportFrameRange(e,t){e.setFrameRange&&t.multiSliceReference?.sliceIndex&&e.setFrameRange(t.sliceIndex+1,t.multiSliceReference.sliceIndex+1)}}},64485:(e,t,n)=>{"use strict";n.d(t,{i:()=>s,x:()=>l});var o=n(15327),i=n(82056),a=n(3823);function s(e,t,n,a){const s=e.getViewReference(),{viewPlaneNormal:l,FrameOfReferenceUID:d}=s,c={annotationUID:a?.annotationUID||o.utilities.uuidv4(),data:{handles:{points:n}},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:t,viewPlaneNormal:l,FrameOfReferenceUID:d,referencedImageId:r(e,n[0],l),...a}};return(0,i.addAnnotation)(c,e.element),c}function r(e,t,n){let i;if(e instanceof o.StackViewport)i=l(e,t,n);else{if(!(e instanceof o.BaseVolumeViewport))throw new Error("getReferencedImageId: viewport must be a StackViewport or BaseVolumeViewport");{const a=function(e){const t=e.getViewReferenceId?.();if(t)return t;if(e instanceof o.BaseVolumeViewport)return`volumeId:${function(e){const t=e.getActors();if(!t)return;return t.find(e=>"vtkVolume"===e.actor.getClassName())?.uid}(e)}`;throw new Error("getTargetId: viewport must have a getTargetId method")}(e),s=o.utilities.getVolumeId(a),r=o.cache.getVolume(s);i=o.utilities.getClosestImageId(r,t,n)}}return i}function l(e,t,n){const i=e.getImageIds();if(!i||!i.length)return;const s=i.map(e=>{const{imagePositionPatient:i}=o.metaData.get("imagePlaneModule",e),s=function(e,t,n){const o=a.eR.create();a.eR.sub(o,e,t);const i=a.eR.dot(o,n);return Math.abs(i)}(t,i,n);return{imageId:e,distance:s}});return s.sort((e,t)=>e.distance-t.distance),s[0].imageId}},76802:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});const o=function(e,t){const n=e.findIndex(([e,t])=>e===t);if(-1===n)throw new Error("3D bounding boxes not supported in an oblique plane");return e[n][0]-=t,e[n][1]+=t,e}},87063:(e,t,n)=>{"use strict";n.d(t,{C:()=>r,g:()=>s});var o=n(15327);const{EPSILON:i}=o.CONSTANTS;function a(e,t,n=!1){let o=1/0,a=n?-1/0:0,s=1/0,r=n?-1/0:0,l=1/0,d=n?-1/0:0;const c=3===e[0]?.length;for(let t=0;t<e.length;t++){const n=e[t];o=Math.min(n[0],o),a=Math.max(n[0],a),s=Math.min(n[1],s),r=Math.max(n[1],r),c&&(l=Math.min(n[2]??l,l),d=Math.max(n[2]??d,d))}return t?(o=Math.max(n?t[0]+i:0,o),a=Math.min(n?t[0]-i:t[0]-1,a),s=Math.max(n?t[1]+i:0,s),r=Math.min(n?t[1]-i:t[1]-1,r),c&&3===t.length&&(l=Math.max(n?t[2]+i:0,l),d=Math.min(n?t[2]-i:t[2]-1,d))):n||(o=Math.max(0,o),a=Math.min(1/0,a),s=Math.max(0,s),r=Math.min(1/0,r),c&&(l=Math.max(0,l),d=Math.min(1/0,d))),c?[[o,a],[s,r],[l,d]]:[[o,a],[s,r],null]}function s(e,t){return a(e,t,!1)}function r(e,t){return a(e,t,!0)}},72282:(e,t,n)=>{"use strict";n.r(t),n.d(t,{extend2DBoundingBoxInViewAxis:()=>o.A,getBoundingBoxAroundShape:()=>i.g,getBoundingBoxAroundShapeIJK:()=>i.g,getBoundingBoxAroundShapeWorld:()=>i.C});var o=n(76802),i=n(87063)},58271:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var o=n(15327);const{calibratedPixelSpacingMetadataProvider:i}=o.utilities;function a(e,t,n){"number"==typeof n&&(n={type:o.Enums.CalibrationTypes.USER,scale:n}),i.add(e,n);t.getStackViewports().forEach(t=>{t.getImageIds().includes(e)&&t.calibrateSpacing(e)})}},14655:(e,t,n)=>{"use strict";var o;n.d(t,{A:()=>i}),function(e){e.CLIP_STOPPED="CORNERSTONE_CINE_TOOL_STOPPED",e.CLIP_STARTED="CORNERSTONE_CINE_TOOL_STARTED"}(o||(o={}));const i=o},67108:(e,t,n)=>{"use strict";n.r(t),n.d(t,{Events:()=>i.A,addToolState:()=>a.Pi,getToolState:()=>a.k6,playClip:()=>o.n,stopClip:()=>o.D});var o=n(53322),i=n(14655),a=n(36085)},53322:(e,t,n)=>{"use strict";n.d(t,{D:()=>g,n:()=>h});var o=n(3823),i=n(15327),a=n(14655),s=n(36085);const{ViewportStatus:r}=i.Enums,{triggerEvent:l}=i.utilities,d=!0,c=new Map;function h(e,t){let n,h;if(void 0===e)throw new Error("playClip: element must not be undefined");const g=(0,i.getEnabledElement)(e);if(!g)throw new Error("playClip: element must be a valid Cornerstone enabled element");t||(t={}),t.dynamicCineEnabled=t.dynamicCineEnabled??!0;const{viewport:f}=g,E=function(e,t){if(e instanceof i.StackViewport)return function(e,t){const n=e.getImageIds();return{get numScrollSteps(){return n.length},get currentStepIndex(){return e.getTargetImageIdIndex()},get frameTimeVectorEnabled(){return!0},waitForRenderedCount:0,scroll(n){this.waitForRenderedCount<=t&&e.viewportStatus!==r.RENDERED?this.waitForRenderedCount++:(this.waitForRenderedCount=0,i.utilities.scroll(e,{delta:n,debounceLoading:d}))}}}(e,t.waitForRendered??30);if(e instanceof i.VolumeViewport){const n=p(e);return t.dynamicCineEnabled&&n?.isDynamicVolume()?function(e){return{get numScrollSteps(){return e.numDimensionGroups},get currentStepIndex(){return e.dimensionGroupNumber-1},get frameTimeVectorEnabled(){return!1},scroll(t){e.scroll(t)}}}(n):function(e,t){const{volumeId:n}=t,a={viewPlaneNormal:o.eR.create(),scrollInfo:null},s=()=>{const t=e.getCamera();if(!a.scrollInfo||!o.eR.equals(t.viewPlaneNormal,a.viewPlaneNormal)){const o=i.utilities.getVolumeViewportScrollInfo(e,n);a.viewPlaneNormal=t.viewPlaneNormal,a.scrollInfo=o}return a.scrollInfo};return{get numScrollSteps(){return s().numScrollSteps},get currentStepIndex(){return s().currentStepIndex},get frameTimeVectorEnabled(){const n=e.getCamera(),i=t.direction.slice(6,9).map(e=>-e),a=o.eR.dot(i,n.viewPlaneNormal);return o.Fd.equals(a,1)},scroll(t){s().currentStepIndex+=t,i.utilities.scroll(e,{delta:t})}}}(e,n)}if(e instanceof i.VideoViewport)return function(e,t){return{get numScrollSteps(){return e.getNumberOfSlices()},get currentStepIndex(){return e.getSliceIndex()},get frameTimeVectorEnabled(){return!0},waitForRenderedCount:0,scroll(n){this.waitForRenderedCount<=t&&e.viewportStatus!==r.RENDERED?this.waitForRenderedCount++:(this.waitForRenderedCount=0,i.utilities.scroll(e,{delta:n,debounceLoading:d}))},play:t=>(t&&e.setPlaybackRate(t/24),e.play(),e.getFrameRate())}}(e,t.waitForRendered??30);throw new Error("Unknown viewport type")}(f,t);let w=(0,s.k6)(e);const I=t.dynamicCineEnabled;if(I&&m(e),w?u(e,{stopDynamicCine:!I,viewportId:f.id}):(w={intervalId:void 0,framesPerSecond:30,lastFrameTimeStamp:void 0,ignoreFrameTimeVector:!1,usingFrameTimeVector:!1,frameTimeVector:t.frameTimeVector??void 0,speed:t.frameTimeVectorSpeedMultiplier??1,reverse:t.reverse??!1,loop:t.loop??!0,bounce:t.bounce??!1},(0,s.Pi)(e,w)),w.dynamicCineEnabled=t.dynamicCineEnabled,(t.framesPerSecond<0||t.framesPerSecond>0)&&(w.framesPerSecond=Number(t.framesPerSecond),w.reverse=w.framesPerSecond<0,w.ignoreFrameTimeVector=!0),!0!==w.ignoreFrameTimeVector&&w.frameTimeVector&&w.frameTimeVector.length===E.numScrollSteps&&E.frameTimeVectorEnabled){const{timeouts:e,isTimeVarying:t}=function(e,t){let n,o,i,a=0;const s=e.length,r=[];let l=!1;("number"!=typeof t||t<=0)&&(t=1);for(n=1;n<s;n++)i=Number(e[n])/t|0,r.push(i),1===n?o=i:i!==o&&(l=!0),a+=i;r.length>0&&(i=l?a/r.length|0:r[0],r.push(i));return{timeouts:r,isTimeVarying:l}}(w.frameTimeVector,w.speed);n=e,h=t}void 0!==t.bounce&&(w.bounce=t.bounce);const C=()=>{const{numScrollSteps:t,currentStepIndex:n}=E;let o=n+(w.reverse?-1:1);if(o<0||o>=t)if(w.bounce)w.reverse=!w.reverse,o=n+(w.reverse?-1:1),o=Math.max(0,Math.min(t-1,o));else{if(!w.loop)return u(e,{stopDynamicCine:!I,viewportId:f.id}),void l(e,a.A.CLIP_STOPPED,{element:e});o=w.reverse?t-1:0}const i=o-n;if(i)try{E.scroll(i)}catch(t){console.warn("Play clip not scrolling",t),v(w),l(e,a.A.CLIP_STOPPED,{element:e})}};if(I){const t=p(f);t&&c.set(t.volumeId,e)}E.play?w.framesPerSecond=E.play(t.framesPerSecond):n&&n.length>0&&h?(w.usingFrameTimeVector=!0,w.intervalId=window.setTimeout(function e(){w.intervalId=window.setTimeout(e,n[E.currentStepIndex]),C()},0)):(w.usingFrameTimeVector=!1,w.intervalId=window.setInterval(C,1e3/Math.abs(w.framesPerSecond)));const T={element:e};l(e,a.A.CLIP_STARTED,T)}function g(e,t={}){u(e,{stopDynamicCine:!0,...t})}function u(e,t={stopDynamicCine:!0,viewportId:void 0}){const{stopDynamicCine:n,viewportId:o}=t,a=(0,i.getEnabledElement)(e);let r;const l=a?.viewport;if(a){const{viewport:e}=a;r=(0,s.k6)(e.element)}else{if(!o)return;r=(0,s.CS)(o)}r&&v(r),l instanceof i.VideoViewport?l.pause():n&&l instanceof i.BaseVolumeViewport&&m(e)}function m(e){const{viewport:t}=(0,i.getEnabledElement)(e);if(t instanceof i.VolumeViewport){const n=p(t);if(n?.isDynamicVolume()){const t=c.get(n.volumeId);c.delete(n.volumeId),t&&t!==e&&g(t)}}}function v(e){const t=e.intervalId;void 0!==t&&(e.intervalId=void 0,e.usingFrameTimeVector?clearTimeout(t):clearInterval(t))}function p(e){if(!(e instanceof i.VolumeViewport))return;const t=e.getAllVolumeIds();if(!t?.length)return;const n=t.find(e=>i.cache.getVolume(e)?.isDynamicVolume()),o=n??t[0];return i.cache.getVolume(o)}},36085:(e,t,n)=>{"use strict";n.d(t,{CS:()=>r,Pi:()=>a,k6:()=>s});var o=n(15327);const i={};function a(e,t){const n=(0,o.getEnabledElement)(e),{viewportId:a}=n;i[a]=t}function s(e){const t=(0,o.getEnabledElement)(e),{viewportId:n}=t;return i[n]}function r(e){return i[e]}},85263:(e,t,n)=>{"use strict";n.d(t,{V:()=>i});var o=n(33283);function i(e){if(e.parentAnnotationUID)return;if(!e.data.segmentation)throw new Error("addContourSegmentationAnnotation: annotation does not have a segmentation data");const{segmentationId:t,segmentIndex:n}=e.data.segmentation,i=(0,o.T)(t);i.representationData.Contour||(i.representationData.Contour={annotationUIDsMap:new Map});let{annotationUIDsMap:a}=i.representationData.Contour;a||(a=new Map);let s=a?.get(n);s||(s=new Set,a.set(n,s)),a.set(n,s.add(e.annotationUID))}},62854:(e,t,n)=>{"use strict";function o(e,t){const{segmentation:n}=e.data,{segmentation:o}=t.data;return n.segmentationId===o.segmentationId&&n.segmentIndex===o.segmentIndex}n.d(t,{A:()=>o})},1318:(e,t,n)=>{"use strict";n.d(t,{u:()=>s});var o=n(82056),i=n(15295),a=n(65172);async function s(e,t,n,s=!0){const r="string"==typeof e?(0,o.getAnnotation)(e):e,l="string"==typeof t?(0,o.getAnnotation)(t):t;if(!r||!l)throw new Error("Both source and target annotations must be valid");n||(n=function(e){const t=(0,i.A)(e);if(!t.length)throw new Error("No viewport found for the annotation");return t[0]}(r));const d=(0,a.RZ)(r.data.contour.polyline,n),c=(0,a.RZ)(l.data.contour.polyline,n),h=(0,a.KN)(d,c);if(h.hasIntersection)if(h.isContourHole){if(!s)return void console.warn("Hole processing is disabled");(0,a.rK)(n,l,r)}else(0,a.pH)(n,l,c,r,d);else console.warn("No intersection found between the two annotations")}},3444:(e,t,n)=>{"use strict";n.d(t,{h:()=>i});var o=n(95527);function i(e,t,n){const i=[],s=o.polyline.getAABB(t);for(let r=0;r<n.length;r++){const l=n[r],d=a(l.data.contour.polyline,e),c=o.polyline.getAABB(d);if(!o.aabb.intersectAABB(s,c))continue;const h=o.polyline.intersectPolyline(t,d),g=!h&&o.polyline.containsPoints(d,t);(h||g)&&i.push({targetAnnotation:l,targetPolyline:d,isContourHole:g})}return i}function a(e,t){const n=e.length,o=new Array(n);for(let i=0;i<n;i++)o[i]=t.worldToCanvas(e[i]);return o}},56534:(e,t,n)=>{"use strict";n.r(t),n.d(t,{addContourSegmentationAnnotation:()=>r.V,addition:()=>c.f,areSameSegment:()=>o.A,checkIntersection:()=>v.KN,combinePolylines:()=>v.pH,contourSegmentationOperation:()=>m.u,convertContourPolylineToCanvasSpace:()=>v.RZ,convertContourPolylineToWorld:()=>v.vV,convertContourSegmentationAnnotation:()=>d,createNewAnnotationFromPolyline:()=>v.oN,createPolylineHole:()=>v.rK,findAllIntersectingContours:()=>g.h,getContourHolesData:()=>v.Yo,isContourSegmentationAnnotation:()=>h.A,processMultipleIntersections:()=>u.A,removeContourSegmentationAnnotation:()=>s.M,subtractAnnotationPolylines:()=>p.nP,subtractMultiplePolylineSets:()=>p.Gu,subtractPolylineSets:()=>p.on,subtraction:()=>c.d,unifyAnnotationPolylines:()=>p.gI,unifyMultiplePolylineSets:()=>p.xW,unifyPolylineSets:()=>p.vL,updateViewportsForAnnotations:()=>v.AL});var o=n(62854),i=n(15327),a=n(6802),s=n(37354),r=n(85263);const l="PlanarFreehandContourSegmentationTool";function d(e){const{polyline:t}=e.data?.contour||{};if(!t||t.length<3)return void console.warn("Skipping creation of new annotation due to invalid polyline:",t);(0,a.O8)(e.annotationUID),(0,s.M)(e);const n=t[0],o=t[t.length-1],d={metadata:{...e.metadata,toolName:l,originalToolName:e.metadata.originalToolName||e.metadata.toolName},data:{cachedStats:{},handles:{points:[n,o],textBox:e.data.handles.textBox?{...e.data.handles.textBox}:void 0},contour:{...e.data.contour},spline:e.data.spline,segmentation:{...e.data.segmentation}},annotationUID:i.utilities.uuidv4(),highlighted:!0,invalidated:!0,isLocked:!1,isVisible:void 0,interpolationUID:e.interpolationUID,interpolationCompleted:e.interpolationCompleted};return(0,a.lC)(d,e.metadata.FrameOfReferenceUID),(0,r.V)(d),d}var c=n(21536),h=n(78130),g=n(3444),u=n(49941),m=n(1318),v=n(65172),p=n(43185)},78130:(e,t,n)=>{"use strict";function o(e){return!!e.data?.segmentation}n.d(t,{A:()=>o})},21536:(e,t,n)=>{"use strict";n.d(t,{f:()=>h,d:()=>g});var o=n(6802),i=n(65172),a=n(43185),s=n(15327);const r="PlanarFreehandContourSegmentationTool";function l(e,t,n,i){const a=new Map;return n.forEach(n=>{if(n.length<3)return;const l={annotationUID:s.utilities.uuidv4(),data:{contour:{closed:!0,polyline:n},segmentation:{segmentationId:t,segmentIndex:i},handles:{}},handles:{},highlighted:!1,autoGenerated:!1,invalidated:!1,isLocked:!1,isVisible:!0,metadata:{toolName:r,...e.getViewReference()}};(0,o.lC)(l,e.element);const d=a?.get(i)||new Set;d.add(l.annotationUID),a.set(i,d)}),a}function d(e,t){const n=[],{annotationUIDsMap:i}=e,a=i.get(t);for(const e of a){const t=(0,o.gw)(e),{polyline:i}=t.data.contour;n.push(i)}return n}function c(e,t,n,o){if(!t)return;if(!t.representationData.Contour)return;const a=t.representationData.Contour,{annotationUIDsMap:s}=a;if(!s)return;if(!s.get(n))return;if(!s.get(o))return;const r=d(a,n),l=d(a,o);return{polyLinesCanvas1:r.map(t=>(0,i.RZ)(t,e)),polyLinesCanvas2:l.map(t=>(0,i.RZ)(t,e))}}function h(e,t,n,o,{name:s,segmentIndex:r,color:d}){const{polyLinesCanvas1:h,polyLinesCanvas2:g}=c(e,t,n,o)||{};if(!h||g)return;const u=(0,a.vL)(h,g).map(t=>(0,i.vV)(t,e)),m=l(e,t.segmentationId,u,r),v=t.representationData.Contour,{annotationUIDsMap:p}=v;p&&p.set(r,m.get(r))}function g(e,t,n,o,{name:s,segmentIndex:r,color:d}){const{polyLinesCanvas1:h,polyLinesCanvas2:g}=c(e,t,n,o)||{};if(!h||g)return;const u=(0,a.on)(h,g).map(t=>(0,i.vV)(t,e)),m=l(e,t.segmentationId,u,r),v=t.representationData.Contour,{annotationUIDsMap:p}=v;p&&p.set(r,m.get(r))}},49941:(e,t,n)=>{"use strict";n.d(t,{A:()=>v});var o=n(15327),i=n(93126),a=n(95527),s=n(72967),r=n(82056),l=n(85263),d=n(37354),c=n(44049),h=n(58640),g=n(60810),u=n(68040);const m="PlanarFreehandContourSegmentationTool";function v(e,t,n,h){const g=h.filter(e=>e.isContourHole),v=h.filter(e=>!e.isContourHole);if(g.length>0){const n=g[0];return function(e,t,n){(0,r.addChildAnnotation)(t,n),(0,d.M)(n);const{contour:o}=n.data,a=p(o.polyline,e);(0,s.A)(n,{points:a,closed:o.closed,targetWindingDirection:t.data.contour.windingDirection===i.W.Clockwise?i.W.CounterClockwise:i.W.Clockwise},e)}(e,n.targetAnnotation,t),void f(e,[t,n.targetAnnotation])}0!==v.length&&((0,u.l$)(m)?function(e,t,n,h){const{element:g}=e,u=[t],v=[],E=[];h.forEach(({targetAnnotation:t})=>{const n=function(e,t){return(0,r.getChildAnnotations)(t).map(t=>({annotation:t,polyline:p(t.data.contour.polyline,e)}))}(e,t);E.push(...n),u.push(t)});const w=n[0],I=h.some(({targetPolyline:e})=>a.polyline.containsPoint(e,w));if(I){let e=n;h.forEach(({targetPolyline:t})=>{e=a.polyline.mergePolylines(e,t)}),v.push(e)}else h.forEach(({targetPolyline:e})=>{const t=a.polyline.subtractPolylines(e,n);v.push(...t)});u.forEach(e=>{(0,r.removeAnnotation)(e.annotationUID),(0,d.M)(e)}),E.forEach(e=>(0,r.clearParentAnnotation)(e.annotation));const C=h[0].targetAnnotation,T=[];v.forEach(t=>{if(!t||t.length<3)return void console.warn("Skipping creation of new annotation due to invalid polyline:",t);const n=function(e,t,n){const a=e.canvasToWorld(n[0]),r=e.canvasToWorld(n[n.length-1]),l={metadata:{...t.metadata,toolName:m,originalToolName:t.metadata.originalToolName||t.metadata.toolName},data:{cachedStats:{},handles:{points:[a,r],textBox:t.data.handles.textBox?{...t.data.handles.textBox}:void 0},contour:{polyline:[],closed:!0},spline:t.data.spline,segmentation:{...t.data.segmentation}},annotationUID:o.utilities.uuidv4(),highlighted:!0,invalidated:!0,isLocked:!1,isVisible:void 0,interpolationUID:t.interpolationUID,interpolationCompleted:t.interpolationCompleted};return(0,s.A)(l,{points:n,closed:!0,targetWindingDirection:i.W.Clockwise},e),l}(e,C,t);(0,r.addAnnotation)(n,g),(0,l.V)(n),(0,c.triggerAnnotationModified)(n,e.element),T.push(n)}),function(e,t,n){t.forEach(t=>{const o=n.find(n=>{const o=p(n.data.contour.polyline,e);return a.polyline.containsPoints(o,t.polyline)});o&&(0,r.addChildAnnotation)(o,t.annotation)})}(e,E,T),f(e,u)}(e,t,n,v):console.warn(`${m} is not registered in cornerstone. Cannot process multiple intersections.`))}function p(e,t){const n=e.length,o=new Array(n);for(let i=0;i<n;i++)o[i]=t.worldToCanvas(e[i]);return o}function f(e,t){const{element:n}=e,o=new Set([m]);t.forEach(e=>{o.add(e.metadata.toolName)});for(const e of o.values())if((0,u.l$)(e)){const t=(0,g.getViewportIdsWithToolToRender)(n,e);(0,h.A)(t)}}},37354:(e,t,n)=>{"use strict";n.d(t,{M:()=>i});var o=n(33283);function i(e){if(!e.data.segmentation)throw new Error("removeContourSegmentationAnnotation: annotation does not have a segmentation data");const{segmentationId:t,segmentIndex:n}=e.data.segmentation,i=(0,o.T)(t),{annotationUIDsMap:a}=i?.representationData.Contour||{},s=a?.get(n);s&&(s.delete(e.annotationUID),s.size||a.delete(n))}},65172:(e,t,n)=>{"use strict";n.d(t,{AL:()=>T,KN:()=>f,RZ:()=>v,Yo:()=>E,oN:()=>C,pH:()=>I,rK:()=>w,vV:()=>p});var o=n(15327),i=n(93126),a=n(95527),s=n(72967),r=n(82056),l=n(85263),d=n(37354),c=n(44049),h=n(58640),g=n(60810),u=n(68040);const m="PlanarFreehandContourSegmentationTool";function v(e,t){const n=e.length,o=new Array(n);for(let i=0;i<n;i++)o[i]=t.worldToCanvas(e[i]);return o}function p(e,t){const n=e.length,o=new Array(n);for(let i=0;i<n;i++)o[i]=t.canvasToWorld(e[i]);return o}function f(e,t){const n=a.polyline.getAABB(e),o=a.polyline.getAABB(t);if(!a.aabb.intersectAABB(n,o))return{hasIntersection:!1,isContourHole:!1};const i=a.polyline.intersectPolyline(e,t),s=!i&&a.polyline.containsPoints(t,e);return{hasIntersection:i||s,isContourHole:s}}function E(e,t){return(0,r.getChildAnnotations)(t).map(t=>({annotation:t,polyline:v(t.data.contour.polyline,e)}))}function w(e,t,n){(0,r.addChildAnnotation)(t,n),(0,d.M)(n);const{contour:o}=n.data,a=v(o.polyline,e);(0,s.A)(n,{points:a,closed:o.closed,targetWindingDirection:t.data.contour.windingDirection===i.W.Clockwise?i.W.CounterClockwise:i.W.Clockwise},e);const{element:l}=e;T(e,[t,n])}function I(e,t,n,o,i){if(!(0,u.l$)(m))return void console.warn(`${m} is not registered in cornerstone. Cannot combine polylines.`);const s=i[0],h=a.polyline.containsPoint(n,s),g=E(e,t),v=new Set(g),p=new Map,f=(e,t)=>{let n=p.get(e);n||(n=[],p.set(e,n)),n.push(t),v.delete(t)},w=[];if(h){const e=a.polyline.mergePolylines(n,i);w.push(e),Array.from(v.keys()).forEach(t=>f(e,t))}else{a.polyline.subtractPolylines(n,i).forEach(e=>{w.push(e),Array.from(v.keys()).forEach(t=>{a.polyline.containsPoints(e,t.polyline)&&f(e,t)})})}Array.from(p.values()).forEach(e=>e.forEach(e=>(0,r.clearParentAnnotation)(e.annotation)));const{element:I}=e,{metadata:b,data:A}=t,{handles:_,segmentation:S}=A,{textBox:D}=_;(0,r.removeAnnotation)(o.annotationUID),(0,r.removeAnnotation)(t.annotationUID),(0,d.M)(o),(0,d.M)(t);const y=[];for(let n=0;n<w.length;n++){const o=w[n];if(!o||o.length<3){console.warn("Skipping creation of new annotation due to invalid polyline:",o);continue}const i=C(e,t,o);(0,r.addAnnotation)(i,I),(0,l.V)(i),(0,c.triggerAnnotationModified)(i,e.element),y.push(i),p.get(o)?.forEach(e=>(0,r.addChildAnnotation)(i,e.annotation))}T(e,[t,o])}function C(e,t,n){const a=e.canvasToWorld(n[0]),r=e.canvasToWorld(n[n.length-1]),l={metadata:{...t.metadata,toolName:m,originalToolName:t.metadata.originalToolName||t.metadata.toolName},data:{cachedStats:{},handles:{points:[a,r],textBox:t.data.handles.textBox?{...t.data.handles.textBox}:void 0},contour:{polyline:[],closed:!0},spline:t.data.spline,segmentation:{...t.data.segmentation}},annotationUID:o.utilities.uuidv4(),highlighted:!0,invalidated:!0,isLocked:!1,isVisible:void 0,interpolationUID:t.interpolationUID,interpolationCompleted:t.interpolationCompleted};return(0,s.A)(l,{points:n,closed:!0,targetWindingDirection:i.W.Clockwise},e),l}function T(e,t){const{element:n}=e,o=new Set([m]);t.forEach(e=>{o.add(e.metadata.toolName)});for(const e of o.values())if((0,u.l$)(e)){const t=(0,g.getViewportIdsWithToolToRender)(n,e);(0,h.A)(t)}}},43185:(e,t,n)=>{"use strict";n.d(t,{Gu:()=>c,gI:()=>r,nP:()=>h,on:()=>d,vL:()=>a,xW:()=>s});var o=n(95527),i=n(65172);function a(e,t){const n=[],a=new Set,s=new Set;for(let r=0;r<e.length;r++){if(a.has(r))continue;const l=e[r];let d=!1;for(let e=0;e<t.length;e++){if(s.has(e))continue;const c=t[e],h=(0,i.KN)(l,c);if(h.hasIntersection&&!h.isContourHole){const t=o.polyline.mergePolylines(l,c);n.push(t),a.add(r),s.add(e),d=!0;break}}d||(n.push([...l]),a.add(r))}for(let e=0;e<t.length;e++)s.has(e)||n.push([...t[e]]);return n}function s(e){if(0===e.length)return[];if(1===e.length)return e[0].map(e=>[...e]);let t=e[0].map(e=>[...e]);for(let n=1;n<e.length;n++)t=a(t,e[n]);return t}function r(e,t,n){return a(e.map(e=>l(e.data.contour.polyline,n)),t.map(e=>l(e.data.contour.polyline,n)))}function l(e,t){const n=e.length,o=new Array(n);for(let i=0;i<n;i++)o[i]=t.worldToCanvas(e[i]);return o}function d(e,t){const n=[],a=new Set;for(let s=0;s<e.length;s++){if(a.has(s))continue;let r=[e[s]],l=!1;for(let e=0;e<t.length;e++){const n=t[e],a=[];for(const e of r){const t=(0,i.KN)(e,n);if(t.hasIntersection&&!t.isContourHole){const t=o.polyline.subtractPolylines(e,n);a.push(...t),l=!0}else a.push(e)}r=a}n.push(...r),a.add(s)}return n}function c(e,t){if(0===t.length)return e.map(e=>[...e]);let n=e.map(e=>[...e]);for(let e=0;e<t.length;e++)n=d(n,t[e]);return n}function h(e,t,n){return d(e.map(e=>l(e.data.contour.polyline,n)),t.map(e=>l(e.data.contour.polyline,n)))}},93843:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});const o=function(e,t){let n=0;for(let t=0;t<e.length-1;t++){const o=e[t],i=e[t+1];n+=Math.sqrt(Math.pow(i[0]-o[0],2)+Math.pow(i[1]-o[1],2))}if(t){const t=e[0],o=e[e.length-1];n+=Math.sqrt(Math.pow(o[0]-t[0],2)+Math.pow(o[1]-t[1],2))}return n}},46228:(e,t,n)=>{"use strict";function o(e,t,n){let i=-1;if(t.forEach((t,n)=>{i>=0||t.a==e.b&&(i=n)}),i>=0){const e=t[i];return t.splice(i,1),n.push(e.b),n[0]==e.b?{remainingLines:t,contourPoints:n,type:"CLOSED_PLANAR"}:o(e,t,n)}return{remainingLines:t,contourPoints:n,type:"OPEN_PLANAR"}}function i(e){if(0==e.length)return[];const t=[],n=e.shift();t.push(n.a),t.push(n.b);const a=o(n,e,t);if(0==a.remainingLines.length)return[{type:a.type,contourPoints:a.contourPoints}];{const e=i(a.remainingLines);return e.push({type:a.type,contourPoints:a.contourPoints}),e}}n.d(t,{Ay:()=>a});const a={findContours:i,findContoursFromReducedSet:function(e){return i(e)}}},98013:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(15327),i=n(3823);const{isEqual:a}=o.utilities;function s(e,t){const{polyline:n}=e.data.contour,{points:o}=e.data.handles,{length:s}=o;if(t===s)return n.length;if(t<0&&(t=(t+s)%s),0===t)return 0;const r=o[t],l=n.findIndex(e=>a(r,e));if(-1!==l)return l;let d=1/0;return n.reduce((e,t,n)=>{const o=i.eR.squaredDistance(t,r);return o<d?(d=o,n):e},-1)}},76617:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var o=n(19246),i=n(92984);function a(e,t){if(!e||0===e.length)return[];if(t<=0)return[];const n=[];for(let a=0;a<e.length;a++){const s=e[a];if(!s||s.length<3)continue;if((0,o.A)(s)){Math.abs((0,i.getSignedArea)(s))/100<t&&n.push(a)}}return n}},15451:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(55659);function i(e,t){const n=(0,o.A)(e),i=[];return n.forEach(e=>{const n=e.length,o=new Array(n);for(let i=0;i<n;i++)o[i]=t.worldToCanvas(e[i]);i.push(o)}),i}},55659:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(82056);function i(e){return(e.childAnnotationUIDs??[]).map(e=>(0,o.getAnnotation)(e).data.contour.polyline)}},37546:(e,t,n)=>{"use strict";function o(e,t=!1){const n=e.getPoints(),o=e.getLines(),i=new Array(n.getNumberOfPoints()).fill(0).map((e,t)=>n.getPoint(t).slice()),a=new Array(o.getNumberOfCells()).fill(0).map((e,t)=>{const n=o.getCell(3*t).slice();return{a:n[0],b:n[1]}});if(t)return{points:i,lines:a};const s=[];for(const[e,t]of i.entries()){const n=s.findIndex(e=>e[0]===t[0]&&e[1]===t[1]&&e[2]===t[2]);if(n>=0)a.map(t=>(t.a===e&&(t.a=n),t.b===e&&(t.b=n),t));else{const n=s.length;s.push(t),a.map(t=>(t.a===e&&(t.a=n),t.b===e&&(t.b=n),t))}}return{points:s,lines:a.filter(e=>e.a!==e.b)}}n.d(t,{v:()=>o})},6936:(e,t,n)=>{"use strict";n.r(t),n.d(t,{AnnotationToPointData:()=>b,acceptAutogeneratedInterpolations:()=>y,areCoplanarContours:()=>i,calculatePerimeter:()=>x.A,contourFinder:()=>a.Ay,detectContourHoles:()=>r,findContourHoles:()=>g,findHandlePolylineIndex:()=>M.A,findIslands:()=>R.A,generateContourSetsFromLabelmap:()=>I,getContourHolesDataCanvas:()=>_.A,getContourHolesDataWorld:()=>A.A,getDeduplicatedVTKPolyDataPoints:()=>s.v,updateContourPolyline:()=>S.A});var o=n(3823);function i(e,t){const{viewPlaneNormal:n}=e.metadata,{viewPlaneNormal:i}=t.metadata,a=o.eR.dot(n,i);if(!o.Fd.equals(1,Math.abs(a)))return!1;const{polyline:s}=e.data.contour,{polyline:r}=t.data.contour,l=o.eR.dot(n,s[0]),d=o.eR.dot(n,r[0]);return o.Fd.equals(l,d)}var a=n(46228),s=n(37546);const r={processContourHoles:function(e,t,n=!0){const o=e.filter(e=>"CLOSED_PLANAR"!==e.type),i=e.filter(e=>"CLOSED_PLANAR"===e.type),a=[];let s=[];return i.forEach((e,n)=>{const o=[];i.forEach((i,a)=>{n!=a&&function(e,t,n){const o=[];e.contourPoints.forEach(e=>{o.push([n[e][0],n[e][1]])});let i=0;return t.contourPoints.forEach(e=>{const t=((e,t)=>{const n=e[0],o=e[1];let i=!1;for(let e=0,a=t.length-1;e<t.length;a=e++){const s=t[e][0],r=t[e][1],l=t[a][0],d=t[a][1];r>o!=d>o&&n<(l-s)*(o-r)/(d-r)+s&&(i=!i)}return i})([n[e][0],n[e][1]],o);t||i++}),0===i}(e,i,t)&&o.push(a)}),o.length>0?a.push({contour:e,holes:o}):s.push(n)}),n&&(a.forEach(e=>{e.contour.type="CLOSEDPLANAR_XOR",o.push(e.contour),e.holes.forEach(e=>{i[e].type="CLOSEDPLANAR_XOR",o.push(i[e]),s=s.filter(t=>t!==e)})}),s.forEach(e=>{o.push(i[e])})),o}};var l=n(63113),d=n(42436),c=n(19246);function h(e,t){return(0,d.A)(t,e)}function g(e){const t=[],n=[];e.forEach((e,t)=>{(0,c.A)(e)&&n.push({polyline:e,originalIndex:t})});for(let e=0;e<n.length;e++){const o=n[e],i=Math.abs((0,l.A)(o.polyline)),a=[];for(let t=0;t<n.length;t++){if(e===t)continue;const s=n[t];Math.abs((0,l.A)(s.polyline))<i&&h(s.polyline,o.polyline)&&a.push(s.originalIndex)}a.length>0&&t.push({contourIndex:o.originalIndex,holeIndexes:a.sort((e,t)=>e-t)})}return t.sort((e,t)=>e.contourIndex-t.contourIndex)}var u=n(15327),m=n(18682),v=n(99737),p=n(44460),f=n(54285),E=n(30722);const{Labelmap:w}=m.A;async function I({segmentations:e}){(0,p.D)(),(0,f.sg)(v.WorkerTypes.GENERATE_CONTOUR_SETS,0);const{representationData:t,segments:n=[0,1],segmentationId:o}=e;let{volumeId:i}=t[w];if(!i){const e=(0,E.A)(o);e&&(i=e.volumeId)}const a=u.cache.getVolume(i);if(!a)return void console.warn(`No volume found for ${i}`);const s={scalarData:a.voxelManager.getCompleteScalarDataArray(),dimensions:a.dimensions,spacing:a.imageData.getSpacing(),origin:a.imageData.getOrigin(),direction:a.imageData.getDirection()},r=Array.isArray(n)?n.filter(e=>null!==e).map(e=>e.segmentIndex||e):Object.values(n).filter(e=>null!==e).map(e=>e.segmentIndex||e),l=await(0,u.getWebWorkerManager)().executeTask("compute","generateContourSetsFromLabelmapVolume",{segmentation:s,indices:r,mode:"individual"}),d=a.imageIds.map(e=>{const t=u.cache.getImage(e)?.referencedImageId;return t?u.cache.getImage(t):void 0}),c=d.map(e=>u.utilities.getImageDataMetadata(e)),h=l.map(e=>{const t=n[e.segment.segmentIndex]||{};if(!e.sliceContours.length)return null;const o=e.sliceContours[0].polyData.points[0];let i;if(o){const e=c.findIndex(e=>{const{scanAxisNormal:t,origin:n}=e,i=u.utilities.planar.planeEquation(t,n);return u.utilities.planar.isPointOnPlane(o,i)});-1!==e&&(i=d[e].imageId)}return{label:t.label,color:t.color,metadata:{FrameOfReferenceUID:a.metadata.FrameOfReferenceUID,referencedImageId:i},sliceContours:e.sliceContours.map(e=>({contours:e.contours,polyData:e.polyData,FrameNumber:e.sliceIndex+1,sliceIndex:e.sliceIndex,FrameOfReferenceUID:a.metadata.FrameOfReferenceUID,referencedImageId:i}))}}).filter(e=>null!==e);return(0,f.sg)(v.WorkerTypes.GENERATE_CONTOUR_SETS,100),h}var C=n(109);class T{static{this.TOOL_NAMES={}}constructor(){}static convert(e,t,n){!function(e){if(!e?.data)throw new Error("Tool data is empty");if(!e.metadata||e.metadata.referencedImageId)throw new Error("Tool data is not associated with any imageId")}(e);const{toolName:o}=e.metadata,i=T.TOOL_NAMES[o];if(!i)throw new Error(`Unknown tool type: ${o}, cannot convert to RTSSReport`);const a=i.getContourSequence(e,n);return{ReferencedROINumber:t+1,ROIDisplayColor:[Math.floor(255*Math.random()),Math.floor(255*Math.random()),Math.floor(255*Math.random())],ContourSequence:a}}static register(e){T.TOOL_NAMES[e.toolName]=e}}T.register(C.A);const b=T;var A=n(55659),_=n(15451),S=n(72967),D=n(27740);function y(e,t){D.A.acceptAutoGenerated(e,t)}var M=n(98013),x=n(93843),R=n(76617)},72967:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(15327),i=n(95527),a=n(82056);function s(e,t,n,s){const{canvasToWorld:r,worldToCanvas:l}=n,{data:d}=e,{targetWindingDirection:c}=t;let{points:h}=t,g=i.polyline.getWindingDirection(h);s?.decimate?.enabled&&(h=i.polyline.decimate(t.points,s?.decimate?.epsilon));let{closed:u}=t;const m=h.length,v=new Array(m),p=(i.polyline.getWindingDirection(h),(0,a.getParentAnnotation)(e));if(void 0===u){let e=!1;if(h.length>3){const t=i.point.distanceToPointSquared(h[0],h[m-1]);e=o.utilities.isEqual(0,t)}u=e}if(!1!==s?.updateWindingDirection){let e=p?-1*p.data.contour.windingDirection:c;void 0===e&&(e=g),e!==g&&h.reverse();const t=(d.handles?.points??[]).map(l);if(t.length>2){i.polyline.getWindingDirection(t)!==e&&d.handles.points.reverse()}g=e}for(let e=0;e<m;e++)v[e]=r(h[e]);d.contour.polyline=v,d.contour.closed=u,d.contour.windingDirection=g,(0,a.invalidateAnnotation)(e)}},473:(e,t,n)=>{"use strict";n.r(t),n.d(t,{getTextBoxCoordsCanvas:()=>o.A});var o=n(1239)},94593:(e,t,n)=>{"use strict";n.d(t,{G:()=>s,H:()=>r});var o=n(15327);function i(e,t){const n=e.getScalarDataLength(),o=new Float32Array(n);for(const i of t){const t=e.getDimensionGroupScalarData(i);for(let e=0;e<n;e++)o[e]+=t[e]}return o}const a={[o.Enums.GenerateImageType.SUM]:(e,t,n)=>{const o=i(e,t);for(let e=0;e<o.length;e++)n(e,o[e])},[o.Enums.GenerateImageType.AVERAGE]:(e,t,n)=>{const o=function(e,t){const n=i(e,t),o=t.length;for(let e=0;e<n.length;e++)n[e]/=o;return n}(e,t);for(let e=0;e<o.length;e++)n(e,o[e])},[o.Enums.GenerateImageType.SUBTRACT]:(e,t,n)=>{if(2!==t.length)throw new Error("Please provide only 2 dimension groups for subtraction.");const o=e.getScalarDataLength(),i=e.getDimensionGroupScalarData(t[0]),a=e.getDimensionGroupScalarData(t[1]);for(let e=0;e<o;e++){n(e,i[e]-a[e])}}};function s(e,t,n){const{dimensionGroupNumbers:o,frameNumbers:i}=n;i&&console.warn("Warning: frameNumbers parameter is deprecated. Please use dimensionGroupNumbers instead.");const s=o||i||Array.from({length:e.numDimensionGroups},(e,t)=>t+1);if(s.length<=1)throw new Error("Please provide two or more dimension groups");const r=e.voxelManager,l=r.getScalarDataLength(),d=a[t];if(!d)throw new Error(`Unsupported operation: ${t}`);const c=new Float32Array(l);return d(r,s,(e,t)=>{c[e]=t}),c}function r(e,t,n){const{dimensionGroupNumbers:o,frameNumbers:i,targetVolume:s}=n;if(!s)throw new Error("A target volume must be provided");i&&console.warn("Warning: frameNumbers parameter is deprecated. Please use dimensionGroupNumbers instead.");const r=o||i||Array.from({length:e.numDimensionGroups},(e,t)=>t+1);if(r.length<=1)throw new Error("Please provide two or more dimension groups");const l=e.voxelManager,d=s.voxelManager,c=a[t];if(!c)throw new Error(`Unsupported operation: ${t}`);c(l,r,(e,t)=>{d.setAtIndex(e,t)}),d.resetModifiedSlices();for(let e=0;e<s.dimensions[2];e++)d.modifiedSlices.add(e)}},41362:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var o=n(15327),i=n(64063);const a=function(e,t){const n=t.dimensionGroupNumbers||t.frameNumbers||Array.from({length:e.numDimensionGroups},(e,t)=>t+1);if(t.frameNumbers&&console.warn("Warning: frameNumbers parameter is deprecated. Please use dimensionGroupNumbers instead."),!t.maskVolumeId&&!t.worldCoordinate)throw new Error("You should provide either maskVolumeId or imageCoordinate");if(t.maskVolumeId&&t.worldCoordinate)throw new Error("You can only use one of maskVolumeId or imageCoordinate");if(t.maskVolumeId){const a=o.cache.getVolume(t.maskVolumeId);if(!a)throw new Error("Segmentation volume not found");const[s,r]=function(e,t,n){const{imageData:o}=n,a=n.voxelManager,s=a.getScalarDataLength(),r=[];r.length=s;let l=0;for(let e=0,t=s;e<t;e++)0!==a.getAtIndex(e)&&(r[l++]=e);r.length=l;const d=[],c=t.voxelManager.getScalarDataLength()===s&&JSON.stringify(t.spacing)===JSON.stringify(n.spacing),h=[];if(c){for(let n=0;n<r.length;n++){const o=[],i=r[n];for(let n=0;n<e.length;n++)o.push(t.voxelManager.getAtIndexAndDimensionGroup(i,e[n]));d.push(o),h.push(a.toIJK(i))}return[d,h]}const g=({pointLPS:n,value:o,pointIJK:a})=>{if(0===o)return;const s=(0,i.Q5)(t.imageData,t.dimensions,t.spacing,n);let r=0;const l=new Map;e.forEach(e=>l.set(e,0));const c=({index:n})=>{for(let o=0;o<e.length;o++){const i=t.voxelManager.getAtIndexAndDimensionGroup(n,e[o]),a=e[o];l.set(a,l.get(a)+i)}r++};t.voxelManager.forEach(c,{imageData:t.imageData,boundsIJK:s});const g=[];l.forEach(e=>{g.push(e/r)}),h.push(a),d.push(g)};return n.voxelManager.forEach(g,{imageData:o}),[d,h]}(n,e,a);return[s,r]}if(t.worldCoordinate){const i=function(e,t,n){const{dimensions:i,imageData:a}=n,s=a.worldToIndex(t);if(s[0]=Math.floor(s[0]),s[1]=Math.floor(s[1]),s[2]=Math.floor(s[2]),!o.utilities.indexWithinDimensions(s,i))throw new Error("outside bounds");const r=i[0],l=i[0]*i[1],d=[];return e.forEach(e=>{const t=s[2]*l+s[1]*r+s[0];d.push(n.voxelManager.getAtIndexAndDimensionGroup(t,e))}),d}(n,t.worldCoordinate,e);return i}}},83052:(e,t,n)=>{"use strict";n.r(t),n.d(t,{generateImageFromTimeData:()=>i.G,getDataInTime:()=>o.A,updateVolumeFromTimeData:()=>i.H});var o=n(41362),i=n(94593)},41293:(e,t,n)=>{"use strict";n.d(t,{S:()=>s,s:()=>r});var o=n(15327),i=n(82056),a=n(77609);function s(e,t,n=5){const i=(0,o.getEnabledElement)(e);if(!i)throw new Error("getAnnotationNearPoint: enabledElement not found");return r(i,t,n)}function r(e,t,n){const{renderingEngineId:o,viewportId:i}=e,s=a.getToolGroupForViewport(i,o);if(!s)return null;const{_toolInstances:r}=s;for(const o in r){const i=l(r[o],e,t,n);if(i)return i}return null}function l(e,t,n,o){const{viewport:a}=t,s=(0,i.getAnnotations)(e.constructor.toolName,a?.element),r=a?.getCurrentImageId?.();if(s?.length){const{element:i}=t.viewport;for(const t of s){const a=t.metadata?.referencedImageId;if(!(r&&a&&r!==a||!e.isPointNearTool)&&(e.isPointNearTool(i,t,n,o,"")||e.getHandleNearImagePoint(i,t,n,o)))return t}}return null}},4096:(e,t,n)=>{"use strict";n.d(t,{CQ:()=>m,Op:()=>g,Xw:()=>u});var o=n(15327);const{CalibrationTypes:i}=o.Enums,a="px",s="voxels",r=[1,2,3,4],l=["3,3","4,7"],d=["4,3","4,7"],c={0:"px",1:"percent",2:"dB",3:"cm",4:"seconds",5:"hertz",6:"dB/seconds",7:"cm/sec",8:"cm",9:"cm/s",12:"degrees"},h="",g=(e,t)=>{const{calibration:n,hasPixelSpacing:d}=e;let g=d?"mm":a;const u=d?"mm":s;let m=g+h,v=1,p="";if(!n||!n.type&&!n.sequenceOfUltrasoundRegions)return{unit:g,areaUnit:m,scale:v,volumeUnit:u};if(n.type===i.UNCALIBRATED)return{unit:a,areaUnit:a+h,scale:v,volumeUnit:s};if(n.sequenceOfUltrasoundRegions){let e,i;if(Array.isArray(t)&&2===t.length)[e,i]=t;else if("function"==typeof t){const n=t();e=n[0],i=n[1]}let d=n.sequenceOfUltrasoundRegions.filter(t=>e[0]>=t.regionLocationMinX0&&e[0]<=t.regionLocationMaxX1&&e[1]>=t.regionLocationMinY0&&e[1]<=t.regionLocationMaxY1&&i[0]>=t.regionLocationMinX0&&i[0]<=t.regionLocationMaxX1&&i[1]>=t.regionLocationMinY0&&i[1]<=t.regionLocationMaxY1);if(!d?.length)return{unit:g,areaUnit:m,scale:v,volumeUnit:u};if(d=d.filter(e=>r.includes(e.regionDataType)&&l.includes(`${e.physicalUnitsXDirection},${e.physicalUnitsYDirection}`)),!d.length)return{unit:a,areaUnit:a+h,scale:v,volumeUnit:s};const f=d[0],E=Math.abs(f.physicalDeltaX),w=Math.abs(f.physicalDeltaY);if(!o.utilities.isEqual(E,w,.001))return{unit:a,areaUnit:a+h,scale:v,volumeUnit:s};v=1/E,p="US Region",g=c[f.physicalUnitsXDirection]||"unknown",m=g+h}else n.scale&&(v=n.scale);return[i.ERMF,i.USER,i.ERROR,i.PROJECTION,i.CALIBRATED,i.UNKNOWN].includes(n?.type)&&(p=n.type),{unit:g+(p?` ${p}`:""),areaUnit:m+(p?` ${p}`:""),scale:v,volumeUnit:u+(p?` ${p}`:"")}},u=(e,t)=>{const[n]=t,{calibration:o}=e;let i=["raw"],a=[null],s="";if(!o||!o.type&&!o.sequenceOfUltrasoundRegions)return{units:i,values:a};if(o.sequenceOfUltrasoundRegions){const e=o.sequenceOfUltrasoundRegions.filter(e=>r.includes(e.regionDataType)&&d.includes(`${e.physicalUnitsXDirection},${e.physicalUnitsYDirection}`));if(!e?.length)return{units:i,values:a};const t=e.find(e=>n[0]>=e.regionLocationMinX0&&n[0]<=e.regionLocationMaxX1&&n[1]>=e.regionLocationMinY0&&n[1]<=e.regionLocationMaxY1);if(!t)return{units:i,values:a};const{referencePixelX0:l=0,referencePixelY0:h=0}=t,{physicalDeltaX:g,physicalDeltaY:u}=t,m=(n[1]-t.regionLocationMinY0-h)*u;s="US Region",a=[(n[0]-t.regionLocationMinX0-l)*g,m],i=[c[t.physicalUnitsXDirection],c[t.physicalUnitsYDirection]]}return{units:i,values:a,calibrationType:s}},m=e=>e.calibration?.aspect||1},40634:(e,t,n)=>{"use strict";n.d(t,{N:()=>i,j:()=>a});var o=n(15327);function i(e,t){return a(o.metaData.get("generalSeriesModule",e).modality,e,t)}function a(e,t,n){return"CT"===e?"HU":"PT"===e?function(e,t){if(!t.isPreScaled)return"raw";if(t.isSuvScaled)return"SUV";const n=o.metaData.get("generalSeriesModule",e);if("PT"===n?.modality){const t=o.metaData.get("petSeriesModule",e);return t?.units||"unitless"}return"unknown"}(t,n):""}},4296:(e,t,n)=>{"use strict";n.d(t,{R:()=>l,l:()=>d});var o=n(15327),i=n(3823),a=n(72282);const{transformWorldToIndex:s}=o.utilities;function r(e,t,n){const[o,r]=e,l=i.eR.fromValues((o[0]+r[0])/2,(o[1]+r[1])/2,(o[2]+r[2])/2),d=i.eR.distance(o,r)/2,{boundsIJK:c,topLeftWorld:h,bottomRightWorld:g}=function(e,t,n,o,r){const l=e.getDimensions(),{row:d,column:c,normal:h}=t,g=i.eR.create(),u=i.eR.create();i.eR.scaleAndAdd(g,o,h,r),i.eR.scaleAndAdd(u,o,h,-r),i.eR.scaleAndAdd(g,g,c,-r),i.eR.scaleAndAdd(u,u,c,r),i.eR.scaleAndAdd(g,g,d,-r),i.eR.scaleAndAdd(u,u,d,r);const m=s(e,g),v=s(e,u),p=n.map(t=>s(e,t)),f=(0,a.getBoundingBoxAroundShapeIJK)([m,v,...p],l);return{boundsIJK:f,topLeftWorld:g,bottomRightWorld:u}}(t,n,e,l,d);return{boundsIJK:c,centerWorld:l,radiusWorld:d,topLeftWorld:h,bottomRightWorld:g}}function l(e,t){const n=t.getDirection(),o=i.eR.fromValues(n[0],n[1],n[2]),a=i.eR.fromValues(n[3],n[4],n[5]),s=i.eR.fromValues(n[6],n[7],n[8]);return r(e,t,{row:o,column:a,normal:i.eR.negate(i.eR.create(),s)})}function d(e,t,n){if(!n)throw new Error("viewport is required in order to calculate the sphere bounds");const o=n.getCamera(),a=i.eR.fromValues(o.viewUp[0],o.viewUp[1],o.viewUp[2]),s=i.eR.fromValues(o.viewPlaneNormal[0],o.viewPlaneNormal[1],o.viewPlaneNormal[2]),l=i.eR.create();i.eR.cross(l,a,s);return r(e,t,{row:l,normal:s,column:i.eR.negate(i.eR.create(),a)})}},15295:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var o=n(15327);const{isEqual:i}=o.utilities;function a(e){const{metadata:t}=e;return(0,o.getEnabledElements)().filter(e=>{if(e.FrameOfReferenceUID===t.FrameOfReferenceUID){const n=e.viewport,{viewPlaneNormal:o,viewUp:a}=n.getCamera();return i(o,t.viewPlaneNormal)&&(!t.viewUp||i(a,t.viewUp))}}).map(e=>e.viewport)}},53860:(e,t,n)=>{"use strict";n.r(t),n.d(t,{AnnotationMultiSlice:()=>v.A,IslandRemoval:()=>V.A,annotationHydration:()=>f.i,boundingBox:()=>S,calibrateImageSpacing:()=>l.A,cine:()=>_,contourSegmentation:()=>O,contours:()=>E,debounce:()=>a.A,drawing:()=>I,dynamicVolume:()=>P,geometricSurfaceUtils:()=>W,getAnnotationNearPoint:()=>i.S,getAnnotationNearPointOnEnabledElement:()=>i.s,getCalibratedAspect:()=>d.CQ,getCalibratedLengthUnitsAndScale:()=>d.Op,getCalibratedProbeUnitsAndValue:()=>d.Xw,getClosestImageIdForStackViewport:()=>f.x,getOrCreateImageVolume:()=>G.A,getPixelValueUnits:()=>B.j,getPixelValueUnitsImageId:()=>B.N,getSphereBoundsInfo:()=>u.R,getViewportForAnnotation:()=>p.A,isObject:()=>r.A,math:()=>C,moveAnnotationToViewPlane:()=>F.T,normalizeViewportPlane:()=>N.A,orientation:()=>A,planar:()=>T,planarFreehandROITool:()=>D,pointInSurroundingSphereCallback:()=>U.i,pointToString:()=>m.l,polyDataUtils:()=>L,rectangleROITool:()=>y,roundNumber:()=>z,segmentation:()=>w,setAnnotationLabel:()=>H.A,stackContextPrefetch:()=>M.N,stackPrefetch:()=>M.S,throttle:()=>s.A,touch:()=>R,triggerAnnotationRender:()=>g.A,triggerAnnotationRenderForToolGroupIds:()=>h.A,triggerAnnotationRenderForViewportIds:()=>c.A,triggerEvent:()=>o.triggerEvent,usFanExtraction:()=>$,viewport:()=>x,viewportFilters:()=>b,voi:()=>k});var o=n(15327),i=n(41293),a=n(52905),s=n(27730),r=n(45217),l=n(58271),d=n(4096),c=n(58640),h=n(94779),g=n(56069),u=n(4296),m=n(38726),v=n(16678),p=n(40133),f=n(64485),E=n(6936),w=n(93759),I=n(473),C=n(95527),T=n(13165),b=n(60810),A=n(90141),_=n(67108),S=n(72282),D=n(55002),y=n(74866),M=n(71132),x=n(19027),R=n(76260),P=n(83052),L=n(32994),k=n(97213),O=n(56534),U=n(10261),N=n(27963),V=n(67912),B=n(40634),W=n(5565),H=n(1355),F=n(79646),G=n(83075),$=n(58180);const z=o.utilities.roundNumber},95527:(e,t,n)=>{"use strict";n.r(t),n.d(t,{BasicStatsCalculator:()=>i,aabb:()=>o,angle:()=>g,circle:()=>a,ellipse:()=>s,lineSegment:()=>r,point:()=>l,polyline:()=>d,rectangle:()=>c,vec2:()=>h});var o=n(88638),i=n(73262),a=n(77081),s=n(11683),r=n(93258),l=n(82216),d=n(92984),c=n(33657),h=n(23324),g=n(83923)},93258:(e,t,n)=>{"use strict";n.r(t),n.d(t,{distanceToPoint:()=>o.A,distanceToPointSquared:()=>i.A,distanceToPointSquaredInfo:()=>a.A,intersectLine:()=>s.A,isPointOnLineSegment:()=>r.A});var o=n(86978),i=n(18989),a=n(73149),s=n(81205),r=n(91818)},42436:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(46513);function i(e,t){for(let n=0,i=t.length;n<i;n++)if(!(0,o.A)(e,t[n]))return!1;return!0}},99944:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var o=n(93258);const i=.1;function a(e,t=i){const n=e.length;if(n<3)return e;const a=t*t,s=[[0,n-1]],r=new Array(n).fill(!1);let l=2;for(r[0]=!0,r[n-1]=!0;s.length;){const[t,n]=s.pop();if(n-t===1)continue;const i=e[t],d=e[n];let c=-1/0,h=-1;for(let a=t+1;a<n;a++){const t=e[a],n=o.distanceToPointSquared(i,d,t);n>c&&(c=n,h=a)}c<a||(r[h]=!0,l++,s.push([h,n]),s.push([t,h]))}const d=new Array(l);for(let t=0,o=0;t<n;t++)r[t]&&(d[o++]=e[t]);return d}},63113:(e,t,n)=>{"use strict";function o(e){if(e.length<3)return 0;const t=e[0];let n=0;for(let o=0,i=e.length;o<i;o++){const a=e[o],s=e[o===i-1?0:o+1],r=a[0]-t[0],l=a[1]-t[1],d=s[0]-t[0];n+=r*(s[1]-t[1])-l*d}return n*=.5,n}n.d(t,{A:()=>o})},92984:(e,t,n)=>{"use strict";n.r(t),n.d(t,{addCanvasPointsToArray:()=>C.A,containsPoint:()=>i.A,containsPoints:()=>a.A,convexHull:()=>_.A,decimate:()=>m.A,getAABB:()=>s.A,getArea:()=>r.A,getClosestLineSegmentIntersection:()=>E.A,getFirstLineSegmentIntersectionIndexes:()=>v.A,getLineSegmentIntersectionsCoordinates:()=>f.A,getLineSegmentIntersectionsIndexes:()=>p.A,getNormal2:()=>h.A,getNormal3:()=>c.A,getSignedArea:()=>l.A,getSubPixelSpacingAndXYDirections:()=>w.A,getWindingDirection:()=>d.A,intersectPolyline:()=>u.A,isClosed:()=>o.A,isPointInsidePolyline3D:()=>b.i,mergePolylines:()=>g.S,pointCanProjectOnLine:()=>T.A,pointsAreWithinCloseContourProximity:()=>I.A,projectTo2D:()=>A.p,subtractPolylines:()=>g.Y});var o=n(19246),i=n(46513),a=n(42436),s=n(98122),r=n(86909),l=n(63113),d=n(4239),c=n(43490),h=n(11377),g=n(68385),u=n(405),m=n(99944),v=n(4338),p=n(37135),f=n(50932),E=n(32979),w=n(61785),I=n(82265),C=n(97792),T=n(80514),b=n(8361),A=n(28502),_=n(58754)},19246:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var o=n(3823),i=n(82216);function a(e){if(e.length<3)return!1;const t=e.length,n=e[0],a=e[t-1],s=(0,i.distanceToPointSquared)(n,a);return o.Fd.equals(0,s)}},90554:(e,t,n)=>{"use strict";function o(e,t){let n=[0,0],o=Number.MAX_SAFE_INTEGER;return e.forEach(function(e){const i=function(e,t){const[n,o]=e,[i,a]=t;return Math.sqrt(Math.pow(n-i,2)+Math.pow(o-a,2))}(t,e);i<o&&(o=i,n=[...e])}),n}n.d(t,{A:()=>o})},79646:(e,t,n)=>{"use strict";n.d(t,{T:()=>a});var o=n(15327),i=n(9175);function a(e,t){const{data:n}=e,{points:a}=n.handles,{focalPoint:s,viewPlaneNormal:r}=t.getCamera(),l=i.dot(i.sub(i.create(),a[0],s),r);return a.forEach(e=>{i.add(e,e,i.scale(i.create(),[-r[0],-r[1],-r[2]],l))}),t instanceof o.StackViewport&&(e.metadata.referencedImageId=t.getCurrentImageId()),e}},27963:(e,t,n)=>{"use strict";n.d(t,{A:()=>l});var o=n(15327);const{isEqual:i}=o.utilities,a={toIJK:e=>e,fromIJK:e=>e,type:"acquistion"},s={toIJK:([e,t,n])=>[n,e,t],fromIJK:([e,t,n])=>[t,n,e],type:"jk"},r={toIJK:([e,t,n])=>[e,n,t],fromIJK:([e,t,n])=>[e,n,t],type:"ik"};function l(e,t){if(!(e instanceof o.BaseVolumeViewport))return{...a,boundsIJKPrime:t};const{viewPlaneNormal:n}=e.getCamera(),l=i(Math.abs(n[0]),1)&&s||i(Math.abs(n[1]),1)&&r||i(Math.abs(n[2]),1)&&a;return l?{...l,boundsIJKPrime:l.fromIJK(t)}:{toIJK:null,boundsIJKPrime:null,fromIJK:null,error:`Only mappings orthogonal to acquisition plane are permitted, but requested ${n}`}}},7193:(e,t,n)=>{"use strict";function o(e){let t="";const n=e[0]<0?"R":"L",o=e[1]<0?"A":"P",i=e[2]<0?"F":"H",a=[Math.abs(e[0]),Math.abs(e[1]),Math.abs(e[2])],s=1e-4;for(let e=0;e<3;e++)if(a[0]>s&&a[0]>a[1]&&a[0]>a[2])t+=n,a[0]=0;else if(a[1]>s&&a[1]>a[0]&&a[1]>a[2])t+=o,a[1]=0;else if(a[2]>s&&a[2]>a[0]&&a[2]>a[1])t+=i,a[2]=0;else if(a[0]>s&&a[1]>s&&a[0]===a[1])t+=n+o,a[0]=0,a[1]=0;else if(a[0]>s&&a[2]>s&&a[0]===a[2])t+=n+i,a[0]=0,a[2]=0;else{if(!(a[1]>s&&a[2]>s&&a[1]===a[2]))break;t+=o+i,a[1]=0,a[2]=0}return t}n.d(t,{A:()=>o})},90141:(e,t,n)=>{"use strict";n.r(t),n.d(t,{getOrientationStringLPS:()=>o.A,invertOrientationStringLPS:()=>i.A});var o=n(7193),i=n(80405)},80405:(e,t,n)=>{"use strict";function o(e){let t=e.replace("H","f");return t=t.replace("F","h"),t=t.replace("R","l"),t=t.replace("L","r"),t=t.replace("A","p"),t=t.replace("P","a"),t=t.toUpperCase(),t}n.d(t,{A:()=>o})},55002:(e,t,n)=>{"use strict";n.r(t),n.d(t,{default:()=>i,smoothAnnotation:()=>o.A});var o=n(61587);const i={smoothAnnotation:o.A}},10261:(e,t,n)=>{"use strict";n.d(t,{i:()=>l});var o=n(15327),i=n(3823),a=n(62783),s=n(72282);const{transformWorldToIndex:r}=o.utilities;function l(e,t,n,l){const{boundsIJK:d,centerWorld:c,radiusWorld:h}=function(e,t,n){const[o,a]=e,l=i.eR.fromValues((o[0]+a[0])/2,(o[1]+a[1])/2,(o[2]+a[2])/2),d=i.eR.distance(o,a)/2;let c;if(!n){const e=r(t,l),n=t.getSpacing(),o=Math.min(...n),i=Math.ceil(d/o);return c=[[e[0]-i,e[0]+i],[e[1]-i,e[1]+i],[e[2]-i,e[2]+i]],{boundsIJK:c,centerWorld:l,radiusWorld:d}}return c=function(e,t,n,o,a){const[l,d]=n,c=e.getDimensions(),h=t.getCamera(),g=i.eR.fromValues(h.viewUp[0],h.viewUp[1],h.viewUp[2]),u=i.eR.fromValues(h.viewPlaneNormal[0],h.viewPlaneNormal[1],h.viewPlaneNormal[2]),m=i.eR.create();i.eR.cross(m,g,u);const v=i.eR.create(),p=i.eR.create();i.eR.scaleAndAdd(v,d,u,a),i.eR.scaleAndAdd(p,l,u,-a),i.eR.scaleAndAdd(v,v,m,-a),i.eR.scaleAndAdd(p,p,m,a);const f=[r(e,v),r(e,p)],E=(0,s.getBoundingBoxAroundShape)(f,c);return E}(t,n,e,0,d),{boundsIJK:c,centerWorld:l,radiusWorld:d}}(t,e,l),g={center:c,radius:h},u=e.getDimensions();o.utilities.VoxelManager.createScalarVolumeVoxelManager({dimensions:u,scalarData:e.getPointData().getScalars().getData()}).forEach(n,{boundsIJK:d,isInObject:e=>(0,a.d)(g,e),imageData:e})}},38726:(e,t,n)=>{"use strict";function o(e,t=5){return parseFloat(e[0]).toFixed(t)+","+parseFloat(e[1]).toFixed(t)+","+parseFloat(e[2]).toFixed(t)+","}n.d(t,{l:()=>o})},32994:(e,t,n)=>{"use strict";n.r(t),n.d(t,{getPoint:()=>i,getPolyDataPointIndexes:()=>a,getPolyDataPoints:()=>s});var o=n(3823);function i(e,t){const n=3*t;if(n<e.length)return o.eR.fromValues(e[n],e[n+1],e[n+2])}function a(e){const t=e.getLines().getData();let n=0;const o=new Map;for(;n<t.length;){const e=t[n++],i=[];for(let o=0;o<e;o++)i.push(t[n+o]);o.set(i[0],i),n+=e}const i=[],a=e=>{for(const[t,n]of e.entries())if(void 0!==n)return t;return-1};let s=a(o);for(;-1!==s;){const e=[s];for(;o.has(s);){const t=o.get(s)[1];o.has(t)&&e.push(t),o.delete(s),s=t}i.push(e),s=a(o)}return i.length?i:void 0}function s(e){const t=a(e);if(!t)return;const n=e.getPoints().getData();return t.map(e=>e.map(e=>i(n,e)))}},37162:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(15327),i=n(87063),a=n(76802);const s=function(e,t,n={}){const s=[];return e.forEach(e=>{const{data:r}=e,{points:l}=r.handles,{imageData:d,dimensions:c}=t;let h=l;if(r.cachedStats?.projectionPoints){const{projectionPoints:e}=r.cachedStats;h=[].concat(...e)}const g=h.map(e=>o.utilities.transformWorldToIndex(d,e));let u=(0,i.g)(g,c);n.numSlicesToProject&&!r.cachedStats?.projectionPoints&&(u=(0,a.A)(u,n.numSlicesToProject)),s.push(u)}),1===s.length?s[0]:s.reduce((e,t)=>({iMin:Math.min(e.iMin,t.iMin),jMin:Math.min(e.jMin,t.jMin),kMin:Math.min(e.kMin,t.kMin),iMax:Math.max(e.iMax,t.iMax),jMax:Math.max(e.jMax,t.jMax),kMax:Math.max(e.kMax,t.kMax)}),{iMin:1/0,jMin:1/0,kMin:1/0,iMax:-1/0,jMax:-1/0,kMax:-1/0})}},74866:(e,t,n)=>{"use strict";n.r(t),n.d(t,{getBoundsIJKFromRectangleAnnotations:()=>o.A,isAxisAlignedRectangle:()=>i.l});var o=n(37162),i=n(26384)},44460:(e,t,n)=>{"use strict";n.d(t,{D:()=>s});var o=n(15327),i=n(36625);let a=!1;function s(){if(a)return;a=!0;const e=(0,o.getWebWorkerManager)(),t=(0,i.zj)().computeWorker,s={maxWorkerInstances:1,autoTerminateOnIdle:t?.autoTerminateOnIdle??{enabled:!0,idleTimeThreshold:2e3}};e.registerWorker("compute",()=>new Worker(new URL(n.p+n.u(3694),n.b),{name:"compute",type:void 0}),s)}},27740:(e,t,n)=>{"use strict";n.d(t,{A:()=>u});var o=n(15327),i=n(47807),a=n(51893),s=n(73816),r=n(56229),l=n(75183),d=n(40133),c=n(85263);const{uuidv4:h}=o.utilities,g=[l.A.HandlesUpdated,l.A.InterpolationUpdated];class u{static{this.toolNames=[]}static addTool(e){this.toolNames.includes(e)||this.toolNames.push(e)}static acceptAutoGenerated(e,t={}){const{toolNames:n,segmentationId:o,segmentIndex:a,sliceIndex:s}=t;for(const t of n||u.toolNames){const n=i.state.getAnnotations(t,e);if(n?.length)for(const e of n){const{interpolationUID:t,data:n,autoGenerated:i,metadata:r}=e;t&&(e.interpolationCompleted=!0),i&&(a&&a!==n.segmentation.segmentIndex||void 0!==s&&r&&s!==r.sliceIndex||o&&o!==n.segmentation.segmentationId||((0,c.V)(e),e.autoGenerated=!1))}}}static{this.handleAnnotationCompleted=e=>{const t=e.detail.annotation;if(!t?.metadata)return;const{toolName:n,originalToolName:o}=t.metadata;if(!this.toolNames.includes(n)&&!this.toolNames.includes(o))return;const i=(0,d.A)(t);if(!i)return void console.warn("Unable to find viewport for",t);const l={viewport:i,sliceData:m(i),annotation:t,interpolationUID:t.interpolationUID},c=!!t.interpolationUID;if(t.autoGenerated=!1,c)return(0,r.A)(l),void(0,s.A)(l);const g=[{key:"segmentIndex",value:t.data.segmentation.segmentIndex,parentKey:e=>e.data.segmentation},{key:"viewPlaneNormal",value:t.metadata.viewPlaneNormal,parentKey:e=>e.metadata},{key:"viewUp",value:t.metadata.viewUp,parentKey:e=>e.metadata}];let u=(0,a.A)(l,g);const{sliceIndex:v}=t.metadata,p=new Set;u.forEach(e=>{if(e.interpolationCompleted||e.metadata.sliceIndex===v){const{interpolationUID:t}=e;p.add(t)}}),u=u.filter(e=>!p.has(e.interpolationUID)),t.interpolationUID=u[0]?.interpolationUID||h(),l.interpolationUID=t.interpolationUID,(0,s.A)(l)}}static{this.handleAnnotationUpdate=e=>{const t=e.detail.annotation,{changeType:n=l.A.HandlesUpdated}=e.detail;if(!t?.metadata)return;const{toolName:o,originalToolName:i}=t.metadata;if(!this.toolNames.includes(o)&&!this.toolNames.includes(i)||!g.includes(n))return;const a=(0,d.A)(t);if(!a)return void console.warn("Unable to find matching viewport for annotation interpolation",t);t.autoGenerated&&((0,c.V)(t),t.autoGenerated=!1);const r={viewport:a,sliceData:m(a),annotation:t,interpolationUID:t.interpolationUID,isInterpolationUpdate:n===l.A.InterpolationUpdated};(0,s.A)(r)}}static{this.handleAnnotationDelete=e=>{const t=e.detail.annotation;if(!t?.metadata)return;const{toolName:n}=t.metadata;if(!this.toolNames.includes(n)||t.autoGenerated)return;const o=(0,d.A)(t);if(!o)return void console.warn("No viewport, can't delete interpolated results",t);const i={viewport:o,sliceData:m(o),annotation:t,interpolationUID:t.interpolationUID};t.autoGenerated=!1,(0,r.A)(i)}}}function m(e){return{numberOfSlices:e.getNumberOfSlices(),imageIndex:e.getCurrentImageIdIndex()}}},13179:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(68915);class i{static{this.calculators=new Map}static{this.indices=[]}static{this.mode="collective"}static statsInit(e){const{storePointData:t,indices:n,mode:i}=e;this.mode=i,this.indices=n,this.calculators.clear(),"individual"===this.mode?n.forEach(e=>{this.calculators.set(e,new o.C3({storePointData:t}))}):this.calculators.set(n,new o.C3({storePointData:t}))}static statsCallback(e){const{segmentIndex:t,...n}=e;if(!t)throw new Error("Segment index is required for stats calculation");const o="individual"===this.mode?this.calculators.get(t):this.calculators.get(this.indices);if(!o)throw new Error(`No calculator found for segment ${t}`);o.statsCallback(n)}static getStatistics(e){if("individual"===this.mode){const t={};return this.calculators.forEach((n,o)=>{t[o]=n.getStatistics(e)}),t}return this.calculators.get(this.indices).getStatistics(e)}}},68915:(e,t,n)=>{"use strict";n.d(t,{Ay:()=>d,C3:()=>l});var o=n(69013),i=n(4096);function a(e,t){const{value:n}=t,{maxIJKs:o}=e,i=o.length;if("number"!=typeof n||i>=10&&n<o[0].value)return;const a={value:t.value,pointLPS:t.pointLPS?[t.pointLPS[0],t.pointLPS[1],t.pointLPS[2]]:void 0,pointIJK:t.pointIJK?[t.pointIJK[0],t.pointIJK[1],t.pointIJK[2]]:void 0};if(!i||n>=o[i-1].value)o.push(a);else for(let e=0;e<i;e++)if(n<=o[e].value){o.splice(e,0,a);break}i>=10&&o.splice(0,1)}function s(e,t,n){const{spacing:o,calibration:a}=n,{volumeUnit:s}=(0,i.Op)({calibration:a,hasPixelSpacing:!0},[]),r=o?o[0]*o[1]*o[2]:1;return t.volume={value:Array.isArray(t.count.value)?t.count.value.map(e=>e*r):t.count.value*r,unit:s,name:"volume",label:"Volume"},t.maxIJKs=e.maxIJKs.filter(e=>void 0!==e.pointIJK),t.array.push(t.volume),e.maxIJKs=[],t}class r extends o.O{static{this.volumetricState={maxIJKs:[]}}static statsInit(e){super.statsInit(e),this.volumetricState={maxIJKs:[]}}static statsCallback(e){super.statsCallback(e),a(this.volumetricState,e)}static getStatistics(e){const t={...e,unit:e?.unit||"none",calibration:e?.calibration,hasPixelSpacing:e?.hasPixelSpacing},n=super.getStatistics(t);return s(this.volumetricState,n,t)}}class l extends o.B{constructor(e){super(e),this.volumetricState={maxIJKs:[]}}statsInit(e){super.statsInit(e),this.volumetricState={maxIJKs:[]}}statsCallback(e){super.statsCallback(e),a(this.volumetricState,e)}getStatistics(e){const t={...e,unit:e?.unit||"none",calibration:e?.calibration,hasPixelSpacing:e?.hasPixelSpacing},n=super.getStatistics(t);return s(this.volumetricState,n,t)}}const d=r},17014:(e,t,n)=>{"use strict";n.d(t,{A:()=>l,M:()=>r});var o=n(77609),i=n(58640),a=n(15327),s=n(14957);function r(e,t,n){const r=(0,o.getToolGroup)(e);if(void 0===r)return;(0,s.n)(e,n).forEach(e=>{e.configuration.brushSize=t,e.invalidateBrushCursor()});const l=r.getViewportsInfo(),d=Object.keys(l).map(e=>l[e]);if(!d.length)return;const{renderingEngineId:c}=d[0],h=r.getViewportIds();(0,a.getRenderingEngine)(c);(0,i.A)(h)}function l(e,t){const n=(0,o.getToolGroup)(e);if(void 0===n)return;const i=n._toolInstances;if(!Object.keys(i).length)return;const a=(0,s.n)(e,t)[0];return a?a.configuration.brushSize:void 0}},49492:(e,t,n)=>{"use strict";n.d(t,{K:()=>s,Q:()=>r});var o=n(77609),i=n(58640),a=n(14957);function s(e,t){const n=(0,o.getToolGroup)(e);if(void 0===n)return;(0,a.n)(e).forEach(e=>{e.configuration.activeStrategy.toLowerCase().includes("threshold")&&(e.configuration={...e.configuration,threshold:{...e.configuration.threshold,...t}})});if(!n.getViewportsInfo().length)return;const s=n.getViewportIds();(0,i.A)(s)}function r(e){const t=(0,o.getToolGroup)(e);if(void 0===t)return;const n=t._toolInstances;if(!Object.keys(n).length)return;const i=(0,a.n)(e)[0];return i?i.configuration.threshold.range:void 0}},88274:(e,t,n)=>{"use strict";n.d(t,{B:()=>h});var o=n(15327),i=n(54285),a=n(99737),s=n(44460),r=n(4334),l=n(33283),d=n(30722),c=n(83075);async function h({segmentationIds:e,segmentIndex:t}){(0,s.D)(),(0,i.sg)(a.WorkerTypes.COMPUTE_STATISTICS,0);const n=(0,l.T)(e[0]),{imageIds:h}=n.representationData.Labelmap;if(!o.utilities.isValidVolume(h))throw new Error("Invalid volume - TMTV cannot be calculated");const g=await async function({segmentationIds:e,segmentIndex:t}){const n=e.map(e=>(0,d.A)(e)),s=(0,r.A)(n,t);if(!s)throw new Error("Invalid volume - TMTV cannot be calculated");const{imageData:h,dimensions:g,direction:u,origin:m,voxelManager:v}=s,p=h.getSpacing(),f={scalarData:v.getCompleteScalarDataArray(),dimensions:g,spacing:p,origin:m,direction:u},E=function(e){const t=(0,l.T)(e);if(!t)return null;let n;const i=t.representationData.Labelmap;if("imageIds"in i){const{imageIds:e}=i,t=o.cache.getImage(e[0]),a=o.cache.getVolumeContainingImageId(t.referencedImageId);if(a?.volume)return a.volume;n=e.map(e=>o.cache.getImage(e).referencedImageId)}else if("volumeId"in i){const{volumeId:e,referencedVolumeId:t}=i;if(t){const e=o.cache.getVolume(t);if(e)return e}const a=o.cache.getVolume(e);a&&(n=a.imageIds.map(e=>o.cache.getImage(e).referencedImageId))}return(0,c.A)(n)}(e[0]),w={dimensions:E.dimensions,spacing:E.spacing,origin:E.origin,direction:E.direction,scalarData:E.voxelManager.getCompleteScalarDataArray()};if(0===w.scalarData.length||0===f.scalarData.length)return{[t]:{name:"TMTV",value:0}};const I=await(0,o.getWebWorkerManager)().executeTask("compute","computeMetabolicStats",{segmentationInfo:f,imageInfo:w});return(0,i.sg)(a.WorkerTypes.COMPUTE_STATISTICS,100),I}({segmentationIds:e,segmentIndex:t});return g}},13276:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(6936),i=n(60199),a=n(30722);async function s(e){const t=await(0,o.generateContourSetsFromLabelmap)({segmentations:e});if(!t?.length||!t[0].sliceContours.length)return;const{segments:n=[null,{label:"Unspecified",color:null,containedSegmentIndices:null}]}=e,s=(0,a.A)(e.segmentationId);if(!s)return;const r=n.findIndex(e=>!!e);return-1!==r?(n[r].segmentIndex=r,(0,i.A)(t[0],s.volumeId,n[r])):void 0}},14514:(e,t,n)=>{"use strict";function o(e,t){const{majorAxis:n,minorAxis:o,label:i="",sliceIndex:a}=e,[s,r]=n,[l,d]=o,c=[s,r,l,d];return{highlighted:!0,invalidated:!0,metadata:{toolName:"Bidirectional",...t.getViewReference({sliceIndex:a})},data:{handles:{points:c,textBox:{hasMoved:!1,worldPosition:[0,0,0],worldBoundingBox:{topLeft:[0,0,0],topRight:[0,0,0],bottomLeft:[0,0,0],bottomRight:[0,0,0]}},activeHandleIndex:null},label:i,cachedStats:{}},isLocked:!1,isVisible:!0}}n.d(t,{A:()=>o})},2397:(e,t,n)=>{"use strict";n.r(t),n.d(t,{createLabelmapMemo:()=>r,createRleMemo:()=>d,restoreMemo:()=>l});var o=n(15327),i=n(49906);n(94021);const{VoxelManager:a,RLEVoxelMap:s}=o.utilities;function r(e,t){return d(e,t)}function l(e){const{segmentationVoxelManager:t,undoVoxelManager:n,redoVoxelManager:o}=this,a=!1===e?o:n;a.forEach(({value:e,pointIJK:n})=>{t.setAtIJKPoint(n,e)});const s=a.getArrayOfModifiedSlices();(0,i.triggerSegmentationDataModified)(this.segmentationId,s)}function d(e,t){return{segmentationId:e,restoreMemo:l,commitMemo:c,segmentationVoxelManager:t,voxelManager:a.createRLEHistoryVoxelManager(t),id:o.utilities.uuidv4(),operationType:"labelmap"}}function c(){if(this.redoVoxelManager)return!0;if(!this.voxelManager.modifiedSlices.size)return!1;const{segmentationVoxelManager:e}=this,t=a.createRLEHistoryVoxelManager(e);s.copyMap(t.map,this.voxelManager.map);for(const e of this.voxelManager.modifiedSlices.keys())t.modifiedSlices.add(e);this.undoVoxelManager=t;const n=a.createRLEVolumeVoxelManager({dimensions:this.segmentationVoxelManager.dimensions});return this.redoVoxelManager=n,t.forEach(({index:t,pointIJK:o,value:i})=>{const a=e.getAtIJKPoint(o);a!==i&&n.setAtIndex(t,a)}),!0}},97492:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(15327);async function i(e){const{viewportId:t,renderingEngineId:n,options:i}=e;let{segmentationId:a}=e;const s=(0,o.getEnabledElementByIds)(t,n);if(!s)throw new Error("element disabled");const{viewport:r}=s;if(!(r instanceof o.VolumeViewport))throw new Error("Segmentation only supports VolumeViewport");const{uid:l}=r.getDefaultActor();if(void 0===a&&(a=`${l}-based-segmentation-${i?.volumeId??o.utilities.uuidv4().slice(0,8)}`),i){const e=structuredClone(i);await o.volumeLoader.createLocalVolume(a,e)}else{const e=r.getVolumeId();o.volumeLoader.createAndCacheDerivedLabelmapVolume(e,{volumeId:a})}return a}},4334:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(15327);const i=function(e,t=1,n="mergedLabelmap"){e.forEach(({direction:t,dimensions:n,origin:i,spacing:a})=>{if(!(o.utilities.isEqual(n,e[0].dimensions)&&o.utilities.isEqual(t,e[0].direction)&&o.utilities.isEqual(a,e[0].spacing)&&o.utilities.isEqual(i,e[0].origin)))throw new Error("labelmaps must have the same size and shape")});const i=e[0],a=new(i.voxelManager.getConstructor())(i.voxelManager.getScalarDataLength());e.forEach(e=>{const n=e.voxelManager,o=n.getScalarDataLength();for(let e=0;e<o;e++)n.getAtIndex(e)===t&&(a[e]=t)});const s={scalarData:a,metadata:i.metadata,spacing:i.spacing,origin:i.origin,direction:i.direction,dimensions:i.dimensions},r=o.cache.getVolume(n);let l;return r?(l=r,l.voxelManager.setCompleteScalarDataArray(a)):l=o.volumeLoader.createLocalVolume(n,s),l}},60199:(e,t,n)=>{"use strict";n.d(t,{A:()=>s});var o=n(3823),i=n(60213);const a=.01;function s(e,t,n){const{sliceContours:o}=e,{segmentIndex:a,containedSegmentIndices:s}=n;let l;const d=(0,i.Hs)(t,a,s);for(const e of o){const t=r(e,d,l);t&&(l=t)}return l&&Object.assign(l,n),l}function r(e,t,n={maxMajor:0,maxMinor:0}){const{points:s}=e.polyData,{maxMinor:r,maxMajor:l}=n;let d,c=l*l,h=r*r;for(let e=0;e<s.length;e++)for(let n=e+1;n<s.length;n++){const r=s[e],l=s[n],g=o.eR.sqrDist(r,l);g<c||(g-a<c+a&&d||t.testCenter(r,l)&&(0,i.pW)(r,l,t)&&(c=g-a,d=[e,n],h=0))}if(!d)return;c=Math.sqrt(c+a);const g=s[d[0]],u=s[d[1]],m=o.eR.sub(o.eR.create(),g,u);let v;o.eR.scale(m,m,1/c);for(let e=0;e<s.length;e++)for(let n=e+1;n<s.length;n++){const r=s[e],l=s[n],d=o.eR.sqrDist(r,l);if(d<=h)continue;const c=o.eR.sub(o.eR.create(),r,l);Math.abs(o.eR.dot(c,m))/Math.sqrt(d)>a||t.testCenter(r,l)&&(0,i.pW)(r,l,t)&&(h=d,v=[e,n])}if(!v)return;h=Math.sqrt(h);return{majorAxis:[g,u],minorAxis:[s[v[0]],s[v[1]]],maxMajor:c,maxMinor:h,...e}}},84882:(e,t,n)=>{"use strict";function o(e,t,n){return(new Array(n+1).join(t)+e).slice(-n)}n.d(t,{A:()=>i});const i=function(e,t,n={}){const i=n.onFlood,a=n.onBoundary,s=n.equals,r=n.filter,l=n.diagonals||!1,d=f(t),c=function(){const e=function(e){const t=[],n=function(e){return e.split("").map(function(e){return parseInt(e,10)-1})};for(let i=0;i<Math.pow(3,e);i+=1){const a=o(i.toString(3),"0",e);t.push(n(a))}return t}(t.length);return e.filter(function(e){const t=function(e){let t=0;for(let n=0;n<e.length;n+=1)0!==e[n]&&(t+=1);return t}(e);return 0!==t&&(1===t||l)})}(),h=[],g=[],u=new Set,m=n.bounds;for(h.push({currentArgs:t});h.length>0;)v(h.pop());return{flooded:g};function v(e){const t=e.currentArgs,n=e.previousArgs;p(t)||(function(e){const[t,n,o=0]=e,i=t+32768+65536*(n+32768+65536*(o+32768));u.add(i)}(t),function(e){const t=f(e);return s?s(t,d):t===d}(t)?(function(e){g.push(e),i&&i(...e)}(t),function(e){for(let t=0;t<c.length;t+=1){const n=c[t],o=e.slice(0);for(let t=0;t<e.length;t+=1)o[t]+=n[t];!1!==r?.(o)&&(p(o)||h.push({currentArgs:o,previousArgs:e}))}}(t)):function(e){const[t,n,o=0]=e,i=t+32768+65536*(n+32768+65536*(o+32768));m?.set(i,e),a&&a(...e)}(n))}function p(e){const[t,n,o=0]=e,i=t+32768+65536*(n+32768+65536*(o+32768));return u.has(i)}function f(t){return e(...t)}}},14957:(e,t,n)=>{"use strict";n.d(t,{n:()=>a});var o=n(77609),i=n(48736);function a(e,t){const n=(0,o.getToolGroup)(e);if(void 0===n)return;const a=n._toolInstances;if(!Object.keys(a).length)return;if(t&&a[t])return[a[t]];return Object.values(a).filter(e=>e instanceof i.A)}},20527:(e,t,n)=>{"use strict";n.d(t,{L:()=>a});var o=n(6802),i=n(98870);function a(e){const t=(0,i.getSegmentation)(e),{annotationUIDsMap:n}=t.representationData.Contour;for(const[e,t]of n.entries()){if(Array.from(t).find(e=>(0,o.gw)(e).highlighted))return e}}},83075:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(15327);const i=function(e){if(!e||e.length<=1)return;if(!o.utilities.isValidVolume(e))return;const t=o.cache.generateVolumeId(e);let n=o.cache.getVolume(t);return n||(n=o.volumeLoader.createAndCacheVolumeFromImagesSync(t,e),n)}},30722:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var o=n(15327),i=n(33283);const a=function(e){const{representationData:t}=(0,i.T)(e);let n,{volumeId:a}=t.Labelmap;if(a&&(n=o.cache.getVolume(a),n))return n;const{imageIds:s}=t.Labelmap;if(a=o.cache.generateVolumeId(s),!s||1===s.length)return;return o.utilities.isValidVolume(s)?(n=o.volumeLoader.createAndCacheVolumeFromImagesSync(a,s),n):void 0}},12853:(e,t,n)=>{"use strict";n.d(t,{b:()=>i});var o=n(15327);function i(e){const t=o.cache.getVolume(e);if(!t)return null;const n=t.referencedVolumeId;let i;if(n)i=o.cache.getVolume(n);else{const e=t.imageIds,n=o.cache.getImage(e[0]).referencedImageId,a=o.cache.getVolumeContainingImageId(n);i=a?.volume}return i}},46507:(e,t,n)=>{"use strict";n.d(t,{T:()=>s});var o=n(15327),i=n(98870),a=n(91963);function s(e,t,{viewport:n,searchRadius:s}){const l=(0,i.getSegmentation)(e).representationData.Labelmap;if(n instanceof o.BaseVolumeViewport){const{volumeId:e}=l,i=o.cache.getVolume(e);if(!i)return;const a=i.voxelManager,d=i.imageData,c=o.utilities.transformWorldToIndex(d,t),h=a.getAtIJK(c[0],c[1],c[2]),g=function(e,t,n,i,a){const s=(t,a)=>{const s=[e[0]+t,e[1]+a],r=n.canvasToWorld(s),l=i.get("voxelManager").voxelManager,d=o.utilities.transformWorldToIndex(i,r);return l.getAtIJK(d[0],d[1],d[2])};return r(s,t,a)}(n.worldToCanvas(t),h,n,d,s);return g?h:void 0}const d=(0,i.getCurrentLabelmapImageIdForViewport)(n.id,e);if(!o.cache.getImage(d))return;const c=(0,a.wV)(n.id,e),h=c?.actor.getMapper().getInputData(),g=o.utilities.transformWorldToIndex(h,t),u=h.getDimensions(),m=h.voxelManager||o.utilities.VoxelManager.createScalarVolumeVoxelManager({dimensions:u,scalarData:h.getPointData().getScalars().getData()}),v=m.getAtIJKPoint(g),p=function(e,t,n,o,i){const a=(t,o,i)=>{const a=[e[0]+t,e[1]+o,e[2]+i];return n.getAtIJK(a[0],a[1],a[2])};return r(a,o,i)}(g,0,m,v);return p?v:void 0}function r(e,t,n=1){const o=Array.from({length:2*n+1},(e,t)=>t-n);for(const n of o)for(const i of o)for(const a of o){if(0===n&&0===i&&0===a)continue;const o=e(n,i,a);if(void 0!==o&&t!==o)return!0}return!1}},71751:(e,t,n)=>{"use strict";n.d(t,{hX:()=>d});var o=n(15327),i=n(99737),a=n(98870),s=n(6802),r=n(92984),l=n(59452);function d(e,t,n={}){const d=(0,a.getSegmentation)(e),c=d.representationData,h=n?.representationType??Object.keys(c)[0];if(!h)throw new Error(`Segmentation ${e} does not have any representations`);switch(h){case i.SegmentationRepresentations.Labelmap:return function(e,t,{viewport:n}){const i=e.representationData.Labelmap;if(n instanceof o.BaseVolumeViewport){const{volumeId:e}=i,n=o.cache.getVolume(e);if(!n)return;return n.imageData.getScalarValueFromWorld(t)}const s=(0,a.getCurrentLabelmapImageIdsForViewport)(n.id,e.segmentationId);if(s.length>1)return void console.warn("Segment selection for labelmaps with multiple imageIds in stack viewports is not supported yet.");const r=s[0];if(!o.cache.getImage(r))return;const d=(0,l.wV)(n.id,e.segmentationId),c=d?.actor.getMapper().getInputData(),h=o.utilities.transformWorldToIndex(c,t),g=c.getDimensions(),u=c.voxelManager||o.utilities.VoxelManager.createScalarVolumeVoxelManager({dimensions:g,scalarData:c.getPointData().getScalars().getData()});return u.getAtIJKPoint(h)}(d,t,n);case i.SegmentationRepresentations.Contour:return function(e,t,{viewport:n}){const i=e.representationData.Contour,a=Array.from(i.annotationUIDsMap.keys()),{viewPlaneNormal:l}=n.getCamera();for(const e of a){const n=i.annotationUIDsMap.get(e);if(n)for(const i of n){const n=(0,s.gw)(i);if(!n)continue;const{polyline:a}=n.data.contour;if(o.utilities.isEqual(l,n.metadata.viewPlaneNormal)&&(0,r.isPointInsidePolyline3D)(t,a))return Number(e)}}}(d,t,n);default:return}}},78773:(e,t,n)=>{"use strict";n.d(t,{T:()=>r});var o=n(15327),i=n(99737),a=n(44460),s=n(54285);async function r({segmentationId:e,segmentIndices:t,mode:n="individual"}){(0,a.D)(),(0,s.sg)(i.WorkerTypes.COMPUTE_LARGEST_BIDIRECTIONAL,0);const r=(0,s.yR)(e,t);if(!r)return;const{operationData:l,segImageIds:d,reconstructableVolume:c,indices:h}=r,g=c?await async function({operationData:e,indices:t,mode:n}){const i=(0,s.o9)(e),{segmentationVoxelManager:a,segmentationImageData:r}=i,l={scalarData:a.getCompleteScalarDataArray(),dimensions:r.getDimensions(),spacing:r.getSpacing(),origin:r.getOrigin(),direction:r.getDirection()},d=await(0,o.getWebWorkerManager)().executeTask("compute","getSegmentLargestBidirectionalInternal",{segmentationInfo:l,indices:t,mode:n});return d}({operationData:l,indices:h,mode:n}):await async function({segImageIds:e,indices:t,mode:n}){const{segmentationInfo:i}=(0,s.Dn)(e),a=await(0,o.getWebWorkerManager)().executeTask("compute","getSegmentLargestBidirectionalInternal",{segmentationInfo:i,indices:t,mode:n,isStack:!0});return a}({segImageIds:d,indices:h,mode:n});return(0,s.sg)(i.WorkerTypes.COMPUTE_LARGEST_BIDIRECTIONAL,100),g}},38440:(e,t,n)=>{"use strict";n.d(t,{A:()=>u});var o=n(15327),i=n(54285),a=n(40634),s=n(68915),r=n(99737),l=n(44460);const d=Math.pow(3e3/(4*Math.PI),1/3);const c=(e,t)=>{if(!e.array)return;const n=e.array.findIndex(e=>e.name===t.name);-1!==n?e.array[n]=t:e.array.push(t)},h=({stats:e,unit:t,spacing:n,segmentationImageData:o,imageVoxelManager:i})=>{if(e.mean.unit=t,e.max.unit=t,e.min.unit=t,"SUV"!==t)return e;const a=n.map(e=>Math.max(1,Math.round(1.1*d/e)));for(const s of e.maxIJKs){const r=g(s,a,o,i,n);if(!r)continue;const{mean:l}=r;(!e.peakValue||e.peakValue.value<=l.value)&&(e.peakValue={name:"peakValue",label:"Peak Value",value:l.value,unit:t},e.peakPoint={name:"peakLPS",label:"Peak SUV Point",value:s.pointLPS?[...s.pointLPS]:null,unit:null},c(e,e.peakValue),c(e,e.peakPoint))}if(e.volume&&e.mean){const n=e.volume.value,o=e.mean.value;e.lesionGlycolysis={name:"lesionGlycolysis",label:"Lesion Glycolysis",value:n*o,unit:`${e.volume.unit}${t}`},c(e,e.lesionGlycolysis)}return e};function g(e,t,n,i,a){const{pointIJK:r,pointLPS:l}=e;if(!r)return;const d=r.map((e,n)=>[e-t[n],e+t[n]]);return s.Ay.statsInit({storePointData:!1}),o.utilities.pointInShapeCallback(n,{pointInShapeFn:(e,n)=>{const o=(n[0]-r[0])/t[0],i=(n[1]-r[1])/t[1],a=(n[2]-r[2])/t[2];return o*o+i*i+a*a<=1},callback:({pointIJK:e,pointLPS:t})=>{const n=i.getAtIJKPoint(e);void 0!==n&&s.Ay.statsCallback({value:n,pointLPS:t,pointIJK:e})},boundsIJK:d}),s.Ay.getStatistics({spacing:a})}const u=async function({segmentationId:e,segmentIndices:t,mode:n="collective"}){(0,l.D)(),(0,i.sg)(r.WorkerTypes.COMPUTE_STATISTICS,0);const d=(0,i.yR)(e,t);if(!d)return;const{operationData:c,segVolumeId:g,segImageIds:u,reconstructableVolume:m,indices:v}=d,{refImageId:p,modalityUnitOptions:f}=(0,i.FI)(g,u),E=(0,a.N)(p,f);return m?await async function({operationData:e,indices:t,unit:n,mode:a}){const l=(0,i.o9)(e),{segmentationVoxelManager:d,imageVoxelManager:c,segmentationImageData:g,imageData:u}=l;if(!d||!g)return;const m=g.getSpacing(),{boundsIJK:v}=d;if(!v)return s.Ay.getStatistics({spacing:m});const p={scalarData:d.getCompleteScalarDataArray(),dimensions:g.getDimensions(),spacing:g.getSpacing(),origin:g.getOrigin(),direction:g.getDirection()},f={scalarData:c.getCompleteScalarDataArray(),dimensions:u.getDimensions(),spacing:u.getSpacing(),origin:u.getOrigin(),direction:u.getDirection()};if(!f.scalarData?.length)return;const E=await(0,o.getWebWorkerManager)().executeTask("compute","calculateSegmentsStatisticsVolume",{segmentationInfo:p,imageInfo:f,indices:t,unit:n,mode:a});if((0,i.sg)(r.WorkerTypes.COMPUTE_STATISTICS,100),"collective"===a)return h({stats:E,unit:n,spacing:m,segmentationImageData:g,imageVoxelManager:c});{const e={};return Object.entries(E).forEach(([t,o])=>{e[t]=h({stats:o,unit:n,spacing:m,segmentationImageData:g,imageVoxelManager:c})}),e}}({operationData:c,indices:v,unit:E,mode:n}):await async function({segImageIds:e,indices:t,unit:n,mode:a}){(0,i.sg)(r.WorkerTypes.COMPUTE_STATISTICS,0);const{segmentationInfo:s,imageInfo:l}=(0,i.Dn)(e),d=await(0,o.getWebWorkerManager)().executeTask("compute","calculateSegmentsStatisticsStack",{segmentationInfo:s,imageInfo:l,indices:t,mode:a});(0,i.sg)(r.WorkerTypes.COMPUTE_STATISTICS,100);const c=s[0].spacing,g=s[0],u=l[0].voxelManager;if("collective"===a)return h({stats:d,unit:n,spacing:c,segmentationImageData:g,imageVoxelManager:u});{const e={};return Object.entries(d).forEach(([t,o])=>{e[t]=h({stats:o,unit:n,spacing:c,segmentationImageData:g,imageVoxelManager:u})}),e}}({segImageIds:u,indices:v,unit:E,mode:n})}},25758:(e,t,n)=>{"use strict";n.d(t,{O:()=>r});var o=n(15327),i=n(99737),a=n(64063),s=n(33283);function r(e){const t=(0,a.R1)(e);if(t)return t;const n=(0,s.T)(e);if(!n)throw new Error(`No segmentation found for segmentationId ${e}`);let r;if(n.representationData.Labelmap)r=function(e,t){const n=e.representationData[i.SegmentationRepresentations.Labelmap],a=new Set;n.imageIds?function(e,t){t.forEach(t=>{o.cache.getImage(t).voxelManager.getScalarData().forEach(t=>{0!==t&&e.add(t)})})}(a,n.imageIds):function(e,t){const n=o.cache.getVolume(t);n.voxelManager.forEach(({value:t})=>{0!==t&&e.add(t)})}(a,t);return Array.from(a).map(Number).sort((e,t)=>e-t)}(n,e);else if(n.representationData.Contour)r=function(e){const{annotationUIDsMap:t,geometryIds:n}=e.representationData.Contour||{};if(!n)throw new Error(`No geometryIds found for segmentationId ${e.segmentationId}`);const i=new Set([...t.keys()]);return n.forEach(e=>{const t=o.cache.getGeometry(e);i.add(t.data.segmentIndex)}),Array.from(i).sort((e,t)=>e-t)}(n);else{if(!n.representationData.Surface)throw new Error(`Unsupported segmentation type: ${n.representationData}`);r=function(e){const t=e.representationData.Surface?.geometryIds??[];return Array.from(t.keys()).map(Number).sort((e,t)=>e-t)}(n)}return(0,a.Dm)(e,r),r}},2733:(e,t,n)=>{"use strict";n.d(t,{A:()=>o});const o="\nconst MAX_STRENGTH = 65535f;\n\n// Workgroup size - X*Y*Z must be multiple of 32 for better performance\noverride workGroupSizeX = 1u;\noverride workGroupSizeY = 1u;\noverride workGroupSizeZ = 1u;\n\n// Compare the current voxel to neighbors using a 9x9x9 window\noverride windowSize = 9i;\n\nstruct Params {\n  size: vec3u,\n  iteration: u32,\n}\n\n// New structure to track bounds of modified voxels\nstruct Bounds {\n  minX: atomic<i32>,\n  minY: atomic<i32>,\n  minZ: atomic<i32>,\n  maxX: atomic<i32>,\n  maxY: atomic<i32>,\n  maxZ: atomic<i32>,\n}\n\n@group(0) @binding(0) var<uniform> params: Params;\n@group(0) @binding(1) var<storage> volumePixelData: array<f32>;\n@group(0) @binding(2) var<storage, read_write> labelmap: array<u32>;\n@group(0) @binding(3) var<storage, read_write> strengthData: array<f32>;\n@group(0) @binding(4) var<storage> prevLabelmap: array<u32>;\n@group(0) @binding(5) var<storage> prevStrengthData: array<f32>;\n@group(0) @binding(6) var<storage, read_write> updatedVoxelsCounter: array<atomic<u32>>;\n@group(0) @binding(7) var<storage, read_write> modifiedBounds: Bounds;\n\nfn getPixelIndex(ijkPos: vec3u) -> u32 {\n  let numPixelsPerSlice = params.size.x * params.size.y;\n  return ijkPos.x + ijkPos.y * params.size.x + ijkPos.z * numPixelsPerSlice;\n}\n\nfn updateBounds(position: vec3i) {\n  // Atomically update min bounds (use min operation)\n  let oldMinX = atomicMin(&modifiedBounds.minX, position.x);\n  let oldMinY = atomicMin(&modifiedBounds.minY, position.y);\n  let oldMinZ = atomicMin(&modifiedBounds.minZ, position.z);\n\n  // Atomically update max bounds (use max operation)\n  let oldMaxX = atomicMax(&modifiedBounds.maxX, position.x);\n  let oldMaxY = atomicMax(&modifiedBounds.maxY, position.y);\n  let oldMaxZ = atomicMax(&modifiedBounds.maxZ, position.z);\n}\n\n@compute @workgroup_size(workGroupSizeX, workGroupSizeY, workGroupSizeZ)\nfn main(\n  @builtin(global_invocation_id) globalId: vec3u,\n) {\n  // Make sure it will not get out of bounds for volume with sizes that\n  // are not multiple of workGroupSize\n  if (\n    globalId.x >= params.size.x ||\n    globalId.y >= params.size.y ||\n    globalId.z >= params.size.z\n  ) {\n    return;\n  }\n\n  // Initialize bounds for the first iteration\n  if (params.iteration == 0 && globalId.x == 0 && globalId.y == 0 && globalId.z == 0) {\n    // Initialize to opposite extremes to ensure any update will improve the bounds\n    atomicStore(&modifiedBounds.minX, i32(params.size.x));\n    atomicStore(&modifiedBounds.minY, i32(params.size.y));\n    atomicStore(&modifiedBounds.minZ, i32(params.size.z));\n    atomicStore(&modifiedBounds.maxX, -1);\n    atomicStore(&modifiedBounds.maxY, -1);\n    atomicStore(&modifiedBounds.maxZ, -1);\n  }\n\n  let currentCoord = vec3i(globalId);\n  let currentPixelIndex = getPixelIndex(globalId);\n\n  let numPixels = arrayLength(&volumePixelData);\n  let currentPixelValue = volumePixelData[currentPixelIndex];\n\n  if (params.iteration == 0) {\n    // All non-zero initial labels are given maximum strength\n    strengthData[currentPixelIndex] = select(MAX_STRENGTH, 0., labelmap[currentPixelIndex] == 0);\n\n    // Update bounds for non-zero initial labels\n    if (labelmap[currentPixelIndex] != 0) {\n      updateBounds(currentCoord);\n    }\n    return;\n  }\n\n  // It should at least copy the values from previous state\n  var newLabel = prevLabelmap[currentPixelIndex];\n  var newStrength = prevStrengthData[currentPixelIndex];\n\n  let window = i32(ceil(f32(windowSize - 1) * .5));\n  let minWindow = -1i * window;\n  let maxWindow = 1i * window;\n\n  for (var k = minWindow; k <= maxWindow; k++) {\n    for (var j = minWindow; j <= maxWindow; j++) {\n      for (var i = minWindow; i <= maxWindow; i++) {\n        // Skip current voxel\n        if (i == 0 && j == 0 && k == 0) {\n          continue;\n        }\n\n        let neighborCoord = currentCoord + vec3i(i, j, k);\n\n        //  Boundary conditions. Do not grow outside of the volume\n        if (\n          neighborCoord.x < 0i || neighborCoord.x >= i32(params.size.x) ||\n          neighborCoord.y < 0i || neighborCoord.y >= i32(params.size.y) ||\n          neighborCoord.z < 0i || neighborCoord.z >= i32(params.size.z)\n        ) {\n          continue;\n        }\n\n        let neighborIndex = getPixelIndex(vec3u(neighborCoord));\n        let neighborPixelValue = volumePixelData[neighborIndex];\n        let prevNeighborStrength = prevStrengthData[neighborIndex];\n        let strengthCost = abs(neighborPixelValue - currentPixelValue);\n        let takeoverStrength = prevNeighborStrength - strengthCost;\n\n        if (takeoverStrength > newStrength) {\n          newLabel = prevLabelmap[neighborIndex];\n          newStrength = takeoverStrength;\n        }\n      }\n    }\n  }\n\n  if (labelmap[currentPixelIndex] != newLabel) {\n    atomicAdd(&updatedVoxelsCounter[params.iteration], 1u);\n\n    // Update bounds for modified voxels\n    updateBounds(currentCoord);\n  }\n\n  labelmap[currentPixelIndex] = newLabel;\n  strengthData[currentPixelIndex] = newStrength;\n}\n"},95373:(e,t,n)=>{"use strict";n.r(t),n.d(t,{run:()=>o.e,runGrowCutForBoundingBox:()=>a.z,runGrowCutForSphere:()=>i.n,runOneClickGrowCut:()=>s.HW});var o=n(66499),i=n(73569),a=n(20271),s=n(16171)},66499:(e,t,n)=>{"use strict";n.d(t,{e:()=>r});var o=n(15327),i=n(2733);const a=2136746229.76,s={windowSize:3,maxProcessingTime:3e4,inspection:{numCyclesInterval:5,numCyclesBelowThreshold:3,threshold:1e-4}};async function r(e,t,n=s){const r=[8,8,4],{windowSize:l,maxProcessingTime:d}=Object.assign({},s,n),c=Object.assign({},s.inspection,n.inspection),h=o.cache.getVolume(e),g=o.cache.getVolume(t),[u,m,v]=h.dimensions;if(g.dimensions[0]!==u||g.dimensions[1]!==m||g.dimensions[2]!==v)throw new Error("Volume and labelmap must have the same size");let p=Math.floor(Math.sqrt(m**2+u**2+v**2)/2);p=Math.min(p,500);const f=g.voxelManager.getCompleteScalarDataArray();let E=h.voxelManager.getCompleteScalarDataArray();E instanceof Float32Array||(E=new Float32Array(E));const w={maxStorageBufferBindingSize:a,maxBufferSize:a},I=await(navigator.gpu?.requestAdapter()),C=await I.requestDevice({requiredLimits:w}),T=E.byteLength,b=p*Uint32Array.BYTES_PER_ELEMENT,A=6*Int32Array.BYTES_PER_ELEMENT,_=C.createShaderModule({code:i.A}),S=new Uint32Array([u,m,v,0]),D=C.createBuffer({size:S.byteLength,usage:GPUBufferUsage.UNIFORM|GPUBufferUsage.COPY_DST}),y=C.createBuffer({size:T,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_DST});C.queue.writeBuffer(y,0,E);const M=[0,1].map(()=>C.createBuffer({size:T,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}));C.queue.writeBuffer(M[0],0,new Uint32Array(f));const x=[0,1].map(()=>C.createBuffer({size:T,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST})),R=C.createBuffer({size:b,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),P=C.createBuffer({size:A,usage:GPUBufferUsage.STORAGE|GPUBufferUsage.COPY_SRC|GPUBufferUsage.COPY_DST}),L=new Int32Array([u,m,v,-1,-1,-1]);C.queue.writeBuffer(P,0,L);const k=C.createBindGroupLayout({entries:[{binding:0,visibility:GPUShaderStage.COMPUTE,buffer:{type:"uniform"}},{binding:1,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:2,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:3,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:4,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:5,visibility:GPUShaderStage.COMPUTE,buffer:{type:"read-only-storage"}},{binding:6,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}},{binding:7,visibility:GPUShaderStage.COMPUTE,buffer:{type:"storage"}}]}),O=[0,1].map(e=>{const t=M[e],n=x[e],o=M[(e+1)%2],i=x[(e+1)%2];return C.createBindGroup({layout:k,entries:[{binding:0,resource:{buffer:D}},{binding:1,resource:{buffer:y}},{binding:2,resource:{buffer:t}},{binding:3,resource:{buffer:n}},{binding:4,resource:{buffer:o}},{binding:5,resource:{buffer:i}},{binding:6,resource:{buffer:R}},{binding:7,resource:{buffer:P}}]})}),U=C.createComputePipeline({layout:C.createPipelineLayout({bindGroupLayouts:[k]}),compute:{module:_,entryPoint:"main",constants:{workGroupSizeX:r[0],workGroupSizeY:r[1],workGroupSizeZ:r[2],windowSize:l}}}),N=[Math.ceil(u/r[0]),Math.ceil(m/r[1]),Math.ceil(v/r[2])],V=C.createBuffer({size:b,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),B=d?performance.now()+d:0;let W=c.numCyclesInterval,H=0;for(let e=0;e<p;e++){S[3]=e,C.queue.writeBuffer(D,0,S);const t=C.createCommandEncoder(),n=t.beginComputePass();n.setPipeline(U),n.setBindGroup(0,O[e%2]),n.dispatchWorkgroups(N[0],N[1],N[2]),n.end(),t.copyBufferToBuffer(R,e*Uint32Array.BYTES_PER_ELEMENT,V,e*Uint32Array.BYTES_PER_ELEMENT,Uint32Array.BYTES_PER_ELEMENT),C.queue.submit([t.finish()]);if(e>0&&!(e%W)){await V.mapAsync(GPUMapMode.READ,0,b);const t=V.getMappedRange(0,b),n=new Uint32Array(t.slice(0))[e]/E.length;if(V.unmap(),e>=1&&n<c.threshold){if(W=1,H++,H===c.numCyclesBelowThreshold)break}else W=c.numCyclesInterval}if(B&&performance.now()>B){console.warn(`Exceeded processing time limit (${d})ms`);break}}const F=C.createCommandEncoder(),G=(p+1)%2,$=C.createBuffer({size:T,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST}),z=C.createBuffer({size:A,usage:GPUBufferUsage.MAP_READ|GPUBufferUsage.COPY_DST});F.copyBufferToBuffer(M[G],0,$,0,T),F.copyBufferToBuffer(P,0,z,0,A),C.queue.submit([F.finish()]),await $.mapAsync(GPUMapMode.READ,0,T);const q=$.getMappedRange(0,T),K=new Uint32Array(q);f.set(K),$.unmap(),await z.mapAsync(GPUMapMode.READ,0,A);const j=z.getMappedRange(0,A),Z=new Int32Array(j.slice(0));z.unmap();const Y=Z[0],J=Z[1],X=Z[2],Q=Z[3],ee=Z[4],te=Z[5];g.voxelManager.setCompleteScalarDataArray(f),g.voxelManager.clearBounds(),g.voxelManager.setBounds([[Y,Q],[J,ee],[X,te]])}},20271:(e,t,n)=>{"use strict";n.d(t,{z:()=>c});var o=n(15327),i=n(66499);const a=254,s=255,r=[-1/0,-995],l=[0,1900];async function d(e,t){const n=o.volumeLoader.createAndCacheDerivedLabelmapVolume(e.volumeId);return function(e,t,n){const{positiveSeedValue:o=a,positivePixelRange:i=l}=n,s=e.voxelManager.getCompleteScalarDataArray(),[r,d,c]=(t.voxelManager.getCompleteScalarDataArray(),t.dimensions),h=Math.floor(c/2),g=Math.max(h-3,0),u=Math.max(g+5,c),m=r*d;for(let e=g;e<u;e++){const n=e*m;for(let e=0;e<d;e++){const a=e*r;for(let e=0;e<r;e++){const r=n+a+e,l=s[r];l>=i[0]&&l<=i[1]&&t.voxelManager.setAtIndex(r,o)}}}}(e,n,t),function(e,t,n){const{negativeSeedValue:o=s,negativePixelRange:i=r}=n,a=e.voxelManager.getCompleteScalarDataArray(),[l,d,c]=t.dimensions,h=Math.floor(c/2),g=new Array(l*d).fill(!1),u=h*l*d,m=(e,n)=>{const s=[[e,n]];for(;s.length;){const[e,n]=s.shift(),r=n*l+e;if(e<0||e>=l||n<0||n>=d||g[r])continue;g[r]=!0;const c=u+r,h=a[c];h<i[0]||h>i[1]||(t.voxelManager.setAtIndex(c,o),s.push([e-1,n]),s.push([e+1,n]),s.push([e,n-1]),s.push([e,n+1]))}},v=(e,t,n,o)=>{for(let s=e;s!==t;s+=n){const e=o*l+s,t=a[u+e];if(t<i[0]||t>i[1])break;g[e]||m(s,o)}};for(let e=0;e<d;e++)v(0,l-1,1,e),v(l-1,0,-1,e)}(e,n,t),n}async function c(e,t,n){const{boundingBox:a}=t,{ijkTopLeft:s,ijkBottomRight:r}=a,l={minX:s[0],maxX:r[0],minY:s[1],maxY:r[1],minZ:s[2],maxZ:r[2]},c=o.utilities.createSubVolume(e,l,{targetBuffer:{type:"Float32Array"}}),h=await d(c,n);return await(0,i.e)(c.volumeId,h.volumeId),h}},73569:(e,t,n)=>{"use strict";n.d(t,{n:()=>m});var o=n(3823),i=n(15327),a=n(66499),s=n(4296);const{transformWorldToIndex:r}=i.utilities,l=254,d=255,c=.1,h=.8;function g(e,t){const n=e.imageData.getDirection(),i=o.eR.fromValues(n[3],n[4],n[5]),{center:a,radius:l}=t,d=e.imageData,c=o.eR.scaleAndAdd(o.eR.create(),a,i,-l),h=o.eR.scaleAndAdd(o.eR.create(),a,i,l);return function(e,t){const{topLeftWorld:n,bottomRightWorld:o}=t,i=r(e.imageData,n),a=r(e.imageData,o);return{...t,topLeftIJK:i,bottomRightIJK:a}}(e,(0,s.R)([h,c],d))}async function u(e,t,n,a){const s=await i.volumeLoader.createAndCacheDerivedLabelmapVolume(e.volumeId);return function(e,t,n,o){const i=e.voxelManager.getCompleteScalarDataArray(),a=n.center,[s,d,h]=e.dimensions,g=s*d,u=r(e.imageData,a),m=i[u[2]*g+u[1]*s+u[0]],v=o.positiveSeedValue??l,p=o.positiveSeedVariance??c,f=Math.abs(m*p),E=m-f,w=m+f,I=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]],C=u[2]*g+u[1]*s+u[0];t.voxelManager.setAtIndex(C,v);const T=[u];for(;T.length;){const e=T.shift(),[n,o,a]=e;for(let e=0,r=I.length;e<r;e++){const r=I[e],l=n+r[0],c=o+r[1],u=a+r[2];if(l<0||l>=s||c<0||c>=d||u<0||u>=h)continue;const m=u*g+c*s+l,p=i[m];t.voxelManager.getAtIndex(m)===v||p<E||p>w||(t.voxelManager.setAtIndex(m,v),T.push([l,c,u]))}}}(e,s,t,a),function(e,t,n,a,s){const l=e.voxelManager.getCompleteScalarDataArray(),[c,g,u]=t.dimensions,m=c*g,{worldVecRowDir:v,worldVecSliceDir:p}=i.utilities.getVolumeDirectionVectors(t.imageData,a.getCamera()),f=r(e.imageData,n.center),E=l[f[2]*c*g+f[1]*c+f[0]],w=s.negativeSeedVariance??h,I=s?.negativeSeedValue??d,C=Math.abs(E*w),T=E-C,b=E+C,A=2*Math.PI/360,_=o.Yu.setAxisAngle(o.Yu.create(),p,A),S=o.eR.clone(v);for(let e=0;e<360;e++){const e=o.eR.scaleAndAdd(o.eR.create(),n.center,S,n.radius),i=r(t.imageData,e),[a,s,d]=i;if(o.eR.transformQuat(S,S,_),a<0||a>=c||s<0||s>=g||d<0||d>=u)continue;const h=a+s*c+d*m,v=l[h];(v<T||v>b)&&t.voxelManager.setAtIndex(h,I)}}(e,s,t,n,a),s}async function m(e,t,n,o){const s=function(e,t,n){const o=e.imageData,a=n.getCamera(),{ijkVecRowDir:s,ijkVecColDir:r}=i.utilities.getVolumeDirectionVectors(o,a);if([s,r].some(e=>!i.utilities.isEqual(Math.abs(e[0]),1)&&!i.utilities.isEqual(Math.abs(e[1]),1)&&!i.utilities.isEqual(Math.abs(e[2]),1)))return void console.warn("Oblique view is not supported!");const{boundsIJK:l}=g(e,t),d={minX:l[0][0],maxX:l[0][1]+1,minY:l[1][0],maxY:l[1][1]+1,minZ:l[2][0],maxZ:l[2][1]+1};return i.utilities.createSubVolume(e.volumeId,d,{targetBuffer:{type:"Float32Array"}})}(i.cache.getVolume(e),t,n),r=await u(s,t,n,o);return await(0,a.e)(s.volumeId,r.volumeId),r}},16171:(e,t,n)=>{"use strict";n.d(t,{HW:()=>d,sG:()=>l});var o=n(15327),i=n(66499),a=n(10564);const{transformWorldToIndex:s}=o.utilities,r=1e5;function l(e,t,n){const{dimensions:i,imageData:l}=e,[d,c,h]=i,g=e.voxelManager,u=g.getCompleteScalarDataArray(),m=d*c,v=n?.initialNeighborhoodRadius??a.Sp,p=n?.positiveStdDevMultiplier??a.ee,f=n?.negativeStdDevMultiplier??a.ag,E=n?.negativeSeedMargin??a.BX,w=n?.negativeSeedsTargetPatches??a.Zi,I=s(l,t).map(Math.round),C=g.toIndex(I);if(I[0]<0||I[0]>=d||I[1]<0||I[1]>=c||I[2]<0||I[2]>=h)return console.warn("Click position is outside volume bounds."),null;const T=o.utilities.calculateNeighborhoodStats(u,i,I,v);0===T.count&&(T.mean=u[C],T.stdDev=0);const b=T.mean-p*T.stdDev,A=T.mean+p*T.stdDev,_=[[-1,0,0],[1,0,0],[0,-1,0],[0,1,0],[0,0,-1],[0,0,1]];let S=1/0,D=1/0,y=1/0,M=-1/0,x=-1/0,R=-1/0;const P=new Set,L=[],k=u[C];if(!(k>=b&&k<=A))return console.warn("Clicked voxel intensity is outside the calculated positive range. No positive seeds generated."),{positiveSeedIndices:new Set,negativeSeedIndices:new Set};P.add(C),L.push(I),S=M=I[0],D=x=I[1],y=R=I[2];let O=0;for(;O<L.length&&P.size<r;){const[e,t,n]=L[O++];S=Math.min(e,S),D=Math.min(t,D),y=Math.min(n,y),M=Math.max(e,M),x=Math.max(t,x),R=Math.max(n,R);for(let o=0;o<_.length;o++){const[i,a,s]=_[o],l=e+i,g=t+a,v=n+s;if(l<0||l>=d||g<0||g>=c||v<0||v>=h)continue;const p=v*m+g*d+l;if(P.has(p))continue;const f=u[p];f>=b&&f<=A&&(P.add(p),P.size<r&&L.push([l,g,v]))}}if(P.size>=r&&console.debug(`Reached maximum number of positive seeds (${r}). Stopping BFS.`),0===P.size)return console.warn("No positive seeds found after BFS."),{positiveSeedIndices:new Set,negativeSeedIndices:new Set};let U=0,N=0;P.forEach(e=>{const t=u[e];U+=t,N+=t*t});const V=P.size,B=U/V,W=N/V-B*B,H=f*Math.sqrt(Math.max(0,W)),F=Math.max(0,S-E),G=Math.max(0,D-E),$=Math.max(0,y-E),z=Math.min(d-1,M+E),q=Math.min(c-1,x+E),K=Math.min(h-1,R+E),j=new Set;let Z=0,Y=0;const J=w*a.gN;for(;Y<w&&Z<J;){Z++;const e=Math.floor(Math.random()*(z-F+1)+F),t=Math.floor(Math.random()*(q-G+1)+G),n=Math.floor(Math.random()*(K-$+1)+$),o=n*m+t*d+e;if(P.has(o)||j.has(o))continue;const i=u[o];if(Math.abs(i-B)>H){let o=!1;for(let i=-1;i<=1;i++){const a=t+i;if(!(a<0||a>=c))for(let t=-1;t<=1;t++){const i=e+t;if(i<0||i>=d)continue;const s=n*m+a*d+i;P.has(s)||j.has(s)||(j.add(s),o=!0)}}o&&Y++}}return 0===j.size&&console.warn("Could not find any negative seeds. GrowCut might fail or produce poor results."),console.debug("positiveSeedIndices",P.size),console.debug("negativeSeedIndices",j.size),{positiveSeedIndices:P,negativeSeedIndices:j}}async function d({referencedVolumeId:e,worldPosition:t,options:n}){const s=o.cache.getVolume(e),d=o.volumeLoader.createAndCacheDerivedLabelmapVolume(e);d.voxelManager.forEach(({index:e,value:t})=>{0!==t&&d.voxelManager.setAtIndex(e,0)});const c=n.seeds??l(s,t,n),h=n?.positiveSeedValue??a.VD,g=n?.negativeSeedValue??a.bs;if(!c)return null;const{positiveSeedIndices:u,negativeSeedIndices:m}=c;return u.size<10||u.size>r||m.size<10?(console.warn("Not enough seeds found. GrowCut might fail or produce poor results."),d):(u.forEach(e=>{d.voxelManager.setAtIndex(e,h)}),m.forEach(e=>{d.voxelManager.setAtIndex(e,g)}),await(0,i.e)(e,d.volumeId,n),d)}},93759:(e,t,n)=>{"use strict";n.r(t),n.d(t,{IslandRemoval:()=>_.A,LabelmapMemo:()=>A,SegmentStatsCalculator:()=>g.A,VolumetricCalculator:()=>h.Ay,computeMetabolicStats:()=>k.B,computeStackLabelmapFromVolume:()=>x._,computeVolumeLabelmapFromStack:()=>R.a,contourAndFindLargestBidirectional:()=>m.A,createBidirectionalToolData:()=>v.A,createLabelmapVolumeForViewport:()=>s.A,createMergedLabelmapForIndex:()=>a.A,floodFill:()=>l.A,getBrushSizeForToolGroup:()=>d.A,getBrushThresholdForToolGroup:()=>c.Q,getBrushToolInstances:()=>T.n,getHoveredContourSegmentationAnnotation:()=>C.L,getOrCreateImageVolume:()=>D.A,getOrCreateSegmentationVolume:()=>S.A,getReferenceVolumeForSegmentationVolume:()=>P.b,getSegmentIndexAtLabelmapBorder:()=>I.T,getSegmentIndexAtWorldPoint:()=>w.hX,getSegmentLargestBidirectional:()=>L.T,getStatistics:()=>y.A,getUniqueSegmentIndices:()=>E.O,growCut:()=>b,invalidateBrushCursor:()=>f.E,rectangleROIThresholdVolumeByRange:()=>i.A,segmentContourAction:()=>p.A,setBrushSizeForToolGroup:()=>d.M,setBrushThresholdForToolGroup:()=>c.K,thresholdSegmentationByRange:()=>u.A,thresholdVolumeByRange:()=>o.A,triggerSegmentationRender:()=>r.h6,triggerSegmentationRenderBySegmentationId:()=>r.fy,validateLabelmap:()=>M});var o=n(8582),i=n(52323),a=n(4334),s=n(97492),r=n(24917),l=n(84882),d=n(17014),c=n(49492),h=n(68915),g=n(13179),u=n(73706),m=n(13276),v=n(14514),p=n(22592),f=n(35706),E=n(25758),w=n(71751),I=n(46507),C=n(20527),T=n(14957),b=n(95373),A=n(2397),_=n(67912),S=n(30722),D=n(83075),y=n(38440),M=n(21345),x=n(93690),R=n(6994),P=n(12853),L=n(78773),k=n(88274)},35706:(e,t,n)=>{"use strict";n.d(t,{E:()=>s});var o=n(77609),i=n(58640),a=n(14957);function s(e){const t=(0,o.getToolGroup)(e);if(void 0===t)return;(0,a.n)(e).forEach(e=>{e.invalidateBrushCursor()});const n=t.getViewportsInfo();if(!Object.keys(n).map(e=>n[e]).length)return;const s=t.getViewportIds();(0,i.A)(s)}},60213:(e,t,n)=>{"use strict";n.d(t,{Hs:()=>s,pW:()=>a});var o=n(15327),i=n(3823);function a(e,t,n){const o=n.toIJK(e),a=n.toIJK(t),s=i.eR.create(),{testIJK:r}=n,l=i.eR.sub(i.eR.create(),o,a),d=Math.round(Math.max(...l.map(Math.abs)));if(d<2)return!0;const c=i.eR.scale(i.eR.create(),l,1/d);for(let e=1;e<d;e++)if(i.eR.scaleAndAdd(s,a,c,e),!r(s))return!1;return!0}function s(e,t,n){const a=o.cache.getVolume(e);if(a)return function({dimensions:e,imageData:t,voxelManager:n,segmentIndex:o,containedSegmentIndices:a}){const s=e[0],r=s*e[1];return{testCenter:(e,l)=>{const d=i.eR.add(i.eR.create(),e,l).map(e=>e/2),c=t.worldToIndex(d).map(Math.round),[h,g,u]=c,m=h+g*s+u*r,v=n.getAtIndex(m);return v===o||a?.has(v)},toIJK:e=>t.worldToIndex(e),testIJK:e=>{const[t,i,l]=e,d=Math.round(t)+Math.round(i)*s+Math.round(l)*r,c=n.getAtIndex(d);return c===o||a?.has(c)}}}({dimensions:a.dimensions,imageData:a.imageData,voxelManager:a.voxelManager,segmentIndex:t,containedSegmentIndices:n});console.warn(`No volume found for ${e}`)}},67912:(e,t,n)=>{"use strict";n.d(t,{A:()=>l});var o=n(15327),i=n(27963);const{RLEVoxelMap:a,VoxelManager:s}=o.utilities;var r;!function(e){e[e.SEGMENT=-1]="SEGMENT",e[e.ISLAND=-2]="ISLAND",e[e.INTERIOR=-3]="INTERIOR",e[e.EXTERIOR=-4]="EXTERIOR",e[e.INTERIOR_SMALL=-5]="INTERIOR_SMALL",e[e.INTERIOR_TEST=-6]="INTERIOR_TEST"}(r||(r={}));class l{constructor(e){this.fillInternalEdge=!1,this.maxInternalRemove=128,this.maxInternalRemove=e?.maxInternalRemove??this.maxInternalRemove,this.fillInternalEdge=e?.fillInternalEdge??this.fillInternalEdge}initialize(e,t,n){const o=!!t.sourceVoxelManager,l=o?t.sourceVoxelManager:t,d=o?t:s.createRLEHistoryVoxelManager(l),{segmentIndex:c=1,previewSegmentIndex:h=1}=n,g=n.points||l.getPoints();if(!g?.length)return;const u=l.getBoundsIJK().map((e,t)=>[Math.min(e[0],...g.map(e=>e[t])),Math.max(e[1],...g.map(e=>e[t]))]);if(u.find(e=>e[0]<0||e[1]>65535))return;const{toIJK:m,fromIJK:v,boundsIJKPrime:p,error:f}=(0,i.A)(e,u);if(f)return void console.warn("Not performing island removal for planes not orthogonal to acquisition plane",f);const[E,w,I]=v(l.dimensions),C=new a(E,w,I);return C.fillFrom((e,t,n)=>{const o=l.toIndex(m([e,t,n])),i=l.getAtIndex(o);if(i===h||i===c)return r.SEGMENT},p),C.normalizer={toIJK:m,fromIJK:v,boundsIJKPrime:p},this.segmentSet=C,this.previewVoxelManager=d,this.segmentIndex=c,this.previewSegmentIndex=h??c,this.selectedPoints=g,!0}floodFillSegmentIsland(){const{selectedPoints:e,segmentSet:t}=this;let n=0;const{fromIJK:o}=t.normalizer;return e.forEach(e=>{const i=o(e),a=t.toIndex(i),[s,l,d]=i;t.get(a)===r.SEGMENT&&(n+=t.floodFill(s,l,d,r.ISLAND))}),n}removeExternalIslands(){const{previewVoxelManager:e,segmentSet:t}=this,{toIJK:n}=t.normalizer;t.forEach((o,i)=>{const[,a,s]=t.toIJK(o);if(i.value!==r.ISLAND)for(let t=i.start;t<i.end;t++){const o=n([t,a,s]),i=e.getAtIJKPoint(o);e.setAtIJKPoint(o,void 0===i?0:null)}},{rowModified:!0})}removeInternalIslands(){const{segmentSet:e,previewVoxelManager:t,previewSegmentIndex:n}=this,{height:o,normalizer:i,width:a}=e,{toIJK:s}=i;return e.forEachRow((t,n)=>{let o;for(const i of[...n])if(i.value===r.ISLAND)if(o){for(let n=o.end;n<i.start;n++)e.set(t+n,r.INTERIOR);o=i}else{if(this.fillInternalEdge&&i.start>0)for(let n=0;n<i.start;n++)e.set(t+n,r.INTERIOR);o=i}if(this.fillInternalEdge&&o?.end<a)for(let n=o.end;n<a;n++)e.set(t+n,r.INTERIOR)}),e.forEach((t,n)=>{if(n.value!==r.INTERIOR)return;const[,i,a]=e.toIJK(t),s=i>0?e.getRun(i-1,a):null,d=i+1<o?e.getRun(i+1,a):null,c=i===o-1,h=0===i,g=l.covers(n,s)||h&&this.fillInternalEdge,u=l.covers(n,d)||c&&this.fillInternalEdge;!(n.end-n.start>2)||g&&u||e.floodFill(n.start,i,a,r.EXTERIOR,{singlePlane:!0})}),e.forEach((t,n)=>{if(n.value!==r.INTERIOR)return;const[,o,i]=e.toIJK(t),a=e.floodFill(n.start,o,i,r.INTERIOR_TEST)>this.maxInternalRemove?r.EXTERIOR:r.INTERIOR_SMALL;e.floodFill(n.start,o,i,a)}),e.forEach((o,i)=>{if(i.value===r.INTERIOR_SMALL)for(let a=i.start;a<i.end;a++){const i=s(e.toIJK(o+a));t.setAtIJKPoint(i,n)}}),t.getArrayOfModifiedSlices()}static covers(e,t){if(!t)return!1;let{start:n}=e;const{end:o}=e;for(const e of t)if(n>=e.start&&n<e.end&&(n=e.end,n>=o))return!0;return!1}}},52323:(e,t,n)=>{"use strict";n.d(t,{A:()=>l});var o=n(47807),i=n(67847),a=n(40336),s=n(8582),r=n(37162);const l=function(e,t,n,l){const d=e.map(e=>o.state.getAnnotation(e));let c;!function(e){const t=[a.A.toolName,i.A.toolName];for(const n of e){const e=n.metadata.toolName;if(!t.includes(e))throw new Error("rectangleROIThresholdVolumeByRange only supports RectangleROIThreshold and RectangleROIStartEndThreshold annotations")}}(d);for(let e=0;e<n.length;e++){n[e].volume.voxelManager.getScalarDataLength()!==t.voxelManager.getScalarDataLength()&&0!==e||(c=(0,r.A)(d,n[e].volume,l))}const h=(0,s.A)(t,n,{...l,boundsIJK:c,segmentationId:l.segmentationId});return h.modified(),h}},22592:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var o=n(15327),i=n(47807),a=n(13276),s=n(14514),r=n(25072),l=n(70758),d=n(60740);async function c(e,t){console.warn("Deprecation Alert: There is a new getSegmentLargestBidirectional function that handles volume, stack and individual segment cases properly. This function is deprecated and will be removed in a future version.");const{data:n}=t,d=(0,o.getEnabledElement)(e),c=(n.getSegment||h)(d,n);if(!c)return;const g=d.viewport.getFrameOfReferenceUID(),u=(0,l.K)(),{segmentIndex:m,segmentationId:v}=c,p=i.state.getAnnotations(this.toolName||r.A.toolName,g);let f=!1;const E=p.filter(e=>{const t=e.data.segment;return!!t&&(t.segmentationId===v&&t.segmentIndex===m&&(f=!0,e.data.segment=t),!0)});let w;if(f||E.push({data:{segment:c}}),E.forEach(async e=>{const t=[],n=e.data.segment,{segmentIndex:o,segmentationId:r}=n;t[o]=n,i.state.removeAnnotation(e.annotationUID);const l=await(0,a.A)({...u.find(e=>e.segmentationId===r),segments:t});if(!l)return;const h=(0,s.A)(l,d.viewport);h.annotationUID=e.annotationUID,h.data.segment=n;const m=i.state.addAnnotation(h,g);if(n.segmentIndex===c.segmentIndex&&n.segmentationId===c.segmentationId){w=l;const{style:e}=c;e&&i.config.style.setAnnotationStyles(m,e)}}),w){const{sliceIndex:t}=w,n=d.viewport.getImageIds();o.utilities.jumpToSlice(e,{imageIndex:n.length-1-t}),d.viewport.render()}else console.warn("No bidirectional found");return w}function h(e,t){const n=(0,l.K)();if(!n.length)return;const o=t.segmentationId||n[0].segmentationId,i=t.segmentIndex??(0,d.Q)(o);if(!i)return;const a=t.segmentData?.get(i);return{label:`Segment ${i}`,segmentIndex:i,segmentationId:o,...a}}},73706:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var o=n(49906),i=n(64063);const a=function(e,t,n,a,s){if(!s)throw new Error("Segmentation ID is required to be passed inside thresholdSegmentationByRange");const{baseVolumeIdx:r,volumeInfoList:l}=(0,i.zf)(e,n),{voxelManager:d}=l[r],c=d,h=e.voxelManager.getScalarDataLength(),g=e.voxelManager;return l.forEach(e=>{const{volumeSize:n}=e;n===h?function(e,t,n,o){const{lower:i,upper:a}=o,s=e.getScalarDataLength();for(let o=0;o<s;o++)if(e.getAtIndex[o]===n){const s=t.getAtIndex(o);e.setAtIndex(o,s>=i&&s<=a?n:0)}}(g,c,t,e):function(e,t,n,o,a,s,r){const{imageData:l,lower:d,upper:c,dimensions:h}=o;let g,u,m;const v=e.getScalarDataLength();for(let t=0;t<v;t++)if(v.getAtIndex(t)===n){const o=(0,i.Q5)(l,h,a[s].spacing,a[s].imageData.getPoint(t)),v=({value:e})=>{g+=1,e>=m.lower&&e<=m.upper&&(u+=1)};g=0,u=0,m={lower:d,upper:c};let p=!1;e.forEach(v,{imageData:l,boundsIJK:o}),p=0===r?u>0:u===g,e.setAtIndex(t,p?n:0)}}(g,0,t,e,l,r,a)}),(0,o.triggerSegmentationDataModified)(s),e}},8582:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var o=n(49906),i=n(64063);const a=function(e,t,n){const{imageData:a}=e,{overwrite:s,boundsIJK:r,segmentationId:l}=n;if(!l)throw new Error("Segmentation ID is required to be passed inside thresholdVolumeByRange as options");const d=n?.overlapType||0,c=e.voxelManager,h=e.voxelManager.getScalarDataLength();if(s)for(let e=0;e<h;e++)c.setAtIndex(e,0);const{baseVolumeIdx:g,volumeInfoList:u}=(0,i.zf)(e,t);let m,v,p;const f=(e,t,n)=>{const{imageData:o,dimensions:a,lower:s,upper:r}=e,l=(0,i.Q5)(o,a,t,n);v=0,m=0,p={lower:s,upper:r};let c=!1;const{voxelManager:h}=o.get("voxelManager");return h.forEach(({value:e})=>{v+=1,e>=p.lower&&e<=p.upper&&(m+=1)},{imageData:o,boundsIJK:l}),0===d?c=m>0:1==d&&(c=m===v),c},E=(e,t)=>{const{imageData:n,lower:o,upper:i}=e,a=n.get("voxelManager").voxelManager,s=a.toIndex(t),r=a.getAtIndex(s);return!(r<=o||r>=i)};return e.voxelManager.forEach(({index:e,pointIJK:t,pointLPS:o})=>{let i=u.length>0;for(let e=0;e<u.length&&(i=u[e].volumeSize===h?E(u[e],t):f(u[e],u[g].spacing,o),i);e++);i&&c.setAtIndex(e,n.segmentIndex||1)},{imageData:a,boundsIJK:r}),(0,o.triggerSegmentationDataModified)(n.segmentationId),e}},64063:(e,t,n)=>{"use strict";n.d(t,{Dm:()=>h,HM:()=>d,Q5:()=>s,R1:()=>c,zf:()=>r});var o=n(15327),i=n(87063);const a=(e,t)=>JSON.stringify(e)===JSON.stringify(t);function s(e,t,n,a){const s=n[0]/2,r=n[1]/2,l=n[2]/2,d=new Array(8);d[0]=o.utilities.transformWorldToIndex(e,[a[0]-s,a[1]-r,a[2]-l]);const c=[[1,-1,-1],[-1,1,-1],[1,1,-1],[-1,-1,1],[1,-1,1],[-1,1,1],[1,1,1]];for(let t=0;t<7;t++){const[n,i,h]=c[t];d[t+1]=o.utilities.transformWorldToIndex(e,[a[0]+n*s,a[1]+i*r,a[2]+h*l])}return(0,i.g)(d,t)}function r(e,t){const{spacing:n}=e,o=e.voxelManager.getScalarDataLength(),i=[];let s=0;for(let e=0;e<t.length;e++){const{imageData:r,spacing:l,dimensions:d,voxelManager:c}=t[e].volume,h=t[e].volume.voxelManager.getScalarDataLength();h===o&&a(l,n)&&(s=e);const g=t[e].lower,u=t[e].upper;i.push({imageData:r,lower:g,upper:u,spacing:l,dimensions:d,volumeSize:h,voxelManager:c})}return{volumeInfoList:i,baseVolumeIdx:s}}const l=new Map,d=e=>{const t=l.get(e);t&&(t.isDirty=!0)},c=e=>{const t=l.get(e);return t&&!t.isDirty?t.indices:null},h=(e,t)=>{l.set(e,{indices:t,isDirty:!1})}},54285:(e,t,n)=>{"use strict";n.d(t,{Dn:()=>g,FI:()=>u,o9:()=>h,sg:()=>d,yR:()=>c});var o=n(15327),i=n(60740),a=n(33283),s=n(40905),r=n(38732),l=n(62753);const d=(e,t)=>{(0,o.triggerEvent)(o.eventTarget,o.Enums.Events.WEB_WORKER_PROGRESS,{progress:t,type:e})},c=(e,t)=>{const n=(0,a.T)(e),{representationData:s}=n,{Labelmap:r}=s;if(!r)return console.debug("No labelmap found for segmentation",e),null;const l=r.volumeId,d=r.imageIds,c={segmentationId:e,volumeId:l,imageIds:d};let h=!1;if(d){const e=d.map(e=>o.cache.getImage(e).referencedImageId);h=o.utilities.isValidVolume(e)}let g=t;return g?Array.isArray(g)||(g=[g,255]):g=[(0,i.Q)(e)],{operationData:c,segVolumeId:l,segImageIds:d,reconstructableVolume:h,indices:g}},h=e=>(0,s.S)({operationData:e,strategy:{ensureSegmentationVolumeFor3DManipulation:r.A.ensureSegmentationVolumeFor3DManipulation,ensureImageVolumeFor3DManipulation:l.A.ensureImageVolumeFor3DManipulation}}),g=e=>{const t=[],n=[];for(const i of e){const e=o.cache.getImage(i),a=e.getPixelData(),{origin:s,direction:r,spacing:l,dimensions:d}=o.utilities.getImageDataMetadata(e);t.push({scalarData:a,dimensions:d,spacing:l,origin:s,direction:r});const c=e.referencedImageId;if(c){const e=o.cache.getImage(c);if(!e)continue;const t=e.getPixelData(),i=e.voxelManager,a=[e.rowPixelSpacing,e.columnPixelSpacing];n.push({scalarData:t,dimensions:i?i.dimensions:[e.columns,e.rows,1],spacing:a})}}return{segmentationInfo:t,imageInfo:n}},u=(e,t)=>{let n;if(e){const t=o.cache.getVolume(e).imageIds,i=o.cache.getImage(t[0]);i&&(n=i.referencedImageId)}else if(t?.length){n=o.cache.getImage(t[0]).referencedImageId}const i=o.cache.getImage(n),a=o.metaData.get("scalingModule",n);return{refImageId:n,modalityUnitOptions:{isPreScaled:Boolean(i?.preScale?.scaled),isSuvScaled:"number"==typeof a?.suvbw}}}},21345:(e,t,n)=>{"use strict";n.r(t),n.d(t,{validate:()=>s,validatePublic:()=>a});var o=n(15327);function i(e){if("volumeId"in e){if(!o.cache.getVolume(e.volumeId))throw new Error(`volumeId of ${e.volumeId} not found in cache, you should load and cache volume before adding segmentation`)}else{if(!("imageIds"in e))throw new Error("The segmentationInput.representationData is undefined, please provide a valid representationData");if(!e.imageIds)throw new Error("The segmentationInput.representationData.imageIds is undefined, please provide a valid representationData.imageIds for stack data")}}function a(e){if(!e.representation.data)throw new Error("The segmentationInput.representationData.data is undefined, please provide a valid representationData.data");i(e.representation.data)}function s(e){i(e)}},1355:(e,t,n)=>{"use strict";n.d(t,{A:()=>a});var o=n(44049),i=n(99737);function a(e,t,n){e.data.label=n,(0,o.triggerAnnotationModified)(e,t,i.ChangeTypes.LabelChange)}},71132:(e,t,n)=>{"use strict";n.d(t,{N:()=>i.A,S:()=>o.A});var o=n(34331),i=n(52734)},52734:(e,t,n)=>{"use strict";n.d(t,{A:()=>h});var o=n(15327),i=n(30045),a=n(94762);let s,r={maxImagesToPrefetch:1/0,minBefore:2,maxAfter:2,directionExtraImages:10,preserveExistingPool:!1};function l(e){const t=(0,a.bV)(e);if(!t)return;if(!t?.imageIds?.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const n=(0,i.k)(e);if(!n)return;const s=n||{};if(s.enabled=s.enabled&&(s.indicesToRequest?.length??0)>0,!1===s.enabled)return;function d(e){const t=s.indicesToRequest.indexOf(e);t>-1&&s.indicesToRequest.splice(t,1)}const h=s.indicesToRequest.slice(),{currentImageIdIndex:g}=t;if(h.forEach(e=>{const n=t.imageIds[e];if(!n)return;(Math.abs(g-e)<6?o.cache.getImageLoadObject(n):o.cache.isLoaded(n))&&d(e)}),!s.indicesToRequest.length)return;r.preserveExistingPool||o.imageLoadPoolManager.filterRequests((0,a.Pg)(t));const u=(n,i)=>o.imageLoader.loadAndCacheImage(n,i).then(()=>function(n){d(t.imageIds.indexOf(n));const i=o.cache.getCachedImageBasedOnImageURI(n),{stats:a}=s,r=i?.image?.decodeTimeInMS||0;if(r){a.imageIds.set(n,r),a.decodeTimeInMS+=r;const e=i?.image?.loadTimeInMS||0;a.loadTimeInMS+=e}if(!s.indicesToRequest.length&&i?.sizeInBytes){const{sizeInBytes:t}=i,n=o.cache.getMaxCacheSize()/4/t;if(s.cacheFill){if(a.imageIds.size){a.fillTime=Date.now()-a.start;const{size:e}=a.imageIds;a.fillSize=e}}else a.initialTime=Date.now()-a.start,a.initialSize=a.imageIds.size,c(e,n),l(e)}}(n));s.indicesToRequest.forEach(e=>{const n=t.imageIds[e],i={requestType:a.y9};o.imageLoadPoolManager.addRequest(u.bind(null,n,i),a.y9,{imageId:n},a.Lr)})}function d(e){clearTimeout(s),s=setTimeout(function(){const t=e.target;try{c(t),l(t)}catch(e){return}},5)}const c=(e,t)=>{const n=(0,a.bV)(e);if(!n)return;if(!n.imageIds?.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const{currentImageIdIndex:o}=n;let{maxAfter:s=2,minBefore:l=2}=r;const{directionExtraImages:d=10}=r,c=(0,i.k)(e)||{indicesToRequest:[],currentImageIdIndex:o,stackCount:0,enabled:!0,direction:1,stats:{start:Date.now(),imageIds:new Map,decodeTimeInMS:0,loadTimeInMS:0,totalBytes:0}},h=o-c.currentImageIdIndex;if(c.direction=h<0?-1:1,c.currentImageIdIndex=o,c.enabled=!0,c.stackCount<100&&(c.stackCount+=d),Math.abs(h)>s||!h)if(c.stackCount=0,t){const e=o/n.imageIds.length;l=Math.ceil(t*e),s=Math.ceil(t*(1-e)),c.cacheFill=!0}else c.cacheFill=!1;else h<0?(l+=c.stackCount,s=0):(s+=c.stackCount,l=0);const g=Math.max(0,o-l),u=Math.min(n.imageIds.length-1,o+s),m=[];for(let e=o+1;e<=u;e++)m.push(e);for(let e=o-1;e>=g;e--)m.push(e);c.indicesToRequest=m,(0,i.P)(e,c)};const h={enable:e=>{const t=(0,a.bV)(e);if(!t)return;if(!t.imageIds?.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");c(e),l(e),e.removeEventListener(o.Enums.Events.STACK_NEW_IMAGE,d),e.addEventListener(o.Enums.Events.STACK_NEW_IMAGE,d);const n=(0,a.m0)(e);o.eventTarget.removeEventListener(o.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,n),o.eventTarget.addEventListener(o.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,n)},disable:function(e){clearTimeout(s),e.removeEventListener(o.Enums.Events.STACK_NEW_IMAGE,d);const t=(0,a.m0)(e);o.eventTarget.removeEventListener(o.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,t);const n=(0,i.k)(e);n&&(n.enabled=!1)},getConfiguration:function(){return r},setConfiguration:function(e){r=e}}},34331:(e,t,n)=>{"use strict";n.d(t,{A:()=>c});var o=n(15327),i=n(30045),a=n(94762);let s,r={maxImagesToPrefetch:1/0,preserveExistingPool:!0};function l(e){const t=(0,i.k)(e);if(!t)return;const n=t||{},s=(0,a.bV)(e);if(!s?.imageIds?.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const{currentImageIdIndex:l}=s;if(n.enabled=n.enabled&&(n.indicesToRequest?.length??0)>0,!1===n.enabled)return;function d(e){const t=n.indicesToRequest.indexOf(e);t>-1&&n.indicesToRequest.splice(t,1)}t.indicesToRequest.sort((e,t)=>e-t);if(n.indicesToRequest.slice().forEach(function(e){const t=s.imageIds[e];if(!t)return;(Math.abs(l-e)<6?o.cache.getImageLoadObject(t):o.cache.isLoaded(t))&&d(e)}),!n.indicesToRequest.length)return;r.preserveExistingPool||o.imageLoadPoolManager.clearRequestStack(a.y9);const c=(0,a.zo)(n.indicesToRequest,s.currentImageIdIndex);let h,g;let u=c.low,m=c.high;const v=[];for(;u>=0||m<n.indicesToRequest.length;){const e=s.currentImageIdIndex,t=!(e-n.indicesToRequest[u]>r.maxImagesToPrefetch)&&u>=0,o=!(n.indicesToRequest[m]-e>r.maxImagesToPrefetch)&&m<n.indicesToRequest.length;if(!o&&!t)break;t&&(g=n.indicesToRequest[u--],h=s.imageIds[g],v.push(h)),o&&(g=n.indicesToRequest[m++],h=s.imageIds[g],v.push(h))}const p=(e,t)=>o.imageLoader.loadAndCacheImage(e,t);v.forEach(e=>{const t={requestType:a.y9};o.imageLoadPoolManager.addRequest(p.bind(null,e,t),a.y9,{imageId:e},a.Lr)})}function d(e){clearTimeout(s),s=setTimeout(function(){const t=e.target;try{l(t)}catch(e){return}},10)}const c={enable:function(e){const t=(0,a.bV)(e);if(!t||!t.imageIds||0===t.imageIds.length)return void console.warn("CornerstoneTools.stackPrefetch: No images in stack.");const n={indicesToRequest:(0,a.y1)(0,t.imageIds.length-1),enabled:!0,direction:1},s=n.indicesToRequest.indexOf(t.currentImageIdIndex);n.indicesToRequest.splice(s,1),(0,i.P)(e,n),l(e),e.removeEventListener(o.Enums.Events.STACK_NEW_IMAGE,d),e.addEventListener(o.Enums.Events.STACK_NEW_IMAGE,d);const r=(0,a.m0)(e);o.eventTarget.removeEventListener(o.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,r),o.eventTarget.addEventListener(o.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,r)},disable:function(e){clearTimeout(s),e.removeEventListener(o.Enums.Events.STACK_NEW_IMAGE,d);const t=(0,a.m0)(e);o.eventTarget.removeEventListener(o.Enums.Events.IMAGE_CACHE_IMAGE_REMOVED,t);const n=(0,i.k)(e);n&&n.indicesToRequest.length&&(n.enabled=!1,o.imageLoadPoolManager.clearRequestStack(a.y9))},getConfiguration:function(){return r},setConfiguration:function(e){r=e}}},76260:(e,t,n)=>{"use strict";function o(e,t){const n=d(e),o=d(t);return{page:h(n.page,o.page),client:h(n.client,o.client),canvas:h(n.canvas,o.canvas),world:(i=n.world,a=o.world,[i[0]-a[0],i[1]-a[1],i[2]-a[2]])};var i,a}function i(e,t){const n=d(e),o=d(t);return{page:u(n.page,o.page),client:u(n.client,o.client),canvas:u(n.canvas,o.canvas),world:m(n.world,o.world)}}function a(e,t){}function s(e,t){const n=g(e),o=g(t);return{page:n.page-o.page,client:n.client-o.client,canvas:n.canvas-o.canvas,world:n.world-o.world}}function r(e){return JSON.parse(JSON.stringify(e))}function l(e){return JSON.parse(JSON.stringify(e))}function d(e){return e.reduce((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length]}),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0]})}function c(e){return e.reduce((t,n)=>({page:[t.page[0]+n.page[0]/e.length,t.page[1]+n.page[1]/e.length],client:[t.client[0]+n.client[0]/e.length,t.client[1]+n.client[1]/e.length],canvas:[t.canvas[0]+n.canvas[0]/e.length,t.canvas[1]+n.canvas[1]/e.length],world:[t.world[0]+n.world[0]/e.length,t.world[1]+n.world[1]/e.length,t.world[2]+n.world[2]/e.length],touch:{identifier:null,radiusX:t.touch.radiusX+n.touch.radiusX/e.length,radiusY:t.touch.radiusY+n.touch.radiusY/e.length,force:t.touch.force+n.touch.force/e.length,rotationAngle:t.touch.rotationAngle+n.touch.rotationAngle/e.length}}),{page:[0,0],client:[0,0],canvas:[0,0],world:[0,0,0],touch:{identifier:null,radiusX:0,radiusY:0,force:0,rotationAngle:0}})}function h(e,t){return[e[0]-t[0],e[1]-t[1]]}function g(e){const t=[];for(let n=0;n<e.length;n++)for(let o=0;o<e.length;o++)n<o&&t.push({page:u(e[n].page,e[o].page),client:u(e[n].client,e[o].client),canvas:u(e[n].canvas,e[o].canvas),world:m(e[n].world,e[o].world)});return t.reduce((e,n)=>({page:e.page+n.page/t.length,client:e.client+n.client/t.length,canvas:e.canvas+n.canvas/t.length,world:e.world+n.world/t.length}),{page:0,client:0,canvas:0,world:0})}function u(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2))}function m(e,t){return Math.sqrt(Math.pow(e[0]-t[0],2)+Math.pow(e[1]-t[1],2)+Math.pow(e[2]-t[2],2))}n.r(t),n.d(t,{copyPoints:()=>l,copyPointsList:()=>r,getDeltaDistance:()=>i,getDeltaDistanceBetweenIPoints:()=>s,getDeltaPoints:()=>o,getDeltaRotation:()=>a,getMeanPoints:()=>d,getMeanTouchPoints:()=>c})},56069:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(39011);const i=function(e){o.o.renderViewport(e)}},94779:(e,t,n)=>{"use strict";n.d(t,{A:()=>r,_:()=>s});var o=n(15327),i=n(56069),a=n(77609);function s(e){e.forEach(e=>{const t=(0,a.getToolGroup)(e);if(!t)return void console.warn(`ToolGroup not available for ${e}`);t.getViewportsInfo().forEach(e=>{const{renderingEngineId:t,viewportId:n}=e,a=(0,o.getRenderingEngine)(t);if(!a)return void console.warn(`RenderingEngine not available for ${t}`);const s=a.getViewport(n);(0,i.A)(s.element)})})}const r=s},58640:(e,t,n)=>{"use strict";n.d(t,{A:()=>s,t:()=>a});var o=n(15327),i=n(56069);function a(e){e.length&&e.forEach(e=>{const t=(0,o.getEnabledElementByViewportId)(e);if(!t)return void console.warn(`Viewport not available for ${e}`);const{viewport:n}=t;if(!n)return void console.warn(`Viewport not available for ${e}`);const a=n.element;(0,i.A)(a)})}const s=a},3198:(e,t,n)=>{"use strict";function o(e,t){const n=e.length,o=[];for(let i=0;i<n;i++){const n=e[i];n.getFrameOfReferenceUID()===t&&o.push(n)}return o}n.d(t,{A:()=>o})},67514:(e,t,n)=>{"use strict";n.d(t,{A:()=>i});var o=n(3823);const i=function(e,t,n=.999){return e.filter(e=>{const i=e.getCamera();return Math.abs(o.eR.dot(i.viewPlaneNormal,t.viewPlaneNormal))>n})}},9356:(e,t,n)=>{"use strict";n.d(t,{A:()=>l});var o=n(99737),i=n(77609);const{Active:a,Passive:s,Enabled:r}=o.ToolModes;function l(e,t){const n=e.length,o=[];for(let a=0;a<n;a++){const n=e[a],s=(0,i.getToolGroupForViewport)(n.id,n.renderingEngineId);if(!s)continue;d(s,t)&&o.push(n)}return o}function d(e,t){const{toolOptions:n}=e,o=n[t];if(!o)return!1;const i=o.mode;return i===a||i===s||i===r}},60810:(e,t,n)=>{"use strict";n.r(t),n.d(t,{filterViewportsWithFrameOfReferenceUID:()=>o.A,filterViewportsWithParallelNormals:()=>s.A,filterViewportsWithToolEnabled:()=>i.A,getViewportIdsWithToolToRender:()=>a.A});var o=n(3198),i=n(9356),a=n(14543),s=n(67514)},19027:(e,t,n)=>{"use strict";n.r(t),n.d(t,{isViewportPreScaled:()=>o.u});var o=n(18990)},4848:(e,t,n)=>{"use strict";n.d(t,{P:()=>g});var o=n(3823),i=n(15327),a=n(57227),s=n(20646),r=n(33517),l=n(62184),d=n(79457),c=n(44845);const h={MULTIPLIER:1,RANGE_TEXT_POSITION:s.U.Right,TICKS_BAR_SIZE:50};class g extends c.A{constructor(e){super(e),this._isMouseOver=!1,this._isInteracting=!1,this._mouseOverCallback=e=>{this._isMouseOver=!0,this.showTicks(),e.stopPropagation()},this._mouseOutCallback=e=>{this._isMouseOver=!1,this.hideTicks(),e.stopPropagation()},this._mouseDownCallback=e=>{this._isInteracting=!0,this.showTicks(),this._addVOIEventListeners(e),e.stopPropagation()},this._mouseDragCallback=(e,t)=>{const n=this.getVOIMultipliers(),a=this._getPointsFromMouseEvent(e),{points:s,voiRange:r}=t,l=o.Zc.sub(o.Zc.create(),a.local,s.local),d=l[0]*n[0],c=l[1]*n[1];if(!d&&!c)return;const{lower:h,upper:g}=r;let{windowWidth:u,windowCenter:m}=i.utilities.windowLevel.toWindowLevel(h,g);u=Math.max(u+d,1),m+=c;const v=i.utilities.windowLevel.toLowHighRange(u,m);this.voiRange=v,e.stopPropagation(),e.preventDefault()},this._mouseUpCallback=e=>{this._isInteracting=!1,this.hideTicks(),this._removeVOIEventListeners(),e.stopPropagation()},this._eventListenersManager=new i.utilities.eventListener.MultiTargetEventListenerManager,this._colormaps=g.getColormapsMap(e),this._activeColormapName=g.getInitialColormapName(e),this._canvas=this._createCanvas(e),this._ticksBar=this._createTicksBar(e),this._rangeTextPosition=e.ticks?.position??h.RANGE_TEXT_POSITION,this._canvas.appendTo(this.rootElement),this._ticksBar.appendTo(this.rootElement),this._addRootElementEventListeners()}get activeColormapName(){return this._activeColormapName}set activeColormapName(e){if(e===this._activeColormapName)return;const t=this._colormaps.get(e);t?(this._activeColormapName=e,this._canvas.colormap=t):console.warn(`Invalid colormap name (${e})`)}get imageRange(){return this._canvas.imageRange}set imageRange(e){this._canvas.imageRange=e,this._ticksBar.imageRange=e}get voiRange(){return this._canvas.voiRange}set voiRange(e){const{voiRange:t}=this._canvas;(0,a.kB)(e)&&!(0,a.bh)(e,t)&&(this._canvas.voiRange=e,this._ticksBar.voiRange=e,this.onVoiChange(e))}get showFullImageRange(){return this._canvas.showFullImageRange}set showFullImageRange(e){this._canvas.showFullImageRange=e,this._ticksBar.showFullPixelValueRange=e}destroy(){super.destroy(),this._eventListenersManager.reset()}createRootElement(){const e=document.createElement("div");return Object.assign(e.style,{position:"relative",fontSize:"0",width:"100%",height:"100%"}),e}onContainerResize(){super.onContainerResize(),this.updateTicksBar(),this._canvas.size=this.containerSize}getVOIMultipliers(){return[h.MULTIPLIER,h.MULTIPLIER]}onVoiChange(e){}showTicks(){this.updateTicksBar(),this._ticksBar.visible=!0}hideTicks(){this._isInteracting||this._isMouseOver||(this._ticksBar.visible=!1)}static getColormapsMap(e){const{colormaps:t}=e;return t.reduce((e,t)=>e.set(t.Name,t),new Map)}static getInitialColormapName(e){const{activeColormapName:t,colormaps:n}=e;return!!t&&n.some(e=>e.Name===t)?t:n[0].Name}_createCanvas(e){const{imageRange:t,voiRange:n,showFullPixelValueRange:o}=e,i=this._colormaps.get(this._activeColormapName);return new r.n({colormap:i,imageRange:t,voiRange:n,showFullPixelValueRange:o})}_createTicksBar(e){const t=e.ticks;return new l.f({imageRange:e.imageRange,voiRange:e.voiRange,ticks:t,showFullPixelValueRange:e.showFullPixelValueRange})}_getPointsFromMouseEvent(e){const{rootElement:t}=this,n=[e.clientX,e.clientY],o=[e.pageX,e.pageY],i=t.getBoundingClientRect();return{client:n,page:o,local:[o[0]-i.left-window.pageXOffset,o[1]-i.top-window.pageYOffset]}}updateTicksBar(){const{width:e,height:t}=this.containerSize;if(0===e&&0===t)return;const{_ticksBar:n,_rangeTextPosition:o}=this,i=e>=t,a=i?e:h.TICKS_BAR_SIZE,r=i?h.TICKS_BAR_SIZE:t;if(!(0,d.A)(e,t,o))throw new Error("Invalid rangeTextPosition value for the current colobar orientation");let l,c;n.size={width:a,height:r},i?(c=0,l=o===s.U.Top?-r:t):(l=0,c=o===s.U.Left?-a:e),n.top=l,n.left=c}_addRootElementEventListeners(){const{_eventListenersManager:e}=this,{rootElement:t}=this;e.addEventListener(t,"mouseover",this._mouseOverCallback),e.addEventListener(t,"mouseout",this._mouseOutCallback),e.addEventListener(t,"mousedown",this._mouseDownCallback)}_addVOIEventListeners(e){const{_eventListenersManager:t}=this,n={points:this._getPointsFromMouseEvent(e),voiRange:{...this._canvas.voiRange}};this._removeVOIEventListeners(),t.addEventListener(document,"voi.mouseup",this._mouseUpCallback),t.addEventListener(document,"voi.mousemove",e=>this._mouseDragCallback(e,n))}_removeVOIEventListeners(){const{_eventListenersManager:e}=this;e.removeEventListener(document,"voi.mouseup"),e.removeEventListener(document,"voi.mousemove")}}},91994:(e,t,n)=>{"use strict";n.d(t,{b:()=>l});var o=n(15327),i=n(4848),a=n(22658);const{Events:s}=o.Enums,r={lower:-1e3,upper:1e3};class l extends i.P{constructor(e){const{element:t,volumeId:n}=e,o=l._getImageRange(t,n),i=l._getVOIRange(t,n);super({...e,imageRange:o,voiRange:i}),this.autoHideTicks=()=>{if(this._hideTicksTimeoutId)return;const e=this._hideTicksTime-Date.now();e<=0?this.hideTicks():this._hideTicksTimeoutId=window.setTimeout(()=>{this._hideTicksTimeoutId=0,this.autoHideTicks()},e)},this._stackNewImageCallback=()=>{this.imageRange=l._getImageRange(this._element)},this._imageVolumeModifiedCallback=e=>{const{volumeId:t}=e.detail;if(t!==this._volumeId)return;const{_element:n}=this;this.imageRange=l._getImageRange(n,t)},this._viewportVOIModifiedCallback=e=>{const{viewportId:t,volumeId:n,range:o,colormap:i}=e.detail,{viewport:a}=this.enabledElement;t===a.id&&n===this._volumeId&&(this.voiRange=o,i&&(this.activeColormapName=i.name),this.showAndAutoHideTicks())},this._viewportColormapModifiedCallback=e=>{const{viewportId:t,colormap:n,volumeId:o}=e.detail,{viewport:i}=this.enabledElement;t===i.id&&o===this._volumeId&&(this.activeColormapName=n.name)},this._element=t,this._volumeId=n,this._addCornerstoneEventListener()}get element(){return this._element}get enabledElement(){return(0,o.getEnabledElement)(this._element)}getVOIMultipliers(){const{viewport:e}=this.enabledElement;return(0,a.j)(e,this._volumeId)}onVoiChange(e){super.onVoiChange(e);const{viewport:t}=this.enabledElement;if(t instanceof o.StackViewport)t.setProperties({voiRange:e}),t.render();else if(t instanceof o.VolumeViewport){const{_volumeId:n}=this,i=o.utilities.getViewportsWithVolumeId(n);t.setProperties({voiRange:e},n),i.forEach(e=>e.render())}}static _getImageRange(e,t){const n=(0,o.getEnabledElement)(e),{viewport:i}=n,a=i.getImageActor(t);if(!a)return r;const s=a.getMapper().getInputData().getPointData().getScalars();let l;if(s)l=s.getRange();else{if(!t)throw new Error("volumeId is required when scalarData is not available");const e=o.cache.getVolume(t),[n,i]=e.voxelManager.getRange();l=[n,i]}return 0===l[0]&&0===l[1]?r:{lower:l[0],upper:l[1]}}static _getVOIRange(e,t){const n=(0,o.getEnabledElement)(e),{viewport:i}=n,a=i.getImageActor(t);if(!a)return r;const s=a.getProperty().getRGBTransferFunction(0).getRange();return 0===s[0]&&0===s[1]?r:{lower:s[0],upper:s[1]}}showAndAutoHideTicks(e=1e3){this._hideTicksTime=Date.now()+e,this.showTicks(),this.autoHideTicks()}_addCornerstoneEventListener(){const{_element:e}=this;o.eventTarget.addEventListener(s.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedCallback),e.addEventListener(s.STACK_NEW_IMAGE,this._stackNewImageCallback),e.addEventListener(s.VOI_MODIFIED,this._viewportVOIModifiedCallback),e.addEventListener(s.COLORMAP_MODIFIED,this._viewportColormapModifiedCallback)}destroy(){super.destroy();const{_element:e}=this;o.eventTarget.removeEventListener(s.IMAGE_VOLUME_MODIFIED,this._imageVolumeModifiedCallback),e.removeEventListener(s.STACK_NEW_IMAGE,this._stackNewImageCallback),e.removeEventListener(s.VOI_MODIFIED,this._viewportVOIModifiedCallback),e.removeEventListener(s.COLORMAP_MODIFIED,this._viewportColormapModifiedCallback)}}},20646:(e,t,n)=>{"use strict";var o;n.d(t,{U:()=>o}),function(e){e.Top="top",e.Left="left",e.Bottom="bottom",e.Right="right"}(o||(o={}))},51807:(e,t,n)=>{"use strict";n.r(t),n.d(t,{ColorbarRangeTextPosition:()=>o.U});var o=n(20646)},28802:(e,t,n)=>{"use strict";n.r(t),n.d(t,{Colorbar:()=>i.P,Enums:()=>o,ViewportColorbar:()=>a.b});var o=n(51807),i=n(4848),a=n(91994)},97213:(e,t,n)=>{"use strict";n.r(t),n.d(t,{colorbar:()=>o,windowLevel:()=>i});var o=n(28802),i=n(72936)},95995:(e,t,n)=>{"use strict";function o(e,t,n){const o=e.length;let i=n,a=t,s=0;if(o<2)return{min:i,max:a,mean:(t+n)/2};for(let t=0;t<o;t++){const n=e[t];i=Math.min(i,n),a=Math.max(a,n),s+=n}return{min:i,max:a,mean:s/o}}n.d(t,{a:()=>o})},41433:(e,t,n)=>{"use strict";n.d(t,{u:()=>i});var o=n(15327);function i(e){if(e instanceof o.VolumeViewport)return function(e){const{scalarData:t,width:n,height:i}=o.utilities.getCurrentVolumeViewportSlice(e),{min:a,max:s}=o.utilities.getMinMax(t);return{scalarData:t,minPixelValue:a,maxPixelValue:s,width:n,height:i,rows:n,columns:i}}(e);if(e instanceof o.StackViewport)return function(e){const t=e.getImageData(),{scalarData:n}=t,{min:i,max:a}=o.utilities.getMinMax(n),s=t.dimensions[0],r=t.dimensions[1],{rows:l,columns:d,color:c}=e.getCornerstoneImage();return{scalarData:n,width:s,height:r,minPixelValue:i,maxPixelValue:a,rows:l,columns:d,color:c}}(e);throw new Error("Viewport not supported")}},98148:(e,t,n)=>{"use strict";function o(e,t,n,o,i){const a=[];let s=0;const r=e.scalarData;let l,d,c;if(e.color)for(d=0;d<i;d++)for(c=0;c<o;c++){l=4*((d+n)*e.columns+(c+t));const o=r[l],i=r[l+1],h=r[l+2];a[s++]=.2126*o+.7152*i+.0722*h}else for(d=0;d<i;d++)for(c=0;c<o;c++)l=(d+n)*e.columns+(c+t),a[s++]=r[l];return a}n.d(t,{l:()=>o})},72936:(e,t,n)=>{"use strict";n.r(t),n.d(t,{calculateMinMaxMean:()=>i.a,extractWindowLevelRegionToolData:()=>a.u,getLuminanceFromRegion:()=>o.l});var o=n(98148),i=n(95995),a=n(41433)},5363:(e,t,n)=>{"use strict";n.d(t,{r:()=>o});const o="3.24.0"},93008:(e,t,n)=>{var o="__lodash_hash_undefined__",i="[object Function]",a="[object GeneratorFunction]",s=/\.|\[(?:[^[\]]*|(["'])(?:(?!\1)[^\\]|\\.)*?\1)\]/,r=/^\w*$/,l=/^\./,d=/[^.[\]]+|\[(?:(-?\d+(?:\.\d+)?)|(["'])((?:(?!\2)[^\\]|\\.)*?)\2)\]|(?=(?:\.|\[\])(?:\.|\[\]|$))/g,c=/\\(\\)?/g,h=/^\[object .+?Constructor\]$/,g="object"==typeof n.g&&n.g&&n.g.Object===Object&&n.g,u="object"==typeof self&&self&&self.Object===Object&&self,m=g||u||Function("return this")();var v,p=Array.prototype,f=Function.prototype,E=Object.prototype,w=m["__core-js_shared__"],I=(v=/[^.]+$/.exec(w&&w.keys&&w.keys.IE_PROTO||""))?"Symbol(src)_1."+v:"",C=f.toString,T=E.hasOwnProperty,b=E.toString,A=RegExp("^"+C.call(T).replace(/[\\^$.*+?()[\]{}|]/g,"\\$&").replace(/hasOwnProperty|(function).*?(?=\\\()| for .+?(?=\\\])/g,"$1.*?")+"$"),_=m.Symbol,S=p.splice,D=V(m,"Map"),y=V(Object,"create"),M=_?_.prototype:void 0,x=M?M.toString:void 0;function R(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var o=e[t];this.set(o[0],o[1])}}function P(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var o=e[t];this.set(o[0],o[1])}}function L(e){var t=-1,n=e?e.length:0;for(this.clear();++t<n;){var o=e[t];this.set(o[0],o[1])}}function k(e,t){for(var n=e.length;n--;)if(F(e[n][0],t))return n;return-1}function O(e,t){var n;t=function(e,t){if(G(e))return!1;var n=typeof e;if("number"==n||"symbol"==n||"boolean"==n||null==e||z(e))return!0;return r.test(e)||!s.test(e)||null!=t&&e in Object(t)}(t,e)?[t]:G(n=t)?n:B(n);for(var o=0,i=t.length;null!=e&&o<i;)e=e[W(t[o++])];return o&&o==i?e:void 0}function U(e){if(!$(e)||(t=e,I&&I in t))return!1;var t,n=function(e){var t=$(e)?b.call(e):"";return t==i||t==a}(e)||function(e){var t=!1;if(null!=e&&"function"!=typeof e.toString)try{t=!!(e+"")}catch(e){}return t}(e)?A:h;return n.test(function(e){if(null!=e){try{return C.call(e)}catch(e){}try{return e+""}catch(e){}}return""}(e))}function N(e,t){var n,o,i=e.__data__;return("string"==(o=typeof(n=t))||"number"==o||"symbol"==o||"boolean"==o?"__proto__"!==n:null===n)?i["string"==typeof t?"string":"hash"]:i.map}function V(e,t){var n=function(e,t){return null==e?void 0:e[t]}(e,t);return U(n)?n:void 0}R.prototype.clear=function(){this.__data__=y?y(null):{}},R.prototype.delete=function(e){return this.has(e)&&delete this.__data__[e]},R.prototype.get=function(e){var t=this.__data__;if(y){var n=t[e];return n===o?void 0:n}return T.call(t,e)?t[e]:void 0},R.prototype.has=function(e){var t=this.__data__;return y?void 0!==t[e]:T.call(t,e)},R.prototype.set=function(e,t){return this.__data__[e]=y&&void 0===t?o:t,this},P.prototype.clear=function(){this.__data__=[]},P.prototype.delete=function(e){var t=this.__data__,n=k(t,e);return!(n<0)&&(n==t.length-1?t.pop():S.call(t,n,1),!0)},P.prototype.get=function(e){var t=this.__data__,n=k(t,e);return n<0?void 0:t[n][1]},P.prototype.has=function(e){return k(this.__data__,e)>-1},P.prototype.set=function(e,t){var n=this.__data__,o=k(n,e);return o<0?n.push([e,t]):n[o][1]=t,this},L.prototype.clear=function(){this.__data__={hash:new R,map:new(D||P),string:new R}},L.prototype.delete=function(e){return N(this,e).delete(e)},L.prototype.get=function(e){return N(this,e).get(e)},L.prototype.has=function(e){return N(this,e).has(e)},L.prototype.set=function(e,t){return N(this,e).set(e,t),this};var B=H(function(e){var t;e=null==(t=e)?"":function(e){if("string"==typeof e)return e;if(z(e))return x?x.call(e):"";var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}(t);var n=[];return l.test(e)&&n.push(""),e.replace(d,function(e,t,o,i){n.push(o?i.replace(c,"$1"):t||e)}),n});function W(e){if("string"==typeof e||z(e))return e;var t=e+"";return"0"==t&&1/e==-1/0?"-0":t}function H(e,t){if("function"!=typeof e||t&&"function"!=typeof t)throw new TypeError("Expected a function");var n=function(){var o=arguments,i=t?t.apply(this,o):o[0],a=n.cache;if(a.has(i))return a.get(i);var s=e.apply(this,o);return n.cache=a.set(i,s),s};return n.cache=new(H.Cache||L),n}function F(e,t){return e===t||e!=e&&t!=t}H.Cache=L;var G=Array.isArray;function $(e){var t=typeof e;return!!e&&("object"==t||"function"==t)}function z(e){return"symbol"==typeof e||function(e){return!!e&&"object"==typeof e}(e)&&"[object Symbol]"==b.call(e)}e.exports=function(e,t,n){var o=null==e?void 0:O(e,t);return void 0===o?n:o}}}]);
//# sourceMappingURL=2011.bundle.10547efd2a04052b5c25.js.map